/* Configuracion MS SQL Server */
SET DATEFIRST 7
SET ANSI_NULLS OFF
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET LOCK_TIMEOUT -1
SET QUOTED_IDENTIFIER OFF
SET ARITHABORT OFF
GO

/**************** spISIntelisisCancelarMov****************/
if exists (select * from sysobjects where id = object_id('dbo.spISIntelisisCancelarMov') and type = 'P') drop procedure dbo.spISIntelisisCancelarMov
GO            
CREATE PROCEDURE spISIntelisisCancelarMov
    @ID                                   int,
    @iSolicitud                           int,
    @Version                              float,
    @Resultado                            varchar(max) = NULL OUTPUT,
    @Ok                                   int = NULL OUTPUT,   
    @OkRef                                varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
      @IDO                     int,
      @IDInv                   int,
      @IDI                     int,
      @Estacion                int,
      @IDAcceso                int,
      @ReferenciaIS            varchar(100),
      @Usuario2                varchar(10),
      @SubReferencia           varchar(100),
      @Empresa                 varchar(5),
      @Sucursal                int,         
      @Mov                     varchar(20),        
      @MovID                   varchar(20),
      @Modulo                  char(5)  ,
      @CantidadA               float,
      @ReferenciaMES           varchar(50),
      @Estatus                 varchar(20),
      @Estatus2                varchar(20),
      @Cantidad                bit,
      @Cantidad2               float,
      @Renglon                 float,
      @Articulo                varchar(20),
      @CfgReservar             bit,
      @Serie                   varchar(3),
      @PedidoMES               varchar(20),
      @IDVenta                 int,
      @MovVenta                varchar(20),
      @CantidadVenta           float,
      @Reservar                bit,
      @SubClave                varchar(20),
      @MovInv                  varchar(20),
      @SubCuenta               varchar(50)

    DECLARE
     @Tabla table(
     ID int,
     Estatus varchar(20)) 

  BEGIN TRANSACTION
  SELECT @IDAcceso = dbo.fnAccesoID(@@SPID)
  SET @Cantidad=0
  SELECT @Estacion = EstacionTrabajo ,@Usuario2 = Usuario FROM Acceso WHERE ID = @IDAcceso

  SELECT  @Modulo= Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Modulo'
  SELECT  @ReferenciaMES = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ReferenciaMES'
  SELECT  @IDInv= Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'IDMarcaje'
   IF @@ERROR <> 0 SET @Ok = 1
  END

  IF @Ok IS NULL
  BEGIN 

  IF @Modulo = 'COMS'
    INSERT INTO @Tabla(ID,Estatus)
    SELECT ID,Estatus
      FROM Compra
     WHERE ReferenciaMES = @ReferenciaMES

  IF @Modulo = 'INV'
    INSERT INTO @Tabla(ID,Estatus)
    SELECT ID,Estatus
      FROM Inv
     WHERE IDMarcaje = @IDInv

   IF @Modulo = 'COMS' AND @Ok IS NULL
   BEGIN 
     DECLARE crCompra CURSOR LOCAL FAST_FORWARD FOR
      SELECT ID,Estatus
    FROM @Tabla    
     OPEN crCompra
     FETCH NEXT FROM crCompra INTO @IDO,@Estatus
     WHILE @@FETCH_STATUS = 0
     BEGIN
       IF(SELECT Estatus FROM Compra WHERE ID =  @IDO)='CONCLUIDO' SET @Ok=46090
       IF EXISTS(SELECT * FROM CompraD WHERE ID = @IDO AND  ISNULL(CantidadPendiente,0.0) <> ISNULL(Cantidad,0.0))
       BEGIN      
         DECLARE crActualizar CURSOR LOCAL FAST_FORWARD FOR
         SELECT Renglon,Articulo,CantidadPendiente
           FROM CompraD
          WHERE ID =@IDO     
         OPEN crActualizar
         FETCH NEXT FROM crActualizar INTO @Renglon,@Articulo,@CantidadA
         WHILE @@FETCH_STATUS = 0
         BEGIN
           UPDATE CompraD
              SET CantidadA = @CantidadA
            WHERE ID = @IDO AND Renglon = @Renglon AND Articulo =@Articulo
              SET @Cantidad=1
           FETCH NEXT FROM crActualizar INTO @Renglon,@Articulo,@CantidadA
         END
         CLOSE crActualizar
         DEALLOCATE crActualizar
       END
       IF @Ok IS NULL AND @Cantidad=1 AND @IDO IS NOT NULL AND @Modulo = 'COMS'
       EXEC spAfectar @Modulo, @IDO, 'CANCELAR', 'Seleccion', NULL, @Usuario2, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion

       IF @Ok IS NULL AND @Cantidad=0 AND @IDO IS NOT NULL AND @Modulo = 'COMS'
       EXEC spAfectar @Modulo, @IDO, 'CANCELAR', 'Todo', NULL, @Usuario2, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
     FETCH NEXT FROM crCompra INTO @IDO,@Estatus
    END
    CLOSE crCompra
    DEALLOCATE crCompra
  END
  IF @Modulo = 'INV'
  BEGIN
    DECLARE crActualizar2 CURSOR LOCAL FAST_FORWARD FOR
     SELECT ID,Estatus
       FROM @Tabla
    OPEN crActualizar2
    FETCH NEXT FROM crActualizar2 INTO @IDI,@Estatus2
    WHILE @@FETCH_STATUS = 0
    BEGIN
      IF NOT EXISTS(SELECT * FROM Inv WHERE ID = @IDI AND ESTATUS  <> 'CANCELADO')SET @Ok =14055
      IF @Estatus2 <> 'CANCELADO'   AND @Ok IS NULL
      EXEC spAfectar @Modulo, @IDI, 'CANCELAR', 'Todo', NULL, @Usuario2, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
      SELECT @MovInv = Mov FROM Inv WHERE ID = @IDI
      SELECT @SubClave = SubClave FROM MovTipo WHERE Mov = @MovInv AND Modulo = 'INV'
      SELECT @CfgReservar = PedidosReservar FROM EmpresaCfg WHERE Empresa = @Empresa
      IF @Ok IS NULL AND @CfgReservar = 1 AND @SubClave NOT IN('INV.ER')
      BEGIN
        SELECT @Serie = Serie ,@PedidoMES = PedidoMES FROM Inv WHERE ID = @IDI
        SELECT @MovVenta = Mov FROM MovTipo WHERE SerieMES = @Serie
        SELECT @IDVenta = ID FROM Venta WHERE Mov = @MovVenta AND MovID =@PedidoMES AND Empresa=@Empresa
        SELECT @CantidadVenta=CantidadPendiente FROM VentaD WHERE ID = @IDVenta AND Articulo = @Articulo AND SubCuenta = @SubCuenta
       DECLARE crDetalle CURSOR LOCAL FAST_FORWARD FOR
         SELECT   Cantidad,Articulo,  SubCuenta
           FROM VentaD
          WHERE  ID = @IDVenta
        OPEN crDetalle
        FETCH NEXT FROM crDetalle INTO   @CantidadVenta,@Articulo, @SubCuenta
        WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
        BEGIN
          SELECT @Cantidad = Cantidad FROM InvD WHERE ID = @IDI AND Articulo = @Articulo AND SubCuenta= @SubCuenta
          IF @Cantidad >= @CantidadVenta
          BEGIN
            UPDATE VentaD
               SET CantidadA = @CantidadVenta
             WHERE ID = @IDVenta AND Articulo = @Articulo AND SubCuenta = @SubCuenta 
             IF @@ROWCOUNT >0 Set @Reservar =1
          END
          IF @Cantidad < @CantidadVenta AND @Cantidad >0.0
          BEGIN
            UPDATE VentaD
               SET CantidadA = @Cantidad
             WHERE ID = @IDVenta AND Articulo = @Articulo AND SubCuenta = @SubCuenta 
            IF @@ROWCOUNT >0 Set @Reservar =1
          END
        END
        FETCH NEXT FROM crDetalle INTO   @CantidadVenta,@Articulo, @SubCuenta
      END
      CLOSE crDetalle
      DEALLOCATE crDetalle
      IF @Ok IS NULL AND @Reservar =1 AND @IDVenta IS NOT NULL AND @SubClave NOT IN('INV.ER')
      BEGIN
        EXEC  spAfectar 'VTAS', @IDVenta, 'DESRESERVAR', 'Seleccion', NULL, @Usuario2, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
      END
     FETCH NEXT FROM crActualizar2 INTO @IDI,@Estatus2
    END
    CLOSE crActualizar2
    DEALLOCATE crActualizar2
  END
  IF @OK = 46090 SET @Ok = NULL
  SELECT @ReferenciaIS = Referencia
    FROM IntelisisService
   WHERE ID = @ID
  SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + ' Modulo="'+@Modulo+'" ModuloID =' + CHAR(34) + ISNULL(CONVERT(varchar,@IDO),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '"/></Intelisis>'
  IF @Ok IS NULL
  BEGIN
    COMMIT TRANSACTION
  END ELSE
  BEGIN
    ROLLBACK TRANSACTION
  END
END
GO





/**************** spIntelisisCOMSMovListado  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCOMSMovListado') and type = 'P') drop procedure dbo.spIntelisisCOMSMovListado
GO            
CREATE PROCEDURE spIntelisisCOMSMovListado
                               @ID                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                                      int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE

        @IDO                                             int,
                               @Texto                                  xml,
                               @Empresa                            varchar(5),
                               @Mov                                    varchar(20),
                               @MovID                                               varchar(20),
                               @FechaEmision                                 datetime   , 
                               @Concepto                          varchar(50),
                               @Proyecto                            varchar(50),
                               @Actividad                          varchar(100),
                               @UEN                                    int   ,
                               @Moneda                                            varchar(10),
                               @TipoCambio                                                    float   ,
                               @Usuario                              varchar(10),
                               @Referencia                        varchar(50), 
                               @Estatus                               varchar(15), 
                               @RenglonID                        int   ,
                               @Proveedor                         varchar(10),
                               @FormaEnvio                                                    varchar(50),
                               @FechaRequerida                                            datetime   ,
                               @Almacen                           varchar(10),
                               @Condicion                         varchar(50),
                               @Vencimiento                                   datetime   ,
                               @ActivoFijo                          bit   , 
                               @Agente                                              varchar(10),
                               @Importe                             money   ,
                               @Impuestos                         money   ,
                               @Saldo                                 money   ,
                               @OrigenTipo                                                      varchar(10),
                               @Origen                                               varchar(20),
                               @OrigenID                           varchar(20),
                               @FechaCancelacion                        datetime   ,
                               @Peso                                   float   ,
                               @Volumen                           float   ,
                               @FechaEntrega                                 datetime   ,
                               @EmbarqueEstado                                           varchar(50),
                               @Sucursal                             int   ,
                               @ZonaImpuesto                                varchar(30),
                               @VIN                                     varchar(20),
                               @SubModulo                                                     varchar(5),
                               @Cliente                               varchar(10),
                               @SucursalOrigen                                               int   ,
                               @SucursalDestino                              int , 
                               @ReferenciaIS                                    varchar(100),
                               @SubReferencia                                varchar(100)


  BEGIN TRANSACTION
  IF @Ok IS NULL
  BEGIN

  SELECT @IDO = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ID'
   SELECT @MovID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'MovID'
  SELECT @FechaEmision = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FechaEmision'
  SELECT @Concepto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Concepto'
  SELECT @Proyecto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Proyecto'
  SELECT @Actividad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Actividad'
  SELECT @UEN = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'UEN'
  SELECT @Moneda = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Moneda'
  SELECT @TipoCambio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'TipoCambio'
  SELECT @Usuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Usuario'
  SELECT @Referencia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Referencia'
  SELECT @Estatus = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Estatus'
  SELECT @RenglonID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'RenglonID'
  SELECT @Proveedor = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Proveedor'
  SELECT @FormaEnvio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FormaEnvio'
  SELECT @FechaRequerida = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FechaRequerida'
  SELECT @Almacen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Almacen'
  SELECT @Condicion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Condicion'
  SELECT @Vencimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Vencimiento'
  SELECT @ActivoFijo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ActivoFijo'
  SELECT @Agente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Agente'
  SELECT @Importe = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Importe'
  SELECT @Impuestos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Impuestos'
  SELECT @Saldo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Saldo'
  SELECT @OrigenTipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'OrigenTipo'
  SELECT @Origen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Origen'
  SELECT @OrigenID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'OrigenID'
  SELECT @FechaCancelacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FechaCancelacion'
  SELECT @Peso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Peso'
  SELECT @Volumen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Volumen'
  SELECT @FechaEntrega = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FechaEntrega'
  SELECT @EmbarqueEstado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EmbarqueEstado'
  SELECT @Sucursal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Sucursal'
  SELECT @ZonaImpuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ZonaImpuesto'
  SELECT @VIN = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'VIN'
  SELECT @SubModulo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SubModulo'
  SELECT @Cliente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Cliente'
  SELECT @SucursalOrigen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SucursalOrigen'
  SELECT @SucursalDestino = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SucursalDestino'

    SELECT @Texto =(SELECT * FROM Compra Compra  JOIN CompraD CompraD ON Compra.ID = CompraD.ID LEFT OUTER JOIN SerieLoteMov SerieLoteMov
        ON SerieLoteMov.ID = CompraD.ID  AND SerieLoteMov.RenglonID = CompraD.RenglonID AND SerieLoteMov.Articulo = CompraD.Articulo AND ISNULL(SerieLoteMov.SubCuenta,'') = ISNULL(CompraD.SubCuenta,'') AND SerieLoteMov.Modulo = 'COMS' AND SerieLoteMov.Empresa = @Empresa
      WHERE  ISNULL(Compra.ID,'') = ISNULL(ISNULL(@IDO,Compra.ID),'')
                    AND ISNULL(Compra.Empresa,'') = ISNULL(ISNULL(@Empresa,Compra.Empresa),'')
                               AND       ISNULL(Compra.Mov,'') = ISNULL(ISNULL(@Mov,Compra.Mov),'')
                               AND       ISNULL(Compra.MovID,'') = ISNULL(ISNULL(@MovID,Compra.MovID),'')
                               AND       ISNULL(Compra.FechaEmision,'') = ISNULL(ISNULL(@FechaEmision,Compra.FechaEmision),'')
                               AND       ISNULL(Compra.Concepto,'') = ISNULL(ISNULL(@Concepto,Compra.Concepto),'')
                               AND       ISNULL(Compra.Proyecto,'') = ISNULL(ISNULL(@Proyecto,Compra.Proyecto),'')
                               AND       ISNULL(Compra.Actividad,'') = ISNULL(ISNULL(@Actividad,Compra.Actividad),'')
                               AND       ISNULL(Compra.UEN,'') = ISNULL(ISNULL(@UEN,Compra.UEN),'')
                               AND       ISNULL(Compra.Moneda,'') = ISNULL(ISNULL(@Moneda,Compra.Moneda),'')
                               AND       ISNULL(Compra.TipoCambio,'') = ISNULL(ISNULL(@TipoCambio,Compra.TipoCambio),'')
                               AND       ISNULL(Compra.Usuario,'') = ISNULL(ISNULL(@Usuario,Compra.Usuario),'')
                               AND       ISNULL(Compra.Estatus,'') = ISNULL(ISNULL(@Estatus,Compra.Estatus),'')
                               AND       ISNULL(Compra.RenglonID,'') = ISNULL(ISNULL(@RenglonID,Compra.RenglonID),'')
                               AND       ISNULL(Compra.Proveedor,'') = ISNULL(ISNULL(@Proveedor,Compra.Proveedor),'')
                               AND       ISNULL(Compra.FormaEnvio,'') = ISNULL(ISNULL(@FormaEnvio,Compra.FormaEnvio),'')
                               AND       ISNULL(Compra.FechaRequerida,'') = ISNULL(ISNULL(@FechaRequerida,Compra.FechaRequerida),'')
                               AND       ISNULL(Compra.Almacen,'') = ISNULL(ISNULL(@Almacen,Compra.Almacen),'')
                               AND       ISNULL(Compra.Condicion,'') = ISNULL(ISNULL(@Condicion,Compra.Condicion),'')
                               AND       ISNULL(Compra.Vencimiento,'') = ISNULL(ISNULL(@Vencimiento,Compra.Vencimiento),'')
                               AND       ISNULL(Compra.Importe,'') = ISNULL(ISNULL(@Importe,Compra.Importe),'')
                               AND       ISNULL(Compra.Impuestos,'') = ISNULL(ISNULL(@Impuestos,Compra.Impuestos),'')
                               AND       ISNULL(Compra.Saldo,'') = ISNULL(ISNULL(@Saldo,Compra.Saldo),'')
                               AND       ISNULL(Compra.OrigenTipo,'') = ISNULL(ISNULL(@OrigenTipo,Compra.OrigenTipo),'')
                               AND       ISNULL(Compra.Origen,'') = ISNULL(ISNULL(@Origen,Compra.Origen),'')
                               AND       ISNULL(Compra.OrigenID,'') = ISNULL(ISNULL(@OrigenID,Compra.OrigenID),'')
                               AND       ISNULL(Compra.FechaCancelacion,'') = ISNULL(ISNULL(@FechaCancelacion,Compra.FechaCancelacion),'')
                               AND       ISNULL(Compra.Peso,'') = ISNULL(ISNULL(@Peso,Compra.Peso),'')
                               AND       ISNULL(Compra.FechaEntrega,'') = ISNULL(ISNULL(@FechaEntrega,Compra.FechaEntrega),'')
                               AND       ISNULL(Compra.EmbarqueEstado,'') = ISNULL(ISNULL(@EmbarqueEstado,Compra.EmbarqueEstado),'')
                               AND       ISNULL(Compra.Sucursal,'') = ISNULL(ISNULL(@Sucursal,Compra.Sucursal),'')
                               AND       ISNULL(Compra.ZonaImpuesto,'') = ISNULL(ISNULL(@ZonaImpuesto,Compra.ZonaImpuesto),'')
                               AND       ISNULL(Compra.VIN,'') = ISNULL(ISNULL(@VIN,Compra.VIN),'')
                               AND       ISNULL(Compra.SubModulo,'') = ISNULL(ISNULL(@SubModulo,Compra.SubModulo),'')
                               AND       ISNULL(Compra.Cliente,'') = ISNULL(ISNULL(@Cliente,Compra.Cliente),'')
                               AND       ISNULL(Compra.SucursalOrigen,'') = ISNULL(ISNULL(@SucursalOrigen,Compra.SucursalOrigen),'')
                               AND       ISNULL(Compra.SucursalDestino,'') = ISNULL(ISNULL(@SucursalDestino,Compra.SucursalDestino),'')
       FOR XML AUTO)         

    SELECT @ReferenciaIS = Referencia
      FROM IntelisisService
     WHERE ID = @ID

    SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'

  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
   BEGIN
     COMMIT TRANSACTION
   END ELSE
    BEGIN
      ROLLBACK TRANSACTION
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')   
    END
  END
END
GO


/**************** spInforTransferenciaVTAS_PR ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforTransferenciaVTAS_PR') and type = 'P') drop procedure dbo.spInforTransferenciaVTAS_PR
GO            
CREATE PROCEDURE spInforTransferenciaVTAS_PR
                               @ID                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                                      int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE
                               @IDO                                                                    varchar(10),
                               @Datos                                                 varchar(max),
                               @Solicitud                                                                           varchar(max),
                               @ReferenciaIS                                                    varchar(100),
                               @SubReferencia                                                varchar(100),
                               @IDNuevo                                                                           int,
                               @Datos2                                                               varchar(max),
                               @Resultado2                                                                      varchar(max),
                               @Resultado3                                                                      varchar(max),
                               @Resultado4                                                                      varchar(max),
                               @Usuario                                                                             varchar(10),
                               @Contrasena                                                                     varchar(32),        
                               @Cliente                                                                  varchar(10),
                               @Empresa                                                                           varchar(5),
                               @ReferenciaIntelisisService                                           varchar(50),
                               @Sucursal                                                                            int,
                               @PlantaSucEmpresa                                        varchar(10),
        @FechaEmision                                                         datetime,
                               @FechaRegistro                                               datetime,
                               @Usuario2                                                                          varchar(10),
                               @Almacen                                                                          varchar(10)          ,
                               @ArtSecundario                      varchar(20),
                               @Articulop                          varchar(20)


  DECLARE                            @Tabla                                table
                               (
                                Anyo                                      int,
                                Periodo                                int,
                                Cliente                                  varchar(10),
                                Articulo                                                varchar(20),
                                SubCuenta               varchar(50),
                                ArticuloSecundario                           varchar(20),
                                UnidadesAlmacen                                           varchar(40),
                                ImporteVenta                                    varchar(40),
                                ImporteCoste                                     varchar(40),
                                FechaDeAlta                                                     datetime,
                                FechaUltimaModificacion              datetime,
                                UsuarioAlta                          varchar(10),
                                UsuarioModificacion                        varchar(10),
                                ReferenciaIntelisisService                                               varchar(50)
                                               )

                  BEGIN TRANSACTION

                  IF @Ok IS NULL
                  BEGIN

  SELECT @IDO = ID FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Venta')
    WITH (ID varchar(255))
  SELECT @FechaEmision = FechaEmision ,@Cliente = Cliente ,@FechaRegistro =  FechaRegistro, @Usuario2 = Usuario, @Almacen = Almacen
    FROM Venta
   WHERE ID = @IDO

  IF @Cliente IS NULL SET @Ok = 1

  SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
    FROM IntelisisService
   WHERE ID = @ID
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario


  SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'


  SET @Datos= '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.VTAS.Mov.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="ID" Valor="'+@IDO+'"/></Solicitud></Intelisis>'

  EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

  SELECT @Solicitud = Resultado
    FROM IntelisisService
   WHERE ID = @IDNuevo
  EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
      SELECT @Empresa = Empresa , @Sucursal = Sucursal   
       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Venta',1) 
       WITH ( Empresa varchar(100), Sucursal varchar(100))
     EXEC sp_xml_removedocument @iSolicitud         

--      SELECT @PlantaSucEmpresa = PlantaSucEmpresa
--        FROM Version
--
--      IF @PlantaSucEmpresa = 'Empresa' 
      SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService
        FROM Alm
       WHERE Almacen = @Almacen

--      IF @PlantaSucEmpresa = 'Sucursal' 
--      SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService
--        FROM Sucursal
--       WHERE Sucursal = @Sucursal
     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud

         INSERT @Tabla(        Anyo,               Periodo,                    Cliente, Articulo,SubCuenta, UnidadesAlmacen, ImporteVenta, ImporteCoste, FechaDeAlta,   FechaUltimaModificacion, UsuarioAlta, UsuarioModificacion,ReferenciaIntelisisService    )
        SELECT         year(@FechaEmision), datepart(week,@FechaEmision), @Cliente, Articulo, SubCuenta,Cantidad,        Precio,       Costo,        @FechaRegistro, @FechaRegistro,           @Usuario2,     @Usuario2 ,           @ReferenciaIntelisisService

       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/VentaD',1) 
                                      WITH ( Articulo varchar(100),Cantidad varchar(100),Precio varchar(100),Costo varchar(100),SubCuenta varchar(100))

     EXEC sp_xml_removedocument @iSolicitud      



     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oObjetivosVentasCliente   FOR XML AUTO))

     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) + 'Infor.Movimiento.Procesar.VTAS_PR' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ModuloID="'+ @IDO+'"  ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>'                        
     EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output      

  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
    BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
    COMMIT TRANSACTION
    END ELSE
    BEGIN
      ROLLBACK TRANSACTION
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')   
    END
  END
 END
GO


  /**************** spInforTransferenciaVTAS_P ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforTransferenciaVTAS_P') and type = 'P') drop procedure dbo.spInforTransferenciaVTAS_P
GO            
CREATE PROCEDURE spInforTransferenciaVTAS_P
                               @ID                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                                      int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

DECLARE
                               @IDO                                     varchar(10),
                               @Datos                                                 varchar(max),
                               @Solicitud                                           varchar(max),
                               @ReferenciaIS                                    varchar(100),
                               @SubReferencia                                varchar(100),
                               @IDNuevo                                           int,
                               @Datos2                               varchar(max),
                               @Resultado2                                       varchar(max),
                               @Resultado3                                       varchar(max),
                               @Resultado4                                       varchar(max),
                                @Usuario                                             varchar(10),
                               @Contrasena                                      varchar(32),
                               @ReferenciaIntelisisService            varchar(50),
                               @Empresa                                           varchar(5),
                               @Sucursal                                            int,
                               @PlantaSucEmpresa                        varchar(10)          ,
                               @Almacen                                           varchar(10),
                               @ArtSecundario                  varchar(20)         ,                             
                               @ArticuloP                      varchar(20)               ,
                               @Mov                                    varchar(20)         ,
                               @Serie                                   varchar(3)           

DECLARE
                               @Tabla                                table
                               (
                                               Serie                                                     varchar(3),
                                               NumeroDePedido                             varchar(20),
                                               ID                            int,
                                               CodigoCliente                                    varchar(10),
                                               FechaPedido                                    datetime,
                                               FechaEntrega                                   datetime,
                                               CodigoProveedor                                             varchar(10),
                                               SuPedido                                             varchar(40),
                                               Referencia                                           varchar(40),
                                               FormaDePago                                    varchar(2),
                                               TipoDeEfecto                                     int,
                                               EntregarA                                            varchar(3),
                                               ServirDesde                                       varchar(10),
                                               Observaciones_1                                             varchar(40),
                                               Moneda                               varchar(10),
                                               EstadoPedido                                    varchar(40),
                                               EnviarConfirmacion                         bit,
                                               FechaDeAlta                                      datetime,
                                               FechaUltimaModificacion                      datetime,
                                               UsuarioAlta                                        varchar(10),
                                               PedidoPorRepresentante                        bit,
                                               Zona                                                     varchar(8),
                                               Departamento                                  varchar(4),
                                               PeriodoFacturacion                          int,
                                               Estatus                                                  varchar(20),
                                               ReferenciaIntelisisService      varchar(50),
                                               Sucursal                                               int
)
 DECLARE
                               @Tabla2                                              table
                                 (     Serie                                                     varchar(3),
                                               NumeroDePedido                             varchar(20),
                                               NumeroOrdenLinea                          int,
                                               CodigoArticulo                    varchar(20),
                                               SubCuenta                       varchar(50),
                                               Estado                                                 varchar(40),
                                               FechaEntregaConfirmada                      datetime,
                                               PrecioUnitario                                   varchar(40),
                                               UnidMedidaAlmacen                     varchar(50),
                                               PresentacionPedida                        varchar(50),
                                               FactorConversionUnidades        varchar(40),
                                               CantidadPedida                                              varchar(40),
                                               AlmacenSalida                                  varchar(10),
                                               FechaEntregaRequerida         datetime,
                                               FechaConfirmado                                           datetime,
                                               CantidadServida                                             float,
                                               FechaUltimaModificacion         datetime,
                                               UsuarioAltaD                                      varchar(10),
                                               UsuarioModificacion                        varchar(10),
                                               FechaEntregaInicial                        datetime,
                                               FechaConfirmadaInicial          datetime,
                                               SuReferencia                                     varchar(40),
                                               ImporteLinea                                      varchar(40),
                                               CantidadIntroducida                       float,
                                               CosteEstandar                                  varchar(40),
                                               CosteMedio                                       varchar(40),
                                               CosteUltimo                                       varchar(40),
                                               Familia                                                varchar(4),
                                               Subfamilia                                         varchar(4),
                                               FechaLlegadaRequerida         datetime,
                                               FechaLlegadaConfirmada                     datetime,
                                               CantidadCancelada               float,
                                               CantidadReservada                  float ,
                                               CantidadPendiente                         float )
 DECLARE
                               @Tabla3                                              table
                                 (     Serie                              varchar(3),
                                               NumeroDePedido                             varchar(20),
                                               NumeroOrdenLinea                          int,
                                               CodigoArticulo                    varchar(20),
                                               SubCuenta                                          varchar(50),
                                               Estado                                                 varchar(40),
                                               FechaEntregaConfirmada                      datetime,
                                               PrecioUnitario                                    varchar(40),
                                               UnidMedidaAlmacen                     varchar(50),
                                               PresentacionPedida                        varchar(50),
                                               FactorConversionUnidades        varchar(40),
                                               CantidadPedida                                              varchar(40),
                                               AlmacenSalida                                  varchar(10),
                                               FechaEntregaRequerida         datetime,
                                               FechaConfirmado                                           datetime,
                                               CantidadServida                                             float,
                                               FechaUltimaModificacion         datetime,
                                               UsuarioAltaD                                      varchar(10),
                                               UsuarioModificacion                        varchar(10),
                                               FechaEntregaInicial                        datetime,
                                               FechaConfirmadaInicial          datetime,
                                               SuReferencia                                     varchar(40),
                                               ImporteLinea                                      varchar(40),
                                               CantidadIntroducida                       float,
                                               CosteEstandar                                  varchar(40),
                                               CosteMedio                                       varchar(40),
                                               CosteUltimo                                       varchar(40),
                                               Familia                                                varchar(4),
                                               Subfamilia                                         varchar(4),
                                               FechaLlegadaRequerida         datetime,
                                               FechaLlegadaConfirmada                     datetime,
                                               CantidadCancelada               float,
                                               CantidadReservada                  float ,
                                               CantidadPendiente                         float,
                                               Planta                                                   varchar(20),
                                               ArticuloSecundario              varchar(20)
                                               )

BEGIN TRANSACTION

 IF @Ok IS NULL
  BEGIN

  SELECT @IDO = ID FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Venta')
    WITH (ID varchar(255))

  SELECT @Almacen = Almacen ,@Mov =Mov FROM Venta WHERE ID = @IDO
  SELECT @Serie = SerieMES FROM MovTipo WHERE Mov = @Mov

  SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
    FROM IntelisisService
   WHERE ID = @ID

  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario

  SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'

  SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.VTAS.Mov.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="ID" Valor="'+@IDO+'"/></Solicitud></Intelisis>'

  EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

  SELECT @Solicitud = Resultado
    FROM IntelisisService
   WHERE ID = @IDNuevo
     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
      SELECT @Empresa = Empresa , @Sucursal = Sucursal   
       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Venta',1) 
       WITH ( Empresa varchar(100), Sucursal varchar(100))
     EXEC sp_xml_removedocument @iSolicitud         

      SELECT @ReferenciaIntelisisService = Referencia
        FROM MapeoPlantaIntelisisMes
       WHERE Empresa = @Empresa AND Sucursal = @Sucursal
     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud

     INSERT @Tabla (Serie,      ID,   NumeroDePedido, CodigoCliente, FechaPedido,  FechaEntrega, CodigoProveedor,      SuPedido,   Referencia, FormaDePago,     TipoDeEfecto,   EntregarA, ServirDesde, Observaciones_1, Moneda, EstadoPedido,   EnviarConfirmacion,   FechaDeAlta,   FechaUltimaModificacion, UsuarioAlta, PedidoPorRepresentante,   Zona,         Departamento, PeriodoFacturacion,       ReferenciaIntelisisService, Estatus,Sucursal)
     SELECT         @Serie,ID,   MovID,             Cliente,       FechaEmision, FechaEntrega, CodigoProveedor=null, Referencia, Referencia, FormaDePago='1', TipoDeEfecto=1, EnviarA,   Almacen,     Mov+' '+MovID,   Moneda, EstadoPedido=1, EnviarConfirmacion=0, FechaRegistro, FechaRegistro,           Usuario,     PedidoPorRepresentante=0, ZonaImpuesto, Departamento, PeriodoFacturacion=0, @ReferenciaIntelisisService, Estatus ,@Sucursal     
                       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Venta',1) 
                                      WITH ( ID varchar(100),Mov varchar(100), MovID varchar(100), Cliente varchar(100),FechaEmision varchar(100),Referencia varchar(100),Almacen varchar(100),FechaEntrega varchar(100),Moneda varchar(100), EnviarA varchar(100), Observaciones varchar(100), FechaRegistro varchar(100), Usuario varchar(100), ZonaImpuesto varchar(100), Departamento varchar(100), RenglonID varchar(100), Articulo varchar(100), FechaRequerida varchar(100), PrecioLista varchar(100), Unidad varchar(100), Factor varchar(100), Cantidad varchar(100), Precio varchar(100),  UltimoCosto  varchar(100),   Costo  varchar(100), CostoUEPS varchar(100), Estatus varchar(100))
     EXEC sp_xml_removedocument @iSolicitud      
     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud

                DECLARE @DivRenglon float
                     SET @DivRenglon = 2048

     INSERT @Tabla2(Serie,  NumeroOrdenLinea, CodigoArticulo, SubCuenta, Estado,   FechaEntregaConfirmada, PrecioUnitario, UnidMedidaAlmacen, PresentacionPedida, FactorConversionUnidades, CantidadPedida, AlmacenSalida, FechaEntregaRequerida, FechaConfirmado,      CantidadServida,      FechaUltimaModificacion, UsuarioAltaD, UsuarioModificacion, FechaEntregaInicial, FechaConfirmadaInicial, SuReferencia,  ImporteLinea,                                  CantidadIntroducida, CosteEstandar, CosteMedio, CosteUltimo, Familia,      Subfamilia,      FechaLlegadaRequerida, FechaLlegadaConfirmada,CantidadCancelada,CantidadReservada,CantidadPendiente)
     SELECT         @Serie, RenglonID,        Articulo,       SubCuenta, Estado=1, FechaRequerida,         PrecioLista,    Unidad,            Unidad,             Factor,                   Cantidad,       Almacen,       FechaRequerida,        FechaConfirmado=Null, CantidadServida=Null, FechaRegistro,            Usuario,      Usuario,             FechaRequerida,      FechaRequerida,         Referencia,   (CONVERT(float,ISNULL (Cantidad,1.00))* CONVERT(float,ISNULL( Precio,0.00))) , Cantidad,           CostoEstandar, Costo,      UltimoCosto, Familia=null, Subfamilia=null, FechaRequerida,        FechaRequerida       , CantidadCancelada,CantidadReservada,CantidadPendiente
       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/VentaD',1) 
      WITH ( ID varchar(100),RenglonID int, Cliente varchar(100),SubCuenta varchar(100),FechaEmision varchar(100),Referencia varchar(100),Almacen varchar(100),FechaEntrega varchar(100),Moneda varchar(100), EnviarA varchar(100), Observaciones varchar(100), FechaRegistro varchar(100), Usuario varchar(100), ZonaImpuesto varchar(100), Departamento varchar(100), Renglon varchar(100), Articulo varchar(100), FechaRequerida varchar(100), PrecioLista varchar(100), Unidad varchar(100), Factor varchar(100), Cantidad float, Precio varchar(100),  UltimoCosto  varchar(100),   Costo  varchar(100), CostoEstandar varchar(100),CantidadCancelada float, CantidadReservada float,CantidadPendiente float)
       EXEC sp_xml_removedocument @iSolicitud    

     UPDATE @Tabla2 SET CantidadPedida = (ISNULL(CantidadPedida,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
         CantidadServida = (ISNULL(CantidadServida,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
         CantidadIntroducida = (ISNULL(CantidadIntroducida,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
         CantidadReservada = (ISNULL(CantidadReservada,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
         CantidadPendiente = (ISNULL(CantidadPendiente,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
         CantidadCancelada = (ISNULL(CantidadPedida,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
         UnidMedidaAlmacen =  dbo.fnInforArtUnidadCompra(CodigoArticulo)

     INSERT @Tabla3(Serie,        NumeroOrdenLinea, CodigoArticulo,SubCuenta, Estado,   FechaEntregaConfirmada, PrecioUnitario, UnidMedidaAlmacen, PresentacionPedida, FactorConversionUnidades, CantidadPedida, AlmacenSalida, FechaEntregaRequerida, FechaConfirmado,      CantidadServida,      FechaUltimaModificacion, UsuarioAltaD, UsuarioModificacion, FechaEntregaInicial, FechaConfirmadaInicial, SuReferencia,  ImporteLinea,                                  CantidadIntroducida, CosteEstandar, CosteMedio, CosteUltimo, Familia,      Subfamilia,      FechaLlegadaRequerida, FechaLlegadaConfirmada,CantidadCancelada,CantidadReservada,CantidadPendiente, Planta)
     SELECT a.Serie,        a.NumeroOrdenLinea, a.CodigoArticulo,a.SubCuenta, a.Estado,   a.FechaEntregaConfirmada, a.PrecioUnitario, a.UnidMedidaAlmacen, a.PresentacionPedida, a.FactorConversionUnidades, a.CantidadPedida, a.AlmacenSalida, a.FechaEntregaRequerida, a.FechaConfirmado,      a.CantidadServida,      a.FechaUltimaModificacion, a.UsuarioAltaD, a.UsuarioModificacion, a.FechaEntregaInicial, a.FechaConfirmadaInicial, a.SuReferencia,  a.ImporteLinea,                                  a.CantidadIntroducida, ISNULL(a.CosteEstandar,0), ISNULL(a.CosteMedio,0), ISNULL(a.CosteUltimo,0), a.Familia,      a.Subfamilia,      a.FechaLlegadaRequerida, a.FechaLlegadaConfirmada,a.CantidadCancelada,a.CantidadReservada,a.CantidadPendiente,c.INFORClavePlanta
       FROM @Tabla2 a
       JOIN Art b ON a.CodigoArticulo = b.Articulo AND b.SeProduce = 1 AND ISNULL(b.EsFactory,0) = 1
       JOIN Alm c ON c.Almacen= b.INFORAlmacenProd AND ISNULL(c.EsFactory,0) = 1

     SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService from @Tabla



     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oPedidoVentaCab FOR XML AUTO))
     SET @Resultado3 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla3 oPedidoVentaLinea FOR XML AUTO))
     SELECT @Resultado4 = @Resultado2 + @Resultado3

     IF EXISTS(SELECT CantidadPendiente FROM @Tabla2 WHERE CantidadPendiente > 0)
     BEGIN
       SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) + 'Infor.Movimiento.Procesar.VTAS_P' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado4 + '</Solicitud></Intelisis>'                        
       EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado4,@Ok Output,@OkRef Output,0,0,@IDNuevo Output    
     END

  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
    BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
    COMMIT TRANSACTION
    END ELSE
    BEGIN
      ROLLBACK TRANSACTION
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')   
    END
  END
 END
GO


/**************** spInforTransferenciaVTAS_F ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforTransferenciaVTAS_F') and type = 'P') drop procedure dbo.spInforTransferenciaVTAS_F
GO            
CREATE PROCEDURE spInforTransferenciaVTAS_F
                               @ID                                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                       int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

DECLARE
                               @IDO                                    varchar(10),
                               @Datos                                                 varchar(max),
                               @Solicitud                                            varchar(max),
                               @ReferenciaIS                                    varchar(100),
                               @SubReferencia                                varchar(100),
                               @IDNuevo                                           int,
                               @Datos2                                                              varchar(max),
                               @Resultado2                                       varchar(max),
                               @Resultado3                                       varchar(max),
                               @Resultado4                                       varchar(max),
                               @Usuario                                              varchar(10),
                               @Contrasena                                      varchar(32),
                               @ReferenciaIntelisisService                                           varchar(50),
                               @Empresa                                           varchar(5),
                               @Sucursal                                            int,
                               @PlantaSucEmpresa                                        varchar(10),
                               @Almacen                                           varchar(10),
                               @ArtSecundario                                  varchar(20),                      
                               @ArticuloP                                      varchar(20),
                               @Mov                                                    varchar(20),
                               @MovIDP                              varchar(20),
                               @Serie                                                   varchar(3),
                               @Origen                                         varchar(20)


  DECLARE
                               @Tabla                                table
                               (
                                               Serie                                                     varchar(3),
                                               NumeroDePedido                             varchar(20),
                                               ID                            int,
                                               CodigoCliente                                    varchar(10),
                                               FechaPedido                                    datetime,
                                               FechaEntrega                                   datetime,
                                               CodigoProveedor                                             varchar(10),
                                               SuPedido                                             varchar(40),
                                               Referencia                                           varchar(40),
                                               FormaDePago                                    varchar(2),
                                               TipoDeEfecto                                     int,
                                               EntregarA                                            varchar(3),
                                               ServirDesde                                       varchar(10),
                                               Observaciones_1                                             varchar(40),
                                               Moneda                               varchar(10),
                                               EstadoPedido                                    varchar(40),
                                               EnviarConfirmacion                         bit,
                                               FechaDeAlta                                      datetime,
                                               FechaUltimaModificacion                      datetime,
                                               UsuarioAlta                                        varchar(10),
                                               PedidoPorRepresentante                        bit,
                                               Zona                                                     varchar(8),
                                               Departamento                                  varchar(4),
                                               PeriodoFacturacion                          int,
                                               Estatus                                                  varchar(20),
                                               ReferenciaIntelisisService      varchar(50),
                                               Sucursal                                               int
)
  DECLARE
                               @Tabla2                                              table
                                 (     Serie                              varchar(3),
                                               NumeroDePedido                             varchar(20),
                                               NumeroOrdenLinea                          int,
                                               CodigoArticulo                    varchar(20),
                                               SubCuenta                       varchar(50),
                                               Estado                                                 varchar(40),
                                               FechaEntregaConfirmada                      datetime,
                                               PrecioUnitario                                   varchar(40),
                                               UnidMedidaAlmacen                     varchar(50),
                                               PresentacionPedida                        varchar(5),
                                               FactorConversionUnidades        varchar(40),
                                               CantidadPedida                                              varchar(40),
                                               AlmacenSalida                                  varchar(10),
                                               FechaEntregaRequerida         datetime,
                                               FechaConfirmado                                           datetime,
                                               CantidadServida                                             varchar(40),
                                               FechaUltimaModificacion         datetime,
                                               UsuarioAltaD                                      varchar(10),
                                               UsuarioModificacion                        varchar(10),
                                               FechaEntregaInicial                        datetime,
                                               FechaConfirmadaInicial          datetime,
                                               SuReferencia                                     varchar(40),
                                               ImporteLinea                                      varchar(40),
                                               CantidadIntroducida                       varchar(40),
                                               CosteEstandar                                  varchar(40),
                                               CosteMedio                                       varchar(40),
                                               CosteUltimo                                       varchar(40),
                                               Familia                                                varchar(4),
                                               Subfamilia                                         varchar(4),
                                               FechaLlegadaRequerida         datetime,
                                               FechaLlegadaConfirmada                     datetime,
                                               CantidadCancelada               float,
                                               CantidadReservada                  float ,
                                               CantidadPendiente                         float )
  DECLARE
                               @Tabla3                                              table
                                 ( Serie                                  varchar(3),
                                               NumeroDePedido                             varchar(20),
                                               NumeroOrdenLinea                          int,
                                               CodigoArticulo                    varchar(20),
                                               SubCuenta                                          varchar(50),
                                               Estado                                                 varchar(40),
                                               FechaEntregaConfirmada                      datetime,
                                               PrecioUnitario                                   varchar(40),
                                               UnidMedidaAlmacen                     varchar(50),
                                               PresentacionPedida                        varchar(5),
                                               FactorConversionUnidades        varchar(40),
                                               CantidadPedida                                              varchar(40),
                                               AlmacenSalida                                  varchar(10),
                                               FechaEntregaRequerida         datetime,
                                               FechaConfirmado                                           datetime,
                                               CantidadServida                                             varchar(40),
                                               FechaUltimaModificacion         datetime,
                                               UsuarioAltaD                                      varchar(10),
                                               UsuarioModificacion                        varchar(10),
                                               FechaEntregaInicial                 datetime,
                                               FechaConfirmadaInicial          datetime,
                                               SuReferencia                                     varchar(40),
                                               ImporteLinea                                      varchar(40),
                                               CantidadIntroducida                       varchar(40),
                                               CosteEstandar                                  varchar(40),
                                               CosteMedio                                       varchar(40),
                                               CosteUltimo                                       varchar(40),
                                               Familia                                                varchar(4),
                                               Subfamilia                                         varchar(4),
                                               FechaLlegadaRequerida         datetime,
                                               FechaLlegadaConfirmada                     datetime,
                                               CantidadCancelada               float,
                                               CantidadReservada                  float ,
                                               CantidadPendiente                         float,
                                               Planta                                                   varchar(20),
                                               ArticuloSecundario              varchar(20)
                                               )

  BEGIN TRANSACTION

  IF @Ok IS NULL
  BEGIN

  SELECT @IDO = ID FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Venta')
    WITH (ID varchar(255))

  SELECT @Almacen = Almacen ,@Mov =Mov ,@Origen = Origen ,@MovIDP = OrigenID FROM Venta WHERE ID = @IDO
  SELECT @Serie = SerieMES FROM MovTipo WHERE Clave = 'VTAS.P' AND Modulo ='VTAS' AND Mov = @Origen

  SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
    FROM IntelisisService
   WHERE ID = @ID
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario

  SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'


  SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.VTAS.Mov.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="ID" Valor="'+@IDO+'"/></Solicitud></Intelisis>'

  EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

  SELECT @Solicitud = Resultado
    FROM IntelisisService
   WHERE ID = @IDNuevo
     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
      SELECT @Empresa = Empresa , @Sucursal = Sucursal   
       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Venta',1) 
       WITH ( Empresa varchar(100), Sucursal varchar(100))
     EXEC sp_xml_removedocument @iSolicitud         

--      SELECT @PlantaSucEmpresa = PlantaSucEmpresa
--        FROM Version
--
--      IF @PlantaSucEmpresa = 'Empresa' 
      SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService
        FROM Alm
       WHERE Almacen = @Almacen
--
--      IF @PlantaSucEmpresa = 'Sucursal' 
--      SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService
--        FROM Sucursal
--       WHERE Sucursal = @Sucursal
     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud

     INSERT @Tabla (Serie,      ID,   NumeroDePedido, CodigoCliente, FechaPedido,  FechaEntrega, CodigoProveedor,      SuPedido,   Referencia, FormaDePago,     TipoDeEfecto,   EntregarA, ServirDesde, Observaciones_1, Moneda, EstadoPedido,   EnviarConfirmacion,   FechaDeAlta,   FechaUltimaModificacion, UsuarioAlta, PedidoPorRepresentante,   Zona,         Departamento, PeriodoFacturacion,       ReferenciaIntelisisService, Estatus,Sucursal)
     SELECT         @Serie,ID,   @MovIDP,             Cliente,       FechaEmision, FechaEntrega, CodigoProveedor=null, Referencia, Referencia, FormaDePago='1', TipoDeEfecto=1, EnviarA,   Almacen,     Mov+' '+MovID,   Moneda, EstadoPedido=1, EnviarConfirmacion=0, FechaRegistro, FechaRegistro,           Usuario,     PedidoPorRepresentante=0, ZonaImpuesto, Departamento, PeriodoFacturacion=0, @ReferenciaIntelisisService, Estatus ,@Sucursal     
                       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Venta',1) 
                                      WITH ( ID varchar(100),Mov varchar(100), MovID varchar(100), Cliente varchar(100),FechaEmision varchar(100),Referencia varchar(100),Almacen varchar(100),FechaEntrega varchar(100),Moneda varchar(100), EnviarA varchar(100), Observaciones varchar(100), FechaRegistro varchar(100), Usuario varchar(100), ZonaImpuesto varchar(100), Departamento varchar(100), RenglonID varchar(100), Articulo varchar(100), FechaRequerida varchar(100), PrecioLista varchar(100), Unidad varchar(100), Factor varchar(100), Cantidad varchar(100), Precio varchar(100),  UltimoCosto  varchar(100),   Costo  varchar(100), CostoUEPS varchar(100), Estatus varchar(100))
     EXEC sp_xml_removedocument @iSolicitud      
     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud

    INSERT @Tabla2(Serie,        NumeroOrdenLinea, CodigoArticulo, SubCuenta,Estado,   FechaEntregaConfirmada, PrecioUnitario, UnidMedidaAlmacen, PresentacionPedida, FactorConversionUnidades, CantidadPedida, AlmacenSalida, FechaEntregaRequerida, FechaConfirmado,      CantidadServida,      FechaUltimaModificacion, UsuarioAltaD, UsuarioModificacion, FechaEntregaInicial, FechaConfirmadaInicial, SuReferencia,  ImporteLinea,                                  CantidadIntroducida, CosteEstandar, CosteMedio, CosteUltimo, Familia,      Subfamilia,      FechaLlegadaRequerida, FechaLlegadaConfirmada,CantidadCancelada,CantidadReservada,CantidadPendiente)
     SELECT        @Serie,   RenglonID,        Articulo,  SubCuenta,    Estado=1, FechaRequerida,         PrecioLista,    Unidad,            Unidad,             Factor,                   Cantidad,       Almacen,       FechaRequerida,        FechaConfirmado=Null, CantidadServida=Null, FechaRegistro,            Usuario,      Usuario,             FechaRequerida,      FechaRequerida,         Referencia,   (CONVERT(float,ISNULL (Cantidad,1.00))* CONVERT(float,ISNULL( Precio,0.00))) , Cantidad,           CostoEstandar, Costo,      UltimoCosto, Familia=null, Subfamilia=null, FechaRequerida,        FechaRequerida       , CantidadCancelada,CantidadReservada,CantidadPendiente
                       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/VentaD',1) 
                                      WITH ( ID varchar(100), Cliente varchar(100),SubCuenta varchar(100),FechaEmision varchar(100),Referencia varchar(100),Almacen varchar(100),FechaEntrega varchar(100),Moneda varchar(100), EnviarA varchar(100), Observaciones varchar(100), FechaRegistro varchar(100), Usuario varchar(100), ZonaImpuesto varchar(100), Departamento varchar(100), RenglonID varchar(100), Articulo varchar(100), FechaRequerida varchar(100), PrecioLista varchar(100), Unidad varchar(100), Factor varchar(100), Cantidad float, Precio varchar(100),  UltimoCosto  varchar(100),   Costo  varchar(100), CostoEstandar varchar(100),CantidadCancelada float, CantidadReservada float,CantidadPendiente float)
     EXEC sp_xml_removedocument @iSolicitud

     UPDATE @Tabla2 SET CantidadPedida = (ISNULL(CantidadPedida,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
         CantidadServida = (ISNULL(CantidadServida,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
         CantidadIntroducida = (ISNULL(CantidadIntroducida,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
         CantidadReservada = (ISNULL(CantidadReservada,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
         CantidadPendiente = (ISNULL(CantidadPendiente,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
         CantidadCancelada = (ISNULL(CantidadPedida,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
         UnidMedidaAlmacen =  dbo.fnInforArtUnidadCompra(CodigoArticulo)              
     INSERT @Tabla3(Serie,        NumeroOrdenLinea, CodigoArticulo,SubCuenta, Estado,   FechaEntregaConfirmada, PrecioUnitario, UnidMedidaAlmacen, PresentacionPedida, FactorConversionUnidades, CantidadPedida, AlmacenSalida, FechaEntregaRequerida, FechaConfirmado,      CantidadServida,      FechaUltimaModificacion, UsuarioAltaD, UsuarioModificacion, FechaEntregaInicial, FechaConfirmadaInicial, SuReferencia,  ImporteLinea,                                  CantidadIntroducida, CosteEstandar, CosteMedio, CosteUltimo, Familia,      Subfamilia,      FechaLlegadaRequerida, FechaLlegadaConfirmada,CantidadCancelada,CantidadReservada,CantidadPendiente, Planta)
     SELECT a.Serie,        a.NumeroOrdenLinea, a.CodigoArticulo,a.SubCuenta, a.Estado,   a.FechaEntregaConfirmada, a.PrecioUnitario, a.UnidMedidaAlmacen, a.PresentacionPedida, a.FactorConversionUnidades, a.CantidadPedida, a.AlmacenSalida, a.FechaEntregaRequerida, a.FechaConfirmado,      a.CantidadServida,      a.FechaUltimaModificacion, a.UsuarioAltaD, a.UsuarioModificacion, a.FechaEntregaInicial, a.FechaConfirmadaInicial, a.SuReferencia,  a.ImporteLinea,                                  a.CantidadIntroducida, a.CosteEstandar, a.CosteMedio, a.CosteUltimo, a.Familia,      a.Subfamilia,      a.FechaLlegadaRequerida, a.FechaLlegadaConfirmada,a.CantidadCancelada,a.CantidadReservada,a.CantidadPendiente,c.INFORClavePlanta
       FROM @Tabla2 a LEFT OUTER JOIN Art b ON a.CodigoArticulo = b.Articulo LEFT OUTER JOIN Alm c ON c.Almacen= b.INFORAlmacenProd
      WHERE ISNULL(b.EsFactory,0) = 1  AND ISNULL(c.EsFactory,0) = 1


     SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService from @Tabla

     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oPedidoVentaCab FOR XML AUTO))
     SET @Resultado3 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla3 oPedidoVentaLinea FOR XML AUTO))
     SELECT @Resultado4 = @Resultado2 + @Resultado3

     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) + 'Infor.Movimiento.Cancelar.VTAS_F' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado4 + '</Solicitud></Intelisis>'                        
     EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado4,@Ok Output,@OkRef Output,0,0,@IDNuevo Output      

  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
    BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
    COMMIT TRANSACTION
    END ELSE
    BEGIN
      ROLLBACK TRANSACTION
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')    
    END
  END
 END
GO



/**************** spInforTransferenciaCOMS_O ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforTransferenciaCOMS_O') and type = 'P') drop procedure dbo.spInforTransferenciaCOMS_O
GO             
CREATE PROCEDURE spInforTransferenciaCOMS_O
                               @ID                                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                       int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE
                               @IDO                                         varchar(10),
                               @Datos                                                     varchar(max),
                               @Solicitud                                               varchar(max),
                               @ReferenciaIS                                        varchar(100),
                               @SubReferencia                                    varchar(100),
                               @IDNuevo                                               int,
                               @Datos2                                   varchar(max),
                               @Resultado2                                           varchar(max),
                               @Resultado3                                           varchar(max),
                               @Resultado4                                           varchar(max),
                               @Usuario                                                 varchar(10),
                               @Contrasena                                          varchar(32),
                               @Almacen                            varchar(10),
                               @ArtSecundario                      varchar(20),
                               @Articulop                          varchar(20),
                               @Mov                                varchar(20),
                               @Serie                              varchar(20),
                               @Empresa                            varchar(5),
                               @ReferenciaIntelisisService                varchar(50),
                               @Sucursal                           int


DECLARE
                               @Tabla                                table
                               (
                                               Serie                                      varchar(3),
                                               NumeroDePedido                                             varchar(20),
                                               CodigoProveedor                                              varchar(10),
                                               FechaPedido                                                    datetime,
                                               Aprovisionamiento                                          int,
                                               MargenSeguridad                            int,
                                               SuPedido                            varchar(40),
                                               Referencia                          varchar(40),
                                               FormaDePago                                                   varchar(2),
                                               TipoDeEfecto                                                     int,
                                               EntregarA                            varchar(10),
                                               RazonSocialProveedor                             varchar(40),
                                               NombreProveedor                           varchar(40),
                                               Observaciones_1                              varchar(40),
                                               ValorarPedido                                                   bit,
                                               Moneda                               varchar(10),
                                               EstadoPedido                                                   varchar(40),
                                               EnviarConfirmacion                                         bit,
                                               EnviarAvisoExpedicion                            bit,
                                               FechaDeAlta                                                     datetime,
                                               UsuarioAlta                         varchar(10),
                                               FechaSolicitudAProveedor                     datetime,
                                               FechaRecepcionSolicitadaCompra                      datetime,
                                               FechaRecepcionConfirmadaCompra                  datetime,
                                               ReferenciaIntelisisService              varchar(50),
                                               Estatus                                  varchar(20),
                        ID                                   int,
                        MovIntelisisMES                        varchar(50)
)
  DECLARE
                               @Tabla2                                             table
                                  (    Serie                              varchar(3),
                        NumeroDePedido                                     varchar(20),
                                               NumeroOrdenLinea                                         int,
                                               CodigoArticulo                                   varchar(20),
                                               SubCuenta                               varchar(50),
                                               CantidadPedida                                varchar(40),
                                               Estado                                  varchar(40),
                                               EntregarA                            varchar(10),
                                               FechaRecepcionSolicitadaCompra                      datetime,
                                               FechaRecepcionConfirmada                 datetime,
                                               CantidadRecibida                                           float,
                                               CantidadPendiente                                         float,
                                               PrecioUnitario                                                   varchar(40),
                                               PrecioUnitarioDivisa                                varchar(40),
                                               PorcDescuento1                                               varchar(40),
                                               PorcDescuento2                                               varchar(40),
                                               UnidMedidaAlmacen                       varchar(50),
                                               ImporteLinea                                                     varchar(40),
                                               CosteEstandar                                                   varchar(40),
                                               CosteMedio                         varchar(40),
                                               CosteUltimo                         varchar(40),
                                               FechaEntregaCompra                             datetime,
                                               CantidadReclamada                                        float,
                                               CantidadPendienteReclamar                float,
                                               Cliente                                  varchar(10),
                                               NumeroPedidoLinea                                        int,
                                               CantDisponible                                                 float,
                        CantidadCancelada                                float,
                        ArticuloSecundario                      varchar(20)
            )
                  BEGIN TRANSACTION

                  IF @Ok IS NULL
                  BEGIN



      SELECT @Almacen = Almacen, @Empresa = Empresa, @IDO = ID, @Sucursal = Sucursal FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
        WITH (Almacen varchar(255), Empresa varchar(5),ID varchar(255), Sucursal int)

      SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
        FROM IntelisisService
       WHERE ID = @ID

      SELECT @Contrasena = Contrasena
                    FROM Usuario
       WHERE Usuario = @Usuario

    SELECT @Mov = Mov FROM Compra WHERE ID = @IDO
    SELECT @Serie = SerieMES FROM MovTipo WHERE Mov = @Mov
    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'


    SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.COMS.Mov.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="ID" Valor="'+@IDO+'"/></Solicitud></Intelisis>'

    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

    SELECT @Solicitud = Resultado
      FROM IntelisisService
     WHERE ID = @IDNuevo


      EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud


     INSERT @Tabla (Serie,                  NumeroDePedido,  CodigoProveedor, FechaPedido,   Aprovisionamiento,   MargenSeguridad,   SuPedido,  Referencia,  FormaDePago,     TipoDeEfecto,    EntregarA, RazonSocialProveedor,      NombreProveedor,      Observaciones_1,  ValorarPedido,       Moneda,     EnviarConfirmacion,   EnviarAvisoExpedicion,   FechaDeAlta,    UsuarioAlta,  FechaSolicitudAProveedor,  FechaRecepcionSolicitadaCompra, FechaRecepcionConfirmadaCompra,  Estatus,ID,MovIntelisisMES)
     SELECT         ISNULL(@Serie,'IP1'),   MovID,           Proveedor,       FechaRegistro, Aprovisionamiento=0, MargenSeguridad=0, OrigenID,  Referencia,  FormaDePago='1', TipoDeEfecto = 1, Almacen,  RazonSocialProveedor=NULL, NombreProveedor=NULL, Observaciones,    ValorarPedido = 1,   Moneda,     EnviarConfirmacion=0, EnviarAvisoExpedicion=0, FechaRegistro,  Usuario,      FechaEmision,              FechaRequerida,           FechaEntrega,                             Estatus   , @IDO,MovIntelisisMES            
       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Compra',1) 
       WITH ( Cliente varchar(100), Proveedor varchar(100),OrigenID varchar(100),Referencia varchar(100),Almacen varchar(100),Observaciones varchar(100),Moneda varchar(100), FechaRegistro varchar(100), Usuario varchar(100), FechaEmision varchar(100), MovID varchar(100), RenglonID varchar(100), Articulo varchar(100), Estatus varchar(100), FechaConclusion varchar(100), Cantidad float, CantidadPendiente float, PrecioLista varchar(100), DescuentoLinea varchar(100), DescuentoImporte varchar(100), Costo varchar(100), CostoInv varchar(100), CostoUEPS varchar(100), FechaRequerida varchar(100), CantidadPendienteCliente varchar(100),FechaEntrega varchar(100),MovIntelisisMES varchar(100))
     EXEC sp_xml_removedocument @iSolicitud      

     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
     INSERT @Tabla2(Serie, NumeroDePedido,  NumeroOrdenLinea,    CodigoArticulo,SubCuenta, CantidadPedida, EntregarA , FechaRecepcionSolicitadaCompra,   CantidadRecibida,   PrecioUnitario,     PorcDescuento1,  PorcDescuento2,  UnidMedidaAlmacen, ImporteLinea,  CosteEstandar,  CosteMedio,  CosteUltimo,  FechaEntregaCompra,  CantidadReclamada,                                             CantidadPendienteReclamar,         Cliente, NumeroPedidoLinea,  CantDisponible,CantidadCancelada)
     SELECT  ISNULL(@Serie,'IP1'),  MovID,            RenglonID,           Articulo,      SubCuenta,Cantidad,         Almacen,    FechaRequerida,                  0.0,            PrecioLista,    DescuentoLinea,  DescuentoImporte, Unidad,           ISNULL(Costo,0),         ISNULL(Costo,0),          ISNULL(CostoInv,0),    ISNULL(CostoUEPS,0),    FechaEntrega,      ( ISNULL(Cantidad,0.00) + ISNULL(CantidadPendiente,0.00)),ISNULL(CantidadPendiente,0.00),         Cliente, RenglonID,          Cantidad  ,   CantidadCancelada
           FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Compra/CompraD',1)

        WITH ( Cliente varchar(100), Almacen varchar(100),SubCuenta varchar(100),FechaEntrega varchar(100), Moneda varchar(100), Unidad varchar(100), MovID varchar(100), RenglonID varchar(100), Articulo varchar(100), FechaConclusion varchar(100), Cantidad float, CantidadPendiente float, PrecioLista varchar(100), DescuentoLinea varchar(100), DescuentoImporte varchar(100), Costo varchar(100), CostoInv varchar(100), CostoUEPS varchar(100), FechaRequerida varchar(100),CantidadCancelada float)            
     EXEC sp_xml_removedocument @iSolicitud      
     UPDATE @Tabla2 SET CantidadPedida = ( ISNULL(CantidadPedida,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                   CantidadReclamada = ( ISNULL(CantidadReclamada,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                   CantidadPendienteReclamar = ( ISNULL(CantidadPendienteReclamar,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                  CantDisponible = ( ISNULL(CantDisponible,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                   CantidadCancelada = ( ISNULL(CantidadCancelada,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                   UnidMedidaAlmacen =  dbo.fnInforArtUnidadCompra(CodigoArticulo)

     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oCompraCab FOR XML AUTO))
     SET @Resultado3 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla2 oCompraLinea FOR XML AUTO))
     SELECT @Resultado4 = @Resultado2 + @Resultado3
     SELECT @ReferenciaIntelisisService = Referencia
       FROM MapeoPlantaIntelisisMes
      WHERE Empresa = @Empresa AND Sucursal = @Sucursal

     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) + 'Infor.Movimiento.Procesar.COMS_O' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ModuloID='+ CHAR(34)  +@IDO+ CHAR(34)+ ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado4 +'</Solicitud></Intelisis>'                   
     EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado4,@Ok Output,@OkRef Output,0,0,@IDNuevo Output      


    IF @Ok IS NULL
    BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
    COMMIT TRANSACTION
    END ELSE
    BEGIN
      ROLLBACK TRANSACTION
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')   
    END
  END
 END
go


/**************** spInforTransferenciaCOMS_OC  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforTransferenciaCOMS_OC') and type = 'P') drop procedure dbo.spInforTransferenciaCOMS_OC
GO            
CREATE PROCEDURE spInforTransferenciaCOMS_OC
                               @ID                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                                      int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE
                               @IDO                                     varchar(10),
                               @Datos                                                 varchar(max),
                               @Solicitud                                           varchar(max),
                               @ReferenciaIS                                    varchar(100),
                               @SubReferencia                                varchar(100),
                               @IDNuevo                                           int,
                               @Datos2                               varchar(max),
                               @Resultado2                                       varchar(max),
                               @Resultado3                                       varchar(max),
                               @Resultado4                                       varchar(max),
                               @Usuario                                             varchar(10),
                               @Contrasena                                      varchar(32),
                               @Almacen                        varchar(10),
                               @ArtSecundario                  varchar(20),
                               @Articulop                      varchar(20),
                               @Empresa                        varchar(5),
                               @ReferenciaIntelisisService            varchar(50),
                               @Sucursal                       int


DECLARE
                               @Tabla                                table
                               (
                                               Serie                                                     varchar(3),
                                               NumeroDePedido                             varchar(20),
                                               CodigoProveedor                              varchar(10),
                                               FechaPedido                                    datetime,
                                               Aprovisionamiento                          int,
                                               MargenSeguridad                                            int,
                                               SuPedido                                           varchar(40),
                                               Referencia                                         varchar(40),
                                               FormaDePago                                   varchar(2),
                                               TipoDeEfecto                                     int,
                                               EntregarA                                           varchar(10),
                                               RazonSocialProveedor                     varchar(40),
                                               NombreProveedor                                          varchar(40),
                                               Observaciones_1                                             varchar(40),
                                               ValorarPedido                                   bit,
                                               Moneda                                              varchar(10),
                                               EstadoPedido                                   varchar(40),
                                               EnviarConfirmacion                         bit,
                                               EnviarAvisoExpedicion                    bit,
                                               FechaDeAlta                                     datetime,
                                               UsuarioAlta                                        varchar(10),
                                               FechaSolicitudAProveedor             datetime,
                                               FechaRecepcionSolicitada             datetime,
                                               FechaRecepcionConfirmada         datetime,
                                               ReferenciaIntelisisService      varchar(50),
                                               Estatus                                                  varchar(20)
)
  DECLARE
                               @Tabla2                                             table
                                  (    Serie                                              varchar(3),
                        NumeroDePedido                                     varchar(20),
                                               NumeroOrdenLinea                                         int,
                                               CodigoArticulo                                   varchar(20),
                                               SubCuenta                                          varchar(50),
                                               CantidadPedida                                float,
                                               Estado                                  varchar(40),
                                               EntregarA                            varchar(10),
                                               FechaRecepcionSolicitada                     datetime,
                                               FechaRecepcionConfirmada                 datetime,
                                               CantidadRecibida                                           float,
                                               CantidadPendiente                                         float,
                                               PrecioUnitario                                                   float,
                                               PrecioUnitarioDivisa                                float,
                                               PorcDescuento1                                               float,
                                               PorcDescuento2                                               float,
                                               UnidMedidaAlmacen                       varchar(50),
                                               ImporteLinea                                                     float,
                                               CosteEstandar                                                   float,
                                               CosteMedio                         float,
                                               CosteUltimo                         float,
                                               FechaRecepcionFirme                                    datetime,
                                               CantidadReclamada                                        float,
                                               CantidadPendienteReclamar                float,
                                               Cliente                                  varchar(10),
                                               NumeroPedidoLinea                                        int,
                                               CantDisponible                                                 float,
                        CantidadCancelada                                float,
                        ArticuloSecundario                      varchar(20)
            )
  BEGIN TRANSACTION
  IF @Ok IS NULL
  BEGIN   
      SELECT @IDO = ID, @Empresa = Empresa, @Sucursal = Sucursal FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
        WITH (ID varchar(255), Empresa varchar(5), Sucursal int)

      SELECT @Almacen = Almacen FROM Venta WHERE ID = @IDO
      SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
        FROM IntelisisService
       WHERE ID = @ID

      SELECT @Contrasena = Contrasena
                    FROM Usuario
       WHERE Usuario = @Usuario


    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'


    SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.COMS.Mov.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="ID" Valor="'+@IDO+'"/></Solicitud></Intelisis>'

    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

    SELECT @Solicitud = Resultado
      FROM IntelisisService
     WHERE ID = @IDNuevo


      EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud




     INSERT @Tabla (Serie,  NumeroDePedido,  CodigoProveedor, FechaPedido,   Aprovisionamiento,   MargenSeguridad, SuPedido,  Referencia,  FormaDePago,  TipoDeEfecto,   EntregarA, RazonSocialProveedor,      NombreProveedor,      Observaciones_1,  ValorarPedido,       Moneda,    EnviarConfirmacion,   EnviarAvisoExpedicion,   FechaDeAlta,    UsuarioAlta,  FechaSolicitudAProveedor,  FechaRecepcionSolicitada, FechaRecepcionConfirmada,  Estatus)
     SELECT         'IP1',  MovID,           Proveedor,       FechaRegistro, 0,                   0,               OrigenID,  Referencia,  '1',          1,              Almacen,   RazonSocialProveedor=NULL, NombreProveedor=NULL, Observaciones,    ValorarPedido = 1,   Moneda,    EnviarConfirmacion=0, EnviarAvisoExpedicion=0, FechaRegistro,  Usuario,      FechaEmision,              FechaRequerida,           FechaEntrega,                       Estatus              
       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Compra',1) 
       WITH ( Cliente varchar(100), Proveedor varchar(100),OrigenID varchar(100),Referencia varchar(100),Almacen varchar(100),Observaciones varchar(100),Moneda varchar(100), FechaRegistro varchar(100), Usuario varchar(100), FechaEmision varchar(100), MovID varchar(100), RenglonID varchar(100), Articulo varchar(100), Estatus varchar(100), FechaConclusion varchar(100), Cantidad varchar(100), CantidadPendiente varchar(100), PrecioLista varchar(100), DescuentoLinea varchar(100), DescuentoImporte varchar(100), Costo varchar(100), CostoInv varchar(100), CostoUEPS varchar(100), FechaRequerida varchar(100), CantidadPendienteCliente varchar(100),FechaEntrega varchar(100))
     EXEC sp_xml_removedocument @iSolicitud      

     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
     INSERT @Tabla2(Serie, NumeroDePedido,  NumeroOrdenLinea,    CodigoArticulo,SubCuenta, CantidadPedida, EntregarA ,              FechaRecepcionSolicitada,   CantidadRecibida,   PrecioUnitario,     PorcDescuento1,  PorcDescuento2,  UnidMedidaAlmacen, ImporteLinea,  CosteEstandar,  CosteMedio,  CosteUltimo,  FechaRecepcionFirme,  CantidadReclamada,                           CantidadPendienteReclamar,         Cliente, NumeroPedidoLinea,  CantDisponible,CantidadCancelada)
     SELECT         'IP1',  MovID,            RenglonID,           Articulo, SubCuenta,     Cantidad,      Almacen,  FechaRequerida,                  0.0,            PrecioLista,    DescuentoLinea,  DescuentoImporte, Unidad,           Costo,         Costo,          CostoInv,    CostoUEPS,    FechaRequerida,          ( ISNULL(Cantidad,0.00) + ISNULL(CantidadPendiente,0.00)) , ISNULL(CantidadPendiente,0.00),    Cliente, RenglonID,          Cantidad  ,   CantidadCancelada 
       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Compra/CompraD',1)                                                       
        WITH ( Cliente varchar(100), Almacen varchar(100), SubCuenta varchar(100), Moneda varchar(100), Unidad varchar(100), MovID varchar(100), RenglonID varchar(100), Articulo varchar(100), FechaConclusion varchar(100), Cantidad float, CantidadPendiente float, PrecioLista varchar(100), DescuentoLinea varchar(100), DescuentoImporte varchar(100), Costo varchar(100), CostoInv varchar(100), CostoUEPS varchar(100), FechaRequerida varchar(100),CantidadCancelada varchar(100))                
     EXEC sp_xml_removedocument @iSolicitud      

          UPDATE @Tabla2 SET CantidadPedida = (ISNULL(CantidadPedida,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                   CantidadReclamada = (ISNULL(CantidadReclamada,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                   CantidadPendienteReclamar = (ISNULL(CantidadPendienteReclamar,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                   CantDisponible = (ISNULL(CantDisponible,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                   CantidadCancelada = (ISNULL(CantidadCancelada,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                   UnidMedidaAlmacen =  dbo.fnInforArtUnidadCompra(CodigoArticulo)


     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oCompraCab FOR XML AUTO))
     SET @Resultado3 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla2 oCompraLinea FOR XML AUTO))
     SELECT @Resultado4 = @Resultado2 + @Resultado3
     SELECT @ReferenciaIntelisisService = Referencia
       FROM MapeoPlantaIntelisisMes
      WHERE Empresa = @Empresa AND Sucursal = @Sucursal

     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) + 'Infor.Movimiento.Procesar.COMS_OC' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ModuloID='+ CHAR(34)  +@IDO+ CHAR(34)+ ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' >' + @Resultado4 +'</Solicitud></Intelisis>'                    
     EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado4,@Ok Output,@OkRef Output,0,0,@IDNuevo Output      

  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
    BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
    COMMIT TRANSACTION
    END ELSE
    BEGIN
      ROLLBACK TRANSACTION
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')   
    END
  END
 END
go





/**************** spInforTransferenciaCOMS_F  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforTransferenciaCOMS_F') and type = 'P') drop procedure dbo.spInforTransferenciaCOMS_F
GO           
CREATE PROCEDURE spInforTransferenciaCOMS_F
            @ID                     int,
            @iSolicitud       int,
            @Version          float,
            @Resultado        varchar(max) = NULL OUTPUT,
            @Ok                     int = NULL OUTPUT,  
            @OkRef                  varchar(255) = NULL OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
            @IDO                                           varchar(10),
            @Datos                                               varchar(max),
            @Solicitud                                     varchar(max),
            @ReferenciaIS                                          varchar(100),
            @SubReferencia                                         varchar(100),
            @IDNuevo                                       int,
            @Datos2                                              varchar(max),
            @Resultado2                                    varchar(max),
            @Resultado3                                    varchar(max),
            @Resultado4                                    varchar(max),
            @Usuario                                       varchar(10),
            @Contrasena                                    varchar(32),
            @ReferenciaIntelisisService                              varchar(50),
            @Empresa                                       varchar(5)  ,
            @Sucursal                                      int,
            @PlantaSucEmpresa                                varchar(10),
            @CantidadPendiente                                     float,
            @CantidadRecibida                                float,
            @Cantidad                                      float,
            @IDP                                           int,
            @ArticuloP                                     varchar(20),
            @MovID                                               varchar(20),
            @MovIDO                                              varchar(20),
            @FechaConclusion                                 datetime,
            @Moneda                                              varchar(10),
            @MovO                                          varchar(20),
            @Mov                                           varchar(20),
            @OrigenID                                      varchar(20),
            @Estatus                                       varchar(20),
            @Estatus2                                      varchar(20),
            @Almacen                                       varchar(10),
            @Almacenp                                      varchar(10),
            @ArtSecudario                                                   varchar(20),
           @Serie                           varchar(3)                             

DECLARE
            @Tabla                 table
            (
                  Serie                               varchar(3),
                  NumeroDePedido                varchar(20),
                  CodigoProveedor              varchar(10),
                  FechaPedido                  datetime,
                  Aprovisionamiento            int,
                  MargenSeguridad                    int,
                  SuPedido                     varchar(40),
                  Referencia                   varchar(40),
                  FormaDePago                         varchar(2),
                  TipoDeEfecto                        int,
                  EntregarA                    varchar(10),
                  RazonSocialProveedor                 varchar(40),
                  NombreProveedor                    varchar(40),
                  Observaciones_1                    varchar(40),
                  ValorarPedido                      bit,
                  Moneda                        varchar(10),
                  EstadoPedido                       varchar(40),
                  EnviarConfirmacion                 bit,
                  EnviarAvisoExpedicion                bit,
                  FechaDeAlta                  datetime,
                  UsuarioAlta                  varchar(10),
                  FechaSolicitudAProveedor             datetime,
                  FechaRecepcionSolicitada             datetime,
                  FechaRecepcionConfirmada             datetime,
                  ReferenciaIntelisisService              varchar(50),
                  Estatus                            varchar(20),
                  EstatusOC                    varchar(20)
)
  DECLARE
            @Tabla2                table
               (  Serie                         varchar(3),
                  NumeroDePedido                varchar(20),
                  NumeroOrdenLinea              int,
                  CodigoArticulo                varchar(20),
                  SubCuenta                     varchar(50),
                  CantidadPedida                float,
                  Estado                        varchar(40),
                  EntregarA                     varchar(10),
                  FechaRecepcionSolicitada      datetime,
                  FechaRecepcionConfirmada      datetime,
                  CantidadRecibida              float,
                  CantidadPendiente             float,
                  PrecioUnitario                float,
                  PrecioUnitarioDivisa          varchar(40),
                  PorcDescuento1                varchar(40),
                  PorcDescuento2                varchar(40),
                  UnidMedidaAlmacen             varchar(50),
                  ImporteLinea                  float,
                  CosteEstandar                 float,
                  CosteMedio                    float,
                  CosteUltimo                   float,
                  FechaRecepcionFirme           datetime,
                  CantidadReclamada             float,
                  CantidadPendienteReclamar     float,
                  Cliente                       varchar(8),
                  NumeroPedidoLinea             int,
                  CantDisponible                varchar(40),
                  CantidadCancelada             varchar(40),
                  ArticuloSecundario            varchar(20)
                  )
  DECLARE
            @Tabla3                table
               (  CantidadPendiente            varchar(40),
                    Cantidad              varchar(40),
                    Articulo              varchar(20),
                    Almacen                       varchar(20)
                  )
  BEGIN TRANSACTION
  IF @Ok IS NULL
  BEGIN
    SELECT @IDO = ID FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH (ID varchar(255))
    SELECT @MovO = Origen ,@MovIDO = OrigenID,  @Empresa = Empresa , @Sucursal = Sucursal
      FROM Compra
     WHERE ID = @IDO

    SELECT @IDP =ID ,@Estatus2 = Estatus
      FROM Compra
     WHERE Mov = @MovO AND MovID = @MovIDO AND Empresa = @Empresa AND Sucursal = @Sucursal
    SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
      FROM IntelisisService
     WHERE ID = @ID
    SELECT @Contrasena = Contrasena
      FROM Usuario
     WHERE Usuario = @Usuario
     
    SELECT @Serie = SerieMES FROM MovTipo WHERE Mov = @Mov AND Modulo = 'COMS'
    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'

    SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.COMS.Mov.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="ID" Valor="'+@IDO+'"/></Solicitud></Intelisis>'

    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output
    SELECT @Solicitud = Resultado
      FROM IntelisisService
     WHERE ID = @IDNuevo
     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
      SELECT @Empresa = Empresa , @Sucursal = Sucursal 
       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Compra',1)
       WITH ( Empresa varchar(100), Sucursal varchar(100))
     EXEC sp_xml_removedocument @iSolicitud     

   SELECT @Mov = Mov, @MovID = MovID, @FechaConclusion = FechaConclusion, @Moneda = Moneda, @OrigenID = OrigenID,  @Almacen = Almacen ,@Estatus = Estatus
     FROM Compra
    WHERE ID = @IDO
     SELECT @Serie = SerieMES FROM MovTipo WHERE Mov = @Mov
     SELECT @ReferenciaIntelisisService = Referencia
       FROM MapeoPlantaIntelisisMes
      WHERE Empresa = @Empresa AND Sucursal = @Sucursal
      EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud

     INSERT @Tabla (Serie, NumeroDePedido,  CodigoProveedor,  FechaPedido,   Aprovisionamiento,   MargenSeguridad,   SuPedido,  Referencia,  FormaDePago,     TipoDeEfecto,    EntregarA, RazonSocialProveedor,      NombreProveedor,      Observaciones_1,  ValorarPedido,       Moneda,   EstadoPedido,   EnviarConfirmacion,   EnviarAvisoExpedicion,   FechaDeAlta,    UsuarioAlta,  FechaSolicitudAProveedor,  FechaRecepcionSolicitada, FechaRecepcionConfirmada, ReferenciaIntelisisService,  Estatus,   EstatusOC)
     SELECT ISNULL(@Serie,'IP1'),  ISNULL(@IDP,''), Proveedor,        FechaRegistro, Aprovisionamiento=0, MargenSeguridad=0, OrigenID,  Referencia,  FormaDePago='1', TipoDeEfecto = 1, Almacen,  RazonSocialProveedor=NULL, NombreProveedor=NULL, Observaciones,    ValorarPedido = 1,   Moneda,   @Estatus,       EnviarConfirmacion=0, EnviarAvisoExpedicion=0, FechaRegistro,  Usuario,      FechaEmision,              FechaRequerida,           FechaEntrega,             @ReferenciaIntelisisService, @Estatus  ,@Estatus2           
       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Compra',1)
       WITH ( Cliente varchar(100), Proveedor varchar(100),OrigenID varchar(100),Referencia varchar(100),Almacen varchar(100),Observaciones varchar(100),Moneda varchar(100), FechaRegistro varchar(100), Usuario varchar(100), FechaEmision varchar(100), MovID varchar(100), RenglonID varchar(100), Articulo varchar(100), Estatus varchar(100), FechaConclusion varchar(100), Cantidad varchar(100), CantidadPendiente varchar(100), PrecioLista varchar(100), DescuentoLinea varchar(100), DescuentoImporte varchar(100), Costo varchar(100), CostoInv varchar(100), CostoUEPS varchar(100), FechaRequerida varchar(100), CantidadPendienteCliente varchar(100),FechaEntrega varchar(100))
     EXEC sp_xml_removedocument @iSolicitud  

     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
     INSERT @Tabla2(Serie, NumeroDePedido,           NumeroOrdenLinea,    CodigoArticulo, SubCuenta, CantidadPedida, Estado,    EntregarA , FechaRecepcionSolicitada, FechaRecepcionConfirmada,  CantidadRecibida,   PrecioUnitario,  PrecioUnitarioDivisa,    PorcDescuento1,  PorcDescuento2,  UnidMedidaAlmacen, ImporteLinea,  CosteEstandar,  CosteMedio,  CosteUltimo,  FechaRecepcionFirme,  CantidadReclamada,                                             CantidadPendienteReclamar,         Cliente, NumeroPedidoLinea,  CantDisponible,CantidadCancelada)
     SELECT         ISNULL(@Serie,'IP1'),  ISNULL(@IDP,''),  RenglonID,           Articulo,       SubCuenta, Cantidad,       @Estatus,  Almacen,    FechaRequerida,           @FechaConclusion,           0.0,            PrecioLista,    @Moneda,   DescuentoLinea,  DescuentoImporte, Unidad,           ISNULL(NULLIF(Costo,''),0),         CONVERT(money,ISNULL(NULLIF(Costo,''),0)),          CONVERT(money,ISNULL(NULLIF(CostoInv,''),0)),    CONVERT(money,ISNULL(NULLIF(CostoUEPS,''),0)),    FechaRequerida, isnull(CONVERT(float,Cantidad),0.0) +isnull(CONVERT(float,CantidadPendiente),isnull(convert(float,CantidadReservada),0.0)),isnull(CantidadPendiente,0.0) ,            Cliente, RenglonID,          Cantidad  ,   CantidadCancelada
       FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Compra/CompraD',1)
       WITH ( Cliente varchar(100), Almacen varchar(100), Moneda varchar(100),SubCuenta varchar(100), Unidad varchar(100), MovID varchar(100), RenglonID varchar(100), Articulo varchar(100), FechaConclusion varchar(100), Cantidad float, CantidadPendiente float, PrecioLista float, DescuentoLinea varchar(100), DescuentoImporte varchar(100), Costo float, CostoInv float, CostoUEPS float, FechaRequerida varchar(100),CantidadCancelada float,CantidadReservada float)  
     EXEC sp_xml_removedocument @iSolicitud  
     SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService from @Tabla
     UPDATE @Tabla2 SET CantidadPedida = (ISNULL(CantidadPedida,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                        CantidadReclamada = (ISNULL(CantidadReclamada,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                        CantidadPendienteReclamar = (ISNULL(CantidadPendienteReclamar,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                        CantDisponible = (ISNULL(CantDisponible,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                        CantidadCancelada = (ISNULL(CantidadCancelada,0.0) * dbo.fnArtUnidadFactor(@Empresa, CodigoArticulo, UnidMedidaAlmacen)) * (dbo.fnInforArtUnidadCompraFactor(@Empresa,CodigoArticulo)) ,
                        UnidMedidaAlmacen =  dbo.fnInforArtUnidadCompra(CodigoArticulo)

     INSERT @Tabla3 (Articulo,CantidadPendiente,Cantidad,Almacen)
     SELECT             d.Articulo, ISNULL(d.CantidadPendiente,0.0),d.Cantidad,c.Almacen
       FROM CompraD d JOIN Compra c ON c.ID = d.ID
      WHERE d.ID = @IDP



     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oPedidoCompraCab FOR XML AUTO))
     SET @Resultado3 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla2 oPedidoCompraLinea FOR XML AUTO))
     SELECT @Resultado4 = @Resultado2 + @Resultado3
     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) + 'Infor.Movimiento.Procesar.COMS_F' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ModuloID='+ CHAR(34)  +@IDO+ CHAR(34)  +' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ '>' + @Resultado4 +'</Solicitud></Intelisis>'          
     EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado4,@Ok Output,@OkRef Output,0,0,@IDNuevo Output 

  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
    BEGIN                                                                                                                                                                                                                        
    COMMIT TRANSACTION
    END ELSE
    BEGIN
      ROLLBACK TRANSACTION
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')  
    END
  END
END
go


/**************** spInforGenerarSolicitudUsuario ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudUsuario') and type = 'P') drop procedure dbo.spInforGenerarSolicitudUsuario
GO 
CREATE PROC spInforGenerarSolicitudUsuario
		@Usuario					varchar (10),
		@Estatus					varchar (10),
		@ReferenciaIntelisisService	varchar(50),
		@Nombre						varchar (10),
		@Alta						datetime,
		@Datos						varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
@AccesoID		int,
@Usuario1		varchar(10),
@Ok				int,
@OkRef			varchar(255),
@Contrasena		varchar(32),
@Resultado		varchar(max),
@Id				int

IF @Estatus IN ('ALTA','CAMBIO')
BEGIN
	SELECT	@Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.Usuario" SubReferencia="'+@Estatus+'" Version="1.0"><Solicitud IntelisisServiceID="" Ok="" OkRef="" ReferenciaIntelisisService="" ><Usuario  Usuario="'+@Usuario+'"	Nombre="'+@Nombre+'"/>  </Solicitud> </Intelisis>'
END

IF @Estatus = 'BAJA'
BEGIN
	SELECT	@Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.Usuario.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0" ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' ><Solicitud IntelisisServiceID="" Ok="" OkRef="" ReferenciaIntelisisService="" ><Usuario Usuario="'+@Usuario+'"	Nombre="'+@Nombre+'" FechaDeAlta="'+isnull(convert(varchar(19), @Alta, 121),'')+'"/> </Solicitud> </Intelisis>'
END

SELECT  @Usuario1 =  dbo.fnAccesoUsuario(@@SPID)

SELECT	@Contrasena = Contrasena
  FROM	Usuario
 WHERE	Usuario = @Usuario1

  IF NOT EXISTS (SELECT ID FROM IntelisisService WHERE Solicitud =  @Datos AND Usuario = @Usuario1 AND ESTATUS = 'SINPROCESAR')
  BEGIN
   --EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output
   EXEC spIntelisisService  @Usuario1,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,0,0,@Id Output
   IF @ID IS NOT NULL         
      INSERT ProcesarIntelisisService (ID, Solicitud) VALUES (@ID, 'Usuario')
  END

END
GO


/**************** spInforGenerarSolicitudUnidad ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudUnidad')           AND type = 'P') drop procedure dbo.spInforGenerarSolicitudUnidad
GO 
CREATE PROC spInforGenerarSolicitudUnidad
		@Unidad         varchar (50),
		@Estatus		  varchar (10),
		@ReferenciaIntelisisService varchar(50),
		@Datos			  varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE 
    @AccesoID							int,
    @Usuario						    varchar(10),
    @Ok									int,
    @OkRef								varchar(255),
    @Contrasena							varchar(32),
    @Resultado							varchar(max),
    @Id									int,
    @Clave                                                      varchar(3)
  
  SELECT @Clave = Clave FROM Unidad WHERE Unidad = @Unidad  
    
  IF @Estatus IN ('ALTA','CAMBIO')

  
  SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.Unidad" SubReferencia="'+@Estatus+'" Version="1.0" ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ '><Solicitud> <Unidad  Unidad="'+@Unidad+'" />  </Solicitud> </Intelisis>'
  IF @Estatus = 'BAJA'
      SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.Unidad.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0" ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' ><Solicitud><Unidad  Unidad="'+ISNULL(@Clave,@Unidad)+'"/> </Solicitud> </Intelisis>'
 
    
  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena 
    FROM Usuario
   WHERE Usuario = @Usuario
   --EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,0,0,@Id Output         
   IF @ID IS NOT NULL      
     INSERT ProcesarIntelisisService (ID, Solicitud) VALUES (@ID, 'Unidad')         

END
go


/**************** spInforGenerarSolicitudSucursal****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudSucursal') and type = 'P') drop procedure dbo.spInforGenerarSolicitudSucursal
GO
CREATE PROC spInforGenerarSolicitudSucursal
                               @Sucursal         varchar (10),
                               @Estatus                                 varchar (10),
                               @ReferenciaIntelisisService                                           varchar(50)          ,
                               @Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int


  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.Sucursal" SubReferencia="'+@Estatus+'" Version="1.0"><Solicitud> <Sucursal  Sucursal="'+@Sucursal+'"/>  </Solicitud> </Intelisis>'

  IF @Estatus = 'BAJA'
       SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.Empresa.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0" ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' ><Solicitud><Sucursal  Sucursal="'+@Sucursal+'"/> </Solicitud> </Intelisis>'

  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output


END
go


/**************** spInforGenerarSolicitudProveedor ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudProveedor') and type = 'P') drop procedure dbo.spInforGenerarSolicitudProveedor
GO 
CREATE PROC spInforGenerarSolicitudProveedor 
		@Proveedor         varchar (10),
		@Estatus		  varchar (10),
        @ReferenciaIntelisisService			varchar(50),
		@Datos			  varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE 
    @AccesoID							int,
    @Usuario						    varchar(10),
    @Ok									int,
    @OkRef								varchar(255),
    @Contrasena							varchar(32),
    @Resultado							varchar(max),
    @Id									int
  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.Prov" SubReferencia="'+@Estatus+'" Version="1.0">
    <Solicitud> <Prov  Proveedor="'+@Proveedor+'"/>  </Solicitud> </Intelisis>'
  
  IF @Estatus = 'BAJA'
      SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Baja.Prov" SubReferencia="'+@Estatus+'" Version="1.0">
                           <Solicitud><Prov  Proveedor="'+@Proveedor+'"/> </Solicitud> </Intelisis>'
 
    
  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena 
	FROM Usuario
   WHERE Usuario = @Usuario
   --EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,0,0,@Id Output         
   IF @ID IS NOT NULL      
     INSERT ProcesarIntelisisService (ID, Solicitud) VALUES (@ID, 'Proveedor')         

END
go

/**************** spInforGenerarSolicitudPlantaUsuario****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudPlantaUsuario') and type = 'P') drop procedure dbo.spInforGenerarSolicitudPlantaUsuario
GO
CREATE PROC spInforGenerarSolicitudPlantaUsuario
                               @Usuario2         varchar (10),
                               @Planta                                                  varchar(8),
                               @Estatus                                 varchar (10),
                               @Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int
  IF @Estatus IN ('ALTA','CAMBIO')

     SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.PlantaUsuario" SubReferencia="'+@Estatus+'" Version="1.0"><Solicitud> <UsuarioPlantaAcceso  Usuario="'+@Usuario2+'"/>  </Solicitud> </Intelisis>'

  IF @Estatus = 'BAJA'
       SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.Planta.Usuario.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0"  ><Solicitud><UsuarioPlantaAcceso  Usuario="'+RTRIM(@Usuario2)+'" Clave="'+@Planta+'"  /> </Solicitud> </Intelisis>'

  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output


END
go

/**************** spInforGenerarSolicitudPlantaProductiva****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudPlantaProductiva') and type = 'P') drop procedure dbo.spInforGenerarSolicitudPlantaProductiva
GO
CREATE PROC spInforGenerarSolicitudPlantaProductiva
                               @Clave         varchar (10),
                               @Estatus                                 varchar (10),
                               @Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int
  IF @Estatus IN ('ALTA','CAMBIO')

     SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.Planta" SubReferencia="'+@Estatus+'" Version="1.0"><Solicitud> <PlantaProductiva  Clave="'+@Clave+'"/>  </Solicitud> </Intelisis>'

  IF @Estatus = 'BAJA'
       SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.Planta.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0"  ><Solicitud><PlantaProductiva  Clave="'+@Clave+'"/> </Solicitud> </Intelisis>'

  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output


END
go


/**************** spInforGenerarSolicitudPersonal ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudPersonal')           AND type = 'P') drop procedure dbo.spInforGenerarSolicitudPersonal
GO 
CREATE PROC spInforGenerarSolicitudPersonal
		@Personal					varchar (10),
		@Estatus					varchar (10),
		@ReferenciaIntelisisService varchar(50),
		@Datos						varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE 
    @AccesoID							int,
    @Usuario						    varchar(10),
    @Ok									int,
    @OkRef								varchar(255),
    @Contrasena							varchar(32),
    @Resultado							varchar(max),
    @Id									int
  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.Personal" SubReferencia="'+@Estatus+'" Version="1.0"> <Solicitud> <Personal  Personal="'+@Personal+'"/>  </Solicitud> </Intelisis>'
  IF @Estatus = 'BAJA'
      SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.Personal.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0" ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' ><Solicitud ><Personal  Personal="'+@Personal+CHAR(34)+'/> </Solicitud> </Intelisis>'
 
    
  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena 
	FROM Usuario
   WHERE Usuario = @Usuario
   --EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,0,0,@Id Output
   IF @ID IS NOT NULL      
     INSERT ProcesarIntelisisService (ID, Solicitud) VALUES (@ID, 'Personal')        

END
go

/**************** spInforGenerarSolicitudPerfilMES ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudPerfilMES') and type = 'P') drop procedure dbo.spInforGenerarSolicitudPerfilMES
GO
CREATE PROC spInforGenerarSolicitudPerfilMES
                               @PerfilMES        varchar (20),
                               @Estatus                                 varchar (10),
                               @Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
   @Id                                                                    int
  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.PerfilMES.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0" ><Solicitud><oGrupo  PerfilMES="'+@PerfilMES+'"/> </Solicitud> </Intelisis>'

  IF @Estatus = 'BAJA'
       SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.PerfilMES.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0" ><Solicitud><oGrupo  PerfilMES="'+@PerfilMES+'"/> </Solicitud> </Intelisis>'

  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output


END
go

/**************** spInforGenerarSolicitudObjetivoVentas ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudObjetivoVentas') and type = 'P') drop procedure dbo.spInforGenerarSolicitudObjetivoVentas
GO
CREATE PROC spInforGenerarSolicitudObjetivoVentas
                                  @FechaD                          DateTime,
                                  @FechaA           DateTime,
                       @Empresa                    varchar(5),
                                  @Sucursal          int
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int,
                                  @Datos                                                varchar (max)

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas" SubReferencia="" Version="1.0">
    <Solicitud> <Objetivo  FechaD="'+CONVERT(varchar,@FechaD)+'" FechaA="'+CONVERT(varchar,@FechaA)+'" Empresa="'+@Empresa+'" Sucursal="'+CONVERT(varchar,@Sucursal)+'"/>  </Solicitud> </Intelisis>'



  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output

END
go

/**************** spInforGenerarSolicitudMoneda ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudMoneda') and type = 'P') drop procedure dbo.spInforGenerarSolicitudMoneda
GO
CREATE PROC spInforGenerarSolicitudMoneda
                               @Moneda            varchar (10),
                               @Estatus                                 varchar (10),
                               @ReferenciaIntelisisService varchar(50),
                               @Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int
  IF @Estatus IN ('ALTA','CAMBIO')
    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.Mon" SubReferencia="'+@Estatus+'" Version="1.0">
    <Solicitud> <Mon Moneda="'+@Moneda+'"/>  </Solicitud> </Intelisis>'

  IF @Estatus = 'BAJA'
      SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Baja.Mon" SubReferencia="'+@Estatus+'" Version="1.0">
                           <Solicitud><Mon Moneda="'+@Moneda+'"/> </Solicitud> </Intelisis>'

  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
    FROM Usuario
   WHERE Usuario = @Usuario

  EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output


END
go

/**************** spInforGenerarSolicitudEmpresa****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudEmpresa') and type = 'P') drop procedure dbo.spInforGenerarSolicitudEmpresa
GO
CREATE PROC spInforGenerarSolicitudEmpresa
                               @Empresa          varchar (50),
                               @Estatus                                 varchar (10),
                               @ReferenciaIntelisisService                                           varchar(50)          ,
                               @Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int
  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.Empresa" SubReferencia="'+@Estatus+'" Version="1.0"><Solicitud> <Empresa  Empresa="'+@Empresa+'"/>  </Solicitud> </Intelisis>'

  IF @Estatus = 'BAJA'
       SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.Empresa.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0" ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' ><Solicitud><Empresa  Empresa="'+@Empresa+'"/> </Solicitud> </Intelisis>'

  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output


END
go

/**************** spInforGenerarSolicitudDepartamento ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudDepartamento') and type = 'P') drop procedure dbo.spInforGenerarSolicitudDepartamento
GO
CREATE PROC spInforGenerarSolicitudDepartamento
                               @Departamento         varchar (50),
                               @Estatus                                 varchar (10),
                               @ReferenciaIntelisisService                                           varchar(50)          ,
                               @Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                            varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int
  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.Departamento" SubReferencia="'+@Estatus+'" Version="1.0"><Solicitud> <Departamento  Departamento="'+@Departamento+'"/>  </Solicitud> </Intelisis>'

  IF @Estatus = 'BAJA'
       SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.Planta.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0" ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' ><Solicitud><Departamento  Departamento="'+@Departamento+'"/> </Solicitud> </Intelisis>'

  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output


END
go

/**************** spInforGenerarSolicitudCteTipo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudCteTipo') and type = 'P') drop procedure dbo.spInforGenerarSolicitudCteTipo
GO
CREATE PROC spInforGenerarSolicitudCteTipo
                               @Tipo            varchar (10),
                               @Estatus                                 varchar (10),
                               @ReferenciaIntelisisService                                           varchar(50)          ,
                               @Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int
  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.CteTipo" SubReferencia="'+@Estatus+'" Version="1.0"><Solicitud> <CteTipo Tipo="'+@Tipo+'"/>  </Solicitud> </Intelisis>'
  IF @Estatus = 'BAJA'
      SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.CteTipo.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0" ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' ><Solicitud><CteTipo Tipo="'+@Tipo+'"/> </Solicitud> </Intelisis>'

  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output


END
go

/**************** spInforGenerarSolicitudCte ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudCte')           AND type = 'P') drop procedure dbo.spInforGenerarSolicitudCte
GO 
CREATE PROC spInforGenerarSolicitudCte
		@Cliente					 varchar (10),
		@Estatus					 varchar (10),
		@ReferenciaIntelisisService  varchar(50),
		@Datos						 varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE 
    @AccesoID							int,
    @Usuario						    varchar(10),
    @Ok									int,
    @OkRef								varchar(255),
    @Contrasena							varchar(32),
    @Resultado							varchar(max),
    @Id									int
  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.Cte" SubReferencia="'+@Estatus+'" Version="1.0"><Solicitud> <Cte  Cliente="'+@Cliente+'"/>  </Solicitud> </Intelisis>'
  IF @Estatus = 'BAJA'
      SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.Cte.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0"'+ ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' ><Solicitud><Cte  Cliente="'+@Cliente+'"/> </Solicitud> </Intelisis>'
 
    
  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena 
	FROM Usuario
   WHERE Usuario = @Usuario
   --EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,0,0,@Id Output
   IF @ID IS NOT NULL      
     INSERT ProcesarIntelisisService (ID, Solicitud) VALUES (@ID, 'Cte')
       
END
go

/**************** spInforGenerarSolicitudArtLinea ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudArtLinea')           AND type = 'P') drop procedure dbo.spInforGenerarSolicitudArtLinea
GO
CREATE PROC spInforGenerarSolicitudArtLinea
                               @Linea         varchar (50),
                               @Estatus                                 varchar (10),
                               @Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int
  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.ArtLinea" SubReferencia="'+@Estatus+'" Version="1.0" ><Solicitud> <ArtLinea  Linea="'+@Linea+'"/>  </Solicitud> </Intelisis>'
  IF @Estatus = 'BAJA'
      SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.ArtLinea.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0"  ><Solicitud><ArtLinea  Linea="'+@Linea+'"/> </Solicitud> </Intelisis>'

  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
    FROM Usuario
   WHERE Usuario = @Usuario
  EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output


END
go

/**************** spInforGenerarSolicitudArticulo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudArticulo') and type = 'P') drop procedure dbo.spInforGenerarSolicitudArticulo
GO 
CREATE PROC spInforGenerarSolicitudArticulo
		@Articulo         varchar (20),
		@Estatus		  varchar (10),
		@ReferenciaIntelisisService			varchar(50)	,
		@Datos			  varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE 
    @AccesoID							int,
    @Usuario						    varchar(10),
    @Ok									int,
    @OkRef								varchar(255),
    @Contrasena							varchar(32),
    @Resultado							varchar(max),
    @Id									int
  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.Art" SubReferencia="'+@Estatus+'" Version="1.0"><Solicitud> <Art  Articulo="'+@Articulo+'"/>  </Solicitud> </Intelisis>'
  
  IF @Estatus = 'BAJA'
       SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.Art.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0" ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' ><Solicitud><Art  Articulo="'+@Articulo+'"/> </Solicitud> </Intelisis>'
 
    
  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena 
	FROM Usuario
   WHERE Usuario = @Usuario
   --EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,0,0,@Id Output         
   IF @ID IS NOT NULL      
     INSERT ProcesarIntelisisService (ID, Solicitud) VALUES (@ID, 'Articulo')        

END
go

/**************** spInforGenerarSolicitudArtFam ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudArtFam') and type = 'P') drop procedure dbo.spInforGenerarSolicitudArtFam
GO
CREATE PROC spInforGenerarSolicitudArtFam
                               @Familia         varchar (50),
                               @Estatus                                 varchar (10),
                               @ReferenciaIntelisisService                                           varchar(50)          ,
                               @Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
   @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int
  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.ArtFam" SubReferencia="'+@Estatus+'" Version="1.0"><Solicitud> <ArtFam  Familia="'+@Familia+'"/>  </Solicitud> </Intelisis>'

  IF @Estatus = 'BAJA'
       SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.ArtFam.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0" ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' ><Solicitud><ArtFam  Familia="'+@Familia+'"/> </Solicitud> </Intelisis>'

  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output


END
go

/**************** spInforGenerarSolicitudArtContadorLotes ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudArtContadorLotes') and type = 'P') drop procedure dbo.spInforGenerarSolicitudArtContadorLotes
GO 
CREATE PROC spInforGenerarSolicitudArtContadorLotes
		@Articulo         varchar (20),
		@Estatus		  varchar (10),
		@ReferenciaIntelisisService			varchar(50)	,		
		@Datos			  varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE 
    @AccesoID							int,
    @Usuario						    varchar(10),
    @Ok									int,
    @OkRef								varchar(255),
    @Contrasena							varchar(32),
    @Resultado							varchar(max),
    @Id									int
  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.ArtContadorLotes" SubReferencia="'+@Estatus+'" Version="1.0"><Solicitud> <Art  Articulo="'+@Articulo+'"/>  </Solicitud> </Intelisis>'
  
  IF @Estatus = 'BAJA'
       SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.ArtContadorLotes.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0" ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' ><Solicitud><Art  Articulo="'+@Articulo+'"/> </Solicitud> </Intelisis>'
 
    
  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena 
	FROM Usuario
   WHERE Usuario = @Usuario
  -- EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output
     EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,0,0,@Id Output         
	 IF @ID IS NOT NULL      
       INSERT ProcesarIntelisisService (ID, Solicitud) VALUES (@ID, 'ArtContadorLotes')      
END
go




/**************** spInforGenerarSolicitudAlmacen ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudAlmacen') and type = 'P') drop procedure dbo.spInforGenerarSolicitudAlmacen
GO
CREATE PROC spInforGenerarSolicitudAlmacen
                               @Almacen          varchar (10),
                               @Estatus                                 varchar (10),
        @ReferenciaIntelisisService                                   varchar(50),
                               @Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int
  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.Alm" SubReferencia="'+@Estatus+'" Version="1.0">
    <Solicitud> <Alm  Almacen="'+@Almacen+'"/>  </Solicitud> </Intelisis>'

  IF @Estatus = 'BAJA'
      SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Baja.Alm" SubReferencia="'+@Estatus+'" Version="1.0">
                           <Solicitud><Alm  Almacen="'+@Almacen+'"/> </Solicitud> </Intelisis>'

  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output


END
go


/**************** spInforCuadrarExistenciaMES ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforCuadrarExistenciaMES')           AND type = 'P') drop procedure dbo.spInforCuadrarExistenciaMES
GO
CREATE PROC spInforCuadrarExistenciaMES
@Usuario		varchar(10),
				 @Empresa		varchar(5),
				 @Sucursal		int,
				 @eArticulo     varchar(20) = NULL,
				 @eSerieLote    varchar(20) = NULL,
				 @eAlmacen      varchar(10) = NULL
--//WITH ENCRYPTION
AS
BEGIN
DECLARE 
    @AccesoID							int,
    @Ok									int,
    @OkRef								varchar(255),
    @Contrasena							varchar(32),
    @Resultado							varchar(max),
    @Resultado2							varchar(max),
    @Id									int,
    @Version							float,
    @SubReferencia                      varchar(255) ,
    @Datos								varchar (max),
    @ReferenciaIntelisisService         varchar(50)
     
 DECLARE @Tabla table(
						  Articulo			varchar(20),
						  SubCuenta			varchar(50),
						  SerieLote			varchar(20),
						  Almacen			varchar(10),
						  EntradaSalida		varchar(1),
						  Existencia		float
                     )

 SELECT @ReferenciaIntelisisService = Referencia 
   FROM MapeoPlantaIntelisisMes 
  WHERE Empresa = @Empresa 
    AND Sucursal = @Sucursal 

  IF EXISTS ( SELECT * 
			    FROM IntelisisService 
			   WHERE Referencia  IN (
                                      'Intelisis.Cuenta.Alm.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.Alm',
                                      'Intelisis.Cuenta.CteTipo.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.CteTipo',
                                      'Intelisis.Cuenta.Mon.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.Mon', 
                                      'Intelisis.Interfaz.Infor.Transferencia.Prov',
                                      'Intelisis.Cuenta.Prov.Listado',
                                      --'Intelisis.Cuenta.Articulo.Listado', 
                                      'Intelisis.Cuenta.Usuario.Listado', 
                                      --'Intelisis.Interfaz.Infor.Transferencia.Art', 
                                      'Intelisis.Interfaz.Infor.Transferencia.ArtContadorLotes', 
                                      'Intelisis.Interfaz.Infor.Transferencia.Usuario',
                                      'Intelisis.Cuenta.ArtFam.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.ArtFam', 
                                      'Intelisis.Cuenta.Departamento.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.Departamento', 
                                      'Intelisis.Cuenta.Empresa.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.Empresa', 
                                      'Intelisis.COMS.Mov.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.COMS_F', 
                                      'Intelisis.Interfaz.Infor.Transferencia.COMS_O', 
                                      'Intelisis.Interfaz.Infor.Transferencia.COMS_OC', 
                                      --'Intelisis.VTAS.Mov.Listado', 
                                      --'Intelisis.Interfaz.Infor.Transferencia.VTAS_P', 
                                      'Intelisis.Interfaz.Infor.Transferencia.VTAS_PR', 
                                      'Intelisis.Cuenta.Cte.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.Cte',
                                      'Intelisis.Cuenta.Unidad.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.Unidad', 
                                      'Intelisis.Cuenta.Personal.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.Personal',
                                      'Intelisis.COMS.InsertarMov.COMS_O', 
                                      'Intelisis.Cuenta.Art.Insertar', 
                                      'Intelisis.INV.InsertarMov.INV_E', 
                                      'Intelisis.INV.InsertarMov.INV_S', 
                                      'Intelisis.Cuenta.Sucursal.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.Sucursal',  
                                      'Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas', 
                                      'Intelisis.Interfaz.Infor.Insertar.CancelacionMov', 
                                      'Intelisis.Cuenta.Planta.Usuario.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.PlantaUsuario', 
                                      'Intelisis.Cuenta.Planta.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.Planta',
                                      'Intelisis.Cuenta.ArtLinea.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.ArtLinea',  
                                      'Intelisis.PC.InsertarMov.PC_C', 
                                      'Intelisis.Cuenta.MotivoRechazo.Listado', 
                                      'Intelisis.Interfaz.Infor.Transferencia.MotivoRechazo', 
                                      'Intelisis.Interfaz.Infor.Transferencia.OpcionDetalle', 
                                      'Intelisis.Interfaz.Infor.Transferencia.Opcion', 
                                      'Intelisis.INV.InsertarMov.NOM_P',
                                      'Intelisis.Interfaz.Infor.CancelarMov',
									  'Intelisis.INV.InsertarMov.INV_EST',
                                      'Infor.Movimiento.Procesar.COMS_OC',
                                      'Infor.Movimiento.Procesar.COMS_O',
                                      --'Infor.Cuenta.Articulo.Mantenimiento',
                                      'Infor.Cuenta.ArtContadorLotes.Mantenimiento',
                                      'Infor.Cuenta.ArtLinea.Mantenimiento',
                                      --'Infor.Movimiento.Procesar.INV',
                                      'Infor.Reporte.ObjetivosVentas',
                                      'Infor.Cuenta.Cte.Mantenimiento',
                                      'Infor.Cuenta.Usuario.Mantenimiento',
                                      'Infor.Cuenta.Proveedor.Mantenimiento',
                                      'Infor.Cuenta.Planta.Usuario.Mantenimiento',
                                      'Infor.Movimiento.Procesar.VTAS_P',
                                      'Infor.Cuenta.Art.Mantenimiento',
                                      'Infor.Cuenta.Personal.Mantenimiento',
                                      'Infor.Cuenta.Moneda.Mantenimiento',
                                      'Infor.Cuenta.ArtFam.Mantenimiento',
                                      'Infor.Movimiento.Procesar.COMS_F',
                                      'Infor.Cuenta.MotivoRechazo.Mantenimiento',
                                      'Infor.Cuenta.Unidad.Mantenimiento',
                                      'Infor.Movimiento.Procesar.VTAS_PR',
                                      'Infor.Cuenta.Planta.Mantenimiento',
                                      'Infor.Movimiento.Procesar.COMS_OC',
                                      'Infor.Cuenta.Empresa.Mantenimiento',
                                      'Infor.Cuenta.CteTipo.Mantenimiento',
                                      'Infor.Cuenta.Almacen.Mantenimiento',
                                      'Infor.Cuenta.Opcion.Mantenimiento',
                                      'Infor.Cuenta.OpcionDetalle.Mantenimiento'
                                     )  
			     AND Estatus IN ('SINPROCESAR') 
			)
	SET @Ok = 2
	
  IF @Ok IS NULL
  BEGIN
    INSERT INTO @Tabla (Articulo,   SubCuenta,    SerieLote,                     Almacen,   Existencia,												  EntradaSalida)  
				 SELECT e.Articulo ,e.SubCuenta , ISNULL(e.SerieLote,'(none)') , e.Almacen, ISNULL(e.ExistenciaInte,0.0)-ISNULL(e.ExistenciaMES,0.0), CASE	WHEN ISNULL(e.ExistenciaInte,0.0) - ISNULL(e.ExistenciaMES,0.0) > 0.0  THEN 'E'  WHEN ISNULL(e.ExistenciaInte,0.0) - ISNULL(e.ExistenciaMES,0.0) < 0.0  THEN 'S'  END
				   FROM ArtExistenciaIntMES e 
				   JOIN Alm a ON e.Almacen = a.Almacen
				  WHERE ISNULL(a.EsFactory,0) = 1 
				    AND e.Articulo  = ISNULL(@eArticulo, e.Articulo) 
				    AND e.Almacen   = ISNULL(@eAlmacen, e.Almacen) 
				    AND e.SerieLote = ISNULL(@eSerieLote, e.SerieLote)
    
    UPDATE @Tabla 
       SET Existencia = Existencia * -1 
     WHERE EntradaSalida = 'S'
 
    SET @Resultado2 = ISNULL(CONVERT(varchar(max), (SELECT * FROM @Tabla InvExistencia FOR XML AUTO)),'')
    SET @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) + 'Intelisis.INV.Cuadrar.ExistenciaMES' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)+ ' ReferenciaIntelisisService=' + CHAR(34) + ISNULL(@ReferenciaIntelisisService,'') + CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>'  
    
    SELECT @Contrasena = Contrasena 
      FROM Usuario
     WHERE Usuario = @Usuario
     
    EXEC spIntelisisService  @Usuario, @Contrasena, @Datos, @Resultado, @Ok Output, @OkRef Output, 0, 0, @Id Output
    
    IF @OK IS NOT NULL
    BEGIN
	  SELECT @OkRef = Descripcion 
	    FROM MensajeLista 
	   WHERE Mensaje = @Ok
	
      SELECT CONVERT(varchar,@ok) + ' ' + @OkRef
    END
    ELSE 
		SELECT 'Proceso Concluido. <BR>Los ajustes en el inventario pueden tardar algunos minutos en verse reflejados,<BR>por favor espere antes de verificar los resultados.'
  END  
   
  IF @Ok = 2 
	SELECT 'Existen Tareas Por Procesar No Se Puede Cuadrar La Existencia'
END
GO


/**************** spCuentaInsertarArt ****************/
if exists (select * from sysobjects where id = object_id('dbo.spCuentaInsertarArt') and type = 'P') drop procedure dbo.spCuentaInsertarArt
GO            
CREATE PROCEDURE spCuentaInsertarArt
                               @ID                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                                      int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
          @Articulo                                                   varchar(20),
          @Rama                                       varchar(20),
          @Descripcion1                                         varchar(100),
          @Descripcion2                                         varchar(255),
          @NombreCorto                                        varchar(20),
          @Grupo                                      varchar(50),
          @Categoria                               varchar(50),
          @CategoriaActivoFijo             varchar(50),
          @Familia                                                   varchar(50),
          @Linea                                       varchar(50),
          @Fabricante                                             varchar(50),
          @ClaveFabricante                                  varchar(50),
          @Impuesto1                              float   ,
          @Impuesto2                              float   ,
          @Impuesto3                              float   ,
          @Factor                                                     varchar(50),
          @Unidad                                                   varchar(50),
          @UnidadCompra                                    varchar(50),
          @UnidadTraspaso                                  varchar(50),
          @UnidadCantidad                                 float   ,
          @TipoCosteo                                            varchar(10),
          @Peso                                         float   ,
          @Tara                                         float   ,
          @Volumen                                 float   ,
          @Tipo                                         varchar(20),
          @TipoOpcion                                           varchar(20),
          @Accesorios                                              bit   ,
          @Refacciones                                           bit   ,
          @Sustitutos                                               bit   ,
          @Servicios                                 bit   ,
          @Consumibles                                         bit   ,
          @MonedaCosto                                       varchar(10),
          @MonedaPrecio                                      varchar(10),
          @MargenMinimo                                    money   ,
          @PrecioLista                                             money   ,
          @PrecioMinimo                                       money   ,
          @FactorAlterno                                        float   ,
          @PrecioAnterior                       money   ,
          @Utilidad                                   varchar(50),
          @DescuentoCompra                              float   ,
          @Clase                                        varchar(15),
          @Estatus                                                    varchar(15),
          @UltimoCambio                                      datetime   ,
          @Alta                                          datetime   ,
          @Conciliar                                 bit   ,
          @Mensaje                                  varchar(50),
          @Comision                                varchar(50),
          @Arancel                                                   varchar(50),
          @ArancelDesperdicio             varchar(50),
          @ABC                                          varchar(1),
          @Usuario                                                   varchar(10),
          @Precio2                                                   money   ,
          @Precio3                                                   money   ,
          @Precio4                                                   money   ,
          @Precio5                                                   money   ,
          @Precio6                                                   money   ,
          @Precio7                                                   money   ,
          @Precio8                                                   money   ,
          @Precio9                                                   money   ,
          @Precio10                                  money   ,
          @Refrigeracion                                        bit   ,
          @TieneCaducidad                                  bit   ,
          @BasculaPesar                                         bit   ,
          @SeProduce                              bit   ,
          @Situacion                                varchar(50),
          @SituacionFecha                    datetime   ,
          @SituacionUsuario                                  varchar(10),
          @SituacionNota                                       varchar(100),
          @EstatusPrecio                                         varchar(15),
          @wMostrar                                bit   ,
          @Merma                                    float   ,
          @Desperdicio                                           float   ,
          @SeCompra                              bit   ,
          @SeVende                                bit   ,
          @EsFormula                              bit   ,
          @TiempoEntrega                                    int   ,
          @TiempoEntregaUnidad      varchar(10),
          @TiempoEntregaSeg                            int   ,
          @TiempoEntregaSegUnidad   varchar(10),
          @LoteOrdenar                                         varchar(30),
          @CantidadOrdenar                                float   ,
          @MultiplosOrdenar                                float   ,
          @InvSeguridad                                       float   ,
          @ProdRuta                                 varchar(20),
          @AlmacenROP                                         varchar(10),
          @CategoriaProd                                      varchar(50),
          @ProdCantidad                                       float   ,
          @ProdUsuario                                          varchar(10),
          @ProdPasoTotal                                      int   ,
          @ProdMovGrupo                                    varchar(50),
          @ProdEstacion                                         varchar(10),
          @ProdOpciones                                       bit   ,
          @ProdVerConcentracion       bit   ,
          @ProdVerCostoAcumulado                  bit   ,
          @ProdVerMerma                                     bit   ,
          @ProdVerDesperdicio            bit   ,
          @ProdVerPorcentaje                              bit   ,
          @RevisionUltima                     datetime   ,
          @RevisionUsuario                    varchar(10),
          @RevisionFrecuencia             int   ,
          @RevisionFrecuenciaUnidad  varchar(10),
          @RevisionSiguiente                               datetime   ,
          @ProdMov                                 varchar(20),
          @TipoCompra                                          varchar(20),
          @TieneMovimientos                              bit   ,
          @Registro1                                varchar(20),
          @Registro1Vencimiento        datetime   ,
          @AlmacenEspecificoVenta   varchar(10),
          @AlmacenEspecificoVentaMov varchar(20),
          @RutaDistribucion                                  varchar(50),
          @CostoEstandar                                      float   ,
          @CostoReposicion                                  float   ,
          @EstatusCosto                                          varchar(15),
          @Margen                                   money  ,
          @Proveedor                              varchar(10),
          @NivelAcceso                                          varchar(50),
          @Temporada                            varchar(50),
          @SolicitarPrecios                      bit   ,
          @AutoRecaudacion                                varchar(30),
          @Concepto                               varchar(50),
          @Cuenta                                                   varchar(20),
          @Retencion1                                            float   ,
          @Retencion2                                            float   ,
          @Retencion3                                            float   ,
          @Espacios                                  bit   ,
          @EspaciosEspecificos             bit   ,
          @EspaciosSobreventa           float   ,
          @EspaciosNivel                                       varchar(50),
          @EspaciosMinutos                                  int   ,
          @EspaciosBloquearAnteriores  bit   ,
          @EspaciosHoraD                                     varchar(5),
          @EspaciosHoraA                                     varchar(5),
          @SerieLoteInfo                                        bit   ,
          @CantidadMinimaVenta      float   ,
          @CantidadMaximaVenta     float   ,
          @EstimuloFiscal                       float   ,
          @OrigenPais                                             varchar(50),
          @OrigenLocalidad                                  varchar(50),
          @Incentivo                                money   ,
          @FactorCompra                                      float   ,
          @Horas                                       float   ,
          @ISAN                                         bit   ,
          @ExcluirDescFormaPago       bit   ,
          @EsDeducible                                          bit   ,
          @Peaje                                       money   ,
          @CodigoAlterno                                      varchar(50),
          @TipoCatalogo                                        varchar(20),
          @AnexosAlFacturar                                bit   ,
          @CaducidadMinima                              int   ,
          @Actividades                                           bit   ,
          @ValidarPresupuestoCompra  varchar(20),
          @SeriesLotesAutoOrden        varchar(20),
          @LotesFijos                                               bit   ,
          @LotesAuto                               bit   ,
          @Consecutivo                                          int   ,
          @TipoEmpaque                                      varchar(50),
          @Modelo                                                   varchar(4),
          @TieneDireccion                     bit   ,
          @Direccion                                varchar(100),
          @DireccionNumero                                varchar(20),
          @DireccionNumeroInt                           varchar(10),
          @EntreCalles                                            varchar(100),
          @Plano                                       varchar(15),
          @Observaciones                                     varchar(100),
          @Colonia                                                   varchar(100),
          @Delegacion                                           varchar(100),
          @Poblacion                               varchar(100),
          @Estado                                                    varchar(30),
          @Pais                                          varchar(30),
          @CodigoPostal                                        varchar(15),
          @Ruta                                         varchar(50),
          @Codigo                                                   varchar(50),
          @ClaveVehicular                     varchar(20),
          @TipoVehiculo                                        varchar(20),
          @DiasLibresintereses                             int   ,
          @PrecioLiberado                     bit   ,
          @ValidarCodigo                                      bit   ,
          @Presentacion                                         varchar(50),
          @GarantiaPlazo                                       int   ,
          @CostoIdentificado                                bit   ,
          @CantidadTarima                                  float   ,
          @UnidadTarima                                      varchar(50),
          @MinimoTarima                                      float   ,
          @DepartamentoDetallista   int   ,
          @TratadoComercial                                varchar(50),
          @CuentaPresupuesto                             varchar(20),
          @ProgramaSectorial                               varchar(50),
          @PedimentoClave                                  varchar(5),
          @PedimentoRegimen                           varchar(5),
          @Permiso                                                      varchar(20),
          @PermisoRenglon                                  varchar(20),
          @Cuenta2                                                     varchar(20),
          @Cuenta3                                                     varchar(20),
          @Impuesto1Excento                              bit   ,
          @CalcularPresupuesto            bit   ,
          @InflacionPresupuesto          float   ,
          @Excento2                                                    bit   ,
          @Excento3                                                    bit,
          @ContUso                                                     varchar(20),
          @ContUso2                                                   varchar(20),
          @ContUso3                                                   varchar(20),
          @NivelToleranciaCosto          varchar(10),
          @ToleranciaCosto                   money   ,
          @ToleranciaCostoInferior  money   ,
          @ObjetoGasto                                          varchar(10),
          @ObjetoGastoRef                    varchar(10),
          @ClavePresupuestalImpuesto1  varchar(50),
          @Estructura                                               varchar(50),
          @TipoImpuesto1                                     varchar(10),
          @TipoImpuesto2                                     varchar(10),
          @TipoImpuesto3                                     varchar(10),
          @TipoRetencion1                    varchar(10),
          @TipoRetencion2                    varchar(10),
          @TipoRetencion3                    varchar(10),
          @TipoImpuesto4                                     varchar(10),
          @Calificacion                            smallint   ,
          @TipoImpuesto5                                     varchar(10),
          @INFORStockMinimo                             float   ,
          @INFORStockMaximo                            float   ,
          @InforPrefijo                                             varchar(20),
          @InforSufijo                                              varchar(20),
          @CodigoEstructura                                 varchar(20),
          @TipoVariante                                         varchar(5),
          @InforTipo                                                    varchar(50),
                                 @IDGenerar                                                      int,
                                 @MovTipo                                         varchar(20),
                                 @ReferenciaIS                                                  varchar(100) ,
                                 @SubReferencia                                              varchar(100)

   DECLARE @Temp   table(
          Articulo                                                      varchar(20),
          Rama                                          varchar(20),
          Descripcion1                                            varchar(100),
          Descripcion2                                            varchar(255),
          NombreCorto                                           varchar(20),
          Grupo                                         varchar(50),
          Categoria                                   varchar(50),
          CategoriaActivoFijo                varchar(50),
          Familia                        varchar(50),
          Linea                                           varchar(50),
          Fabricante                                 varchar(50),
          ClaveFabricante                      varchar(50),
          Impuesto1                                 float   ,
          Impuesto2                                 float   ,
          Impuesto3                                 float   ,
          Factor                                         varchar(50),
          Unidad                                       varchar(50),
          UnidadCompra                                       varchar(50),
          UnidadTraspaso                                     varchar(50),
          UnidadCantidad                                    float   ,
          TipoCosteo                                varchar(10),
          Peso                                            float   ,
          Tara                                             float   ,
          Volumen                                                   float   ,
          Tipo                                             varchar(20),
          TipoOpcion                               varchar(20),
          Accesorios                                  bit   ,
          Refacciones                                              bit   ,
          Sustitutos                                                   bit   ,
          Servicios                                                    bit   ,
          Consumibles                                            bit   ,
          MonedaCosto                                          varchar(10),
          MonedaPrecio                                         varchar(10),
          MargenMinimo                                       money   ,
          PrecioLista                                                 money   ,
          PrecioMinimo                                           money   ,
          FactorAlterno                                           float   ,
          PrecioAnterior                                          money   ,
          Utilidad                                                     varchar(50),
          DescuentoCompra                                 float   ,
          Clase                                           varchar(15),
          Estatus                        varchar(15),
          UltimoCambio                                         datetime   ,
          Alta                                              datetime   ,
          Conciliar                                                    bit   ,
          Mensaje                                                    varchar(50),
          Comision                                                   varchar(50),
          Arancel                                                      varchar(50),
          ArancelDesperdicio                                varchar(50),
          ABC                                             varchar(1),
          Usuario                                                      varchar(10),
          Precio2                        money   ,
          Precio3                        money   ,
          Precio4                        money   ,
          Precio5                        money   ,
          Precio6                        money   ,
          Precio7                        money   ,
          Precio8                        money   ,
          Precio9                        money   ,
          Precio10                                                    money   ,
          Refrigeracion                                           bit   ,
          TieneCaducidad                                     bit   ,
          BasculaPesar                                            bit   ,
          SeProduce                                 bit   ,
          Situacion                                                   varchar(50),
          SituacionFecha                                       datetime   ,
          SituacionUsuario                     varchar(10),
          SituacionNota                                          varchar(100),
          EstatusPrecio                                            varchar(15),
          wMostrar                                                   bit   ,
          Merma                                        float   ,
          Desperdicio                                              float   ,
          SeCompra                                  bit   ,
          SeVende                                                   bit   ,
          EsFormula                                  bit   ,
          TiempoEntrega                                       int   ,
          TiempoEntregaUnidad         varchar(10),
          TiempoEntregaSeg                                int   ,
          TiempoEntregaSegUnidad                 varchar(10),
          LoteOrdenar                                             varchar(30),
          CantidadOrdenar                   float   ,
          MultiplosOrdenar                    float   ,
          InvSeguridad                                           float   ,
          ProdRuta                                                   varchar(20),
          AlmacenROP                             varchar(10),
          CategoriaProd                                         varchar(50),
          ProdCantidad                                          float   ,
          ProdUsuario                                              varchar(10),
          ProdPasoTotal                                          int   ,
          ProdMovGrupo                                        varchar(50),
          ProdEstacion                                            varchar(10),
          ProdOpciones                                          bit   ,
          ProdVerConcentracion          bit   ,
          ProdVerCostoAcumulado      bit   ,
          ProdVerMerma                                        bit   ,
          ProdVerDesperdicio                               bit   ,
          ProdVerPorcentaje                                 bit   ,
          RevisionUltima                                        datetime   ,
          RevisionUsuario                       varchar(10),
          RevisionFrecuencia                                int   ,
          RevisionFrecuenciaUnidad  varchar(10),
          RevisionSiguiente                                   datetime   ,
          ProdMov                                                   varchar(20),
          TipoCompra                              varchar(20),
         TieneMovimientos                                 bit   ,
          Registro1                                                   varchar(20),
          Registro1Vencimiento           datetime   ,
          AlmacenEspecificoVenta      varchar(10),
          AlmacenEspecificoVentaMov varchar(20),
          RutaDistribucion                      varchar(50),
          CostoEstandar                                         float   ,
          CostoReposicion                      float   ,
          EstatusCosto                                             varchar(15),
          Margen                                      money  ,
          Proveedor                                  varchar(10),
          NivelAcceso                                              varchar(50),
          Temporada                               varchar(50),
          SolicitarPrecios                         bit   ,
          AutoRecaudacion                    varchar(30),
          Concepto                                   varchar(50),
          Cuenta                                       varchar(20),
          Retencion1                                float   ,
          Retencion2                                float   ,
          Retencion3                                float   ,
          Espacios                                                    bit   ,
          EspaciosEspecificos                bit   ,
          EspaciosSobreventa                              float   ,
          EspaciosNivel                                           varchar(50),
          EspaciosMinutos                      int   ,
          EspaciosBloquearAnteriores  bit   ,
          EspaciosHoraD                                        varchar(5),
          EspaciosHoraA                                         varchar(5),
          SerieLoteInfo                                            bit   ,
          CantidadMinimaVenta         float   ,
          CantidadMaximaVenta         float   ,
          EstimuloFiscal                                          float   ,
          OrigenPais                                 varchar(50),
          OrigenLocalidad                     varchar(50),
          Incentivo                                                   money   ,
          FactorCompra                                          float   ,
          Horas                                          float   ,
          ISAN                                            bit   ,
         ExcluirDescFormaPago          bit   ,
          EsDeducible                                             bit   ,
          Peaje                                           money   ,
          CodigoAlterno                                         varchar(50),
          TipoCatalogo                                           varchar(20),
          AnexosAlFacturar                    bit   ,
          CaducidadMinima                                 int   ,
          Actividades                                              bit   ,
          ValidarPresupuestoCompra  varchar(20),
          SeriesLotesAutoOrden           varchar(20),
          LotesFijos                                   bit   ,
          LotesAuto                                   bit   ,
          Consecutivo                                             int   ,
          TipoEmpaque                                          varchar(50),
          Modelo                                       varchar(4),
          TieneDireccion                                        bit   ,
          Direccion                                                   varchar(100),
          DireccionNumero                    varchar(20),
          DireccionNumeroInt                               varchar(20),
          EntreCalles                                               varchar(100),
          Plano                                          varchar(15),
          Observaciones                                         varchar(100),
          Colonia                                                      varchar(100),
          Delegacion                               varchar(100),
          Poblacion                                  varchar(100),
          Estado                                        varchar(30),
          Pais                                              varchar(30),
          CodigoPostal                                            varchar(15),
          Ruta                                             varchar(50),
          Codigo                                       varchar(50),
          ClaveVehicular                                        varchar(20),
          TipoVehiculo                                            varchar(20),
          DiasLibresintereses                 int   ,
          PrecioLiberado                                        bit   ,
          ValidarCodigo                                         bit   ,
          Presentacion                                            varchar(50),
          GarantiaPlazo                                          int   ,
          CostoIdentificado                    bit   ,
          CantidadTarima                                      float   ,
         UnidadTarima                                         varchar(50),
          MinimoTarima                                         float   ,
          DepartamentoDetallista        int   ,
          TratadoComercial                   varchar(50),
          CuentaPresupuesto                                varchar(20),
          ProgramaSectorial                                  varchar(50),
          PedimentoClave                                     varchar(5),
          PedimentoRegimen                               varchar(5),
          Permiso                                          varchar(20),
          PermisoRenglon                                      varchar(20),
          Cuenta2                                         varchar(20),
          Cuenta3                                         varchar(20),
          Impuesto1Excento                                  bit   ,
          CalcularPresupuesto               bit   ,
          InflacionPresupuesto              float   ,
          Excento2                                       bit   ,
          Excento3                                       bit,
          ContUso                                         varchar(20),
          ContUso2                                                      varchar(20),
          ContUso3                                                      varchar(20),
          NivelToleranciaCosto             varchar(10),
          ToleranciaCosto                       money   ,
          ToleranciaCostoInferior   money   ,
          ObjetoGasto                                             varchar(10),
          ObjetoGastoRef                                       varchar(10),
          ClavePresupuestalImpuesto1  varchar(50),
          Estructura                                   varchar(50),
          TipoImpuesto1                                        varchar(10),
          TipoImpuesto2                                        varchar(10),
          TipoImpuesto3                                        varchar(10),
          TipoRetencion1                                       varchar(10),
          TipoRetencion2                                       varchar(10),
          TipoRetencion3                                       varchar(10),
          TipoImpuesto4                                        varchar(10),
          Calificacion                               smallint   ,
          TipoImpuesto5                                        varchar(10),
          INFORStockMinimo                                float   ,
          INFORStockMaximo                                float   ,
          INFORPrefijo                                             varchar(20),
          INFORSufijo                                              varchar(20),
          INFORTipo                                                    varchar(50),
          CodigoEstructura                                    varchar(20),
          TipoVariante                                            varchar(5)
                                )

  BEGIN TRANSACTION
    INSERT @Temp ( Articulo,  Rama,  Descripcion1,  Descripcion2,  NombreCorto,  Grupo,  Categoria,  CategoriaActivoFijo,  Familia,  Linea,  Fabricante,  ClaveFabricante,  Impuesto1,  Impuesto2,  Impuesto3,  Factor,  Unidad,  UnidadCompra,  UnidadTraspaso,  UnidadCantidad,  TipoCosteo,  Peso,  Tara,  Volumen,  Tipo,  TipoOpcion,  Accesorios,  Refacciones,  Sustitutos,  Servicios,  Consumibles,  MonedaCosto,  MonedaPrecio,  MargenMinimo,  PrecioLista,  PrecioMinimo,  FactorAlterno,  PrecioAnterior,  Utilidad,  DescuentoCompra,  Clase,  Estatus,  UltimoCambio,  Alta,  Conciliar,  Mensaje,  Comision,  Arancel,  ArancelDesperdicio,  ABC,  Usuario,  Precio2,  Precio3,  Precio4,  Precio5,  Precio6,  Precio7,  Precio8,  Precio9,  Precio10,  Refrigeracion,  TieneCaducidad,  BasculaPesar,  SeProduce,  Situacion,  SituacionFecha,  SituacionUsuario,  SituacionNota,  EstatusPrecio,  wMostrar,  Merma,  Desperdicio,  SeCompra,  SeVende,  EsFormula,  TiempoEntrega,  TiempoEntregaUnidad,  TiempoEntregaSeg,  TiempoEntregaSegUnidad,  LoteOrdenar,  CantidadOrdenar,  MultiplosOrdenar,  InvSeguridad,  ProdRuta,  AlmacenROP,  CategoriaProd,  ProdCantidad,  ProdUsuario,  ProdPasoTotal,  ProdMovGrupo,  ProdEstacion,  ProdOpciones,  ProdVerConcentracion,  ProdVerCostoAcumulado,  ProdVerMerma,  ProdVerDesperdicio,  ProdVerPorcentaje,  RevisionUltima,  RevisionUsuario,  RevisionFrecuencia,  RevisionFrecuenciaUnidad,  RevisionSiguiente,  ProdMov,  TipoCompra,  TieneMovimientos,  Registro1,  Registro1Vencimiento,  AlmacenEspecificoVenta,  AlmacenEspecificoVentaMov,  RutaDistribucion,  CostoEstandar,  CostoReposicion,  EstatusCosto,  Margen,  Proveedor,  NivelAcceso,  Temporada,  SolicitarPrecios,  AutoRecaudacion,  Concepto,  Cuenta,  Retencion1,  Retencion2,  Retencion3,  Espacios,  EspaciosEspecificos,  EspaciosSobreventa,  EspaciosNivel,  EspaciosMinutos,  EspaciosBloquearAnteriores,  EspaciosHoraD,  EspaciosHoraA,  SerieLoteInfo,  CantidadMinimaVenta,  CantidadMaximaVenta,  EstimuloFiscal,  OrigenPais,  OrigenLocalidad,  Incentivo,  FactorCompra,  Horas,  ISAN,  ExcluirDescFormaPago,  EsDeducible,  Peaje,  CodigoAlterno,  TipoCatalogo,  AnexosAlFacturar,  CaducidadMinima,  Actividades,  ValidarPresupuestoCompra,  SeriesLotesAutoOrden,  LotesFijos,  LotesAuto,  Consecutivo,  TipoEmpaque,  Modelo,TieneDireccion,  Direccion,  DireccionNumero,  DireccionNumeroInt,  EntreCalles,  Plano,  Observaciones,  Colonia,  Delegacion,  Poblacion,  Estado,  Pais,  CodigoPostal,  Ruta,  Codigo,  ClaveVehicular,  TipoVehiculo,  DiasLibresIntereses,  PrecioLiberado,  ValidarCodigo,  Presentacion,  GarantiaPlazo,  CostoIdentificado,  CantidadTarima,  UnidadTarima,  MinimoTarima,  DepartamentoDetallista,  TratadoComercial,  CuentaPresupuesto,  ProgramaSectorial,  PedimentoClave,  PedimentoRegimen,  Permiso,  PermisoRenglon,  Cuenta2,  Cuenta3,  Impuesto1Excento,  CalcularPresupuesto,  InflacionPresupuesto,  Excento2,  Excento3,  ContUso,  ContUso2,  ContUso3,  NivelToleranciaCosto,  ToleranciaCosto,  ToleranciaCostoInferior,  ObjetoGasto,  ObjetoGastoRef,  ClavePresupuestalImpuesto1,  Estructura,  TipoImpuesto1,  TipoImpuesto2,  TipoImpuesto3,  TipoRetencion1,  TipoRetencion2,  TipoRetencion3,  TipoImpuesto4,  Calificacion,  TipoImpuesto5,  INFORStockMinimo,  INFORStockMaximo,  INFORPrefijo,  INFORSufijo, INFORTipo, CodigoEstructura     ,TipoVariante )
    SELECT         Articulo,  Rama,  Descripcion1,  Descripcion2,  NombreCorto,  Grupo,  Categoria,  CategoriaActivoFijo,  Familia,  Linea,  Fabricante,  ClaveFabricante,  Impuesto1,  Impuesto2,  Impuesto3,  Factor,  Unidad,  UnidadCompra,  UnidadTraspaso,  UnidadCantidad,  TipoCosteo,  Peso,  Tara,  Volumen,  Tipo,  TipoOpcion,  Accesorios,  Refacciones,  Sustitutos,  Servicios,  Consumibles,  MonedaCosto,  MonedaPrecio,  MargenMinimo,  PrecioLista,  PrecioMinimo,  FactorAlterno,  PrecioAnterior,  Utilidad,  DescuentoCompra,  Clase,  Estatus,  UltimoCambio,  Alta,  Conciliar,  Mensaje,  Comision,  Arancel,  ArancelDesperdicio,  ABC,  Usuario,  Precio2,  Precio3,  Precio4,  Precio5,  Precio6,  Precio7,  Precio8,  Precio9,  Precio10,  Refrigeracion,  TieneCaducidad,  BasculaPesar,  SeProduce,  Situacion,  SituacionFecha,  SituacionUsuario,  SituacionNota,  EstatusPrecio,  wMostrar,  Merma,  Desperdicio,  SeCompra,  SeVende,  EsFormula,  TiempoEntrega,  TiempoEntregaUnidad,  TiempoEntregaSeg,  TiempoEntregaSegUnidad,  LoteOrdenar,  CantidadOrdenar,  MultiplosOrdenar,  InvSeguridad,  ProdRuta,  AlmacenROP,  CategoriaProd,  ProdCantidad,  ProdUsuario,  ProdPasoTotal,  ProdMovGrupo,  ProdEstacion,  ProdOpciones,  ProdVerConcentracion,  ProdVerCostoAcumulado,  ProdVerMerma,  ProdVerDesperdicio,  ProdVerPorcentaje,  RevisionUltima,  RevisionUsuario,  RevisionFrecuencia,  RevisionFrecuenciaUnidad,  RevisionSiguiente,  ProdMov,  TipoCompra,  TieneMovimientos,  Registro1,  Registro1Vencimiento,  AlmacenEspecificoVenta,  AlmacenEspecificoVentaMov,  RutaDistribucion,  CostoEstandar,  CostoReposicion,  EstatusCosto,  Margen,  Proveedor,  NivelAcceso,  Temporada,  SolicitarPrecios,  AutoRecaudacion,  Concepto,  Cuenta,  Retencion1,  Retencion2,  Retencion3,  Espacios,  EspaciosEspecificos,  EspaciosSobreventa,  EspaciosNivel,  EspaciosMinutos,  EspaciosBloquearAnteriores,  EspaciosHoraD,  EspaciosHoraA,  SerieLoteInfo,  CantidadMinimaVenta,  CantidadMaximaVenta,  EstimuloFiscal,  OrigenPais,  OrigenLocalidad,  Incentivo,  FactorCompra,  Horas,  ISAN,  ExcluirDescFormaPago,  EsDeducible,  Peaje,  CodigoAlterno,  TipoCatalogo,  AnexosAlFacturar,  CaducidadMinima,  Actividades,  ValidarPresupuestoCompra,  SeriesLotesAutoOrden,  LotesFijos,  LotesAuto,  Consecutivo,  TipoEmpaque,  Modelo,TieneDireccion,  Direccion,  DireccionNumero,  DireccionNumeroInt,  EntreCalles,  Plano,  Observaciones,  Colonia,  Delegacion,  Poblacion,  Estado,  Pais,  CodigoPostal,  Ruta,  Codigo,  ClaveVehicular,  TipoVehiculo,  DiasLibresIntereses,  PrecioLiberado,  ValidarCodigo,  Presentacion,  GarantiaPlazo,  CostoIdentificado,  CantidadTarima,  UnidadTarima,  MinimoTarima,  DepartamentoDetallista,  TratadoComercial,  CuentaPresupuesto,  ProgramaSectorial,  PedimentoClave,  PedimentoRegimen,  Permiso,  PermisoRenglon,  Cuenta2,  Cuenta3,  Impuesto1Excento,  CalcularPresupuesto,  InflacionPresupuesto,  Excento2,  Excento3,  ContUso,  ContUso2,  ContUso3,  NivelToleranciaCosto,  ToleranciaCosto,  ToleranciaCostoInferior,  ObjetoGasto,  ObjetoGastoRef,  ClavePresupuestalImpuesto1,  Estructura,  TipoImpuesto1,  TipoImpuesto2,  TipoImpuesto3,  TipoRetencion1,  TipoRetencion2,  TipoRetencion3,  TipoImpuesto4,  Calificacion,  TipoImpuesto5,  INFORStockMinimo,  INFORStockMaximo,  INFORPrefijo, INFORSufijo,  CASE INFORTipo  WHEN  1 THEN 'PRODUCTO ACABADO' WHEN 2 THEN 'SEMIELABORADO' WHEN 3 THEN 'TRABAJO EXTERIOR'  WHEN 4 THEN 'MATERIA PRIMA' END, CodigoEstructura                ,TipoVariante
    FROM OPENXML (@iSolicitud, '/Intelisis/Solicitud/Art',1) 
    WITH (Articulo varchar(100),  Rama varchar(100),  Descripcion1 varchar(100),  Descripcion2 varchar(100),  NombreCorto varchar(100),  Grupo varchar(100),  Categoria varchar(100),  CategoriaActivoFijo varchar(100),  Familia varchar(100),  Linea varchar(100),  Fabricante varchar(100),  ClaveFabricante varchar(100),  Impuesto1 varchar(100),  Impuesto2 varchar(100),  Impuesto3 varchar(100),  Factor varchar(100),  Unidad varchar(100),  UnidadCompra varchar(100),  UnidadTraspaso varchar(100),  UnidadCantidad varchar(100),  TipoCosteo varchar(100),  Peso varchar(100),  Tara varchar(100),  Volumen varchar(100),  Tipo varchar(100),  TipoOpcion varchar(100),  Accesorios varchar(100),  Refacciones varchar(100),  Sustitutos varchar(100),  Servicios varchar(100),  Consumibles varchar(100),  MonedaCosto varchar(100),  MonedaPrecio varchar(100),  MargenMinimo varchar(100),  PrecioLista varchar(100),  PrecioMinimo varchar(100),  FactorAlterno varchar(100),  PrecioAnterior varchar(100),  Utilidad varchar(100),  DescuentoCompra varchar(100),  Clase varchar(100),  Estatus varchar(100),  UltimoCambio varchar(100),  Alta varchar(100),  Conciliar varchar(100),  Mensaje varchar(100),  Comision varchar(100),  Arancel varchar(100),  ArancelDesperdicio varchar(100),  ABC varchar(100),  Usuario varchar(100),  Precio2 varchar(100),  Precio3 varchar(100),  Precio4 varchar(100),  Precio5 varchar(100),  Precio6 varchar(100),  Precio7 varchar(100),  Precio8 varchar(100),  Precio9 varchar(100),  Precio10 varchar(100),  Refrigeracion varchar(100),  TieneCaducidad varchar(100),  BasculaPesar varchar(100),  SeProduce varchar(100),  Situacion varchar(100),  SituacionFecha varchar(100),  SituacionUsuario varchar(100),  SituacionNota varchar(100),  EstatusPrecio varchar(100),  wMostrar varchar(100),  Merma varchar(100),  Desperdicio varchar(100),  SeCompra varchar(100),  SeVende varchar(100),  EsFormula varchar(100),  TiempoEntrega varchar(100),  TiempoEntregaUnidad varchar(100),  TiempoEntregaSeg varchar(100),  TiempoEntregaSegUnidad varchar(100),  LoteOrdenar varchar(100),  CantidadOrdenar varchar(100),  MultiplosOrdenar varchar(100),  InvSeguridad varchar(100),  ProdRuta varchar(100),  AlmacenROP varchar(100),  CategoriaProd varchar(100),  ProdCantidad varchar(100),  ProdUsuario varchar(100),  ProdPasoTotal varchar(100),  ProdMovGrupo varchar(100),  ProdEstacion varchar(100),  ProdOpciones varchar(100),  ProdVerConcentracion varchar(100),  ProdVerCostoAcumulado varchar(100),  ProdVerMerma varchar(100),  ProdVerDesperdicio varchar(100),  ProdVerPorcentaje varchar(100),  RevisionUltima varchar(100),  RevisionUsuario varchar(100),  RevisionFrecuencia varchar(100),  RevisionFrecuenciaUnidad varchar(100),  RevisionSiguiente varchar(100),  ProdMov varchar(100),  TipoCompra varchar(100),  TieneMovimientos varchar(100),  Registro1 varchar(100),  Registro1Vencimiento varchar(100),  AlmacenEspecificoVenta varchar(100),  AlmacenEspecificoVentaMov varchar(100),  RutaDistribucion varchar(100),  CostoEstandar varchar(100),  CostoReposicion varchar(100),  EstatusCosto varchar(100),  Margen varchar(100),  Proveedor varchar(100),  NivelAcceso varchar(100),  Temporada varchar(100),  SolicitarPrecios varchar(100),  AutoRecaudacion varchar(100),  Concepto varchar(100),  Cuenta varchar(100),  Retencion1 varchar(100),  Retencion2 varchar(100),  Retencion3 varchar(100),  Espacios varchar(100),  EspaciosEspecificos varchar(100),  EspaciosSobreventa varchar(100),  EspaciosNivel varchar(100),  EspaciosMinutos varchar(100),  EspaciosBloquearAnteriores varchar(100),  EspaciosHoraD varchar(100),  EspaciosHoraA varchar(100),  SerieLoteInfo varchar(100),  CantidadMinimaVenta varchar(100),  CantidadMaximaVenta varchar(100),  EstimuloFiscal varchar(100),  OrigenPais varchar(100),  OrigenLocalidad varchar(100),  Incentivo varchar(100),  FactorCompra varchar(100),  Horas varchar(100),  ISAN varchar(100),  ExcluirDescFormaPago varchar(100),  EsDeducible varchar(100),  Peaje varchar(100),  CodigoAlterno varchar(100),  TipoCatalogo varchar(100),  AnexosAlFacturar varchar(100),  CaducidadMinima varchar(100),  Actividades varchar(100),  ValidarPresupuestoCompra varchar(100),  SeriesLotesAutoOrden varchar(100),  LotesFijos varchar(100),  LotesAuto varchar(100),  Consecutivo varchar(100),  TipoEmpaque varchar(100),  Modelo varchar(100),  TieneDireccion varchar(100),  Direccion varchar(100),  DireccionNumero varchar(100),  DireccionNumeroInt varchar(100),  EntreCalles varchar(100),  Plano varchar(100),  Observaciones varchar(100),  Colonia varchar(100),  Delegacion varchar(100),  Poblacion varchar(100),  Estado varchar(100),  Pais varchar(100),  CodigoPostal varchar(100),  Ruta varchar(100),  Codigo varchar(100),  ClaveVehicular varchar(100),  TipoVehiculo varchar(100),  DiasLibresIntereses varchar(100),  PrecioLiberado varchar(100),  ValidarCodigo varchar(100),  Presentacion varchar(100),  GarantiaPlazo varchar(100),  CostoIdentificado varchar(100),  CantidadTarima varchar(100),  UnidadTarima varchar(100),  MinimoTarima varchar(100),  DepartamentoDetallista varchar(100),  TratadoComercial varchar(100),  CuentaPresupuesto varchar(100),  ProgramaSectorial varchar(100),  PedimentoClave varchar(100),  PedimentoRegimen varchar(100),  Permiso varchar(100),  PermisoRenglon varchar(100),  Cuenta2 varchar(100),  Cuenta3 varchar(100),  Impuesto1Excento varchar(100),  CalcularPresupuesto varchar(100),  InflacionPresupuesto varchar(100),  Excento2 varchar(100),  Excento3 varchar(100),  ContUso varchar(100),  ContUso2 varchar(100),  ContUso3 varchar(100),  NivelToleranciaCosto varchar(100),  ToleranciaCosto varchar(100),  ToleranciaCostoInferior varchar(100),  ObjetoGasto varchar(100),  ObjetoGastoRef varchar(100),  ClavePresupuestalImpuesto1 varchar(100),  Estructura varchar(100),  TipoImpuesto1 varchar(100),  TipoImpuesto2 varchar(100),  TipoImpuesto3 varchar(100),  TipoRetencion1 varchar(100),  TipoRetencion2 varchar(100),  TipoRetencion3 varchar(100),  TipoImpuesto4 varchar(100),  Calificacion varchar(100),  TipoImpuesto5 varchar(100),  INFORStockMinimo varchar(100),  INFORStockMaximo varchar(100),  InforPrefijo varchar(100),  InforSufijo varchar(100),  InforTipo varchar(100) ,CodigoEstructura varchar(100), TipoVariante varchar(100))

    DECLARE crDetalle CURSOR LOCAL FAST_FORWARD FOR
    SELECT Articulo,  Rama,  Descripcion1,  Descripcion2,  NombreCorto,  Grupo,  Categoria,  CategoriaActivoFijo,  Familia,  Linea,  Fabricante,  ClaveFabricante,  Impuesto1,  Impuesto2,  Impuesto3,  Factor,  Unidad,  UnidadCompra,  UnidadTraspaso,  UnidadCantidad,  TipoCosteo,  Peso,  Tara,  Volumen,  Tipo,  TipoOpcion,  Accesorios,  Refacciones,  Sustitutos,  Servicios,  Consumibles,  MonedaCosto,  MonedaPrecio,  MargenMinimo,  PrecioLista,  PrecioMinimo,  FactorAlterno,  PrecioAnterior,  Utilidad,  DescuentoCompra,  Clase,  Estatus,  UltimoCambio,  Alta,  Conciliar,  Mensaje,  Comision,  Arancel,  ArancelDesperdicio,  ABC,  Usuario,  Precio2,  Precio3,  Precio4,  Precio5,  Precio6,  Precio7,  Precio8,  Precio9,  Precio10,  Refrigeracion,  TieneCaducidad,  BasculaPesar,  SeProduce,  Situacion,  SituacionFecha,  SituacionUsuario,  SituacionNota,  EstatusPrecio,  wMostrar,  Merma,  Desperdicio,  SeCompra,  SeVende,  EsFormula,  TiempoEntrega,  TiempoEntregaUnidad,  TiempoEntregaSeg,  TiempoEntregaSegUnidad,  LoteOrdenar,  CantidadOrdenar,  MultiplosOrdenar,  InvSeguridad,  ProdRuta,  AlmacenROP,  CategoriaProd,  ProdCantidad,  ProdUsuario,  ProdPasoTotal,  ProdMovGrupo,  ProdEstacion,  ProdOpciones,  ProdVerConcentracion,  ProdVerCostoAcumulado,  ProdVerMerma,  ProdVerDesperdicio,  ProdVerPorcentaje,  RevisionUltima,  RevisionUsuario,  RevisionFrecuencia,  RevisionFrecuenciaUnidad,  RevisionSiguiente,  ProdMov,  TipoCompra,  TieneMovimientos,  Registro1,  Registro1Vencimiento,  AlmacenEspecificoVenta,  AlmacenEspecificoVentaMov,  RutaDistribucion,  CostoEstandar,  CostoReposicion,  EstatusCosto,  Margen,  Proveedor,  NivelAcceso,  Temporada,  SolicitarPrecios,  AutoRecaudacion,  Concepto,  Cuenta,  Retencion1,  Retencion2,  Retencion3,  Espacios,  EspaciosEspecificos,  EspaciosSobreventa,  EspaciosNivel,  EspaciosMinutos,  EspaciosBloquearAnteriores,  EspaciosHoraD,  EspaciosHoraA,  SerieLoteInfo,  CantidadMinimaVenta,  CantidadMaximaVenta,  EstimuloFiscal,  OrigenPais,  OrigenLocalidad,  Incentivo,  FactorCompra,  Horas,  ISAN,  ExcluirDescFormaPago,  EsDeducible,  Peaje,  CodigoAlterno,  TipoCatalogo,  AnexosAlFacturar,  CaducidadMinima,  Actividades,  ValidarPresupuestoCompra,  SeriesLotesAutoOrden,  LotesFijos,  LotesAuto,  Consecutivo,  TipoEmpaque,  Modelo,  TieneDireccion,  Direccion,  DireccionNumero,  DireccionNumeroInt,  EntreCalles,  Plano,  Observaciones,  Colonia,  Delegacion,  Poblacion,  Estado,  Pais,  CodigoPostal,  Ruta,  Codigo,  ClaveVehicular,  TipoVehiculo,  DiasLibresIntereses,  PrecioLiberado,  ValidarCodigo,  Presentacion,  GarantiaPlazo,  CostoIdentificado,  CantidadTarima,  UnidadTarima,  MinimoTarima,  DepartamentoDetallista,  TratadoComercial,  CuentaPresupuesto,  ProgramaSectorial,  PedimentoClave,  PedimentoRegimen,  Permiso,  PermisoRenglon,  Cuenta2,  Cuenta3,  Impuesto1Excento,  CalcularPresupuesto,  InflacionPresupuesto,  Excento2,  Excento3,  ContUso,  ContUso2,  ContUso3,  NivelToleranciaCosto,  ToleranciaCosto,  ToleranciaCostoInferior,  ObjetoGasto,  ObjetoGastoRef,  ClavePresupuestalImpuesto1,  Estructura,  TipoImpuesto1,  TipoImpuesto2,  TipoImpuesto3,  TipoRetencion1,  TipoRetencion2,  TipoRetencion3,  TipoImpuesto4,  Calificacion,  TipoImpuesto5,  INFORStockMinimo,  INFORStockMaximo,  InforPrefijo,  InforSufijo,  InforTipo, CodigoEstructura             ,TipoVariante
    FROM @Temp
    OPEN crDetalle
    FETCH NEXT FROM crDetalle INTO @Articulo, @Rama, @Descripcion1, @Descripcion2, @NombreCorto, @Grupo, @Categoria, @CategoriaActivoFijo, @Familia, @Linea, @Fabricante, @ClaveFabricante, @Impuesto1, @Impuesto2, @Impuesto3, @Factor, @Unidad, @UnidadCompra, @UnidadTraspaso, @UnidadCantidad, @TipoCosteo, @Peso, @Tara, @Volumen, @Tipo, @TipoOpcion, @Accesorios, @Refacciones, @Sustitutos, @Servicios, @Consumibles, @MonedaCosto, @MonedaPrecio, @MargenMinimo, @PrecioLista, @PrecioMinimo, @FactorAlterno, @PrecioAnterior, @Utilidad, @DescuentoCompra, @Clase, @Estatus, @UltimoCambio, @Alta, @Conciliar, @Mensaje, @Comision, @Arancel, @ArancelDesperdicio, @ABC, @Usuario, @Precio2, @Precio3, @Precio4, @Precio5, @Precio6, @Precio7, @Precio8, @Precio9, @Precio10, @Refrigeracion, @TieneCaducidad, @BasculaPesar, @SeProduce, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @EstatusPrecio, @wMostrar, @Merma, @Desperdicio, @SeCompra, @SeVende, @EsFormula, @TiempoEntrega, @TiempoEntregaUnidad, @TiempoEntregaSeg, @TiempoEntregaSegUnidad, @LoteOrdenar, @CantidadOrdenar, @MultiplosOrdenar, @InvSeguridad, @ProdRuta, @AlmacenROP, @CategoriaProd, @ProdCantidad, @ProdUsuario, @ProdPasoTotal, @ProdMovGrupo, @ProdEstacion, @ProdOpciones, @ProdVerConcentracion, @ProdVerCostoAcumulado, @ProdVerMerma, @ProdVerDesperdicio, @ProdVerPorcentaje, @RevisionUltima, @RevisionUsuario, @RevisionFrecuencia, @RevisionFrecuenciaUnidad, @RevisionSiguiente, @ProdMov, @TipoCompra, @TieneMovimientos, @Registro1, @Registro1Vencimiento, @AlmacenEspecificoVenta, @AlmacenEspecificoVentaMov, @RutaDistribucion, @CostoEstandar, @CostoReposicion, @EstatusCosto, @Margen, @Proveedor, @NivelAcceso, @Temporada, @SolicitarPrecios, @AutoRecaudacion, @Concepto, @Cuenta, @Retencion1, @Retencion2, @Retencion3, @Espacios, @EspaciosEspecificos, @EspaciosSobreventa, @EspaciosNivel, @EspaciosMinutos, @EspaciosBloquearAnteriores, @EspaciosHoraD, @EspaciosHoraA, @SerieLoteInfo, @CantidadMinimaVenta, @CantidadMaximaVenta, @EstimuloFiscal, @OrigenPais, @OrigenLocalidad, @Incentivo, @FactorCompra, @Horas, @ISAN, @ExcluirDescFormaPago, @EsDeducible, @Peaje, @CodigoAlterno, @TipoCatalogo, @AnexosAlFacturar, @CaducidadMinima, @Actividades, @ValidarPresupuestoCompra, @SeriesLotesAutoOrden, @LotesFijos, @LotesAuto, @Consecutivo, @TipoEmpaque, @Modelo, @TieneDireccion, @Direccion, @DireccionNumero, @DireccionNumeroInt, @EntreCalles, @Plano, @Observaciones, @Colonia, @Delegacion, @Poblacion, @Estado, @Pais, @CodigoPostal, @Ruta, @Codigo, @ClaveVehicular, @TipoVehiculo, @DiasLibresIntereses, @PrecioLiberado, @ValidarCodigo, @Presentacion, @GarantiaPlazo, @CostoIdentificado, @CantidadTarima, @UnidadTarima, @MinimoTarima, @DepartamentoDetallista, @TratadoComercial, @CuentaPresupuesto, @ProgramaSectorial, @PedimentoClave, @PedimentoRegimen, @Permiso, @PermisoRenglon, @Cuenta2, @Cuenta3, @Impuesto1Excento, @CalcularPresupuesto, @InflacionPresupuesto, @Excento2, @Excento3, @ContUso, @ContUso2, @ContUso3, @NivelToleranciaCosto, @ToleranciaCosto, @ToleranciaCostoInferior, @ObjetoGasto, @ObjetoGastoRef, @ClavePresupuestalImpuesto1, @Estructura, @TipoImpuesto1, @TipoImpuesto2, @TipoImpuesto3, @TipoRetencion1, @TipoRetencion2, @TipoRetencion3, @TipoImpuesto4, @Calificacion, @TipoImpuesto5, @INFORStockMinimo, @INFORStockMaximo, @InforPrefijo, @InforSufijo, @InforTipo, @CodigoEstructura  ,@TipoVariante
    WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
    BEGIN
      IF NOT EXISTS(SELECT * FROM Art WHERE Grupo = @Grupo) AND NULLIF(@Grupo,'') IS NOT NULL SELECT @Ok = 10255
      IF NOT EXISTS(SELECT * FROM Art WHERE Familia = @Familia ) AND NULLIF(@Familia,'') IS NOT NULL SELECT @Ok = 10265
      IF NOT EXISTS(SELECT * FROM Art WHERE AlmacenROP = @AlmacenROP ) SELECT @Ok = 20830
      --IF NOT EXISTS(SELECT * FROM Condicion WHERE Condicion = @Condicion ) AND NULLIF(@Condicion,'') IS NOT NULL SELECT @Ok = 30030
      IF EXISTS(SELECT * FROM Art WHERE Articulo = @Articulo) SELECT @Ok = 1
      IF @Tipo NOT IN ('Normal','Servicio','Serie','Lote','Juego','Estructura') SELECT @Ok = 73030

      INSERT Art( Articulo,  Rama,  Descripcion1,  Descripcion2,  NombreCorto,  Grupo,  Categoria,  CategoriaActivoFijo,  Familia,  Linea,  Fabricante,  ClaveFabricante,  Impuesto1,  Impuesto2,  Impuesto3,  Factor,  Unidad,  UnidadCompra,  UnidadTraspaso,  UnidadCantidad,  TipoCosteo,  Peso,  Tara,  Volumen,  Tipo,  TipoOpcion,  Accesorios,  Refacciones,  Sustitutos,  Servicios,  Consumibles,  MonedaCosto,  MonedaPrecio,  MargenMinimo,  PrecioLista,  PrecioMinimo,  FactorAlterno,  PrecioAnterior,  Utilidad,  DescuentoCompra,  Clase,  Estatus,  UltimoCambio,  Alta,  Conciliar,  Mensaje,  Comision,  Arancel,  ArancelDesperdicio,  ABC,  Usuario,  Precio2,  Precio3,  Precio4,  Precio5,  Precio6,  Precio7,  Precio8,  Precio9,  Precio10,  Refrigeracion,  TieneCaducidad,  BasculaPesar,  SeProduce,  Situacion,  SituacionFecha,  SituacionUsuario,  SituacionNota,  EstatusPrecio,  wMostrar,  Merma,  Desperdicio,  SeCompra,  SeVende,  EsFormula,  TiempoEntrega,  TiempoEntregaUnidad,  TiempoEntregaSeg,  TiempoEntregaSegUnidad,  LoteOrdenar,  CantidadOrdenar,  MultiplosOrdenar,  InvSeguridad,  ProdRuta,  AlmacenROP,  CategoriaProd,  ProdCantidad,  ProdUsuario,  ProdPasoTotal,  ProdMovGrupo,  ProdEstacion,  ProdOpciones,  ProdVerConcentracion,  ProdVerCostoAcumulado,  ProdVerMerma,  ProdVerDesperdicio,  ProdVerPorcentaje,  RevisionUltima,  RevisionUsuario,  RevisionFrecuencia,  RevisionFrecuenciaUnidad,  RevisionSiguiente,  ProdMov,  TipoCompra,  TieneMovimientos,  Registro1,  Registro1Vencimiento,  AlmacenEspecificoVenta,  AlmacenEspecificoVentaMov,  RutaDistribucion,  CostoEstandar,  CostoReposicion,  EstatusCosto,  Margen,  Proveedor,  NivelAcceso,  Temporada,  SolicitarPrecios,  AutoRecaudacion,  Concepto,  Cuenta,  Retencion1,  Retencion2,  Retencion3,  Espacios,  EspaciosEspecificos,  EspaciosSobreventa,  EspaciosNivel,  EspaciosMinutos,  EspaciosBloquearAnteriores,  EspaciosHoraD,  EspaciosHoraA,  SerieLoteInfo,  CantidadMinimaVenta,  CantidadMaximaVenta,  EstimuloFiscal,  OrigenPais,  OrigenLocalidad,  Incentivo,  FactorCompra,  Horas,  ISAN,  ExcluirDescFormaPago,  EsDeducible,  Peaje,  CodigoAlterno,  TipoCatalogo,  AnexosAlFacturar,  CaducidadMinima,  Actividades,  ValidarPresupuestoCompra,  SeriesLotesAutoOrden,  LotesFijos,  LotesAuto,  Consecutivo,  TipoEmpaque,  Modelo,  TieneDireccion,  Direccion,  DireccionNumero,  DireccionNumeroInt,  EntreCalles,  Plano,  Observaciones,  Colonia,  Delegacion,  Poblacion,  Estado,  Pais,  CodigoPostal,  Ruta,  Codigo,  ClaveVehicular,  TipoVehiculo,  DiasLibresIntereses,  PrecioLiberado,  ValidarCodigo,  Presentacion,  GarantiaPlazo,  CostoIdentificado,  CantidadTarima,  UnidadTarima,  MinimoTarima,  DepartamentoDetallista,  TratadoComercial,  CuentaPresupuesto,  ProgramaSectorial,  PedimentoClave,  PedimentoRegimen,  Permiso,  PermisoRenglon,  Cuenta2,  Cuenta3,  Impuesto1Excento,  CalcularPresupuesto,  InflacionPresupuesto,  Excento2,  Excento3,  ContUso,  ContUso2,  ContUso3,  NivelToleranciaCosto,  ToleranciaCosto,  ToleranciaCostoInferior,  ObjetoGasto,  ObjetoGastoRef,  ClavePresupuestalImpuesto1,  Estructura,  TipoImpuesto1,  TipoImpuesto2,  TipoImpuesto3,  TipoRetencion1,  TipoRetencion2,  TipoRetencion3,  TipoImpuesto4,  Calificacion,  TipoImpuesto5,  INFORStockMinimo,  INFORStockMaximo,  INFORPrefijo,  INFORSufijo,  INFORTipo, CodigoEstructura    ,TipoVariante)
      VALUES    (@Articulo, @Rama, @Descripcion1, @Descripcion2, @NombreCorto, @Grupo, @Categoria, @CategoriaActivoFijo, @Familia, @Linea, @Fabricante, @ClaveFabricante, @Impuesto1, @Impuesto2, @Impuesto3, @Factor, @Unidad, @UnidadCompra, @UnidadTraspaso, @UnidadCantidad, @TipoCosteo, @Peso, @Tara, @Volumen, @Tipo, @TipoOpcion, @Accesorios, @Refacciones, @Sustitutos, @Servicios, @Consumibles, @MonedaCosto, @MonedaPrecio, @MargenMinimo, @PrecioLista, @PrecioMinimo, @FactorAlterno, @PrecioAnterior, @Utilidad, @DescuentoCompra, @Clase, @Estatus, @UltimoCambio, @Alta, @Conciliar, @Mensaje, @Comision, @Arancel, @ArancelDesperdicio, @ABC, @Usuario, @Precio2, @Precio3, @Precio4, @Precio5, @Precio6, @Precio7, @Precio8, @Precio9, @Precio10, @Refrigeracion, @TieneCaducidad, @BasculaPesar, @SeProduce, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @EstatusPrecio, @wMostrar, @Merma, @Desperdicio, @SeCompra, @SeVende, @EsFormula, @TiempoEntrega, @TiempoEntregaUnidad, @TiempoEntregaSeg, @TiempoEntregaSegUnidad, @LoteOrdenar, @CantidadOrdenar, @MultiplosOrdenar, @InvSeguridad, @ProdRuta, @AlmacenROP, @CategoriaProd, @ProdCantidad, @ProdUsuario, @ProdPasoTotal, @ProdMovGrupo, @ProdEstacion, @ProdOpciones, @ProdVerConcentracion, @ProdVerCostoAcumulado, @ProdVerMerma, @ProdVerDesperdicio, @ProdVerPorcentaje, @RevisionUltima, @RevisionUsuario, @RevisionFrecuencia, @RevisionFrecuenciaUnidad, @RevisionSiguiente, @ProdMov, @TipoCompra, @TieneMovimientos, @Registro1, @Registro1Vencimiento, @AlmacenEspecificoVenta, @AlmacenEspecificoVentaMov, @RutaDistribucion, @CostoEstandar, @CostoReposicion, @EstatusCosto, @Margen, @Proveedor, @NivelAcceso, @Temporada, @SolicitarPrecios, @AutoRecaudacion, @Concepto, @Cuenta, @Retencion1, @Retencion2, @Retencion3, @Espacios, @EspaciosEspecificos, @EspaciosSobreventa, @EspaciosNivel, @EspaciosMinutos, @EspaciosBloquearAnteriores, @EspaciosHoraD, @EspaciosHoraA, @SerieLoteInfo, @CantidadMinimaVenta, @CantidadMaximaVenta, @EstimuloFiscal, @OrigenPais, @OrigenLocalidad, @Incentivo, @FactorCompra, @Horas, @ISAN, @ExcluirDescFormaPago, @EsDeducible, @Peaje, @CodigoAlterno, @TipoCatalogo, @AnexosAlFacturar, @CaducidadMinima, @Actividades, @ValidarPresupuestoCompra, @SeriesLotesAutoOrden, @LotesFijos, @LotesAuto, @Consecutivo, @TipoEmpaque, @Modelo,  @TieneDireccion, @Direccion, @DireccionNumero, @DireccionNumeroInt, @EntreCalles, @Plano, @Observaciones, @Colonia, @Delegacion, @Poblacion, @Estado, @Pais, @CodigoPostal, @Ruta, @Codigo, @ClaveVehicular, @TipoVehiculo, @DiasLibresIntereses, @PrecioLiberado, @ValidarCodigo, @Presentacion, @GarantiaPlazo, @CostoIdentificado, @CantidadTarima, @UnidadTarima, @MinimoTarima, @DepartamentoDetallista, @TratadoComercial, @CuentaPresupuesto, @ProgramaSectorial, @PedimentoClave, @PedimentoRegimen, @Permiso, @PermisoRenglon, @Cuenta2, @Cuenta3, @Impuesto1Excento, @CalcularPresupuesto, @InflacionPresupuesto, @Excento2, @Excento3, @ContUso, @ContUso2, @ContUso3, @NivelToleranciaCosto, @ToleranciaCosto, @ToleranciaCostoInferior, @ObjetoGasto, @ObjetoGastoRef, @ClavePresupuestalImpuesto1, @Estructura, @TipoImpuesto1, @TipoImpuesto2, @TipoImpuesto3, @TipoRetencion1, @TipoRetencion2, @TipoRetencion3, @TipoImpuesto4, @Calificacion, @TipoImpuesto5, @INFORStockMinimo, @INFORStockMaximo, @InforPrefijo, @InforSufijo, @InforTipo, @CodigoEstructura            ,@TipoVariante)
      IF @@ERROR <> 0 SET @Ok = 1

      FETCH NEXT FROM crDetalle INTO  @Articulo, @Rama, @Descripcion1, @Descripcion2, @NombreCorto, @Grupo, @Categoria, @CategoriaActivoFijo, @Familia, @Linea, @Fabricante, @ClaveFabricante, @Impuesto1, @Impuesto2, @Impuesto3, @Factor, @Unidad, @UnidadCompra, @UnidadTraspaso, @UnidadCantidad, @TipoCosteo, @Peso, @Tara, @Volumen, @Tipo, @TipoOpcion, @Accesorios, @Refacciones, @Sustitutos, @Servicios, @Consumibles, @MonedaCosto, @MonedaPrecio, @MargenMinimo, @PrecioLista, @PrecioMinimo, @FactorAlterno, @PrecioAnterior, @Utilidad, @DescuentoCompra, @Clase, @Estatus, @UltimoCambio, @Alta, @Conciliar, @Mensaje, @Comision, @Arancel, @ArancelDesperdicio, @ABC, @Usuario, @Precio2, @Precio3, @Precio4, @Precio5, @Precio6, @Precio7, @Precio8, @Precio9, @Precio10, @Refrigeracion, @TieneCaducidad, @BasculaPesar, @SeProduce, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @EstatusPrecio, @wMostrar, @Merma, @Desperdicio, @SeCompra, @SeVende, @EsFormula, @TiempoEntrega, @TiempoEntregaUnidad, @TiempoEntregaSeg, @TiempoEntregaSegUnidad, @LoteOrdenar, @CantidadOrdenar, @MultiplosOrdenar, @InvSeguridad, @ProdRuta, @AlmacenROP, @CategoriaProd, @ProdCantidad, @ProdUsuario, @ProdPasoTotal, @ProdMovGrupo, @ProdEstacion, @ProdOpciones, @ProdVerConcentracion, @ProdVerCostoAcumulado, @ProdVerMerma, @ProdVerDesperdicio, @ProdVerPorcentaje, @RevisionUltima, @RevisionUsuario, @RevisionFrecuencia, @RevisionFrecuenciaUnidad, @RevisionSiguiente, @ProdMov, @TipoCompra, @TieneMovimientos, @Registro1, @Registro1Vencimiento, @AlmacenEspecificoVenta, @AlmacenEspecificoVentaMov, @RutaDistribucion, @CostoEstandar, @CostoReposicion, @EstatusCosto, @Margen, @Proveedor, @NivelAcceso, @Temporada, @SolicitarPrecios, @AutoRecaudacion, @Concepto, @Cuenta, @Retencion1, @Retencion2, @Retencion3, @Espacios, @EspaciosEspecificos, @EspaciosSobreventa, @EspaciosNivel, @EspaciosMinutos, @EspaciosBloquearAnteriores, @EspaciosHoraD, @EspaciosHoraA, @SerieLoteInfo, @CantidadMinimaVenta, @CantidadMaximaVenta, @EstimuloFiscal, @OrigenPais, @OrigenLocalidad, @Incentivo, @FactorCompra, @Horas, @ISAN, @ExcluirDescFormaPago, @EsDeducible, @Peaje, @CodigoAlterno, @TipoCatalogo, @AnexosAlFacturar, @CaducidadMinima, @Actividades, @ValidarPresupuestoCompra, @SeriesLotesAutoOrden, @LotesFijos, @LotesAuto, @Consecutivo, @TipoEmpaque, @Modelo, @TieneDireccion, @Direccion, @DireccionNumero, @DireccionNumeroInt, @EntreCalles, @Plano, @Observaciones, @Colonia, @Delegacion, @Poblacion, @Estado, @Pais, @CodigoPostal, @Ruta, @Codigo, @ClaveVehicular, @TipoVehiculo, @DiasLibresIntereses, @PrecioLiberado, @ValidarCodigo, @Presentacion, @GarantiaPlazo, @CostoIdentificado, @CantidadTarima, @UnidadTarima, @MinimoTarima, @DepartamentoDetallista, @TratadoComercial, @CuentaPresupuesto, @ProgramaSectorial, @PedimentoClave, @PedimentoRegimen, @Permiso, @PermisoRenglon, @Cuenta2, @Cuenta3, @Impuesto1Excento, @CalcularPresupuesto, @InflacionPresupuesto, @Excento2, @Excento3, @ContUso, @ContUso2, @ContUso3, @NivelToleranciaCosto, @ToleranciaCosto, @ToleranciaCostoInferior, @ObjetoGasto, @ObjetoGastoRef, @ClavePresupuestalImpuesto1, @Estructura, @TipoImpuesto1, @TipoImpuesto2, @TipoImpuesto3, @TipoRetencion1, @TipoRetencion2, @TipoRetencion3, @TipoImpuesto4, @Calificacion, @TipoImpuesto5, @INFORStockMinimo, @INFORStockMaximo, @InforPrefijo, @InforSufijo, @InforTipo, @CodigoEstructura  ,@TipoVariante
    END
    CLOSE crDetalle
    DEALLOCATE crDetalle
  IF @Ok IS NULL
  SELECT @ReferenciaIS = Referencia
    FROM IntelisisService
   WHERE ID = @ID

  SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34) + ISNULL(CONVERT(varchar,@IDGenerar),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'

    IF @Ok IS NULL
    BEGIN
      COMMIT TRANSACTION
    END ELSE
    BEGIN
      ROLLBACK TRANSACTION
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')   
    END
END
GO


/************** spIntelisisCuentaMotivoRechazoListado ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaMotivoRechazoListado')           AND type = 'P') drop procedure dbo.spIntelisisCuentaMotivoRechazoListado
GO            
CREATE PROCEDURE spIntelisisCuentaMotivoRechazoListado
                               @ID                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                                      int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE

                               @Motivo             Varchar(8),
                               @Texto                                                 xml,
                               @ReferenciaIS                    varchar(100),
                               @SubReferencia                varchar(100)




  SELECT  @Motivo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Motivo'





  SELECT @Texto =(SELECT * FROM MotivoRechazo
   WHERE           ISNULL(Motivo,'') = ISNULL(ISNULL(@Motivo,Motivo),'')

                   FOR XML AUTO)            

  IF @@ERROR <> 0 SET @Ok = 1
  BEGIN
    SELECT @ReferenciaIS = Referencia
      FROM IntelisisService
     WHERE ID = @ID
    IF @@ERROR <> 0 SET @Ok = 1

    IF @Ok IS NULL
    BEGIN
      SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'
      IF @@ERROR <> 0 SET @Ok = 1
    END
  END
END
GO


/**************** spIntelisisInterfazInforTransferenciaMotivoRechazo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaMotivoRechazo')           AND type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaMotivoRechazo
GO            
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaMotivoRechazo
                               @ID                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                                      int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

 DECLARE
                               @Motivo                                       varchar(8),
                               @Datos                                                 varchar(max),
                               @Solicitud                                                                           varchar(max),
                               @ReferenciaIS                                                    varchar(100),
                               @SubReferencia                                                varchar(100),
                               @IDNuevo                                                                           int,
                               @Datos2                                                               varchar(max),
                               @Resultado2                                                                      varchar(max),
                               @Usuario                                                                             varchar(10),
                               @Contrasena                                                                     varchar(32)


  DECLARE
                               @Tabla                                 table
                               (
        Motivo       varchar(8),
        Descripcion  varchar(40)
                               )


  SELECT @Motivo = Motivo FROM openxml (@iSolicitud,'/Intelisis/Solicitud/MotivoRechazo')
    WITH (Motivo varchar(255))


 SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
   FROM IntelisisService
  WHERE ID = @ID


 SELECT @Contrasena = Contrasena
   FROM Usuario
  WHERE Usuario = @Usuario


 IF @Ok IS NULL
BEGIN

    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@ID,'')),'') + CHAR(34) +  ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@Ok,'')),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(ISNULL(@OkRef,''),'') + CHAR(34) + '/></Intelisis>'
    SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.MotivoRechazo.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Motivo" Valor="'+@Motivo+'"/></Solicitud></Intelisis>'

    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDnuevo Output

    IF @Ok IS NULL
      SELECT @Solicitud = Resultado
        FROM IntelisisService
       WHERE ID = @IDNuevo

      EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
      IF @@ERROR <> 0 SET @Ok = 1
      INSERT @Tabla (Motivo,Descripcion)

            SELECT Motivo,Descripcion
             FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/MotivoRechazo',1) 
                WITH (Motivo varchar(100),Descripcion varchar(100))
      IF @@ERROR <> 0 SET @Ok = 1
      EXEC sp_xml_removedocument @iSolicitud
      IF @@ERROR <> 0 SET @Ok = 1

    END
        SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oMotivoRechazo FOR XML AUTO))
        SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.MotivoRechazo.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>' 

  EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output                                                                                                                                                                                                                                                                                                      

END
GO


/**************** spInforGenerarSolicitudMotivoRechazo  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudMotivoRechazo')           AND type = 'P') drop procedure dbo.spInforGenerarSolicitudMotivoRechazo
GO
CREATE PROC spInforGenerarSolicitudMotivoRechazo
                               @Motivo        varchar (8),
                               @Estatus                                 varchar (10),
                               @Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int
  IF @Estatus IN ('ALTA','CAMBIO')

    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.MotivoRechazo" SubReferencia="'+@Estatus+'" Version="1.0" ><Solicitud> <MotivoRechazo  Motivo="'+@Motivo+'"/>  </Solicitud> </Intelisis>'
  IF @Estatus = 'BAJA'
      SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Cuenta.MotivoRechazo.Mantenimiento" SubReferencia="'+@Estatus+'" Version="1.0"  ><Solicitud><MotivoRechazo  Motivo="'+@Motivo+'"/> </Solicitud> </Intelisis>'

  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output


END
go



/**************** spISIntelisisPCInsertarMovPC_C****************/
if exists (select * from sysobjects where id = object_id('dbo.spISIntelisisPCInsertarMovPC_C') and type = 'P') drop procedure dbo.spISIntelisisPCInsertarMovPC_C
GO            
CREATE PROCEDURE spISIntelisisPCInsertarMovPC_C
                               @ID                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                                      int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @IDGenerar                                    int,
    @IDAcceso                                       int,         
    @MovTipo                                       varchar(20),
    @ReferenciaIS                                                varchar(100),
    @Usuario2                                       varchar(10),
    @Estacion                                        int,
    @SubReferencia                            varchar(100),
    @Empresa                    varchar(5),
    @Mov                        varchar(20),
    @MovID                      varchar(20),
    @FechaEmision               datetime   ,
    @UltimoCambio               datetime   ,
    @Proyecto                   varchar(50),
    @UEN                        int   ,
    @Concepto                   varchar(50),
    @Moneda                     varchar(10),
    @TipoCambio                 float   ,
    @Usuario                    varchar(10),
    @Autorizacion               varchar(10),
    @DocFuente                  int   ,
    @Observaciones              varchar(100),
    @Referencia                 varchar(50),
    @Estatus                    varchar(15),
    @Situacion                  varchar(50),
    @SituacionFecha             datetime   ,
    @SituacionUsuario           varchar(10),
    @SituacionNota              varchar(100),
    @OrigenTipo                 varchar(10),
    @Origen                     varchar(20),
    @OrigenID                   varchar(20),
    @Ejercicio                  int   ,
    @Periodo                    int   ,
    @FechaRegistro              datetime   ,
    @FechaConclusion            datetime   ,
    @FechaCancelacion           datetime   ,   
    @Poliza                     varchar(20),
    @PolizaID                   varchar(20),
    @GenerarPoliza              bit   ,
    @ContID                     int   ,
    @Sucursal                   int   ,
    @ListaModificar             varchar(20),
    @Proveedor                  varchar(10),
    @FechaInicio                datetime   ,
    @FechaTermino               datetime   ,
    @Recalcular                 bit   ,
    @Parcial                    bit   ,
    @Metodo                     varchar(50),
    @Monto                      float   ,
    @Logico1                    bit   ,
    @Logico2                    bit   ,
    @Logico3                    bit   ,
    @Logico4                    bit   ,
    @Logico5                    bit   ,
    @Logico6                    bit   ,
    @Logico7                    bit   ,
    @Logico8                    bit   ,
    @Logico9                    bit   ,
    @SincroID                   timestamp   ,
    @SincroC                    int   ,
    @SucursalOrigen             int   ,
    @SucursalDestino            int,  

-----detalle
    @Articulo                   varchar(20),
    @SubCuenta                  varchar(50),
    @Unidad                     varchar(50),
    @Nuevo                      money   ,
    @Anterior                   money   ,
    @Baja                       bit   ,
    @ExistenciaSucursal         float   ,
    @ListaModificarD            varchar(20),
    @SucursalEsp                int   ,
    @MontoD                     float   ,
    @SucursalD                  int   ,
    @SucursalOrigenD            int   ,
    @CostoBase                  money   ,
    @Renglon                    float,
    @ReferenciaIntelisisService  varchar(50),
    @Mov2                       varchar(20),
    @Precio                     float,
    @Planta                     varchar(20)


  DECLARE @Temp                table
         (
          ID            int,
          Renglon       float,
          Articulo      varchar(20),
          SubCuenta     varchar(50),
          Unidad        varchar(50),
          Nuevo         money,
          Anterior      money,
          Baja          bit,
          ExistenciaSucursal  float,
          ListaModificar  varchar(20),
          SucursalEsp       int,
          Monto         float,
          Sucursal      int,
          SucursalOrigen  int,
          CostoBase  money

         )



  BEGIN TRANSACTION
  SELECT @IDAcceso = dbo.fnAccesoID(@@SPID)

  SELECT @Estacion = EstacionTrabajo  FROM Acceso WHERE ID = @IDAcceso
    IF @Ok IS NULL
  BEGIN
    SELECT @Mov =  NULLIF(Mov,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
      WITH (Mov varchar(255))
    IF @@ERROR <> 0 SET @Ok = 1
  END

    SELECT @Mov2 = Mov FROM MapeoMovimientosInforIntelisis WHERE INFORMov = @Mov
    SELECT @MovTipo = Clave
                  FROM MovTipo
     WHERE Modulo = 'PC' AND Mov = @Mov2

  IF @MovTipo <> 'PC.C' SELECT @Ok = 35005, @OkRef = @Mov

  IF @Ok IS NULL
  BEGIN 

  SELECT  @Empresa = NULLIF(Empresa,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Empresa  varchar(255))

  SELECT  @FechaEmision = CONVERT(datetime,FechaEmision)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (FechaEmision  varchar(255))
  SELECT  @UltimoCambio = CONVERT(datetime,UltimoCambio)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (UltimoCambio  varchar(255))
  SELECT  @Proyecto = NULLIF(Proyecto,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Proyecto  varchar(255))
  SELECT  @UEN = CONVERT(int,UEN)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (UEN  varchar(255))
  SELECT  @Concepto = NULLIF(Concepto,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Concepto  varchar(255))
  SELECT  @Moneda = NULLIF(Moneda,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Moneda  varchar(255))
  SELECT  @TipoCambio = CONVERT(float,TipoCambio)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (TipoCambio  varchar(255))
  SELECT  @Usuario = NULLIF(Usuario,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Usuario  varchar(255))
  SELECT  @Autorizacion = NULLIF(Autorizacion,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Autorizacion  varchar(255))
  SELECT  @DocFuente = CONVERT(int,DocFuente)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (DocFuente  varchar(255))
  SELECT  @Observaciones = NULLIF(Observaciones,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Observaciones  varchar(255))
  SELECT  @Referencia = NULLIF(Referencia,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Referencia  varchar(255))
  SELECT  @Estatus = NULLIF(Estatus,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Estatus  varchar(255))
  SELECT  @Situacion = NULLIF(Situacion,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Situacion  varchar(255))
  SELECT  @SituacionFecha = CONVERT(datetime,SituacionFecha)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (SituacionFecha  varchar(255))
  SELECT  @SituacionUsuario = NULLIF(SituacionUsuario,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (SituacionUsuario  varchar(255))
  SELECT  @SituacionNota = NULLIF(SituacionNota,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (SituacionNota  varchar(255))
  SELECT  @OrigenTipo = NULLIF(OrigenTipo,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (OrigenTipo  varchar(255))
  SELECT  @Origen = NULLIF(Origen,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Origen  varchar(255))
  SELECT  @OrigenID = NULLIF(OrigenID,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (OrigenID  varchar(255))
  SELECT  @Ejercicio = CONVERT(int,Ejercicio)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Ejercicio  varchar(255))
  SELECT  @Periodo = CONVERT(int,Periodo)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Periodo  varchar(255))
  SELECT  @FechaRegistro = CONVERT(datetime,FechaRegistro)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (FechaRegistro  varchar(255))
  SELECT  @FechaConclusion = CONVERT(datetime,FechaConclusion)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (FechaConclusion  varchar(255))
  SELECT  @FechaCancelacion = CONVERT(datetime,FechaCancelacion)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (FechaCancelacion  varchar(255))
  SELECT  @Poliza = NULLIF(Poliza,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Poliza  varchar(255))
  SELECT  @PolizaID = NULLIF(PolizaID,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (PolizaID  varchar(255))  
  SELECT  @GenerarPoliza = CONVERT(bit,GenerarPoliza)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (GenerarPoliza  varchar(255))
  SELECT  @ContID = CONVERT(int,ContID)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (ContID  varchar(255))
  SELECT  @Sucursal = CONVERT(int,Sucursal)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Sucursal  varchar(255))
  SELECT  @ListaModificar = NULLIF(ListaModificar,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (ListaModificar  varchar(255))
  SELECT  @Proveedor = NULLIF(Proveedor,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Proveedor  varchar(255))  
  SELECT  @FechaInicio = CONVERT(datetime,FechaInicio)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (FechaInicio  varchar(255))
  SELECT  @FechaTermino = CONVERT(datetime,FechaTermino)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (FechaTermino  varchar(255))
  SELECT  @Recalcular = CONVERT(bit,Recalcular)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Recalcular  varchar(255))  
  SELECT  @Parcial = CONVERT(bit,Parcial)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Parcial  varchar(255))
  SELECT  @Metodo = NULLIF(Metodo,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Metodo  varchar(255))
  SELECT  @Monto = CONVERT(float,Monto)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Monto  varchar(255))  
  SELECT  @Logico1 = CONVERT(bit,Logico1)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Logico1  varchar(255))
  SELECT  @Logico2 = CONVERT(bit,Logico2)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Logico2  varchar(255)) 
  SELECT  @Logico3 = CONVERT(bit,Logico3)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Logico3  varchar(255))
  SELECT  @Logico4 = CONVERT(bit,Logico4)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Logico4  varchar(255))
  SELECT  @Logico5 = CONVERT(bit,Logico5)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Logico5  varchar(255))
  SELECT  @Logico6 = CONVERT(bit,Logico6)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Logico6  varchar(255))
  SELECT  @Logico7 = CONVERT(bit,Logico7)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Logico7  varchar(255))
  SELECT  @Logico8 = CONVERT(bit,Logico8)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Logico8  varchar(255))  
  SELECT  @Logico9 = CONVERT(bit,Logico9)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (Logico9  varchar(255))
  SELECT  @SucursalOrigen = CONVERT(int,SucursalOrigen)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (SucursalOrigen  varchar(255))
  SELECT  @SucursalDestino = CONVERT(int,SucursalDestino)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (SucursalDestino  varchar(255))
   SELECT  @ReferenciaIntelisisService = NULLIF(ReferenciaIntelisisService,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PC')
    WITH (ReferenciaIntelisisService  varchar(255))    



   END

  IF @Ok IS NULL
  BEGIN 
    SET @Estatus = 'SINAFECTAR' 

    SELECT @OrigenTipo='I:MES'
    SELECT @Empresa = Empresa ,@Planta=Planta
      FROM MapeoPlantaIntelisisMes
     WHERE Referencia = @ReferenciaIntelisisService
    SELECT @Sucursal = Sucursal, @SucursalOrigen = Sucursal
      FROM PlantaProductiva WHERE Clave =@Planta 



    IF NOT EXISTS(SELECT * FROM Mon WHERE Moneda = @Moneda ) SELECT @Ok = 20196
    IF NOT EXISTS(SELECT * FROM Proy WHERE Proyecto = @Proyecto ) AND NULLIF(@Proyecto,'') IS NOT NULL SELECT @Ok = 15010
    IF NOT EXISTS(SELECT * FROM UEN WHERE UEN = @UEN ) AND NULLIF(@UEN,'') IS NOT NULL SELECT @Ok = 10070
    IF NOT EXISTS(SELECT * FROM MovTipo WHERE Mov = @Mov ) SELECT @Ok = 14055
    IF NOT EXISTS(SELECT * FROM Sucursal WHERE Sucursal =  @Sucursal)SELECT @Ok = 72060
    IF NOT EXISTS(SELECT * FROM Empresa WHERE Empresa =  @Empresa)SELECT @Ok =26070
  END

  IF @Ok IS NULL
  BEGIN 
    INSERT INTO PC ( Empresa, Mov, FechaEmision, UltimoCambio, Proyecto, UEN, Concepto, Moneda, TipoCambio, Usuario, Autorizacion, DocFuente, Observaciones, Referencia, Estatus, Situacion, SituacionFecha, SituacionUsuario, SituacionNota, OrigenTipo, Origen, OrigenID, Ejercicio, Periodo, FechaRegistro, FechaConclusion, FechaCancelacion, Poliza, PolizaID, GenerarPoliza, ContID, Sucursal, ListaModificar, Proveedor, FechaInicio, FechaTermino, Recalcular, Parcial, Metodo, Monto, Logico1, Logico2, Logico3, Logico4, Logico5, Logico6, Logico7, Logico8, Logico9, SucursalOrigen, SucursalDestino)
                     VALUES (   @Empresa, @Mov,  @FechaEmision, @UltimoCambio, @Proyecto, @UEN, @Concepto, @Moneda, @TipoCambio, @Usuario, @Autorizacion, @DocFuente, @Observaciones, @Referencia, @Estatus, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @OrigenTipo, @Origen, @OrigenID, @Ejercicio, @Periodo, @FechaRegistro, @FechaConclusion, @FechaCancelacion, @Poliza, @PolizaID, @GenerarPoliza, @ContID, @Sucursal, @ListaModificar, @Proveedor, @FechaInicio, @FechaTermino, @Recalcular, @Parcial, @Metodo, @Monto, @Logico1, @Logico2, @Logico3, @Logico4, @Logico5, @Logico6, @Logico7, @Logico8, @Logico9,  @SucursalOrigen, @SucursalDestino)
    IF @@ERROR <> 0 SET @Ok = 1
    SET @IDGenerar = SCOPE_IDENTITY()

  END
  INSERT @Temp (  Articulo, SubCuenta, Unidad, Nuevo, Anterior, Baja, ExistenciaSucursal, ListaModificar, SucursalEsp, Monto, Sucursal, SucursalOrigen, CostoBase)
  SELECT          Articulo, SubCuenta, Unidad, Nuevo, Anterior, Baja, ExistenciaSucursal, ListaModificar, SucursalEsp, Monto, Sucursal, SucursalOrigen, CostoBase
    FROM OPENXML(@iSolicitud, '/Intelisis/Solicitud/PC/PCD',1) 
    WITH (Articulo   varchar(100), SubCuenta   varchar(100), Unidad   varchar(100), Nuevo   varchar(100), Anterior   varchar(100), Baja   varchar(100), ExistenciaSucursal   varchar(100), ListaModificar   varchar(100), SucursalEsp   varchar(100), Monto   varchar(100), Sucursal   varchar(100), SucursalOrigen   varchar(100), CostoBase  varchar(100))


  BEGIN
    DECLARE crDetalle CURSOR LOCAL FAST_FORWARD FOR
    SELECT   Articulo, SubCuenta, Unidad, Nuevo, Anterior, Baja, ExistenciaSucursal, ListaModificar, SucursalEsp, Monto, Sucursal, SucursalOrigen, CostoBase
    FROM @Temp
    SET @Renglon = 0.0

    OPEN crDetalle
    FETCH NEXT FROM crDetalle INTO   @Articulo,@SubCuenta , @Unidad, @Nuevo, @Anterior, @Baja, @ExistenciaSucursal, @ListaModificarD, @SucursalEsp, @MontoD, @SucursalD, @SucursalOrigenD, @CostoBase
    WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
    BEGIN
      SELECT @SubCuenta =ISNULL(@SubCuenta,'')
       EXEC spPCGet @Sucursal, @Empresa, @Articulo, @SubCuenta, @Unidad, @Moneda, @TipoCambio, @ListaModificar, @Precio OUTPUT                               
       SELECT @Anterior = @Precio

       SET @Renglon = @Renglon + 2048.0

      INSERT PCD (   ID        ,  Renglon,  Articulo, SubCuenta, Unidad, Nuevo, Anterior, Baja, ExistenciaSucursal, ListaModificar, SucursalEsp, Monto, Sucursal, SucursalOrigen)
      VALUES         (@IDGenerar, @Renglon, @Articulo, @SubCuenta, @Unidad, @Nuevo, @Anterior, @Baja, @ExistenciaSucursal, @ListaModificarD, @SucursalEsp, @MontoD, @Sucursal, @SucursalOrigen)

      IF @@ERROR <> 0 SET @Ok = 1

      FETCH NEXT FROM crDetalle INTO  @Articulo, @SubCuenta, @Unidad, @Nuevo, @Anterior, @Baja, @ExistenciaSucursal, @ListaModificarD, @SucursalEsp, @MontoD, @SucursalD, @SucursalOrigenD, @CostoBase
    END
    CLOSE crDetalle
    DEALLOCATE crDetalle
  END 

  IF @Ok IS NULL
    EXEC spAfectar 'PC', @IDGenerar, @EnSilencio = 1, @Conexion = 1, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT

  IF @Ok IS NULL
    SELECT @ReferenciaIS = Referencia
      FROM IntelisisService
     WHERE ID = @ID

  SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + ' Modulo="PC" ModuloID =' + CHAR(34) + ISNULL(CONVERT(varchar,@IDGenerar),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'

  IF @Ok IS NULL
  BEGIN
    COMMIT TRANSACTION
  END ELSE
  BEGIN
    ROLLBACK TRANSACTION
  END
END
GO


/**************** spIntelisisInterfazInforTransferenciaArtOpcion ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaArtOpcion')           AND type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaArtOpcion
GO            
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaArtOpcion
                               @ID                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                                      int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE
                               @Datos                                                 varchar(max),
                               @Solicitud                                                                           varchar(max),
                               @ReferenciaIS                                                    varchar(100),
                               @SubReferencia                                                varchar(100),
                               @IDNuevo                                                                           int,
                               @Datos2                                                               varchar(max),
                               @Resultado2                                                                      varchar(max),
                               @Usuario                                                                             varchar(10),
                               @Contrasena                                                                     varchar(32)


  DECLARE
                               @Tabla                                 table
                               (
        InforVariante       varchar(1),
        InforDescripcion  varchar(40)
                               )




 SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
   FROM IntelisisService
  WHERE ID = @ID


 SELECT @Contrasena = Contrasena
   FROM Usuario
  WHERE Usuario = @Usuario



    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@ID,'')),'') + CHAR(34) +  ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@Ok,'')),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(ISNULL(@OkRef,''),'') + CHAR(34) + '/></Intelisis>'

    IF @Ok IS NULL
      SELECT @Solicitud = Resultado
        FROM IntelisisService
       WHERE ID = @IDNuevo


        INSERT @Tabla (InforVariante,InforDescripcion)
                SELECT Opcion,Descripcion
                  FROM Opcion

        SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oVariantes FOR XML AUTO))
        SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Opcion.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>' 

  EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output                                                                                                                                                                                                                                                                                                      

END
GO

/**************** spIntelisisInterfazInforTransferenciaArtOpcionDetalle ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaArtOpcionDetalle')           AND type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaArtOpcionDetalle
GO            
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaArtOpcionDetalle
                               @ID                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                                      int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE
                               @Datos                                                 varchar(max),
                               @Solicitud                                                                           varchar(max),
                               @ReferenciaIS                                                    varchar(100),
                               @SubReferencia                                                varchar(100),
                               @IDNuevo                                                                           int,
                               @Datos2                                                               varchar(max),
                               @Resultado2                                                                      varchar(max),
                               @Usuario                                                                             varchar(10),
                               @Contrasena                                                                     varchar(32)


  DECLARE
                               @Tabla                                 table
                               (
        InforVariante       varchar(1),
        InforValor          int,
        InforDescripcion    varchar(100)
                               )




 SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
   FROM IntelisisService
  WHERE ID = @ID


 SELECT @Contrasena = Contrasena
   FROM Usuario
  WHERE Usuario = @Usuario




    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@ID,'')),'') + CHAR(34) +  ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@Ok,'')),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(ISNULL(@OkRef,''),'') + CHAR(34) + '/></Intelisis>'

    IF @Ok IS NULL
      SELECT @Solicitud = Resultado
        FROM IntelisisService
       WHERE ID = @IDNuevo


        INSERT @Tabla (InforVariante,InforValor,InforDescripcion)
                SELECT Opcion,Numero,Nombre
                  FROM OpcionD

        SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oVariantes FOR XML AUTO))
        SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.OpcionDetalle.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>' 

  EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output                                                                                                                                                                                                                                                                                                      

END
GO


/**************** spInforGenerarSolicitudOpciones  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudOpciones')           AND type = 'P') drop procedure dbo.spInforGenerarSolicitudOpciones
GO
CREATE PROC spInforGenerarSolicitudOpciones
@Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int,
    @Datos2                             varchar(max)


    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.Opcion" SubReferencia="" Version="1.0" ><Solicitud></Solicitud> </Intelisis>'


  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output
   EXEC spInforGenerarSolicitudOpcionesDetalle   @Datos2   
    SELECT 'Operacion Completada'
END
go

/**************** spInforGenerarSolicitudOpcionesDetalle  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforGenerarSolicitudOpcionesDetalle')           AND type = 'P') drop procedure dbo.spInforGenerarSolicitudOpcionesDetalle
GO
CREATE PROC spInforGenerarSolicitudOpcionesDetalle
@Datos                                   varchar (max) OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
    @AccesoID                                                                      int,
    @Usuario                                                             varchar(10),
    @Ok                                                                   int,
    @OkRef                                                             varchar(255),
    @Contrasena                                                                 varchar(32),
    @Resultado                                                                     varchar(max),
    @Id                                                                    int


    SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.OpcionDetalle" SubReferencia="" Version="1.0" ><Solicitud></Solicitud> </Intelisis>'


  SELECT  @Usuario =  dbo.fnAccesoUsuario(@@SPID)
  SELECT @Contrasena = Contrasena
                FROM Usuario
   WHERE Usuario = @Usuario
   EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output


END
go


/************** spObjetivoVentasIntelisisMES***************/
if exists (select * from sysobjects where id = object_id('dbo.spObjetivoVentasIntelisisMES') and sysstat & 0xf = 4) drop procedure dbo.spObjetivoVentasIntelisisMES
GO
CREATE PROCEDURE spObjetivoVentasIntelisisMES
                               @ID                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                                      int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE

                               @FechaD                                             DateTime,
        @FechaA                                     DateTime,
                               @Empresa                            varchar(5),
                               @Sucursal                             int,
                               @Usuario                             varchar(10),
                               @PlantaSucEmpresa                        varchar(10),
                               @Contrasena                                                     varchar(32),
                               @ReferenciaIntelisisService                                           varchar(50),  
                               @Texto                                                 varchar(max),
                               @ReferenciaIS                    varchar(100),
                               @SubReferencia                varchar(100),
                               @Datos                                                 varchar(max),
                               @Solicitud                                                                           varchar(max),
                               @IDNuevo                                                                           int,
                               @Datos2                                                               varchar(max),
                               @Resultado2                                                                      varchar(max)

  DECLARE                            @Tabla                                table
                               (
                                Anyo                                      int,
                                Periodo                                int,
                                Articulo                                                varchar(20),
                                SubCuenta                          varchar(50),
                                UnidadesAlmacen                                           varchar(40),
                                ImporteVenta                                    varchar(40),
                                ImporteCoste                                     varchar(40),
                                ReferenciaIntelisisService                                               varchar(50)
                                               )

    SELECT @Empresa = Empresa FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Objetivo')
      WITH (Empresa varchar(255))
    SELECT @Sucursal = Sucursal FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Objetivo')
      WITH (Sucursal varchar(255))
    SELECT @FechaD = FechaD FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Objetivo')
      WITH (FechaD varchar(255))
    SELECT @FechaA = FechaA FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Objetivo')
      WITH (FechaA varchar(255)) 

    SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
      FROM IntelisisService
     WHERE ID = @ID
    SELECT @Contrasena = Contrasena
      FROM Usuario
     WHERE Usuario = @Usuario

--      SELECT @PlantaSucEmpresa = PlantaSucEmpresa
--        FROM Version
--
--      IF @PlantaSucEmpresa = 'Empresa' 
      SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService
        FROM Empresa
       WHERE Empresa = @Empresa
--
----      IF @PlantaSucEmpresa = 'Sucursal' 
--      SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService
--        FROM Sucursal
--       WHERE Sucursal = @Sucursal


    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'


    SET @Datos=
             '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Objetivo  /></Solicitud></Intelisis>'


    SELECT @Solicitud = Resultado
      FROM IntelisisService
     WHERE ID = @IDNuevo

      SELECT @Empresa = NULLIF(Empresa,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Objetivo')
      WITH (Empresa varchar(255))
    SELECT @Sucursal = CONVERT(int,NULLIF(Sucursal,'')) FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Objetivo')
      WITH (Sucursal varchar(255))
    SELECT @FechaD = CONVERT(datetime,FechaD) FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Objetivo')
      WITH (FechaD varchar(255))
    SELECT @FechaA= CONVERT(datetime,FechaA) FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Objetivo')
      WITH (FechaA varchar(255))



   INSERT @Tabla(              Anyo,                Periodo,         Articulo,SubCuenta, UnidadesAlmacen, ImporteVenta, ImporteCoste, ReferenciaIntelisisService               )
    SELECT year(v.FechaRequerida), MONTH(v.FechaRequerida), d.Articulo,d.SubCuenta,sum(d.Cantidad),   avg(d.Precio), avg(d.Costo),   ISNULL(@ReferenciaIntelisisService,'')
      FROM Venta v JOIN VentaD d ON v.ID = d.ID
      JOIN Art a ON a.Articulo = d.Articulo
      JOIN MovTipo  mt ON mt.Mov = v.Mov AND mt.Modulo = 'VTAS'
      WHERE v.Estatus = 'CONCLUIDO'
        AND a.InforTipo = 'PRODUCTO ACABADO'
        AND v.FechaRequerida BETWEEN @FechaD AND @FechaA
        AND mt.Clave = 'VTAS.PR'
      GROUP BY year(v.FechaRequerida), MONTH(v.FechaRequerida), d.Articulo,d.SubCuenta

     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oObjetivosVentas FOR XML AUTO))


     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) + 'Infor.Reporte.ObjetivosVentas' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  +' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>'                        
     EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output                                                                                                                                                                                                                                                                                                   

      IF @@ERROR <> 0 SET @Ok = 1

  END
GO


/**************** spISIntelisisINVInsertarMovINV_T ****************/
if exists (select * from sysobjects where id = object_id('dbo.spISIntelisisINVInsertarMovINV_T') and type = 'P') drop procedure dbo.spISIntelisisINVInsertarMovINV_T
GO            
CREATE PROCEDURE spISIntelisisINVInsertarMovINV_T
                               @ID                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                                      int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @IDGenerar                                    int,
    @IDAcceso                                       int,         
    @MovTipo                                       varchar(20),
    @ReferenciaIS                                                varchar(100),
    @Usuario2                                       varchar(10),
    @Estacion                                        int,
    @SubReferencia                            varchar(100),
    @Empresa                            varchar(5),
    @Mov                                                   varchar(20),
    @MovID                                           varchar(20),
    @FechaEmision                                             datetime   ,
    @UltimoCambio                                            datetime   ,
    @Concepto                                                     varchar(50),
    @Proyecto                        varchar(50),
    @Actividad                                                     varchar(100),
    @UEN                                                   int   ,
    @Moneda                                        varchar(10),
    @TipoCambio                                 float   ,
    @Usuario                                          varchar(10),
    @Autorizacion                                                varchar(10),
    @Referencia                                                   varchar(50),
    @DocFuente                                   int   ,
    @Observaciones                                           varchar(100),
    @Estatus                                           varchar(15),
    @Situacion                                                      varchar(50),
    @SituacionFecha                                          datetime   ,
    @SituacionUsuario                        varchar(10),
    @SituacionNota                                             varchar(100),
    @Prioridad                                                      varchar(10),
    @Directo                                          bit   ,
    @RenglonID                                                   int   ,
    @Almacen                                       varchar(10),
    @AlmacenDestino                                        varchar(10),
    @AlmacenTransito                                       varchar(10),
    @Largo                                             bit   ,
    @FechaRequerida                                        datetime   ,
    @Condicion                                                    varchar(50),
    @Vencimiento                                datetime   ,
    @FormaEnvio                                 varchar(50),
    @OrigenTipo                                  varchar(10),
    @Origen                                           varchar(20),
    @OrigenID                                                      varchar(20),
    @Poliza                                             varchar(20),
    @PolizaID                         varchar(20),
    @GenerarPoliza                                             bit   ,
    @ContID                                           int   ,
    @Ejercicio                         int   ,
    @Periodo                                         int   ,
    @FechaRegistro                                            datetime   ,
    @FechaConclusion                                       datetime   ,
    @FechaCancelacion                    datetime   ,
    @FechaOrigen                               datetime   ,
    @Peso                                               float   ,
    @Volumen                                       float   ,
    @Paquetes                                                      int   ,
    @FechaEntrega                                            datetime   ,
    @EmbarqueEstado                                       varchar(50),
    @Sucursal                         int   ,
    @Importe                                         money   ,
    @Logico1                                         bit   ,
    @Logico2                                         bit   ,
    @Logico3                                         bit   ,
    @Logico4                                         bit   ,
    @Logico5                                         bit   ,
    @Logico6                                         bit   ,
    @Logico7                                         bit   ,
    @Logico8                                         bit   ,
    @Logico9                                         bit   ,
    @VerLote                                         bit   ,
    @EspacioResultado                       bit   ,
    @VerDestino                                   bit   ,
    @EstaImpreso                                 bit   ,
    @Personal                        varchar(10),
    @Reabastecido                              bit   ,
    @Conteo                                          int   ,
    @Agente                                          varchar(10),
    @ACRetencion                               float   ,
    @SubModulo                                  varchar(5),
    @SucursalOrigen                                           int   ,
    @SucursalDestino                                         int   ,
    @PedimentoExtraccion                               varchar(50),
-----detalle
    @IDD                                                 int   ,
    @Renglon                                        float   ,
    @RenglonSub                                int   ,
    @RenglonIDD                                 int   ,
    @RenglonTipo                               char(1),
    @Cantidad                                                     float   ,
    @AlmacenD                                                   varchar(10),
    @Codigo                                                          varchar(30),
    @Articulo                          varchar(20),
    @ArticuloDestino                                           varchar(20),
    @SubCuenta                                   varchar(50),
    @SubCuentaDestino                                    varchar(50),
    @Costo                                                             money   ,
    @CostoInv                                       money   ,
    @ContUso                                        varchar(20),
    @Espacio                                         varchar(10),
    @CantidadReservada                                  float   ,
    @CantidadCancelada                                 float   ,
    @CantidadOrdenada                                  float   ,
    @CantidadPendiente                                  float   ,
    @CantidadA                                                   float   ,
    @Paquete                                        int   ,
    @Aplica                                            varchar(20),
    @AplicaID                        varchar(20),
    @DestinoTipo                                 varchar(10),
    @Destino                                         varchar(20),
    @DestinoID                                                     varchar(20),
    @Cliente                                          varchar(10),
    @Unidad                                         varchar(50),
    @Factor                                            float   ,
    @CantidadInventario                                  float   ,
    @UltimoReservadoCantidad      float   ,
    @UltimoReservadoFecha            datetime   ,
    @ProdSerieLote                                             varchar(50),
    @Merma                                          float   ,
    @Desperdicio                                 float   ,
    @Producto                                                      varchar(20),
    @SubProducto                                varchar(20),
    @Tipo                                               varchar(20),
    @Precio                                                            money   ,
    @SegundoConteo                                        float   ,
    @DescripcionExtra                        varchar(100),
    @AjusteCosteo                                money   ,
    @CostoUEPS                                   money   ,
    @CostoPEPS                                    money   ,
    @UltimoCosto                                                money   ,
    @PrecioLista                                                   money   ,
    @DepartamentoDetallista          int   ,
    @AjustePrecioLista                                        money   ,
    @Posicion                         varchar(10),
    @Tarima                                           varchar(20),
    @Seccion                                         smallint   ,
    @CostoEstandar                             money   ,
    @FechaCaducidad                                       datetime   ,
    @CostoPromedio                           money   ,
    @CostoReposicion                                        money  ,
    @Proveedor                                    varchar(10),
    @ReferenciaIntelisisService varchar(50)



  DECLARE @Temp                table
         (
     IDD                                                   int   ,
     Renglon                          float   ,
     RenglonSub                                   int   ,
     RenglonID                                                     int   ,
     RenglonTipo                                                 char(1),
     Cantidad                         float   ,
     Almacen                          varchar(10),
     Codigo                                            varchar(30),
     Articulo                            varchar(20),
     ArticuloDestino                             varchar(20),
     SubCuenta                                                    varchar(50),
     SubCuentaDestino                      varchar(50),
     Costo                                                               money   ,
     CostoInv                                          money   ,
     ContUso                          varchar(20),
     Espacio                            varchar(10),
     CantidadReservada                    float   ,
     CantidadCancelada                    float   ,
     CantidadOrdenada                     float   ,
     CantidadPendiente                    float   ,
     CantidadA                                                     float   ,
     Paquete                           int   ,
     FechaRequerida                                          datetime   ,
     Aplica                                              varchar(20),
     AplicaID                           varchar(20),
     DestinoTipo                                   varchar(10),
     Destino                            varchar(20),
     DestinoID                        varchar(20),
     Cliente                             varchar(10),
     Unidad                                            varchar(50),
     Factor                                              float   ,
     CantidadInventario                     float   ,
     UltimoReservadoCantidad        float   ,
     UltimoReservadoFecha              datetime   ,
     ProdSerieLote                                               varchar(50),
     Merma                                             float   ,
     Desperdicio                                   float   ,
     Producto                         varchar(20),
     SubProducto                                                 varchar(20),
     Tipo                                                  varchar(20),
     Sucursal                           int   ,
     Precio                                               money   ,
     SegundoConteo                                          float   ,
     DescripcionExtra                          varchar(100),
     AjusteCosteo                                                 money   ,
     CostoUEPS                                      money   ,
     CostoPEPS                                      money   ,
     UltimoCosto                                                   money   ,
     PrecioLista                                                      money   ,
     DepartamentoDetallista             int   ,
     AjustePrecioLista                                          money   ,
     Posicion                           varchar(10),
     SucursalOrigen                                             int   ,
     Tarima                                             varchar(20),
     Seccion                                           smallint   ,
     CostoEstandar                               money   ,
     FechaCaducidad                                         datetime   ,
     CostoPromedio                              money   ,
     CostoReposicion                                           money 
         )


  BEGIN TRANSACTION
  SELECT @IDAcceso = dbo.fnAccesoID(@@SPID)

  SELECT @Estacion = EstacionTrabajo  FROM Acceso WHERE ID = @IDAcceso

  IF @Ok IS NULL
  BEGIN
    SELECT @Mov =  NULLIF(Mov,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
      WITH (Mov varchar(255))
    IF @@ERROR <> 0 SET @Ok = 1
  END

  IF @Ok IS NULL
    SELECT @MovTipo = Clave
                  FROM MovTipo
     WHERE Modulo = 'INV' AND Mov = @Mov


  IF @MovTipo <> 'INV.T' SELECT @Ok = 35005, @OkRef = @Mov

  IF @Ok IS NULL
  BEGIN 
     SELECT  @Mov = NULLIF(Mov,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Mov   varchar(255)) 
     SELECT  @MovID = NULLIF(MovID,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(MovID   varchar(255)) 
     SELECT  @FechaEmision = dbo.fnFechaSinHora(GETDATE()) 
     SELECT  @UltimoCambio = CONVERT(datetime,UltimoCambio)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(UltimoCambio   varchar(255)) 
     SELECT  @Concepto = NULLIF(Concepto,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Concepto   varchar(255)) 
     SELECT  @Proyecto = NULLIF(Proyecto,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Proyecto   varchar(255)) 
     SELECT  @Actividad = NULLIF(Actividad,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Actividad   varchar(255)) 
     SELECT  @UEN = CONVERT(int,UEN)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(UEN   varchar(255)) 
     SELECT  @Moneda = NULLIF(Moneda,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Moneda   varchar(255)) 
     SELECT  @TipoCambio = CONVERT(float , TipoCambio)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(TipoCambio   varchar(255)) 
     SELECT  @Usuario = NULLIF(Usuario,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Usuario   varchar(255))
     SELECT  @Autorizacion = NULLIF(Autorizacion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Autorizacion   varchar(255)) 
     SELECT  @Referencia = NULLIF(Referencia,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Referencia   varchar(255)) 
     SELECT  @DocFuente = CONVERT(int,DocFuente)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(DocFuente   varchar(255)) 
     SELECT  @Observaciones = NULLIF(Observaciones,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Observaciones   varchar(255)) 
     SELECT  @Estatus = NULLIF(Estatus,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Estatus   varchar(255)) 
     SELECT  @Situacion = NULLIF(Situacion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Situacion   varchar(255)) 
     SELECT  @SituacionFecha = CONVERT(datetime,SituacionFecha)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SituacionFecha   varchar(255)) 
     SELECT  @SituacionUsuario = NULLIF(SituacionUsuario,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SituacionUsuario   varchar(255)) 
     SELECT  @SituacionNota = NULLIF(SituacionNota,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SituacionNota   varchar(255))
     SELECT  @Prioridad = NULLIF(Prioridad,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Prioridad   varchar(255)) 
     SELECT  @Directo = CONVERT(bit,Directo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Directo   varchar(255))
     SELECT  @RenglonID = CONVERT(int,RenglonID)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(RenglonID   varchar(255)) 
     SELECT  @Almacen = NULLIF(Almacen,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Almacen   varchar(255)) 
     SELECT  @AlmacenDestino = NULLIF(AlmacenDestino,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(AlmacenDestino   varchar(255)) 
     SELECT  @AlmacenTransito = NULLIF(AlmacenTransito,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(AlmacenTransito   varchar(255)) 
     SELECT  @Largo = CONVERT(bit,Largo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Largo   varchar(255)) 
     SELECT  @FechaRequerida = CONVERT(datetime,FechaRequerida)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FechaRequerida   varchar(255)) 
     SELECT  @Condicion = NULLIF(Condicion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Condicion   varchar(255)) 
     SELECT  @Vencimiento = CONVERT(datetime,Vencimiento)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Vencimiento   varchar(255)) 
     SELECT  @FormaEnvio = NULLIF(FormaEnvio,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FormaEnvio   varchar(255)) 
     SELECT  @OrigenTipo = NULLIF(OrigenTipo,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(OrigenTipo   varchar(255)) 
     SELECT  @Origen = NULLIF(Origen,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Origen   varchar(255)) 
     SELECT  @OrigenID = NULLIF(OrigenID,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(OrigenID   varchar(255)) 
     SELECT  @Poliza = NULLIF(Poliza,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Poliza   varchar(255)) 
     SELECT  @PolizaID = NULLIF(PolizaID,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(PolizaID   varchar(255)) 
     SELECT  @GenerarPoliza = CONVERT(bit,GenerarPoliza)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(GenerarPoliza   varchar(255)) 
     SELECT  @ContID = CONVERT(int,ContID)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(ContID   varchar(255)) 
     SELECT  @Ejercicio = CONVERT(int,Ejercicio)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Ejercicio   varchar(255)) 
     SELECT  @Periodo = CONVERT(int,Periodo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Periodo   varchar(255)) 
     SELECT  @FechaRegistro = GETDATE() 
     SELECT  @FechaOrigen = CONVERT(datetime,FechaOrigen)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FechaOrigen   varchar(255)) 
     SELECT  @Peso = CONVERT(float , Peso)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Peso   varchar(255)) 
     SELECT  @Volumen = CONVERT(float , Volumen)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Volumen   varchar(255)) 
     SELECT  @Paquetes = CONVERT(int,Paquetes)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Paquetes   varchar(255)) 
     SELECT  @FechaEntrega = CONVERT(datetime,FechaEntrega)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FechaEntrega   varchar(255)) 
     SELECT  @EmbarqueEstado = NULLIF(EmbarqueEstado,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(EmbarqueEstado   varchar(255)) 
     SELECT  @Importe = CONVERT(money,Importe)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Importe   varchar(255)) 
     SELECT  @Logico1 = CONVERT(bit,Logico1)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico1   varchar(255)) 
     SELECT  @Logico2 = CONVERT(bit,Logico2)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico2   varchar(255)) 
     SELECT  @Logico3 = CONVERT(bit,Logico3)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico3   varchar(255)) 
     SELECT  @Logico4 = CONVERT(bit,Logico4)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico4   varchar(255)) 
     SELECT  @Logico5 = CONVERT(bit,Logico5)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico5   varchar(255)) 
     SELECT  @Logico6 = CONVERT(bit,Logico6)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico6   varchar(255)) 
     SELECT  @Logico7 = CONVERT(bit,Logico7)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico7   varchar(255)) 
     SELECT  @Logico8 = CONVERT(bit,Logico8)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico8   varchar(255)) 
     SELECT  @Logico9 = CONVERT(bit,Logico9)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico9   varchar(255)) 
     SELECT  @VerLote = CONVERT(bit,VerLote)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(VerLote   varchar(255)) 
     SELECT  @EspacioResultado = CONVERT(bit,EspacioResultado)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(EspacioResultado   varchar(255)) 
     SELECT  @VerDestino = CONVERT(bit,VerDestino)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(VerDestino   varchar(255)) 
     SELECT  @EstaImpreso = CONVERT(bit,EstaImpreso)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(EstaImpreso   varchar(255)) 
     SELECT  @Personal = NULLIF(Personal,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Personal   varchar(255)) 
     SELECT  @Reabastecido = CONVERT(bit,Reabastecido)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Reabastecido   varchar(255)) 
     SELECT  @Conteo = CONVERT(int,Conteo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Conteo   varchar(255)) 
     SELECT  @Agente = NULLIF(Agente,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Agente   varchar(255)) 
     SELECT  @ACRetencion = CONVERT(float , ACRetencion)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(ACRetencion   varchar(255)) 
     SELECT  @SubModulo = NULLIF(SubModulo,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SubModulo   varchar(255)) 
     SELECT  @SucursalOrigen = CONVERT(int,SucursalOrigen)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SucursalOrigen   varchar(255)) 
     SELECT  @SucursalDestino = CONVERT(int,SucursalDestino)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SucursalDestino   varchar(255)) 
     SELECT  @PedimentoExtraccion = NULLIF(PedimentoExtraccion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(PedimentoExtraccion   varchar(255))
     SELECT  @ReferenciaIntelisisService = NULLIF(ReferenciaIntelisisService,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(ReferenciaIntelisisService   varchar(255))
   END

  IF @Ok IS NULL
  BEGIN 
    SET @Estatus = 'SINAFECTAR' 

    SELECT @Empresa = Empresa , @Sucursal = Sucursal
      FROM MapeoPlantaIntelisisMes
     WHERE Referencia = @ReferenciaIntelisisService

    IF NOT EXISTS(SELECT * FROM Mon WHERE Moneda = @Moneda ) SELECT @Ok = 20196
    IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) SELECT @Ok = 20830
    IF NOT EXISTS(SELECT * FROM Proy WHERE Proyecto = @Proyecto ) AND NULLIF(@Proyecto,'') IS NOT NULL SELECT @Ok = 15010
   IF NOT EXISTS(SELECT * FROM UEN WHERE UEN = @UEN ) AND NULLIF(@UEN,'') IS NOT NULL SELECT @Ok = 10070
    IF NOT EXISTS(SELECT * FROM MovTipo WHERE Mov = @Mov ) SELECT @Ok = 14055
    IF NOT EXISTS(SELECT * FROM Sucursal WHERE Sucursal = @Sucursal )SELECT @Ok = 72060
    IF NOT EXISTS(SELECT * FROM Empresa WHERE Empresa =  @Empresa)SELECT @Ok =26070


  END

  IF @Ok IS NULL
  BEGIN 
    INSERT INTO Inv (Empresa, Mov,   MovID, FechaEmision,   UltimoCambio, Concepto, Proyecto, Actividad,   UEN,   Moneda,   TipoCambio,   Usuario,   Autorizacion,   Referencia, DocFuente, Observaciones, Estatus, Situacion, SituacionFecha, SituacionUsuario,   SituacionNota,   Prioridad, Directo, RenglonID, Almacen,   AlmacenDestino,   AlmacenTransito,   Largo,   FechaRequerida,   Condicion,   Vencimiento, FormaEnvio, OrigenTipo, Origen, OrigenID, Poliza,   PolizaID,   GenerarPoliza, ContID, Ejercicio, Periodo,   FechaRegistro,   FechaConclusion,   FechaCancelacion,   FechaOrigen,   Peso, Volumen, Paquetes, FechaEntrega, EmbarqueEstado,   Sucursal,   Importe,   Logico1, Logico2, Logico3, Logico4, Logico5,   Logico6,   Logico7,   Logico8,   Logico9, VerLote, EspacioResultado,   VerDestino, EstaImpreso,   Personal, Reabastecido,   Conteo, Agente,   ACRetencion, SubModulo,   SucursalOrigen, SucursalDestino,   PedimentoExtraccion)
                     VALUES (   @Empresa, @Mov, @MovID, @FechaEmision, @UltimoCambio, @Concepto, @Proyecto, @Actividad, @UEN, @Moneda, @TipoCambio, @Usuario, @Autorizacion, @Referencia, @DocFuente, @Observaciones, @Estatus, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @Prioridad, @Directo, @RenglonID, @Almacen, @AlmacenDestino, @AlmacenTransito, @Largo, @FechaRequerida, @Condicion, @Vencimiento, @FormaEnvio, @OrigenTipo, @Origen, @OrigenID, @Poliza, @PolizaID, @GenerarPoliza, @ContID, @Ejercicio, @Periodo, @FechaRegistro, @FechaConclusion, @FechaCancelacion, @FechaOrigen, @Peso, @Volumen, @Paquetes, @FechaEntrega, @EmbarqueEstado, @Sucursal, @Importe, @Logico1, @Logico2, @Logico3, @Logico4, @Logico5, @Logico6, @Logico7, @Logico8, @Logico9, @VerLote, @EspacioResultado, @VerDestino, @EstaImpreso, @Personal, @Reabastecido, @Conteo, @Agente, @ACRetencion, @SubModulo, @SucursalOrigen, @SucursalDestino, @PedimentoExtraccion)
    IF @@ERROR <> 0 SET @Ok = 1
    SET @IDGenerar = @@IDENTITY


  END
  SELECT @RenglonSub = 0
  INSERT @Temp (  RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad, Factor, CantidadInventario, UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion)
  SELECT          RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad, Factor, CantidadInventario, UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion
    FROM OPENXML(@iSolicitud, '/Intelisis/Solicitud/Inv/DetalleInv',1) 
    WITH ( RenglonTipo  varchar(100), Cantidad  varchar(100), Almacen  varchar(100), Codigo  varchar(100), Articulo  varchar(100), ArticuloDestino  varchar(100), SubCuenta  varchar(100), SubCuentaDestino  varchar(100), Costo  varchar(100), CostoInv  varchar(100), ContUso  varchar(100), Espacio  varchar(100), CantidadReservada  varchar(100), CantidadCancelada  varchar(100), CantidadOrdenada  varchar(100), CantidadPendiente  varchar(100), CantidadA  varchar(100), Paquete  varchar(100), FechaRequerida  varchar(100), Aplica  varchar(100), AplicaID  varchar(100), DestinoTipo  varchar(100), Destino  varchar(100), DestinoID  varchar(100), Cliente  varchar(100), Unidad  varchar(100), Factor  varchar(100), CantidadInventario  varchar(100), UltimoReservadoCantidad  varchar(100), UltimoReservadoFecha  varchar(100), ProdSerieLote  varchar(100), Merma  varchar(100), Desperdicio  varchar(100), Producto  varchar(100), SubProducto  varchar(100), Tipo  varchar(100), Sucursal  varchar(100), Precio  varchar(100), SegundoConteo  varchar(100), DescripcionExtra  varchar(100), AjusteCosteo  varchar(100), CostoUEPS  varchar(100), CostoPEPS  varchar(100), UltimoCosto  varchar(100), PrecioLista  varchar(100), DepartamentoDetallista  varchar(100), AjustePrecioLista  varchar(100), Posicion  varchar(100), SucursalOrigen  varchar(100), Tarima  varchar(100), Seccion  varchar(100), CostoEstandar  varchar(100), FechaCaducidad  varchar(100), CostoPromedio  varchar(100), CostoReposicion varchar(100))

  BEGIN
    DECLARE crDetalle CURSOR LOCAL FAST_FORWARD FOR
    SELECT  RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad, Factor, CantidadInventario, UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion
    FROM @Temp
    SET @Renglon = 0.0
    SET @RenglonIDD = 0

    OPEN crDetalle
    FETCH NEXT FROM crDetalle INTO  @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, @Sucursal, @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion, @SucursalOrigen, @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion
    WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
    BEGIN
      IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) SELECT @Ok = 20830
      IF @Cantidad < 0 SET @Ok = 20010
      IF @Costo < 0 SET @Ok = 20140

      SET @Renglon = @Renglon + 2048.0
      SET @RenglonIDD = @RenglonIDD + 1
      INSERT InvD (   ID        ,  Renglon,  RenglonSub,  RenglonID,  RenglonTipo,  Cantidad,  Almacen,  Codigo,  Articulo,  ArticuloDestino,  SubCuenta,  SubCuentaDestino,  Costo,  CostoInv,  ContUso,  Espacio,  CantidadReservada,  CantidadCancelada,  CantidadOrdenada,  CantidadPendiente,  CantidadA,  Paquete,  FechaRequerida,  Aplica,  AplicaID,  DestinoTipo,  Destino,  DestinoID,  Cliente,  Unidad,  Factor,  CantidadInventario,  UltimoReservadoCantidad,  UltimoReservadoFecha,  ProdSerieLote,  Merma,  Desperdicio,  Producto,  SubProducto,  Tipo,  Sucursal,  Precio,  SegundoConteo,  DescripcionExtra,  AjusteCosteo,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  DepartamentoDetallista,  AjustePrecioLista,  Posicion,  SucursalOrigen,  Tarima,  Seccion,  CostoEstandar,  FechaCaducidad,  CostoPromedio,  CostoReposicion )
      VALUES         (@IDGenerar, @Renglon, @RenglonSub, @RenglonIDD, @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, @Sucursal, @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion, @SucursalOrigen, @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion )

      IF @@ERROR <> 0 SET @Ok = 1

      FETCH NEXT FROM crDetalle INTO  @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, @Sucursal, @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion, @SucursalOrigen, @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion
    END
    CLOSE crDetalle
    DEALLOCATE crDetalle

  END
  IF @Ok IS NULL
    EXEC spAfectar 'INV', @IDGenerar, 'VERIFICAR', 'Todo', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
  IF @Ok IS NULL OR @Ok = 80000
    SELECT @Ok = NULL
  IF @Ok IS NULL AND @Estatus = 'SINAFECTAR'
    EXEC spAfectar 'INV', @IDGenerar, 'AFECTAR', 'Todo', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion

  IF @Ok IS NULL
  SELECT @ReferenciaIS = Referencia
    FROM IntelisisService
   WHERE ID = @ID

  SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + ' Modulo=INV ModuloID =' + CHAR(34) + ISNULL(CONVERT(varchar,@IDGenerar),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'

  IF @Ok IS NULL
  BEGIN
    COMMIT TRANSACTION
  END ELSE
  BEGIN
    ROLLBACK TRANSACTION
  END
END
GO

/**************** spISIntelisisINVInsertarMovINV_SOL ****************/
if exists (select * from sysobjects where id = object_id('dbo.spISIntelisisINVInsertarMovINV_SOL') and type = 'P') drop procedure dbo.spISIntelisisINVInsertarMovINV_SOL
GO            
CREATE PROCEDURE spISIntelisisINVInsertarMovINV_SOL
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok			int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION

AS BEGIN
  -- SET nocount ON
  DECLARE 
    @IDGenerar				int,
    @IDAcceso				int,	
    @MovTipo				varchar(20),
    @ReferenciaIS			varchar(100),
    @Usuario2				varchar(10),
    @Estacion				int,
    @SubReferencia			varchar(100),
    @Empresa   				varchar(5),
    @Mov   				varchar(20),
    @Mov2   				varchar(20),
    @Mov3    				varchar(20),
    @MovID   				varchar(20),
    @FechaEmision   		        datetime   ,
    @UltimoCambio   		        datetime   ,
    @Concepto   			varchar(50),
    @Proyecto   			varchar(50),
    @Actividad   			varchar(100),
    @UEN   				int   ,
    @Moneda   				varchar(10),
    @TipoCambio 			float   ,
    @Usuario   				varchar(10),
    @Autorizacion   		        varchar(10),
    @Referencia   			varchar(50),
    @DocFuente   			int   ,
    @Observaciones   		        varchar(100),
    @Estatus   				varchar(15),
    @Situacion   			varchar(50),
    @SituacionFecha   		        datetime   ,
    @SituacionUsuario   	        varchar(10),
    @SituacionNota   		        varchar(100),
    @Prioridad   			varchar(10),
    @Directo   				bit   ,
    @RenglonID   			int   ,
    @Almacen   				varchar(10),
    @AlmacenDestino   		        varchar(10),
    @AlmacenTransito   		        varchar(10),
    @Largo   				bit   ,
    @FechaRequerida   		        datetime   ,
    @Condicion   			varchar(50),
    @Vencimiento   			datetime   ,
    @FormaEnvio   			varchar(50),
    @OrigenTipo   			varchar(10),
    @Origen   				varchar(20),
    @OrigenID   			varchar(20),
    @Poliza   				varchar(20),
    @PolizaID   			varchar(20),
    @GenerarPoliza   		        bit   ,
    @ContID   				int   ,
    @Ejercicio   			int   ,
    @Periodo   				int   ,
    @FechaRegistro   		        datetime   ,
    @FechaConclusion   		        datetime   ,
    @FechaCancelacion   	        datetime   ,
    @FechaOrigen   			datetime   ,
    @Peso   				float   ,
    @Volumen   				float   ,
    @Paquetes   			int   ,
    @FechaEntrega   		        datetime   ,
    @EmbarqueEstado   		        varchar(50),
    @Sucursal   			int   ,
    @Sucursal2   			int   ,
    @Importe				money   ,
    @Logico1   				bit   ,
    @Logico2   				bit   ,
    @Logico3   				bit   ,
    @Logico4   				bit   ,
    @Logico5   				bit   ,
    @Logico6   				bit   ,
    @Logico7   				bit   ,
    @Logico8   				bit   ,
    @Logico9   				bit   ,
    @VerLote   				bit   ,
    @EspacioResultado   	        bit   ,
    @VerDestino   			bit   ,
    @EstaImpreso  			bit   ,
    @Personal   			varchar(10),
    @Reabastecido 			bit   ,
    @Conteo   				int   ,
    @Agente   				varchar(10),
    @ACRetencion   			float   ,
    @SubModulo   			varchar(5),
    @SucursalOrigen   		        int   ,
    @SucursalDestino   		        int   ,
    @PedimentoExtraccion   	        varchar(50),
    @MovMES				bit,
-----detalle
    @IDD		   		int   ,
    @Renglon   				float   ,
    @Renglon2   			float   ,
    @RenglonSub   			int   ,
    @RenglonIDD   			int   ,
    @RenglonIDD2   			int   ,
    @RenglonTipo			char(1),
    @Cantidad   			float   ,
    @AlmacenD   			varchar(10),
    @Codigo				varchar(30),
    @Articulo   			varchar(20),
    @ArticuloDestino   		        varchar(20),
    @SubCuenta   			varchar(50),
    @SubCuentaDestino  		        varchar(50),
    @Costo				money   ,
    @CostoInv				money   ,
    @ContUso   				varchar(20),
    @Espacio   				varchar(10),
    @CantidadReservada   	        float   ,
    @CantidadCancelada   	        float   ,
    @CantidadOrdenada   	        float   ,
    @CantidadPendiente   	        float   ,
    @CantidadA   			float   ,
    @Paquete   				int   ,
    @Aplica   				varchar(20),
    @AplicaID   			varchar(20),
    @DestinoTipo   			varchar(10),
    @Destino				varchar(20),
    @DestinoID   			varchar(20),
    @Cliente   				varchar(10),
    @Unidad   				varchar(50),
    @Factor   				float   ,
    @CantidadInventario   	        float   ,
    @UltimoReservadoCantidad            float   ,
    @UltimoReservadoFecha               datetime   ,
    @ProdSerieLote   		        varchar(50),
    @Merma   				float   ,
    @Desperdicio   			float   ,
    @Producto   			varchar(20),
    @SubProducto   			varchar(20),
    @Tipo   				varchar(20),
    @Precio				money   ,
    @SegundoConteo   		        float   ,
    @DescripcionExtra   	        varchar(100),
    @AjusteCosteo			money   ,
    @CostoUEPS				money   ,
    @CostoPEPS				money   ,
    @UltimoCosto			money   ,
    @PrecioLista			money   ,
    @DepartamentoDetallista             int   ,
    @AjustePrecioLista		        money   ,
    @Posicion   			varchar(10),
    @Tarima   				varchar(20),
    @Seccion				smallint   ,
    @CostoEstandar			money   ,
    @FechaCaducidad   		        datetime   ,
    @CostoPromedio			money   ,
    @CostoReposicion		        money  ,
    @Proveedor				varchar(10),
    @ReferenciaIntelisisService         varchar(50),
    @Articulo2				varchar(20),
    @Lote				Varchar(50),
    @Cantidad2				float,
    @UltRenglonID			int,
    @UltRenglonID2			int,
    @Tipo2				varchar(20),
    @ArtTipo				varchar(20),
    @INFORCostoConsumoMat               float,
    @INFORCostoManoObra                 float,
    @INFORCostoIndirecto                float,
    @ReferenciaMES                      varchar(50),
    @PedidoMES                          varchar(20),
    @Planta                             varchar(20),
    @MovO                               varchar(20),
    @NuevoID                            int,
    @Disponible                         float,
    @Ajuste                             int,
    @AjustesAutomaticosMES              bit,
    @IDMES                              int,
    @IDNuevo                            int,
    @MoVIDO                             varchar(20),
    @IDMarcaje                          int,
    @IDSol                              int,
    @FormaCosteo                        varchar(20),
    @TipoCosteo                         varchar(20),
    @Cual                               varchar(20),
    @CostoEstandarArt                   float,
    @WMS                                bit,
    @DefPosicionSurtido                 varchar(10),
    @CfgPosiciones		        bit

  DECLARE @Temp   table (
     RenglonIDD				int ,    
     IDD		   		int   ,
     Renglon   				float   ,
     RenglonSub   			int   ,
     RenglonID   			int   ,
     RenglonTipo			char(1),
     Cantidad   			float   ,
     Almacen   				varchar(10),
     Codigo				varchar(30),
     Articulo   			varchar(20),
     ArticuloDestino   		        varchar(20),
     SubCuenta   			varchar(50),
     SubCuentaDestino  		        varchar(50),
     Costo				money   ,
     CostoInv				money   ,
     ContUso   				varchar(20),
     Espacio   				varchar(10),
     CantidadReservada   	        float   ,
     CantidadCancelada   	        float   ,
     CantidadOrdenada   	        float   ,
     CantidadPendiente   	        float   ,
     CantidadA   			float   ,
     Paquete   				int   ,
     FechaRequerida   		        datetime   ,
     Aplica   				varchar(20),
     AplicaID   			varchar(20),
     DestinoTipo   			varchar(10),
     Destino   				varchar(20),
     DestinoID   			varchar(20),
     Cliente   				varchar(10),
     Unidad   				varchar(50),
     Factor   				float   ,
     CantidadInventario   	        float   ,
     UltimoReservadoCantidad            float   ,
     UltimoReservadoFecha               datetime   ,
     ProdSerieLote   		        varchar(50),
     Merma   				float   ,
     Desperdicio   			float   ,
     Producto   			varchar(20),
     SubProducto   			varchar(20),
     Tipo   				varchar(20),
     Sucursal   			int   ,
     Precio				money   ,
     SegundoConteo   		        float   ,
     DescripcionExtra   	        varchar(100),
     AjusteCosteo			money   ,
     CostoUEPS				money   ,
     CostoPEPS				money   ,
     UltimoCosto			money   ,
     PrecioLista			money   ,
     DepartamentoDetallista             int   ,
     AjustePrecioLista		        money   ,
     Posicion   			varchar(10),
     SucursalOrigen   		        int   ,
     Tarima   				varchar(20),
     Seccion				smallint   ,
     CostoEstandar			money   ,
     FechaCaducidad   		        datetime   ,
     CostoPromedio			money   ,
     CostoReposicion		        money  ,
     INFORCostoConsumoMat               float,
     INFORCostoManoObra                 float,
     INFORCostoIndirecto                float)
         
  DECLARE @Tabla  table (
     Empresa				varchar(5), 
     Modulo				varchar(5), 
     ID					int, 
     RenglonID				int,
     Articulo				varchar(20),
     SubCuenta				varchar(50), 
     SerieLote				varchar(50), 
     Cantidad				float, 
     CantidadAlterna		        float, 
     Propiedades			varchar(20),
     Ubicacion				int, 
     Cliente				varchar(10),
     Localizacion			varchar(10),
     Sucursal				int, 
     ArtCostoInv			money)    
     
  DECLARE @Temp2   table (
     RenglonIDD				int ,    
     IDD		   		int   ,
     Renglon   				float   ,
     RenglonSub   			int   ,
     RenglonID   			int   ,
     RenglonTipo			char(1),
     Cantidad   			float   ,
     Almacen   				varchar(10),
     Codigo				varchar(30),
     Articulo   			varchar(20),
     ArticuloDestino   		        varchar(20),
     SubCuenta   			varchar(50),
     SubCuentaDestino  		        varchar(50),
     Costo				money   ,
     CostoInv				money   ,
     ContUso   				varchar(20),
     Espacio   				varchar(10),
     CantidadReservada   	        float   ,
     CantidadCancelada   	        float   ,
     CantidadOrdenada   	        float   ,
     CantidadPendiente   	        float   ,
     CantidadA   			float   ,
     Paquete   				int   ,
     FechaRequerida   		        datetime   ,
     Aplica   				varchar(20),
     AplicaID   			varchar(20),
     DestinoTipo   			varchar(10),
     Destino   				varchar(20),
     DestinoID   			varchar(20),
     Cliente   				varchar(10),
     Unidad   				varchar(50),
     Factor   				float   ,
     CantidadInventario   	        float   ,
     UltimoReservadoCantidad            float   ,
     UltimoReservadoFecha               datetime   ,
     ProdSerieLote   		        varchar(50),
     Merma   				float   ,
     Desperdicio   			float   ,
     Producto   			varchar(20),
     SubProducto   			varchar(20),
     Tipo   				varchar(20),
     Sucursal   			int   ,
     Precio				money   ,
     SegundoConteo   		        float   ,
     DescripcionExtra   	        varchar(100),
     AjusteCosteo			money   ,
     CostoUEPS				money   ,
     CostoPEPS				money   ,
     UltimoCosto			money   ,
     PrecioLista			money   ,
     DepartamentoDetallista             int   ,
     AjustePrecioLista		        money   ,
     Posicion   			varchar(10),
     SucursalOrigen   		        int   ,
     Tarima   				varchar(20),
     Seccion				smallint   ,
     CostoEstandar			money   ,
     FechaCaducidad   		        datetime   ,
     CostoPromedio			money   ,
     CostoReposicion		        money  ,
     INFORCostoConsumoMat               float,
     INFORCostoManoObra                 float,
     INFORCostoIndirecto                float)
 
  SELECT @IDAcceso = dbo.fnAccesoID(@@SPID), @Estacion = EstacionTrabajo  
    FROM Acceso 
   WHERE ID = @IDAcceso
  
  IF @Ok IS NULL
  BEGIN
    SELECT  @Mov = NULLIF(Mov,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
      WITH  (Mov   varchar(255))  
    IF @@ERROR <> 0 SET @Ok = 1
  END

  IF @Ok IS NULL
    SELECT @Mov2 = Mov FROM MapeoMovimientosInforIntelisis WHERE INFORMov = @Mov
    
  SELECT @MovTipo = Clave
    FROM MovTipo
   WHERE Modulo   = 'INV' AND Mov = @Mov2
       
  IF @MovTipo <> 'INV.SOL' SELECT @Ok = 35005, @OkRef = @Mov

  IF @Ok IS NULL
  BEGIN  
     SELECT  @Mov                           = NULLIF(Dev,'')						FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Dev                             varchar(255))
     IF @Mov IS NULL
     BEGIN
       SELECT @Mov                          = NULLIF(Mov,'')						FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
         WITH (Mov                            varchar(255))
     END
     
     SELECT  @MovID                         = NULLIF(MovID,'')						FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (MovID                           varchar(255))
     SELECT  @FechaEmision                  = dbo.fnFechaSinHora(GETDATE())
     SELECT  @UltimoCambio                  = CONVERT(datetime,UltimoCambio)		FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (UltimoCambio                    varchar(255))
     SELECT  @Concepto                      = NULLIF(Concepto,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Concepto                        varchar(255))
     SELECT  @Proyecto                      = NULLIF(Proyecto,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Proyecto                        varchar(255))
     SELECT  @Actividad                     = NULLIF(Actividad,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Actividad                       varchar(255))
     SELECT  @UEN                           = CONVERT(int,UEN)						FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (UEN                             varchar(255))
     SELECT  @Moneda                        = NULLIF(Moneda,'')						FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Moneda                          varchar(255))
     SELECT  @TipoCambio                    = CONVERT(float , TipoCambio)			FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (TipoCambio                      varchar(255))
     SELECT  @Usuario                       = NULLIF(Usuario,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Usuario                         varchar(255))
     SELECT  @Autorizacion                  = NULLIF(Autorizacion,'')				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Autorizacion                    varchar(255))
     SELECT  @Referencia                    = NULLIF(Referencia,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Referencia                      varchar(255))
     SELECT  @DocFuente                     = CONVERT(int,DocFuente)				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (DocFuente                       varchar(255))
     SELECT  @Observaciones                 = NULLIF(Observaciones,'')				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Observaciones                   varchar(255))
     SELECT  @Estatus                       = NULLIF(Estatus,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Estatus                         varchar(255))
     SELECT  @Situacion                     = NULLIF(Situacion,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Situacion                       varchar(255))
     SELECT  @SituacionFecha                = CONVERT(datetime,SituacionFecha)		FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (SituacionFecha                  varchar(255))
     SELECT  @SituacionUsuario              = NULLIF(SituacionUsuario,'')			FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (SituacionUsuario                varchar(255))
     SELECT  @SituacionNota                 = NULLIF(SituacionNota,'')				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (SituacionNota                   varchar(255))
     SELECT  @Prioridad                     = NULLIF(Prioridad,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Prioridad                       varchar(255))
    SELECT  @Directo                       = CONVERT(bit,Directo)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Directo                         varchar(255))
     SELECT  @RenglonID                     = CONVERT(int,RenglonID)				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (RenglonID                       varchar(255))
     SELECT  @Almacen                       = NULLIF(Almacen,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Almacen                         varchar(255))
     SELECT  @AlmacenDestino                = NULLIF(AlmacenDestino,'')				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (AlmacenDestino                  varchar(255))
     SELECT  @AlmacenTransito               = NULLIF(AlmacenTransito,'')			FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (AlmacenTransito                 varchar(255))
     SELECT  @Largo                         = CONVERT(bit,Largo)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Largo                           varchar(255))
     SELECT  @FechaRequerida                = CONVERT(datetime,FechaRequerida)		FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (FechaRequerida                  varchar(255))
     SELECT  @Condicion                     = NULLIF(Condicion,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Condicion                       varchar(255))
     SELECT  @Vencimiento                   = CONVERT(datetime,Vencimiento)			FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Vencimiento                     varchar(255))
     SELECT  @FormaEnvio                    = NULLIF(FormaEnvio,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (FormaEnvio                      varchar(255))
     SELECT  @OrigenTipo                    = NULLIF(OrigenTipo,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (OrigenTipo                      varchar(255))
     SELECT  @Origen                        = NULLIF(Origen,'')						FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Origen                          varchar(255))
     SELECT  @OrigenID                      = NULLIF(OrigenID,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (OrigenID                        varchar(255))
     SELECT  @Poliza                        = NULLIF(Poliza,'')						FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Poliza                          varchar(255))
     SELECT  @PolizaID                      = NULLIF(PolizaID,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (PolizaID                        varchar(255))
     SELECT  @GenerarPoliza                 = CONVERT(bit,GenerarPoliza)			FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (GenerarPoliza                   varchar(255))
     SELECT  @ContID                        = CONVERT(int,ContID)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (ContID                          varchar(255))
     SELECT  @Ejercicio                     = CONVERT(int,Ejercicio)				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Ejercicio                       varchar(255))
     SELECT  @Periodo                       = CONVERT(int,Periodo)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Periodo                         varchar(255))
     SELECT  @FechaRegistro                 = GETDATE()
     SELECT  @Peso                          = CONVERT(float , Peso)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Peso                            varchar(255))
     SELECT  @Volumen                       = CONVERT(float , Volumen)				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Volumen                         varchar(255))
     SELECT  @Paquetes                      = CONVERT(int,Paquetes)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Paquetes                        varchar(255))
     SELECT  @FechaEntrega                  = CONVERT(datetime,FechaEntrega)		FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (FechaEntrega                    varchar(255))
     SELECT  @EmbarqueEstado                = NULLIF(EmbarqueEstado,'')				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (EmbarqueEstado                  varchar(255))
     SELECT  @Importe                       = CONVERT(money,Importe)				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Importe                         varchar(255))
     SELECT  @Logico1                       = CONVERT(bit,Logico1)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Logico1                         varchar(255))
     SELECT  @Logico2                       = CONVERT(bit,Logico2)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Logico2                         varchar(255))
     SELECT  @Logico3                       = CONVERT(bit,Logico3)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Logico3                         varchar(255))
     SELECT  @Logico4                       = CONVERT(bit,Logico4)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Logico4                         varchar(255))
     SELECT  @Logico5                       = CONVERT(bit,Logico5)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Logico5                         varchar(255))
     SELECT  @Logico6                       = CONVERT(bit,Logico6)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Logico6                         varchar(255))
     SELECT  @Logico7                       = CONVERT(bit,Logico7)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Logico7                         varchar(255))
     SELECT  @Logico8                       = CONVERT(bit,Logico8)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Logico8                         varchar(255))
     SELECT  @Logico9                       = CONVERT(bit,Logico9)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Logico9                         varchar(255))
     SELECT  @VerLote                       = CONVERT(bit,VerLote)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (VerLote                         varchar(255))
     SELECT  @EspacioResultado              = CONVERT(bit,EspacioResultado)			FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (EspacioResultado                varchar(255))
     SELECT  @VerDestino                    = CONVERT(bit,VerDestino)				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (VerDestino                      varchar(255))
     SELECT  @EstaImpreso                   = CONVERT(bit,EstaImpreso)				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (EstaImpreso                     varchar(255))
     SELECT  @Personal                      = NULLIF(Personal,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Personal                        varchar(255))
     SELECT  @Reabastecido                  = CONVERT(bit,Reabastecido)				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Reabastecido                    varchar(255))
     SELECT  @Conteo                        = CONVERT(int,Conteo)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Conteo                          varchar(255))
     SELECT  @Agente                        = NULLIF(Agente,'')						FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (Agente                          varchar(255))
     SELECT  @ACRetencion                   = CONVERT(float , ACRetencion)			FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (ACRetencion                     varchar(255))
     SELECT  @SubModulo                     = NULLIF(SubModulo,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (SubModulo                       varchar(255))
     SELECT  @SucursalOrigen                = CONVERT(int,SucursalOrigen)			FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (SucursalOrigen                  varchar(255))
     SELECT  @SucursalDestino               = CONVERT(int,SucursalDestino)			FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (SucursalDestino                 varchar(255))
     SELECT  @PedimentoExtraccion           = NULLIF(PedimentoExtraccion,'')		FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (PedimentoExtraccion             varchar(255))
     SELECT  @ReferenciaIntelisisService	= NULLIF(ReferenciaIntelisisService,'')	FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
      WITH  (ReferenciaIntelisisService       varchar(255))
     SELECT  @MovMES                        = CONVERT(bit,MovMES)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (MovMES                          varchar(255))
     SELECT  @ReferenciaMES                 = NULLIF(ReferenciaMES,'')				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (ReferenciaMES                   varchar(255))
     SELECT  @PedidoMES                     = NULLIF(PedidoMES ,'')					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (PedidoMES                       varchar(255))
     SELECT  @IDMES                         = CONVERT(int,IDMES)					FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (IDMES                           varchar(255))
     SELECT  @IDMarcaje                     = CONVERT(int,IDMarcaje)				FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv') 
       WITH  (IDMarcaje                       varchar(255)) 
   END
 
  IF @Ok IS NULL
  BEGIN  
    SET @Estatus = 'BORRADOR'  

   
 
    SELECT @Empresa = Empresa ,@Sucursal = Sucursal, @SucursalOrigen = Sucursal
      FROM MapeoPlantaIntelisisMes 
     WHERE Referencia = @ReferenciaIntelisisService
    SELECT @Sucursal2 = @Sucursal 
    --SELECT @Sucursal2 = Sucursal, @SucursalOrigen = Sucursal
    --  FROM PlantaProductiva WHERE Clave =@Planta  
    --SELECT @Sucursal = Sucursal FROM Alm WHERE Almacen = @Almacen 
    
    SELECT @WMS = ISNULL(WMS,0)
      FROM EmpresaGral
     WHERE Empresa = @Empresa 
    
    SELECT @FormaCosteo = FormaCosteo, @TipoCosteo = TipoCosteo, @CfgPosiciones = ISNULL(Posiciones, 0) FROM EmpresaCfg WHERE Empresa = @Empresa
     
    IF NOT EXISTS(SELECT * FROM Mon WHERE Moneda = @Moneda ) SELECT @Ok = 20196
    IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) SELECT @Ok = 20830
    IF NOT EXISTS(SELECT * FROM Proy WHERE Proyecto = @Proyecto ) AND NULLIF(@Proyecto,'') IS NOT NULL SELECT @Ok = 15010
    IF NOT EXISTS(SELECT * FROM UEN WHERE UEN = @UEN ) AND NULLIF(@UEN,'') IS NOT NULL SELECT @Ok = 10070
    IF NOT EXISTS(SELECT * FROM MovTipo WHERE Mov = @Mov2 ) SELECT @Ok = 14055
    IF NOT EXISTS(SELECT * FROM Sucursal WHERE Sucursal = @Sucursal )SELECT @Ok = 72060
    IF NOT EXISTS(SELECT * FROM Empresa WHERE Empresa =  @Empresa)SELECT @Ok =26070 

  END
  
  IF @Ok IS NULL 
  BEGIN  
    IF @Almacen NOT IN(SELECT Almacen FROM Alm WHERE Sucursal = @Sucursal)
      SELECT @Almacen = AlmacenPrincipal FROM Sucursal WHERE Sucursal = @Sucursal
    SELECT @OrigenTipo ='I:MES'
    
    IF @WMS = 1 
    BEGIN 
      IF EXISTS(SELECT * FROM Alm WHERE ISNULL(WMS,0) = 1 AND NULLIF(DefPosicionSurtido,'') IS NOT NULL AND Almacen = @Almacen)
        SELECT @DefPosicionSurtido = DefPosicionSurtido FROM Alm WHERE ISNULL(WMS,0) = 1 AND NULLIF(DefPosicionSurtido,'') IS NOT NULL AND Almacen = @Almacen
    END
    
    INSERT INTO Inv (Empresa,  Mov,   MovID, FechaEmision,   UltimoCambio,  Concepto,  Proyecto,  Actividad,  UEN,  Moneda,  TipoCambio,  Usuario,  Autorizacion,  Referencia,  DocFuente,  Observaciones,  Estatus,  Situacion,  SituacionFecha,  SituacionUsuario,  SituacionNota,  Prioridad,  Directo,  RenglonID,  Almacen,   AlmacenDestino, AlmacenTransito,  Largo,  FechaRequerida,  Condicion,  Vencimiento,  FormaEnvio,  OrigenTipo,  Origen,  OrigenID,  Poliza,  PolizaID,  GenerarPoliza,  ContID,  Ejercicio,  Periodo,  FechaRegistro,  FechaConclusion,  FechaCancelacion,  FechaOrigen,  Peso,  Volumen,  Paquetes,  FechaEntrega,  EmbarqueEstado,  Sucursal,                     Importe,  Logico1,  Logico2,  Logico3,  Logico4,  Logico5,  Logico6,  Logico7,  Logico8,  Logico9,  VerLote,  EspacioResultado,  VerDestino,  EstaImpreso,  Personal,  Reabastecido,  Conteo,  Agente,  ACRetencion,  SubModulo,  SucursalOrigen,  SucursalDestino,  PedimentoExtraccion,  MovMES,  ReferenciaMES,  PedidoMES ,   IDMES  , IDMarcaje,  PosicionWMS)
	     SELECT  @Empresa, @Mov2, @MovID, @FechaEmision, @UltimoCambio, @Concepto, @Proyecto, @Actividad, @UEN, @Moneda, @TipoCambio, @Usuario, @Autorizacion, @Referencia, @DocFuente, @Observaciones, @Estatus, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @Prioridad, @Directo, @RenglonID, @Almacen, @AlmacenDestino, @AlmacenTransito, @Largo, @FechaRequerida, @Condicion, @Vencimiento, @FormaEnvio, @OrigenTipo, @Origen, @OrigenID, @Poliza, @PolizaID, @GenerarPoliza, @ContID, @Ejercicio, @Periodo, @FechaRegistro, @FechaConclusion, @FechaCancelacion, @FechaOrigen, @Peso, @Volumen, @Paquetes, @FechaEntrega, @EmbarqueEstado, ISNULL(@Sucursal,@Sucursal2), @Importe, @Logico1, @Logico2, @Logico3, @Logico4, @Logico5, @Logico6, @Logico7, @Logico8, @Logico9, @VerLote, @EspacioResultado, @VerDestino, @EstaImpreso, @Personal, @Reabastecido, @Conteo, @Agente, @ACRetencion, @SubModulo, @SucursalOrigen, @SucursalDestino, @PedimentoExtraccion, @MovMES, @ReferenciaMES, @PedidoMES  , @IDMES , @IDMarcaje, @DefPosicionSurtido
    IF @@ERROR <> 0 SET @Ok = 1
    SET @IDGenerar = @@IDENTITY

  END

  SELECT @RenglonSub = 0
  INSERT @Temp2 (  RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario, UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion  )
  SELECT          RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, DescripcionUnidad, Factor, ISNULL(CantidadInventario, Cantidad), UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion
    FROM OPENXML(@iSolicitud, '/Intelisis/Solicitud/Inv/DetalleInv',1)  
    WITH (RenglonSub  varchar(100), RenglonID  varchar(100), RenglonTipo  varchar(100), Cantidad  varchar(100), Almacen  varchar(100), Codigo  varchar(100), Articulo  varchar(100), ArticuloDestino  varchar(100), SubCuenta  varchar(100), SubCuentaDestino  varchar(100), Costo  varchar(100), CostoInv  varchar(100), ContUso  varchar(100), Espacio  varchar(100), CantidadReservada  varchar(100), CantidadCancelada  varchar(100), CantidadOrdenada  varchar(100), CantidadPendiente  varchar(100), CantidadA  varchar(100), Paquete  varchar(100), FechaRequerida  varchar(100), Aplica  varchar(100), AplicaID  varchar(100), DestinoTipo  varchar(100), Destino  varchar(100), DestinoID  varchar(100), Cliente  varchar(100), Unidad  varchar(100), Factor  varchar(100), CantidadInventario  varchar(100), UltimoReservadoCantidad  varchar(100), UltimoReservadoFecha  varchar(100), ProdSerieLote  varchar(100), Merma  varchar(100), Desperdicio  varchar(100), Producto  varchar(100), SubProducto  varchar(100), Tipo  varchar(100), Sucursal  varchar(100), Precio  varchar(100), SegundoConteo  varchar(100), DescripcionExtra  varchar(100), AjusteCosteo  varchar(100), CostoUEPS  varchar(100), CostoPEPS  varchar(100), UltimoCosto  varchar(100), PrecioLista  varchar(100), DepartamentoDetallista  varchar(100), AjustePrecioLista  varchar(100), Posicion  varchar(100), SucursalOrigen  varchar(100), Tarima  varchar(100), Seccion  varchar(100), CostoEstandar  varchar(100), FechaCaducidad  varchar(100), CostoPromedio  varchar(100), CostoReposicion varchar(100),ES varchar(100),PR varchar(100),UC varchar(100),MO varchar(100),CI varchar(100),CM varchar(100),MA varchar(100),ReferenciaMES varchar(100),PedidoMES varchar(100),IDMarcaje  varchar(100), DescripcionUnidad varchar(100))
  INSERT @Temp (  RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario, UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion  )
  SELECT RenglonTipo, SUM(Cantidad), Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario, UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion 
    FROM @Temp2
 GROUP BY RenglonTipo, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario, UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion    
  
  
  INSERT @Tabla (Articulo, SerieLote, Cantidad ,SubCuenta )
  SELECT         Articulo, Lote, Cantidad  ,SubCuenta 
    FROM OPENXML(@iSolicitud, '/Intelisis/Solicitud/Inv/SerieLoteMov',1)  
    WITH (Articulo  varchar(100), Lote  varchar(100), Cantidad  varchar(100),SubCuenta varchar(100) )
  SET @RenglonIDD =0
  UPDATE @Temp 
     SET @RenglonIDD = RenglonID = @RenglonIDD + 1
    FROM @Temp 
  SET @RenglonIDD =0
  UPDATE @Tabla 
     SET @RenglonIDD = RenglonID = @RenglonIDD + 1
    FROM @Tabla 
  BEGIN    
    DECLARE crDetalle CURSOR LOCAL FAST_FORWARD FOR
    SELECT  RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad, Factor, Cantidad*dbo.fnArtUnidadFactor(@Empresa, Articulo, Unidad), UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion,  Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion,RenglonID
      FROM @Temp
    SET @Renglon = 0.0
    SET @RenglonIDD = 0

    OPEN crDetalle
    FETCH NEXT FROM crDetalle INTO   @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion,  @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion, @RenglonID
    WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL 
    BEGIN
      IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) SELECT @Ok = 20830
      IF @Cantidad < 0 SET @Ok = 20010
      IF @Costo < 0 SET @Ok = 20140
      IF @AlmacenD NOT IN(SELECT Almacen FROM Alm WHERE Sucursal = @Sucursal) AND @Ok IS NULL
        SELECT @AlmacenD = AlmacenPrincipal FROM Sucursal WHERE Sucursal = @Sucursal
      SELECT @ArtTipo = Tipo, @CostoEstandarArt = CostoEstandar FROM Art WHERE Articulo = @Articulo
      IF @CfgPosiciones = 1
        SELECT @Posicion = DefPosicionSurtido FROM Alm WHERE ISNULL(Ubicaciones,0) = 1 AND NULLIF(DefPosicionSurtido,'') IS NOT NULL AND Almacen = @AlmacenD      
      EXEC spRenglonTipo @ArtTipo, @Subcuenta, @RenglonTipo OUTPUT

      SET @Renglon = @Renglon + 2048.0
     -- SET @RenglonIDD = @RenglonIDD + 1

      IF @FormaCosteo = 'Articulo'
        SELECT @Cual = TipoCosteo FROM Art WHERE Articulo = @Articulo
      ELSE
        SELECT @Cual = @TipoCosteo


      IF UPPER(@Cual) <> 'ESTANDAR'        
        EXEC spVerCosto @Sucursal, @Empresa, NULL, @Articulo, @SubCuenta, @Unidad, @Cual, @Moneda, @TipoCambio, @Costo OUTPUT, @ConReturn = 0
      ELSE
      BEGIN
        SELECT @Costo = @CostoEstandar

        IF @Costo IS NULL
          EXEC spVerCosto @Sucursal, @Empresa, NULL, @Articulo, @SubCuenta, @Unidad, @Cual, @Moneda, @TipoCambio, @Costo OUTPUT, @ConReturn = 0
      END   
      IF NULLIF(@Costo,0.0) IS NULL
        SELECT @Costo = @CostoEstandarArt

      INSERT InvD (   ID        ,  Renglon,RenglonID,  RenglonSub,  RenglonTipo,  Cantidad,  Almacen,  Codigo,  Articulo,  ArticuloDestino,  SubCuenta,  SubCuentaDestino,  Costo,  CostoInv,  ContUso,  Espacio,  CantidadReservada,  CantidadCancelada,  CantidadOrdenada,  CantidadPendiente,  CantidadA,  Paquete,  FechaRequerida,  Aplica,  AplicaID,  DestinoTipo,  Destino,  DestinoID,  Cliente,  Unidad,  Factor,  CantidadInventario,  UltimoReservadoCantidad,  UltimoReservadoFecha,  ProdSerieLote,  Merma,  Desperdicio,  Producto,  SubProducto,  Tipo,  Sucursal,  Precio,  SegundoConteo,  DescripcionExtra,  AjusteCosteo,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  DepartamentoDetallista,  AjustePrecioLista,  Posicion,  SucursalOrigen,  Tarima,  Seccion,  CostoEstandar,  FechaCaducidad,  CostoPromedio,  CostoReposicion   )
      VALUES         (@IDGenerar, @Renglon,@RenglonID, @RenglonSub,  @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, ISNULL(@Sucursal,@Sucursal2), @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion, @SucursalOrigen, @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion   )
      IF @@ERROR <> 0 SET @Ok = 1

      FETCH NEXT FROM crDetalle INTO  @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion,  @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion, @RenglonID
    END
    CLOSE crDetalle
    DEALLOCATE crDetalle

  END
    IF @Ok IS NULL
    BEGIN
    DECLARE crDetalle2 CURSOR LOCAL FAST_FORWARD FOR
     SELECT a.Articulo,a.SerieLote,a.Cantidad,a.SubCuenta,a.RenglonID
       FROM @Tabla a JOIN Art b ON a.Articulo = b.Articulo
      WHERE b.Tipo  IN ('Lote','Serie')
    OPEN crDetalle2
    FETCH NEXT FROM crDetalle2 INTO  @Articulo2,@Lote,@Cantidad2,@SubCuenta,@UltRenglonID
    WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
    BEGIN

      --SELECT @Lote = NULLIF(@Lote,'(none)')
      SELECT @Tipo2 = Tipo FROM Art WHERE Articulo = @Articulo2



      SELECT @UltRenglonID = ISNULL(MAX(RenglonID), 0) FROM InvD WHERE ID = @IDGenerar AND Articulo=@Articulo2 AND Cantidad = @Cantidad2 AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')

      IF @Lote IS NOT NULL  AND @Tipo2  IN ('Lote','Serie')
      BEGIN

        INSERT SerieLoteMov (Empresa,  Modulo, ID,          RenglonID,     Articulo, Cantidad,        SubCuenta,     SerieLote, Sucursal)
        SELECT               @Empresa, 'INV',  @IDGenerar, @UltRenglonID, @Articulo2,@Cantidad2, ISNULL(@SubCuenta,''), @Lote,   ISNULL(@Sucursal,@Sucursal2)
        IF @@ERROR <> 0 SET @Ok = 1
      END 

      FETCH NEXT FROM crDetalle2 INTO  @Articulo2,@Lote,@Cantidad2,@SubCuenta,@UltRenglonID
    END
    CLOSE crDetalle2
    DEALLOCATE crDetalle2

  END 

  BEGIN TRANSACTION
  IF @Ok IS NULL
    EXEC spAfectar 'INV', @IDGenerar, 'VERIFICAR', 'Todo', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
  IF @Ok IS NULL OR @Ok = 80000
    SELECT @Ok = NULL

  IF @Ok IS NULL AND @Estatus = 'BORRADOR' AND @IDGenerar IS NOT NULL
    EXEC spAfectar 'INV', @IDGenerar, 'AFECTAR', 'Todo', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion


  IF @Ok IS NULL
  BEGIN
    COMMIT TRANSACTION
  END ELSE
  BEGIN
    ROLLBACK TRANSACTION
  END
  IF @Ok IS NULL
  BEGIN
    SELECT @ReferenciaIS = Referencia
      FROM IntelisisService
     WHERE ID = @ID
  END 
  SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + ' Modulo="INV" ModuloID =' + CHAR(34) + ISNULL(CONVERT(varchar,@IDGenerar),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'

END
GO

/**************** spISIntelisisINVInsertarMovINV_S ****************/
if exists (select * from sysobjects where id = object_id('dbo.spISIntelisisINVInsertarMovINV_S') and type = 'P') drop procedure dbo.spISIntelisisINVInsertarMovINV_S
GO           
CREATE PROCEDURE spISIntelisisINVInsertarMovINV_S
            @ID               int,
            @iSolicitud       int,
            @Version          float,
            @Resultado        varchar(max) = NULL OUTPUT,
            @Ok               int = NULL OUTPUT,  
            @OkRef                  varchar(255) = NULL OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @IDGenerar                     int,
    @IDGenerar2                    int,
    @IDAjuste                      int,
    @IDAcceso                      int,
    @MovTipo                       varchar(20),
    @ReferenciaIS            varchar(100),
    @Usuario2                      varchar(10),
    @Estacion                      int,
    @SubReferencia                 varchar(100),
    @Empresa                       varchar(5),
    @Mov                     varchar(20),
    @Mov2                          varchar(20),
    @Mov3                          varchar(20),
    @MovID                         varchar(20),
    @FechaEmision                  datetime   ,
    @UltimoCambio                  datetime   ,
    @Concepto                varchar(50),
    @Proyecto                varchar(50),
    @Actividad               varchar(100),
    @UEN                     int   ,
    @Moneda                        varchar(10),
    @TipoCambio                     float   ,
    @Usuario                       varchar(10),
    @Autorizacion                  varchar(10),
    @Referencia                    varchar(50),
    @DocFuente               int   ,
    @Observaciones                 varchar(100),
    @Estatus                       varchar(15),
    @Situacion               varchar(50),
    @SituacionFecha                datetime   ,
    @SituacionUsuario              varchar(10),
    @SituacionNota                 varchar(100),
    @Prioridad               varchar(10),
    @Directo                       bit   ,
    @RenglonID               int   ,
    @Almacen                       varchar(10),
    @AlmacenDestino                varchar(10),
    @AlmacenTransito                 varchar(10),
    @Largo                         bit   ,
    @FechaRequerida                datetime   ,
    @Condicion               varchar(50),
    @Vencimiento                   datetime   ,
    @FormaEnvio                    varchar(50),
    @OrigenTipo                    varchar(10),
    @Origen                        varchar(20),
    @OrigenID                varchar(20),
    @Poliza                        varchar(20),
    @PolizaID                varchar(20),
    @GenerarPoliza                 bit   ,
    @ContID                        int   ,
    @Ejercicio               int   ,
    @Periodo                       int   ,
    @FechaRegistro                 datetime   ,
    @FechaConclusion                 datetime   ,
    @FechaCancelacion              datetime   ,
    @FechaOrigen                   datetime   ,
    @Peso                          float   ,
    @Volumen                       float   ,
    @Paquetes                int   ,
    @FechaEntrega                  datetime   ,
    @EmbarqueEstado                varchar(50),
    @Sucursal                int   ,
    @Sucursal2               int   ,
    @Importe                       money   ,
    @Logico1                       bit   ,
    @Logico2                       bit   ,
    @Logico3                       bit   ,
    @Logico4                       bit   ,
    @Logico5                       bit   ,
    @Logico6                       bit   ,
    @Logico7                       bit   ,
    @Logico8                       bit   ,
    @Logico9                       bit   ,
    @VerLote                       bit   ,
    @EspacioResultado              bit   ,
    @VerDestino                    bit   ,
    @EstaImpreso                   bit   ,
    @Personal                varchar(10),
    @Reabastecido                  bit   ,
    @Conteo                        int   ,
    @Agente                        varchar(10),
    @ACRetencion                   float   ,
    @SubModulo               varchar(5),
    @SucursalOrigen                int   ,
    @SucursalDestino                 int   ,
    @PedimentoExtraccion             varchar(50),
    @MovMES                  bit,
-----detalle
    @IDD                      int   ,
    @Renglon                       float   ,
    @Renglon2                float   ,
    @RenglonSub                    int   ,
    @RenglonIDD                    int   ,
    @RenglonIDD2                   int   ,
    @RenglonTipo             char(1),
    @Cantidad                float   ,
    @AlmacenD                varchar(10),
    @Codigo                  varchar(30),
    @Articulo                varchar(20),
    @ArticuloDestino                 varchar(20),
    @SubCuenta               varchar(50),
    @SubCuentaDestino                varchar(50),
    @Costo                   money   ,
    @CostoInv                      money   ,
    @ContUso                       varchar(20),
    @Espacio                       varchar(10),
    @CantidadReservada             float   ,
    @CantidadCancelada             float   ,
    @CantidadOrdenada              float   ,
    @CantidadPendiente             float   ,
    @CantidadA               float   ,
    @Paquete                       int   ,
    @Aplica                        varchar(20),
    @AplicaID                varchar(20),
    @DestinoTipo                   varchar(10),
    @Destino                       varchar(20),
    @DestinoID               varchar(20),
    @Cliente                       varchar(10),
    @Unidad                        varchar(50),
    @Factor                        float   ,
    @CantidadInventario            float   ,
    @UltimoReservadoCantidad         float   ,
    @UltimoReservadoFecha           datetime   ,
    @ProdSerieLote                 varchar(50),
    @Merma                         float   ,
    @Desperdicio                   float   ,
    @Producto                varchar(20),
    @SubProducto                   varchar(20),
    @Tipo                          varchar(20),
    @Precio                  money   ,
    @SegundoConteo                 float   ,
    @DescripcionExtra              varchar(100),
    @AjusteCosteo            money   ,
    @CostoUEPS                     money   ,
    @CostoPEPS                     money   ,
    @UltimoCosto             money   ,
    @PrecioLista             money   ,
    @DepartamentoDetallista                int   ,
    @AjustePrecioLista             money   ,
    @Posicion                varchar(10),
    @Tarima                        varchar(20),
    @Seccion                       smallint   ,
    @CostoEstandar                 money   ,
    @FechaCaducidad                datetime   ,
    @CostoPromedio                 money   ,
    @CostoReposicion               money  ,
    @Proveedor                     varchar(10),
    @ReferenciaIntelisisService         varchar(50),
    @Articulo2                     varchar(20),
    @Lote                    varchar(50),
    @Cantidad2                     float,
    @UltRenglonID            int,
    @UltRenglonID2                 int,
    @Tipo2                   varchar(20),
    @ArtTipo                       varchar(20),
    @INFORCostoConsumoMat               float,
    @INFORCostoManoObra                 float,
    @INFORCostoIndirecto                float,
    @ReferenciaMES                      varchar(50),
    @PedidoMES                          varchar(20),
    @Planta                             varchar(20),
    @MovO                               varchar(20),
    @NuevoID                            int,
    @Disponible                         float,
    @Ajuste                             int,
    @AjustesAutomaticosMES              bit,
    @IDMES                              int,
    @IDNuevo                            int,
    @MoVIDO                             varchar(20),
    @IDMarcaje                          int,
    @IDSol                              int,
    @FormaCosteo                        varchar(20),
    @TipoCosteo                         varchar(20),
    @Cual                               varchar(20),
    @ArticuloSol                        varchar(20),  
    @CantAfectar                        float,
    @CantidadSol                        float ,
    @ToleranciaAjuste                   float,
    @RedondeoMonetarios					int,
    @SerieLote							varchar(50),
    @SerieLoteD							varchar(50)

  DECLARE @Temp2             table
         (
     IDR int IDENTITY,
     RenglonIDD                 int ,  
     IDD                int   ,
     Renglon                 float   ,
     RenglonSub              int   ,
     RenglonID          int   ,
     RenglonTipo        char(1),
     Cantidad           float   ,
     Almacen                 varchar(10),
     Codigo             varchar(30),
     Articulo           varchar(20),
     ArticuloDestino         varchar(20),
     SubCuenta          varchar(50),
     SubCuentaDestino        varchar(50),
     Costo              money   ,
     CostoInv                money   ,
     ContUso                 varchar(20),
     Espacio                 varchar(10),
     CantidadReservada       float   ,
     CantidadCancelada       float   ,
     CantidadOrdenada        float   ,
     CantidadPendiente       float   ,
     CantidadA          float   ,
     Paquete                 int   ,
     FechaRequerida          datetime   ,
     Aplica                  varchar(20),
     AplicaID           varchar(20),
     DestinoTipo             varchar(10),
     Destino                 varchar(20),
     DestinoID          varchar(20),
     Cliente                 varchar(10),
     Unidad                  varchar(50),
     Factor                  float   ,
     CantidadInventario      float   ,
     UltimoReservadoCantidad float   ,
     UltimoReservadoFecha   datetime   ,
     ProdSerieLote           varchar(50),
     Merma                   float   ,
     Desperdicio             float   ,
     Producto           varchar(20),
     SubProducto             varchar(20),
     Tipo                    varchar(20),
     Sucursal           int   ,
     Precio             money   ,
     SegundoConteo           float   ,
     DescripcionExtra        varchar(100),
     AjusteCosteo       money   ,
     CostoUEPS               money   ,
     CostoPEPS               money   ,
     UltimoCosto        money   ,
     PrecioLista        money   ,
     DepartamentoDetallista        int   ,
     AjustePrecioLista       money   ,
     Posicion           varchar(10),
     SucursalOrigen          int   ,
     Tarima                  varchar(20),
     Seccion                 smallint   ,
     CostoEstandar           money   ,
     FechaCaducidad          datetime   ,
     CostoPromedio           money   ,
     CostoReposicion         money  ,
     INFORCostoConsumoMat       float,
     INFORCostoManoObra         float,
     INFORCostoIndirecto        float
      
         )             
                                              
  DECLARE @Temp             table
         (
     IDR int IDENTITY,
     RenglonIDD                 int ,  
     IDD                int   ,
     Renglon                 float   ,
     RenglonSub              int   ,
     RenglonID          int   ,
     RenglonTipo        char(1),
     Cantidad           float   ,
     Almacen                 varchar(10),
     Codigo             varchar(30),
     Articulo           varchar(20),
     ArticuloDestino         varchar(20),
     SubCuenta          varchar(50),
     SubCuentaDestino        varchar(50),
     Costo              money   ,
     CostoInv                money   ,
     ContUso                 varchar(20),
     Espacio                 varchar(10),
     CantidadReservada       float   ,
     CantidadCancelada       float   ,
     CantidadOrdenada        float   ,
     CantidadPendiente       float   ,
     CantidadA          float   ,
     Paquete                 int   ,
     FechaRequerida          datetime   ,
     Aplica                  varchar(20),
     AplicaID           varchar(20),
     DestinoTipo             varchar(10),
     Destino                 varchar(20),
     DestinoID          varchar(20),
     Cliente                 varchar(10),
    Unidad                  varchar(50),
     Factor                  float   ,
     CantidadInventario      float   ,
     UltimoReservadoCantidad float   ,
     UltimoReservadoFecha   datetime   ,
     ProdSerieLote           varchar(50),
     Merma                   float   ,
     Desperdicio             float   ,
     Producto           varchar(20),
     SubProducto             varchar(20),
     Tipo                    varchar(20),
     Sucursal           int   ,
     Precio             money   ,
     SegundoConteo           float   ,
     DescripcionExtra        varchar(100),
     AjusteCosteo       money   ,
     CostoUEPS               money   ,
     CostoPEPS               money   ,
     UltimoCosto        money   ,
     PrecioLista        money   ,
     DepartamentoDetallista        int   ,
     AjustePrecioLista       money   ,
     Posicion           varchar(10),
     SucursalOrigen          int   ,
     Tarima                  varchar(20),
     Seccion                 smallint   ,
     CostoEstandar           money   ,
     FechaCaducidad          datetime   ,
     CostoPromedio           money   ,
     CostoReposicion         money  ,
     INFORCostoConsumoMat       float,
     INFORCostoManoObra         float,
     INFORCostoIndirecto        float,
     SerieLote				varchar(50) NULL
         )
       
     DECLARE @Tabla table (
     IDR int IDENTITY,
     Empresa            varchar(5),
     Modulo       varchar(5),
     ID                 int,
     RenglonID          int,
     Articulo           varchar(20),
     SubCuenta          varchar(50),
     SerieLote          varchar(50),
     Cantidad           float,
     CantidadAlterna    float,
     Propiedades  varchar(20),
     Ubicacion          int,
     Cliente            varchar(10),
     Localizacion varchar(10),
     Sucursal           int,
     ArtCostoInv  money)  
     
   DECLARE
   @Tabla2 table (
	   IDR int IDENTITY,
       Articulo    varchar(20),
       SubCuenta   varchar(50),
       Almacen     varchar(10),
       Serielote   varchar(50),
       Renglon     float,
       RenglonID   int ,
       Costo       float,
       Cantidad    float,
       Unidad      varchar(10)
       )
 
  
  SELECT @IDAcceso = dbo.fnAccesoID(@@SPID)
  SELECT @Estacion = EstacionTrabajo  FROM Acceso WHERE ID = @IDAcceso
  IF @Ok IS NULL
  BEGIN
    SELECT @Mov =  NULLIF(Mov,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
      WITH (Mov varchar(255))
    IF @@ERROR <> 0 SET @Ok = 1
  END
  IF @Ok IS NULL
    SELECT @Mov2 = Mov FROM MapeoMovimientosInforIntelisis WHERE INFORMov = @Mov
    SELECT @MovTipo = Clave
        FROM MovTipo
     WHERE Modulo = 'INV' AND Mov = @Mov2
  --IF @MovTipo <> 'INV.S' SELECT @Ok = 35005, @OkRef = @Mov
  IF @Ok IS NULL
  BEGIN
 
     SELECT  @Mov = NULLIF(Mov,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Mov   varchar(255))
     SELECT  @MovID = NULLIF(MovID,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(MovID   varchar(255))
     SELECT  @FechaEmision = dbo.fnFechaSinHora(GETDATE())
     SELECT  @UltimoCambio = CONVERT(datetime,UltimoCambio)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(UltimoCambio   varchar(255))
     SELECT  @Concepto = NULLIF(Concepto,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Concepto   varchar(255))
     SELECT  @Proyecto = NULLIF(Proyecto,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Proyecto   varchar(255))
     SELECT  @Actividad = NULLIF(Actividad,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Actividad   varchar(255))
     SELECT  @UEN = CONVERT(int,UEN)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(UEN   varchar(255))
     SELECT  @Moneda = NULLIF(Moneda,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Moneda   varchar(255))
     SELECT  @TipoCambio = CONVERT(float , TipoCambio)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(TipoCambio   varchar(255))
     SELECT  @Usuario = NULLIF(Usuario,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Usuario   varchar(255))
     SELECT  @Autorizacion = NULLIF(Autorizacion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Autorizacion   varchar(255))
     SELECT  @Referencia = NULLIF(Referencia,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Referencia   varchar(255))
     SELECT  @DocFuente = CONVERT(int,DocFuente)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(DocFuente   varchar(255))
     SELECT  @Observaciones = NULLIF(Observaciones,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Observaciones   varchar(255))
     SELECT  @Estatus = NULLIF(Estatus,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Estatus   varchar(255))
     SELECT  @Situacion = NULLIF(Situacion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Situacion   varchar(255))
     SELECT  @SituacionFecha = CONVERT(datetime,SituacionFecha)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SituacionFecha   varchar(255))
     SELECT  @SituacionUsuario = NULLIF(SituacionUsuario,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SituacionUsuario   varchar(255))
     SELECT  @SituacionNota = NULLIF(SituacionNota,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SituacionNota   varchar(255))
     SELECT  @Prioridad = NULLIF(Prioridad,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Prioridad   varchar(255))
     SELECT  @Directo = CONVERT(bit,Directo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Directo   varchar(255))
     SELECT  @RenglonID = CONVERT(int,RenglonID)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(RenglonID   varchar(255))
     SELECT  @Almacen = NULLIF(Almacen,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Almacen   varchar(255))
     SELECT  @AlmacenDestino = NULLIF(AlmacenDestino,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(AlmacenDestino   varchar(255))
     SELECT  @AlmacenTransito = NULLIF(AlmacenTransito,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(AlmacenTransito   varchar(255))
     SELECT  @Largo = CONVERT(bit,Largo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Largo   varchar(255))
     SELECT  @FechaRequerida = CONVERT(datetime,FechaRequerida)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FechaRequerida   varchar(255))
     SELECT  @Condicion = NULLIF(Condicion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Condicion   varchar(255))
     SELECT  @Vencimiento = CONVERT(datetime,Vencimiento)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Vencimiento   varchar(255))
     SELECT  @FormaEnvio = NULLIF(FormaEnvio,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FormaEnvio   varchar(255))
     SELECT  @OrigenTipo = NULLIF(OrigenTipo,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(OrigenTipo   varchar(255))
     SELECT  @Origen = NULLIF(Origen,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Origen   varchar(255))
     SELECT  @OrigenID = NULLIF(OrigenID,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(OrigenID   varchar(255))
     SELECT  @Poliza = NULLIF(Poliza,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Poliza   varchar(255))
     SELECT  @PolizaID = NULLIF(PolizaID,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(PolizaID   varchar(255))
     SELECT  @GenerarPoliza = CONVERT(bit,GenerarPoliza)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(GenerarPoliza   varchar(255))
     SELECT  @ContID = CONVERT(int,ContID)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(ContID   varchar(255))
     SELECT  @Ejercicio = CONVERT(int,Ejercicio)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Ejercicio   varchar(255))
     SELECT  @Periodo = CONVERT(int,Periodo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Periodo   varchar(255))
     SELECT  @FechaRegistro = GETDATE()
     SELECT  @FechaConclusion = CONVERT(datetime,FechaConclusion)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FechaConclusion   varchar(255))
     SELECT  @FechaCancelacion = CONVERT(datetime,FechaCancelacion)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FechaCancelacion   varchar(255))
     SELECT  @FechaOrigen = CONVERT(datetime,FechaOrigen)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FechaOrigen   varchar(255))
     SELECT  @Peso = CONVERT(float , Peso)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Peso   varchar(255))
     SELECT  @Volumen = CONVERT(float , Volumen)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Volumen   varchar(255))
     SELECT  @Paquetes = CONVERT(int,Paquetes)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Paquetes   varchar(255))
     SELECT  @FechaEntrega = CONVERT(datetime,FechaEntrega)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FechaEntrega   varchar(255))
     SELECT  @EmbarqueEstado = NULLIF(EmbarqueEstado,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(EmbarqueEstado   varchar(255))
     SELECT  @Importe = CONVERT(money,Importe)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Importe   varchar(255))
     SELECT  @Logico1 = CONVERT(bit,Logico1)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico1   varchar(255))
     SELECT  @Logico2 = CONVERT(bit,Logico2)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico2   varchar(255))
     SELECT  @Logico3 = CONVERT(bit,Logico3)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico3   varchar(255))
     SELECT  @Logico4 = CONVERT(bit,Logico4)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico4   varchar(255))
     SELECT  @Logico5 = CONVERT(bit,Logico5)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico5   varchar(255))
     SELECT  @Logico6 = CONVERT(bit,Logico6)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico6   varchar(255))
     SELECT  @Logico7 = CONVERT(bit,Logico7)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico7   varchar(255))
     SELECT  @Logico8 = CONVERT(bit,Logico8)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico8   varchar(255))
     SELECT  @Logico9 = CONVERT(bit,Logico9)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico9   varchar(255))
     SELECT  @VerLote = CONVERT(bit,VerLote)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(VerLote   varchar(255))
     SELECT  @EspacioResultado = CONVERT(bit,EspacioResultado)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(EspacioResultado   varchar(255))
     SELECT  @VerDestino = CONVERT(bit,VerDestino)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(VerDestino   varchar(255))
     SELECT  @EstaImpreso = CONVERT(bit,EstaImpreso)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(EstaImpreso   varchar(255))
     SELECT  @Personal = NULLIF(Personal,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Personal   varchar(255))
     SELECT  @Reabastecido = CONVERT(bit,Reabastecido)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Reabastecido   varchar(255))
     SELECT  @Conteo = CONVERT(int,Conteo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Conteo   varchar(255))
     SELECT  @Agente = NULLIF(Agente,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Agente   varchar(255))
     SELECT  @ACRetencion = CONVERT(float , ACRetencion)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(ACRetencion   varchar(255))
     SELECT  @SubModulo = NULLIF(SubModulo,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SubModulo   varchar(255))
     SELECT  @SucursalOrigen = CONVERT(int,SucursalOrigen)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SucursalOrigen   varchar(255))
     SELECT  @SucursalDestino = CONVERT(int,SucursalDestino)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SucursalDestino   varchar(255))
     SELECT  @PedimentoExtraccion = NULLIF(PedimentoExtraccion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(PedimentoExtraccion   varchar(255))
     SELECT  @ReferenciaIntelisisService = NULLIF(ReferenciaIntelisisService,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
      WITH(ReferenciaIntelisisService   varchar(255))
     SELECT  @MovMES = CONVERT(bit,MovMES)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(MovMES   varchar(255))
     SELECT  @ReferenciaMES = NULLIF(ReferenciaMES,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(ReferenciaMES   varchar(255))
     SELECT  @PedidoMES = NULLIF(PedidoMES ,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(PedidoMES    varchar(255))      
     SELECT  @IDMES = CONVERT(int,IDMES)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(IDMES   varchar(255))    
     SELECT  @IDMarcaje = CONVERT(int,IDMarcaje)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(IDMarcaje   varchar(255))   
   END
  IF @Ok IS NULL
  BEGIN
    SET @Estatus = 'CONFIRMAR'
 
 
    SELECT @Empresa = Empresa ,@Sucursal =Sucursal, @SucursalOrigen = Sucursal
      FROM MapeoPlantaIntelisisMes
     WHERE Referencia = @ReferenciaIntelisisService
    SELECT @Sucursal2 = @Sucursal
    --SELECT @Sucursal2 = Sucursal, @SucursalOrigen = Sucursal
    --  FROM PlantaProductiva WHERE Clave =@Planta
      
    --SELECT @Sucursal =Sucursal FROM Alm WHERE Almacen = @Almacen
   
    SELECT @AjustesAutomaticosMES = AjustesAutomaticosMES, @FormaCosteo = FormaCosteo, @TipoCosteo = TipoCosteo, @ToleranciaAjuste = ISNULL(ToleranciaAjuste,0)  FROM EmpresaCfg WHERE Empresa = @Empresa
 
    IF NOT EXISTS(SELECT * FROM Mon WHERE Moneda = @Moneda ) SELECT @Ok = 20196
    IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) SELECT @Ok = 20830
    IF NOT EXISTS(SELECT * FROM Proy WHERE Proyecto = @Proyecto ) AND NULLIF(@Proyecto,'') IS NOT NULL SELECT @Ok = 15010
    IF NOT EXISTS(SELECT * FROM UEN WHERE UEN = @UEN ) AND NULLIF(@UEN,'') IS NOT NULL SELECT @Ok = 10070
    IF NOT EXISTS(SELECT * FROM MovTipo WHERE Mov = @Mov2 ) SELECT @Ok = 14055
    IF NOT EXISTS(SELECT * FROM Sucursal WHERE Sucursal = @Sucursal )SELECT @Ok = 72060
    IF NOT EXISTS(SELECT * FROM Empresa WHERE Empresa =  @Empresa)SELECT @Ok =26070
 
  END
  IF @Ok IS NULL
  BEGIN
    IF @Almacen NOT IN(SELECT Almacen FROM Alm WHERE Sucursal = @Sucursal)
      SELECT @Almacen = AlmacenPrincipal FROM Sucursal WHERE Sucursal = @Sucursal
    INSERT @Temp2 (  RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario, UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion,INFORCostoConsumoMat, INFORCostoManoObra , INFORCostoIndirecto )
    SELECT          RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, DescripcionUnidad, Factor, CantidadInventario, UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion, INFORCostoConsumoMat, INFORCostoManoObra , INFORCostoIndirecto
      FROM OPENXML(@iSolicitud, '/Intelisis/Solicitud/Inv/DetalleInv',1)
      WITH (RenglonSub  varchar(100), RenglonID  varchar(100), RenglonTipo  varchar(100), Cantidad  varchar(100), Almacen  varchar(100), Codigo  varchar(100), Articulo  varchar(100), ArticuloDestino  varchar(100), SubCuenta  varchar(100), SubCuentaDestino  varchar(100), Costo  varchar(100), CostoInv  varchar(100), ContUso  varchar(100), Espacio  varchar(100), CantidadReservada  varchar(100), CantidadCancelada  varchar(100), CantidadOrdenada  varchar(100), CantidadPendiente  varchar(100), CantidadA  varchar(100), Paquete  varchar(100), FechaRequerida  varchar(100), Aplica  varchar(100), AplicaID  varchar(100), DestinoTipo  varchar(100), Destino  varchar(100), DestinoID  varchar(100), Cliente  varchar(100), Unidad  varchar(100), Factor  varchar(100), CantidadInventario  varchar(100), UltimoReservadoCantidad  varchar(100), UltimoReservadoFecha  varchar(100), ProdSerieLote  varchar(100), Merma  varchar(100), Desperdicio  varchar(100), Producto  varchar(100), SubProducto  varchar(100), Tipo  varchar(100), Sucursal  varchar(100), Precio  varchar(100), SegundoConteo  varchar(100), DescripcionExtra  varchar(100), AjusteCosteo  varchar(100), CostoUEPS  varchar(100), CostoPEPS  varchar(100), UltimoCosto  varchar(100), PrecioLista  varchar(100), DepartamentoDetallista  varchar(100), AjustePrecioLista  varchar(100), Posicion  varchar(100), SucursalOrigen  varchar(100), Tarima  varchar(100), Seccion  varchar(100), CostoEstandar  varchar(100), FechaCaducidad  varchar(100), CostoPromedio  varchar(100), CostoReposicion varchar(100),INFORCostoConsumoMat  varchar(100), INFORCostoManoObra varchar(100), INFORCostoIndirecto varchar(100),ReferenciaMES varchar(100),PedidoMES varchar(100),IDMarcaje varchar(100),RenglonIDD varchar(100), DescripcionUnidad varchar(100))
      ORDER BY Articulo
    IF @@ERROR <> 0 SET @Ok = 1

	/*
	SELECT al.Empresa, al.Almacen, al.SerieLote, al.Articulo, al.SubCuenta, Unidad=ISNULL(u.Unidad,AL.Unidad), Existencia = SUM((ISNULL(al.Entrada, 0.0)-ISNULL(al.Salida, 0.0))) /*SUM((ISNULL(Entrada, 0.0)-ISNULL(Salida, 0.0))/ISNULL(Factor, 1.0))*/, ExistenciaAlterna = SUM((ISNULL(al.Entrada, 0.0)-ISNULL(al.Salida, 0.0))), al.Posicion
	  FROM AuxiliarAlterno al 
	  Join art a ON al.Articulo = a.Articulo
	  LEFT OUTER JOIN ArtUnidad u ON u.Articulo = a.Articulo AND u.Factor = 1

	  where a.Articulo='MPPRUEBA1' and al.Almacen='MP-GDL' and al.SerieLote='RR'

	 GROUP BY al.Empresa, al.Almacen, al.SerieLote, al.Articulo, al.SubCuenta, al.Posicion, ISNULL(u.Unidad,AL.Unidad)
	*/

	update @Temp2 set Posicion = isnull(Posicion, 'SURTIDO')

      INSERT @Tabla (Articulo, SerieLote, Cantidad, SubCuenta  )
      SELECT         Articulo, Lote, Cantidad  , SubCuenta
        FROM OPENXML(@iSolicitud, '/Intelisis/Solicitud/Inv/SerieLoteMov',1) 
        WITH (Articulo  varchar(100), Lote  varchar(100), Cantidad  varchar(100), SubCuenta varchar(100))
		ORDER BY Articulo

	INSERT @Temp (  RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario, UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion,INFORCostoConsumoMat, INFORCostoManoObra , INFORCostoIndirecto, SerieLote )
    SELECT A.RenglonTipo, SUM(A.Cantidad), A.Almacen, A.Codigo, A.Articulo, A.ArticuloDestino, A.SubCuenta, A.SubCuentaDestino, 
		A.Costo, A.CostoInv, A.ContUso, A.Espacio, A.CantidadReservada, A.CantidadCancelada, A.CantidadOrdenada, A.CantidadPendiente, 
		A.CantidadA, A.Paquete, A.FechaRequerida, A.Aplica, A.AplicaID, A.DestinoTipo, A.Destino, A.DestinoID, A.Cliente, A.Unidad,            
		A.Factor, A.CantidadInventario, A.UltimoReservadoCantidad, A.UltimoReservadoFecha, A.ProdSerieLote, A.Merma, A.Desperdicio, A.Producto, 
		A.SubProducto, A.Tipo, A.Sucursal, A.Precio, A.SegundoConteo, A.DescripcionExtra, A.AjusteCosteo, A.CostoUEPS, A.CostoPEPS, A.UltimoCosto, 
		A.PrecioLista, A.DepartamentoDetallista, A.AjustePrecioLista, A.Posicion, A.SucursalOrigen, A.Tarima, A.Seccion, A.CostoEstandar, A.FechaCaducidad, 
		A.CostoPromedio, A.CostoReposicion, A.INFORCostoConsumoMat, A.INFORCostoManoObra , A.INFORCostoIndirecto, B.SerieLote
	  FROM @Temp2 A JOIN @Tabla B ON A.IDR = B.IDR AND A.Articulo = B.Articulo
	GROUP BY  A.RenglonTipo, A.Almacen, A.Codigo, A.Articulo, A.ArticuloDestino, A.SubCuenta, A.SubCuentaDestino, 
		A.Costo, A.CostoInv, A.ContUso, A.Espacio, A.CantidadReservada, A.CantidadCancelada, A.CantidadOrdenada, A.CantidadPendiente, 
		A.CantidadA, A.Paquete, A.FechaRequerida, A.Aplica, A.AplicaID, A.DestinoTipo, A.Destino, A.DestinoID, A.Cliente, A.Unidad,            
		A.Factor, A.CantidadInventario, A.UltimoReservadoCantidad, A.UltimoReservadoFecha, A.ProdSerieLote, A.Merma, A.Desperdicio, A.Producto, 
		A.SubProducto, A.Tipo, A.Sucursal, A.Precio, A.SegundoConteo, A.DescripcionExtra, A.AjusteCosteo, A.CostoUEPS, A.CostoPEPS, A.UltimoCosto, 
		A.PrecioLista, A.DepartamentoDetallista, A.AjustePrecioLista, A.Posicion, A.SucursalOrigen, A.Tarima, A.Seccion, A.CostoEstandar, A.FechaCaducidad, 
		A.CostoPromedio, A.CostoReposicion, A.INFORCostoConsumoMat, A.INFORCostoManoObra , A.INFORCostoIndirecto, B.SerieLote

	/*
	INSERT @Temp (  RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario, UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion,INFORCostoConsumoMat, INFORCostoManoObra , INFORCostoIndirecto )
    SELECT           RenglonTipo, SUM(Cantidad), Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario, UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion,INFORCostoConsumoMat, INFORCostoManoObra , INFORCostoIndirecto 
	  FROM @Temp2
	GROUP BY  RenglonTipo, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario, UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion,INFORCostoConsumoMat, INFORCostoManoObra , INFORCostoIndirecto 
	*/

    IF EXISTS(SELECT * FROM Inv i JOIN MovTipo m ON i.Mov = m.Mov AND m.Modulo = 'INV'   WHERE m.Clave = 'INV.SOL' AND i.Estatus = 'PENDIENTE' AND i.Referencia = @Referencia AND i.OrigenTipo = 'I:MES')
    BEGIN
      BEGIN TRANSACTION 
      SELECT TOP 1 @IDSol = i.ID FROM Inv i JOIN MovTipo m ON i.Mov = m.Mov AND m.Modulo = 'INV'   WHERE m.Clave = 'INV.SOL' AND i.Estatus = 'PENDIENTE' AND i.Referencia = @Referencia AND i.OrigenTipo = 'I:MES'
     
      IF EXISTS(SELECT * FROM InvD d JOIN @Temp t ON d.Articulo = t.Articulo AND ISNULL(d.SubCuenta,'') = ISNULL(t.SubCuenta,'') WHERE d.ID = @IDSol AND d.CantidadPendiente >= t.Cantidad AND t.Almacen = ISNULL(NULLIF(d.Almacen,''),@Almacen))
      BEGIN
    
        UPDATE InvD SET CantidadA  = t.Cantidad
          FROM InvD d JOIN @Temp t ON d.Articulo = t.Articulo AND ISNULL(d.SubCuenta,'') = ISNULL(t.SubCuenta,'') AND ISNULL(NULLIF(d.Almacen,''),@Almacen) = t.Almacen
         WHERE d.ID = @IDSol AND d.CantidadPendiente >= t.Cantidad

         IF @Ok IS NULL
           EXEC spAfectar 'INV', @IDSol, 'RESERVAR', 'Seleccion', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT,@EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion

       END
        
       IF @Ok IS NULL AND EXISTS(SELECT * FROM InvD WHERE ID = @IDSol AND CantidadReservada > 0.0)
       BEGIN
         UPDATE InvD SET CantidadA  = t.Cantidad
           FROM InvD d JOIN @Temp t ON d.Articulo = t.Articulo AND ISNULL(d.SubCuenta,'') = ISNULL(t.SubCuenta,'') AND ISNULL(NULLIF(d.Almacen,''),@Almacen) = t.Almacen
          WHERE d.ID = @IDSol AND d.CantidadReservada  >= t.Cantidad
                 
         UPDATE @Temp SET Cantidad  = t.Cantidad-ISNULL(d.CantidadA,0.0)
           FROM InvD d JOIN @Temp t ON d.Articulo = t.Articulo AND ISNULL(d.SubCuenta,'') = ISNULL(t.SubCuenta,'')AND ISNULL(NULLIF(d.Almacen,''),@Almacen)= t.Almacen
          WHERE d.ID = @IDSol AND d.CantidadA <= t.Cantidad 
      
         EXEC @IDGenerar2 =  spAfectar 'INV', @IDSol, 'GENERAR', 'Seleccion', @Mov2, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT,@EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
         IF @Ok IS NULL OR @Ok BETWEEN 80000 AND 81000
           SELECT @Ok = NULL 
		 UPDATE Inv SET MovMES = 1 , OrigenTipo = 'I:MES' WHERE ID = @IDGenerar2
 
       END 
       
              IF @Ok IS NULL AND EXISTS(SELECT * FROM @Tabla)
       BEGIN
         DECLARE crSerieLote CURSOR LOCAL FAST_FORWARD FOR
         SELECT d.Articulo, d.Cantidad
           FROM InvD d JOIN Art b ON d.Articulo = b.Articulo
          WHERE b.Tipo  IN ('Lote','Serie')
            AND d.ID = @IDGenerar2
         OPEN crSerieLote
         FETCH NEXT FROM crSerieLote INTO  @ArticuloSol,@CantidadSol
         WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
         BEGIN
           DECLARE crDetalle3 CURSOR LOCAL FAST_FORWARD FOR
           SELECT a.Articulo,a.SerieLote,SUM(a.Cantidad),a.SubCuenta,NULL
             FROM @Tabla a JOIN Art b ON a.Articulo = b.Articulo
            WHERE b.Tipo  IN ('Lote','Serie')
              AND a.ARticulo = @ArticuloSol
           GROUP BY a.Articulo,a.SerieLote,a.SubCuenta
           OPEN crDetalle3
           FETCH NEXT FROM crDetalle3 INTO  @Articulo2,@Lote,@Cantidad2,@SubCuenta,@UltRenglonID
           WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
           BEGIN

             IF @Cantidad2 < = @CantidadSol
               SELECT @CantAfectar = @Cantidad2
             ELSE
               SELECT @CantAfectar = @CantidadSol   

             SELECT @Tipo2 = Tipo FROM Art WHERE Articulo = @Articulo2   
            
             SELECT @UltRenglonID = ISNULL(MAX(RenglonID), 0) FROM InvD WHERE ID = @IDGenerar2 AND Articulo=@Articulo2 AND Cantidad >= @CantAfectar AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')
       
             IF @Lote IS NOT NULL  AND @Tipo2  IN ('Lote','Serie') AND @Articulo2 IS NOT NULL
             BEGIN
       
               INSERT SerieLoteMov (Empresa,  Modulo, ID,          RenglonID,     Articulo, Cantidad,        SubCuenta,     SerieLote, Sucursal)
               SELECT               @Empresa, 'INV',  @IDGenerar2, @UltRenglonID, @Articulo2,@CantAfectar, ISNULL(@SubCuenta,''), @Lote,   ISNULL(@Sucursal,@Sucursal2)
               IF @@ERROR <> 0 SET @Ok = 1
               
       
             END
             UPDATE @Tabla SET Cantidad = Cantidad -@CantAfectar WHERE Articulo = @Articulo2 AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND SerieLote = @Lote AND Cantidad = @Cantidad2
             
             FETCH NEXT FROM crDetalle3 INTO  @Articulo2,@Lote,@Cantidad2,@SubCuenta,@UltRenglonID
           END
           CLOSE crDetalle3
           DEALLOCATE crDetalle3
           SELECT @Articulo2 = NULL,@Lote= NULL, @Articulo2 = NULL,@Cantidad2= NULL,@SubCuenta= NULL,@UltRenglonID= NULL         

           FETCH NEXT FROM crSerieLote INTO  @ArticuloSol,@CantidadSol
         END
         CLOSE crSerieLote
         DEALLOCATE crSerieLote
       END
       DELETE @Tabla WHERE ISNULL(Cantidad,0) <=0.0
       IF @Ok IS NULL OR @Ok BETWEEN 80000 AND 81000
            SELECT @Ok = NULL  
 
      DELETE @Temp WHERE ISNULL(Cantidad,0.0) <=0.0  
      IF @Ok IS NULL
      BEGIN
        COMMIT TRANSACTION
      END ELSE
      BEGIN
        ROLLBACK TRANSACTION
      END
    END

	IF EXISTS(SELECT * FROM @Temp WHERE ISNULL(Cantidad,0.0) > 0.0) AND @Ok IS NULL
    BEGIN
      SELECT @OrigenTipo='I:MES'
	  INSERT INTO Inv (Empresa, Mov,   MovID, FechaEmision,   UltimoCambio, Concepto, Proyecto, Actividad,   UEN,   Moneda,   TipoCambio,   Usuario,   Autorizacion,   Referencia, DocFuente, Observaciones, Estatus, Situacion, SituacionFecha, SituacionUsuario,   SituacionNota,   Prioridad, Directo, RenglonID, Almacen,   AlmacenDestino,   AlmacenTransito,   Largo,   FechaRequerida,   Condicion,   Vencimiento, FormaEnvio, OrigenTipo, Origen, OrigenID, Poliza,   PolizaID,   GenerarPoliza, ContID, Ejercicio, Periodo,   FechaRegistro,   FechaConclusion,   FechaCancelacion,   FechaOrigen,   Peso, Volumen, Paquetes, FechaEntrega, EmbarqueEstado,   Sucursal,   Importe,   Logico1, Logico2, Logico3, Logico4, Logico5,   Logico6,   Logico7,   Logico8,   Logico9, VerLote, EspacioResultado,   VerDestino, EstaImpreso,   Personal, Reabastecido,   Conteo, Agente,   ACRetencion, SubModulo,   SucursalOrigen, SucursalDestino,   PedimentoExtraccion, MovMES,ReferenciaMES, PedidoMES   ,IDMES,IDMarcaje)
	         SELECT  @Empresa, @Mov2, @MovID, @FechaEmision, @UltimoCambio, @Concepto, @Proyecto, @Actividad, @UEN, @Moneda, @TipoCambio, @Usuario, @Autorizacion, @Referencia, @DocFuente, @Observaciones, @Estatus, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @Prioridad, @Directo, @RenglonID, @Almacen, @AlmacenDestino, @AlmacenTransito, @Largo, @FechaRequerida, @Condicion, @Vencimiento, @FormaEnvio, @OrigenTipo, @Origen, @OrigenID, @Poliza, @PolizaID, @GenerarPoliza, @ContID, @Ejercicio, @Periodo, @FechaRegistro, @FechaConclusion, @FechaCancelacion, @FechaOrigen, @Peso, @Volumen, @Paquetes, @FechaEntrega, @EmbarqueEstado, ISNULL(@Sucursal,@Sucursal2), @Importe, @Logico1, @Logico2, @Logico3, @Logico4, @Logico5, @Logico6, @Logico7, @Logico8, @Logico9, @VerLote, @EspacioResultado, @VerDestino, @EstaImpreso, @Personal, @Reabastecido, @Conteo, @Agente, @ACRetencion, @SubModulo, @SucursalOrigen, @SucursalDestino, @PedimentoExtraccion, @MovMES,@ReferenciaMES, @PedidoMES  ,@IDMES ,@IDMarcaje
	  IF @@ERROR <> 0 SET @Ok = 1
	  SET @IDGenerar = @@IDENTITY
    
      SELECT @RenglonSub = 0
      SET @RenglonIDD =0
      UPDATE @Temp
         SET @RenglonIDD = RenglonID = @RenglonIDD + 1
        FROM @Temp

      IF @Ok IS NULL
      BEGIN
        DECLARE crDetalle CURSOR LOCAL FAST_FORWARD FOR
        SELECT  RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad, Factor, Cantidad*dbo.fnArtUnidadFactor(@Empresa, Articulo, Unidad), UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion,  Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion,INFORCostoConsumoMat, INFORCostoManoObra , INFORCostoIndirecto ,RenglonID, SerieLote
          FROM @Temp
        SET @Renglon = 0.0
        --SET @RenglonIDD = 0
        OPEN crDetalle
        FETCH NEXT FROM crDetalle INTO   @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion,  @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion,@INFORCostoConsumoMat, @INFORCostoManoObra , @INFORCostoIndirecto  ,@RenglonIDD, @SerieLote
        WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
        BEGIN
		  IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) 
			SELECT @Ok = 20830

          IF @Cantidad < 0 SET @Ok = 20010
        --  IF @Costo < 0 SET @Ok = 20140
      
          IF @AlmacenD NOT IN(SELECT Almacen FROM Alm WHERE Sucursal = @Sucursal)
            SELECT @AlmacenD = AlmacenPrincipal FROM Sucursal WHERE Sucursal = @Sucursal

         IF @FormaCosteo = 'Articulo'
           SELECT @Cual = TipoCosteo FROM Art WHERE Articulo = @Articulo
         ELSE
           SELECT @Cual = @TipoCosteo
 
         IF UPPER(@Cual) <> 'ESTANDAR'       
           EXEC spVerCosto @Sucursal, @Empresa, NULL, @Articulo, @SubCuenta, @Unidad, @Cual, @Moneda, @TipoCambio, @Costo OUTPUT, @ConReturn = 0
         ELSE
         BEGIN
           SELECT @Costo = @CostoEstandar
         
           IF NULLIF(@Costo,0.0) IS NULL
             EXEC spVerCosto @Sucursal, @Empresa, NULL, @Articulo, @SubCuenta, @Unidad, @Cual, @Moneda, @TipoCambio, @Costo OUTPUT, @ConReturn = 0
         END
 
         SELECT @ArtTipo = Tipo FROM Art WHERE Articulo = @Articulo
        
         EXEC spRenglonTipo @ArtTipo, @Subcuenta, @RenglonTipo OUTPUT
      
         SET @Renglon = @Renglon + 2048.0

		 BEGIN TRY
			IF EXISTS(SELECT Articulo FROM InvD WHERE ID = @IDGenerar and Articulo = @Articulo)
			BEGIN 
				UPDATE InvD SET Cantidad = Cantidad + @Cantidad, CantidadReservada = CantidadReservada + @CantidadReservada, CantidadInventario = CantidadInventario + @CantidadInventario WHERE ID = @IDGenerar and Articulo = @Articulo
			END
			ELSE
			BEGIN
				INSERT InvD (   ID        ,  Renglon,  RenglonSub,  RenglonID,  RenglonTipo,  Cantidad,  Almacen,  Codigo,  Articulo,  ArticuloDestino,  SubCuenta,  SubCuentaDestino,  Costo,  CostoInv,  ContUso,  Espacio,  CantidadReservada,  CantidadCancelada,  CantidadOrdenada,  CantidadPendiente,  CantidadA,  Paquete,  FechaRequerida,  Aplica,  AplicaID,  DestinoTipo,  Destino,  DestinoID,  Cliente,  Unidad,  Factor,  CantidadInventario,  UltimoReservadoCantidad,  UltimoReservadoFecha,  ProdSerieLote,  Merma,  Desperdicio,  Producto,  SubProducto,  Tipo,  Sucursal,  Precio,  SegundoConteo,  DescripcionExtra,  AjusteCosteo,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  DepartamentoDetallista,  AjustePrecioLista,  Posicion,  SucursalOrigen,  Tarima,  Seccion,  CostoEstandar,  FechaCaducidad,  CostoPromedio,  CostoReposicion, INFORCostoConsumoMat, INFORCostoManoObra , INFORCostoIndirecto   )
				VALUES         (@IDGenerar, @Renglon, @RenglonSub, @RenglonIDD, @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, ISNULL(@SubCuenta,''), @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, ISNULL(@Sucursal,@Sucursal2), @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion, @SucursalOrigen, @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion ,@INFORCostoConsumoMat, @INFORCostoManoObra , @INFORCostoIndirecto   )
			END
         END TRY
		 BEGIN CATCH
			SET @okref = ERROR_MESSAGE()
		 END CATCH

         SELECT @Disponible = Disponible
           FROM ArtSubDisponible
          WHERE Empresa   = @Empresa
            AND Almacen   = @AlmacenD
            AND Articulo  = @Articulo
            AND SubCuenta = ISNULL(@SubCuenta,'')
      
		IF (@ArtTipo IN ('Serie','Lote'))
		BEGIN
		  DECLARE @Disponible2 float
	      SELECT @Disponible2 = isnull(SerieLote.Existencia, 0)
            FROM SerieLote JOIN Alm ON SerieLote.Almacen=Alm.Almacen
		   WHERE SerieLote.Empresa=@Empresa AND SerieLote.Articulo=@Articulo AND SerieLote.Existencia>0 
				 --AND SerieLote.SerieLote in (SELECT SerieLote FROM @Tabla WHERE Articulo= @Articulo )
				 AND SerieLote.SerieLote = @SerieLote AND SerieLote.Almacen = @Almacen
			 SET @Disponible = ISNULL(@Disponible2, 0)	 
		end

         IF @Cantidad > @Disponible  AND @ArtTipo ='Normal'
         BEGIN
            SELECT @Renglon2 = MAX(Renglon) FROM @Tabla2
            SELECT @Renglon2 = ISNULL(@Renglon2,0.0)
            SET @Renglon2 = @Renglon2 + 2048.00
       
            INSERT @Tabla2 (Renglon,Articulo,SubCuenta,Almacen,Serielote,Costo,Cantidad,Unidad)
            SELECT          @Renglon2,@Articulo,@SubCuenta,ISNULL(@AlmacenD,@Almacen),null,@Costo,(@Cantidad-@Disponible),@Unidad
             
          END

          IF @Cantidad > @Disponible AND @ArtTipo IN ('Serie','Lote')
          BEGIN
			IF EXISTS(SELECT * FROM SerieLote WHERE Sucursal = ISNULL(@Sucursal,@Sucursal2) AND Empresa =  @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND SerieLote = @Lote AND Almacen = ISNULL(@AlmacenD,@Almacen)AND Existencia IS NOT NULL) 
				SELECT @Ok = 20080 ,@OkRef= @OkRef+' Articulo  '+@Articulo

            IF @Ok IS NULL
            BEGIN
              SELECT @Renglon2 = MAX(Renglon) FROM @Tabla2
              SELECT @Renglon2 = ISNULL(@Renglon2,0.0)
              SET @Renglon2 = @Renglon2 + 2048.00

              INSERT @Tabla2 (Renglon,Articulo,SubCuenta,Almacen,Serielote,Costo,Cantidad,Unidad)
              SELECT          @Renglon2,@Articulo,@SubCuenta,ISNULL(@AlmacenD,@Almacen),SerieLote,@Costo,(@Cantidad-@Disponible),@Unidad
              FROM @Tabla WHERE Articulo = @Articulo AND Cantidad=@Cantidad AND SubCuenta =@SubCuenta AND SerieLote = @SerieLote

            END
          END
      --    FETCH NEXT FROM crDetalle INTO  @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion,  @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion,@INFORCostoConsumoMat, @INFORCostoManoObra , @INFORCostoIndirecto, @RenglonIDD, @SerieLote
      --  END
      --  CLOSE crDetalle
      --  DEALLOCATE crDetalle
      --END
	  IF @Ok IS NULL AND EXISTS(SELECT * FROM @Tabla)
       BEGIN
         DECLARE crSerieLote CURSOR LOCAL FAST_FORWARD FOR
         SELECT Articulo, Cantidad, SerieLote 
		   FROM @Tabla 
		  WHERE SerieLote = @SerieLote
         OPEN crSerieLote
         FETCH NEXT FROM crSerieLote INTO  @ArticuloSol,@CantidadSol, @SerieLoteD
         WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
         BEGIN
           DECLARE crDetalle3 CURSOR LOCAL FAST_FORWARD FOR
           SELECT a.Articulo,a.SerieLote,SUM(a.Cantidad),a.SubCuenta,NULL
             FROM @Tabla a JOIN Art b ON a.Articulo = b.Articulo
            WHERE b.Tipo  IN ('Lote','Serie')
              AND a.ARticulo = @ArticuloSol
              AND a.SerieLote = @SerieLoteD
           GROUP BY a.Articulo,a.SerieLote,a.SubCuenta
           OPEN crDetalle3
           FETCH NEXT FROM crDetalle3 INTO  @Articulo2,@Lote,@Cantidad2,@SubCuenta,@UltRenglonID
           WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
           BEGIN
             IF @Cantidad2 < = @CantidadSol
               SELECT @CantAfectar = @Cantidad2
             ELSE
               SELECT @CantAfectar = @CantidadSol   

            SELECT @Tipo2 = Tipo FROM Art WHERE Articulo = @Articulo2   
			SELECT @UltRenglonID = MIN(RenglonID) FROM @Temp WHERE Articulo=@Articulo2 
       
             IF @Lote IS NOT NULL  AND @Tipo2  IN ('Lote','Serie') AND @Articulo2 IS NOT NULL
             BEGIN
			  begin try
				IF NOT EXISTS (SELECT ID FROM SerieLoteMov WHERE 
					ID = @IDGenerar AND Articulo = @Articulo2 AND RenglonID = @UltRenglonID AND SubCuenta = ISNULL(@SubCuenta,'') AND SerieLote = @Lote AND Empresa = @Empresa)
				BEGIN
					INSERT SerieLoteMov (Empresa,  Modulo, ID,          RenglonID,     Articulo,   Cantidad,        SubCuenta,     SerieLote, Sucursal)
					SELECT               @Empresa, 'INV',  @IDGenerar, @UltRenglonID, @Articulo2, @CantAfectar, ISNULL(@SubCuenta,''), @Lote,   ISNULL(@Sucursal,@Sucursal2)
				END
			   end try
			   begin catch
				  SElECT @Ok = 1, @OkRef = ERROR_MESSAGE()
			   end catch
             END
             FETCH NEXT FROM crDetalle3 INTO  @Articulo2,@Lote,@Cantidad2,@SubCuenta,@UltRenglonID
           END
           CLOSE crDetalle3
           DEALLOCATE crDetalle3
		   --SELECT @Articulo2 = NULL,@Lote= NULL, @Articulo2 = NULL,@Cantidad2= NULL,@SubCuenta= NULL,@UltRenglonID= NULL
           FETCH NEXT FROM crSerieLote INTO  @ArticuloSol, @CantidadSol, @SerieLoteD
         END
         CLOSE crSerieLote
         DEALLOCATE crSerieLote
         --select 'end'
       END  

    -- regresar cursor   (Lote por renglon)
    FETCH NEXT FROM crDetalle INTO  @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion,  @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion,@INFORCostoConsumoMat, @INFORCostoManoObra , @INFORCostoIndirecto, @RenglonIDD, @SerieLote
        END
        CLOSE crDetalle
        DEALLOCATE crDetalle
      END
  END

  SELECT @Ajuste = COUNT(*) FROM @Tabla2
  SELECT @RedondeoMonetarios = dbo.fnRedondeoMonetarios()

  IF @Ajuste > 0 AND @AjustesAutomaticosMES =1 AND @Ok IS NULL AND EXISTS (SELECT * FROM @Tabla2 WHERE ROUND(ISNULL(Cantidad,0),@RedondeoMonetarios) <= ROUND(@ToleranciaAjuste,@RedondeoMonetarios))
  BEGIN
    SET @RenglonIDD =0
    UPDATE @Tabla2
       SET @RenglonIDD = RenglonID = @RenglonIDD + 1
      FROM @Tabla2

    SELECT @Mov3 = Mov FROM MovTipo WHERE Modulo = 'INV' AND Clave ='INV.E' AND SubClave ='INV.EA'

	BEGIN TRY
		INSERT INTO Inv (Empresa, Mov,    FechaEmision,   UltimoCambio, Concepto, Proyecto, Actividad,   UEN,   Moneda,   TipoCambio,   Usuario,   Autorizacion,   Referencia, DocFuente, Observaciones, Estatus, Situacion, SituacionFecha, SituacionUsuario,   SituacionNota,   Prioridad, Directo, RenglonID, Almacen,   AlmacenDestino,   AlmacenTransito,   Largo,   FechaRequerida,   Condicion,   Vencimiento, FormaEnvio, OrigenTipo, Origen, OrigenID, Poliza,   PolizaID,   GenerarPoliza, ContID, Ejercicio, Periodo,   FechaRegistro,   FechaConclusion,   FechaCancelacion,   FechaOrigen,   Peso, Volumen, Paquetes, FechaEntrega, EmbarqueEstado,   Sucursal,   Importe,   Logico1, Logico2, Logico3, Logico4, Logico5,   Logico6,   Logico7,   Logico8,   Logico9, VerLote, EspacioResultado,   VerDestino, EstaImpreso,   Personal, Reabastecido,   Conteo, Agente,   ACRetencion, SubModulo,   SucursalOrigen, SucursalDestino,   PedimentoExtraccion, MovMES,ReferenciaMES, PedidoMES ,IDMarcaje  )
				SELECT  @Empresa, @Mov3,  @FechaEmision, @UltimoCambio, @Concepto, @Proyecto, @Actividad, @UEN, @Moneda, @TipoCambio, @Usuario, @Autorizacion, @Referencia, @DocFuente, @Observaciones, @Estatus, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @Prioridad, @Directo, @RenglonID, @Almacen, @AlmacenDestino, @AlmacenTransito, @Largo, @FechaRequerida, @Condicion, @Vencimiento, @FormaEnvio, @OrigenTipo, @Origen, @OrigenID, @Poliza, @PolizaID, @GenerarPoliza, @ContID, @Ejercicio, @Periodo, @FechaRegistro, @FechaConclusion, @FechaCancelacion, @FechaOrigen, @Peso, @Volumen, @Paquetes, @FechaEntrega, @EmbarqueEstado, ISNULL(@Sucursal,@Sucursal2), @Importe, @Logico1, @Logico2, @Logico3, @Logico4, @Logico5, @Logico6, @Logico7, @Logico8, @Logico9, @VerLote, @EspacioResultado, @VerDestino, @EstaImpreso, @Personal, @Reabastecido, @Conteo, @Agente, @ACRetencion, @SubModulo, @SucursalOrigen, @SucursalDestino, @PedimentoExtraccion, @MovMES,@ReferenciaMES, @PedidoMES,@IDMarcaje 
		SET @IDAjuste = @@IDENTITY

		INSERT INTO InvD(ID,Renglon,RenglonID,Articulo,SubCuenta,Almacen,Cantidad,Costo,Unidad,CantidadInventario)
		 SELECT @IDAjuste, MIN(Renglon), MIN(RenglonID), Articulo, ISNULL(SubCuenta,''), Almacen, SUM(Cantidad), Costo, Unidad, SUM(Cantidad*dbo.fnArtUnidadFactor(@Empresa, Articulo, Unidad))
		   FROM @Tabla2
		  WHERE ROUND(ISNULL(Cantidad,0),@RedondeoMonetarios) <= ROUND(@ToleranciaAjuste,@RedondeoMonetarios) 
		  GROUP BY Articulo, ISNULL(SubCuenta,''), Almacen, Costo, Unidad 

		DECLARE @RenglonIDaJUSTE int, @ArticuloAjuste varchar(50), @SubCuentaAjuste varchar(50), @SerieLoteAjuste varchar(50), @CantidadAjuste2 float, @UltRenglonIDAjuste int
		DECLARE ajusteLote_cursor CURSOR FOR 
		SELECT RenglonID, Articulo, ISNULL(SubCuenta,''), SerieLote, Cantidad
		  FROM @Tabla2
		 WHERE Serielote IS NOT NULL AND ROUND(ISNULL(Cantidad,0),@RedondeoMonetarios) <= ROUND(@ToleranciaAjuste,@RedondeoMonetarios) 

		OPEN ajusteLote_cursor
		FETCH NEXT FROM ajusteLote_cursor
		INTO @RenglonIDaJUSTE, @ArticuloAjuste, @SubCuentaAjuste, @SerieLoteAjuste, @CantidadAjuste2

		WHILE @@FETCH_STATUS = 0
		BEGIN
			SELECT @UltRenglonIDAjuste = MIN(RenglonID) FROM INVD WHERE ID = @IDAjuste AND Articulo=@ArticuloAjuste
			INSERT SerieLoteMov (Empresa,  Modulo, ID,        RenglonID,			Articulo,		 SubCuenta,			SerieLote,		 Sucursal,					   Cantidad)
			SELECT               @Empresa, 'INV',  @IDAjuste, @UltRenglonIDAjuste, @ArticuloAjuste, @SubCuentaAjuste, @SerieLoteAjuste, ISNULL(@Sucursal,@Sucursal2), @CantidadAjuste2
			FETCH NEXT FROM ajusteLote_cursor 
			INTO @RenglonIDaJUSTE, @ArticuloAjuste, @SubCuentaAjuste, @SerieLoteAjuste, @CantidadAjuste2
		END
		CLOSE ajusteLote_cursor;
		DEALLOCATE ajusteLote_cursor;
    END TRY
	BEGIN CATCH
		SELECT @Ok = 1, @okref = ERROR_MESSAGE()
	END CATCH

      BEGIN TRANSACTION
      IF @Ok IS NULL AND @IDAjuste IS NOT NULL
     
      EXEC spAfectar 'INV', @IDAjuste, 'AFECTAR', 'Todo', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT,@EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
      IF @Ok IS NULL OR @Ok BETWEEN 80000 AND 81000
        SELECT @Ok = NULL
     IF @Ok IS NULL
     BEGIN
       COMMIT TRANSACTION
     END ELSE
     BEGIN
       ROLLBACK TRANSACTION
     IF @IDAjuste IS NOT NULL
      UPDATE Inv SET Estatus = 'BORRADOR' WHERE ID = @IDAjuste
   
     END        
 
   END
 
   BEGIN TRANSACTION
   IF @Ok IS NULL AND @IDGenerar2 IS NOT NULL
    EXEC spAfectar 'INV', @IDGenerar2, 'VERIFICAR', 'Todo', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT,@EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
   IF @Ok IS NULL OR @Ok BETWEEN 80000 AND 81000
     SELECT @Ok = NULL
   IF @Ok IS NULL AND  @IDGenerar2 IS NOT NULL
    EXEC spAfectar 'INV', @IDGenerar2, 'AFECTAR', 'Todo', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT,@EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
   IF @Ok IS NULL OR @Ok BETWEEN 80000 AND 81000
      SELECT @Ok = NULL 
   IF @Ok IS NULL AND @IDGenerar IS NOT NULL
    EXEC spAfectar 'INV', @IDGenerar, 'VERIFICAR', 'Todo', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT,@EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
   IF @Ok IS NULL OR @Ok BETWEEN 80000 AND 81000
    SELECT @Ok = NULL
   IF @Ok IS NULL AND @Estatus IN ('CONFIRMAR', 'SINAFECTAR') AND @IDGenerar IS NOT NULL
    EXEC spAfectar 'INV', @IDGenerar, 'AFECTAR', 'Todo', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT,@EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
   IF @Ok IS NULL OR @Ok BETWEEN 80000 AND 81000
      SELECT @Ok = NULL

  IF @Ok IS NULL
  BEGIN
    COMMIT TRANSACTION
  END ELSE
  BEGIN
    ROLLBACK TRANSACTION
    IF @IDGenerar IS NOT NULL
      UPDATE Inv SET Estatus = 'BORRADOR' WHERE ID = @IDGenerar
      
    IF @IDGenerar2 IS NOT NULL
      UPDATE Inv SET Estatus = 'BORRADOR' WHERE ID = @IDGenerar2     
  END
 END

  IF @Ok IS NULL
  BEGIN
    SELECT @ReferenciaIS = Referencia
      FROM IntelisisService
     WHERE ID = @ID
  END
 
  SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + ' Modulo="INV" ModuloID =' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@IDGenerar,@IDGenerar2)),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'

END
GO

/**************** spISIntelisisINVInsertarMovINV_E ****************/
if exists (select * from sysobjects where id = object_id('dbo.spISIntelisisINVInsertarMovINV_E') and type = 'P') drop procedure dbo.spISIntelisisINVInsertarMovINV_E
GO
CREATE PROCEDURE spISIntelisisINVInsertarMovINV_E
            @ID                     int,
            @iSolicitud       int,
            @Version          float,
            @Resultado        varchar(max) = NULL OUTPUT,
            @Ok               int = NULL OUTPUT,  
            @OkRef                  varchar(255) = NULL OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @IDGenerar                     int,
    @IDAcceso                      int,
    @MovTipo                       varchar(20),
    @ReferenciaIS            varchar(100),
    @Usuario2                      varchar(10),
    @Estacion                      int,
    @SubReferencia                 varchar(100),
    @Empresa                       varchar(5),
    @Mov                           varchar(20),
    @Mov2                          varchar(20),
    @MovID                         varchar(20),
    @FechaEmision            datetime   ,
    @UltimoCambio            datetime   ,
    @Concepto                varchar(50),
    @Proyecto                varchar(50),
    @Actividad               varchar(100),
    @UEN                           int   ,
    @Moneda                        varchar(10),
    @TipoCambio                    float   ,
    @Usuario                       varchar(10),
    @Autorizacion            varchar(10),
    @Referencia                    varchar(50),
    @DocFuente               int   ,
    @Observaciones           varchar(100),
    @Estatus                       varchar(15),
    @Situacion               varchar(50),
    @SituacionFecha          datetime   ,
    @SituacionUsuario        varchar(10),
    @SituacionNota           varchar(100),
    @Prioridad               varchar(10),
   @Directo                       bit   ,
    @RenglonID               int   ,
    @Almacen                       varchar(10),
    @AlmacenDestino          varchar(10),
    @AlmacenTransito         varchar(10),
    @Largo                         bit   ,
    @FechaRequerida          datetime   ,
    @Condicion               varchar(50),
    @Vencimiento                   datetime   ,
    @FormaEnvio                    varchar(50),
    @OrigenTipo                    varchar(10),
    @Origen                        varchar(20),
    @OrigenID                varchar(20),
    @Poliza                        varchar(20),
    @PolizaID                varchar(20),
    @GenerarPoliza           bit   ,
    @ContID                        int   ,
    @Ejercicio               int   ,
    @Periodo                       int   ,
    @FechaRegistro           datetime   ,
    @FechaConclusion         datetime   ,
    @FechaCancelacion        datetime   ,
    @FechaOrigen                   datetime   ,
    @Peso                          float   ,
    @Volumen                       float   ,
    @Paquetes                int   ,
    @FechaEntrega            datetime   ,
    @EmbarqueEstado          varchar(50),
    @Sucursal                int   ,
    @Sucursal2               int   ,
    @Importe                       money   ,
    @Logico1                       bit   ,
    @Logico2                       bit   ,
    @Logico3                       bit   ,
    @Logico4                       bit   ,
    @Logico5                       bit   ,
    @Logico6                       bit   ,
    @Logico7                       bit   ,
    @Logico8                       bit   ,
    @Logico9                       bit   ,
    @VerLote                       bit   ,
    @EspacioResultado        bit   ,
    @VerDestino                    bit   ,
    @EstaImpreso                   bit   ,
    @Personal                varchar(10),
    @Reabastecido                  bit   ,
    @Conteo                        int   ,
    @Agente                        varchar(10),
    @ACRetencion                   float   ,
    @SubModulo               varchar(5),
    @SucursalOrigen          int   ,
    @SucursalDestino         int   ,
    @PedimentoExtraccion     varchar(50),
    @MovMES                        bit,
-----detalle
    @IDD                            int   ,
    @Renglon                       float   ,
    @RenglonSub                    int   ,
    @RenglonIDD                    int   ,
    @RenglonTipo             char(1),
    @Cantidad                float   ,
    @AlmacenD                varchar(10),
    @Codigo                        varchar(30),
    @Articulo                varchar(20),
    @ArticuloDestino         varchar(20),
    @SubCuenta               varchar(50),
    @SubCuentaDestino        varchar(50),
    @Costo                          money   ,
    @CostoInv                      money   ,
    @ContUso                       varchar(20),
    @Espacio                       varchar(10),
    @CantidadReservada       float   ,
    @CantidadCancelada       float   ,
    @CantidadOrdenada        float   ,
    @CantidadPendiente       float   ,
    @CantidadA               float   ,
    @Paquete                       int   ,
    @Aplica                        varchar(20),
    @AplicaID                varchar(20),
    @DestinoTipo                   varchar(10),
    @Destino                       varchar(20),
    @DestinoID               varchar(20),
    @Cliente                       varchar(10),
    @Unidad                        varchar(50),
    @Factor                        float   ,
    @CantidadInventario      float   ,
    @UltimoReservadoCantidad float   ,
    @UltimoReservadoFecha   datetime   ,
    @ProdSerieLote           varchar(50),
    @Merma                         float   ,
    @Desperdicio                   float   ,
    @Producto                varchar(20),
    @SubProducto                   varchar(20),
    @Tipo                          varchar(20),
    @Precio                        money   ,
    @SegundoConteo           float   ,
    @DescripcionExtra        varchar(100),
    @AjusteCosteo            money   ,
    @CostoUEPS                     money   ,
    @CostoPEPS                     money   ,
    @UltimoCosto             money   ,
    @PrecioLista             money   ,
    @DepartamentoDetallista int   ,
    @AjustePrecioLista       money   ,
    @Posicion                varchar(10),
    @Tarima                        varchar(20),
    @Seccion                       smallint   ,
    @CostoEstandar                 money   ,
    @FechaCaducidad          datetime   ,
    @CostoPromedio                 money   ,
    @CostoReposicion         money  ,
    @Proveedor                     varchar(10),
    @ReferenciaIntelisisService  varchar(50),
    @Articulo2                     varchar(20),
    @ArtCompra                      varchar(20),
    @Lote                             Varchar(50),
    @Cantidad2                     float,
    @UltRenglonID            int,
    @Tipo2                         varchar(20),
    @ArtTipo                 varchar(20),  
    @CostoConsumoMat        float,
    @CostoManoObra          float,
    @CostoIndirecto         float,
    @CostoServicio          float,
    @ReferenciaMES          varchar(50),
    @PedidoMES              varchar(20),
    @Motivo                 varchar(8),
    @Planta                 varchar(20),
    @IDMES                  int,
    @Serie                  varchar(3),
    @IDVenta                int,
    @MovVenta               varchar(20),
    @RenglonCompra          float,
    @CantidadVenta          float,
    @Reservar               bit,
    @CfgReservar            bit,
    @NuevoID                int ,
    @MovO                   varchar(20),
    @MoVIDO                 varchar(20)  ,
    @IDMarcaje              int ,
    @SubClave               varchar(20),
    @ArticuloD              varchar(20),
    @CantidadD              float,
    @CantidadResta          float,
    @SubCuentaD             varchar(50),
    @UnidadD                varchar(50),
    @UnidadP                varchar(50),
    @IDPedido               int,
    @RenglonD               float,
    @AlmacenDD              varchar(10),
    @AlmacenO               varchar(10),
    @ArticuloO              varchar(20),
    @CantidadO              float,
    @IDSol                  int,
    @SubCuentaO             varchar(50),
    @UnidadO                varchar(50),
    @RenglonO               float,
    @CantidadReservar       float,
    @CantidadPendienteO     float,
    @UnidadPO               varchar(50),
    @AlmacenP               varchar(10),
    @CfgPosiciones          bit ,
    @PosicionO              varchar(50),
	@FormaCosteo            varchar(20),
    @TipoCosteo             varchar(20),
	@Cual                   varchar(20),
	@INFORTipo				varchar(50)

  DECLARE @Temp             table
         (
     IDD                            int   ,
     Renglon                       float   ,
     RenglonSub                    int   ,
     RenglonID               int   ,
     RenglonTipo             char(1),
     Cantidad                float   ,
     Almacen                       varchar(10),
     Codigo                        varchar(30),
     Articulo                varchar(20),
     ArticuloDestino         varchar(20),
     SubCuenta               varchar(50),
     SubCuentaDestino        varchar(50),
     Costo                         float   ,
     CostoInv                      float   ,
     ContUso                       varchar(20),
     Espacio                       varchar(10),
     CantidadReservada       float   ,
     CantidadCancelada       float   ,
     CantidadOrdenada        float   ,
     CantidadPendiente       float   ,
     CantidadA               float   ,
     Paquete                       int   ,
     FechaRequerida          datetime   ,
     Aplica                        varchar(20),
     AplicaID                varchar(20),
     DestinoTipo                   varchar(10),
     Destino                       varchar(20),
     DestinoID               varchar(20),
     Cliente                       varchar(10),
     Unidad                        varchar(50),
     Factor                        float   ,
     CantidadInventario      float   ,
     UltimoReservadoCantidad float   ,
     UltimoReservadoFecha   datetime   ,
     ProdSerieLote           varchar(50),
     Merma                         float   ,
     Desperdicio                   float   ,
     Producto                varchar(20),
     SubProducto                   varchar(20),
     Tipo                          varchar(20),
     Sucursal                int   ,
     Precio                        float   ,
     SegundoConteo           float   ,
     DescripcionExtra        varchar(100),
     AjusteCosteo            float   ,
     CostoUEPS                     float   ,
     CostoPEPS                     float   ,
     UltimoCosto             float   ,
     PrecioLista             float   ,
     DepartamentoDetallista int   ,
     AjustePrecioLista       float   ,
     Posicion                varchar(10),
     SucursalOrigen          int   ,
     Tarima                        varchar(20),
     Seccion                       smallint   ,
     CostoEstandar                 float   ,
     FechaCaducidad          datetime   ,
     CostoPromedio                 float   ,
     CostoReposicion         float  ,
     CostoConsumoMat        float,
     CostoManoObra          float,
     CostoIndirecto         float,
     CostoServicio          float

       
         )


  DECLARE @Temp2             table
         (
     IDD                            int   ,
     Renglon                       float   ,
     RenglonSub                    int   ,
     RenglonID               int   ,
     RenglonTipo             char(1),
     Cantidad                float   ,
     Almacen                       varchar(10),
     Codigo                        varchar(30),
     Articulo                varchar(20),
     ArticuloDestino         varchar(20),
     SubCuenta               varchar(50),
     SubCuentaDestino        varchar(50),
     Costo                         float   ,
     CostoInv                      float   ,
     ContUso                       varchar(20),
     Espacio                       varchar(10),
     CantidadReservada       float   ,
     CantidadCancelada       float   ,
     CantidadOrdenada        float   ,
     CantidadPendiente       float   ,
     CantidadA               float   ,
     Paquete                       int   ,
     FechaRequerida          datetime   ,
     Aplica                        varchar(20),
     AplicaID                varchar(20),
     DestinoTipo                   varchar(10),
     Destino                       varchar(20),
     DestinoID               varchar(20),
     Cliente                       varchar(10),
     Unidad                        varchar(50),
     Factor                        float   ,
     CantidadInventario      float   ,
     UltimoReservadoCantidad float   ,
     UltimoReservadoFecha   datetime   ,
     ProdSerieLote           varchar(50),
     Merma                         float   ,
     Desperdicio                   float   ,
     Producto                varchar(20),
    SubProducto                   varchar(20),
     Tipo                          varchar(20),
     Sucursal                int   ,
     Precio                        float   ,
     SegundoConteo           float   ,
     DescripcionExtra        varchar(100),
     AjusteCosteo            float   ,
     CostoUEPS                     float   ,
     CostoPEPS                     float   ,
     UltimoCosto             float   ,
     PrecioLista             float   ,
     DepartamentoDetallista int   ,
     AjustePrecioLista       float   ,
     Posicion                varchar(10),
     SucursalOrigen          int   ,
     Tarima                        varchar(20),
     Seccion                       smallint   ,
     CostoEstandar                 float   ,
     FechaCaducidad          datetime   ,
     CostoPromedio                 float   ,
     CostoReposicion         float  ,
     CostoConsumoMat        float, 
     CostoManoObra          float, 
     CostoIndirecto         float, 
     CostoServicio          float

         )

     DECLARE @Tabla table (
     Empresa            varchar(5),
     Modulo             varchar(5),
     ID                      int,
     RenglonID          int,
     Articulo           varchar(20),
     SubCuenta          varchar(50),
     SerieLote          varchar(50),
     Cantidad           float,
     CantidadAlterna float,
     Propiedades  varchar(20),
     Ubicacion          int,
     Cliente            varchar(10),
     Localizacion varchar(10),
     Sucursal           int,
     ArtCostoInv  money)  

  SELECT @IDAcceso = dbo.fnAccesoID(@@SPID)
  SELECT @Estacion = EstacionTrabajo  FROM Acceso WHERE ID = @IDAcceso
  IF @Ok IS NULL
  BEGIN
    SELECT  @Mov = NULLIF(Dev,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Dev   varchar(255))
     IF @Mov IS NULL
     BEGIN
       SELECT  @Mov = NULLIF(Mov,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
         WITH(Mov   varchar(255))
     END
    IF @@ERROR <> 0 SET @Ok = 1
  END
  IF @Ok IS NULL
    SELECT @Mov2 = Mov FROM MapeoMovimientosInforIntelisis WHERE INFORMov = @Mov

    SELECT @MovTipo = Clave,@SubClave = SubClave
      FROM MovTipo
     WHERE Modulo = 'INV' AND Mov = @Mov2

  IF @MovTipo <> 'INV.E' SELECT @Ok = 35005, @OkRef = @Mov
  IF @Ok IS NULL
  BEGIN

     SELECT  @Mov = NULLIF(Dev,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Dev   varchar(255))
     IF @Mov IS NULL
     BEGIN
       SELECT  @Mov = NULLIF(Mov,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
         WITH(Mov   varchar(255))
     END
     SELECT  @MovID = NULLIF(MovID,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(MovID   varchar(255))
     SELECT  @FechaEmision = dbo.fnFechaSinHora(GETDATE())
     SELECT  @UltimoCambio = CONVERT(datetime,UltimoCambio)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(UltimoCambio   varchar(255))
     SELECT  @Concepto = NULLIF(Concepto,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Concepto   varchar(255))
     SELECT  @Proyecto = NULLIF(Proyecto,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Proyecto   varchar(255))
     SELECT  @Actividad = NULLIF(Actividad,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Actividad   varchar(255))
     SELECT  @UEN = CONVERT(int,UEN)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(UEN   varchar(255))
     SELECT  @Moneda = NULLIF(Moneda,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Moneda   varchar(255))
     SELECT  @TipoCambio = CONVERT(float , TipoCambio)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(TipoCambio   varchar(255))
     SELECT  @Usuario = NULLIF(Usuario,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Usuario   varchar(255))
     SELECT  @Autorizacion = NULLIF(Autorizacion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Autorizacion   varchar(255))
     SELECT  @Referencia = NULLIF(Referencia,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Referencia   varchar(255))
     SELECT  @DocFuente = CONVERT(int,DocFuente)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(DocFuente   varchar(255))
     SELECT  @Observaciones = NULLIF(Observaciones,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Observaciones   varchar(255))
     SELECT  @Estatus = NULLIF(Estatus,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Estatus   varchar(255))
     SELECT  @Situacion = NULLIF(Situacion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Situacion   varchar(255))
     SELECT  @SituacionFecha = CONVERT(datetime,SituacionFecha)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SituacionFecha   varchar(255))
     SELECT  @SituacionUsuario = NULLIF(SituacionUsuario,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SituacionUsuario   varchar(255))
     SELECT  @SituacionNota = NULLIF(SituacionNota,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SituacionNota   varchar(255))
     SELECT  @Prioridad = NULLIF(Prioridad,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Prioridad   varchar(255))
     SELECT  @Directo = CONVERT(bit,Directo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Directo   varchar(255))
     SELECT  @RenglonID = CONVERT(int,RenglonID)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(RenglonID   varchar(255))
     SELECT  @Almacen = NULLIF(Almacen,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Almacen   varchar(255))
     SELECT  @AlmacenDestino = NULLIF(AlmacenDestino,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(AlmacenDestino   varchar(255))
     SELECT  @AlmacenTransito = NULLIF(AlmacenTransito,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(AlmacenTransito   varchar(255))
     SELECT  @Largo = CONVERT(bit,Largo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Largo   varchar(255))
     SELECT  @FechaRequerida = CONVERT(datetime,FechaRequerida)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FechaRequerida   varchar(255))
     SELECT  @Condicion = NULLIF(Condicion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Condicion   varchar(255))
     SELECT  @Vencimiento = CONVERT(datetime,Vencimiento)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Vencimiento   varchar(255))
     SELECT  @FormaEnvio = NULLIF(FormaEnvio,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FormaEnvio   varchar(255))
     SELECT  @OrigenTipo = NULLIF(OrigenTipo,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(OrigenTipo   varchar(255))
     SELECT  @Origen = NULLIF(Origen,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Origen   varchar(255))
     SELECT  @OrigenID = NULLIF(OrigenID,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(OrigenID   varchar(255))
     SELECT  @Poliza = NULLIF(Poliza,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Poliza   varchar(255))
     SELECT  @PolizaID = NULLIF(PolizaID,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(PolizaID   varchar(255))
     SELECT  @GenerarPoliza = CONVERT(bit,GenerarPoliza)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(GenerarPoliza   varchar(255))
     SELECT  @ContID = CONVERT(int,ContID)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(ContID   varchar(255))
     SELECT  @Ejercicio = CONVERT(int,Ejercicio)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Ejercicio   varchar(255))
     SELECT  @Periodo = CONVERT(int,Periodo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Periodo   varchar(255))
     SELECT  @FechaRegistro = GETDATE()
     SELECT  @Peso = CONVERT(float , Peso)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Peso   varchar(255))
     SELECT  @Volumen = CONVERT(float , Volumen)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Volumen   varchar(255))
     SELECT  @Paquetes = CONVERT(int,Paquetes)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Paquetes   varchar(255))
     SELECT  @FechaEntrega = CONVERT(datetime,FechaEntrega)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FechaEntrega   varchar(255))
     SELECT  @EmbarqueEstado = NULLIF(EmbarqueEstado,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(EmbarqueEstado   varchar(255))
     SELECT  @Importe = CONVERT(money,Importe)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Importe   varchar(255))
     SELECT  @Logico1 = CONVERT(bit,Logico1)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico1   varchar(255))
     SELECT  @Logico2 = CONVERT(bit,Logico2)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico2   varchar(255))
     SELECT  @Logico3 = CONVERT(bit,Logico3)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico3   varchar(255))
     SELECT  @Logico4 = CONVERT(bit,Logico4)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico4   varchar(255))
     SELECT  @Logico5 = CONVERT(bit,Logico5)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico5   varchar(255))
     SELECT  @Logico6 = CONVERT(bit,Logico6)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico6   varchar(255))
     SELECT  @Logico7 = CONVERT(bit,Logico7)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico7   varchar(255))
     SELECT  @Logico8 = CONVERT(bit,Logico8)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico8   varchar(255))
     SELECT  @Logico9 = CONVERT(bit,Logico9)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico9   varchar(255))
     SELECT  @VerLote = CONVERT(bit,VerLote)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(VerLote   varchar(255))
     SELECT  @EspacioResultado = CONVERT(bit,EspacioResultado)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(EspacioResultado   varchar(255))
     SELECT  @VerDestino = CONVERT(bit,VerDestino)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(VerDestino   varchar(255))
     SELECT  @EstaImpreso = CONVERT(bit,EstaImpreso)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(EstaImpreso   varchar(255))
     SELECT  @Personal = NULLIF(Personal,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Personal   varchar(255))
     SELECT  @Reabastecido = CONVERT(bit,Reabastecido)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Reabastecido   varchar(255))
     SELECT  @Conteo = CONVERT(int,Conteo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Conteo   varchar(255))
     SELECT  @Agente = NULLIF(Agente,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Agente   varchar(255))
     SELECT  @ACRetencion = CONVERT(float , ACRetencion)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(ACRetencion   varchar(255))
     SELECT  @SubModulo = NULLIF(SubModulo,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SubModulo   varchar(255))
     SELECT  @SucursalOrigen = CONVERT(int,SucursalOrigen)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SucursalOrigen   varchar(255))
     SELECT  @SucursalDestino = CONVERT(int,SucursalDestino)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SucursalDestino   varchar(255))
     SELECT  @PedimentoExtraccion = NULLIF(PedimentoExtraccion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(PedimentoExtraccion   varchar(255))
     SELECT  @ReferenciaIntelisisService = NULLIF(ReferenciaIntelisisService,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
      WITH(ReferenciaIntelisisService   varchar(255))
     SELECT  @MovMES = CONVERT(bit,MovMES)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(MovMES   varchar(255))
     SELECT  @Motivo = NULLIF(MotivoRechazo,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(MotivoRechazo   varchar(255))
     SELECT  @ReferenciaMES = NULLIF(ReferenciaMES,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(ReferenciaMES   varchar(255))
     SELECT  @PedidoMES = NULLIF(PedidoMES ,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(PedidoMES    varchar(255))
     SELECT  @IDMES = CONVERT(int,IDMES)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(IDMES   varchar(255)) 
     SELECT  @Serie = NULLIF(Serie ,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Serie    varchar(255)) 
     SELECT  @IDMarcaje = CONVERT(int,IDMarcaje)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(IDMarcaje   varchar(255))                       
   END
  IF @Ok IS NULL
  BEGIN
    SET @Estatus = 'CONFIRMAR'

    SELECT @Empresa = Empresa ,@Sucursal = Sucursal, @SucursalOrigen = Sucursal
      FROM MapeoPlantaIntelisisMes
     WHERE Referencia = @ReferenciaIntelisisService
    SELECT @Sucursal2 = @Sucursal
    --SELECT @Sucursal2 = Sucursal, @SucursalOrigen = Sucursal
    --  FROM PlantaProductiva WHERE Clave =@Planta
    --SELECT @Sucursal = Sucursal FROM Alm WHERE Almacen = @Almacen

    SELECT @CfgReservar = PedidosReservar ,@CfgPosiciones = ISNULL(Posiciones, 0) FROM EmpresaCfg WHERE Empresa = @Empresa

    IF NOT EXISTS(SELECT * FROM Mon WHERE Moneda = @Moneda ) SELECT @Ok = 20196
    IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) SELECT @Ok = 20830
    IF NOT EXISTS(SELECT * FROM Proy WHERE Proyecto = @Proyecto ) AND NULLIF(@Proyecto,'') IS NOT NULL SELECT @Ok = 15010
    IF NOT EXISTS(SELECT * FROM UEN WHERE UEN = @UEN ) AND NULLIF(@UEN,'') IS NOT NULL SELECT @Ok = 10070
    IF NOT EXISTS(SELECT * FROM MovTipo WHERE Mov = @Mov2 ) SELECT @Ok = 14055
    IF NOT EXISTS(SELECT * FROM Sucursal WHERE Sucursal = @Sucursal )SELECT @Ok = 72060
    IF NOT EXISTS(SELECT * FROM Empresa WHERE Empresa =  @Empresa)SELECT @Ok =26070
  END

  IF @Ok IS NULL
  BEGIN
    IF @Almacen NOT IN(SELECT Almacen FROM Alm WHERE Sucursal = @Sucursal)
      SELECT @Almacen = AlmacenPrincipal FROM Sucursal WHERE Sucursal = @Sucursal
    SELECT @OrigenTipo ='I:MES'
    INSERT INTO Inv (Empresa, Mov,   MovID, FechaEmision,   UltimoCambio, Concepto, Proyecto, Actividad,   UEN,   Moneda,   TipoCambio,   Usuario,   Autorizacion,   Referencia, DocFuente, Observaciones, Estatus, Situacion, SituacionFecha, SituacionUsuario,   SituacionNota,   Prioridad, Directo, RenglonID, Almacen,   AlmacenDestino,   AlmacenTransito,   Largo,   FechaRequerida,   Condicion,   Vencimiento, FormaEnvio, OrigenTipo, Origen, OrigenID, Poliza,   PolizaID,   GenerarPoliza, ContID, Ejercicio, Periodo,   FechaRegistro,   FechaConclusion,   FechaCancelacion,   FechaOrigen,   Peso, Volumen, Paquetes, FechaEntrega, EmbarqueEstado,   Sucursal,   Importe,   Logico1, Logico2, Logico3, Logico4, Logico5,   Logico6,   Logico7,   Logico8,   Logico9, VerLote, EspacioResultado,   VerDestino, EstaImpreso,   Personal, Reabastecido,   Conteo, Agente,   ACRetencion, SubModulo,   SucursalOrigen, SucursalDestino,   PedimentoExtraccion, MovMES,Motivo,ReferenciaMES, PedidoMES ,IDMES  ,Serie,IDMarcaje)
           SELECT  @Empresa, @Mov2, @MovID, @FechaEmision, @UltimoCambio, @Concepto, @Proyecto, @Actividad, @UEN, @Moneda, @TipoCambio, @Usuario, @Autorizacion, @Referencia, @DocFuente, @Observaciones, @Estatus, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @Prioridad, @Directo, @RenglonID, @Almacen, @AlmacenDestino, @AlmacenTransito, @Largo, @FechaRequerida, @Condicion, @Vencimiento, @FormaEnvio, @OrigenTipo, @Origen, @OrigenID, @Poliza, @PolizaID, @GenerarPoliza, @ContID, @Ejercicio, @Periodo, @FechaRegistro, @FechaConclusion, @FechaCancelacion, @FechaOrigen, @Peso, @Volumen, @Paquetes, @FechaEntrega, @EmbarqueEstado, ISNULL(@Sucursal,@Sucursal2), @Importe, @Logico1, @Logico2, @Logico3, @Logico4, @Logico5, @Logico6, @Logico7, @Logico8, @Logico9, @VerLote, @EspacioResultado, @VerDestino, @EstaImpreso, @Personal, @Reabastecido, @Conteo, @Agente, @ACRetencion, @SubModulo, @SucursalOrigen, @SucursalDestino, @PedimentoExtraccion, @MovMES,@Motivo,@ReferenciaMES, @PedidoMES  ,@IDMES,@Serie ,@IDMarcaje
    IF @@ERROR <> 0 SET @Ok = 1
    SET @IDGenerar = @@IDENTITY
  END

  SELECT @RenglonSub = 0
  INSERT @Temp2 (  RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario,                   UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion, CostoConsumoMat, CostoManoObra, CostoIndirecto, CostoServicio)
  SELECT          RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, DescripcionUnidad, Factor, ISNULL(CantidadInventario, Cantidad), UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion, CostoConsumoMat, CostoManoObra, CostoIndirecto, CostoServicio
    FROM OPENXML(@iSolicitud, '/Intelisis/Solicitud/Inv/DetalleInv',1)
    WITH (RenglonSub  varchar(100), RenglonID  varchar(100), RenglonTipo  varchar(100), Cantidad  varchar(100), Almacen  varchar(100), Codigo  varchar(100), Articulo  varchar(100), ArticuloDestino  varchar(100), SubCuenta  varchar(100), SubCuentaDestino  varchar(100), Costo  varchar(100), CostoInv  varchar(100), ContUso  varchar(100), Espacio  varchar(100), CantidadReservada  varchar(100), CantidadCancelada  varchar(100), CantidadOrdenada  varchar(100), CantidadPendiente  varchar(100), CantidadA  varchar(100), Paquete  varchar(100), FechaRequerida  varchar(100), Aplica  varchar(100), AplicaID  varchar(100), DestinoTipo  varchar(100), Destino  varchar(100), DestinoID  varchar(100), Cliente  varchar(100), Unidad  varchar(100), Factor  varchar(100), CantidadInventario  varchar(100), UltimoReservadoCantidad  varchar(100), UltimoReservadoFecha  varchar(100), ProdSerieLote  varchar(100), Merma  varchar(100), Desperdicio  varchar(100), Producto  varchar(100), SubProducto  varchar(100), Tipo  varchar(100), Sucursal  varchar(100), Precio  varchar(100), SegundoConteo  varchar(100), DescripcionExtra  varchar(100), AjusteCosteo  varchar(100), CostoUEPS  varchar(100), CostoPEPS  varchar(100), UltimoCosto  varchar(100), PrecioLista  varchar(100), DepartamentoDetallista  varchar(100), AjustePrecioLista  varchar(100), Posicion  varchar(100), SucursalOrigen  varchar(100), Tarima  varchar(100), Seccion  varchar(100), CostoEstandar  varchar(100), FechaCaducidad  varchar(100), CostoPromedio  varchar(100), CostoReposicion varchar(100),ES varchar(100),PR varchar(100),UC varchar(100),MO varchar(100),CI varchar(100),CM varchar(100),MA varchar(100),ReferenciaMES varchar(100),PedidoMES varchar(100),IDMarcaje  varchar(100), DescripcionUnidad varchar(100), CostoConsumoMat float, CostoManoObra float, CostoIndirecto float, CostoServicio float)
  INSERT @Temp (RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario,                   UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion, CostoConsumoMat, CostoManoObra, CostoIndirecto, CostoServicio)
  SELECT        RenglonTipo, SUM(Cantidad), Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario,                   UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion, CostoConsumoMat, CostoManoObra, CostoIndirecto, CostoServicio
    FROM @Temp2
  GROUP BY RenglonTipo, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario,                   UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion, CostoConsumoMat, CostoManoObra, CostoIndirecto, CostoServicio
  INSERT @Tabla (Articulo, SerieLote, Cantidad ,SubCuenta )
  SELECT         Articulo, Lote, Cantidad  ,SubCuenta
    FROM OPENXML(@iSolicitud, '/Intelisis/Solicitud/Inv/SerieLoteMov',1)
    WITH (Articulo  varchar(100), Lote  varchar(100), Cantidad  varchar(100),SubCuenta varchar(100) )
  SET @RenglonIDD =0
  UPDATE @Temp
     SET @RenglonIDD = RenglonID = @RenglonIDD + 1
    FROM @Temp
  SET @RenglonIDD =0
  UPDATE @Tabla
     SET @RenglonIDD = RenglonID = @RenglonIDD + 1
    FROM @Tabla

  IF @OK IS NULL
  BEGIN  
    DECLARE crDetalle CURSOR LOCAL FAST_FORWARD FOR
    SELECT  RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad, Factor, Cantidad*dbo.fnArtUnidadFactor(@Empresa, Articulo, Unidad), UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion,  Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion,CostoConsumoMat, CostoManoObra, CostoIndirecto, CostoServicio ,RenglonID
    FROM @Temp
    SET @Renglon = 0.0
   -- SET @RenglonIDD = 0
    OPEN crDetalle
    FETCH NEXT FROM crDetalle INTO   @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion,  @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion, @CostoConsumoMat, @CostoManoObra, @CostoIndirecto, @CostoServicio,@RenglonID
    WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
    BEGIN

		SELECT @FormaCosteo = FormaCosteo, @TipoCosteo = TipoCosteo FROM EmpresaCfg WHERE Empresa = @Empresa
		SELECT @INFORTipo = INFORTipo FROM Art WHERE Articulo = @Articulo

	    IF @FormaCosteo = 'Articulo'
			SELECT @Cual = TipoCosteo FROM Art WHERE Articulo = @Articulo
        ELSE
			SELECT @Cual = @TipoCosteo
 
        IF UPPER(@Cual) <> 'ESTANDAR' AND @INFORTipo = 'MATERIA PRIMA'
			EXEC spVerCosto @Sucursal, @Empresa, NULL, @Articulo, @SubCuenta, @Unidad, @Cual, @Moneda, @TipoCambio, @Costo OUTPUT, @ConReturn = 0
        ELSE IF UPPER(@Cual) = 'ESTANDAR'
        BEGIN
			SELECT @Costo = @CostoEstandar

			IF NULLIF(@Costo,0.0) IS NULL
				EXEC spVerCosto @Sucursal, @Empresa, NULL, @Articulo, @SubCuenta, @Unidad, @Cual, @Moneda, @TipoCambio, @Costo OUTPUT, @ConReturn = 0
        END
		ELSE
        BEGIN
			SELECT @Costo = ISNULL(NULLIF(@Costo,0.0),@CostoEstandar)

			IF NULLIF(@Costo,0.0) IS NULL
				EXEC spVerCosto @Sucursal, @Empresa, NULL, @Articulo, @SubCuenta, @Unidad, @Cual, @Moneda, @TipoCambio, @Costo OUTPUT, @ConReturn = 0
        END

      IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) SELECT @Ok = 20830
      IF @Cantidad < 0 SET @Ok = 20010
      IF @Costo < 0 SET @Ok = 20140

      SELECT @Aplica = i.Mov, @AplicaID = i.MovID FROM Inv i JOIN MovTipo mt ON i.Mov = mt.Mov AND mt.Modulo = 'INV' WHERE i.ReferenciaMES = @ReferenciaMES AND i.OrigenTipo = @OrigenTipo AND mt.Clave= '' AND i.Estatus = 'PENDIENTE'
--		IF NOT EXISTS(SELECT Almacen FROM Alm WHERE Sucursal = @Sucursal AND Almacen = @AlmacenD) AND @Ok IS NULL
--		  SELECT @AlmacenD = AlmacenPrincipal FROM Sucursal WHERE Sucursal = @Sucursal
      IF @CfgPosiciones = 1
        SELECT @Posicion= DefPosicionRecibo FROM Alm WHERE ISNULL(Ubicaciones,0) = 1 AND NULLIF(DefPosicionRecibo,'') IS NOT NULL AND Almacen = @AlmacenD 
      SELECT @ArtTipo = Tipo FROM Art WHERE Articulo = @Articulo

      EXEC spRenglonTipo @ArtTipo, @Subcuenta, @RenglonTipo OUTPUT

      SET @Renglon = @Renglon + 2048.0
     -- SET @RenglonIDD = @RenglonIDD + 1

	  IF NOT EXISTS(SELECT ID FROM InvD WHERE ID = @IDGenerar AND Articulo = @Articulo)
	  BEGIN
		INSERT InvD (   ID        ,  Renglon,RenglonID,  RenglonSub,  RenglonTipo,  Cantidad,  Almacen,  Codigo,  Articulo,  ArticuloDestino,  SubCuenta,  SubCuentaDestino,  Costo,  CostoInv,  ContUso,  Espacio,  CantidadReservada,  CantidadCancelada,  CantidadOrdenada,  CantidadPendiente,  CantidadA,  Paquete,  FechaRequerida,  Aplica,  AplicaID,  DestinoTipo,  Destino,  DestinoID,  Cliente,  Unidad,  Factor,  CantidadInventario,  UltimoReservadoCantidad,  UltimoReservadoFecha,  ProdSerieLote,  Merma,  Desperdicio,  Producto,  SubProducto,  Tipo,  Sucursal,  Precio,  SegundoConteo,  DescripcionExtra,  AjusteCosteo,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  DepartamentoDetallista,  AjustePrecioLista,  Posicion,  SucursalOrigen,  Tarima,  Seccion,  CostoEstandar,  FechaCaducidad,  CostoPromedio,  CostoReposicion   )
		VALUES         (@IDGenerar, @Renglon,@RenglonID, @RenglonSub,  @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, ISNULL(@Sucursal,@Sucursal2), @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion, @SucursalOrigen, @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion   )
		IF @@ERROR <> 0 SET @Ok = 1
      END
      ELSE
      BEGIN
		UPDATE InvD SET Cantidad = Cantidad + @Cantidad WHERE ID = @IDGenerar AND Articulo = @Articulo
      END

      IF @Ok IS NULL
      BEGIN
          INSERT InvDCosto(ID,Renglon,RenglonID,Articulo,CostoEstandar,CostoServicio, CostoManoObra, CostoIndirecto, CostoMateriales)
          SELECT          @IDGenerar,@Renglon,@RenglonIDD,@Articulo,ISNULL(@Costo,0.0), ISNULL(@CostoServicio,0.0) , ISNULL(@CostoManoObra,0.0) ,ISNULL(@CostoIndirecto,0.0), ISNULL(@CostoConsumoMat,0.0)
      END

      IF @@ERROR <> 0 SET @Ok = 1
      IF @Ok IS NULL AND @CfgReservar = 1 AND @SubClave NOT IN('INV.ER')
      BEGIN
        SELECT @MovVenta = Mov FROM MovTipo WHERE SerieMES = @Serie
        SELECT @IDVenta = @PedidoMES --ID FROM Venta WHERE Mov = @MovVenta AND MovID =@PedidoMES AND Empresa=@Empresa
        IF @IDVenta IS NOT NULL
        BEGIN
          SELECT @RenglonCompra =Renglon,@CantidadVenta=CantidadPendiente FROM VentaD WHERE ID = @IDVenta AND Articulo = @Articulo AND SubCuenta = @SubCuenta

          IF @Cantidad >= @CantidadVenta
          BEGIN
            UPDATE VentaD
              SET CantidadA = @CantidadVenta
             WHERE ID = @IDVenta AND Articulo = @Articulo AND SubCuenta = @SubCuenta
            IF @@ROWCOUNT >0 Set @Reservar =1
          END

          IF @Cantidad < @CantidadVenta
          BEGIN
            UPDATE VentaD
               SET CantidadA = @Cantidad
             WHERE ID = @IDVenta AND Articulo = @Articulo AND SubCuenta = @SubCuenta
            IF @@ROWCOUNT >0 Set @Reservar =1
          END
        END
      END
      FETCH NEXT FROM crDetalle INTO  @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion,  @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion, @CostoConsumoMat, @CostoManoObra, @CostoIndirecto, @CostoServicio,@RenglonID
    END
    CLOSE crDetalle
    DEALLOCATE crDetalle
  END
  IF @Ok IS NULL
  BEGIN
    DECLARE crDetalle2 CURSOR LOCAL FAST_FORWARD FOR
     SELECT a.Articulo,a.SerieLote,a.Cantidad,a.SubCuenta,a.RenglonID
       FROM @Tabla a JOIN Art b ON a.Articulo = b.Articulo
      WHERE b.Tipo  IN ('Lote','Serie')
    OPEN crDetalle2
    FETCH NEXT FROM crDetalle2 INTO  @Articulo2,@Lote,@Cantidad2,@SubCuenta,@UltRenglonID
    WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
    BEGIN
      --SELECT @Lote = NULLIF(@Lote,'(none)')
      SELECT @Tipo2 = Tipo FROM Art WHERE Articulo = @Articulo2

      SELECT @UltRenglonID = ISNULL(MIN(RenglonID), 0) 
	    FROM InvD 
	   WHERE ID = @IDGenerar AND Articulo=@Articulo2 AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')

	  IF @UltRenglonID = 0 set @UltRenglonID = 1
      IF @Lote IS NOT NULL  AND @Tipo2  IN ('Lote','Serie')
      BEGIN
	    BEGIN TRY
			INSERT SerieLoteMov (Empresa,  Modulo, ID,          RenglonID,     Articulo, Cantidad,        SubCuenta,     SerieLote, Sucursal)
			SELECT               @Empresa, 'INV',  @IDGenerar, @UltRenglonID, @Articulo2,@Cantidad2, ISNULL(@SubCuenta,''), @Lote,   ISNULL(@Sucursal,@Sucursal2)
		END TRY
        BEGIN CATCH
			SELECT @Ok = 1, @OkRef = ERROR_MESSAGE()
		END CATCH
      END

      FETCH NEXT FROM crDetalle2 INTO  @Articulo2,@Lote,@Cantidad2,@SubCuenta,@UltRenglonID
    END
    CLOSE crDetalle2
    DEALLOCATE crDetalle2
  END

  BEGIN TRANSACTION

  IF (@Ok IS NULL AND @Estatus = 'CONFIRMAR') -- OR (@Ok IS NULL AND @Estatus = 'CONFIRMAR' AND @IDGenerar IS NOT NULL)
  BEGIN
	BEGIN TRY
		EXEC spAfectar 'INV', @IDGenerar, 'AFECTAR', 'Todo', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
	END TRY
	BEGIN CATCH
		SELECT @Ok = 1, @OkRef = ERROR_MESSAGE()
	END CATCH
  END

  IF @Ok IS NULL AND @Reservar =1 AND @IDVenta IS NOT NULL AND @SubClave NOT IN('INV.ER')
  BEGIN
	BEGIN TRY
		EXEC  spAfectar 'VTAS', @IDVenta, 'RESERVAR', 'Seleccion', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT,  @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
	END TRY
	BEGIN CATCH
		SELECT @Ok = 1, @OkRef = ERROR_MESSAGE()
	END CATCH
  END

-- RJP No es correcto que se liguen todos los movimientos cuya referencia a la OT (@IDMES) sea la de la Entrada de Producto, 
-- Lo anterior porque rompe el estandar de Intelisis y no es real que la Entrada de Producto tenga como origen los Consumos por ejemplo

--  IF @OK IS NULL
 -- BEGIN
 --   SELECT @MovID= MovID , @Mov2= Mov FROM Inv WHERE ID =@IDGenerar
 --   SELECT @NuevoID = ID ,@MovO = Mov, @MoVIDO = MovID FROM Inv WHERE IDMES = @IDMES AND ID <> @IDGenerar
   -- IF @MovIDO IS NOT NULL AND @IDNuevo IS NOT NULL  AND @Mov2 IS NOT NULL
    -- @IDGenerar, @Mov2, @MovID,@MoVIDO
 --   EXEC spMovFlujo @Sucursal, 'AFECTAR', @Empresa, 'INV', @IDGenerar, @Mov2, @MovID, 'INV', @NuevoID, @MovO, @MoVIDO, @Ok OUTPUT
  --END

  IF @Ok IS NULL
  BEGIN
    COMMIT TRANSACTION
  END ELSE
  BEGIN
    ROLLBACK TRANSACTION
    UPDATE Inv SET Estatus = 'BORRADOR' WHERE ID = @IDGenerar
  END

  IF @OK IS NULL  AND EXISTS(SELECT * FROM Inv i JOIN InvD d ON d.ID = i.ID JOIN MovTipo m ON m.Mov = i.Mov AND m.Modulo = 'INV'  JOIN Inv c ON c.ID = @IDGenerar JOIN InvD cd ON c.ID = cd.ID AND cd.Articulo = d.Articulo AND ISNULL(cd.SubCuenta,'') = ISNULL(d.SubCuenta,'') AND ISNULL(cd.Almacen,c.Almacen) = ISNULL(d.Almacen,i.Almacen)  WHERE m.Clave = 'INV.SOL' AND i.Estatus = 'PENDIENTE' AND i.OrigenTipo = 'I:MES' AND ISNULL(d.CantidadPendiente,0.0) > 0 )
  BEGIN
    BEGIN TRANSACTION
    DECLARE crArt CURSOR LOCAL FAST_FORWARD FOR
     SELECT d.Articulo, d.Cantidad, d.SubCuenta, d.Unidad, ISNULL(d.Almacen,c.Almacen), ISNULL(d.Posicion,'')
       FROM Inv c JOIN InvD d ON c.ID = d.ID
      WHERE c.ID = @IDGenerar
    OPEN crArt
    FETCH NEXT FROM crArt INTO  @ArticuloO, @CantidadO, @SubCuentaO, @UnidadO, @AlmacenO, @Posicion
    WHILE @@FETCH_STATUS <> -1
    BEGIN
      SELECT @CantidadReservar = (@CantidadO * dbo.fnArtUnidadFactor(@Empresa, @ArticuloO, @UnidadO))
      DECLARE crSolicitudInv CURSOR LOCAL FAST_FORWARD FOR  
       SELECT d.ID, d.Renglon, d.CantidadPendiente, d.Unidad, ISNULL(d.Posicion,'')
         FROM Inv i JOIN InvD d ON d.ID = i.ID JOIN MovTipo m ON m.Mov = i.Mov AND m.Modulo = 'INV'
        WHERE m.Clave = 'INV.SOL'
          AND i.Estatus = 'PENDIENTE'
          AND i.OrigenTipo = 'I:MES'
          AND ISNULL(d.CantidadPendiente,0.0) > 0 
          AND d.Articulo = @ArticuloO
          AND ISNULL(d.SubCuenta,'') = ISNULL(@SubCuenta,'')
          AND ISNULL(d.Almacen,i.Almacen) = @AlmacenO
          AND ISNULL(d.Posicion,'') = @Posicion
      ORDER BY d.FechaRequerida, i.ID
      OPEN crSolicitudInv
      FETCH NEXT FROM crSolicitudInv INTO  @IDSol, @RenglonO, @CantidadPendienteO, @UnidadPO, @PosicionO
      WHILE @@FETCH_STATUS <> -1 AND @CantidadReservar > 0 AND @Ok IS NULL
      BEGIN

        IF @CantidadReservar>= (@CantidadPendienteO * dbo.fnArtUnidadFactor(@Empresa, @ArticuloO, @UnidadPO))
        BEGIN
          UPDATE InvD SET CantidadA = Cantidad WHERE ID = @IDSol AND Renglon = @RenglonO
          SET @CantidadReservar = @CantidadReservar - (@CantidadPendienteO * dbo.fnArtUnidadFactor(@Empresa, @ArticuloO, @UnidadPO))
          IF @@ROWCOUNT <> 0
            EXEC  spAfectar 'INV', @IDSol, 'RESERVAR', 'Seleccion', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
        END
        ELSE
        BEGIN
          UPDATE InvD
             SET CantidadA = (@CantidadReservar * dbo.fnArtUnidadFactor(@Empresa, @ArticuloO, @UnidadO))* dbo.fnArtUnidadFactor(@Empresa, @ArticuloO, @UnidadPO)
           WHERE ID = @IDSol AND Renglon = @RenglonO

          IF @@ROWCOUNT <> 0
            EXEC  spAfectar 'INV', @IDSol, 'RESERVAR', 'Seleccion', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
          SET @CantidadReservar = 0
        END

        FETCH NEXT FROM crSolicitudInv INTO @IDSol, @RenglonO, @CantidadPendienteO, @UnidadPO, @PosicionO
      END
      CLOSE crSolicitudInv
      DEALLOCATE crSolicitudInv

      FETCH NEXT FROM crArt INTO @ArticuloO, @CantidadO, @SubCuentaO, @UnidadO, @AlmacenO, @Posicion
    END
    CLOSE crArt
    DEALLOCATE crArt
    IF @Ok IS NULL
    BEGIN
      COMMIT TRANSACTION
    END ELSE
    BEGIN
      ROLLBACK TRANSACTION
    END 
  END

  IF @OK IS NULL AND @CfgReservar = 1 AND EXISTS(SELECT * FROM Venta v JOIN VentaD d ON d.ID = v.ID JOIN MovTipo m ON m.Mov = v.Mov AND m.Modulo = 'VTAS' JOIN InvD i ON i.Articulo = d.Articulo AND ISNULL(i.SubCuenta,'') = ISNULL(d.SubCuenta,'') AND i.ID = @IDGenerar WHERE m.Clave = 'VTAS.P' AND v.Estatus = 'PENDIENTE'  AND d.CantidadPendiente > 0 )
  BEGIN
  BEGIN TRANSACTION
    DECLARE crArt CURSOR LOCAL FAST_FORWARD FOR      
     SELECT d.Articulo, d.Cantidad, d.SubCuenta, d.Unidad, d.Almacen
       FROM Inv i JOIN InvD d ON i.ID = d.ID WHERE i.ID = @IDGenerar
    OPEN crArt
    FETCH NEXT FROM crArt INTO  @ArticuloD, @CantidadD, @SubCuentaD, @UnidadD, @AlmacenDD
    WHILE @@FETCH_STATUS <> -1
    BEGIN
      SELECT @CantidadResta = (@CantidadD * dbo.fnArtUnidadFactor(@Empresa, @ArticuloD, @UnidadD))
      DECLARE crPedido CURSOR LOCAL FAST_FORWARD FOR 
       SELECT d.ID, d.Renglon, d.CantidadPendiente, d.Unidad, ISNULL(d.Almacen,v.Almacen)
         FROM Venta v JOIN VentaD d ON d.ID = v.ID JOIN MovTipo m ON m.Mov = v.Mov AND m.Modulo = 'VTAS'
        WHERE m.Clave = 'VTAS.P'
          AND v.Estatus = 'PENDIENTE'
          AND ISNULL(d.CantidadPendiente,0.0) > 0
          AND d.Articulo = @ArticuloD
          AND ISNULL(d.SubCuenta,'') = ISNULL(@SubCuenta,'')
          AND ISNULL(d.Almacen,v.Almacen) = @AlmacenDD
      ORDER BY d.FechaRequerida DESC, v.ID
      OPEN crPedido
      FETCH NEXT FROM crPedido INTO  @IDPedido, @RenglonD, @CantidadPendiente, @UnidadP, @AlmacenP
      WHILE @@FETCH_STATUS <> -1 AND @CantidadResta > 0
      BEGIN

        IF @CantidadResta>= (@CantidadPendiente * dbo.fnArtUnidadFactor(@Empresa, @ArticuloD, @UnidadP))
        BEGIN
		/*ARL 26Ene2015 */
--        UPDATE VentaD SET CantidadA = Cantidad WHERE ID = @IDPedido AND Renglon = @RenglonD
          UPDATE VentaD SET CantidadA = CantidadPendiente WHERE ID = @IDPedido AND Renglon = @RenglonD
          SET @CantidadResta = @CantidadResta - (@CantidadPendiente * dbo.fnArtUnidadFactor(@Empresa, @ArticuloD, @UnidadP))
        END
        ELSE
        BEGIN
          UPDATE VentaD
             SET CantidadA = (@CantidadResta * dbo.fnArtUnidadFactor(@Empresa, @ArticuloD, @UnidadD))* dbo.fnArtUnidadFactor(@Empresa, @ArticuloD, @UnidadP)
           WHERE ID = @IDPedido AND Renglon = @RenglonD
           SET @CantidadResta = 0
        END
        EXEC  spAfectar 'VTAS', @IDPedido, 'RESERVAR', 'Seleccion', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT,  @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion

        FETCH NEXT FROM crPedido INTO @IDPedido, @RenglonD, @CantidadPendiente, @UnidadP, @AlmacenP    
      END
      CLOSE crPedido
      DEALLOCATE crPedido
      FETCH NEXT FROM crArt INTO @ArticuloD, @CantidadD, @SubCuentaD, @UnidadD, @AlmacenDD
    END
    CLOSE crArt
    DEALLOCATE crArt
    
	IF @Ok IS NULL
	BEGIN
		COMMIT TRANSACTION
	END ELSE
	BEGIN
		ROLLBACK TRANSACTION
		UPDATE Inv SET Estatus = 'BORRADOR' WHERE ID = @IDGenerar
	END
  END

  IF @Ok IS NULL
  SELECT @ReferenciaIS = Referencia
    FROM IntelisisService
   WHERE ID = @ID

    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + ' Modulo="INV" ModuloID =' + CHAR(34) + ISNULL(CONVERT(varchar,@IDGenerar),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'

END
GO
/**************** spISIntelisisCOMSInsertarMovCOMS_O ****************/
if exists (select * from sysobjects where id = object_id('dbo.spISIntelisisCOMSInsertarMovCOMS_O') and type = 'P') drop procedure dbo.spISIntelisisCOMSInsertarMovCOMS_O
GO            
CREATE PROCEDURE spISIntelisisCOMSInsertarMovCOMS_O
                               @ID                                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                       int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
      @IDGenerar                  int,
      @IDAcceso                 int,            
      @MovTipo                                     varchar(20),
      @ReferenciaIS                              varchar(100),
      @Usuario2                                     varchar(10),
      @Estacion                                      int,
      @SubReferencia                          varchar(100),
      @Empresa                                     varchar(5),          
      @Mov                                             varchar(20),        
      @Mov2                                           varchar(20),        
      @MovID                                         varchar(20),        
      @FechaEmision                           datetime,            
      @UltimoCambio                          datetime,            
      @Concepto                   varchar(50),        
      @Proyecto                      varchar(50),        
      @Actividad                    varchar(100),     
      @UEN                                             int,         
      @Moneda                                     varchar(10),        
      @TipoCambio                              float,     
      @Usuario                                       varchar(10),        
      @Autorizacion                              varchar(10),        
      @Referencia                  varchar(50),        
      @DocFuente                                 int,         
      @Observaciones                          varchar(100),     
      @Estatus                                        varchar(15),        
      @Situacion                    varchar(50),        
      @SituacionFecha                        datetime,            
      @SituacionUsuario      varchar(10),        
      @SituacionNota                           varchar(100),     
      @Directo                                        bit,         
      @VerDestino                                 bit,         
      @Prioridad                     varchar(10),        
      @Proveedor                  varchar(10),        
      @FormaEnvio                               varchar(50),        
      @FechaRequerida                      datetime,            
      @Almacen                                     varchar(10),        
      @Condicion                  varchar(50),        
      @Vencimiento                             datetime,            
      @Manejo                                       money, 
      @Fletes                                          money, 
      @ActivoFijo                   bit,         
      @Instruccion                 varchar(50),        
      @Agente                                       varchar(10),        
      @Descuento                  varchar(30),        
      @DescuentoGlobal                     float,     
      @Importe                       money, 
      @Impuestos                   money, 
      @Saldo                                           money, 
      @DescuentoLineal      money, 
      @OrigenTipo                                varchar(10),        
      @Origen                                        varchar(20),        
      @OrigenID                     varchar(20),        
      @Poliza                                          varchar(20),        
      @PolizaID                       varchar(20),        
      @GenerarPoliza                           bit,         
      @ContID                                        int,         
      @Ejercicio                      int,         
      @Periodo                                       int,         
      @FechaRegistro                           datetime,            
      @FechaConclusion                     datetime,            
      @FechaCancelacion   datetime,            
      @Peso                                             float,     
      @Volumen                                    float,     
      @Conciliado                  bit,         
      @Causa                                          varchar(50),        
      @Atencion                     varchar(50),        
      @FechaEntrega                           datetime,            
      @EmbarqueEstado                     varchar(50),        
      @Sucursal                      int,         
      @Sucursal2                    int,         
      @ZonaImpuesto                          varchar(30),        
      @Paquetes                    int,         
      @Idioma                                        varchar(50),        
      @IVAFiscal                     float,     
      @IEPSFiscal                   float,     
      @ListaPreciosEsp                         varchar(20),        
      @EstaImpreso                               bit,         
      @Mensaje                                     int,         
      @Logico1                                       bit,         
      @Logico2                                       bit,         
      @Logico3                                       bit,         
      @Logico4                                       bit,         
      @Logico5                                       bit,         
      @Logico6                                       bit,         
      @Logico7                                       bit,         
      @Pagado                                       float,     
      @ProrrateoAplicaID     int,         
      @FormaEntrega                          varchar(50),        
      @CancelarPendiente                 bit,         
      @LineaCredito                             varchar(20),        
      @TipoAmortizacion     varchar(20),        
      @TipoTasa                     varchar(20),        
      @Comisiones                                money, 
      @ComisionesIVA                          money, 
      @OperacionRelevante               bit,         
      @VIN                                               varchar(20),        
      @SubModulo                                varchar(5),          
      @AutoCargos                                float,     
      @TieneTasaEsp                           bit,         
      @TasaEsp                                      float,     
      @Cliente                                        varchar(10),        
      @SucursalOrigen                         int,         
      @SucursalDestino                        int,         
      @ContUso                                     varchar(20),        
      @ContUso2                   varchar(20),        
      @ContUso3                   varchar(20),        
      @ContratoID                 int,         
      @ContratoMov                             varchar(20),        
      @ContratoMovID                         varchar(20),        
      @ReferenciaMES                         varchar(50),        
------detalle
     @IDD                                               int   ,
     @Renglon                       float   ,
     @RenglonSub                               int   ,
     @RenglonID                                  int   ,
     @RenglonTipo                              char(1),
     @Cantidad                     float   ,
     @AlmacenD                                   varchar(10),
     @Codigo                                         varchar(30),
     @Articulo                         varchar(20),
     @SubCuenta                                 varchar(50),
     @FechaRequeridaD                    datetime   ,
     @FechaOrdenarD                        datetime   ,
     @FechaEntregaD                         datetime   ,
     @Costo                                            float   ,
     @Impuesto1                                   float   ,
     @Impuesto2                                   float   ,
     @Impuesto3                                   float   ,
     @Retencion1                                 float   ,
     @Retencion2                                 float   ,
     @Retencion3                                 float   ,
     @DescuentoD                               varchar(30),
     @DescuentoTipo                          char(1),
     @DescuentoLinea        money   ,
     @DescuentoImporte                    money   ,
     @DescripcionExtra       varchar(100),
     @ReferenciaExtra         varchar(50),
     @ContUsoD                    varchar(20),
     @DestinoTipo                                varchar(10),
     @Destino                        varchar(20),
     @DestinoID                    varchar(20),
     @Aplica                                           varchar(20),
     @AplicaID                       varchar(20),
     @CantidadPendiente                 float   ,
     @CantidadCancelada                float   ,
     @CantidadA                                  float   ,
     @CostoInv                      float   ,
     @Unidad                                        varchar(50),
     @Factor                                           float   ,
     @CantidadInventario                 float   ,
     @ClienteD                      varchar(10),
     @ServicioArticulo          varchar(20),
     @ServicioSerie                              varchar(20),
     @Paquete                       int   ,
     @SucursalD                    int   ,
     @ImportacionProveedor            varchar(10),
     @ImportacionReferencia            varchar(50),
     @ProveedorRef                             varchar(10),
     @AgenteRef                                  varchar(10),
     @EstadoRef                    varchar(50),
     @FechaCaducidad                      datetime   ,
     @ProveedorArt                              varchar(10),
     @ProveedorArtCosto   float   ,
     @AjusteCosteo                              money   ,
     @CostoUEPS                                  money   ,
     @CostoPEPS                                   money   ,
     @UltimoCosto                                money   ,
     @PrecioLista                                   money   ,
     @Posicion                       varchar(10),
     @DepartamentoDetallista         int   ,
     @Pais                                               varchar(50),
     @TratadoComercial     varchar(50),
     @ProgramaSectorial   varchar(50),
     @ValorAduana                              money   ,
     @ImportacionImpuesto1            float   ,
     @ImportacionImpuesto2            float   ,
     @ID1                                char(2),
     @ID2                                char(2),
     @FormaPago                                 varchar(50),
     @EsEstadistica                               bit   ,
     @PresupuestoEsp                         bit   ,
     @SucursalOrigenD                       int   ,
     @ContUso2D                                 varchar(20),
     @ContUso3D                                 varchar(20),
     @Tarima                                         varchar(20),
     @EmpresaRef                                varchar(5),
     @Categoria                    varchar(50),
     @Estado                                          varchar(30),
     @CostoEstandar                           money   ,
     @ABC                                               varchar(50),
     @PaqueteCantidad     float   ,
     @CantidadEmbarcada               float   ,
     @ClavePresupuestal   varchar(50),
     @TipoImpuesto1                          varchar(10),
     @TipoImpuesto2                          varchar(10),
     @TipoImpuesto3                          varchar(10),
     @TipoRetencion1                         varchar(10),
     @TipoRetencion2                         varchar(10),
     @TipoRetencion3                         varchar(10),
     @CostoConImpuesto                   float   ,
     @TipoImpuesto4                          varchar(10),
     @CostoPromedio                          money   ,
     @CostoReposicion        money   ,
     @TipoImpuesto5                          varchar(10),
     @Impuesto5                                   float   ,
     @ArtTipo                                         varchar(20),
     @Decimales                                   int,
     @ReferenciaIntelisisService    varchar(50),
     @MovIntelisisMES                        varchar(10),
     @MovMoneda                                              varchar(10),
     @MovTipoCambio                       float,
     @MovZonaImpuesto                   varchar(30),
     @ArtImpuesto1                             float,
     @ArtImpuesto2                             float,
     @ArtImpuesto3                             money,
     @ArtRetencion1                            float,
     @ArtRetencion2                            float,
     @ArtRetencion3                            float,
     @CfgCompraCostoSugerido     char(20),
     @CfgMultiUnidades                    bit,
     @CfgMultiUnidadesNivel          char(20),
     @CantidadOrden             float,
     @Planta                                          varchar(20)



  DECLARE @Temp                table
         (
  IDD                                      int   ,
  Renglon                                             float   ,
  RenglonSub                                      int   ,
  RenglonID                                         int   ,
  RenglonTipo                                     char(1),
  Cantidad                                           float   ,
  Almacen                                            varchar(10),
  Codigo                                               varchar(30),
  Articulo                                               varchar(20),
  SubCuenta                                        varchar(50),
  FechaRequerida                              datetime   ,
  FechaOrdenar                                  datetime   ,
  FechaEntrega                                  datetime   ,
  Costo                                                   float   ,
  Impuesto1                                         float   ,
  Impuesto2                                         float   ,
  Impuesto3                                         float   ,
  Retencion1                                        float   ,
  Retencion2                                        float   ,
  Retencion3                                        float   ,
  Descuento                                         varchar(30),
  DescuentoTipo                                 char(1),
  DescuentoLinea                                                      money   ,
  DescuentoImporte                                                  money   ,
  DescripcionExtra                                                     varchar(100),
  ReferenciaExtra                        varchar(50),
  ContUso                                             varchar(20),
  DestinoTipo                                                      varchar(10),
  Destino                                               varchar(20),
  DestinoID                                           varchar(20),
  Aplica                                                 varchar(20),
  AplicaID                                             varchar(20),
  CantidadPendiente                                               float   ,
  CantidadCancelada                                              float   ,
  CantidadA                                         float   ,
  CostoInv                                             float   ,
  Unidad                                               varchar(50),
  Factor                                                 float   ,
  CantidadInventario                                               float   ,
  Cliente                                                varchar(10),
  ServicioArticulo                         varchar(20),
  ServicioSerie                                                    varchar(20),
  Paquete                                             int   ,
  Sucursal                                              int   ,
  ImportacionProveedor                                          varchar(10),
  ImportacionReferencia                                          varchar(50),
  ProveedorRef                                                   varchar(10),
  AgenteRef                                         varchar(10),
  EstadoRef                                          varchar(50),
  FechaCaducidad                             datetime   ,
  ProveedorArt                                                    varchar(10),
  ProveedorArtCosto                                                 float   ,
  AjusteCosteo                                                    money   ,
  CostoUEPS                                         money   ,
  CostoPEPS                                         money   ,
  UltimoCosto                                                      money   ,
  PrecioLista                          money   ,
  Posicion                                              varchar(10),
  DepartamentoDetallista                                       int   ,
  Pais                                      varchar(50),
  TratadoComercial                                                   varchar(50),
  ProgramaSectorial                                          varchar(50),
  ValorAduana                                                    money   ,
  ImportacionImpuesto1                                          float   ,
  ImportacionImpuesto2                                          float   ,
  ID1                                                       char(2),
  ID2                                                       char(2),
  FormaPago                                       varchar(50),
  EsEstadistica                                                     bit   ,
  PresupuestoEsp                                bit   ,
  SucursalOrigen                                 int   ,
  ContUso2                                           varchar(20),
  ContUso3                                           varchar(20),
  Tarima                                                varchar(20),
  EmpresaRef                                       varchar(5),
  Categoria                                           varchar(50),
  Estado                                                varchar(30),
  CostoEstandar                                  money   ,
  ABC                                      varchar(50),
  PaqueteCantidad                                                   float   ,
  CantidadEmbarcada                                             float   ,
  ClavePresupuestal                                                  varchar(50),
  TipoImpuesto1                                 varchar(10),
  TipoImpuesto2                                 varchar(10),
  TipoImpuesto3                                 varchar(10),
  TipoRetencion1                               varchar(10),
  TipoRetencion2                               varchar(10),
  TipoRetencion3                               varchar(10),
  CostoConImpuesto                                                 float   ,
  TipoImpuesto4                                 varchar(10),
  CostoPromedio                                 money   ,
  CostoReposicion                                                      money   ,
  TipoImpuesto5                                 varchar(10),
  Impuesto5                                         float ,
  MovIntelisisMES                               varchar(10)

         )



  SELECT @IDAcceso = dbo.fnAccesoID(@@SPID)

  SELECT @Estacion = EstacionTrabajo ,@Usuario2 = Usuario FROM Acceso WHERE ID = @IDAcceso

  IF @Ok IS NULL
  BEGIN
    SELECT @Mov =  NULLIF(Mov,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH (Mov varchar(255))


    IF @@ERROR <> 0 SET @Ok = 1
  END

  IF @Ok IS NULL
  SELECT @Mov2 = Mov FROM MapeoMovimientosInforIntelisis WHERE INFORMov = @Mov
    SELECT @MovTipo = Clave
                  FROM MovTipo
     WHERE Modulo = 'COMS' AND Mov = @Mov


  IF @MovTipo <> 'COMS.O' SELECT @Ok = 35005, @OkRef = @Mov

  IF @Ok IS NULL
  BEGIN 


    SELECT @Mov = NULLIF(Mov,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Mov  varchar(255))
    SELECT @MovID = NULLIF(MovID,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(MovID  varchar(255))
    SELECT @FechaEmision  = dbo.fnFechaSinHora(GETDATE())
    SELECT @UltimoCambio  = CONVERT(datetime,UltimoCambio)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(UltimoCambio  varchar(255))
    SELECT @Concepto = NULLIF(Concepto,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Concepto  varchar(255))
    SELECT @Proyecto = NULLIF(Proyecto,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Proyecto  varchar(255))
    SELECT @Actividad = NULLIF(Actividad,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Actividad  varchar(255))
    SELECT @UEN   = CONVERT(int ,UEN)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(UEN  varchar(255))
    SELECT @Moneda = NULLIF(Moneda,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Moneda  varchar(255))
    SELECT @TipoCambio   = CONVERT(float,TipoCambio)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(TipoCambio  varchar(255))
    SELECT @Usuario = NULLIF(Usuario,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Usuario  varchar(255))
    SELECT @Autorizacion = NULLIF(Autorizacion,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Autorizacion  varchar(255))
    SELECT @Referencia = NULLIF(Referencia,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Referencia  varchar(255))
    SELECT @DocFuente   = CONVERT(int ,DocFuente)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(DocFuente  varchar(255))
    SELECT @Observaciones = NULLIF(Observaciones,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Observaciones  varchar(255))
    SELECT @Estatus = NULLIF(Estatus,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Estatus  varchar(255))
    SELECT @Situacion = NULLIF(Situacion,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Situacion  varchar(255))
    SELECT @SituacionFecha  = CONVERT(datetime,SituacionFecha)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(SituacionFecha  varchar(255))
    SELECT @SituacionUsuario = NULLIF(SituacionUsuario,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(SituacionUsuario  varchar(255))
    SELECT @SituacionNota = NULLIF(SituacionNota,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(SituacionNota  varchar(255))
    SELECT @Directo  = CONVERT(bit,Directo)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Directo  varchar(255))
    SELECT @VerDestino  = CONVERT(bit,VerDestino)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(VerDestino  varchar(255))
    SELECT @Prioridad = NULLIF(Prioridad,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Prioridad  varchar(255))
    SELECT @RenglonID   = CONVERT(int ,RenglonID)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(RenglonID  varchar(255))
    SELECT @Proveedor = NULLIF(Proveedor,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Proveedor  varchar(255))
    SELECT @FormaEnvio = NULLIF(FormaEnvio,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(FormaEnvio  varchar(255))
    SELECT @FechaRequerida  = CONVERT(datetime,FechaRequerida)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(FechaRequerida  varchar(255))
    SELECT @Almacen = NULLIF(Almacen,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Almacen  varchar(255))
    SELECT @Condicion = NULLIF(Condicion,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Condicion  varchar(255))
    SELECT @Vencimiento  = CONVERT(datetime,Vencimiento)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Vencimiento  varchar(255))
    SELECT @Manejo   = CONVERT(money ,Manejo)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Manejo  varchar(255))
    SELECT @Fletes   = CONVERT(money ,Fletes)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Fletes  varchar(255))
    SELECT @ActivoFijo  = CONVERT(bit,ActivoFijo)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ActivoFijo  varchar(255))
    SELECT @Instruccion = NULLIF(Instruccion,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Instruccion  varchar(255))
    SELECT @Agente = NULLIF(Agente,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Agente  varchar(255))
    SELECT @Descuento = NULLIF(Descuento,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Descuento  varchar(255))
    SELECT @DescuentoGlobal   = CONVERT(float,DescuentoGlobal)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(DescuentoGlobal  varchar(255))
    SELECT @Importe   = CONVERT(money ,Importe)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Importe  varchar(255))
    SELECT @Impuestos   = CONVERT(money ,Impuestos)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Impuestos  varchar(255))
    SELECT @Saldo   = CONVERT(money ,Saldo)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Saldo  varchar(255))
    SELECT @DescuentoLineal   = CONVERT(money ,DescuentoLineal)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(DescuentoLineal  varchar(255))
    SELECT @OrigenTipo = NULLIF(OrigenTipo,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(OrigenTipo  varchar(255))
    SELECT @Origen = NULLIF(Origen,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Origen  varchar(255))
    SELECT @OrigenID = NULLIF(OrigenID,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(OrigenID  varchar(255))
    SELECT @Poliza = NULLIF(Poliza,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Poliza  varchar(255))
    SELECT @PolizaID = NULLIF(PolizaID,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(PolizaID  varchar(255))
    SELECT @GenerarPoliza  = CONVERT(bit,GenerarPoliza)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(GenerarPoliza  varchar(255))
    SELECT @ContID   = CONVERT(int ,ContID)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContID  varchar(255))
    SELECT @Ejercicio   = CONVERT(int ,Ejercicio)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Ejercicio  varchar(255))
    SELECT @Periodo   = CONVERT(int ,Periodo)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Periodo  varchar(255))
    SELECT @FechaRegistro  = GETDATE()
    SELECT @Peso   = CONVERT(float,Peso)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Peso  varchar(255))
    SELECT @Volumen   = CONVERT(float,Volumen)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Volumen  varchar(255))
    SELECT @Conciliado  = CONVERT(bit,Conciliado)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Conciliado  varchar(255))
    SELECT @Causa = NULLIF(Causa,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Causa  varchar(255))
    SELECT @Atencion = NULLIF(Atencion,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Atencion  varchar(255))
    SELECT @FechaEntrega  = CONVERT(datetime,FechaEntrega)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(FechaEntrega  varchar(255))
    SELECT @EmbarqueEstado = NULLIF(EmbarqueEstado,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(EmbarqueEstado  varchar(255))
    SELECT @ZonaImpuesto = NULLIF(ZonaImpuesto,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ZonaImpuesto  varchar(255))
    SELECT @Paquetes   = CONVERT(int ,Paquetes)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Paquetes  varchar(255))
    SELECT @Idioma = NULLIF(Idioma,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Idioma  varchar(255))
    SELECT @IVAFiscal   = CONVERT(float,IVAFiscal)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(IVAFiscal  varchar(255))
    SELECT @IEPSFiscal   = CONVERT(float,IEPSFiscal)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(IEPSFiscal  varchar(255))
    SELECT @ListaPreciosEsp = NULLIF(ListaPreciosEsp,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ListaPreciosEsp  varchar(255))
   SELECT @EstaImpreso  = CONVERT(bit,EstaImpreso)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(EstaImpreso  varchar(255))
    SELECT @Mensaje   = CONVERT(int ,Mensaje)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Mensaje  varchar(255))
    SELECT @Logico1  = CONVERT(bit,Logico1)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico1  varchar(255))
    SELECT @Logico2  = CONVERT(bit,Logico2)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico2  varchar(255))
    SELECT @Logico3  = CONVERT(bit,Logico3)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico3  varchar(255))
    SELECT @Logico4  = CONVERT(bit,Logico4)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico4  varchar(255))
    SELECT @Logico5  = CONVERT(bit,Logico5)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico5  varchar(255))
    SELECT @Logico6  = CONVERT(bit,Logico6)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico6  varchar(255))
    SELECT @Logico7  = CONVERT(bit,Logico7)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico7  varchar(255))
    SELECT @Pagado   = CONVERT(float,Pagado)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Pagado  varchar(255))
    SELECT @ProrrateoAplicaID   = CONVERT(int ,ProrrateoAplicaID)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ProrrateoAplicaID  varchar(255))
    SELECT @FormaEntrega = NULLIF(FormaEntrega,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(FormaEntrega  varchar(255))
    SELECT @CancelarPendiente  = CONVERT(bit,CancelarPendiente)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(CancelarPendiente  varchar(255))
    SELECT @LineaCredito = NULLIF(LineaCredito,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(LineaCredito  varchar(255))
    SELECT @TipoAmortizacion = NULLIF(TipoAmortizacion,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(TipoAmortizacion  varchar(255))
    SELECT @TipoTasa = NULLIF(TipoTasa,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(TipoTasa  varchar(255))
    SELECT @Comisiones   = CONVERT(money ,Comisiones)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Comisiones  varchar(255))
    SELECT @ComisionesIVA   = CONVERT(money ,ComisionesIVA)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ComisionesIVA  varchar(255))
    SELECT @OperacionRelevante  = CONVERT(bit,OperacionRelevante)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(OperacionRelevante  varchar(255))
    SELECT @VIN = NULLIF(VIN,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(VIN  varchar(255))
    SELECT @SubModulo = NULLIF(SubModulo,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(SubModulo  varchar(255))
    SELECT @AutoCargos   = CONVERT(float,AutoCargos)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(AutoCargos  varchar(255))
    SELECT @TieneTasaEsp  = CONVERT(bit,TieneTasaEsp)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(TieneTasaEsp  varchar(255))
    SELECT @TasaEsp   = CONVERT(float,TasaEsp)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(TasaEsp  varchar(255))
    SELECT @Cliente = NULLIF(Cliente,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Cliente  varchar(255))
    SELECT @SucursalOrigen   = CONVERT(int ,SucursalOrigen)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(SucursalOrigen  varchar(255))
    SELECT @SucursalDestino   = CONVERT(int ,SucursalDestino)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(SucursalDestino varchar(255))
    SELECT @ContUso = NULLIF(ContUso,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContUso  varchar(255))
    SELECT @ContUso2 = NULLIF(ContUso2,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContUso2  varchar(255))
    SELECT @ContUso3 = NULLIF(ContUso3,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContUso3  varchar(255))
    SELECT @ContratoID   = CONVERT(int ,ContratoID)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContratoID  varchar(255))
    SELECT @ContratoMov = NULLIF(ContratoMov,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContratoMov  varchar(255))  
    SELECT @ContratoMovID = NULLIF(ContratoMovID,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContratoMovID  varchar(255))  
    SELECT @ReferenciaIntelisisService = NULLIF(ReferenciaIntelisisService,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ReferenciaIntelisisService  varchar(255))
    SELECT @MovIntelisisMES =  NULLIF(MovIntelisisMES,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH (MovIntelisisMES varchar(255))
    SELECT @ReferenciaMES =  NULLIF(ReferenciaMES,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH (ReferenciaMES varchar(255))     





   END

  IF @Ok IS NULL
  BEGIN 


    IF NOT EXISTS(SELECT * FROM Prov WHERE Proveedor = @Proveedor ) SELECT @Ok = 26050
    IF NOT EXISTS(SELECT * FROM Mon WHERE Moneda = @Moneda ) SELECT @Ok = 20196
    IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) SELECT @Ok = 20830
    IF NOT EXISTS(SELECT * FROM Proy WHERE Proyecto = @Proyecto ) AND NULLIF(@Proyecto,'') IS NOT NULL SELECT @Ok = 15010
    IF NOT EXISTS(SELECT * FROM UEN WHERE UEN = @UEN ) AND NULLIF(@UEN,'') IS NOT NULL SELECT @Ok = 10070
    IF NOT EXISTS(SELECT * FROM MovTipo WHERE Modulo = 'COMS' AND Mov = @Mov ) SELECT @Ok = 14055

    SELECT @Empresa = Empresa ,@Sucursal = Sucursal, @SucursalOrigen = Sucursal
      FROM MapeoPlantaIntelisisMes
     WHERE Referencia = @ReferenciaIntelisisService
     SELECT @Sucursal2 = @Sucursal
    --SELECT @Sucursal2 = Sucursal, @SucursalOrigen = Sucursal
    --  FROM PlantaProductiva WHERE Clave =@Planta 
    --SELECT @Sucursal = Sucursal FROM Alm WHERE Almacen = @Almacen

  END

  IF @Ok IS NULL
  BEGIN
    IF @Almacen NOT IN(SELECT Almacen FROM Alm WHERE Sucursal = @Sucursal)
      SELECT @Almacen = AlmacenPrincipal FROM Sucursal WHERE Sucursal = @Sucursal
    SELECT @OrigenTipo='I:MES'
    SELECT @Moneda = m.Moneda,
         @TipoCambio = m.TipoCambio,
         @CfgCompraCostoSugerido = cfg.CompraCostoSugerido
    FROM EmpresaCfg cfg, Mon m
   WHERE Empresa = @Empresa AND m.Moneda = cfg.ContMoneda
   SET @Estatus = 'CONFIRMAR'
    INSERT INTO Compra (Empresa,  Mov,  MovID,  FechaEmision,  UltimoCambio,  Concepto,  Proyecto,  Actividad,  UEN,  Moneda,  TipoCambio,  Usuario,  Autorizacion,  Referencia,  DocFuente,  Observaciones,  Estatus,  Situacion,  SituacionFecha,  SituacionUsuario,  SituacionNota,  Directo,  VerDestino,  Prioridad,  RenglonID,  Proveedor,  FormaEnvio,  FechaRequerida,  Almacen,  Condicion,  Vencimiento,  Manejo,  Fletes,  ActivoFijo,  Instruccion,  Agente,  Descuento,  DescuentoGlobal,  Importe,  Impuestos,  Saldo,  DescuentoLineal,  OrigenTipo,  Origen,  OrigenID,  Poliza,  PolizaID,  GenerarPoliza,  ContID,  Ejercicio,  Periodo,  FechaRegistro,  FechaConclusion,  FechaCancelacion,  Peso,  Volumen,  Conciliado,  Causa,  Atencion,  FechaEntrega,  EmbarqueEstado,  Sucursal,  ZonaImpuesto,  Paquetes,  Idioma,  IVAFiscal,  IEPSFiscal,  ListaPreciosEsp,  EstaImpreso,  Mensaje,  Logico1,  Logico2,  Logico3,  Logico4,  Logico5,  Logico6,  Logico7,  Pagado,  ProrrateoAplicaID,  FormaEntrega,  CancelarPendiente,  LineaCredito,  TipoAmortizacion,  TipoTasa,  Comisiones,  ComisionesIVA,  OperacionRelevante,  VIN,  SubModulo,  AutoCargos,  TieneTasaEsp,  TasaEsp,  Cliente, SucursalOrigen,  SucursalDestino,  ContUso,  ContUso2,  ContUso3,  ContratoID,  ContratoMov,  ContratoMovID ,MovIntelisisMES,ReferenciaMES)
                     VALUES (      @Empresa, @Mov2, @MovID, @FechaEmision, @UltimoCambio, @Concepto, @Proyecto, @Actividad, @UEN, @Moneda, @TipoCambio, @Usuario, @Autorizacion, @Referencia, @DocFuente, @Observaciones, @Estatus, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @Directo, @VerDestino, @Prioridad, @RenglonID, @Proveedor, @FormaEnvio, @FechaRequerida, @Almacen, @Condicion, @Vencimiento, @Manejo, @Fletes, @ActivoFijo, @Instruccion, @Agente, @Descuento, @DescuentoGlobal, @Importe, @Impuestos, @Saldo, @DescuentoLineal, @OrigenTipo, @Origen, @OrigenID, @Poliza, @PolizaID, @GenerarPoliza, @ContID, @Ejercicio, @Periodo, @FechaRegistro, @FechaConclusion, @FechaCancelacion, @Peso, @Volumen, @Conciliado, @Causa, @Atencion, @FechaEntrega, @EmbarqueEstado, ISNULL(@Sucursal,@Sucursal2), @ZonaImpuesto, @Paquetes, @Idioma, @IVAFiscal, @IEPSFiscal, @ListaPreciosEsp, @EstaImpreso, @Mensaje, @Logico1, @Logico2, @Logico3, @Logico4, @Logico5, @Logico6, @Logico7, @Pagado, @ProrrateoAplicaID, @FormaEntrega, @CancelarPendiente, @LineaCredito, @TipoAmortizacion, @TipoTasa, @Comisiones, @ComisionesIVA, @OperacionRelevante, @VIN, @SubModulo, @AutoCargos, @TieneTasaEsp, @TasaEsp, @Cliente, @SucursalOrigen, @SucursalDestino, @ContUso, @ContUso2, @ContUso3, @ContratoID, @ContratoMov, @ContratoMovID,ISNULL(@MovIntelisisMES,''),@ReferenciaMES)
    IF @@ERROR <> 0 SET @Ok = 1
    SET @IDGenerar = SCOPE_IDENTITY()


  IF @Proveedor IS NOT NULL
  UPDATE Compra
     SET Proyecto = ISNULL(Compra.Proyecto,p.Proyecto),
                   FormaEnvio     = p.FormaEnvio,
                   Agente              = p.Agente,
                   Condicion         = p.Condicion,
                                  ZonaImpuesto = p.ZonaImpuesto,
                                  Idioma               = p.Idioma,
                   Moneda       = m.Moneda,
                   TipoCambio     = m.TipoCambio
    FROM Compra, Prov p, Mon m
   WHERE Compra.ID = @IDGenerar AND p.Proveedor = @Proveedor AND m.Moneda = ISNULL(p.DefMoneda, @Moneda)

  END
  SELECT @RenglonSub = 0
  INSERT @Temp (   Cantidad,  Almacen,  Codigo,  Articulo,  SubCuenta,  FechaRequerida,  FechaOrdenar,  FechaEntrega,  Costo,  Impuesto1,  Impuesto2,  Impuesto3,  Retencion1,  Retencion2,  Retencion3,  Descuento,  DescuentoTipo,  DescuentoLinea,  DescuentoImporte,  DescripcionExtra,  ReferenciaExtra,  ContUso,  DestinoTipo,  Destino,  DestinoID,  Aplica,  AplicaID,  CantidadPendiente,  CantidadCancelada,  CantidadA,  CostoInv,  Unidad,             Factor,  CantidadInventario,  Cliente,  ServicioArticulo,  ServicioSerie,  Paquete,  Sucursal,  ImportacionProveedor,  ImportacionReferencia,  ProveedorRef,  AgenteRef,  EstadoRef,  FechaCaducidad,  ProveedorArt,  ProveedorArtCosto,  AjusteCosteo,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  Posicion,  DepartamentoDetallista,  Pais,  TratadoComercial,  ProgramaSectorial,  ValorAduana,  ImportacionImpuesto1,  ImportacionImpuesto2,  ID1,  ID2,  FormaPago,  EsEstadistica,  PresupuestoEsp,  SucursalOrigen,  ContUso2,  ContUso3,  Tarima,  EmpresaRef,  Categoria,  Estado,  CostoEstandar,  ABC,  PaqueteCantidad,  CantidadEmbarcada,  ClavePresupuestal,  TipoImpuesto1,  TipoImpuesto2,  TipoImpuesto3,  TipoRetencion1,  TipoRetencion2,  TipoRetencion3,  CostoConImpuesto,  TipoImpuesto4,  CostoPromedio,  CostoReposicion,  TipoImpuesto5,  Impuesto5  )
  SELECT          Cantidad,  Almacen,  Codigo,  Articulo,  SubCuenta,  FechaRequerida,  FechaOrdenar,  FechaEntrega,  Costo,  Impuesto1,  Impuesto2,  Impuesto3,  Retencion1,  Retencion2,  Retencion3,  Descuento,  DescuentoTipo,  DescuentoLinea,  DescuentoImporte,  DescripcionExtra,  ReferenciaExtra,  ContUso,  DestinoTipo,  Destino,  DestinoID,  Aplica,  AplicaID,  CantidadPendiente,  CantidadCancelada,  CantidadA,  CostoInv,   DescripcionUnidad,  Factor,  CantidadInventario,  Cliente,  ServicioArticulo,  ServicioSerie,  Paquete,  Sucursal,  ImportacionProveedor,  ImportacionReferencia,  ProveedorRef,  AgenteRef,  EstadoRef,  FechaCaducidad,  ProveedorArt,  ProveedorArtCosto,  AjusteCosteo,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  Posicion,  DepartamentoDetallista,  Pais,  TratadoComercial,  ProgramaSectorial,  ValorAduana,  ImportacionImpuesto1,  ImportacionImpuesto2,  ID1,  ID2,  FormaPago,  EsEstadistica,  PresupuestoEsp,  SucursalOrigen,  ContUso2,  ContUso3,  Tarima,  EmpresaRef,  Categoria,  Estado,  CostoEstandar,  ABC,  PaqueteCantidad,  CantidadEmbarcada,  ClavePresupuestal,  TipoImpuesto1,  TipoImpuesto2,  TipoImpuesto3,  TipoRetencion1,  TipoRetencion2,  TipoRetencion3,  CostoConImpuesto,  TipoImpuesto4,  CostoPromedio,  CostoReposicion,  TipoImpuesto5,  Impuesto5 
    FROM OPENXML (@iSolicitud, '/Intelisis/Solicitud/Compra/DetalleCompra',1) 
    WITH (RenglonSub  varchar(100),  RenglonID  varchar(100),  RenglonTipo  varchar(100),  Cantidad  varchar(100),  Almacen  varchar(100),  Codigo  varchar(100),  Articulo  varchar(100),  SubCuenta  varchar(100),  FechaRequerida  varchar(100),  FechaOrdenar  varchar(100),  FechaEntrega  varchar(100),  Costo  varchar(100),  Impuesto1  varchar(100),  Impuesto2  varchar(100),  Impuesto3  varchar(100),  Retencion1  varchar(100),  Retencion2  varchar(100),  Retencion3  varchar(100),  Descuento  varchar(100),  DescuentoTipo  varchar(100),  DescuentoLinea  varchar(100),  DescuentoImporte  varchar(100),  DescripcionExtra  varchar(100),  ReferenciaExtra  varchar(100),  ContUso  varchar(100),  DestinoTipo  varchar(100),  Destino  varchar(100),  DestinoID  varchar(100),  Aplica  varchar(100),  AplicaID  varchar(100),  CantidadPendiente  varchar(100),  CantidadCancelada  varchar(100),  CantidadA  varchar(100),  CostoInv  varchar(100),  Unidad  varchar(100),  Factor  varchar(100),  CantidadInventario  varchar(100),  Cliente  varchar(100),  ServicioArticulo  varchar(100),  ServicioSerie  varchar(100),  Paquete  varchar(100),  Sucursal  varchar(100),  ImportacionProveedor  varchar(100),  ImportacionReferencia  varchar(100),  ProveedorRef  varchar(100),  AgenteRef  varchar(100),  EstadoRef  varchar(100),  FechaCaducidad  varchar(100),  ProveedorArt  varchar(100),  ProveedorArtCosto  varchar(100),  AjusteCosteo  varchar(100),  CostoUEPS  varchar(100),  CostoPEPS  varchar(100),  UltimoCosto  varchar(100),  PrecioLista  varchar(100),  Posicion  varchar(100),  DepartamentoDetallista  varchar(100),  Pais  varchar(100),  TratadoComercial  varchar(100),  ProgramaSectorial  varchar(100),  ValorAduana  varchar(100),  ImportacionImpuesto1  varchar(100),  ImportacionImpuesto2  varchar(100),  ID1  varchar(100),  ID2  varchar(100),  FormaPago  varchar(100),  EsEstadistica  varchar(100),  PresupuestoEsp  varchar(100),  SucursalOrigen  varchar(100),  ContUso2  varchar(100),  ContUso3  varchar(100),  Tarima  varchar(100),  EmpresaRef  varchar(100),  Categoria  varchar(100),  Estado  varchar(100),  CostoEstandar  varchar(100),  ABC  varchar(100),  PaqueteCantidad  varchar(100),  CantidadEmbarcada  varchar(100),  ClavePresupuestal  varchar(100),  TipoImpuesto1  varchar(100),  TipoImpuesto2  varchar(100),  TipoImpuesto3  varchar(100),  TipoRetencion1  varchar(100),  TipoRetencion2  varchar(100),  TipoRetencion3  varchar(100),  CostoConImpuesto  varchar(100),  TipoImpuesto4  varchar(100),CostoPromedio  varchar(100),  CostoReposicion  varchar(100),  TipoImpuesto5  varchar(100),  Impuesto5 varchar(100), DescripcionUnidad varchar(100) )

  BEGIN
    DECLARE crDetalle CURSOR LOCAL FAST_FORWARD FOR
     SELECT    Cantidad,  Almacen,  Codigo,  Articulo,  SubCuenta,  FechaRequerida,  FechaOrdenar,  FechaEntrega,  Costo,  Impuesto1,  Impuesto2,  Impuesto3,  Retencion1,  Retencion2,  Retencion3,  Descuento,  DescuentoTipo,  DescuentoLinea,  DescuentoImporte,  DescripcionExtra,  ReferenciaExtra,  ContUso,  DestinoTipo,  Destino,  DestinoID,  Aplica,  AplicaID,  CantidadPendiente,  CantidadCancelada,  CantidadA,  CostoInv,  Unidad,  Factor,  Cantidad*dbo.fnArtUnidadFactor(@Empresa, Articulo, Unidad),  Cliente,  ServicioArticulo,  ServicioSerie,  Paquete,  ImportacionProveedor,  ImportacionReferencia,  ProveedorRef,  AgenteRef,  EstadoRef,  FechaCaducidad,  ProveedorArt,  ProveedorArtCosto,  AjusteCosteo,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  Posicion,  DepartamentoDetallista,  Pais,  TratadoComercial,  ProgramaSectorial,  ValorAduana,  ImportacionImpuesto1,  ImportacionImpuesto2,  ID1,  ID2,  FormaPago,  EsEstadistica,  PresupuestoEsp, ContUso2,  ContUso3,  Tarima,  EmpresaRef,  Categoria,  Estado,  CostoEstandar,  ABC,  PaqueteCantidad,  CantidadEmbarcada,  ClavePresupuestal,  TipoImpuesto1,  TipoImpuesto2,  TipoImpuesto3,  TipoRetencion1,  TipoRetencion2,  TipoRetencion3,  CostoConImpuesto,  TipoImpuesto4,   CostoPromedio,  CostoReposicion,  TipoImpuesto5,  Impuesto5 
       FROM @Temp
    SET @Renglon = 0.0
    SET @RenglonID = 0

    OPEN crDetalle                                             
    FETCH NEXT FROM crDetalle INTO   @Cantidad, @AlmacenD, @Codigo, @Articulo, @SubCuenta, @FechaRequeridaD, @FechaOrdenarD, @FechaEntregaD, @Costo, @Impuesto1, @Impuesto2, @Impuesto3, @Retencion1, @Retencion2, @Retencion3, @DescuentoD, @DescuentoTipo, @DescuentoLinea, @DescuentoImporte, @DescripcionExtra, @ReferenciaExtra, @ContUso, @DestinoTipo, @Destino, @DestinoID, @Aplica, @AplicaID, @CantidadPendiente, @CantidadCancelada, @CantidadA, @CostoInv, @Unidad, @Factor, @CantidadInventario, @Cliente, @ServicioArticulo, @ServicioSerie, @Paquete,  @ImportacionProveedor, @ImportacionReferencia, @ProveedorRef, @AgenteRef, @EstadoRef, @FechaCaducidad, @ProveedorArt, @ProveedorArtCosto, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @Posicion, @DepartamentoDetallista, @Pais, @TratadoComercial, @ProgramaSectorial, @ValorAduana, @ImportacionImpuesto1, @ImportacionImpuesto2, @ID1, @ID2, @FormaPago, @EsEstadistica, @PresupuestoEsp, @ContUso2, @ContUso3, @Tarima, @EmpresaRef, @Categoria, @Estado, @CostoEstandar, @ABC, @PaqueteCantidad, @CantidadEmbarcada, @ClavePresupuestal, @TipoImpuesto1, @TipoImpuesto2, @TipoImpuesto3, @TipoRetencion1, @TipoRetencion2, @TipoRetencion3, @CostoConImpuesto, @TipoImpuesto4, @CostoPromedio, @CostoReposicion, @TipoImpuesto5, @Impuesto5 
    WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
    BEGIN

      IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) SELECT @Ok = 20830
      IF @Cantidad < 0 SET @Ok = 20010
      IF @Costo < 0 SET @Ok = 20140
      SELECT @ArtImpuesto1 = Impuesto1, @ArtImpuesto2=Impuesto2, @ArtImpuesto3=Impuesto3, @ArtRetencion1=Retencion1, @ArtRetencion2=Retencion2, @ArtRetencion3=Retencion3
        FROM Art WHERE Articulo = @Articulo

      IF @AlmacenD NOT IN(SELECT Almacen FROM Alm WHERE Sucursal = @Sucursal)
        SELECT @AlmacenD = AlmacenPrincipal FROM Sucursal WHERE Sucursal = @Sucursal

      SET @Renglon = @Renglon + 2048.0
      SET @RenglonID = @RenglonID + 1
      SELECT @ArtTipo = Tipo FROM Art WHERE Articulo = @Articulo
      EXEC spRenglonTipo @ArtTipo, @Subcuenta, @RenglonTipo OUTPUT
      SELECT @MovMoneda = Moneda, @MovTipoCambio = TipoCambio, @MovZonaImpuesto = ZonaImpuesto, @Proveedor= Proveedor FROM Compra WHERE ID = @IDGenerar
      EXEC xpCantidadInventario @Articulo, @SubCuenta, @Unidad, @CfgMultiUnidades, @CfgMultiUnidadesNivel, @Cantidad, @CantidadInventario OUTPUT
      EXEC spUnidadFactor @Empresa, @Articulo, @SubCuenta, @Unidad, @Factor OUTPUT, @Decimales OUTPUT
      EXEC spZonaImp @MovZonaImpuesto, @ArtImpuesto1 OUTPUT
      EXEC spZonaImp @MovZonaImpuesto, @ArtImpuesto2 OUTPUT
      EXEC spZonaImp @MovZonaImpuesto, @ArtImpuesto3 OUTPUT
      EXEC spTipoImpuesto 'COMS' , @IDGenerar, @Mov, @FechaEmision, @Empresa, @Sucursal, @Contacto = @Proveedor, @Articulo = @Articulo, @EnSilencio = 1, @Impuesto1 = @ArtImpuesto1 OUTPUT, @Impuesto2 = @ArtImpuesto2 OUTPUT, @Impuesto3 = @ArtImpuesto3 OUTPUT
      SELECT @CantidadOrden = ROUND(@Cantidad / (@CantidadInventario / @Cantidad), 4), @CantidadInventario = @Cantidad
      EXEC spVerCosto @Sucursal, @Empresa, @Proveedor, @Articulo, @SubCuenta, @Unidad, @CfgCompraCostoSugerido, @MovMoneda, @MovTipoCambio, @Costo OUTPUT, 0
      SELECT @DestinoTipo = NULL, @Destino = NULL, @DestinoID = NULL


      INSERT CompraD ( ID,       Renglon,   RenglonSub,  RenglonID,  RenglonTipo,  Cantidad,  Almacen,  Codigo,  Articulo,  SubCuenta,  FechaRequerida,  FechaOrdenar,    FechaEntrega,  Costo,  Impuesto1,  Impuesto2,  Impuesto3,  Retencion1,  Retencion2,  Retencion3,  Descuento,  DescuentoTipo,  DescuentoLinea,  DescuentoImporte,  DescripcionExtra,  ReferenciaExtra,  ContUso,  DestinoTipo,  Destino,  DestinoID,  Aplica,    AplicaID,  CantidadPendiente,  CantidadCancelada,  CantidadA,  CostoInv,  Unidad,  Factor,  CantidadInventario,  Cliente,  ServicioArticulo,  ServicioSerie,  Paquete,  Sucursal,  ImportacionProveedor,  ImportacionReferencia,  ProveedorRef,  AgenteRef,  EstadoRef,  FechaCaducidad,  ProveedorArt,  ProveedorArtCosto,  AjusteCosteo,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  Posicion,  DepartamentoDetallista,  Pais,  TratadoComercial,  ProgramaSectorial,  ValorAduana,  ImportacionImpuesto1,  ImportacionImpuesto2,  ID1,  ID2,  FormaPago,  EsEstadistica,  PresupuestoEsp,  SucursalOrigen,  ContUso2,  ContUso3,  Tarima,  EmpresaRef,  Categoria,  Estado,  CostoEstandar,  ABC,  PaqueteCantidad,  CantidadEmbarcada,  ClavePresupuestal,  TipoImpuesto1,  TipoImpuesto2,  TipoImpuesto3,  TipoRetencion1,  TipoRetencion2,  TipoRetencion3,  CostoConImpuesto,  TipoImpuesto4,   CostoPromedio,  CostoReposicion,  TipoImpuesto5,  Impuesto5  )
     VALUES         (@IDGenerar,@Renglon, @RenglonSub, @RenglonID, @RenglonTipo, @CantidadOrden, @AlmacenD, @Codigo, @Articulo, @SubCuenta, @FechaRequeridaD, @FechaOrdenarD, @FechaEntregaD, @Costo,@ArtImpuesto1, @ArtImpuesto2, @ArtImpuesto3, @ArtRetencion1, @ArtRetencion2, @ArtRetencion3, @DescuentoD, @DescuentoTipo, @DescuentoLinea, @DescuentoImporte, @DescripcionExtra, @ReferenciaExtra, @ContUso, @DestinoTipo, @Destino, @DestinoID, @Aplica, @AplicaID, @CantidadPendiente, @CantidadCancelada, @CantidadA, @CostoInv, @Unidad, @Factor, @CantidadInventario, @Cliente, @ServicioArticulo, @ServicioSerie, @Paquete, ISNULL(@Sucursal,@Sucursal2), @ImportacionProveedor, @ImportacionReferencia, @ProveedorRef, @AgenteRef, @EstadoRef, @FechaCaducidad, @ProveedorArt, @ProveedorArtCosto, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @Posicion, @DepartamentoDetallista, @Pais, @TratadoComercial, @ProgramaSectorial, @ValorAduana, @ImportacionImpuesto1, @ImportacionImpuesto2, @ID1, @ID2, @FormaPago, @EsEstadistica, @PresupuestoEsp, ISNULL(@Sucursal,@Sucursal2), @ContUso2, @ContUso3, @Tarima, @EmpresaRef, @Categoria, @Estado, @CostoEstandar, @ABC, @PaqueteCantidad, @CantidadEmbarcada, @ClavePresupuestal, @TipoImpuesto1, @TipoImpuesto2, @TipoImpuesto3, @TipoRetencion1, @TipoRetencion2, @TipoRetencion3, @CostoConImpuesto, @TipoImpuesto4, @CostoPromedio, @CostoReposicion, @TipoImpuesto5, @Impuesto5  )
      IF @@ERROR <> 0 SET @Ok = 1

      FETCH NEXT FROM crDetalle INTO   @Cantidad, @AlmacenD, @Codigo, @Articulo, @SubCuenta, @FechaRequeridaD, @FechaOrdenarD, @FechaEntregaD, @Costo, @Impuesto1, @Impuesto2, @Impuesto3, @Retencion1, @Retencion2, @Retencion3, @DescuentoD, @DescuentoTipo, @DescuentoLinea, @DescuentoImporte, @DescripcionExtra, @ReferenciaExtra, @ContUso, @DestinoTipo, @Destino, @DestinoID, @Aplica, @AplicaID, @CantidadPendiente, @CantidadCancelada, @CantidadA, @CostoInv, @Unidad, @Factor, @CantidadInventario, @Cliente, @ServicioArticulo, @ServicioSerie, @Paquete,  @ImportacionProveedor, @ImportacionReferencia, @ProveedorRef, @AgenteRef, @EstadoRef, @FechaCaducidad, @ProveedorArt, @ProveedorArtCosto, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @Posicion, @DepartamentoDetallista, @Pais, @TratadoComercial, @ProgramaSectorial, @ValorAduana, @ImportacionImpuesto1, @ImportacionImpuesto2, @ID1, @ID2, @FormaPago, @EsEstadistica, @PresupuestoEsp, @ContUso2, @ContUso3, @Tarima, @EmpresaRef, @Categoria, @Estado, @CostoEstandar, @ABC, @PaqueteCantidad, @CantidadEmbarcada, @ClavePresupuestal, @TipoImpuesto1, @TipoImpuesto2, @TipoImpuesto3, @TipoRetencion1, @TipoRetencion2, @TipoRetencion3, @CostoConImpuesto, @TipoImpuesto4, @CostoPromedio, @CostoReposicion, @TipoImpuesto5, @Impuesto5 
    END
    CLOSE crDetalle
    DEALLOCATE crDetalle
  END
  --BEGIN TRANSACTION
  --IF @Ok IS NULL
  --  EXEC spAfectar 'COMS', @IDGenerar, 'AFECTAR', 'Todo', NULL, @Usuario2, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion

  --IF @Ok IS NULL
  --BEGIN
  --  COMMIT TRANSACTION
  --END ELSE
  --BEGIN
  --  ROLLBACK TRANSACTION
  --END
  IF @Ok IS NULL
  SELECT @ReferenciaIS = Referencia
    FROM IntelisisService
   WHERE ID = @ID
   SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + ' Modulo="COMS" ModuloID =' + CHAR(34) + ISNULL(CONVERT(varchar,@IDGenerar),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + ' MovIntelisisMES="'+@MovIntelisisMES+'" ReferenciaIntelisisService="'+@ReferenciaIntelisisService+'"/></Intelisis>'
END
GO



/**************** fnInforArtUnidadCompra ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnInforArtUnidadCompra') DROP FUNCTION fnInforArtUnidadCompra
GO
CREATE FUNCTION fnInforArtUnidadCompra (@Articulo varchar(20))
RETURNS varchar(50)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Resultado                                     varchar(50),

    @Unidad                     varchar(50)

  SELECT @Unidad = ISNULL(NULLIF(UnidadCompra,''),Unidad) FROM Art WHERE Articulo = @Articulo 



  RETURN(@Unidad)
END
GO

/**************** fnInforArtUnidadCompraFactor ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnInforArtUnidadCompraFactor') DROP FUNCTION fnInforArtUnidadCompraFactor
GO
CREATE FUNCTION fnInforArtUnidadCompraFactor (@Empresa varchar(5), @Articulo varchar(20))
RETURNS float
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Resultado                                     float,
    @CfgMultiUnidadesNivel           varchar(20),
    @Unidad                     varchar(50)

  SELECT @Unidad = ISNULL(NULLIF(UnidadCompra,''),Unidad) FROM Art WHERE Articulo = @Articulo 

  SELECT @CfgMultiUnidadesNivel = ISNULL(UPPER(NivelFactorMultiUnidad), 'UNIDAD')
    FROM EmpresaCfg2
   WHERE Empresa = @Empresa

  SELECT @Resultado = NULL
  IF @CfgMultiUnidadesNivel = 'ARTICULO'
    SELECT @Resultado = NULLIF(Factor, 0.0)
      FROM ArtUnidad
     WHERE Articulo = @Articulo AND Unidad = @Unidad

  IF @Resultado IS NULL
    SELECT @Resultado = dbo.fnUnidadFactor(@Unidad)

  RETURN(@Resultado)
END
GO

/************** spInforSaldoU ***************/
if exists (select * from sysobjects where id = object_id('dbo.spInforSaldoU') and sysstat & 0xf = 4) drop procedure dbo.spInforSaldoU
GO
CREATE PROCEDURE spInforSaldoU
                @Sucursal                                            int,
                @Accion                               char(20),
                @Empresa                                           char(5),
                @Usuario                                             char(10),
                @Rama                                                 char(5),
                @Moneda                            char(10),
                @Cuenta                              char(20),
                @SubCuenta                                      varchar(50),
                @Grupo                                                char(10),
                @Modulo                              char(5),
                @ID                        int,
                @Mov                                                   char(20),
                @MovID                                varchar(20),
                @Cargo                                                money,
                @Abono                               money,
                @CargoU                              float,
                @AbonoU                            float,
                @Fecha                                                datetime,
        @EjercicioAfectacion            int,
        @PeriodoAfectacion              int,
                @AcumulaSinDetalles              bit,
        @AcumulaEnLinea                            bit,
        @GeneraAuxiliar                                bit,
        @GeneraSaldo                           bit,
        @Conciliar                                   bit,
                @Aplica                                                char(20),
                @AplicaID                                            varchar(20),
                @EsTransferencia                bit,
                @EsResultados                            bit,
                @EsTipoSerie                                      bit,
                @InvNegativoU                                 float,
                @ConsignacionU                                      float,
                @IDGenerar                      int,
                @Ok                                                      int                           OUTPUT,
                @OkRef                                                varchar(255)       OUTPUT,
                @Renglon                                           float                       = NULL,
                @RenglonSub                                    int                          = NULL,
                @RenglonID                                       int                          = NULL,
        @SubGrupo                                varchar(20)          = NULL
--//WITH ENCRYPTION
AS BEGIN
DECLARE
                               @ProdInterfazINFOR                         bit,
                               @Cantidadslm                                   float,
                               @Cantidad                                          float,
                               @Datos                                                 varchar(max),
                               @Resultado                                         varchar(max),
                               @ReferenciaIS                                    varchar(100),
                               @SubReferencia                                varchar(100),
                @IDNuevo                                           int           ,
                               @Contrasena                                      varchar(32),
                               @ReferenciaIntelisisService     varchar(50),
                        @PlantaSucEmpresa                 varchar(10),
                @TipoMovimiento                 varchar(20),
                @Almacen                                          varchar(10),
                               @MovMES                           bit,
                @IDO                                                    int,
                        @MovO                         char(20),
                        @MovIDO                                    varchar(20),
                        @ArtSecundario                  varchar(20),
                               @Articulop                      varchar(20),
                               @Rama2                          varchar(20),
                               @SubClave                       varchar(20)

DECLARE @Tabla   table(
                               Codigo                                 varchar(20),
                               SubCuenta               varchar(50),
                               CodigoID                             int,
                               CodigoArticulo            varchar(20),
                               FechaMovimiento                            datetime,
                               EntradaSalida                    varchar(1),
                               Cantidad                             float,
                               TipoMovimiento                                varchar(20),
                               NuevoStock                         float,
                               CodigoAlmacen                 varchar(10),
                               PrecioVenta                        float,
                               PrecioCoste                         float,
                               Importe                                float,
                               NumPedido                         int,
                               ClienteDestino                   varchar(10),
                               ProveedorDestino             varchar(10),
                               AlmacenDestino                                varchar(10),
                               NumeroLote                        varchar(50),
                               Lanzamiento                      int,
                               Fase                                      int,
                               NumeroTrabajo                  int,
                               FechaEntregaPrevista      datetime,
                               Observaciones1                 varchar(40),
                               FechaDeAlta                       datetime,
                               FechaUltimaModificacion              datetime,
                               UsuarioAlta                          varchar(10),
                               Ubicacin                            varchar(8),
                               NuevoStockAlmacen        float,
                               NuevoStockLote                 float,
                               SeriePedido                        varchar(3),
                               SerieDocumento                               varchar(3),
                               NumLineaDocumento      int,
                               TipoCambio                        float,
                               Divisa                                    varchar(10),
                               Serie                                      varchar(3),
                               Numero                                int,
                               Linea                                     int,
                               FechaMovimientoHora    datetime,
                               ReferenciaIntelisisService      varchar(50),
                NumDocumento            varchar(20) ,
                ArticuloSecundario      varchar(20),
                StockAntes              float

)
  SELECT @SubClave = SubClave FROM MovTipo WHERE Mov = @Mov AND Modulo = @Modulo
   SELECT @ProdInterfazINFOR = ProdInterfazINFOR
     FROM EmpresaGral WHERE Empresa = @Empresa
   SELECT @Contrasena = Contrasena
     FROM Usuario
    WHERE Usuario = @Usuario

   SELECT @Rama2 = Rama FROM AuxiliarU WHERE ID = @IDGenerar

   SELECT @MovO = Origen , @MovIDO = OrigenID FROM Inv WHERE ID = @ID

   SELECT @IDO = ID FROM Inv WHERE Mov = @MovO AND MovID = @MovIDO AND Empresa = @Empresa AND Sucursal = @Sucursal

   SELECT @TipoMovimiento =       ReferenciaIntelisisMes  
     FROM MapeoMovimientosIntelisisInfor
    WHERE Movimiento = @Mov AND Modulo = @Modulo    

   IF @ProdInterfazINFOR = 1   AND @Accion IN ('AFECTAR','CANCELAR','RESERVARPARCIAL') AND @IDGenerar IS NOT NULL-- AND @SubClave NOT IN ('INV.EA','INV.SA')
   BEGIN
     IF @Modulo = 'COMS'
     BEGIN

       SELECT @Cantidadslm = SUM(slm.Cantidad)
         FROM SerieLoteMov slm JOIN CompraD md
           ON slm.ID = md.ID AND slm.Modulo = @Modulo AND slm.RenglonID = md.RenglonID AND slm.Articulo = md.Articulo AND ISNULL(slm.SubCuenta,'') = ISNULL(md.SubCuenta,'') AND slm.Empresa = @Empresa
         JOIN AuxiliarU a ON a.Modulo = @Modulo AND a.ModuloID = md.ID AND a.Renglon = md.Renglon AND a.RenglonSub = md.RenglonSub
                JOIN Alm al ON a.Grupo = al.Almacen
                JOIN Art ar ON slm.Articulo = ar.Articulo
                WHERE a.ID = @IDGenerar
                  AND ISNULL(al.EsFactory,0) = 1
                  AND ISNULL(ar.EsFactory,0) = 1

       SELECT @Cantidad = ISNULL(a.CargoU,a.AbonoU)
         FROM AuxiliarU a JOIN Alm al ON a.Grupo = al.Almacen
         JOIN Art ar ON a.Cuenta = ar.Articulo
        WHERE a.ID = @IDGenerar
                  AND ISNULL(al.EsFactory,0) = 1
                  AND ISNULL(ar.EsFactory,0) = 1

       SELECT @Almacen = Almacen FROM Compra WHERE ID = @ID

       SELECT @ReferenciaIntelisisService = Referencia
         FROM MapeoPlantaIntelisisMes
        WHERE Empresa = @Empresa AND Sucursal = @Sucursal

       --IF ISNULL(@Cantidadslm,(ABS(@Cantidad))) <> ABS(@Cantidad) SET @Ok = 10340

       INSERT @Tabla (Codigo, CodigoID, CodigoArticulo, FechaMovimiento, EntradaSalida,                                     Cantidad,                                     TipoMovimiento,    NuevoStock,   CodigoAlmacen, PrecioVenta,    PrecioCoste, Importe,                                      NumPedido, ClienteDestino, ProveedorDestino, AlmacenDestino, NumeroLote,                    Lanzamiento, Fase, NumeroTrabajo, FechaEntregaPrevista, Observaciones1, FechaDeAlta,     FechaUltimaModificacion, UsuarioAlta, Ubicacin, NuevoStockAlmacen, NuevoStockLote, SeriePedido, SerieDocumento,     NumLineaDocumento, TipoCambio, Divisa,   Serie, Numero, Linea,        FechaMovimientoHora, SubCuenta,               ReferenciaIntelisisService,  NumDocumento )     
        SELECT  @Cuenta, NULL,    @Cuenta,        @Fecha,          CASE  WHEN a.CargoU IS NULL AND a.AbonoU >0.0 THEN 'S' WHEN a.CargoU IS NULL AND a.AbonoU <0.0 THEN 'E' WHEN a.AbonoU IS NULL AND a.CargoU >0.0  THEN 'E' WHEN a.AbonoU IS NULL AND a.CargoU <0.0 THEN 'S' END, ISNULL(slm.Cantidad,ISNULL(CASE WHEN a.CargoU >0.0 THEN a.CargoU WHEN a.CargoU <0.0 THEN a.CargoU*-1 END ,CASE WHEN a.AbonoU >0.0 THEN a.AbonoU WHEN a.AbonoU <0.0 THEN a.AbonoU*-1 END)), @TipoMovimiento, e.Existencia, a.Grupo,    ar.PrecioLista, md.Costo,   (ISNULL(a.CargoU,a.AbonoU)* ar.PrecioLista)  , 0,       null,     null,      a.Grupo,     ISNULL(slm.SerieLote,''),                    0,          0, 0,            md.FechaRequerida,   m.Mov+' '+m.MovID,           m.FechaRegistro, NULL,                    m.Usuario,   NULL,      0,               0,            'IP',         'IP',           md.RenglonID,      NULL,       m.Moneda, 'IP',  NULL,   md.RenglonID,  m.FechaRegistro,    ISNULL(md.SubCuenta,''),@ReferenciaIntelisisService, @MovID         
         FROM AuxiliarU a
         JOIN CompraD md ON a.Modulo = @Modulo AND a.ModuloID = md.ID AND a.Renglon = md.Renglon AND a.RenglonSub = md.RenglonSub
         JOIN Compra m  ON md.ID = m.ID LEFT OUTER
         JOIN SerieLoteMov slm  ON slm.ID = md.ID AND slm.Modulo = @Modulo AND slm.RenglonID = md.RenglonID AND slm.Articulo = md.Articulo AND ISNULL(slm.SubCuenta,'') = ISNULL(md.SubCuenta,'') AND slm.Empresa = m.Empresa
         JOIN Art ar  ON md.Articulo = ar.Articulo  AND md.Articulo = @Cuenta AND  ar.Articulo = @Cuenta 
         JOIN ArtExistenciaNeta e  ON a.Empresa = e.Empresa AND a.Cuenta = e.Articulo AND a.Moneda = e.Moneda AND a.Grupo = e.Almacen
                JOIN Alm al ON a.Grupo = al.Almacen
                WHERE a.ID = @IDGenerar
                  AND ISNULL(al.EsFactory,0) = 1
                  AND ISNULL(ar.EsFactory,0) = 1
     END

     IF @Modulo = 'VTAS'
     BEGIN

       SELECT @Cantidadslm = SUM(slm.Cantidad)
         FROM SerieLoteMov slm
         JOIN VentaD md  ON slm.ID = md.ID AND slm.Modulo = @Modulo AND slm.RenglonID = md.RenglonID AND slm.Articulo = md.Articulo AND ISNULL(slm.SubCuenta,'') = ISNULL(md.SubCuenta,'') AND slm.Empresa = @Empresa
         JOIN AuxiliarU a ON a.Modulo = @Modulo AND a.ModuloID = md.ID AND a.Renglon = md.Renglon AND a.RenglonSub = md.RenglonSub
                JOIN Alm al ON a.Grupo = al.Almacen
                JOIN Art ar ON slm.Articulo = ar.Articulo
                WHERE a.ID = @IDGenerar
                  AND ISNULL(al.EsFactory,0) = 1
                  AND ISNULL(ar.EsFactory,0) = 1
       SELECT @Cantidad = ISNULL(a.CargoU,a.AbonoU)
         FROM AuxiliarU a JOIN Alm al ON a.Grupo = al.Almacen
         JOIN Art ar ON a.Cuenta = ar.Articulo
        WHERE a.ID = @IDGenerar
                  AND ISNULL(al.EsFactory,0) = 1
                  AND ISNULL(ar.EsFactory,0) = 1
       SELECT @Almacen = Almacen FROM Venta WHERE ID = @ID


       SELECT @ReferenciaIntelisisService = Referencia
         FROM MapeoPlantaIntelisisMes
        WHERE Empresa = @Empresa AND Sucursal = @Sucursal

       --IF ISNULL(@Cantidadslm,(ABS(@Cantidad))) <> ABS(@Cantidad) SET @Ok = 10340

        INSERT @Tabla (Codigo, CodigoID, CodigoArticulo, FechaMovimiento, EntradaSalida,                                     Cantidad,                                     TipoMovimiento,   NuevoStock,   CodigoAlmacen, PrecioVenta,    PrecioCoste, Importe,                                      NumPedido, ClienteDestino, ProveedorDestino, AlmacenDestino, NumeroLote,                    Lanzamiento, Fase, NumeroTrabajo, FechaEntregaPrevista, Observaciones1, FechaDeAlta,     FechaUltimaModificacion, UsuarioAlta, Ubicacin, NuevoStockAlmacen, NuevoStockLote, SeriePedido, SerieDocumento,     NumLineaDocumento, TipoCambio, Divisa,   Serie, Numero, Linea,        FechaMovimientoHora, SubCuenta,               ReferenciaIntelisisService, NumDocumento )      
        SELECT  @Cuenta, NULL,    @Cuenta,        @Fecha,          CASE  WHEN a.CargoU IS NULL AND a.AbonoU >0.0 THEN 'S' WHEN a.CargoU IS NULL AND a.AbonoU <0.0 THEN 'E' WHEN a.AbonoU IS NULL AND a.CargoU >0.0  THEN 'E' WHEN a.AbonoU IS NULL AND a.CargoU <0.0 THEN 'S' END, ISNULL(slm.Cantidad,ISNULL(CASE WHEN a.CargoU >0.0 THEN a.CargoU WHEN a.CargoU <0.0 THEN a.CargoU*-1 END ,CASE WHEN a.AbonoU >0.0 THEN a.AbonoU WHEN a.AbonoU <0.0 THEN a.AbonoU*-1 END)), @TipoMovimiento, e.Existencia, a.Grupo,    ar.PrecioLista, md.Costo,   (ISNULL(a.CargoU,a.AbonoU)* ar.PrecioLista)  , 0,       null,     null,      a.Grupo,     ISNULL(slm.SerieLote,''),                    0,          0, 0,            md.FechaRequerida,   m.Mov+' '+m.MovID,           m.FechaRegistro, NULL,                    m.Usuario,   NULL,      0,               0,            'IP',         'IP',           md.RenglonID,      NULL,       m.Moneda, 'IP',  NULL,   md.RenglonID,  m.FechaRegistro,    ISNULL(md.SubCuenta,''),@ReferenciaIntelisisService, @MovID         
         FROM AuxiliarU a
         JOIN VentaD md ON a.Modulo = @Modulo AND a.ModuloID = md.ID AND a.Renglon = md.Renglon AND a.RenglonSub = md.RenglonSub
         JOIN Venta m ON md.ID = m.ID
         LEFT JOIN SerieLoteMov slm ON slm.ID = md.ID AND slm.Modulo = @Modulo AND slm.RenglonID = md.RenglonID AND slm.Articulo = md.Articulo AND ISNULL(slm.SubCuenta,'') = ISNULL(md.SubCuenta,'') AND slm.Empresa = m.Empresa 
         JOIN Art ar ON md.Articulo = ar.Articulo AND md.Articulo = @Cuenta  
         JOIN ArtExistenciaNeta e ON a.Empresa = e.Empresa AND a.Cuenta = e.Articulo AND a.Moneda = e.Moneda AND a.Grupo = e.Almacen
                JOIN Alm al ON a.Grupo = al.Almacen
                WHERE a.ID = @IDGenerar
                  AND ISNULL(al.EsFactory,0) = 1
                  AND ISNULL(ar.EsFactory,0) = 1
     END
     IF @Modulo = 'PROD'
     BEGIN

       SELECT @Cantidadslm = SUM(slm.Cantidad)
         FROM SerieLoteMov slm
         JOIN ProdD md ON slm.ID = md.ID AND slm.Modulo = @Modulo AND slm.RenglonID = md.RenglonID AND slm.Articulo = md.Articulo AND ISNULL(slm.SubCuenta,'') = ISNULL(md.SubCuenta,'') AND slm.Empresa = @Empresa
         JOIN AuxiliarU a ON a.Modulo = @Modulo AND a.ModuloID = md.ID AND a.Renglon = md.Renglon AND a.RenglonSub = md.RenglonSub
                JOIN Alm al ON a.Grupo = al.Almacen
                WHERE a.ID = @IDGenerar
                  AND ISNULL(al.EsFactory,0) = 1

       SELECT @Cantidad = ISNULL(a.CargoU,a.AbonoU)
         FROM AuxiliarU a JOIN Alm al ON a.Grupo = al.Almacen
        WHERE a.ID = @IDGenerar
                  AND ISNULL(al.EsFactory,0) = 1

       SELECT @Almacen = Almacen FROM Prod WHERE ID = @ID

       SELECT @ReferenciaIntelisisService = Referencia
         FROM MapeoPlantaIntelisisMes
        WHERE Empresa = @Empresa AND Sucursal = @Sucursal

       --IF ISNULL(@Cantidadslm,(ABS(@Cantidad))) <> ABS(@Cantidad) SET @Ok = 10340

       INSERT @Tabla (Codigo, CodigoID, CodigoArticulo, FechaMovimiento, EntradaSalida,                                     Cantidad,                                       TipoMovimiento, NuevoStock,   CodigoAlmacen, PrecioVenta,    PrecioCoste, Importe,                                      NumPedido, ClienteDestino, ProveedorDestino, AlmacenDestino, NumeroLote,                    Lanzamiento, Fase, NumeroTrabajo, FechaEntregaPrevista, Observaciones1, FechaDeAlta,     FechaUltimaModificacion, UsuarioAlta, Ubicacin, NuevoStockAlmacen, NuevoStockLote, SeriePedido, SerieDocumento,     NumLineaDocumento, TipoCambio, Divisa,   Serie, Numero, Linea,        FechaMovimientoHora, SubCuenta,               ReferenciaIntelisisService, NumDocumento )      
       SELECT  @Cuenta, NULL,    @Cuenta,        @Fecha,          CASE  WHEN a.CargoU IS NULL AND a.AbonoU >0.0 THEN 'S' WHEN a.CargoU IS NULL AND a.AbonoU <0.0 THEN 'E' WHEN a.AbonoU IS NULL AND a.CargoU >0.0  THEN 'E' WHEN a.AbonoU IS NULL AND a.CargoU <0.0 THEN 'S' END, ISNULL(slm.Cantidad,ISNULL(CASE WHEN a.CargoU >0.0 THEN a.CargoU WHEN a.CargoU <0.0 THEN a.CargoU*-1 END ,CASE WHEN a.AbonoU >0.0 THEN a.AbonoU WHEN a.AbonoU <0.0 THEN a.AbonoU*-1 END)), @TipoMovimiento, e.Existencia, a.Grupo,    ar.PrecioLista, ISNULL(md.Costo,0),   (ISNULL(a.CargoU,a.AbonoU)* ar.PrecioLista)  , 0,       null,     null,      a.Grupo,     ISNULL(slm.SerieLote,''),                    0,          0, 0,            md.FechaRequerida,   m.Mov+' '+m.MovID,           m.FechaRegistro, NULL,                    m.Usuario,   NULL,      0,               0,            'IP',         'IP',           md.RenglonID,      NULL,       m.Moneda, 'IP',  NULL,   md.RenglonID,  m.FechaRegistro,    ISNULL(md.SubCuenta,''),@ReferenciaIntelisisService, @MovID         
         FROM AuxiliarU a
         JOIN ProdD md ON a.Modulo = @Modulo AND a.ModuloID = md.ID AND a.Renglon = md.Renglon AND a.RenglonSub = md.RenglonSub
         JOIN Prod m ON md.ID = m.ID
         LEFT OUTER JOIN SerieLoteMov slm  ON slm.ID = md.ID AND slm.Modulo = @Modulo AND slm.RenglonID = md.RenglonID AND slm.Articulo = md.Articulo AND ISNULL(slm.SubCuenta,'') = ISNULL(md.SubCuenta,'') AND slm.Empresa = m.Empresa
         LEFT OUTER JOIN Art ar ON md.Articulo = ar.Articulo AND md.Articulo = @Cuenta 
         JOIN ArtExistenciaNeta e ON a.Empresa = e.Empresa AND a.Cuenta = e.Articulo AND a.Moneda = e.Moneda AND a.Grupo = e.Almacen
                JOIN Alm al ON a.Grupo = al.Almacen
                WHERE a.ID = @IDGenerar
                  AND ISNULL(al.EsFactory,0) = 1
     END

     IF @Modulo = 'INV'
     SELECT @MovMES = MovMES FROM Inv WHERE ID = @ID
     IF (@Modulo = 'INV' AND (@MovMES <> 1 OR @MovMES IS NULL ) AND @Rama2 <>'RESV') OR (@Modulo = 'INV' AND @Accion = 'CANCELAR' AND @Rama2 <>'RESV')
     BEGIN

       SELECT @Cantidadslm = SUM(slm.Cantidad)
         FROM SerieLoteMov slm
         JOIN InvD md ON slm.ID = md.ID AND slm.Modulo = @Modulo AND slm.RenglonID = md.RenglonID AND slm.Articulo = md.Articulo AND ISNULL(slm.SubCuenta,'') = ISNULL(md.SubCuenta,'') AND slm.Empresa = @Empresa
         JOIN AuxiliarU a ON a.Modulo = @Modulo AND a.ModuloID = md.ID AND a.Renglon = md.Renglon AND a.RenglonSub = md.RenglonSub
                JOIN Alm al ON a.Grupo = al.Almacen
                JOIN Art ar ON slm.Articulo = ar.Articulo
                WHERE a.ID = @IDGenerar
                  AND ISNULL(al.EsFactory,0) = 1
                  AND ISNULL(ar.EsFactory,0) = 1  
       SELECT @Cantidad = ISNULL(a.CargoU,a.AbonoU)
         FROM AuxiliarU a JOIN Alm al ON a.Grupo = al.Almacen
         JOIN Art ar ON a.Cuenta = ar.Articulo
        WHERE a.ID = @IDGenerar
                  AND ISNULL(al.EsFactory,0) = 1
          AND ISNULL(ar.EsFactory,0) = 1
       SELECT @Almacen = Almacen FROM Inv WHERE ID = @ID

      --SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService
      --  FROM Alm
      -- WHERE Almacen = @Almacen

       SELECT @ReferenciaIntelisisService = Referencia
         FROM MapeoPlantaIntelisisMes
        WHERE Empresa = @Empresa AND Sucursal = @Sucursal

      --IF ISNULL(@Cantidadslm,(ABS(@Cantidad))) <> ABS(@Cantidad) SET @Ok = 10340

       INSERT @Tabla (Codigo, CodigoID, CodigoArticulo, FechaMovimiento, EntradaSalida,                                                                                                     Cantidad,                                                                                                             TipoMovimiento, NuevoStock,   CodigoAlmacen, PrecioVenta,    PrecioCoste,            Importe,                                      NumPedido, ClienteDestino, ProveedorDestino, AlmacenDestino, NumeroLote,                    Lanzamiento, Fase, NumeroTrabajo, FechaEntregaPrevista, Observaciones1, FechaDeAlta,     FechaUltimaModificacion, UsuarioAlta, Ubicacin, NuevoStockAlmacen, NuevoStockLote, SeriePedido, SerieDocumento,     NumLineaDocumento, TipoCambio, Divisa,   Serie, Numero, Linea,        FechaMovimientoHora, SubCuenta,               ReferenciaIntelisisService, NumDocumento )      
       SELECT         @Cuenta, NULL,    @Cuenta,        @Fecha,          CASE  WHEN a.CargoU IS NULL AND a.AbonoU >0.0 THEN 'S' WHEN a.CargoU IS NULL AND a.AbonoU <0.0 THEN 'E' WHEN a.AbonoU IS NULL AND a.CargoU >0.0  THEN 'E' WHEN a.AbonoU IS NULL AND a.CargoU <0.0 THEN 'S' END, ISNULL(slm.Cantidad,ISNULL(CASE WHEN a.CargoU >0.0 THEN a.CargoU WHEN a.CargoU <0.0 THEN a.CargoU*-1 END ,CASE WHEN a.AbonoU >0.0 THEN a.AbonoU WHEN a.AbonoU <0.0 THEN a.AbonoU*-1 END))*dbo.fnInforArtUnidadCompraFactor(@Empresa,md.Articulo), @TipoMovimiento, e.Existencia, a.Grupo,      ar.PrecioLista, ISNULL(md.Costo,0),    (ISNULL(a.CargoU,a.AbonoU)* ar.PrecioLista)  , 0,       null,     null,      a.Grupo,     ISNULL(slm.SerieLote,''),                    0,          0, 0,            md.FechaRequerida,   m.Mov+' '+m.MovID,           m.FechaRegistro, NULL,                    m.Usuario,   NULL,      0,               0,            'IP',         'IP',           md.RenglonID,      NULL,       m.Moneda, 'IP',  NULL,   md.RenglonID,  m.FechaRegistro,    ISNULL(md.SubCuenta,''),@ReferenciaIntelisisService, @MovID         
         FROM AuxiliarU a
         JOIN Invd md ON a.Modulo = @Modulo AND a.ModuloID = md.ID AND a.Renglon = md.Renglon AND a.RenglonSub = md.RenglonSub
         JOIN Inv m   ON md.ID = m.ID
         LEFT OUTER JOIN SerieLoteMov slm ON slm.ID = md.ID AND slm.Modulo = @Modulo AND slm.RenglonID = md.RenglonID AND slm.Articulo = md.Articulo AND ISNULL(slm.SubCuenta,'') = ISNULL(md.SubCuenta,'') AND slm.Empresa = m.Empresa
         LEFT OUTER JOIN Art ar ON md.Articulo = ar.Articulo AND md.Articulo = @Cuenta 
         JOIN ArtExistenciaNeta e ON a.Empresa = e.Empresa AND a.Cuenta = e.Articulo AND a.Moneda = e.Moneda AND a.Grupo = e.Almacen
         JOIN Alm al ON a.Grupo = al.Almacen
                WHERE a.ID = @IDGenerar
                  AND ISNULL(al.EsFactory,0) = 1
                  AND ISNULL(ar.EsFactory,0) = 1
                  
                  


     END
     
          
     IF EXISTS(SELECT * FROM @Tabla)
     BEGIN
       UPDATE @Tabla SET StockAntes = s.Existencia
         FROM @Tabla t JOIN Art a ON a.Articulo = t.Codigo
         LEFT JOIN SerieLote s  ON t.Codigo = s.Articulo AND t.AlmacenDestino = s.Almacen AND t.NumeroLote = s.SerieLote AND s.Empresa = @Empresa AND s.Sucursal = @Sucursal  AND ISNULL(t.SubCuenta,'') = ISNULL(s.SubCuenta,'')
        WHERE a.Tipo IN ('SERIE','LOTE') 
        
        
       UPDATE @Tabla SET StockAntes = ISNULL(s.Disponible,0)+ISNULL(s.Reservado,0)
         FROM @Tabla t JOIN Art a ON a.Articulo = t.Codigo
         LEFT JOIN ArtDisponibleReservado s  ON t.Codigo = s.Articulo AND t.AlmacenDestino = s.Almacen  AND s.Empresa = @Empresa 
        WHERE a.Tipo IN ('Normal') 
      END  

     IF EXISTS(SELECT * FROM @Tabla)
     BEGIN
       UPDATE @Tabla SET StockAntes = 0.0 WHERE StockAntes = NULL
       SET @Resultado = CONVERT(varchar(max) ,(SELECT * FROM @Tabla MovimientoArticulo FOR XML AUTO))
       IF @@ERROR <> 0 SET @Ok = 1
       IF @Ok IS NULL AND ((@MovMES <> 1 OR @MovMES IS NULL)OR (@Accion = 'CANCELAR'))AND @Rama2 <> 'RESV' AND EXISTS (SELECT * FROM AuxiliarU AU JOIN MovTipo MT ON AU.Mov = MT.Mov AND MT.Clave <> 'INV.TMA' WHERE AU.ID = @IDGenerar)
       BEGIN
       
         SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Infor.Movimiento.Procesar.INV" SubReferencia="'+@Modulo+'" Version="1.0"><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@IDNuevo),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado + '</Solicitud></Intelisis>'
         
         EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,0,0,@IDNuevo Output
         IF @@ERROR <> 0 SET @Ok = 1
       END
     END      
   END
  RETURN
END
GO

/**************** spINFORInvAfectar****************/
if exists (select * from sysobjects where id = object_id('dbo.spINFORInvAfectar') and sysstat & 0xf = 4) drop procedure dbo.spINFORInvAfectar
GO            
CREATE PROCEDURE spINFORInvAfectar
                                  @ID                                     int,
                                  @Accion                                            char(20),
                   @Base                                               char(20),
                                  @Empresa                                        char(5),
                                  @Usuario                                          char(10),
                                  @Modulo                                          char(5),
                                  @Mov                                                char(20),
                                  @MovID                                            varchar(20),
                                  @MovTipo                        char(20),
                                  @MovMoneda                                char(10),
                                  @MovTipoCambio                        float,
                           @Estatus                                   char(15),
                           @EstatusNuevo                       char(15),
                                  @FechaEmision                              datetime,
                                  @FechaRegistro                              datetime,
                                  @FechaAfectacion                         datetime,
                                  @Conexion                                      bit,
                                  @SincroFinal                                   bit,
                                   @Sucursal                                         int,
                                  @UtilizarID                                       int,
                                  @UtilizarMovTipo                           char(20),
                                  @Ok                                                   int                          OUTPUT,
                                   @OkRef                                             varchar(255)       OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
     @ProdInterfazINFOR         bit,
     @AccesoID                                     int,
     @Contrasena                 varchar(32),
     @Resultado                                    varchar(max),
     @Datos                                            varchar (max) ,
     @MovIntelisisMES                varchar (10),
     @MovIntelisisMES1              varchar (10),
     @IDP                                int,
     @IDV                                int,
     @MovO                                           varchar (20),
     @MovIDO                                       varchar(20),
     @Aplica                                   varchar (20),
     @AplicaID                                       varchar(20),
     @ReferenciaIntelisisService varchar(50)



   SELECT @ProdInterfazINFOR = ProdInterfazINFOR
     FROM EmpresaGral WHERE Empresa = @Empresa

   SELECT @Contrasena = Contrasena
     FROM Usuario
    WHERE Usuario = @Usuario

   SELECT @MovO = Origen ,@MovIDO = OrigenID
     FROM Compra
    WHERE ID = @ID

   SELECT @IDP =ID
     FROM Compra
    WHERE Mov = @MovO AND MovID = @MovIDO AND Empresa = @Empresa AND Sucursal = @Sucursal

   SELECT @Aplica= Aplica ,@AplicaID = AplicaID
     FROM VentaD
    WHERE ID = @ID

   SELECT @IDV =ID
     FROM Venta
    WHERE Mov = @Aplica AND MovID = @AplicaID AND Empresa = @Empresa AND Sucursal = @Sucursal

  SELECT @MovIntelisisMES = MovIntelisisMES FROM Compra WHERE ID = @IDP
  SELECT @MovIntelisisMES1 = MovIntelisisMES FROM Compra WHERE ID = @ID

  IF @ProdInterfazINFOR = 1
  BEGIN
    SELECT @ReferenciaIntelisisService = Referencia
      FROM MapeoPlantaIntelisisMes
     WHERE Empresa = @Empresa AND Sucursal = @Sucursal
    IF    EXISTS(SELECT * FROM MapeoMovimientosIntelisisInfor WHERE Movimiento = @Mov AND Modulo = @Modulo)  
    BEGIN
      SET @Datos = NULL

      IF @Modulo ='VTAS'
      BEGIN
		IF @MovTipo = 'VTAS.P'  AND @EstatusNuevo = 'PENDIENTE' AND @Accion IN('AFECTAR','RESERVARPARCIAL')
        AND EXISTS(SELECT * FROM VentaD d JOIN Art a ON d.Articulo = a.Articulo JOIN Alm al ON a.INFORAlmacenProd = al.Almacen AND ISNULL(al.EsFactory,0) = 1 WHERE ISNULL(a.SeProduce,0) = 1 AND ISNULL(a.EsFactory,0) = 1 AND d.ID = @ID)    
          SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.VTAS_P" SubReferencia="'+CONVERT(varchar,@Mov)+'"'+' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' Version="1.0"><Solicitud> <Venta ID="'+CONVERT(varchar,@ID)+'"/>  </Solicitud> </Intelisis>'
        IF @MovTipo = 'VTAS.P'  AND @EstatusNuevo IN('CANCELADO','PENDIENTE','CONCLUIDO') AND @Accion = 'CANCELAR'
          SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.VTAS_P" SubReferencia="'+CONVERT(varchar,@Mov)+'"'+' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' Version="1.0"><Solicitud> <Venta ID="'+CONVERT(varchar,@ID)+'"/>  </Solicitud> </Intelisis>'
     END  

      IF @Modulo ='COMS'
      BEGIN
        IF @MovTipo IN ('COMS.F') AND @EstatusNuevo IN('CANCELADO','PENDIENTE','CONCLUIDO')  AND @Accion = 'CANCELAR' --AND @MovIntelisisMES IS NOT NULL
          SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.COMS_F" SubReferencia="'+CONVERT(varchar,@Mov)+'"'+' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' Version="1.0"><Solicitud> <Compra ID="'+CONVERT(varchar,@ID)+'"/>  </Solicitud> </Intelisis>'

        IF @MovTipo IN ('COMS.O') AND @EstatusNuevo IN('CANCELADO','PENDIENTE','CONCLUIDO')  AND @Accion = 'CANCELAR' --AND @MovIntelisisMES1 IS NOT NULL
          SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.COMS_OC" SubReferencia="'+CONVERT(varchar,@Mov)+'"'+' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' Version="1.0"><Solicitud> <Compra ID="'+CONVERT(varchar,@ID)+'"/>  </Solicitud> </Intelisis>'

        IF @MovTipo IN ('COMS.O') AND @EstatusNuevo = 'PENDIENTE'  AND @Accion = 'AFECTAR'  --AND @MovIntelisisMES1 IS NOT NULL
          SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.COMS_O" SubReferencia="'+CONVERT(varchar,@Mov)+'"'+' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' Version="1.0"><Solicitud> <Compra ID="'+CONVERT(varchar,@ID)+'"/>  </Solicitud> </Intelisis>'

        IF @MovTipo = 'COMS.F' AND @EstatusNuevo = 'CONCLUIDO'AND @Accion = 'AFECTAR' --AND @MovIntelisisMES IS NOT NULL
          SELECT @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.Transferencia.COMS_F" SubReferencia="'+CONVERT(varchar,@Mov)+'"'+' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' Version="1.0"><Solicitud> <Compra ID="'+CONVERT(varchar,@ID)+'"/>  </Solicitud> </Intelisis>'

      END
      IF @Datos IS NOT NULL AND  @Ok IS NULL OR @Ok BETWEEN 80030 AND 81000
      EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output
    END  
  END  
END
GO


/**************** spInforCuadrarExistenciaIntelisis ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforCuadrarExistenciaIntelisis')           AND type = 'P') drop procedure dbo.spInforCuadrarExistenciaIntelisis
GO
CREATE PROC spInforCuadrarExistenciaIntelisis
        @Empresa   varchar(5),
        @Usuario   varchar(20),
        @Sucursal  int,
        @Estacion  int
--//WITH ENCRYPTION
AS
BEGIN
DECLARE
  @Articulo         varchar(20),
  @Cantidad         float,
  @Moneda                          varchar(10),
  @TipoCambio                   float,
  @Unidad           varchar(50),
  @SerieLote        varchar(50),
  @SubCuenta        varchar(50), 
  @Factor           float,
  @MovEnt           varchar(20),
  @MovSal           varchar(20),
  @Tipo             varchar(20),
  @EntID            int,
  @SalID            int,
  @Renglon                          float   ,
  @RenglonSub                  int   ,
  @RenglonID                      int   ,
  @UltRenglonID     int,
  @Almacen          varchar(20),
  @AlmacenU         varchar(20),
  @RenglonTipo      varchar(20),
  @ExistenciaI      float,
  @Costo            float,
  @Ok               int,
  @OkRef            varchar(255),
  @CfgCompraCostoSugerido       varchar(20),
  @CfgPosiciones    bit,
  @Posicion         varchar(50)



   IF EXISTS (SELECT * FROM IntelisisService WHERE Referencia  IN (
                                          'Intelisis.Cuenta.Alm.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Alm',
                                          'Intelisis.Cuenta.CteTipo.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.CteTipo',
                                          'Intelisis.Cuenta.Mon.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Mon',
                                          'Intelisis.Interfaz.Infor.Transferencia.Prov',
                                          'Intelisis.Cuenta.Prov.Listado',
                                          'Intelisis.Cuenta.Articulo.Listado',
                                          'Intelisis.Cuenta.Usuario.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Art',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtContadorLotes',
                                          'Intelisis.Interfaz.Infor.Transferencia.Usuario',
                                          'Intelisis.Cuenta.ArtFam.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtFam',
                                          'Intelisis.Cuenta.Departamento.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Departamento',
                                          'Intelisis.Cuenta.Empresa.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Empresa',
                                          'Intelisis.COMS.Mov.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_F',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_O',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_OC',
                                          'Intelisis.VTAS.Mov.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.VTAS_P',
                                          'Intelisis.Interfaz.Infor.Transferencia.VTAS_PR',
                                          'Intelisis.Cuenta.Cte.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Cte',
                                          'Intelisis.Cuenta.Unidad.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Unidad',
                                          'Intelisis.Cuenta.Personal.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Personal',
                                          'Intelisis.COMS.InsertarMov.COMS_O',
                                          'Intelisis.Cuenta.Art.Insertar',
                                          'Intelisis.INV.InsertarMov.INV_E',
                                          'Intelisis.INV.InsertarMov.INV_S',
                                          'Intelisis.Cuenta.Sucursal.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Sucursal', 
                                          'Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas',
                                          'Intelisis.Interfaz.Infor.Insertar.CancelacionMov',
                                          'Intelisis.Cuenta.Planta.Usuario.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.PlantaUsuario',
                                          'Intelisis.Cuenta.Planta.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Planta',
                                          'Intelisis.Cuenta.ArtLinea.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtLinea', 
                                          'Intelisis.PC.InsertarMov.PC_C',
                                          'Intelisis.Cuenta.MotivoRechazo.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.MotivoRechazo',
                                          'Intelisis.Interfaz.Infor.Transferencia.OpcionDetalle',
                                          'Intelisis.Interfaz.Infor.Transferencia.Opcion',
                                          'Intelisis.INV.InsertarMov.NOM_P',
                                          'Intelisis.Interfaz.Infor.CancelarMov',
                                          'Infor.Movimiento.Procesar.COMS_OC',
                                          'Infor.Movimiento.Procesar.COMS_O',
                                          'Infor.Cuenta.Articulo.Mantenimiento',
                                          'Infor.Cuenta.ArtContadorLotes.Mantenimiento',
                                          'Infor.Cuenta.ArtLinea.Mantenimiento',
                                          'Infor.Movimiento.Procesar.INV',
                                          'Infor.Reporte.ObjetivosVentas',
                                          'Infor.Cuenta.Cte.Mantenimiento',
                                          'Infor.Cuenta.Usuario.Mantenimiento',
                                          'Infor.Cuenta.Proveedor.Mantenimiento',
                                          'Infor.Cuenta.Planta.Usuario.Mantenimiento',
                                          'Infor.Movimiento.Procesar.VTAS_P',
                                          'Infor.Cuenta.Art.Mantenimiento',
                                          'Infor.Cuenta.Personal.Mantenimiento',
                                          'Infor.Cuenta.Moneda.Mantenimiento',
                                          'Infor.Cuenta.ArtFam.Mantenimiento',
                                          'Infor.Movimiento.Procesar.COMS_F',
                                          'Infor.Cuenta.MotivoRechazo.Mantenimiento',
                                          'Infor.Cuenta.Unidad.Mantenimiento',
                                          'Infor.Movimiento.Procesar.VTAS_PR',
                                          'Infor.Cuenta.Planta.Mantenimiento',
                                          'Infor.Movimiento.Procesar.COMS_OC',
                                          'Infor.Cuenta.Empresa.Mantenimiento',
                                          'Infor.Cuenta.CteTipo.Mantenimiento',
                                          'Infor.Cuenta.Almacen.Mantenimiento',
                                          'Infor.Cuenta.Opcion.Mantenimiento',
                                          'Infor.Cuenta.OpcionDetalle.Mantenimiento') 
  AND Estatus IN ('SINPROCESAR') )SET @Ok = 2
  IF @Ok IS NULL
  BEGIN


    SET @Ok = null
    SELECT @Moneda = ContMoneda, @CfgCompraCostoSugerido = CompraCostoSugerido, @CfgPosiciones = ISNULL(Posiciones, 0)  FROM EmpresaCfg WHERE Empresa = @Empresa
    SELECT @MovEnt= Mov FROM MovTipo WHERE Clave ='INV.E' AND Subclave ='INV.EA'
    SELECT @MovSal= Mov FROM MovTipo WHERE Clave ='INV.S' AND Subclave ='INV.SA'
    SELECT @TipoCambio = TipoCambio FROM Mon WHERE Moneda = @Moneda
    BEGIN TRANSACTION 


    IF EXISTS(SELECT * FROM ArtExistenciaIntMES WHERE (ISNULL(ExistenciaMES,0.0)-ISNULL(ExistenciaInte,0.0))>0.0)

    BEGIN
      SELECT TOP 1 @AlmacenU = Almacen FROM ArtExistenciaIntMES
      SELECT @Sucursal = Sucursal FROM Alm WHERE Almacen = @AlmacenU
      INSERT Inv (Empresa,  Sucursal,  Mov,     Almacen,    FechaEmision, Estatus, Moneda, TipoCambio,Usuario)
      SELECT      @Empresa, @Sucursal,@MovEnt,@AlmacenU, dbo.fnFechaSinHora(GETDATE()),'SINAFECTAR', @Moneda,ISNULL(@TipoCambio,1.0),@Usuario
      SELECT @EntID = SCOPE_IDENTITY()
      IF @@ERROR <> 0 SET @OK = 1
      DECLARE crDetalle CURSOR LOCAL FAST_FORWARD FOR
      SELECT e.Articulo ,e.SubCuenta , e.SerieLote , e.Almacen, ISNULL(e.ExistenciaMES,0.0)-ISNULL(e.ExistenciaInte,0.0),e.CostoMes
        FROM ArtExistenciaIntMES e JOIN Alm a ON a.Almacen = e.Almacen
       WHERE  (ISNULL(e.ExistenciaMES,0.0)-ISNULL(e.ExistenciaInte,0.0))>0.0
         AND ISNULL(a.EsFactory,0) = 1

       SET @Renglon = 0.0
       SET @RenglonID = 0
       OPEN crDetalle
       FETCH NEXT FROM crDetalle INTO @Articulo,@SubCuenta,@SerieLote,@Almacen,@Cantidad,@Costo
       WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
       BEGIN

         SELECT @Posicion = DefPosicionRecibo FROM Alm WHERE ISNULL(Ubicaciones,0) = 1 AND NULLIF(DefPosicionSurtido,'') IS NOT NULL AND Almacen = @Almacen     
         SET @Renglon = @Renglon + 2048.0
         SET @RenglonID = @RenglonID + 1
         SET @RenglonSub =0
         SELECT @Tipo = Tipo ,@Unidad= Unidad FROM Art WHERE Articulo = @Articulo
         SELECT @Factor= Factor FROM ArtUnidad WHERE Unidad = @Unidad
                EXEC spRenglonTipo @Tipo, NULL, @RenglonTipo OUTPUT 
                 EXEC spVerCosto @Sucursal, @Empresa, NULL, @Articulo, @SubCuenta, @Unidad, @CfgCompraCostoSugerido, @Moneda, 1.0, @Costo OUTPUT, 0
         INSERT InvD ( ID,     Renglon,RenglonID,RenglonTipo, RenglonSub, Sucursal, Almacen, Articulo, SubCuenta, Cantidad, Unidad, Factor,CantidadInventario,Costo, Posicion)
         SELECT @EntID, @Renglon,@RenglonID,@RenglonTipo, @RenglonSub,@Sucursal, @Almacen, @Articulo, ISNULL(@SubCuenta,''), @Cantidad, @Unidad, @Factor ,@Cantidad*ISNULL(@Factor,1),ISNULL(@Costo,0.0), @Posicion   

         IF @SerieLote IS NOT NULL  AND @Tipo  IN ('Lote','Serie')
         BEGIN
           SELECT @UltRenglonID = ISNULL(MAX(RenglonID), 0) FROM InvD WHERE ID = @EntID AND Articulo=@Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND Cantidad = @Cantidad
           INSERT SerieLoteMov (Empresa,  Modulo, ID,          RenglonID,     Articulo,Cantidad,         SubCuenta,     SerieLote, Sucursal)
           SELECT               @Empresa, 'INV',  @EntID, @UltRenglonID, @Articulo,@Cantidad, ISNULL(@SubCuenta,''), @SerieLote,@Sucursal

         END                   
         IF @@ERROR <> 0 SET @Ok = 1
        FETCH NEXT FROM crDetalle INTO @Articulo,@SubCuenta,@SerieLote,@Almacen,@Cantidad,@Costo
      END
      CLOSE crDetalle
      DEALLOCATE crDetalle
    END 

    IF EXISTS(SELECT * FROM ArtExistenciaIntMES WHERE (ISNULL(ExistenciaMES,0.0)-ISNULL(ExistenciaInte,0.0))<0.0)
    BEGIN
      SELECT TOP 1 @AlmacenU = Almacen FROM ArtExistenciaIntMES
      SELECT @Sucursal = Sucursal FROM Alm WHERE Almacen = @AlmacenU
      INSERT Inv (Empresa,  Sucursal,  Mov,     Almacen,    FechaEmision, Estatus, Moneda, TipoCambio,Usuario)
      SELECT      @Empresa, @Sucursal,@MovSal,@AlmacenU, dbo.fnFechaSinHora(GETDATE()),'SINAFECTAR', @Moneda,@TipoCambio,@Usuario
      SELECT @SalID = SCOPE_IDENTITY()
      IF @@ERROR <> 0 SET @OK = 1
      DECLARE crDetalle2 CURSOR LOCAL FAST_FORWARD FOR
      SELECT Articulo ,SubCuenta , SerieLote , Almacen, ISNULL(ExistenciaMES,0.0)-ISNULL(ExistenciaInte,0.0)
        FROM ArtExistenciaIntMES
       WHERE ISNULL(ExistenciaMES,0.0)-ISNULL(ExistenciaInte,0.0)<0.0


       SET @Renglon = 0.0
       SET @RenglonID = 0
       OPEN crDetalle2
       FETCH NEXT FROM crDetalle2 INTO @Articulo,@SubCuenta,@SerieLote,@Almacen,@Cantidad
       WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
       BEGIN
         SELECT @Posicion = DefPosicionSurtido FROM Alm WHERE ISNULL(Ubicaciones,0) = 1 AND NULLIF(DefPosicionSurtido,'') IS NOT NULL AND Almacen = @Almacen     
         SELECT @Cantidad = @Cantidad*-1
         SET @Renglon = @Renglon + 2048.0
         SET @RenglonID = @RenglonID + 1
         SET @RenglonSub =0
         SET @Costo = 0.0
         SELECT @Tipo = Tipo ,@Unidad= Unidad FROM Art WHERE Articulo = @Articulo
         SELECT @Factor= Factor FROM ArtUnidad WHERE Unidad = @Unidad

                                EXEC spRenglonTipo @Tipo, NULL, @RenglonTipo OUTPUT 
         INSERT InvD ( ID,     Renglon,RenglonID,RenglonTipo, RenglonSub, Sucursal, Almacen, Articulo, SubCuenta, Cantidad, Unidad, Factor,CantidadInventario,Costo)
         SELECT @SalID, @Renglon,@RenglonID,@RenglonTipo, @RenglonSub,@Sucursal, @Almacen, @Articulo, ISNULL(@SubCuenta,''), @Cantidad, @Unidad, @Factor ,@Cantidad*ISNULL(@Factor,1) ,@Costo  

         IF @SerieLote IS NOT NULL  AND @Tipo  IN ('Lote','Serie')
         BEGIN
           SELECT @UltRenglonID = ISNULL(MAX(RenglonID), 0) FROM InvD WHERE ID = @SalID AND Articulo=@Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND Cantidad = @Cantidad
           INSERT SerieLoteMov (Empresa,  Modulo, ID,          RenglonID,     Articulo,Cantidad,         SubCuenta,     SerieLote, Sucursal)
           SELECT               @Empresa, 'INV',  @SalID, @UltRenglonID, @Articulo,@Cantidad, ISNULL(@SubCuenta,''), @SerieLote,@Sucursal
         END                   
         IF @@ERROR <> 0 SET @Ok = 1          
        FETCH NEXT FROM crDetalle2 INTO @Articulo,@SubCuenta,@SerieLote,@Almacen,@Cantidad
       END
       CLOSE crDetalle2
       DEALLOCATE crDetalle2
     END  

     IF @Ok IS NULL AND @EntID IS NOT NULL
     BEGIN
       EXEC spAfectar 'INV', @EntID, 'AFECTAR', 'Todo', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
     END
     IF @Ok IS NULL AND @SalID IS NOT NULL
     BEGIN
       EXEC spAfectar 'INV', @SalID, 'AFECTAR', 'Todo', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
     END

   IF @OK IS NOT NULL
   BEGIN
                               SELECT @OkRef = Descripcion FROM MensajeLista WHERE Mensaje = @Ok

     SELECT CONVERT(varchar,@ok)+'    '+@OkRef+'   '
   END
   ELSE
   SELECT 'Los ajustes en el inventario pueden tardar algunos minutos en verse reflejados, por favor espere antes de verificar los resultados.'
   IF @Ok IS NULL
   COMMIT TRANSACTION
   ELSE
   ROLLBACK TRANSACTION
  END  
  IF @Ok = 2 SELECT 'Existen Tareas Por Procesar  No Se Puede  Cuadrar La Existencia' 
  RETURN
END
go


/**************** spInicializarArtExistenciaIntMES ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInicializarArtExistenciaIntMES')           AND type = 'P') drop procedure dbo.spInicializarArtExistenciaIntMES
GO            
CREATE PROCEDURE spInicializarArtExistenciaIntMES


--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

DELETE ArtExistenciaIntMES

END
GO




/**************** spSolicitarExistenciaMES ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSolicitarExistenciaMES')           AND type = 'P') drop procedure dbo.spSolicitarExistenciaMES
GO            
CREATE PROCEDURE spSolicitarExistenciaMES
        @Empresa       varchar(5),
        @Usuario       varchar(10),
        @Sucursal      int

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE
                               @Solicitud                                           varchar(max),
                               @ReferenciaIS                                    varchar(100),
                               @SubReferencia                                varchar(100),
                               @ID                                        int,
                               @Datos                                                 varchar(max),
                               @Resultado                                         varchar(max),
                               @Contrasena                                      varchar(32),
                               @ReferenciaIntelisisService     varchar(50) ,
                               @iSolicitud                                   int,
                @IDNuevo                                           int,
                               @Datos2                               varchar(max),
                               @Resultado2                                       varchar(max),
                               @Verificar                                            int           ,
                        @Ok                               int ,   
                               @OkRef                                         varchar(255)              

  DECLARE
  @Tabla table(
    Articulo            varchar(20),
    SubCuenta           varchar(50),
    SerieLote           varchar(50),
    Almacen             varchar(10),
    ExistenciaMES       float  ,
    ExistenciaIntel     float  ,
    Costo               float
  )

  DECLARE
  @Tabla2 table(
    Articulo            varchar(20),
    SubCuenta           varchar(50),
    SerieLote           varchar(50),
    Almacen             varchar(10),
    ExistenciaIntel      float  ,
    ExistenciaMES       float  ,
    CostoMES            float
  )

  DECLARE
  @Tabla3 table(
  Articulo      varchar(20),
  SubCuenta     varchar(50),
  SerieLote     varchar(50),
  Almacen       varchar(10),
  EntradaSalida varchar(1),
  Existencia    float

)



 SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
   FROM IntelisisService
  WHERE ID = @ID


 SELECT @Contrasena = Contrasena
   FROM Usuario
  WHERE Usuario = @Usuario

 SELECT @ReferenciaIntelisisService = Referencia
   FROM MapeoPlantaIntelisisMes
  WHERE Empresa = @Empresa AND Sucursal = @Sucursal


 IF @Ok IS NULL
BEGIN

   DELETE ArtExistenciaIntMES

    SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia="Intelisis.Interfaz.Infor.ExistenciaMES" SubReferencia="" Version="1.0" ReferenciaIntelisisService='+CHAR(34)+ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' Sucursal='+CHAR(34)+ISNULL(CONVERT(varchar,@Sucursal),'')+CHAR(34)+' Empresa='+CHAR(34)+ISNULL(@Empresa,'')+CHAR(34)+'><Solicitud></Solicitud> </Intelisis>'

    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado ,@Ok Output,@OkRef Output,1,0,@ID Output

    IF @Ok IS NULL
      SELECT @Solicitud = Resultado
        FROM IntelisisService
       WHERE ID = @ID

    EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
    IF @@ERROR <> 0 SET @Ok = 1

   INSERT @Tabla (       Articulo ,SubCuenta , SerieLote , Almacen, ExistenciaMES,ExistenciaIntel,Costo)
   SELECT        Articulo ,ISNULL(SubCuenta,'') , NULLIF(NULLIF(Lote,'(none)'),'') , Almacen, Existencia,0.0,Costo
    FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/INV',1) 
    WITH (Articulo  varchar(100),  SubCuenta  varchar(100),  Lote  varchar(100),  Almacen  varchar(100),  Existencia  float, Costo Float)

   IF @@ERROR <> 0 SET @Ok = 1
   EXEC sp_xml_removedocument @iSolicitud
   IF @@ERROR <> 0 SET @Ok = 1       

   INSERT @Tabla (Articulo ,SubCuenta ,            SerieLote , Almacen, ExistenciaIntel,ExistenciaMES)  
   SELECT         s.Articulo ,ISNULL(s.SubCuenta,'') , s.SerieLote , s.Almacen, s.Existencia* dbo.fnInforArtUnidadCompraFactor(@Empresa,s.Articulo) ,    0.0
     FROM SerieLote s JOIN Alm a ON s.Almacen = a.Almacen
     JOIN Art art ON art.Articulo = s.Articulo
    WHERE s.Existencia IS NOT NULL  AND s.Empresa = @Empresa
      AND ISNULL(a.EsFactory,0) = 1
      AND ISNULL(art.EsFactory,0) = 1
      AND a.Sucursal = @Sucursal
   GROUP BY   s.Articulo ,s.SubCuenta , s.SerieLote , s.Almacen, s.Existencia

   INSERT @Tabla ( Articulo ,  SubCuenta ,             Almacen,   ExistenciaIntel,                                                   ExistenciaMES)  
   SELECT          s.Articulo ,ISNULL(s.SubCuenta,'') ,s.Almacen, s.Existencias* dbo.fnInforArtUnidadCompraFactor(@Empresa,s.Articulo),0.0
     FROM ArtSubExistenciaReservado s JOIN Art a ON a.Articulo = s.Articulo
     JOIN Alm al ON s.Almacen = al.Almacen
    WHERE a.Tipo = 'Normal'
      AND ISNULL(al.EsFactory,0) = 1
      AND ISNULL(a.EsFactory,0) = 1
      AND al.Sucursal = @Sucursal
   GROUP BY   s.Articulo ,s.SubCuenta , s.Almacen, s.Existencias



    INSERT  @Tabla2 (Articulo, SubCuenta,  SerieLote, Almacen ,ExistenciaIntel,               ExistenciaMES,               CostoMES)
    SELECT             Articulo, SubCuenta,  SerieLote, Almacen, SUM(ROUND(ExistenciaIntel,4)), SUM(ROUND(ExistenciaMES,4)) ,ISNULL(Costo,0.0)
      FROM @Tabla
     WHERE ExistenciaMES <> ExistenciaIntel
    GROUP BY Articulo,SubCuenta,SerieLote,Almacen ,Costo


    INSERT  ArtExistenciaIntMES (Articulo, SubCuenta, SerieLote, Almacen ,ExistenciaInte,  ExistenciaMES,CostoMES)
    SELECT                         Articulo, SubCuenta, SerieLote, Almacen, ExistenciaIntel, ExistenciaMES ,ISNULL(CostoMES,0.0)
      FROM @Tabla2
     WHERE ExistenciaMES <> ExistenciaIntel
       AND Almacen IN (SELECT Almacen FROM Alm)


END 

END
GO

/************** spSincroMES*************/
if exists (select * from sysobjects where id = object_id('dbo.spSincroMES') and type = 'P') drop procedure dbo.spSincroMES
GO
CREATE PROCEDURE spSincroMES

--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @TipoMensaje                                               nvarchar(256),
    @iDatos                                            int,
    @Brincar                           bit,
    @Ok                                                   int,
    @OkRef                                             varchar(255),

    @ID                                                    int,
    @Sistema                         varchar(100),
    @Contenido                                                   varchar(100),
    @Referencia                                                   varchar(100),
    @SubReferencia                                            varchar(100),
    @Version                          float,
    @Solicitud                        varchar(max),
    @Resultado                                                     varchar(max),
    @Estatus                           varchar(15),
    @FechaEstatus                                              datetime,
    @ISOk                                               int,
    @ISOkRef                          varchar(255),
    @Conversacion                                             uniqueidentifier,
    @SincroGUID                                                 uniqueidentifier,
    @IntelisisServiceID                        int,
    @FechaRecibo                                               datetime,
    @UsuarioIS                                                      varchar(10),
    @SucursalLocal                                              int,
    @SucursalOrigen                                           datetime,
    @SucursalDestino                          datetime,
    @Detener                         int,
    @GUIDSolicitud                                             uniqueidentifier,
    @Usuario                      varchar(10),
                @Debug                               bit           ,
                @contador               int

  SET @Debug=0
  IF NOT EXISTS(SELECT * FROM IntelisisService WHERE Referencia IN ( 'Intelisis.CXP.InsertarMov.CXP_F',
                                      'Intelisis.CXP.InsertarMov.CXP_CA',
                                      'Intelisis.CXP.InsertarMov.CXP_NC',
                                      'Intelisis.Cuenta.Alm.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.Alm',
                                      'Intelisis.Cuenta.CteTipo.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.CteTipo',
                                      'Intelisis.Cuenta.Mon.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.Mon',
                                      'Intelisis.Interfaz.Infor.Transferencia.Prov',
                                      'Intelisis.Cuenta.Prov.Listado',
                                      'Intelisis.Cuenta.Articulo.Listado',
                                      'Intelisis.Cuenta.Usuario.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.Art',
                                      'Intelisis.Interfaz.Infor.Transferencia.ArtContadorLotes',
                                      'Intelisis.Interfaz.Infor.Transferencia.Usuario',
                                      'Intelisis.Cuenta.ArtFam.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.ArtFam',
                                      'Intelisis.Cuenta.Departamento.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.Departamento',
                                      'Intelisis.Cuenta.Empresa.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.Empresa',
                                      'Intelisis.COMS.Mov.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.COMS_F',
                                      'Intelisis.Interfaz.Infor.Transferencia.COMS_O',
                                      'Intelisis.Interfaz.Infor.Transferencia.COMS_OC',
                                      'Intelisis.VTAS.Mov.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.VTAS_P',
                                      'Intelisis.Interfaz.Infor.Transferencia.VTAS_PR',
                                      'Intelisis.Cuenta.Cte.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.Cte',
                                      'Intelisis.Cuenta.Unidad.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.Unidad',
                                      'Intelisis.Cuenta.Personal.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.Personal',
                                      'Intelisis.COMS.InsertarMov.COMS_O',
                                      'Intelisis.Cuenta.Art.Insertar',
                                      'Intelisis.INV.InsertarMov.INV_E',
                                      'Intelisis.INV.InsertarMov.INV_S',
                                      'Intelisis.INV.InsertarMov.INV_SOL',
                                      'Intelisis.Cuenta.Sucursal.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.Sucursal', 
                                      'Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas',
                                      'Intelisis.Interfaz.Infor.Insertar.CancelacionMov',
                                      'Intelisis.Cuenta.Planta.Usuario.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.PlantaUsuario',
                                      'Intelisis.Cuenta.Planta.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.Planta',
                                      'Intelisis.Cuenta.ArtLinea.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.ArtLinea', 
                                      'Intelisis.PC.InsertarMov.PC_C',
                                      'Intelisis.Cuenta.MotivoRechazo.Listado',
                                      'Intelisis.Interfaz.Infor.Transferencia.MotivoRechazo',
                                      'Intelisis.Interfaz.Infor.Transferencia.OpcionDetalle',
                                      'Intelisis.Interfaz.Infor.Transferencia.Opcion',
                                      'Intelisis.NOM.Rendimiento.NOM_P',
                                      'Intelisis.Interfaz.Infor.CancelarMov',
                                      'Intelisis.Art.ActCosto',
                                      'Intelisis.COMS_INV.InsertarMov.Maquila',
                                      'Intelisis.INV.InsertarMov.INV_EST')
    AND Estatus IN ('SINPROCESAR','ERROR')
    AND Sistema ='Intelisis')
  RETURN 



  DECLARE @IntelisisService table
          (
          ID                                                 int NOT NULL identity(1,1),
          IntelisisServiceID                     int NULL,
          Sistema                                      varchar(100) COLLATE DATABASE_DEFAULT NULL,
          Contenido                                 varchar(100) COLLATE DATABASE_DEFAULT NULL,
          Referencia                                                varchar(100) COLLATE DATABASE_DEFAULT NULL,
          SubReferencia                          varchar(100) COLLATE DATABASE_DEFAULT NULL,                                        
          [Version]                                    float NULL,
          Usuario                                       varchar(10) COLLATE DATABASE_DEFAULT NULL,
          Solicitud                                     varchar(max) COLLATE DATABASE_DEFAULT NULL,
          Resultado                                   varchar(max) COLLATE DATABASE_DEFAULT NULL,
          Estatus                                        varchar(15) COLLATE DATABASE_DEFAULT NULL,
          FechaEstatus                            datetime NULL,
          Ok                                                int NULL,
          OkRef                                                          varchar(255) COLLATE DATABASE_DEFAULT NULL,         
          Detener                                      int NULL DEFAULT 0
          )

   INSERT @IntelisisService (IntelisisServiceID,  Sistema, Contenido, Referencia, SubReferencia, [Version], Usuario, Solicitud, Resultado, Estatus, FechaEstatus, Ok, OkRef,  Detener)
                     SELECT  ID,                  Sistema, Contenido, Referencia, SubReferencia, [Version], Usuario, Solicitud, Resultado, Estatus, FechaEstatus, Ok, OkRef,  0
                       FROM IntelisisService WITH (UPDLOCK, READPAST)
                      WHERE Referencia IN ('Intelisis.Cuenta.Alm.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Alm',
                                          'Intelisis.Cuenta.CteTipo.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.CteTipo',
                                          'Intelisis.Cuenta.Mon.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Mon',
                                          'Intelisis.Interfaz.Infor.Transferencia.Prov',
                                          'Intelisis.Cuenta.Prov.Listado',
                                          'Intelisis.Cuenta.Articulo.Listado',
                                          'Intelisis.Cuenta.Usuario.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Art',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtContadorLotes',
                                          'Intelisis.Interfaz.Infor.Transferencia.Usuario',
                                          'Intelisis.Cuenta.ArtFam.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtFam',
                                          'Intelisis.Cuenta.Departamento.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Departamento',
                                          'Intelisis.Cuenta.Empresa.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Empresa',
                                          'Intelisis.COMS.Mov.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_F',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_O',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_OC',
                                          'Intelisis.VTAS.Mov.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.VTAS_P',
                                          'Intelisis.Interfaz.Infor.Transferencia.VTAS_PR',
                                          'Intelisis.Cuenta.Cte.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Cte',
                                          'Intelisis.Cuenta.Unidad.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Unidad',
                                          'Intelisis.Cuenta.Personal.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Personal',
                                          'Intelisis.COMS.InsertarMov.COMS_O',
                                          'Intelisis.Cuenta.Art.Insertar',
                                          'Intelisis.INV.InsertarMov.INV_E',
                                          'Intelisis.INV.InsertarMov.INV_S',
                                          'Intelisis.INV.InsertarMov.INV_SOL',
                                          'Intelisis.Cuenta.Sucursal.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Sucursal', 
                                          'Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas',
                                          'Intelisis.Interfaz.Infor.Insertar.CancelacionMov',
                                          'Intelisis.Cuenta.Planta.Usuario.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.PlantaUsuario',
                                          'Intelisis.Cuenta.Planta.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Planta',
                                          'Intelisis.Cuenta.ArtLinea.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtLinea', 
                                          'Intelisis.PC.InsertarMov.PC_C',
                                          'Intelisis.Cuenta.MotivoRechazo.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.MotivoRechazo',
                                          'Intelisis.Interfaz.Infor.Transferencia.OpcionDetalle',
                                          'Intelisis.Interfaz.Infor.Transferencia.Opcion',
                                          'Intelisis.NOM.Rendimiento.NOM_P',
                                          'Intelisis.Interfaz.Infor.CancelarMov',
                                          'Intelisis.Art.ActCosto',
                                          'Intelisis.COMS_INV.InsertarMov.Maquila',
                                          'Intelisis.INV.InsertarMov.INV_EST'
                                         )
                      AND Estatus IN ('SINPROCESAR','ERROR')
                      AND Sistema ='Intelisis'
                    ORDER BY ID

   WHILE EXISTS(SELECT * FROM @IntelisisService WHERE Referencia IN (
                                          'Intelisis.Cuenta.Alm.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Alm',
                                          'Intelisis.Cuenta.CteTipo.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.CteTipo',
                                          'Intelisis.Cuenta.Mon.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Mon',
                                          'Intelisis.Interfaz.Infor.Transferencia.Prov',
                                          'Intelisis.Cuenta.Prov.Listado',
                                          'Intelisis.Cuenta.Articulo.Listado',
                                          'Intelisis.Cuenta.Usuario.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Art',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtContadorLotes',
                                          'Intelisis.Interfaz.Infor.Transferencia.Usuario',
                                          'Intelisis.Cuenta.ArtFam.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtFam',
                                          'Intelisis.Cuenta.Departamento.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Departamento',
                                          'Intelisis.Cuenta.Empresa.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Empresa',
                                          'Intelisis.COMS.Mov.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_F',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_O',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_OC',
                                          'Intelisis.VTAS.Mov.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.VTAS_P',
                                          'Intelisis.Interfaz.Infor.Transferencia.VTAS_PR',
                                          'Intelisis.Cuenta.Cte.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Cte',
                                          'Intelisis.Cuenta.Unidad.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Unidad',
                                          'Intelisis.Cuenta.Personal.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Personal',
                                          'Intelisis.COMS.InsertarMov.COMS_O',
                                          'Intelisis.Cuenta.Art.Insertar',
                                          'Intelisis.INV.InsertarMov.INV_E',
                                          'Intelisis.INV.InsertarMov.INV_S',
                                          'Intelisis.INV.InsertarMov.INV_SOL',
                                          'Intelisis.Cuenta.Sucursal.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Sucursal', 
                                          'Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas',
                                          'Intelisis.Interfaz.Infor.Insertar.CancelacionMov',
                                          'Intelisis.Cuenta.Planta.Usuario.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.PlantaUsuario',
                                          'Intelisis.Cuenta.Planta.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Planta',
                                          'Intelisis.Cuenta.ArtLinea.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtLinea', 
                                          'Intelisis.PC.InsertarMov.PC_C',
                                          'Intelisis.Cuenta.MotivoRechazo.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.MotivoRechazo',
                                          'Intelisis.Interfaz.Infor.Transferencia.OpcionDetalle',
                                          'Intelisis.Interfaz.Infor.Transferencia.Opcion',
                                          'Intelisis.NOM.Rendimiento.NOM_P',
                                         'Intelisis.Interfaz.Infor.CancelarMov',
                                          'Intelisis.Art.ActCosto',
                                          'Intelisis.COMS_INV.InsertarMov.Maquila',
                                          'Intelisis.INV.InsertarMov.INV_EST')
     AND Estatus IN ('SINPROCESAR','ERROR')
     AND Sistema ='Intelisis')
     AND @Ok IS NULL
   BEGIN
   --WAITFOR DELAY '00:00:01'
     SELECT @ID = ID, @IntelisisServiceID = IntelisisServiceID, @Sistema = Sistema, @Contenido = Contenido, @Referencia = Referencia, @SubReferencia = SubReferencia, @Version = [Version],  @UsuarioIS = Usuario, @Solicitud = Solicitud,  @Resultado = Resultado, @Estatus = Estatus, @FechaEstatus = FechaEstatus, @ISOk = Ok, @ISOkRef = OkRef, @Detener = Detener FROM @IntelisisService WHERE Referencia  IN (
                                          'Intelisis.Cuenta.Alm.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Alm',
                                          'Intelisis.Cuenta.CteTipo.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.CteTipo',
                                          'Intelisis.Cuenta.Mon.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Mon',
                                          'Intelisis.Interfaz.Infor.Transferencia.Prov',
                                          'Intelisis.Cuenta.Prov.Listado',
                                          'Intelisis.Cuenta.Articulo.Listado',
                                          'Intelisis.Cuenta.Usuario.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Art',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtContadorLotes',
                                          'Intelisis.Interfaz.Infor.Transferencia.Usuario',
                                          'Intelisis.Cuenta.ArtFam.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtFam',
                                          'Intelisis.Cuenta.Departamento.Listado',
                                         'Intelisis.Interfaz.Infor.Transferencia.Departamento',
                                          'Intelisis.Cuenta.Empresa.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Empresa',
                                          'Intelisis.COMS.Mov.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_F',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_O',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_OC',
                                          'Intelisis.VTAS.Mov.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.VTAS_P',
                                          'Intelisis.Interfaz.Infor.Transferencia.VTAS_PR',
                                          'Intelisis.Cuenta.Cte.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Cte',
                                          'Intelisis.Cuenta.Unidad.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Unidad',
                                          'Intelisis.Cuenta.Personal.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Personal',
                                          'Intelisis.COMS.InsertarMov.COMS_O',
                                          'Intelisis.Cuenta.Art.Insertar',
                                          'Intelisis.INV.InsertarMov.INV_E',
                                          'Intelisis.INV.InsertarMov.INV_S',
                                          'Intelisis.INV.InsertarMov.INV_SOL',
                                          'Intelisis.Cuenta.Sucursal.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Sucursal', 
                                          'Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas',
                                          'Intelisis.Interfaz.Infor.Insertar.CancelacionMov',
                                          'Intelisis.Cuenta.Planta.Usuario.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.PlantaUsuario',
                                          'Intelisis.Cuenta.Planta.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Planta',
                                          'Intelisis.Cuenta.ArtLinea.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtLinea', 
                                          'Intelisis.PC.InsertarMov.PC_C',
                                          'Intelisis.Cuenta.MotivoRechazo.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.MotivoRechazo',
                                          'Intelisis.Interfaz.Infor.Transferencia.OpcionDetalle',
                                          'Intelisis.Interfaz.Infor.Transferencia.Opcion',
                                          'Intelisis.NOM.Rendimiento.NOM_P',
                                          'Intelisis.Interfaz.Infor.CancelarMov',
                                          'Intelisis.Art.ActCosto',
                                          'Intelisis.COMS_INV.InsertarMov.Maquila',
                                          'Intelisis.INV.InsertarMov.INV_EST')
    AND Estatus IN ('SINPROCESAR','ERROR')
    AND ID = (SELECT MIN(ID) FROM @IntelisisService WHERE Referencia  IN (
                                          'Intelisis.Cuenta.Alm.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Alm',
                                          'Intelisis.Cuenta.CteTipo.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.CteTipo',
                                          'Intelisis.Cuenta.Mon.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Mon',
                                          'Intelisis.Interfaz.Infor.Transferencia.Prov',
                                          'Intelisis.Cuenta.Prov.Listado',
                                          'Intelisis.Cuenta.Articulo.Listado',
                                          'Intelisis.Cuenta.Usuario.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Art',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtContadorLotes',
                                          'Intelisis.Interfaz.Infor.Transferencia.Usuario',
                                          'Intelisis.Cuenta.ArtFam.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtFam',
                                          'Intelisis.Cuenta.Departamento.Listado',
                                         'Intelisis.Interfaz.Infor.Transferencia.Departamento',
                                          'Intelisis.Cuenta.Empresa.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Empresa',
                                          'Intelisis.COMS.Mov.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_F',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_O',
                                          'Intelisis.Interfaz.Infor.Transferencia.COMS_OC',
                                          'Intelisis.VTAS.Mov.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.VTAS_P',
                                          'Intelisis.Interfaz.Infor.Transferencia.VTAS_PR',
                                          'Intelisis.Cuenta.Cte.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Cte',
                                          'Intelisis.Cuenta.Unidad.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Unidad',
                                          'Intelisis.Cuenta.Personal.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Personal',
                                          'Intelisis.COMS.InsertarMov.COMS_O',
                                          'Intelisis.Cuenta.Art.Insertar',
                                          'Intelisis.INV.InsertarMov.INV_E',
                                          'Intelisis.INV.InsertarMov.INV_S',
                                          'Intelisis.INV.InsertarMov.INV_SOL',
                                          'Intelisis.Cuenta.Sucursal.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Sucursal', 
                                          'Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas',
                                          'Intelisis.Interfaz.Infor.Insertar.CancelacionMov',
                                          'Intelisis.Cuenta.Planta.Usuario.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.PlantaUsuario',
                                          'Intelisis.Cuenta.Planta.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.Planta',
                                          'Intelisis.Cuenta.ArtLinea.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.ArtLinea', 
                                          'Intelisis.PC.InsertarMov.PC_C',
                                          'Intelisis.Cuenta.MotivoRechazo.Listado',
                                          'Intelisis.Interfaz.Infor.Transferencia.MotivoRechazo',
                                          'Intelisis.Interfaz.Infor.Transferencia.OpcionDetalle',
                                          'Intelisis.Interfaz.Infor.Transferencia.Opcion',
                                          'Intelisis.NOM.Rendimiento.NOM_P',
                                          'Intelisis.Interfaz.Infor.CancelarMov',
                                          'Intelisis.Art.ActCosto',
                                          'Intelisis.COMS_INV.InsertarMov.Maquila',
                                          'Intelisis.INV.InsertarMov.INV_EST') 
       AND Estatus IN ('SINPROCESAR','ERROR') )

       IF ISNULL(@Detener,0) < 3
       BEGIN

         DELETE FROM @IntelisisService WHERE ID = @ID       
         INSERT @IntelisisService (IntelisisServiceID,  Sistema,  Contenido,  Referencia,  SubReferencia,  [Version], Usuario,    Solicitud,  Resultado,  Estatus,  FechaEstatus,  Ok,  OkRef,    Detener)
                          VALUES (@IntelisisServiceID, @Sistema, @Contenido, @Referencia, @SubReferencia, @Version,  @UsuarioIS, @Solicitud, @Resultado, @Estatus, @FechaEstatus, @Ok, @OkRef,  ISNULL(@Detener,0) + 1)

         EXEC spIntelisisServiceProcesar    @IntelisisServiceID                
       END


         --BEGIN
         --  IF @Detener = 2
         --  BEGIN


         --  EXEC spMESISEnviarCorreo @IntelisisServiceID                     
         --  END
         --END 
  IF @Detener = 3 RETURN        
  END                  

  RETURN
END
GO

  /**************** spModificarAcceso****************/
if exists (select * from sysobjects where id = object_id('dbo.spModificarAcceso') and type = 'P') drop procedure dbo.spModificarAcceso
GO            
CREATE PROCEDURE spModificarAcceso
      @Empresa Varchar(5),
      @Usuario  varchar(10)

--//WITH ENCRYPTION

AS BEGIN

DECLARE  @ID int

  SELECT @ID = MAX(ID)
    FROM Acceso
   WHERE Empresa = @Empresa
     AND Usuario = @Usuario

  UPDATE Acceso SET SPID = @@SPID
   WHERE ID = @ID

END
GO


--EXEC spModificarAcceso 'DEMO', 'DEMO'

/**************** spMESISEnviarCorreo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMESISEnviarCorreo') and type = 'P') drop procedure dbo.spMESISEnviarCorreo
GO            
CREATE PROCEDURE spMESISEnviarCorreo
                               @IntelisisServiceID                            int

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @SincroISDBMailPerfil                                                 varchar(50),
    @SincroISDBMailAsunto                              varchar(8000),
    @SincroISDBMailMensaje                           varchar(8000),
    @eMail                                                             varchar(50),
    @SubReferencia                                                            varchar(100),
    @Estatus                                                                          varchar(15),
    @FechaEstatus                                                              datetime,
    @Conversacion                                                             uniqueidentifier,
    @SincroGUID                                                                 uniqueidentifier,
    @SucursalOrigen                                                           int,
    @SucursalDestino                                          int,
    @IntelisisServiceOk                                       int,
    @IntelisisServiceOkRef                                                varchar(255)

  SELECT
    @SincroISDBMailPerfil = MESISDBMailPerfil,
    @SincroISDBMailAsunto = MESISDBMailAsunto,
    @SincroISDBMailMensaje = MESISDBMailMensaje
    FROM Version

  SELECT
    @SubReferencia         = SubReferencia,
    @Estatus               = Estatus,
    @FechaEstatus          = FechaEstatus,
    @IntelisisServiceOk    = Ok,
    @IntelisisServiceOkRef = OkRef
    FROM IntelisisService
   WHERE ID = @IntelisisServiceID

  SELECT @SincroISDBMailAsunto = REPLACE(@SincroISDBMailAsunto,'#IntelisisServiceID#',LTRIM(RTRIM(CONVERT(varchar,ISNULL(@IntelisisServiceID,0)))))
  SELECT @SincroISDBMailAsunto = REPLACE(@SincroISDBMailAsunto,'#SubReferencia#',LTRIM(RTRIM(ISNULL(@SubReferencia,''))))
  SELECT @SincroISDBMailAsunto = REPLACE(@SincroISDBMailAsunto,'#Estatus#',LTRIM(RTRIM(ISNULL(@Estatus,''))))
  SELECT @SincroISDBMailAsunto = REPLACE(@SincroISDBMailAsunto,'#IntelisisServiceOk#',LTRIM(RTRIM(CONVERT(varchar,ISNULL(@IntelisisServiceOk,-1)))))     
  SELECT @SincroISDBMailAsunto = REPLACE(@SincroISDBMailAsunto,'#IntelisisServiceOkRef#',LTRIM(RTRIM(ISNULL(@IntelisisServiceOkRef,'')))) 
  SELECT @SincroISDBMailAsunto = REPLACE(@SincroISDBMailAsunto,'#FechaEstatus#',LTRIM(RTRIM(CONVERT(varchar,ISNULL(@FechaEstatus,GETDATE()))))) 
  SELECT @SincroISDBMailMensaje = REPLACE(@SincroISDBMailMensaje,'#IntelisisServiceID#',LTRIM(RTRIM(CONVERT(varchar,ISNULL(@IntelisisServiceID,0)))))
  SELECT @SincroISDBMailMensaje = REPLACE(@SincroISDBMailMensaje,'#SubReferencia#',LTRIM(RTRIM(ISNULL(@SubReferencia,''))))
  SELECT @SincroISDBMailMensaje = REPLACE(@SincroISDBMailMensaje,'#Estatus#',LTRIM(RTRIM(ISNULL(@Estatus,''))))
  SELECT @SincroISDBMailMensaje = REPLACE(@SincroISDBMailMensaje,'#IntelisisServiceOk#',LTRIM(RTRIM(CONVERT(varchar,ISNULL(@IntelisisServiceOk,-1)))))     
  SELECT @SincroISDBMailMensaje = REPLACE(@SincroISDBMailMensaje,'#IntelisisServiceOkRef#',LTRIM(RTRIM(ISNULL(@IntelisisServiceOkRef,'')))) 
  SELECT @SincroISDBMailMensaje = REPLACE(@SincroISDBMailMensaje,'#FechaEstatus#',LTRIM(RTRIM(CONVERT(varchar,ISNULL(@FechaEstatus,GETDATE()))))) 

  IF NULLIF(@SincroISDBMailPerfil,'') IS NOT NULL AND NULLIF(@SincroISDBMailAsunto,'') IS NOT NULL AND NULLIF(@SincroisdbMailMensaje,'') IS NOT NULL
  BEGIN
    DECLARE crUsuario CURSOR LOCAL FAST_FORWARD FOR
     SELECT eMail
       FROM Usuario
      WHERE ISMESNotificarError = 1
        AND NULLIF(eMail,'') IS NOT NULL 

    OPEN crUsuario
    FETCH NEXT FROM crUsuario INTO @eMail
    WHILE @@FETCH_STATUS = 0
    BEGIN
      EXEC spEnviarDBMail @SincroISDBMailPerfil, @eMail, NULL, NULL, @SincroISDBMailAsunto, @SincroISDBMailMensaje 
      FETCH NEXT FROM crUsuario INTO @eMail
    END
    CLOSE crUsuario
    DEALLOCATE crUsuario
  END
END
GO

/**************** spIntelisisCuentaCteListado ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaCteListado') and type = 'P') drop procedure dbo.spIntelisisCuentaCteListado
GO 
CREATE PROCEDURE spIntelisisCuentaCteListado
@ID                        int,
@iSolicitud                           int,
@Version                              float,
@Resultado                         varchar(max) = NULL OUTPUT,
@Ok                                                      int = NULL OUTPUT,
@OkRef                                 varchar(255) = NULL OUTPUT
WITH ENCRYPTION
AS BEGIN
  DECLARE
                @Texto xml,
                @ReferenciaIS varchar(100),
                @SubReferencia varchar(100),
                @SQL nvarchar(MAX),
                @SQLVars nvarchar(MAX),
                @SQLLeerXML nvarchar(MAX),
                @SQLANDS nvarchar(MAX)

  SELECT @SQLVars = '', @SQLLeerXML = '', @SQLANDS = ''

  SELECT TOP 10
                               @SQLVars             = @SQLVars+'@' + COLUMN_NAME + ' ' + CASE WHEN DATA_TYPE LIKE '%char' THEN DATA_TYPE + '(' + CAST(CHARACTER_MAXIMUM_LENGTH AS varchar(5)) + ')' else DATA_TYPE end + ',',
                               @SQLLeerXML    = @SQLLeerXML+'SELECT @' + COLUMN_NAME + ' = Valor FROM openxml (@iSolicitud,''/Intelisis/Solicitud/Parametro'') WITH (Campo varchar(255), Valor varchar(255)) WHERE Campo = ''' + COLUMN_NAME + '''' + NCHAR(13),
                               @SQLANDS          = @SQLANDS+'AND ISNULL(' + COLUMN_NAME + ','''') = ISNULL(ISNULL(@' + COLUMN_NAME + ',' + COLUMN_NAME + '),'''')'
    FROM INFORMATION_SCHEMA.COLUMNS
   WHERE TABLE_NAME = 'Cte' AND DATA_TYPE NOT IN ('text','timestamp')
   ORDER BY ORDINAL_POSITION

  SELECT
                               @SQLVars             = 'DECLARE ' + NCHAR(13) + REPLACE(REPLACE(@SQLVars + ':', ',:', ''), ',', ',' + NCHAR(13)) + NCHAR(13),
                               @SQLANDS          = 'SELECT @Texto =(SELECT * FROM Cte WHERE ' +
                                                 REPLACE(SUBSTRING(@SQLANDS, 5, LEN(@SQLANDS)),')AND ISNULL(',') AND' + NCHAR(13) + 'ISNULL(') + 'FOR XML AUTO)'

  SELECT @SQL = @SQLVars + NCHAR(13) + @SQLLeerXML + NCHAR(13) + @SQLANDS           

  EXEC sp_executesql @SQL, N'@iSolicitud int, @Texto XML OUTPUT', @iSolicitud = @iSolicitud, @Texto = @Texto OUTPUT
  IF @@ERROR <> 0 SET @Ok = 1
  BEGIN
                SELECT @ReferenciaIS = Referencia
                  FROM IntelisisService
                WHERE ID = @ID

                IF @@ERROR <> 0 SET @Ok = 1

                IF @Ok IS NULL
                BEGIN
                               SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'
                               IF @@ERROR <> 0 SET @Ok = 1
                END
  END
END
GO

/**************** spInforReservarSolicitudInv****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforReservarSolicitudInv') and type = 'P') drop procedure dbo.spInforReservarSolicitudInv
GO             
CREATE PROCEDURE spInforReservarSolicitudInv
	   @Modulo	char(5),
           @ID          int,
           @Accion	char(20),
	   @Base	char(20),
           @GenerarMov	char(20),
	   @Usuario	char(10),
	   @SincroFinal	bit,
           @EnSilencio	bit,
    	   @Ok          int 	     OUTPUT,
    	   @OkRef       varchar(255) OUTPUT

--//WITH ENCRYPTION

AS BEGIN
  
DECLARE  

  @ArticuloD            varchar(20), 
  @CantidadD            float, 
  @SubCuenta            varchar(50), 
  @SubCuentaD           varchar(50), 
  @UnidadD              varchar(50),
  @AlmacenD             varchar(20),
  @Empresa              varchar(5),
  @CantidadReservada    float,
  @CantidadReservar     float,
  @CantidadPendiente    float,
  @IDSol                int, 
  @RenglonD             float, 
  @UnidadP              varchar(50),
  @IDAcceso             int,
  @Estacion             int,
  @ProdInterfazINFOR    bit,
  @MovClave             varchar(20),
  @OrigenTipo           varchar(20),
  @OrigenID             varchar(20),
  @Origen               varchar(20),
  @ReservarSolicitudesFacory bit
  
  

  
  IF @Modulo = 'COMS' AND @Accion = 'AFECTAR'  
  BEGIN
    SELECT @IDAcceso = dbo.fnAccesoID(@@SPID)  
    SELECT @Estacion = EstacionTrabajo  FROM Acceso WHERE ID = @IDAcceso 
    SELECT @Empresa = Empresa FROM Compra WHERE ID = @ID
    SELECT @ProdInterfazINFOR = ISNULL(ProdInterfazINFOR,0) FROM EmpresaGral WHERE Empresa = @Empresa  
    SELECT @MovClave = mt.Clave FROM Compra c JOIN MovTipo mt ON c.Mov = mt.Mov AND mt.Modulo = 'COMS' WHERE c.ID = @ID
    SELECT @Origen = Origen, @OrigenID = OrigenID FROM Compra WHERE ID =  @ID
    SELECT @OrigenTipo = OrigenTipo FROM Compra WHERE Empresa = @Empresa AND Mov = @Origen AND MovID = @OrigenID
    SELECT @ReservarSolicitudesFacory = ISNULL(ReservarSolicitudesFacory,0) FROM EmpresaCfg WHERE Empresa = @Empresa
    BEGIN TRAN
    IF @ProdInterfazINFOR = 1 AND @MovClave = 'COMS.F' AND @OrigenTipo = 'I:MES' AND @ReservarSolicitudesFacory = 1
    BEGIN
      
      IF @OK IS NULL  AND EXISTS(SELECT * FROM Inv i JOIN InvD d ON d.ID = i.ID JOIN MovTipo m ON m.Mov = i.Mov AND m.Modulo = 'INV' JOIN Compra c ON c.ID = @ID JOIN CompraD cd ON c.ID = cd.ID AND cd.Articulo = d.Articulo AND ISNULL(cd.SubCuenta,'') = ISNULL(d.SubCuenta,'') AND ISNULL(cd.Almacen,c.Almacen) = ISNULL(d.Almacen,i.Almacen) WHERE m.Clave = 'INV.SOL' AND i.Estatus = 'PENDIENTE' AND i.OrigenTipo = 'I:MES' AND ISNULL(d.CantidadPendiente,0.0) > 0 )
      BEGIN
        DECLARE crArt CURSOR LOCAL FAST_FORWARD FOR	  
         SELECT d.Articulo, d.Cantidad, d.SubCuenta, d.Unidad, ISNULL(d.Almacen,c.Almacen)
           FROM Compra c JOIN CompraD d ON c.ID = d.ID
          WHERE c.ID = @ID
        OPEN crArt
        FETCH NEXT FROM crArt INTO  @ArticuloD, @CantidadD, @SubCuentaD, @UnidadD, @AlmacenD
        WHILE @@FETCH_STATUS <> -1
        BEGIN
          SELECT @CantidadReservar = (@CantidadD * dbo.fnArtUnidadFactor(@Empresa, @ArticuloD, @UnidadD))
          DECLARE crSolicitudInv CURSOR LOCAL FAST_FORWARD FOR   
           SELECT d.ID, d.Renglon, ISNULL(d.CantidadPendiente,0), d.Unidad, ISNULL(d.CantidadReservada,0)
             FROM Inv i JOIN InvD d ON d.ID = i.ID JOIN MovTipo m ON m.Mov = i.Mov AND m.Modulo = 'INV'
            WHERE m.Clave = 'INV.SOL'
              AND i.Estatus = 'PENDIENTE'
              AND i.OrigenTipo = 'I:MES'
              AND ISNULL(d.CantidadPendiente,0.0) > 0  
              AND d.Articulo = @ArticuloD
              AND ISNULL(d.SubCuenta,'') = ISNULL(@SubCuenta,'')
              AND ISNULL(d.Almacen,i.Almacen) = @AlmacenD
          ORDER BY d.FechaRequerida, i.ID
          OPEN crSolicitudInv
          FETCH NEXT FROM crSolicitudInv INTO  @IDSol, @RenglonD, @CantidadPendiente, @UnidadP, @CantidadReservada	
          WHILE @@FETCH_STATUS <> -1 AND @CantidadReservar > 0 AND @Ok IS NULL
          BEGIN
            
            IF ISNULL(@CantidadReservar,0)>= @CantidadPendiente 
            BEGIN
              UPDATE InvD SET CantidadA = CantidadPendiente WHERE ID = @IDSol AND Renglon = @RenglonD
              SET @CantidadReservar = @CantidadReservar - @CantidadPendiente
              
              IF @@ROWCOUNT <> 0 AND EXISTS(SELECT * FROM InvD WHERE ID = @IDSol AND ISNULL(CantidadA,0) >0)
                EXEC  spAfectar 'INV', @IDSol, 'RESERVAR', 'Seleccion', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 0, @Estacion = @Estacion
            END
            ELSE
            BEGIN
              UPDATE InvD 
                 SET CantidadA = @CantidadReservar 
               WHERE ID = @IDSol AND Renglon = @RenglonD
              SET @CantidadReservar = 0  
              IF @@ROWCOUNT <> 0 AND EXISTS(SELECT * FROM InvD WHERE ID = @IDSol AND ISNULL(CantidadA,0) >0)
                EXEC  spAfectar 'INV', @IDSol, 'RESERVAR', 'Seleccion', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion
              
            END
              
            FETCH NEXT FROM crSolicitudInv INTO @IDSol, @RenglonD, @CantidadPendiente, @UnidadP, @CantidadReservada	
          END
          CLOSE crSolicitudInv
          DEALLOCATE crSolicitudInv
   
          FETCH NEXT FROM crArt INTO @ArticuloD, @CantidadD, @SubCuentaD, @UnidadD, @AlmacenD
        END
        CLOSE crArt
        DEALLOCATE crArt
      END      
    END 

    IF @Ok IS NULL
      COMMIT TRAN
    ELSE
      ROLLBACK TRAN  
      SELECT @Ok = NULL  
  END
  RETURN
END
GO


/**************** fnInforValidarCte ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnInforValidarCte') DROP FUNCTION fnInforValidarCte
GO
CREATE FUNCTION fnInforValidarCte
                (
                @NombreCorto                                                  varchar(20)
                )
RETURNS varchar(100)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Resultado   varchar(100)
    SET @Resultado = NULL

    IF NULLIF(@NombreCorto,'') IS NULL
      SELECT @Resultado = 'El campo Nombre Corto debe tener valor'
 RETURN (@Resultado)

END
GO

/**************** fnInforValidarArt ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnInforValidarArt') DROP FUNCTION fnInforValidarArt
GO
CREATE FUNCTION fnInforValidarArt
                (
                @AlmacenROP    varchar(20),
                @Proveedor         varchar(10),
                @Descripcion1   varchar(100),
                @UnidadCompra   varchar(50),
                @SeCompra       bit
                )
RETURNS varchar(100)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Resultado   varchar(100)
    SET @Resultado = NULL

    IF NULLIF(@AlmacenROP,'') IS NULL
      SELECT @Resultado = 'El campo Almacn Orden debe tener valor'
    IF NULLIF(@Proveedor,'') IS NULL AND ISNULL(@SeCompra,0)= 1
      SELECT @Resultado = 'El campo Proveedor (por omision) debe tener valor'
    IF NULLIF(@Descripcion1,'') IS NULL
      SELECT @Resultado = 'El campo Descripcin debe tener valor'
    IF NULLIF(@UnidadCompra,'') IS NULL
      SELECT @Resultado ='El campo Unidad Compra/Produccin debe tener valor'


 RETURN (@Resultado)

END
GO


/**************** spISIntelisisActualizarCosto ****************/
if exists (select * from sysobjects where id = object_id('dbo.spISIntelisisActualizarCosto') and type = 'P') drop procedure dbo.spISIntelisisActualizarCosto
GO            
CREATE PROCEDURE spISIntelisisActualizarCosto
                               @ID                        int,
                               @iSolicitud                           int,
                               @Version                              float,
                               @Resultado                         varchar(max) = NULL OUTPUT,
                               @Ok                                       int = NULL OUTPUT,   
                               @OkRef                                 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE

    @Estacion                        int,
    @SubReferencia                                            varchar(100),
    @ReferenciaIS                       varchar(100),
    @IDAcceso                           int




     DECLARE @Tabla table (

     Articulo                            varchar(20),
     Costo                                float,
     CostoReposicion    float
)   




  SELECT @IDAcceso = dbo.fnAccesoID(@@SPID)

  SELECT @Estacion = EstacionTrabajo  FROM Acceso WHERE ID = @IDAcceso


  INSERT @Tabla (Articulo, Costo, CostoReposicion )
  SELECT         Articulo, NuevoCostoEstandar, CostoReposicion
    FROM OPENXML(@iSolicitud, '/Intelisis/Solicitud/Scosto/DetalleAct',1) 
    WITH (Articulo  varchar(100), NuevoCostoEstandar float, CostoReposicion float )

  IF EXISTS(SELECT * FROM @Tabla)
    UPDATE Art SET CostoEstandar = ISNULL(NULLIF(t.Costo,0.0),a.CostoEstandar), CostoReposicion = ISNULL(NULLIF(t.CostoReposicion,0.0),a.CostoReposicion)
      FROM @Tabla t JOIN Art a ON a.Articulo = t.Articulo
  IF @@ERROR <> 0 SET @Ok = 1   

  IF @Ok IS NULL
  SELECT @ReferenciaIS = Referencia
    FROM IntelisisService
   WHERE ID = @ID


    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'
END
GO

/**************** spISIntelisisCOMSInsertarMovCOMS_Maquila ****************/
if exists (select * from sysobjects where id = object_id('dbo.spISIntelisisCOMSInsertarMovCOMS_Maquila') and type = 'P') drop procedure dbo.spISIntelisisCOMSInsertarMovCOMS_Maquila
GO           
CREATE PROCEDURE spISIntelisisCOMSInsertarMovCOMS_Maquila
            @ID               int,
            @iSolicitud       int,
            @Version          float,
            @Resultado        varchar(max) = NULL OUTPUT,
            @Ok               int = NULL OUTPUT, 
            @OkRef                  varchar(255) = NULL OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
      @IDGenerar        int,
      @IDAcceso                 int,  
      @MovTipo               varchar(20),
      @ReferenciaIS          varchar(100),
      @Usuario2              varchar(10),
      @Estacion              int,
      @SubReferencia         varchar(100),
      @Empresa               varchar(5),
      @Mov              varchar(20),   
      @Mov2                  varchar(20),   
      @MovID                 varchar(20),   
      @FechaEmision          datetime,
      @UltimoCambio          datetime,
      @Concepto         varchar(50),   
      @Proyecto         varchar(50),   
      @Actividad        varchar(100),  
      @UEN              int,
      @Moneda                varchar(10),   
      @TipoCambio            float,   
      @Usuario               varchar(10),   
      @Autorizacion          varchar(10),   
      @Referencia            varchar(50),   
      @DocFuente        int,
      @Observaciones         varchar(100),  
      @Estatus               varchar(15),   
      @Situacion        varchar(50),   
      @SituacionFecha        datetime,
      @SituacionUsuario      varchar(10),   
      @SituacionNota         varchar(100),  
      @Directo               bit,
      @VerDestino            bit,
      @Prioridad        varchar(10),   
      @Proveedor        varchar(10),   
      @FormaEnvio            varchar(50),   
      @FechaRequerida        datetime,
      @Almacen               varchar(10),   
      @AlmacenDestino        varchar(10),   
      @AlmacenMatPrima       varchar(10),   
      @Condicion        varchar(50),   
      @Vencimiento           datetime,
      @Manejo                 money,   
      @Fletes                money,   
      @ActivoFijo            bit,
      @Instruccion           varchar(50),   
      @Agente                varchar(10),   
      @Descuento        varchar(30),   
      @DescuentoGlobal       float,   
      @Importe          money,   
      @Impuestos             money,   
      @Saldo                 money,   
      @DescuentoLineal       money,   
      @OrigenTipo            varchar(10),   
      @Origen                varchar(20),   
      @OrigenID         varchar(20),   
      @Poliza                varchar(20),   
      @PolizaID         varchar(20),   
      @GenerarPoliza         bit,
      @ContID                 int,
      @Ejercicio        int,
      @Periodo               int,
      @FechaRegistro         datetime,
      @FechaConclusion       datetime,
      @FechaCancelacion      datetime,
      @Peso                  float,   
      @Volumen               float,   
      @Conciliado            bit,
      @Causa                 varchar(50),   
      @Atencion         varchar(50),   
      @FechaEntrega          datetime,
      @EmbarqueEstado        varchar(50),   
      @Sucursal         int,
      @Sucursal2        int,
      @ZonaImpuesto          varchar(30),   
      @Paquetes         int,
      @Idioma                varchar(50),   
      @IVAFiscal        float,   
      @IEPSFiscal            float,   
      @ListaPreciosEsp       varchar(20),   
      @EstaImpreso           bit,
      @Mensaje               int,
      @Logico1               bit,
      @Logico2               bit,
      @Logico3               bit,
      @Logico4               bit,
      @Logico5               bit,
      @Logico6               bit,
      @Logico7               bit,
      @Pagado                float,   
      @ProrrateoAplicaID     int,
      @FormaEntrega          varchar(50),   
      @CancelarPendiente     bit,
      @LineaCredito          varchar(20),   
      @TipoAmortizacion      varchar(20),   
      @TipoTasa         varchar(20),   
      @Comisiones            money,   
      @ComisionesIVA         money,   
      @OperacionRelevante    bit,
      @VIN              varchar(20),   
      @SubModulo        varchar(5),
      @AutoCargos            float,   
      @TieneTasaEsp          bit,
      @TasaEsp               float,   
      @Cliente               varchar(10),   
      @SucursalOrigen        int,
      @SucursalDestino       int,
      @ContUso               varchar(20),   
      @ContUso2         varchar(20),   
      @ContUso3         varchar(20),   
      @ContratoID            int,
      @ContratoMov           varchar(20),   
      @ContratoMovID         varchar(20),   
      @ReferenciaMES         varchar(50),   
------detalle
     @IDD                    int   ,
     @Renglon           float   ,
     @RenglonSub             int   ,
     @RenglonID              int   ,
     @RenglonTipo       char(1),
     @Cantidad         float   ,
     @AlmacenD          varchar(10),
     @Codigo                 varchar(30),
     @Articulo          varchar(20),
     @SubCuenta              varchar(50),
     @FechaRequeridaD        datetime   ,
     @FechaOrdenarD          datetime   ,
     @FechaEntregaD          datetime   ,
     @Costo                  float   ,
     @Impuesto1              float   ,
     @Impuesto2              float   ,
     @Impuesto3              float   ,
     @Retencion1             float   ,
     @Retencion2             float   ,
     @Retencion3             float   ,
     @DescuentoD             varchar(30),
     @DescuentoTipo          char(1),
     @DescuentoLinea         money   ,
     @DescuentoImporte       money   ,
     @DescripcionExtra       varchar(100),
     @ReferenciaExtra        varchar(50),
     @ContUsoD          varchar(20),
     @DestinoTipo            varchar(10),
     @Destino           varchar(20),
     @DestinoID              varchar(20),
     @Aplica                 varchar(20),
     @AplicaID          varchar(20),
     @CantidadPendiente      float   ,
     @CantidadCancelada      float   ,
     @CantidadA              float   ,
     @CostoInv          float   ,
     @Unidad                 varchar(50),
     @Factor                 float   ,
     @CantidadInventario     float   ,
     @ClienteD          varchar(10),
     @ServicioArticulo       varchar(20),
     @ServicioSerie          varchar(20),
     @Paquete           int   ,
     @SucursalD              int   ,
     @ImportacionProveedor   varchar(10),
     @ImportacionReferencia        varchar(50),
     @ProveedorRef           varchar(10),
     @AgenteRef              varchar(10),
     @EstadoRef              varchar(50),
     @FechaCaducidad         datetime   ,
     @ProveedorArt           varchar(10),
     @ProveedorArtCosto      float   ,
     @AjusteCosteo           money   ,
     @CostoUEPS              money   ,
     @CostoPEPS              money   ,
     @UltimoCosto            money   ,
     @PrecioLista            money   ,
     @Posicion          varchar(10),
     @DepartamentoDetallista       int   ,
     @Pais                   varchar(50),
     @TratadoComercial       varchar(50),
     @ProgramaSectorial      varchar(50),
     @ValorAduana            money   ,
     @ImportacionImpuesto1   float   ,
     @ImportacionImpuesto2   float   ,
     @ID1               char(2),
     @ID2               char(2),
     @FormaPago              varchar(50),
     @EsEstadistica          bit   ,
     @PresupuestoEsp         bit   ,
     @SucursalOrigenD        int   ,
     @ContUso2D              varchar(20),
     @ContUso3D         varchar(20),
     @Tarima                 varchar(20),
     @EmpresaRef             varchar(5),
     @Categoria              varchar(50),
     @Estado                 varchar(30),
     @CostoEstandar          money   ,
     @ABC                    varchar(50),
     @PaqueteCantidad        float   ,
     @CantidadEmbarcada      float   ,
     @ClavePresupuestal      varchar(50),
     @TipoImpuesto1          varchar(10),
     @TipoImpuesto2          varchar(10),
     @TipoImpuesto3          varchar(10),
     @TipoRetencion1         varchar(10),
     @TipoRetencion2         varchar(10),
     @TipoRetencion3         varchar(10),
     @CostoConImpuesto       float   ,
     @TipoImpuesto4          varchar(10),
     @CostoPromedio          money   ,
     @CostoReposicion        money   ,
     @TipoImpuesto5          varchar(10),
     @Impuesto5              float   ,
     @ArtTipo                varchar(20),
     @Decimales              int,
     @ReferenciaIntelisisService    varchar(50),
     @MovIntelisisMES        varchar(10),
     @MovMoneda              varchar(10),
     @MovTipoCambio          float,
     @MovZonaImpuesto        varchar(30),
     @ArtImpuesto1           float,
     @ArtImpuesto2           float,
     @ArtImpuesto3           money,
     @ArtRetencion1          float,
     @ArtRetencion2          float,
     @ArtRetencion3          float,
     @CfgCompraCostoSugerido       char(20),
     @CfgMultiUnidades       bit,
     @CfgMermaIncluida          bit,
     @CfgDesperdicioIncluido    bit,
     @CfgTipoMerma              char(1),
     @CfgMultiUnidadesNivel  char(20),
     @CantidadOrden             float,
     @Planta                 varchar(20),
     @ArtMaterial               varchar(20),
     @UnidadMaterial            varchar(50),
     @IDGenerarInv              int,
     @MovTransferencia          varchar(20),
     @RenglonInv                float,
     @DefPosicionSurtido        varchar(10),
     @DefPosicionRecibo         varchar(10),
     @MovEntrada                varchar(20),
     @TieneMateriales           bit,
     @Transforma                bit




  DECLARE @Temp             table
         (
  IDD                              int   ,
  Renglon                                float   ,
  RenglonSub                             int   ,
  RenglonID                              int   ,
  RenglonTipo                            char(1),
  Cantidad                               float   ,
  Almacen                                varchar(10),
  Codigo                           varchar(30),
  Articulo                               varchar(20),
  SubCuenta                              varchar(50),
  FechaRequerida                         datetime   ,
  FechaOrdenar                     datetime   ,
  FechaEntrega                     datetime   ,
  Costo                            float   ,
  Impuesto1                              float   ,
  Impuesto2                              float   ,
  Impuesto3                              float   ,
  Retencion1                             float   ,
  Retencion2                             float   ,
  Retencion3                             float   ,
  Descuento                              varchar(30),
  DescuentoTipo                          char(1),
  DescuentoLinea                           money   ,
  DescuentoImporte                         money   ,
  DescripcionExtra                         varchar(100),
  ReferenciaExtra                          varchar(50),
  ContUso                                varchar(20),
  DestinoTipo                      varchar(10),
  Destino                                varchar(20),
  DestinoID                              varchar(20),
  Aplica                           varchar(20),
  AplicaID                               varchar(20),
  CantidadPendiente                        float   ,
  CantidadCancelada                        float   ,
  CantidadA                              float   ,
  CostoInv                               float   ,
  Unidad                           varchar(50),
  Factor                           float   ,
  CantidadInventario                       float   ,
  Cliente                                varchar(10),
  ServicioArticulo                         varchar(20),
  ServicioSerie                          varchar(20),
  Paquete                                int   ,
  Sucursal                               int   ,
  ImportacionProveedor                     varchar(10),
  ImportacionReferencia                    varchar(50),
  ProveedorRef                     varchar(10),
  AgenteRef                              varchar(10),
  EstadoRef                              varchar(50),
  FechaCaducidad                         datetime   ,
  ProveedorArt                     varchar(10),
  ProveedorArtCosto                        float   ,
  AjusteCosteo                           money   ,
  CostoUEPS                              money   ,
  CostoPEPS                              money   ,
  UltimoCosto                      money   ,
  PrecioLista                      money   ,
  Posicion                               varchar(10),
  DepartamentoDetallista                   int   ,
  Pais                             varchar(50),
  TratadoComercial                         varchar(50),
  ProgramaSectorial                      varchar(50),
  ValorAduana                      money   ,
  ImportacionImpuesto1                     float   ,
  ImportacionImpuesto2                     float   ,
  ID1                              char(2),
  ID2                              char(2),
  FormaPago                              varchar(50),
  EsEstadistica                          bit   ,
  PresupuestoEsp                         bit   ,
  SucursalOrigen                         int   ,
  ContUso2                               varchar(20),
  ContUso3                               varchar(20),
  Tarima                           varchar(20),
  EmpresaRef                             varchar(5),
  Categoria                              varchar(50),
  Estado                           varchar(30),
  CostoEstandar                          money   ,
  ABC                              varchar(50),
  PaqueteCantidad                          float   ,
  CantidadEmbarcada                        float   ,
  ClavePresupuestal                        varchar(50),
  TipoImpuesto1                          varchar(10),
  TipoImpuesto2                          varchar(10),
  TipoImpuesto3                          varchar(10),
  TipoRetencion1                         varchar(10),
  TipoRetencion2                         varchar(10),
  TipoRetencion3                         varchar(10),
  CostoConImpuesto                         float   ,
  TipoImpuesto4                          varchar(10),
  CostoPromedio                          money   ,
  CostoReposicion                          money   ,
  TipoImpuesto5                          varchar(10),
  Impuesto5                              float ,
  MovIntelisisMES                  varchar(10),
  Servicio                                      varchar(20)
         )
  SET @TieneMateriales = 0
  SELECT @IDAcceso = dbo.fnAccesoID(@@SPID)
  SELECT @Estacion = 1 ,@Usuario2 = Usuario FROM Acceso WHERE ID = @IDAcceso
  IF @Ok IS NULL
  BEGIN
    SELECT @Mov =  NULLIF(Mov,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH (Mov varchar(255))
    IF @@ERROR <> 0 SET @Ok = 1
  END
  IF @Ok IS NULL
  SELECT @Mov2 = Mov FROM MapeoMovimientosInforIntelisis WHERE INFORMov = @Mov

    SELECT @MovTipo = Clave
        FROM MovTipo
     WHERE Modulo = 'COMS' AND Mov = @Mov
  IF @MovTipo <> 'COMS.O' SELECT @Ok = 35005, @OkRef = @Mov
  IF @Ok IS NULL
  BEGIN

    SELECT @Mov2 = NULLIF(Mov,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Mov  varchar(255))
   SELECT @MovID = NULLIF(MovID,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(MovID  varchar(255))
    SELECT @FechaEmision  = dbo.fnFechaSinHora(GETDATE())
    SELECT @UltimoCambio  = CONVERT(datetime,UltimoCambio)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(UltimoCambio  varchar(255))
    SELECT @Concepto = NULLIF(Concepto,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Concepto  varchar(255))
    SELECT @Proyecto = NULLIF(Proyecto,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Proyecto  varchar(255))
    SELECT @Actividad = NULLIF(Actividad,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Actividad  varchar(255))
    SELECT @UEN   = CONVERT(int ,UEN)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(UEN  varchar(255))
    SELECT @Moneda = NULLIF(Moneda,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Moneda  varchar(255))
    SELECT @TipoCambio   = CONVERT(float,TipoCambio)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(TipoCambio  varchar(255))
    SELECT @Usuario = NULLIF(Usuario,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Usuario  varchar(255))
    SELECT @Autorizacion = NULLIF(Autorizacion,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Autorizacion  varchar(255))
    SELECT @Referencia = NULLIF(Referencia,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Referencia  varchar(255))
    SELECT @DocFuente   = CONVERT(int ,DocFuente)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(DocFuente  varchar(255))
    SELECT @Observaciones = NULLIF(Observaciones,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Observaciones  varchar(255))
    SELECT @Estatus = NULLIF(Estatus,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Estatus  varchar(255))
    SELECT @Situacion = NULLIF(Situacion,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Situacion  varchar(255))
    SELECT @SituacionFecha  = CONVERT(datetime,SituacionFecha)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(SituacionFecha  varchar(255))
    SELECT @SituacionUsuario = NULLIF(SituacionUsuario,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(SituacionUsuario  varchar(255))
    SELECT @SituacionNota = NULLIF(SituacionNota,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(SituacionNota  varchar(255))
    SELECT @Directo  = CONVERT(bit,Directo)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Directo  varchar(255))
    SELECT @VerDestino  = CONVERT(bit,VerDestino)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(VerDestino  varchar(255))
    SELECT @Prioridad = NULLIF(Prioridad,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Prioridad  varchar(255))
    SELECT @RenglonID   = CONVERT(int ,RenglonID)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(RenglonID  varchar(255))
    SELECT @Proveedor = NULLIF(Proveedor,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Proveedor  varchar(255))
    SELECT @FormaEnvio = NULLIF(FormaEnvio,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(FormaEnvio  varchar(255))
    SELECT @FechaRequerida  = CONVERT(datetime,FechaRequerida)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(FechaRequerida  varchar(255))
    SELECT @Almacen = NULLIF(Almacen,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Almacen  varchar(255))
    SELECT @Condicion = NULLIF(Condicion,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Condicion  varchar(255))
    SELECT @Vencimiento  = CONVERT(datetime,Vencimiento)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Vencimiento  varchar(255))
    SELECT @Manejo   = CONVERT(money ,Manejo)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Manejo  varchar(255))
    SELECT @Fletes   = CONVERT(money ,Fletes)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Fletes  varchar(255))
    SELECT @ActivoFijo  = CONVERT(bit,ActivoFijo)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ActivoFijo  varchar(255))
    SELECT @Instruccion = NULLIF(Instruccion,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Instruccion  varchar(255))
    SELECT @Agente = NULLIF(Agente,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Agente  varchar(255))
    SELECT @Descuento = NULLIF(Descuento,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Descuento  varchar(255))
    SELECT @DescuentoGlobal   = CONVERT(float,DescuentoGlobal)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(DescuentoGlobal  varchar(255))
    SELECT @Importe   = CONVERT(money ,Importe)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Importe  varchar(255))
    SELECT @Impuestos   = CONVERT(money ,Impuestos)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Impuestos  varchar(255))
    SELECT @Saldo   = CONVERT(money ,Saldo)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Saldo  varchar(255))
    SELECT @DescuentoLineal   = CONVERT(money ,DescuentoLineal)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(DescuentoLineal  varchar(255))
    SELECT @OrigenTipo = NULLIF(OrigenTipo,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(OrigenTipo  varchar(255))
    SELECT @Origen = NULLIF(Origen,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Origen  varchar(255))
    SELECT @OrigenID = NULLIF(OrigenID,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(OrigenID  varchar(255))
    SELECT @Poliza = NULLIF(Poliza,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Poliza  varchar(255))
    SELECT @PolizaID = NULLIF(PolizaID,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(PolizaID  varchar(255))
    SELECT @GenerarPoliza  = CONVERT(bit,GenerarPoliza)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(GenerarPoliza  varchar(255))
    SELECT @ContID   = CONVERT(int ,ContID)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContID  varchar(255))
    SELECT @Ejercicio   = CONVERT(int ,Ejercicio)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Ejercicio  varchar(255))
    SELECT @Periodo   = CONVERT(int ,Periodo)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Periodo  varchar(255))
    SELECT @FechaRegistro  = GETDATE()
    SELECT @Peso   = CONVERT(float,Peso)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Peso  varchar(255))
    SELECT @Volumen   = CONVERT(float,Volumen)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Volumen  varchar(255))
    SELECT @Conciliado  = CONVERT(bit,Conciliado)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Conciliado  varchar(255))
    SELECT @Causa = NULLIF(Causa,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Causa  varchar(255))
    SELECT @Atencion = NULLIF(Atencion,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Atencion  varchar(255))
    SELECT @FechaEntrega  = CONVERT(datetime,FechaEntrega)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(FechaEntrega  varchar(255))
    SELECT @EmbarqueEstado = NULLIF(EmbarqueEstado,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(EmbarqueEstado  varchar(255))
    SELECT @ZonaImpuesto = NULLIF(ZonaImpuesto,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ZonaImpuesto  varchar(255))
    SELECT @Paquetes   = CONVERT(int ,Paquetes)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Paquetes  varchar(255))
    SELECT @Idioma = NULLIF(Idioma,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Idioma  varchar(255))
    SELECT @IVAFiscal   = CONVERT(float,IVAFiscal)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(IVAFiscal  varchar(255))
    SELECT @IEPSFiscal   = CONVERT(float,IEPSFiscal)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(IEPSFiscal  varchar(255))
    SELECT @ListaPreciosEsp = NULLIF(ListaPreciosEsp,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ListaPreciosEsp  varchar(255))
    SELECT @EstaImpreso  = CONVERT(bit,EstaImpreso)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(EstaImpreso  varchar(255))
    SELECT @Mensaje   = CONVERT(int ,Mensaje)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Mensaje  varchar(255))
    SELECT @Logico1  = CONVERT(bit,Logico1)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico1  varchar(255))
    SELECT @Logico2  = CONVERT(bit,Logico2)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico2  varchar(255))
    SELECT @Logico3  = CONVERT(bit,Logico3)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico3  varchar(255))
    SELECT @Logico4  = CONVERT(bit,Logico4)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico4  varchar(255))
    SELECT @Logico5  = CONVERT(bit,Logico5)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico5  varchar(255))
    SELECT @Logico6  = CONVERT(bit,Logico6)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico6  varchar(255))
    SELECT @Logico7  = CONVERT(bit,Logico7)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Logico7  varchar(255))
    SELECT @Pagado   = CONVERT(float,Pagado)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Pagado  varchar(255))
    SELECT @ProrrateoAplicaID   = CONVERT(int ,ProrrateoAplicaID)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ProrrateoAplicaID  varchar(255))
    SELECT @FormaEntrega = NULLIF(FormaEntrega,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(FormaEntrega  varchar(255))
    SELECT @CancelarPendiente  = CONVERT(bit,CancelarPendiente)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(CancelarPendiente  varchar(255))
    SELECT @LineaCredito = NULLIF(LineaCredito,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(LineaCredito  varchar(255))
    SELECT @TipoAmortizacion = NULLIF(TipoAmortizacion,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(TipoAmortizacion  varchar(255))
    SELECT @TipoTasa = NULLIF(TipoTasa,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(TipoTasa  varchar(255))
    SELECT @Comisiones   = CONVERT(money ,Comisiones)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Comisiones  varchar(255))
    SELECT @ComisionesIVA   = CONVERT(money ,ComisionesIVA)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ComisionesIVA  varchar(255))
    SELECT @OperacionRelevante  = CONVERT(bit,OperacionRelevante)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(OperacionRelevante  varchar(255))
    SELECT @VIN = NULLIF(VIN,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(VIN  varchar(255))
    SELECT @SubModulo = NULLIF(SubModulo,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(SubModulo  varchar(255))
    SELECT @AutoCargos   = CONVERT(float,AutoCargos)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(AutoCargos  varchar(255))
    SELECT @TieneTasaEsp  = CONVERT(bit,TieneTasaEsp)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(TieneTasaEsp  varchar(255))
    SELECT @TasaEsp   = CONVERT(float,TasaEsp)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(TasaEsp  varchar(255))
    SELECT @Cliente = NULLIF(Cliente,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(Cliente  varchar(255))
    SELECT @SucursalOrigen   = CONVERT(int ,SucursalOrigen)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(SucursalOrigen  varchar(255))
    SELECT @SucursalDestino   = CONVERT(int ,SucursalDestino)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(SucursalDestino varchar(255))
    SELECT @ContUso = NULLIF(ContUso,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContUso  varchar(255))
    SELECT @ContUso2 = NULLIF(ContUso2,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContUso2  varchar(255))
    SELECT @ContUso3 = NULLIF(ContUso3,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContUso3  varchar(255))
    SELECT @ContratoID   = CONVERT(int ,ContratoID)  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContratoID  varchar(255))
    SELECT @ContratoMov = NULLIF(ContratoMov,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContratoMov  varchar(255))
    SELECT @ContratoMovID = NULLIF(ContratoMovID,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ContratoMovID  varchar(255))
    SELECT @ReferenciaIntelisisService = NULLIF(ReferenciaIntelisisService,'')  FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH(ReferenciaIntelisisService  varchar(255))
    SELECT @MovIntelisisMES =  NULLIF(MovIntelisisMES,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH (MovIntelisisMES varchar(255))
    SELECT @ReferenciaMES =  NULLIF(ReferenciaMES,'') FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Compra')
      WITH (ReferenciaMES varchar(255)) 

    SELECT @Transforma =  ISNULL(Transforma,0) FROM openxml (@iSolicitud,'/Intelisis')
      WITH (Transforma bit)         





   END
  IF @Ok IS NULL
  BEGIN


    IF NOT EXISTS(SELECT * FROM Prov WHERE Proveedor = @Proveedor ) SELECT @Ok = 26050
    IF NOT EXISTS(SELECT * FROM Mon WHERE Moneda = @Moneda ) SELECT @Ok = 20196
    --IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) SELECT @Ok = 20830
    IF NOT EXISTS(SELECT * FROM Proy WHERE Proyecto = @Proyecto ) AND NULLIF(@Proyecto,'') IS NOT NULL SELECT @Ok = 15010
    IF NOT EXISTS(SELECT * FROM UEN WHERE UEN = @UEN ) AND NULLIF(@UEN,'') IS NOT NULL SELECT @Ok = 10070
    IF NOT EXISTS(SELECT * FROM MovTipo WHERE Modulo = 'COMS' AND Mov = @Mov ) SELECT @Ok = 14055
    SELECT @Empresa = Empresa ,@Sucursal = Sucursal, @SucursalOrigen = Sucursal, @AlmacenMatPrima = AlmacenMatPrima
      FROM MapeoPlantaIntelisisMes
     WHERE Referencia = @ReferenciaIntelisisService
     SELECT @Sucursal2 = @Sucursal
  END
  IF @Ok IS NULL
  BEGIN
    IF @Almacen NOT IN(SELECT Almacen FROM Alm WHERE Sucursal = @Sucursal)
      SELECT @Almacen = AlmacenPrincipal FROM Sucursal WHERE Sucursal = @Sucursal
    SELECT @OrigenTipo='I:MES'
    SELECT @Moneda = m.Moneda,
         @TipoCambio = m.TipoCambio,
         @CfgCompraCostoSugerido = cfg.CompraCostoSugerido      
    FROM EmpresaCfg cfg, Mon m
   WHERE Empresa = @Empresa AND m.Moneda = cfg.ContMoneda
  SELECT @CfgMermaIncluida    = ProdMermaIncluida,
         @CfgDesperdicioIncluido = ProdDesperdicioIncluido,
         @CfgMultiUnidades       = MultiUnidades,
      @CfgMultiUnidadesNivel  = ISNULL(UPPER(NivelFactorMultiUnidad), 'UNIDAD'),
         @CfgTipoMerma       = ISNULL(ProdTipoMerma, '%')
    FROM EmpresaCfg2
   WHERE Empresa = @Empresa
   SET @Estatus = 'CONFIRMAR'
    INSERT INTO Compra (Empresa,  Mov,  MovID,  FechaEmision,  UltimoCambio,  Concepto,  Proyecto,  Actividad,  UEN,  Moneda,  TipoCambio,  Usuario,  Autorizacion,  Referencia,  DocFuente,  Observaciones,  Estatus,  Situacion,  SituacionFecha,  SituacionUsuario,  SituacionNota,  Directo,  VerDestino,  Prioridad,  RenglonID,  Proveedor,  FormaEnvio,  FechaRequerida,  Almacen,  Condicion,  Vencimiento,  Manejo,  Fletes,  ActivoFijo,  Instruccion,  Agente,  Descuento,  DescuentoGlobal,  Importe,  Impuestos,  Saldo,  DescuentoLineal,  OrigenTipo,  Origen,  OrigenID,  Poliza,  PolizaID,  GenerarPoliza,  ContID,  Ejercicio,  Periodo,  FechaRegistro,  FechaConclusion,  FechaCancelacion,  Peso,  Volumen,  Conciliado,  Causa,  Atencion,  FechaEntrega,  EmbarqueEstado,  Sucursal,  ZonaImpuesto,  Paquetes,  Idioma,  IVAFiscal,  IEPSFiscal,  ListaPreciosEsp,  EstaImpreso,  Mensaje,  Logico1,  Logico2,  Logico3,  Logico4,  Logico5,  Logico6,  Logico7,  Pagado,  ProrrateoAplicaID,  FormaEntrega,  CancelarPendiente,  LineaCredito,  TipoAmortizacion,  TipoTasa,  Comisiones,  ComisionesIVA,  OperacionRelevante,  VIN,  SubModulo,  AutoCargos,  TieneTasaEsp,  TasaEsp,  Cliente, SucursalOrigen,  SucursalDestino,  ContUso,  ContUso2,  ContUso3,  ContratoID,  ContratoMov,  ContratoMovID ,MovIntelisisMES,ReferenciaMES)
           VALUES (      @Empresa, @Mov2, @MovID, @FechaEmision, @UltimoCambio, @Concepto, @Proyecto, @Actividad, @UEN, @Moneda, @TipoCambio, @Usuario, @Autorizacion, @Referencia, @DocFuente, @Observaciones, @Estatus, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @Directo, @VerDestino, @Prioridad, @RenglonID, @Proveedor, @FormaEnvio, @FechaRequerida, @Almacen, @Condicion, @Vencimiento, @Manejo, @Fletes, @ActivoFijo, @Instruccion, @Agente, @Descuento, @DescuentoGlobal, @Importe, @Impuestos, @Saldo, @DescuentoLineal, @OrigenTipo, @Origen, @OrigenID, @Poliza, @PolizaID, @GenerarPoliza, @ContID, @Ejercicio, @Periodo, @FechaRegistro, @FechaConclusion, @FechaCancelacion, @Peso, @Volumen, @Conciliado, @Causa, @Atencion, @FechaEntrega, @EmbarqueEstado, ISNULL(@Sucursal,@Sucursal2), @ZonaImpuesto, @Paquetes, @Idioma, @IVAFiscal, @IEPSFiscal, @ListaPreciosEsp, @EstaImpreso, @Mensaje, @Logico1, @Logico2, @Logico3, @Logico4, @Logico5, @Logico6, @Logico7, @Pagado, @ProrrateoAplicaID, @FormaEntrega, @CancelarPendiente, @LineaCredito, @TipoAmortizacion, @TipoTasa, @Comisiones, @ComisionesIVA, @OperacionRelevante, @VIN, @SubModulo, @AutoCargos, @TieneTasaEsp, @TasaEsp, @Cliente, @SucursalOrigen, @SucursalDestino, @ContUso, @ContUso2, @ContUso3, @ContratoID, @ContratoMov, @ContratoMovID,ISNULL(@MovIntelisisMES,''),@ReferenciaMES)
    IF @@ERROR <> 0 SET @Ok = 1
    SET @IDGenerar = SCOPE_IDENTITY()


  IF @Proveedor IS NOT NULL
  UPDATE Compra
     SET Proyecto       = ISNULL(Compra.Proyecto,p.Proyecto),
        FormaEnvio      = p.FormaEnvio,
        Agente    = p.Agente,
        Condicion = p.Condicion,
      ZonaImpuesto      = p.ZonaImpuesto,
      Idioma      = p.Idioma,
        Moneda       = m.Moneda,
        TipoCambio      = m.TipoCambio
    FROM Compra, Prov p, Mon m
   WHERE Compra.ID = @IDGenerar AND p.Proveedor = @Proveedor AND m.Moneda = ISNULL(p.DefMoneda, @Moneda)
  END
  SELECT @RenglonSub = 0
  INSERT @Temp (   Cantidad,  Almacen,  Codigo,  Articulo,  SubCuenta,  FechaRequerida,  FechaOrdenar,  FechaEntrega,  Costo,  Impuesto1,  Impuesto2,  Impuesto3,  Retencion1,  Retencion2,  Retencion3,  Descuento,  DescuentoTipo,  DescuentoLinea,  DescuentoImporte,  DescripcionExtra,  ReferenciaExtra,  ContUso,  DestinoTipo,  Destino,  DestinoID,  Aplica,  AplicaID,  CantidadPendiente,  CantidadCancelada,  CantidadA,  CostoInv,  Unidad,             Factor,  CantidadInventario,  Cliente,  ServicioArticulo,  ServicioSerie,  Paquete,  Sucursal,  ImportacionProveedor,  ImportacionReferencia,  ProveedorRef,  AgenteRef,  EstadoRef,  FechaCaducidad,  ProveedorArt,  ProveedorArtCosto,  AjusteCosteo,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  Posicion,  DepartamentoDetallista,  Pais,  TratadoComercial,  ProgramaSectorial,  ValorAduana,  ImportacionImpuesto1,  ImportacionImpuesto2,  ID1,  ID2,  FormaPago,  EsEstadistica,  PresupuestoEsp,  SucursalOrigen,  ContUso2,  ContUso3,  Tarima,  EmpresaRef,  Categoria,  Estado,  CostoEstandar,  ABC,  PaqueteCantidad,  CantidadEmbarcada,  ClavePresupuestal,  TipoImpuesto1,  TipoImpuesto2,  TipoImpuesto3,  TipoRetencion1,  TipoRetencion2,  TipoRetencion3,  CostoConImpuesto,  TipoImpuesto4,  CostoPromedio,  CostoReposicion,  TipoImpuesto5,  Impuesto5 ,Servicio )
  SELECT          Cantidad,  Almacen,  Codigo,  Articulo,  SubCuenta,  FechaRequerida,  FechaOrdenar,  FechaEntrega,  Costo,  Impuesto1,  Impuesto2,  Impuesto3,  Retencion1,  Retencion2,  Retencion3,  Descuento,  DescuentoTipo,  DescuentoLinea,  DescuentoImporte,  DescripcionExtra,  ReferenciaExtra,  ContUso,  DestinoTipo,  Destino,  DestinoID,  Aplica,  AplicaID,  CantidadPendiente,  CantidadCancelada,  CantidadA,  CostoInv,   DescripcionUnidad,  Factor,  CantidadInventario,  Cliente,  ServicioArticulo,  ServicioSerie,  Paquete,  Sucursal,  ImportacionProveedor,  ImportacionReferencia,  ProveedorRef,  AgenteRef,  EstadoRef,  FechaCaducidad,  ProveedorArt,  ProveedorArtCosto,  AjusteCosteo,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  Posicion,  DepartamentoDetallista,  Pais,  TratadoComercial,  ProgramaSectorial,  ValorAduana,  ImportacionImpuesto1,  ImportacionImpuesto2,  ID1,  ID2,  FormaPago,  EsEstadistica,  PresupuestoEsp,  SucursalOrigen,  ContUso2,  ContUso3,  Tarima,  EmpresaRef,  Categoria,  Estado,  CostoEstandar,  ABC,  PaqueteCantidad,  CantidadEmbarcada,  ClavePresupuestal,  TipoImpuesto1,  TipoImpuesto2,  TipoImpuesto3,  TipoRetencion1,  TipoRetencion2,  TipoRetencion3,  CostoConImpuesto,  TipoImpuesto4,  CostoPromedio,  CostoReposicion,  TipoImpuesto5,  Impuesto5 ,Servicio
    FROM OPENXML (@iSolicitud, '/Intelisis/Solicitud/Compra/DetalleCompra',1)
    WITH (RenglonSub  varchar(100),  RenglonID  varchar(100),  RenglonTipo  varchar(100),  Cantidad  varchar(100),  Almacen  varchar(100),  Codigo  varchar(100),  Articulo  varchar(100),  SubCuenta  varchar(100),  FechaRequerida  varchar(100),  FechaOrdenar  varchar(100),  FechaEntrega  varchar(100),  Costo  varchar(100),  Impuesto1  varchar(100),  Impuesto2  varchar(100),  Impuesto3  varchar(100),  Retencion1  varchar(100),  Retencion2  varchar(100),  Retencion3  varchar(100),  Descuento  varchar(100),  DescuentoTipo  varchar(100),  DescuentoLinea  varchar(100),  DescuentoImporte  varchar(100),  DescripcionExtra  varchar(100),  ReferenciaExtra  varchar(100),  ContUso  varchar(100),  DestinoTipo  varchar(100),  Destino  varchar(100),  DestinoID  varchar(100),  Aplica  varchar(100),  AplicaID  varchar(100),  CantidadPendiente  varchar(100),  CantidadCancelada  varchar(100),  CantidadA  varchar(100),  CostoInv  varchar(100),  Unidad  varchar(100),  Factor  varchar(100),  CantidadInventario  varchar(100),  Cliente  varchar(100),  ServicioArticulo  varchar(100),  ServicioSerie  varchar(100),  Paquete  varchar(100),  Sucursal  varchar(100),  ImportacionProveedor  varchar(100),  ImportacionReferencia  varchar(100),  ProveedorRef  varchar(100),  AgenteRef  varchar(100),  EstadoRef  varchar(100),  FechaCaducidad  varchar(100),  ProveedorArt  varchar(100),  ProveedorArtCosto  varchar(100),  AjusteCosteo  varchar(100),  CostoUEPS  varchar(100),  CostoPEPS  varchar(100),  UltimoCosto  varchar(100),  PrecioLista  varchar(100),  Posicion  varchar(100),  DepartamentoDetallista  varchar(100),  Pais  varchar(100),  TratadoComercial  varchar(100),  ProgramaSectorial  varchar(100),  ValorAduana  varchar(100),  ImportacionImpuesto1  varchar(100),  ImportacionImpuesto2  varchar(100),  ID1  varchar(100),  ID2  varchar(100),  FormaPago  varchar(100),  EsEstadistica  varchar(100),  PresupuestoEsp  varchar(100),  SucursalOrigen  varchar(100),  ContUso2  varchar(100),  ContUso3  varchar(100),  Tarima  varchar(100),  EmpresaRef  varchar(100),  Categoria  varchar(100),  Estado  varchar(100),  CostoEstandar  varchar(100),  ABC  varchar(100),  PaqueteCantidad  varchar(100),  CantidadEmbarcada  varchar(100),  ClavePresupuestal  varchar(100),  TipoImpuesto1  varchar(100),  TipoImpuesto2  varchar(100),  TipoImpuesto3  varchar(100),  TipoRetencion1  varchar(100),  TipoRetencion2  varchar(100),  TipoRetencion3  varchar(100),  CostoConImpuesto  varchar(100),  TipoImpuesto4  varchar(100),CostoPromedio  varchar(100),  CostoReposicion  varchar(100),  TipoImpuesto5  varchar(100),  Impuesto5 varchar(100), DescripcionUnidad varchar(100), Servicio varchar(100) )

  SELECT @AlmacenDestino = Almacen FROM Prov WHERE Proveedor = @Proveedor
  SELECT @DefPosicionSurtido = DefPosicionSurtido FROM Alm WHERE Almacen = @AlmacenMatPrima
  SELECT  @DefPosicionRecibo = DefPosicionRecibo FROM Alm WHERE Almacen = @AlmacenDestino
  SELECT TOP 1 @MovTransferencia = Mov FROM MovTipo WHERE Modulo = 'INV' AND Clave = 'INV.OT'
  SELECT TOP 1 @MovEntrada = Mov FROM MovTipo WHERE Modulo = 'INV' AND Clave = 'INV.E'
  IF EXISTS(SELECT * FROM @Temp a JOIN ArtMaterial m ON a.Articulo = m.Articulo) AND @Transforma = 0
  BEGIN
     SET @TieneMateriales = 1

    INSERT INTO Inv (Empresa, Mov,  MovID, FechaEmision,   Concepto, Proyecto, Actividad,   UEN,   Moneda,   TipoCambio,   Usuario, Referencia, DocFuente, Observaciones, Estatus, Situacion, SituacionFecha, SituacionUsuario,   SituacionNota,   Prioridad, Directo, RenglonID,    Almacen,          AlmacenDestino,   FechaRequerida,   Condicion,   Vencimiento, FormaEnvio, OrigenTipo, Origen, OrigenID, Poliza,   PolizaID,   GenerarPoliza, ContID, Ejercicio, Periodo,   FechaRegistro,   FechaConclusion,   FechaCancelacion,   Peso,  Volumen, Paquetes, FechaEntrega, EmbarqueEstado,   Sucursal,   Importe,    VerDestino, EstaImpreso,    SubModulo,   SucursalOrigen, SucursalDestino)
    VALUES      (   @Empresa, @MovTransferencia, NULL, @FechaEmision,  @Concepto, @Proyecto, @Actividad, @UEN, @Moneda, @TipoCambio, @Usuario,  @Referencia, @DocFuente, @Observaciones, @Estatus, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @Prioridad, @Directo, @RenglonID, @AlmacenMatPrima, @AlmacenDestino, @FechaRequerida, @Condicion, @Vencimiento, @FormaEnvio, @OrigenTipo, @Origen, @OrigenID, @Poliza, @PolizaID, @GenerarPoliza, @ContID, @Ejercicio, @Periodo, @FechaRegistro, @FechaConclusion, @FechaCancelacion, @Peso, @Volumen, @Paquetes, @FechaEntrega, @EmbarqueEstado, @Sucursal, @Importe,  @VerDestino, @EstaImpreso,  'INV', @SucursalOrigen, @SucursalDestino)
    IF @@ERROR <> 0 SET @Ok = 1
    SET @IDGenerarInv = SCOPE_IDENTITY()
  END
  ELSE
  IF NOT EXISTS(SELECT * FROM @Temp a JOIN ArtMaterial m ON a.Articulo = m.Articulo) AND @Transforma = 1
  BEGIN
    INSERT INTO Inv (Empresa, Mov,  MovID, FechaEmision,   Concepto, Proyecto, Actividad,   UEN,   Moneda,   TipoCambio,   Usuario, Referencia, DocFuente, Observaciones, Estatus, Situacion, SituacionFecha, SituacionUsuario,   SituacionNota,   Prioridad, Directo, RenglonID,    Almacen,          AlmacenDestino,   FechaRequerida,   Condicion,   Vencimiento, FormaEnvio, OrigenTipo, Origen, OrigenID, Poliza,   PolizaID,   GenerarPoliza, ContID, Ejercicio, Periodo,   FechaRegistro,   FechaConclusion,   FechaCancelacion,   Peso,  Volumen, Paquetes, FechaEntrega, EmbarqueEstado,   Sucursal,   Importe,    VerDestino, EstaImpreso,    SubModulo,   SucursalOrigen, SucursalDestino)
    VALUES      (   @Empresa, @MovTransferencia, NULL, @FechaEmision,  @Concepto, @Proyecto, @Actividad, @UEN, @Moneda, @TipoCambio, @Usuario,  @Referencia, @DocFuente, @Observaciones, @Estatus, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @Prioridad, @Directo, @RenglonID, @AlmacenMatPrima, @AlmacenDestino, @FechaRequerida, @Condicion, @Vencimiento, @FormaEnvio, @OrigenTipo, @Origen, @OrigenID, @Poliza, @PolizaID, @GenerarPoliza, @ContID, @Ejercicio, @Periodo, @FechaRegistro, @FechaConclusion, @FechaCancelacion, @Peso, @Volumen, @Paquetes, @FechaEntrega, @EmbarqueEstado, @Sucursal, @Importe,  @VerDestino, @EstaImpreso,  'INV', @SucursalOrigen, @SucursalDestino)
    IF @@ERROR <> 0 SET @Ok = 1
    SET @IDGenerarInv = SCOPE_IDENTITY() 
  END

  IF @OK IS NULL
  BEGIN
    DECLARE crDetalle CURSOR LOCAL FAST_FORWARD FOR
     SELECT    Cantidad,  Almacen,  Codigo,  Servicio,  SubCuenta,  FechaRequerida,  FechaOrdenar,  FechaEntrega,  Costo,  Impuesto1,  Impuesto2,  Impuesto3,  Retencion1,  Retencion2,  Retencion3,  Descuento,  DescuentoTipo,  DescuentoLinea,  DescuentoImporte,  DescripcionExtra,  ReferenciaExtra,  ContUso,  DestinoTipo,  Destino,  DestinoID,  Aplica,  AplicaID,  CantidadPendiente,  CantidadCancelada,  CantidadA,  CostoInv,  Unidad,  Factor,  Cantidad*dbo.fnArtUnidadFactor(@Empresa, Articulo, Unidad),  Cliente,  ServicioArticulo,  ServicioSerie,  Paquete,  ImportacionProveedor,  ImportacionReferencia,  ProveedorRef,  AgenteRef,  EstadoRef,  FechaCaducidad,  ProveedorArt,  ProveedorArtCosto,  AjusteCosteo,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  Posicion,  DepartamentoDetallista,  Pais,  TratadoComercial,  ProgramaSectorial,  ValorAduana,  ImportacionImpuesto1,  ImportacionImpuesto2,  ID1,  ID2,  FormaPago,  EsEstadistica,  PresupuestoEsp, ContUso2,  ContUso3,  Tarima,  EmpresaRef,  Categoria,  Estado,  CostoEstandar,  ABC,  PaqueteCantidad,  CantidadEmbarcada,  ClavePresupuestal,  TipoImpuesto1,  TipoImpuesto2,  TipoImpuesto3,  TipoRetencion1,  TipoRetencion2,  TipoRetencion3,  CostoConImpuesto,  TipoImpuesto4,   CostoPromedio,  CostoReposicion,  TipoImpuesto5,  Impuesto5, Articulo
       FROM @Temp
    SET @Renglon = 0.0
    SET @RenglonID = 0
    OPEN crDetalle                          
    FETCH NEXT FROM crDetalle INTO   @Cantidad, @AlmacenD, @Codigo, @Articulo, @SubCuenta, @FechaRequeridaD, @FechaOrdenarD, @FechaEntregaD, @Costo, @Impuesto1, @Impuesto2, @Impuesto3, @Retencion1, @Retencion2, @Retencion3, @DescuentoD, @DescuentoTipo, @DescuentoLinea, @DescuentoImporte, @DescripcionExtra, @ReferenciaExtra, @ContUso, @DestinoTipo, @Destino, @DestinoID, @Aplica, @AplicaID, @CantidadPendiente, @CantidadCancelada, @CantidadA, @CostoInv, @Unidad, @Factor, @CantidadInventario, @Cliente, @ServicioArticulo, @ServicioSerie, @Paquete,  @ImportacionProveedor, @ImportacionReferencia, @ProveedorRef, @AgenteRef, @EstadoRef, @FechaCaducidad, @ProveedorArt, @ProveedorArtCosto, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @Posicion, @DepartamentoDetallista, @Pais, @TratadoComercial, @ProgramaSectorial, @ValorAduana, @ImportacionImpuesto1, @ImportacionImpuesto2, @ID1, @ID2, @FormaPago, @EsEstadistica, @PresupuestoEsp, @ContUso2, @ContUso3, @Tarima, @EmpresaRef, @Categoria, @Estado, @CostoEstandar, @ABC, @PaqueteCantidad, @CantidadEmbarcada, @ClavePresupuestal, @TipoImpuesto1, @TipoImpuesto2, @TipoImpuesto3, @TipoRetencion1, @TipoRetencion2, @TipoRetencion3, @CostoConImpuesto, @TipoImpuesto4, @CostoPromedio, @CostoReposicion, @TipoImpuesto5, @Impuesto5,  @ArtMaterial
    WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
    BEGIN

      IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) SELECT @Ok = 20830
      IF NOT EXISTS(SELECT * FROM Art WHERE Articulo = @Articulo ) SELECT @Ok = 10530
      IF @Cantidad < 0 SET @Ok = 20010
      IF @Costo < 0 SET @Ok = 20140
      SELECT @ArtImpuesto1 = Impuesto1, @ArtImpuesto2=Impuesto2, @ArtImpuesto3=Impuesto3, @ArtRetencion1=Retencion1, @ArtRetencion2=Retencion2, @ArtRetencion3=Retencion3
        FROM Art WHERE Articulo = @Articulo

      IF @AlmacenD NOT IN(SELECT Almacen FROM Alm WHERE Sucursal = @Sucursal)
        SELECT @AlmacenD = AlmacenPrincipal FROM Sucursal WHERE Sucursal = @Sucursal
      SET @Renglon = @Renglon + 2048.0
      SET @RenglonID = @RenglonID + 1
      SELECT @ArtTipo = Tipo, @Unidad = UnidadCompra FROM Art WHERE Articulo = @Articulo
      SELECT @UnidadMaterial = Unidad FROM Art WHERE Articulo = @ArtMaterial
      EXEC spRenglonTipo @ArtTipo, @Subcuenta, @RenglonTipo OUTPUT
      SELECT @MovMoneda = Moneda, @MovTipoCambio = TipoCambio, @MovZonaImpuesto = ZonaImpuesto, @Proveedor= Proveedor FROM Compra WHERE ID = @IDGenerar
      EXEC xpCantidadInventario @Articulo, @SubCuenta, @Unidad, @CfgMultiUnidades, @CfgMultiUnidadesNivel, @Cantidad, @CantidadInventario OUTPUT
      EXEC spUnidadFactor @Empresa, @Articulo, @SubCuenta, @Unidad, @Factor OUTPUT, @Decimales OUTPUT
      EXEC spZonaImp @MovZonaImpuesto, @ArtImpuesto1 OUTPUT
      EXEC spZonaImp @MovZonaImpuesto, @ArtImpuesto2 OUTPUT
      EXEC spZonaImp @MovZonaImpuesto, @ArtImpuesto3 OUTPUT
      EXEC spTipoImpuesto 'COMS' , @IDGenerar, @Mov, @FechaEmision, @Empresa, @Sucursal, @Contacto = @Proveedor, @Articulo = @Articulo, @EnSilencio = 1, @Impuesto1 = @ArtImpuesto1 OUTPUT, @Impuesto2 = @ArtImpuesto2 OUTPUT, @Impuesto3 = @ArtImpuesto3 OUTPUT
      SELECT @CantidadOrden = ROUND(@Cantidad / (@CantidadInventario / @Cantidad), 4), @CantidadInventario = @Cantidad
      EXEC spVerCosto @Sucursal, @Empresa, @Proveedor, @Articulo, @SubCuenta, @Unidad, @CfgCompraCostoSugerido, @MovMoneda, @MovTipoCambio, @Costo OUTPUT, 0
      SELECT @DestinoTipo = NULL, @Destino = NULL, @DestinoID = NULL

      IF EXISTS(SELECT * FROM Compra c JOIN CompraD d ON c.ID = d.ID JOIN MovTipo mt ON mt.Mov = c.Mov AND mt.Modulo = 'COMS' WHERE mt.Clave = 'COMS.C' AND c.Estatus = 'CONFIRMAR' AND c.Proveedor = @Proveedor AND d.Articulo = @Articulo)
      BEGIN
        SELECT TOP 1 @Costo = (d.Costo/d.Cantidad) FROM Compra c JOIN CompraD d ON c.ID = d.ID JOIN MovTipo mt ON mt.Mov = c.Mov AND mt.Modulo = 'COMS' WHERE mt.Clave = 'COMS.C' AND c.Estatus = 'CONFIRMAR' AND c.Proveedor = @Proveedor AND d.Articulo = @Articulo ORDER BY c.FechaEmision DESC
      END
      INSERT CompraD ( ID,       Renglon,   RenglonSub,  RenglonID,  RenglonTipo,  Cantidad,      Almacen,         Codigo,  Articulo,  SubCuenta,  FechaRequerida,  FechaOrdenar,    FechaEntrega,  Costo,  Impuesto1,  Impuesto2,  Impuesto3,  Retencion1,  Retencion2,  Retencion3,  Descuento,  DescuentoTipo,  DescuentoLinea,  DescuentoImporte,  DescripcionExtra,  ReferenciaExtra,  ContUso,  DestinoTipo,  Destino,  DestinoID,  Aplica,    AplicaID,  CantidadPendiente,  CantidadCancelada,  CantidadA,  CostoInv,  Unidad,  Factor,  CantidadInventario,  Cliente,  ServicioArticulo,  ServicioSerie,  Paquete,  Sucursal,  ImportacionProveedor,  ImportacionReferencia,  ProveedorRef,  AgenteRef,  EstadoRef,  FechaCaducidad,  ProveedorArt,  ProveedorArtCosto,  AjusteCosteo,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  Posicion,  DepartamentoDetallista,  Pais,  TratadoComercial,  ProgramaSectorial,  ValorAduana,  ImportacionImpuesto1,  ImportacionImpuesto2,  ID1,  ID2,  FormaPago,  EsEstadistica,  PresupuestoEsp,  SucursalOrigen,  ContUso2,  ContUso3,  Tarima,  EmpresaRef,  Categoria,  Estado,  CostoEstandar,  ABC,  PaqueteCantidad,  CantidadEmbarcada,  ClavePresupuestal,  TipoImpuesto1,  TipoImpuesto2,  TipoImpuesto3,  TipoRetencion1,  TipoRetencion2,  TipoRetencion3,  CostoConImpuesto,  TipoImpuesto4,   CostoPromedio,  CostoReposicion,  TipoImpuesto5,  Impuesto5, ArticuloMaquila)
      VALUES         (@IDGenerar,@Renglon, @RenglonSub, @RenglonID, @RenglonTipo, @CantidadOrden, @AlmacenMatPrima, @Codigo, @Articulo, @SubCuenta, @FechaRequeridaD, @FechaOrdenarD, @FechaEntregaD, @Costo,@ArtImpuesto1, @ArtImpuesto2, @ArtImpuesto3, @ArtRetencion1, @ArtRetencion2, @ArtRetencion3, @DescuentoD, @DescuentoTipo, @DescuentoLinea, @DescuentoImporte, @DescripcionExtra, @ReferenciaExtra, @ContUso, @DestinoTipo, @Destino, @DestinoID, @Aplica, @AplicaID, @CantidadPendiente, @CantidadCancelada, @CantidadA, @CostoInv, @Unidad, @Factor, @CantidadInventario, @Cliente, @ServicioArticulo, @ServicioSerie, @Paquete, ISNULL(@Sucursal,@Sucursal2), @ImportacionProveedor, @ImportacionReferencia, @ProveedorRef, @AgenteRef, @EstadoRef, @FechaCaducidad, @ProveedorArt, @ProveedorArtCosto, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @Posicion, @DepartamentoDetallista, @Pais, @TratadoComercial, @ProgramaSectorial, @ValorAduana, @ImportacionImpuesto1, @ImportacionImpuesto2, @ID1, @ID2, @FormaPago, @EsEstadistica, @PresupuestoEsp, ISNULL(@Sucursal,@Sucursal2), @ContUso2, @ContUso3, @Tarima, @EmpresaRef, @Categoria, @Estado, @CostoEstandar, @ABC, @PaqueteCantidad, @CantidadEmbarcada, @ClavePresupuestal, @TipoImpuesto1, @TipoImpuesto2, @TipoImpuesto3, @TipoRetencion1, @TipoRetencion2, @TipoRetencion3, @CostoConImpuesto, @TipoImpuesto4, @CostoPromedio, @CostoReposicion, @TipoImpuesto5, @Impuesto5, @ArtMaterial)
      IF @@ERROR <> 0 SET @Ok = 1


      SELECT @RenglonInv = MAX(Renglon) FROM InvD WHERE ID = @IDGenerarInv
      SELECT @RenglonInv = ISNULL(@RenglonInv,0)

      IF @TieneMateriales = 1
      BEGIN
        EXEC spProdExp @IDGenerarInv, NULL, NULL,  NULL, NULL, @ArtMaterial, NULL, @Cantidad, @UnidadMaterial, @Factor, @Volumen , @AlmacenMatPrima, @CfgMultiUnidades, @CfgMultiUnidadesNivel, @CfgMermaIncluida, @CfgDesperdicioIncluido, @CfgTipoMerma, @FechaRequeridaD, @RenglonInv, @Ok, @OkRef, 'INV'


        IF @Ok IS NULL
          UPDATE InvD SET Posicion = @DefPosicionSurtido, PosicionDestino = @DefPosicionRecibo, Almacen = @AlmacenMatPrima
           WHERE ID = @IDGenerarInv
      END
      ELSE
      BEGIN
        INSERT InvD(ID,           Renglon,  RenglonSub,  RenglonID,  RenglonTipo,  Cantidad,       Unidad,  Almacen,          Codigo,  Articulo,     SubCuenta,  Costo,  Posicion, CantidadInventario)
        SELECT      @IDGenerarInv,@Renglon, @RenglonSub, @RenglonID, @RenglonTipo, @CantidadOrden, @UnidadMaterial, @AlmacenMatPrima, @Codigo, @ArtMaterial, @SubCuenta, @Costo, @DefPosicionRecibo, @CantidadInventario

      END
      FETCH NEXT FROM crDetalle INTO   @Cantidad, @AlmacenD, @Codigo, @Articulo, @SubCuenta, @FechaRequeridaD, @FechaOrdenarD, @FechaEntregaD, @Costo, @Impuesto1, @Impuesto2, @Impuesto3, @Retencion1, @Retencion2, @Retencion3, @DescuentoD, @DescuentoTipo, @DescuentoLinea, @DescuentoImporte, @DescripcionExtra, @ReferenciaExtra, @ContUso, @DestinoTipo, @Destino, @DestinoID, @Aplica, @AplicaID, @CantidadPendiente, @CantidadCancelada, @CantidadA, @CostoInv, @Unidad, @Factor, @CantidadInventario, @Cliente, @ServicioArticulo, @ServicioSerie, @Paquete,  @ImportacionProveedor, @ImportacionReferencia, @ProveedorRef, @AgenteRef, @EstadoRef, @FechaCaducidad, @ProveedorArt, @ProveedorArtCosto, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @Posicion, @DepartamentoDetallista, @Pais, @TratadoComercial, @ProgramaSectorial, @ValorAduana, @ImportacionImpuesto1, @ImportacionImpuesto2, @ID1, @ID2, @FormaPago, @EsEstadistica, @PresupuestoEsp, @ContUso2, @ContUso3, @Tarima, @EmpresaRef, @Categoria, @Estado, @CostoEstandar, @ABC, @PaqueteCantidad, @CantidadEmbarcada, @ClavePresupuestal, @TipoImpuesto1, @TipoImpuesto2, @TipoImpuesto3, @TipoRetencion1, @TipoRetencion2, @TipoRetencion3, @CostoConImpuesto, @TipoImpuesto4, @CostoPromedio, @CostoReposicion, @TipoImpuesto5, @Impuesto5, @ArtMaterial
    END
    CLOSE crDetalle
    DEALLOCATE crDetalle
  END
  IF EXISTS (SELECT * FROM CompraD WHERE ID = @IDGenerar AND NULLIF(Costo,0) IS NULL)
    SELECT @Ok = 20101
  BEGIN TRANSACTION
  IF @Ok IS NULL AND @IDGenerarInv IS NOT NULL
    EXEC spAfectar 'INV', @IDGenerarInv, 'AFECTAR', 'Todo', NULL, @Usuario2, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion

  IF @Ok IS NULL AND @IDGenerar IS NOT NULL
    EXEC spAfectar 'COMS', @IDGenerar, 'AFECTAR', 'Todo', NULL, @Usuario2, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion


  IF @Ok IS NULL
  BEGIN
    COMMIT TRANSACTION
  END ELSE
  BEGIN
    SELECT @OkRef = Descripcion +' '+ISNULL(@OkRef,'')
      FROM MensajeLista WHERE Mensaje = @Ok
    ROLLBACK TRANSACTION
  END

  SELECT @ReferenciaIS = Referencia
    FROM IntelisisService
   WHERE ID = @ID
   SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + ' Modulo="COMS" ModuloID =' + CHAR(34) + ISNULL(CONVERT(varchar,@IDGenerar),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + ' MovIntelisisMES="'+ISNULL(@MovIntelisisMES,'')+'" ReferenciaIntelisisService="'+ISNULL(@ReferenciaIntelisisService,'')+'"/></Intelisis>'

END
GO
--begin tran a

--declare @datos                               varchar(max),
--                             @idatos                 int,
--                             @Resultado  varchar(max),
--                             @Ok                                       int,
--                             @OkRef                 varchar(255),
--                             @Id                                        int

--set @Ok = null
--set @OkRef = null
--set @datos='<?xml version="1.0" encoding="windows-1252"?>
--<Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.COMS_INV.InsertarMov.Maquila" SubReferencia="aaa" Version="1.0" Transforma="0">
--  <Solicitud>
--    <Compra Mov="Orden Maquila" MovID="" FechaEmision="20140605" UltimoCambio="20140605" Moneda="Pesos" TipoCambio="1" Usuario="jorge" Estatus="SINAFECTAR" Directo="1" VerDestino="0" Prioridad="Normal" Proveedor="PROMAQUILA" FechaRequerida="20140605" Almacen="02" ActivoFijo="0" GenerarPoliza="0" Ejercicio="2014" Periodo="6" FechaRegistro="20140605" Conciliado="0" EstaImpreso="0" Logico1="0" Logico2="0" Logico3="0" Logico4="0" Logico5="0" Logico6="0" Logico7="0" CancelarPendiente="0" OperacionRelevante="0" SubModulo="COMS" TieneTasaEsp="0" SucursalOrigen="0" DerechoDevolucion="0" Comprobante="0" ReferenciaIntelisisService="Principal" MovIntelisisMES="" ReferenciaMES="">
--      <DetalleCompra RenglonSub="0" RenglonID="1" Articulo="ETIQUETAGATORADE" Costo="0" FechaRequerida="20140605" Cantidad="1" Almacen="02" Impuesto1="0" Unidad="PZA" DescripcionUnidad="" ReglonTipo="N" Factor="1" Paquete="0" EsEstadistica="0" PresupuestoEsp="0" DerechoDevolucion="0" Comprobante="0" Servicio="ETIQUETAGATSER" />
--    </Compra>
--  </Solicitud>
--</Intelisis>'

--EXEC spIntelisisService 'DEMO','0633971b5e442cd51b8e0a972d74f054',@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output
--select @Ok,@OkRef

--rollback tran a
--select * from intelisisservice

/**************** spISIntelisisINVInsertarMovINV_EST ****************/
if exists (select * from sysobjects where id = object_id('dbo.spISIntelisisINVInsertarMovINV_EST') and type = 'P') drop procedure dbo.spISIntelisisINVInsertarMovINV_EST
GO           
CREATE PROCEDURE spISIntelisisINVInsertarMovINV_EST
    @ID							int,
    @iSolicitud					int,
    @Version					float,
    @Resultado					varchar(max) = NULL OUTPUT,
    @Ok							int = NULL OUTPUT,  
    @OkRef						varchar(255) = NULL OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @IDGenerar					int,
    @IDAcceso					int,
    @MovTipo					varchar(20),
    @ReferenciaIS				varchar(100),
    @Usuario2					varchar(10),
    @Estacion					int,
    @SubReferencia				varchar(100),
    @Empresa					varchar(5),
    @Mov						varchar(20),
    @Mov2						varchar(20),
    @MovID						varchar(20),
    @FechaEmision				datetime,
    @UltimoCambio				datetime,
    @Concepto					varchar(50),
    @Proyecto					varchar(50),
    @Actividad					varchar(100),
    @UEN						int,
    @Moneda						varchar(10),
    @TipoCambio					float,
    @Usuario					varchar(10),
    @Autorizacion				varchar(10),
    @Referencia					varchar(50),
    @DocFuente					int,
    @Observaciones				varchar(100),
    @Estatus					varchar(15),
    @Situacion					varchar(50),
    @SituacionFecha				datetime,
    @SituacionUsuario			varchar(10),
    @SituacionNota				varchar(100),
    @Prioridad					varchar(10),
    @Directo					bit,
    @RenglonID					int,
    @Almacen					varchar(10),
    @AlmacenDestino				varchar(10),
    @AlmacenTransito			varchar(10),
    @Largo						bit,
    @FechaRequerida				datetime,
    @Condicion					varchar(50),
    @Vencimiento				datetime   ,
    @FormaEnvio					varchar(50),
    @OrigenTipo					varchar(10),
    @Origen						varchar(20),
    @OrigenID					varchar(20),
    @Poliza						varchar(20),
    @PolizaID					varchar(20),
    @GenerarPoliza				bit,
    @ContID						int,
    @Ejercicio					int,
    @Periodo					int,
    @FechaRegistro				datetime,
    @FechaConclusion			datetime,
    @FechaCancelacion			datetime,
    @FechaOrigen				datetime,
    @Peso						float,
    @Volumen					float,
    @Paquetes					int,
    @FechaEntrega				datetime,
    @EmbarqueEstado				varchar(50),
    @Sucursal					int,
    @Sucursal2					int,
    @Importe					money,
    @Logico1					bit,
    @Logico2					bit,
    @Logico3					bit,
    @Logico4					bit,
    @Logico5					bit,
    @Logico6					bit,
    @Logico7					bit,
    @Logico8					bit,
    @Logico9					bit,
    @VerLote					bit,
    @EspacioResultado			bit,
    @VerDestino					bit,
    @EstaImpreso				bit,
    @Personal					varchar(10),
    @Reabastecido				bit,
    @Conteo						int,
    @Agente						varchar(10),
    @ACRetencion				float,
    @SubModulo					varchar(5),
    @SucursalOrigen				int,
    @SucursalDestino			int,
    @PedimentoExtraccion		varchar(50),
    @MovMES						bit,
-----detalle
    @IDD						int,
    @Renglon					float,
    @RenglonSub					int,
    @RenglonIDD					int,
    @RenglonTipo				char(1),
    @Cantidad					float   ,
    @AlmacenD					varchar(10),
    @Codigo						varchar(30),
   @Articulo					varchar(20),
    @ArticuloDestino			varchar(20),
    @SubCuenta					varchar(50),
    @SubCuentaDestino			varchar(50),
    @Costo						money,
    @CostoInv					money,
    @ContUso					varchar(20),
    @Espacio					varchar(10),
    @CantidadReservada			float,
    @CantidadCancelada			float,
    @CantidadOrdenada			float,
    @CantidadPendiente			float,
    @CantidadA					float,
    @Paquete					int,
    @Aplica						varchar(20),
    @AplicaID					varchar(20),
    @DestinoTipo				varchar(10),
    @Destino					varchar(20),
    @DestinoID					varchar(20),
    @Cliente					varchar(10),
    @Unidad						varchar(50),
    @Factor						float,
    @CantidadInventario			float,
    @UltimoReservadoCantidad	float,
    @UltimoReservadoFecha		datetime,
    @ProdSerieLote				varchar(50),
    @Merma						float,
    @Desperdicio				float,
    @Producto					varchar(20),
    @SubProducto				varchar(20),
    @Tipo						varchar(20),
    @Precio						money,
    @SegundoConteo				float,
    @DescripcionExtra			varchar(100),
    @AjusteCosteo				money,
    @CostoUEPS					money,
    @CostoPEPS					money,
    @UltimoCosto				money,
    @PrecioLista				money,
    @DepartamentoDetallista		int,
    @AjustePrecioLista			money,
    @Posicion					varchar(10),
    @Tarima                     varchar(20),
    @Seccion                    smallint,
    @CostoEstandar              money,
    @FechaCaducidad				datetime,
    @CostoPromedio              money,
    @CostoReposicion			money,
    @Proveedor                  varchar(10),
    @ReferenciaIntelisisService	varchar(50),
    @Articulo2                  varchar(20),
    @ArtCompra                  varchar(20),
    @Lote                       Varchar(50),
    @Cantidad2                  float,
    @UltRenglonID				int,
    @Tipo2                      varchar(20),
    @ArtTipo					varchar(20),  
    @CostoConsumoMat			float,
    @CostoManoObra				float,
    @CostoIndirecto				float,
    @CostoServicio				float,
    @ReferenciaMES				varchar(50),
    @PedidoMES					varchar(20),
    @Motivo						varchar(8),
    @Planta						varchar(20),
    @IDMES						int,
    @Serie						varchar(3),
    @IDVenta					int,
    @MovVenta					varchar(20),
    @RenglonCompra				float,
    @CantidadVenta				float,
    @Reservar					bit,
    @CfgReservar				bit,
    @NuevoID					int ,
    @MovO						varchar(20),
    @MoVIDO						varchar(20),
    @IDMarcaje					int,
    @SubClave					varchar(20),
    @ArticuloD					varchar(20),
    @CantidadD					float,
    @CantidadResta				float,
    @SubCuentaD					varchar(50),
    @UnidadD					varchar(50),
    @UnidadP					varchar(50),
    @IDPedido					int,
    @RenglonD					float,
    @AlmacenDD					varchar(10),
    @AlmacenO					varchar(10),
    @ArticuloO					varchar(20),
    @CantidadO					float,
    @IDSol						int,
    @SubCuentaO					varchar(50),
    @UnidadO					varchar(50),
    @RenglonO					float,
    @CantidadReservar			float,
    @CantidadPendienteO			float,
    @UnidadPO					varchar(50),
    @AlmacenP					varchar(10)   

  DECLARE @Temp             table
         (
     IDD                        int,
     Renglon                    float,
     RenglonSub                 int,
     RenglonID					int,
     RenglonTipo				char(1),
     Cantidad					float,
     Almacen                    varchar(10),
     Codigo                     varchar(30),
     Articulo					varchar(20),
     ArticuloDestino			varchar(20),
     SubCuenta					varchar(50),
     SubCuentaDestino			varchar(50),
     Costo                      float,
     CostoInv                   float,
     ContUso                    varchar(20),
     Espacio                    varchar(10),
     CantidadReservada			float,
     CantidadCancelada			float,
     CantidadOrdenada			float,
     CantidadPendiente			float,
     CantidadA					float,
     Paquete                    int,
     FechaRequerida				datetime,
     Aplica                     varchar(20),
     AplicaID					varchar(20),
     DestinoTipo                varchar(10),
     Destino                    varchar(20),
     DestinoID					varchar(20),
     Cliente                    varchar(10),
     Unidad                     varchar(50),
     Factor                     float,
     CantidadInventario			float,
     UltimoReservadoCantidad	float,
     UltimoReservadoFecha		datetime,
     ProdSerieLote				varchar(50),
     Merma                      float,
     Desperdicio                float,
     Producto					varchar(20),
    SubProducto                 varchar(20),
     Tipo                       varchar(20),
     Sucursal					int,
     Precio                     float,
     SegundoConteo				float,
     DescripcionExtra			varchar(100),
     AjusteCosteo				float,
     CostoUEPS                  float,
     CostoPEPS                  float,
     UltimoCosto				float,
     PrecioLista				float,
     DepartamentoDetallista		int,
     AjustePrecioLista			float,
     Posicion					varchar(10),
     SucursalOrigen				int,
     Tarima                     varchar(20),
     Seccion                    smallint,
     CostoEstandar              float,
     FechaCaducidad				datetime,
     CostoPromedio              float,
     CostoReposicion			float,
     CostoConsumoMat			float,
     CostoManoObra				float,
     CostoIndirecto				float,
     CostoServicio				float
         )

  SELECT @IDAcceso = dbo.fnAccesoID(@@SPID)
  SELECT @Estacion = EstacionTrabajo  FROM Acceso WHERE ID = @IDAcceso
  IF @Ok IS NULL
  BEGIN
    SELECT  @Mov2 = NULLIF(Mov,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
      WITH(Mov   varchar(255)) 
    IF @@ERROR <> 0 SET @Ok = 1
  END
  IF @Ok IS NULL
    SELECT @Mov2 = Mov FROM MapeoMovimientosInforIntelisis WHERE INFORMov = @Mov

    SELECT @MovTipo = Clave,@SubClave = SubClave
      FROM MovTipo
     WHERE Modulo = 'INV' AND Mov = @Mov2

  IF @MovTipo <> 'INV.EST' SELECT @Ok = 35005, @OkRef = @Mov
  IF @Ok IS NULL
  BEGIN

     SELECT  @Mov = NULLIF(Dev,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Dev   varchar(255))
     IF @Mov IS NULL
     BEGIN
       SELECT  @Mov = NULLIF(Mov,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
         WITH(Mov   varchar(255))
     END
     SELECT  @MovID = NULLIF(MovID,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(MovID   varchar(255))
     SELECT  @FechaEmision = dbo.fnFechaSinHora(GETDATE())
     SELECT  @UltimoCambio = CONVERT(datetime,UltimoCambio)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(UltimoCambio   varchar(255))
     SELECT  @Concepto = NULLIF(Concepto,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Concepto   varchar(255))
     SELECT  @Proyecto = NULLIF(Proyecto,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Proyecto   varchar(255))
     SELECT  @Actividad = NULLIF(Actividad,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Actividad   varchar(255))
     SELECT  @UEN = CONVERT(int,UEN)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(UEN   varchar(255))
     SELECT  @Moneda = NULLIF(Moneda,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Moneda   varchar(255))
     SELECT  @TipoCambio = CONVERT(float , TipoCambio)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(TipoCambio   varchar(255))
     SELECT  @Usuario = NULLIF(Usuario,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Usuario   varchar(255))
     SELECT  @Autorizacion = NULLIF(Autorizacion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Autorizacion   varchar(255))
     SELECT  @Referencia = NULLIF(Referencia,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Referencia   varchar(255))
     SELECT  @DocFuente = CONVERT(int,DocFuente)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(DocFuente   varchar(255))
     SELECT  @Observaciones = NULLIF(Observaciones,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Observaciones   varchar(255))
     SELECT  @Estatus = NULLIF(Estatus,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Estatus   varchar(255))
     SELECT  @Situacion = NULLIF(Situacion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Situacion   varchar(255))
     SELECT  @SituacionFecha = CONVERT(datetime,SituacionFecha)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SituacionFecha   varchar(255))
     SELECT  @SituacionUsuario = NULLIF(SituacionUsuario,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SituacionUsuario   varchar(255))
     SELECT  @SituacionNota = NULLIF(SituacionNota,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SituacionNota   varchar(255))
     SELECT  @Prioridad = NULLIF(Prioridad,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Prioridad   varchar(255))
     SELECT  @Directo = CONVERT(bit,Directo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Directo   varchar(255))
     SELECT  @RenglonID = CONVERT(int,RenglonID)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(RenglonID   varchar(255))
     SELECT  @Almacen = NULLIF(Almacen,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Almacen   varchar(255))
     SELECT  @AlmacenDestino = NULLIF(AlmacenDestino,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(AlmacenDestino   varchar(255))
     SELECT  @AlmacenTransito = NULLIF(AlmacenTransito,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(AlmacenTransito   varchar(255))
     SELECT  @Largo = CONVERT(bit,Largo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Largo   varchar(255))
     SELECT  @FechaRequerida = CONVERT(datetime,FechaRequerida)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FechaRequerida   varchar(255))
     SELECT  @Condicion = NULLIF(Condicion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Condicion   varchar(255))
     SELECT  @Vencimiento = CONVERT(datetime,Vencimiento)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
      WITH(Vencimiento   varchar(255))
     SELECT  @FormaEnvio = NULLIF(FormaEnvio,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FormaEnvio   varchar(255))
     SELECT  @OrigenTipo = NULLIF(OrigenTipo,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(OrigenTipo   varchar(255))
     SELECT  @Origen = NULLIF(Origen,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Origen   varchar(255))
     SELECT  @OrigenID = NULLIF(OrigenID,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(OrigenID   varchar(255))
     SELECT  @Poliza = NULLIF(Poliza,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Poliza   varchar(255))
     SELECT  @PolizaID = NULLIF(PolizaID,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(PolizaID   varchar(255))
     SELECT  @GenerarPoliza = CONVERT(bit,GenerarPoliza)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(GenerarPoliza   varchar(255))
     SELECT  @ContID = CONVERT(int,ContID)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(ContID   varchar(255))
     SELECT  @Ejercicio = CONVERT(int,Ejercicio)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Ejercicio   varchar(255))
     SELECT  @Periodo = CONVERT(int,Periodo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Periodo   varchar(255))
     SELECT  @FechaRegistro = GETDATE()
     SELECT  @Peso = CONVERT(float , Peso)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Peso   varchar(255))
     SELECT  @Volumen = CONVERT(float , Volumen)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Volumen   varchar(255))
     SELECT  @Paquetes = CONVERT(int,Paquetes)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Paquetes   varchar(255))
     SELECT  @FechaEntrega = CONVERT(datetime,FechaEntrega)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(FechaEntrega   varchar(255))
     SELECT  @EmbarqueEstado = NULLIF(EmbarqueEstado,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(EmbarqueEstado   varchar(255))
     SELECT  @Importe = CONVERT(money,Importe)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Importe   varchar(255))
     SELECT  @Logico1 = CONVERT(bit,Logico1)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico1   varchar(255))
     SELECT  @Logico2 = CONVERT(bit,Logico2)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico2   varchar(255))
     SELECT  @Logico3 = CONVERT(bit,Logico3)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico3   varchar(255))
     SELECT  @Logico4 = CONVERT(bit,Logico4)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico4   varchar(255))
     SELECT  @Logico5 = CONVERT(bit,Logico5)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico5   varchar(255))
     SELECT  @Logico6 = CONVERT(bit,Logico6)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico6   varchar(255))
     SELECT  @Logico7 = CONVERT(bit,Logico7)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico7   varchar(255))
     SELECT  @Logico8 = CONVERT(bit,Logico8)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico8   varchar(255))
     SELECT  @Logico9 = CONVERT(bit,Logico9)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Logico9   varchar(255))
     SELECT  @VerLote = CONVERT(bit,VerLote)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(VerLote   varchar(255))
     SELECT  @EspacioResultado = CONVERT(bit,EspacioResultado)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(EspacioResultado   varchar(255))
     SELECT  @VerDestino = CONVERT(bit,VerDestino)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(VerDestino   varchar(255))
     SELECT  @EstaImpreso = CONVERT(bit,EstaImpreso)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(EstaImpreso   varchar(255))
     SELECT  @Personal = NULLIF(Personal,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Personal   varchar(255))
     SELECT  @Reabastecido = CONVERT(bit,Reabastecido)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Reabastecido   varchar(255))
     SELECT  @Conteo = CONVERT(int,Conteo)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Conteo   varchar(255))
     SELECT  @Agente = NULLIF(Agente,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Agente   varchar(255))
     SELECT  @ACRetencion = CONVERT(float , ACRetencion)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(ACRetencion   varchar(255))
     SELECT  @SubModulo = NULLIF(SubModulo,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SubModulo   varchar(255))
     SELECT  @SucursalOrigen = CONVERT(int,SucursalOrigen)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SucursalOrigen   varchar(255))
     SELECT  @SucursalDestino = CONVERT(int,SucursalDestino)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(SucursalDestino   varchar(255))
     SELECT  @PedimentoExtraccion = NULLIF(PedimentoExtraccion,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(PedimentoExtraccion   varchar(255))
     SELECT  @ReferenciaIntelisisService = NULLIF(ReferenciaIntelisisService,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
      WITH(ReferenciaIntelisisService   varchar(255))
     SELECT  @MovMES = CONVERT(bit,MovMES)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(MovMES   varchar(255))
     SELECT  @Motivo = NULLIF(MotivoRechazo,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(MotivoRechazo   varchar(255))
     SELECT  @ReferenciaMES = NULLIF(ReferenciaMES,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(ReferenciaMES   varchar(255))
     SELECT  @PedidoMES = NULLIF(PedidoMES ,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(PedidoMES    varchar(255))
     SELECT  @IDMES = CONVERT(int,IDMES)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(IDMES   varchar(255)) 
     SELECT  @Serie = NULLIF(Serie ,'')FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(Serie    varchar(255)) 
     SELECT  @IDMarcaje = CONVERT(int,IDMarcaje)FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Inv')
       WITH(IDMarcaje   varchar(255))                       
   END
  IF @Ok IS NULL
  BEGIN
    SET @Estatus = 'SINAFECTAR'

    SELECT @Empresa = Empresa ,@Sucursal = Sucursal, @SucursalOrigen = Sucursal
      FROM MapeoPlantaIntelisisMes
     WHERE Referencia = @ReferenciaIntelisisService
    SELECT @Sucursal2 = @Sucursal
    --SELECT @Sucursal2 = Sucursal, @SucursalOrigen = Sucursal
    --  FROM PlantaProductiva WHERE Clave =@Planta
    --SELECT @Sucursal = Sucursal FROM Alm WHERE Almacen = @Almacen

    SELECT @CfgReservar = PedidosReservar FROM EmpresaCfg WHERE Empresa = @Empresa

    IF NOT EXISTS(SELECT * FROM Mon WHERE Moneda = @Moneda ) SELECT @Ok = 20196
    IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) SELECT @Ok = 20830
    IF NOT EXISTS(SELECT * FROM Proy WHERE Proyecto = @Proyecto ) AND NULLIF(@Proyecto,'') IS NOT NULL SELECT @Ok = 15010
    IF NOT EXISTS(SELECT * FROM UEN WHERE UEN = @UEN ) AND NULLIF(@UEN,'') IS NOT NULL SELECT @Ok = 10070
    IF NOT EXISTS(SELECT * FROM MovTipo WHERE Mov = @Mov2 ) SELECT @Ok = 14055
    IF NOT EXISTS(SELECT * FROM Sucursal WHERE Sucursal = @Sucursal )SELECT @Ok = 72060
    IF NOT EXISTS(SELECT * FROM Empresa WHERE Empresa =  @Empresa)SELECT @Ok =26070
  END
  IF @Ok IS NULL
  BEGIN
    IF @Almacen NOT IN(SELECT Almacen FROM Alm WHERE Sucursal = @Sucursal)
      SELECT @Almacen = AlmacenPrincipal FROM Sucursal WHERE Sucursal = @Sucursal
    SELECT @OrigenTipo ='I:MES'
    INSERT INTO Inv (Empresa, Mov,   MovID, FechaEmision,   UltimoCambio, Concepto, Proyecto, Actividad,   UEN,   Moneda,   TipoCambio,   Usuario,   Autorizacion,   Referencia, DocFuente, Observaciones, Estatus, Situacion, SituacionFecha, SituacionUsuario,   SituacionNota,   Prioridad, Directo, RenglonID, Almacen,   AlmacenDestino,   AlmacenTransito,   Largo,   FechaRequerida,   Condicion,   Vencimiento, FormaEnvio, OrigenTipo, Origen, OrigenID, Poliza,   PolizaID,   GenerarPoliza, ContID, Ejercicio, Periodo,   FechaRegistro,   FechaConclusion,   FechaCancelacion,   FechaOrigen,   Peso, Volumen, Paquetes, FechaEntrega, EmbarqueEstado,   Sucursal,   Importe,   Logico1, Logico2, Logico3, Logico4, Logico5,   Logico6,   Logico7,   Logico8,   Logico9, VerLote, EspacioResultado,   VerDestino, EstaImpreso,   Personal, Reabastecido,   Conteo, Agente,   ACRetencion, SubModulo,   SucursalOrigen, SucursalDestino,   PedimentoExtraccion, MovMES,Motivo,ReferenciaMES, PedidoMES ,IDMES  ,Serie,IDMarcaje)
           SELECT  @Empresa, @Mov2, @MovID, @FechaEmision, @UltimoCambio, @Concepto, @Proyecto, @Actividad, @UEN, @Moneda, @TipoCambio, @Usuario, @Autorizacion, @Referencia, @DocFuente, @Observaciones, @Estatus, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @Prioridad, @Directo, @RenglonID, @Almacen, @AlmacenDestino, @AlmacenTransito, @Largo, @FechaRequerida, @Condicion, @Vencimiento, @FormaEnvio, @OrigenTipo, @Origen, @OrigenID, @Poliza, @PolizaID, @GenerarPoliza, @ContID, @Ejercicio, @Periodo, @FechaRegistro, @FechaConclusion, @FechaCancelacion, @FechaOrigen, @Peso, @Volumen, @Paquetes, @FechaEntrega, @EmbarqueEstado, ISNULL(@Sucursal,@Sucursal2), @Importe, @Logico1, @Logico2, @Logico3, @Logico4, @Logico5, @Logico6, @Logico7, @Logico8, @Logico9, @VerLote, @EspacioResultado, @VerDestino, @EstaImpreso, @Personal, @Reabastecido, @Conteo, @Agente, @ACRetencion, @SubModulo, @SucursalOrigen, @SucursalDestino, @PedimentoExtraccion, @MovMES,@Motivo,@ReferenciaMES, @PedidoMES  ,@IDMES,@Serie ,@IDMarcaje
    IF @@ERROR <> 0 SET @Ok = 1
    SET @IDGenerar = SCOPE_IDENTITY()
  END
  SELECT @RenglonSub = 0
  INSERT @Temp (  RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad,            Factor, CantidadInventario,                   UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion, CostoConsumoMat, CostoManoObra, CostoIndirecto, CostoServicio)
  SELECT          RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, DescripcionUnidad, Factor, ISNULL(CantidadInventario, Cantidad), UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Sucursal, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion, SucursalOrigen, Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion, CostoConsumoMat, CostoManoObra, CostoIndirecto, CostoServicio
    FROM OPENXML(@iSolicitud, '/Intelisis/Solicitud/Inv/DetalleInv',1)
    WITH (RenglonSub  varchar(100), RenglonID  varchar(100), RenglonTipo  varchar(100), Cantidad  varchar(100), Almacen  varchar(100), Codigo  varchar(100), Articulo  varchar(100), ArticuloDestino  varchar(100), SubCuenta  varchar(100), SubCuentaDestino  varchar(100), Costo  varchar(100), CostoInv  varchar(100), ContUso  varchar(100), Espacio  varchar(100), CantidadReservada  varchar(100), CantidadCancelada  varchar(100), CantidadOrdenada  varchar(100), CantidadPendiente  varchar(100), CantidadA  varchar(100), Paquete  varchar(100), FechaRequerida  varchar(100), Aplica  varchar(100), AplicaID  varchar(100), DestinoTipo  varchar(100), Destino  varchar(100), DestinoID  varchar(100), Cliente  varchar(100), Unidad  varchar(100), Factor  varchar(100), CantidadInventario  varchar(100), UltimoReservadoCantidad  varchar(100), UltimoReservadoFecha  varchar(100), ProdSerieLote  varchar(100), Merma  varchar(100), Desperdicio  varchar(100), Producto  varchar(100), SubProducto  varchar(100), Tipo  varchar(100), Sucursal  varchar(100), Precio  varchar(100), SegundoConteo  varchar(100), DescripcionExtra  varchar(100), AjusteCosteo  varchar(100), CostoUEPS  varchar(100), CostoPEPS  varchar(100), UltimoCosto  varchar(100), PrecioLista  varchar(100), DepartamentoDetallista  varchar(100), AjustePrecioLista  varchar(100), Posicion  varchar(100), SucursalOrigen  varchar(100), Tarima  varchar(100), Seccion  varchar(100), CostoEstandar  varchar(100), FechaCaducidad  varchar(100), CostoPromedio  varchar(100), CostoReposicion varchar(100),ES varchar(100),PR varchar(100),UC varchar(100),MO varchar(100),CI varchar(100),CM varchar(100),MA varchar(100),ReferenciaMES varchar(100),PedidoMES varchar(100),IDMarcaje  varchar(100), DescripcionUnidad varchar(100), CostoConsumoMat float, CostoManoObra float, CostoIndirecto float, CostoServicio float)
  SET @RenglonIDD =0
  UPDATE @Temp
     SET @RenglonIDD = RenglonID = @RenglonIDD + 1
    FROM @Temp


  IF @OK IS NULL
  BEGIN  
	DECLARE @tblCostoReposicion as TABLE (Articulo varchar(20), CostoReposicion float)
    DECLARE crDetalle CURSOR LOCAL FAST_FORWARD FOR
    SELECT  RenglonTipo, Cantidad, Almacen, Codigo, Articulo, ArticuloDestino, SubCuenta, SubCuentaDestino, Costo, CostoInv, ContUso, Espacio, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadPendiente, CantidadA, Paquete, FechaRequerida, Aplica, AplicaID, DestinoTipo, Destino, DestinoID, Cliente, Unidad, Factor, Cantidad*dbo.fnArtUnidadFactor(@Empresa, Articulo, Unidad), UltimoReservadoCantidad, UltimoReservadoFecha, ProdSerieLote, Merma, Desperdicio, Producto, SubProducto, Tipo, Precio, SegundoConteo, DescripcionExtra, AjusteCosteo, CostoUEPS, CostoPEPS, UltimoCosto, PrecioLista, DepartamentoDetallista, AjustePrecioLista, Posicion,  Tarima, Seccion, CostoEstandar, FechaCaducidad, CostoPromedio, CostoReposicion,CostoConsumoMat, CostoManoObra, CostoIndirecto, CostoServicio ,RenglonID
    FROM @Temp
    SET @Renglon = 0.0
   -- SET @RenglonIDD = 0
    OPEN crDetalle
    FETCH NEXT FROM crDetalle INTO   @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion,  @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion, @CostoConsumoMat, @CostoManoObra, @CostoIndirecto, @CostoServicio,@RenglonID
    WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
    BEGIN
      SELECT @Costo = ISNULL(NULLIF(@Costo,0.0),@CostoEstandar)
      IF NOT EXISTS(SELECT * FROM Alm WHERE Almacen = @Almacen ) SELECT @Ok = 20830
      IF @Cantidad < 0 SET @Ok = 20010
      IF @Costo < 0 SET @Ok = 20140

      SELECT @Aplica = i.Mov, @AplicaID = i.MovID FROM Inv i JOIN MovTipo mt ON i.Mov = mt.Mov AND mt.Modulo = 'INV' WHERE i.ReferenciaMES = @ReferenciaMES AND i.OrigenTipo = @OrigenTipo AND mt.Clave= '' AND i.Estatus = 'PENDIENTE'
      IF @AlmacenD NOT IN(SELECT Almacen FROM Alm WHERE Sucursal = @Sucursal) AND @Ok IS NULL
        SELECT @AlmacenD = AlmacenPrincipal FROM Sucursal WHERE Sucursal = @Sucursal
      SELECT @ArtTipo = Tipo FROM Art WHERE Articulo = @Articulo

      EXEC spRenglonTipo @ArtTipo, @Subcuenta, @RenglonTipo OUTPUT

      SET @Renglon = @Renglon + 2048.0
     -- SET @RenglonIDD = @RenglonIDD + 1

      INSERT InvD (   ID        ,  Renglon,RenglonID,  RenglonSub,  RenglonTipo,  Cantidad,  Almacen,  Codigo,  Articulo,  ArticuloDestino,  SubCuenta,  SubCuentaDestino,  Costo,  CostoInv,  ContUso,  Espacio,  CantidadReservada,  CantidadCancelada,  CantidadOrdenada,  CantidadPendiente,  CantidadA,  Paquete,  FechaRequerida,  Aplica,  AplicaID,  DestinoTipo,  Destino,  DestinoID,  Cliente,  Unidad,  Factor,  CantidadInventario,  UltimoReservadoCantidad,  UltimoReservadoFecha,  ProdSerieLote,  Merma,  Desperdicio,  Producto,  SubProducto,  Tipo,  Sucursal,  Precio,  SegundoConteo,  DescripcionExtra,  AjusteCosteo,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  DepartamentoDetallista,  AjustePrecioLista,  Posicion,  SucursalOrigen,  Tarima,  Seccion,  CostoEstandar,  FechaCaducidad,  CostoPromedio,  CostoReposicion   )
      VALUES         (@IDGenerar, @Renglon,@RenglonID, @RenglonSub,  @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, ISNULL(@Sucursal,@Sucursal2), @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion, @SucursalOrigen, @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion   )
      IF @@ERROR <> 0 SET @Ok = 1

      IF @Ok IS NULL
      BEGIN

          INSERT InvDCosto(ID,Renglon,RenglonID,Articulo,CostoEstandar,CostoServicio, CostoManoObra, CostoIndirecto, CostoMateriales)
          SELECT          @IDGenerar,@Renglon,@RenglonIDD,@Articulo,ISNULL(@Costo,0.0), ISNULL(@CostoServicio,0.0) , ISNULL(@CostoManoObra,0.0) ,ISNULL(@CostoIndirecto,0.0), ISNULL(@CostoConsumoMat,0.0)

		  INSERT @tblCostoReposicion (Articulo, CostoReposicion)
		  SELECT @Articulo, ISNULL(@Costo,0.0)
      END

      IF @@ERROR <> 0 SET @Ok = 1
      FETCH NEXT FROM crDetalle INTO  @RenglonTipo, @Cantidad, @AlmacenD, @Codigo, @Articulo, @ArticuloDestino, @SubCuenta, @SubCuentaDestino, @Costo, @CostoInv, @ContUso, @Espacio, @CantidadReservada, @CantidadCancelada, @CantidadOrdenada, @CantidadPendiente, @CantidadA, @Paquete, @FechaRequerida, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Unidad, @Factor, @CantidadInventario, @UltimoReservadoCantidad, @UltimoReservadoFecha, @ProdSerieLote, @Merma, @Desperdicio, @Producto, @SubProducto, @Tipo, @Precio, @SegundoConteo, @DescripcionExtra, @AjusteCosteo, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @DepartamentoDetallista, @AjustePrecioLista, @Posicion,  @Tarima, @Seccion, @CostoEstandar, @FechaCaducidad, @CostoPromedio, @CostoReposicion, @CostoConsumoMat, @CostoManoObra, @CostoIndirecto, @CostoServicio,@RenglonID
    END
    CLOSE crDetalle
    DEALLOCATE crDetalle
  END

  BEGIN TRANSACTION

  IF @Ok IS NULL AND @Estatus = 'SINAFECTAR'
    EXEC spAfectar 'INV', @IDGenerar, 'AFECTAR', 'Todo', NULL, @Usuario, NULL, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT, @EnSilencio = 1, @Conexion = 1, @Estacion = @Estacion

  IF @Ok IS NULL
  BEGIN
	UPDATE Art
	   SET CostoReposicion = T.CostoReposicion
	  FROM @tblCostoReposicion T
	 WHERE Art.Articulo = T.Articulo

    COMMIT TRANSACTION
  END ELSE
  BEGIN
    ROLLBACK TRANSACTION
    UPDATE Inv SET Estatus = 'BORRADOR' WHERE ID = @IDGenerar
  END
  IF @Ok IS NULL
  SELECT @ReferenciaIS = Referencia
    FROM IntelisisService
   WHERE ID = @ID

    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + ' Modulo="INV" ModuloID =' + CHAR(34) + ISNULL(CONVERT(varchar,@IDGenerar),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'
END
GO


-- Procedimiento a Ejecutarse desde un Job
--EXEC spProcesarIntelisisServices 'NOVA'
/**************** spProcesarIntelisisServices ****************/
if exists (select * from sysobjects where id = object_id('dbo.spProcesarIntelisisServices') and type = 'P') drop procedure dbo.spProcesarIntelisisServices
GO 
CREATE PROC spProcesarIntelisisServices
		@Empresa         varchar (10)
--//WITH ENCRYPTION
AS BEGIN

DECLARE 
@ProdInterfazINFOR bit,
@ID int,
@Procesando bit

  SELECT @ProdInterfazINFOR = ProdInterfazINFOR
    FROM EmpresaGral WHERE Empresa = @Empresa

  DELETE ProcesarIntelisisService WHERE ID NOT IN (SELECT ID FROM IntelisisService)

  IF @ProdInterfazINFOR = 1
  BEGIN
    DECLARE	crProcesarIS CURSOR LOCAL FAST_FORWARD FOR
     SELECT	ID, Procesando FROM ProcesarIntelisisService WHERE Procesado = 0 ORDER By Id ASC
      OPEN	crProcesarIS
      FETCH NEXT FROM crProcesarIS INTO @ID, @Procesando
      WHILE @@FETCH_STATUS = 0 
      BEGIN
	    IF @Procesando = 0
	    BEGIN
	       UPDATE ProcesarIntelisisService SET Procesando = 1 WHERE ID = @ID
	       EXEC spIntelisisServiceProcesar @ID
		   UPDATE ProcesarIntelisisService SET Procesado = 1 WHERE ID = @ID
	    END
	  FETCH NEXT FROM crProcesarIS INTO @ID, @Procesando
      END
      CLOSE crProcesarIS
      DEALLOCATE crProcesarIS  
    
  END

RETURN
END
GO			



--declare @datos                               varchar(max),
--                             @idatos                 int,
--                             @Resultado  varchar(max),
--                             @Ok                                       int,
--                             @OkRef                 varchar(255),
--                             @Id                                        int

--set @Ok = null
--set @OkRef = null
--set @datos='<?xml version="1.0" encoding="windows-1252"?>
--<Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.INV.InsertarMov.INV_EST" SubReferencia="" Version="1.0"><Solicitud>
--<Inv Mov="Cierre Orden" MovID="" UltimoCambio="20140521" Moneda="Pesos" TipoCambio="1" Usuario="jorge" Estatus="SINAFECTAR" Directo="1" Almacen="03" AlmacenTransito="" GenerarPoliza="0" Ejercicio="2014" Periodo="5" FechaRegistro="20140521" Importe="28.34" SubModulo="INV" ReferenciaIntelisisService="Principal" Largo="0" FechaEmision="20140521" Logico1="0" Logico2="0" Logico3="0" Logico4="0" Logico5="0" Logico6="0" Logico7="0" Logico8="0" Logico9="0" MovMES="1" ReferenciaMES="OT-70" Serie="NAC" PedidoMES="1" IDMES="13" IDMarcaje="3" ><DetalleInv Cantidad="1" Almacen="03" Articulo="LAPIZLAB" Costo="0" UltimoCosto="0" PrecioLista="0" CostoEstandar="0" ReferenciaIntelisisService="Principal" Unidad="PZA" DescripcionUnidad="PZA" Factor="1" CostoConsumoMat="15" CostoManoObra="13.34" CostoIndirecto="0" CostoServicio="0" UC="0" PR="0" ES="0" CM="0" MO="0" CI="0" MA="0" /><SerieLoteMov Articulo="LAPIZLAB" Lote="" Cantidad="1" /></Inv></Solicitud></Intelisis>'

--EXEC spIntelisisService 'DEMO','0633971b5e442cd51b8e0a972d74f054',@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@Id Output
--select @Ok,@OkRef
/**************** spIntelisisServiceFactoryProcesar ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisServiceFactoryProcesar') and sysstat & 0xf = 4) drop procedure dbo.spIntelisisServiceFactoryProcesar
GO            
CREATE PROCEDURE spIntelisisServiceFactoryProcesar
                                               @ID        int
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
   @Usuario                           varchar(10),
   @Estatus                            varchar(15),
   @EstatusD         varchar(15),
   @Contrasena                   varchar(32),
   @Solicitud                         varchar(max),
   @Resultado                      varchar(max),
   @RID                 int,
   @iSolicitud          int ,
   @Modulo              varchar(20),
   @ModuloID            int      

  SELECT @Estatus = Estatus, @Usuario = Usuario, @Solicitud = Solicitud
    FROM IntelisisServiceFactory
   WHERE ID = @ID
  IF @Estatus = 'SINPROCESAR'
  BEGIN
    SELECT @Contrasena = Contrasena FROM Usuario WHERE Usuario = @Usuario
    EXEC spIntelisisService @Usuario, @Contrasena, @Solicitud, @Procesar = 1, @ID = @RID OUTPUT, @Resultado = @Resultado OUTPUT, @EliminarProcesado =0
    SELECT @EstatusD = Estatus FROM IntelisisService WHERE ID = @RID

    EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Resultado
        SELECT  @Modulo = Modulo, @ModuloID = ModuloID
        FROM OPENXML(@iSolicitud, '/Intelisis/Resultado',1)
        WITH (Modulo  varchar(100), ModuloID  int)
    EXEC sp_xml_removedocument @iSolicitud   
    UPDATE IntelisisServiceFactory SET RID = @RID , Estatus = @EstatusD,Modulo = @Modulo, ModuloID = @ModuloID
     WHERE ID = @ID
  END

END
GO




/**************** spInforArticuloSaldoInicial ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInforArticuloSaldoInicial')           AND type = 'P') drop procedure dbo.spInforArticuloSaldoInicial
GO 
CREATE PROC spInforArticuloSaldoInicial
	@Articulo varchar(20),
	@Usuario  varchar(10),
	@Empresa  varchar(5),
	@Sucursal int                           
--//WITH ENCRYPTION
AS
BEGIN
DECLARE 
    @AccesoID					int,
    @Ok							int,
    @OkRef						varchar(255),
    @Contrasena					varchar(32),
    @Resultado					varchar(max),
    @Resultado2					varchar(max),
    @Id							int,
    @Version					float,
    @SubReferencia              varchar(255) ,
    @Datos						varchar (max),
    @ReferenciaIntelisisService	varchar(50),
	@ArtTipo					varchar(20)
     
 DECLARE 
  @Tabla table(
	  Articulo      varchar(20),
	  SubCuenta     varchar(50),
	  SerieLote     varchar(20),
	  Almacen       varchar(10),
	  EntradaSalida varchar(1),
	  Existencia    float
  )

 SELECT @ReferenciaIntelisisService = Referencia 
   FROM MapeoPlantaIntelisisMes 
  WHERE Empresa = @Empresa AND Sucursal = @Sucursal 
  
  SELECT @ArtTipo = Tipo FROM Art WHERE Articulo = @Articulo
  
  IF @ArtTipo IN ('Serie', 'Lote')
  BEGIN
	 INSERT INTO @Tabla (Articulo,   SubCuenta,              SerieLote,   Almacen,   Existencia,   EntradaSalida)  
	 SELECT              s.Articulo, ISNULL(s.SubCuenta,''), s.SerieLote, s.Almacen, ISNULL(s.Existencia,0), 'E'  
	   FROM SerieLote s JOIN Alm m ON s.Almacen = m.Almacen
	  WHERE ISNULL(m.EsFactory,0) = 1  
		AND ISNULL(s.Existencia,0)<>0
		AND s.Articulo = @Articulo
  END
  ELSE
  BEGIN    
	 INSERT INTO @Tabla (Articulo,   SubCuenta,              SerieLote,   Almacen,   Existencia,   EntradaSalida)  
	 SELECT              s.Articulo, '', '', s.Almacen, ISNULL(s.Disponible,0)+ISNULL(s.Reservado,0), 'E'  
	   FROM ArtDisponibleReservado s JOIN Alm m ON s.Almacen = m.Almacen
	  WHERE ISNULL(m.EsFactory,0) = 1  
		AND s.Articulo = @Articulo 
   END
   
   SET @Resultado2 =ISNULL(CONVERT(varchar(max) ,(SELECT * FROM @Tabla InvExistencia FOR XML AUTO)),'')
   SET @Datos = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Intelisis.INV.Cuadrar.ExistenciaMES' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)+ ' ReferenciaIntelisisService=' + CHAR(34) + ISNULL(@ReferenciaIntelisisService,'') + CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>'  

   SELECT @Contrasena = Contrasena 
     FROM Usuario
    WHERE Usuario = @Usuario
     EXEC spIntelisisService  @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,0,0,@Id Output
END
GO
/**************** spIntelisisInterfazInforTransferenciaCte ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaCte')           AND type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaCte
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaCte
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok			int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
		@Cliente     		        varchar(10),
		@Datos				varchar(max),
		@Solicitud			varchar(max),
		@ReferenciaIS			varchar(100),
		@SubReferencia			varchar(100),
		@IDNuevo			int,
		@Datos2				varchar(max),
		@Resultado2			varchar(max),
		@Usuario			varchar(10),
		@Contrasena			varchar(32),
		@Verificar			int	,
		@ReferenciaIntelisisService     varchar(50)							

  DECLARE
		@Tabla			 table
		(
		 Codigo			        varchar(10),
		 Descripcion			varchar(50),
		 ReferenciaIntelisisService     varchar(50),
		 NombreComercial		varchar(100),
		 RazonSocial			varchar(100),
		 BajaComercial			varchar(50),	
		 ClienteTipo			varchar(20)
		 )
		
 

  SELECT @Cliente = Cliente FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Cte')
    WITH (Cliente varchar(255))


 --SELECT @Verificar =LEN(@Cliente)
 --IF  @Verificar > 8  SELECT @Ok = 10040, @OkRef = @Cliente

  
 SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
   FROM IntelisisService 
  WHERE ID = @ID
  
  
 SELECT @Contrasena = Contrasena 
   FROM Usuario
  WHERE Usuario = @Usuario
  
  
 IF @Ok IS NULL
 BEGIN 

    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@ID,'')),'') + CHAR(34) +  ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@Ok,'')),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(ISNULL(@OkRef,''),'') + CHAR(34) + '/></Intelisis>'
    SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Cte.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Cliente" Valor="'+@Cliente+'"/></Solicitud></Intelisis>'
     
    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDnuevo Output
  
    IF @Ok IS NULL
      SELECT @Solicitud = Resultado 
        FROM IntelisisService
       WHERE ID = @IDNuevo
  
      EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
      IF @@ERROR <> 0 SET @Ok = 1
      INSERT @Tabla ( Codigo,Descripcion,ReferenciaIntelisisService,NombreComercial,RazonSocial,BajaComercial,ClienteTipo)
             
            SELECT Cliente, Descripcion, ReferenciaIntelisisService, Nombre, Nombre, Estatus, Tipo
              FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Cte',1)  
              WITH (Cliente varchar(100), Descripcion varchar(100), ReferenciaIntelisisService varchar(100), NombreCorto varchar(100),Nombre varchar(100), Estatus varchar(100), Tipo varchar(100))


      IF @@ERROR <> 0 SET @Ok = 1
      EXEC sp_xml_removedocument @iSolicitud
      IF @@ERROR <> 0 SET @Ok = 1
      
      SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService FROM @Tabla

        SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oCliente FOR XML AUTO))
        SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Cte.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)+' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34) + '>' + @Resultado2 + '</Solicitud></Intelisis>'  
  END
  ELSE
  BEGIN
    SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Cte.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud><ERROR Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + '/></Solicitud></Intelisis>' 		
    
  END      

  EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
					
END
GO
/**************** spIntelisisInterfazInforTransferenciaProv ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaProv') and type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaProv
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaProv
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
		@Proveedor			varchar(10),
		@Datos				varchar(max),
		@Solicitud			varchar(max),
		@ReferenciaIS			varchar(100),
		@SubReferencia			varchar(100),
		@IDNuevo			int,
		@Datos2				varchar(max),
		@Resultado2			varchar(max),
		@Usuario			varchar(10),
		@Contrasena			varchar(32)	,
		@CIFDNI				varchar(40),
		@TipoEfecto			varchar(40),
		@PorcentajeIVA			varchar(40)	,
		@ReferenciaIntelisisService	varchar(50)	
	DECLARE
		@Tabla	table
		(
		 CodigoProveedor 		varchar(10),
		 RazonSocial			varchar(40),
		 NombreComercial                varchar(40),
		 Direccion1			varchar(40),
		 Direccion2			varchar(40),
		 Poblacion			varchar(40),
		 Provincia			varchar(40),
		 CodigoPostal			varchar(40),
		 CIFDNI				varchar(40),
		 FormaPago  			varchar(40),
		 CodigoMoneda 			varchar(40),
		 TipoEfecto			varchar(40),
		 ProveedorFormasPagoObjeto	varchar(40),
		 TipoImpuesto			varchar(40),
		 ProveedorMonedaObjeto		varchar(40),
		 BajaComercial			varchar(40),
		 PorcentajeIVA			varchar(40),
		 Almacen			varchar(10),
		 ReferenciaIntelisisService     varchar(50),
		 TallerExterior			bit,
		 TipoProveedor			bit
		 
		 )
		

  SELECT @Proveedor = Proveedor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Prov')
    WITH (Proveedor varchar(255))
  
  SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
    FROM IntelisisService 
   WHERE ID = @ID
  
  SELECT @Contrasena = Contrasena 
	FROM Usuario
   WHERE Usuario = @Usuario

 
  SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'
  SET @CIFDNI = '000000000000001'
  SET @TipoEfecto = '0'
  SET @PorcentajeIVA = '15'

  SET @Datos= '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Prov.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Proveedor" Valor="'+@Proveedor+'"/></Solicitud></Intelisis>'
    
  EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok OUTPUT,@OkRef OUTPUT,1,0,@IDNuevo Output
  
  IF @Ok IS NULL
    SELECT @Solicitud = Resultado 
      FROM IntelisisService
     WHERE ID = @IDNuevo
  
  IF @Ok IS NULL
  BEGIN
    EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
    IF @@ERROR <> 0 SET @Ok = 1
    INSERT @Tabla (CodigoProveedor, RazonSocial,             NombreComercial, Direccion1, Direccion2, Poblacion, Provincia, CodigoPostal, CIFDNI,  FormaPago,                 CodigoMoneda, TipoEfecto,  ProveedorFormasPagoObjeto, TipoImpuesto, ProveedorMonedaObjeto,  BajaComercial, PorcentajeIVA, Almacen, ReferenciaIntelisisService,TallerExterior,     TipoProveedor)
            SELECT Proveedor ,      SUBSTRING(Nombre,1,40)  ,NombreCorto ,    Direccion , ' '       , Poblacion, Estado   , CodigoPostal, @CIFDNI, SUBSTRING(FormaPago,1,40), DefMoneda,    @TipoEfecto, DefMoneda,                 '',           DefMoneda,              Estatus,       @PorcentajeIVA,Almacen, ReferenciaIntelisisService,INFORTallerExterior,INFORProveedorNal
              FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Prov',1)  
              WITH (Proveedor varchar(100), Nombre varchar(100), NombreCorto varchar(100), Direccion varchar(100), Direccion2 varchar(100), Poblacion varchar(100), Estado varchar(100), CodigoPostal varchar(100), FormaPago varchar(100), DefMoneda varchar(100), Estatus varchar(100),ReferenciaIntelisisService  varchar(100),Almacen  varchar(100), INFORTallerExterior varchar(100),INFORProveedorNal varchar(100))
    IF @@ERROR <> 0 SET @Ok = 1
    EXEC sp_xml_removedocument @iSolicitud
    IF @@ERROR <> 0 SET @Ok = 1
  END		
  SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService from @Tabla
  SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oProveedor FOR XML AUTO))
  SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +  'Infor.Cuenta.Proveedor.Mantenimiento'  + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>'  		
  
  IF @Ok IS NULL
    EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							

END
GO
/**************** spIntelisisCuentaProvListado ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaProvListado') and type = 'P') drop procedure dbo.spIntelisisCuentaProvListado
GO             
CREATE PROCEDURE spIntelisisCuentaProvListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
		
  		@Proveedor				varchar(10),
		@Rama					varchar(20),
		@Nombre 				varchar(100),
		@NombreCorto            varchar(20),
		@Direccion				varchar(100),
		@DireccionNumero		varchar(20), 
		@DireccionNumeroInt		varchar(20), 
		@Colonia     			varchar(100),
		@Delegacion				varchar(100),
		@Poblacion				varchar(100),
		@Estado					varchar(30),
		@Pais					varchar(30),		
		@CodigoPostal 			varchar(15),
	    @Grupo      			varchar(50),
		@Categoria     			varchar(50),
		@Familia     			varchar(50),
		@Zona        			varchar(30),
		@Ruta       			varchar(50),
		@Tipo       			varchar(15),
		@Sucursal     			int,
		@Estatus    			varchar(15),
        @DefMoneda				varchar(10),
		@FormaPago				varchar(50),
		@Alta       			datetime,
		@Cuenta					varchar(20),
	    @Texto					xml,
		@ReferenciaIS			varchar(100),
		@SubReferencia			varchar(100)

  SELECT @Proveedor = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Proveedor'
  SELECT @Rama = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Rama'
  SELECT @Nombre = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Nombre'
  SELECT @NombreCorto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'NombreCorto'
  SELECT @Direccion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Direccion'
  SELECT @DireccionNumero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DireccionNumero' 
  SELECT @DireccionNumeroInt = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DireccionNumeroInt'
  SELECT @Colonia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Colonia'
  SELECT @Delegacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Delegacion'
  SELECT @Poblacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Poblacion'
  SELECT @Estado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Estado'
  SELECT @Pais = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Pais'
  SELECT @CodigoPostal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CodigoPostal'
  SELECT @Categoria = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Categoria'
  SELECT @Zona = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Zona'
  SELECT @Ruta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Ruta'
  SELECT @Tipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Tipo'
  SELECT @Estatus = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Estatus'
  SELECT @DefMoneda = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DefMoneda'
  SELECT @FormaPago = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FormaPago'
  SELECT @Alta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Alta'
  SELECT @Cuenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Cuenta'

  SELECT @Texto =(SELECT 
			ISNULL(Proveedor, '') [Proveedor],
			ISNULL(Rama, '') [Rama],
			ISNULL(Nombre, '') [Nombre],
			ISNULL(NombreCorto, '') [NombreCorto],
			ISNULL(Direccion, '') [Direccion],
			ISNULL(DireccionNumero, '') [DireccionNumero],
			ISNULL(DireccionNumeroInt, '') [DireccionNumeroInt],
			ISNULL(EntreCalles, '') [EntreCalles],
			ISNULL(Plano, '') [Plano],
			ISNULL(Observaciones, '') [Observaciones],
			ISNULL(Delegacion, '') [Delegacion],
			ISNULL(Colonia, '') [Colonia],
			ISNULL(Poblacion, '') [Poblacion],
			ISNULL(Estado, '') [Estado],
			ISNULL(Zona, '') [Zona],
			ISNULL(Ruta, '') [Ruta],
			ISNULL(Pais, '') [Pais],
			ISNULL(CodigoPostal, '') [CodigoPostal],
			ISNULL(Telefonos, '') [Telefonos],
			ISNULL(Fax, '') [Fax],
			ISNULL(PedirTono, 0) [PedirTono],
			ISNULL(DirInternet, '') [DirInternet],
			ISNULL(Contacto1, '') [Contacto1],
			ISNULL(Contacto2, '') [Contacto2],
			ISNULL(Extencion1, '') [Extencion1],
			ISNULL(Extencion2, '') [Extencion2],
			ISNULL(eMail1, '') [eMail1],
			ISNULL(eMail2, '') [eMail2],
			ISNULL(RFC, '') [RFC],
			ISNULL(CURP, '') [CURP],
			ISNULL(Categoria, '') [Categoria],
			ISNULL(Familia, '') [Familia],
			ISNULL(ZonaImpuesto, '') [ZonaImpuesto],
			ISNULL(FormaEnvio, '') [FormaEnvio],
			ISNULL(Descuento, '') [Descuento],
			ISNULL(Comprador, '') [Comprador],
			ISNULL(Proyecto, '') [Proyecto],
			ISNULL(Condicion, '') [Condicion],
			ISNULL(CtaDinero, '') [CtaDinero],
			ISNULL(Almacen, '') [Almacen],
			ISNULL(DiaRevision1, '') [DiaRevision1],
			ISNULL(DiaRevision2, '') [DiaRevision2],
			ISNULL(HorarioRevision, '') [HorarioRevision],
			ISNULL(DiaPago1, '') [DiaPago1],
			ISNULL(DiaPago2, '') [DiaPago2],
			ISNULL(HorarioPago, '') [HorarioPago],
			ISNULL(Beneficiario, 0) [Beneficiario],
			ISNULL(BeneficiarioNombre, '') [BeneficiarioNombre],
			ISNULL(LeyendaCheque, '') [LeyendaCheque],
			ISNULL(Agente, '') [Agente],
			ISNULL(Situacion, '') [Situacion],
			[SituacionFecha],
			ISNULL(SituacionUsuario, '') [SituacionUsuario],
			ISNULL(SituacionNota, '') [SituacionNota],
			ISNULL(Clase, '') [Clase],
			ISNULL(Estatus, '') [Estatus],
			[UltimoCambio],
			[Alta],
			ISNULL(Conciliar, 0) [Conciliar],
			ISNULL(Mensaje, '') [Mensaje],
			ISNULL(Tipo, '') [Tipo],
			ISNULL(ProntoPago, 0) [ProntoPago],
			ISNULL(DefMoneda, '') [DefMoneda],
			ISNULL(ProvBancoSucursal, '') [ProvBancoSucursal],
			ISNULL(ProvCuenta, '') [ProvCuenta],
			ISNULL(Logico1, 0) [Logico1],
			ISNULL(Logico2, 0) [Logico2],
			ISNULL(Logico3, 0) [Logico3],
			ISNULL(TieneMovimientos, 0) [TieneMovimientos],
			ISNULL(DescuentoRecargos, 0) [DescuentoRecargos],
			ISNULL(CompraAutoCargosTipo, '') [CompraAutoCargosTipo],
			ISNULL(CompraAutoCargos, 0) [CompraAutoCargos],
			ISNULL(Pagares, 0) [Pagares],
			ISNULL(Aforo, 0) [Aforo],
			ISNULL(MaximoAplicacionPagos, 0) [MaximoAplicacionPagos],
			ISNULL(NivelAcceso, '') [NivelAcceso],
			ISNULL(Idioma, '') [Idioma],
			ISNULL(ListaPreciosEsp, '') [ListaPreciosEsp],
			ISNULL(Contrasena, '') [Contrasena],
			ISNULL(AutoEndoso, '') [AutoEndoso],
			ISNULL(Cuenta, '') [Cuenta],
			ISNULL(CuentaRetencion, '') [CuentaRetencion],
			ISNULL(FormaPago, '') [FormaPago],
			ISNULL(wGastoSolicitud, 0) [wGastoSolicitud],
			ISNULL(ConLimiteAnticipos, 0) [ConLimiteAnticipos],
			ISNULL(LimiteAnticiposMN, 0) [LimiteAnticiposMN],
			ISNULL(ChecarLimite, '') [ChecarLimite],
			ISNULL(eMailAuto, 0) [eMailAuto],
			ISNULL(FiscalRegimen, '') [FiscalRegimen],
			ISNULL(FiscalZona, '') [FiscalZona],
			ISNULL(Intercompania, 0) [Intercompania],
			ISNULL(GarantiaCostos, 0) [GarantiaCostos],
			ISNULL(GarantiaCostosPlazo, 0) [GarantiaCostosPlazo],
			ISNULL(ImportadorRegimen, '') [ImportadorRegimen],
			ISNULL(ImportadorRegistro, '') [ImportadorRegistro],
			ISNULL(Comision, 0) [Comision],
			ISNULL(Importe1, 0) [Importe1],
			ISNULL(Importe2, 0) [Importe2],
			ISNULL(Origen, '') [Origen],
			ISNULL(OrigenID, '') [OrigenID],
			ISNULL(MapaLatitud, 0) [MapaLatitud],
			ISNULL(MapaLongitud, 0) [MapaLongitud],
			ISNULL(MapaPrecision, 0) [MapaPrecision],
			ISNULL(TipoRegistro, '') [TipoRegistro],
			ISNULL(AutorizacionSRI, '') [AutorizacionSRI],
			[VigenciaSRI],
			ISNULL(FiscalGenerar, 0) [FiscalGenerar],
			[SincroID],
			ISNULL(SincroC, 0) [SincroC],
			ISNULL(INFORTallerExterior, 0) [INFORTallerExterior],
			ISNULL(INFORProveedorNal, 0) [INFORProveedorNal],
			ISNULL(ReferenciaIntelisisService, '') [ReferenciaIntelisisService]
    FROM Prov 
   WHERE ISNULL(Proveedor,'') = ISNULL(ISNULL(@Proveedor,Proveedor),'')
     AND ISNULL(Rama,'') = ISNULL(ISNULL(@Rama,Rama),'')		
     AND ISNULL(Nombre,'') = ISNULL(ISNULL(@Nombre,Nombre),'') 				
   	 AND ISNULL(NombreCorto,'') = ISNULL(ISNULL(@NombreCorto,NombreCorto),'')
	 AND ISNULL(Colonia,'') = ISNULL(ISNULL(@Colonia,Colonia),'')     			
     AND ISNULL(Delegacion,'') =	ISNULL(ISNULL(@Delegacion,Delegacion),'')				
     AND ISNULL(Poblacion,'')  =	ISNULL(ISNULL(@Poblacion,Poblacion),'')				
     AND ISNULL(Estado,'') =	ISNULL(ISNULL(@Estado,Estado),'')					
     AND ISNULL(Pais,'') =	ISNULL(ISNULL(@Pais,Pais),'')							
     AND ISNULL(CodigoPostal,'') = ISNULL(ISNULL(@CodigoPostal,CodigoPostal),'') 			
     AND ISNULL(Categoria,'') = ISNULL(ISNULL(@Categoria,Categoria),'')     			
     AND ISNULL(Zona,'') = ISNULL(ISNULL(@Zona,Zona),'')        			
     AND ISNULL(Ruta,'') = ISNULL(ISNULL(@Ruta,Ruta),'')       			
     AND ISNULL(Tipo,'') = ISNULL(ISNULL(@Tipo,Tipo),'')	
     AND ISNULL(Estatus,'') = ISNULL(ISNULL(@Estatus,Estatus),'')    			
     AND ISNULL(DefMoneda,'') = ISNULL(ISNULL(@DefMoneda,DefMoneda),'')    			
     AND ISNULL(FormaPago,'') = ISNULL(ISNULL(@FormaPago,FormaPago),'')    			
     AND ISNULL(Alta,'') = ISNULL(ISNULL(@Alta,Alta),'')    
     AND ISNULL(Cuenta,'') =ISNULL(ISNULL(@Cuenta,Cuenta),'')	
     FOR XML AUTO)	
  IF @@ERROR <> 0 SET @Ok = 1
  BEGIN
    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
    IF @@ERROR <> 0 SET @Ok = 1

    IF @Ok IS NULL
    BEGIN
      SELECT @Resultado =REPLACE( '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>','','N')
      IF @@ERROR <> 0 SET @Ok = 1
    END
  END
END
GO
/**************** spIntelisisInterfazInforTransferenciaUnidad ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaUnidad')           AND type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaUnidad
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaUnidad
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
		@Unidad     				        varchar(50),
		@Datos								varchar(max),
		@Solicitud							varchar(max),
		@ReferenciaIS						varchar(100),
		@SubReferencia						varchar(100),
		@IDNuevo							int,
		@Datos2								varchar(max),
		@Resultado2							varchar(max),
		@Usuario							varchar(10),
		@Contrasena							varchar(32),
		@Verificar							int,
		@ReferenciaIntelisisService			varchar(50)
								

  DECLARE
		@Tabla			 table
		(
		 Unidad					    	 varchar(50),
		 Clave					    	 varchar(3),
                 Descripcion					 varchar(30),
		 ReferenciaIntelisisService      varchar(50)
		 )
		
 
 SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
   FROM IntelisisService 
  WHERE ID = @ID
 
  
 SELECT @Contrasena = Contrasena 
   FROM Usuario
  WHERE Usuario = @Usuario
 
  
 IF @Ok IS NULL
 BEGIN 
   SELECT @Unidad = Unidad FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Unidad')
    WITH (Unidad varchar(255))

    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@ID,'')),'') + CHAR(34) +  ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@Ok,'')),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(ISNULL(@OkRef,''),'') + CHAR(34) + '/></Intelisis>'
    SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Unidad.Listado" SubReferencia="'+ISNULL(@SubReferencia,'')+'" Version="1.0"><Solicitud><Parametro Campo="Unidad" Valor="'+@Unidad+'"/></Solicitud></Intelisis>'
     
    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDnuevo Output

    IF @Ok IS NULL
      SELECT @Solicitud = Resultado 
        FROM IntelisisService
       WHERE ID = @IDNuevo
  
      EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
      IF @@ERROR <> 0 SET @Ok = 1
      INSERT @Tabla (Unidad,Descripcion, ReferenciaIntelisisService, Clave)
      SELECT         Clave, Unidad,      ReferenciaIntelisisService, Clave
        FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Unidad',1)  
        WITH (Unidad varchar(100), INFORDescripcion varchar(100),ReferenciaIntelisisService varchar(100), Clave varchar(3))
      IF @@ERROR <> 0 SET @Ok = 1
      EXEC sp_xml_removedocument @iSolicitud
      IF @@ERROR <> 0 SET @Ok = 1
     
        SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService from @Tabla
        SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oUnidad FOR XML AUTO))
        SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Unidad.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)+ ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>'  
  END
  ELSE
  BEGIN
    SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Unidad.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud><ERROR Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + '/></Solicitud></Intelisis>' 		
    
  END      

  EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
					
END
GO
/************** spIntelisisCuentaUnidadListado ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaUnidadListado')           AND type = 'P') drop procedure dbo.spIntelisisCuentaUnidadListado
GO             
CREATE PROCEDURE spIntelisisCuentaUnidadListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
		
		@Unidad			varchar(50), 
		@Factor			float, 
		@Multiplo		float, 
		@Decimales		int, 
		@Orden			int, 
		@AutoAjuste		float, 
		@Clave			char(3),
		@Texto				xml,
		@ReferenciaIS		varchar(100),
		@SubReferencia		varchar(100)




  SELECT  @Unidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Unidad'
  SELECT  @Factor= Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Factor'
  SELECT  @Multiplo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Multiplo'
  SELECT  @Decimales = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Decimales'
  SELECT  @Orden = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Orden'
  SELECT  @AutoAjuste = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'AutoAjuste'
  SELECT  @Clave = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Clave'

  

  SELECT @Texto =(SELECT * FROM Unidad 
   WHERE           ISNULL(Unidad,'') = ISNULL(ISNULL(@Unidad,Unidad),'') 
               AND ISNULL(Factor,'') = ISNULL(ISNULL(@Factor,Factor),'') 
               AND ISNULL(Multiplo,'') = ISNULL(ISNULL(@Multiplo,Multiplo),'') 
               AND ISNULL(Decimales,'') = ISNULL(ISNULL(@Decimales,Decimales),'') 
               AND ISNULL(Orden,'') = ISNULL(ISNULL(@Orden,Orden),'') 
               AND ISNULL(AutoAjuste,'') = ISNULL(ISNULL(@AutoAjuste,AutoAjuste),'') 
               AND ISNULL(Clave,'') = ISNULL(ISNULL(@Clave,Clave),'') 
    
     FOR XML AUTO)	

  IF @@ERROR <> 0 SET @Ok = 1
  BEGIN
    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
    IF @@ERROR <> 0 SET @Ok = 1
    
    IF @Ok IS NULL
    BEGIN
      SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'
      IF @@ERROR <> 0 SET @Ok = 1
    END
  END
END
GO
/**************** spIntelisisInterfazInforTransferenciaPersonal ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaPersonal')           AND type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaPersonal
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaPersonal
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
		@Personal     				        varchar(10),
		@Datos								varchar(max),
		@Solicitud							varchar(max),
		@ReferenciaIS						varchar(100),
		@SubReferencia						varchar(100),
		@IDNuevo							int,
		@Datos2								varchar(max),
		@Resultado2							varchar(max),
		@Usuario							varchar(10),
		@Contrasena							varchar(32),
		@Verificar							int	,
	    @ReferenciaIntelisisService			varchar(50)					

  DECLARE
		@Tabla			 table(
	Operario					varchar(100),
	ReferenciaIntelisisService	varchar(50),
    Nombre						varchar(35),
	Direccion					varchar(40),
	Poblacion					varchar(40),
	CodigoPostal				varchar(15),
	Telefono					varchar(16),
	LugarNacimiento				varchar(40),
	EstadoCivil					varchar(1),
	TipoContrato				varchar(40),
	Inactivo						varchar(1)
		 )
		
 

  SELECT @Personal = Personal FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Personal')
    WITH (Personal varchar(255))
  --SELECT @Verificar =LEN(@Personal)
  --IF  @Verificar  > 6  SELECT @Ok = 40026, @OkRef = @Personal

  
 SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
   FROM IntelisisService 
  WHERE ID = @ID
  
  
 SELECT @Contrasena = Contrasena 
   FROM Usuario
  WHERE Usuario = @Usuario
  
  
 IF @Ok IS NULL
 BEGIN 

    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@ID,'')),'') + CHAR(34) +  ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@Ok,'')),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(ISNULL(@OkRef,''),'') + CHAR(34) + '/></Intelisis>'
    SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Personal.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Personal" Valor="'+@Personal+'"/></Solicitud></Intelisis>'
     
    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDnuevo Output
  
    IF @Ok IS NULL
      SELECT @Solicitud = Resultado 
        FROM IntelisisService
       WHERE ID = @IDNuevo
  
      EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
      IF @@ERROR <> 0 SET @Ok = 1
      INSERT @Tabla (       	Operario, ReferenciaIntelisisService, Nombre,													 Direccion,                           Poblacion,                 CodigoPostal,                 Telefono,                 LugarNacimiento,                 EstadoCivil,                TipoContrato,	           Inactivo)
           SELECT 	            Personal, ReferenciaIntelisisService, SUBSTRING(ApellidoPaterno +' ' +ApellidoMaterno+' '+Nombre,1,35), SUBSTRING(Direccion,1,40), SUBSTRING(Poblacion,1,40), SUBSTRING(CodigoPostal,1,10), SUBSTRING(Telefono,1,16), SUBSTRING(LugarNacimiento,1,40), SUBSTRING(EstadoCivil,1,1), SUBSTRING(TipoContrato,1,40), CASE Estatus WHEN 'ALTA' THEN 0 ELSE 1 END
             FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Personal',1)  
                WITH (Personal varchar(100), ReferenciaIntelisisService varchar(100),ApellidoPaterno varchar(100),ApellidoMaterno varchar(100),Nombre varchar(100),Direccion varchar(100),Poblacion varchar(100),CodigoPostal varchar(100),Telefono varchar(100),LugarNacimiento varchar(100),EstadoCivil varchar(100),TipoContrato varchar(100),Estatus varchar(100))
      IF @@ERROR <> 0 SET @Ok = 1
      EXEC sp_xml_removedocument @iSolicitud
      IF @@ERROR <> 0 SET @Ok = 1
		SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService FROM @Tabla
                SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oOperarios FOR XML AUTO))
        SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Personal.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' >' + @Resultado2 + '</Solicitud></Intelisis>'  
  END
  ELSE
  BEGIN
    SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Personal.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud><ERROR Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + '/></Solicitud></Intelisis>' 		
    
  END      

  EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
					
END
GO
/************** spIntelisisCuentaPersonalListado ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaPersonalListado')           AND type = 'P') drop procedure dbo.spIntelisisCuentaPersonalListado
GO             
CREATE PROCEDURE spIntelisisCuentaPersonalListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
		
		@Personal			varchar(10),
		@ApellidoPaterno	varchar(30), 
		@ApellidoMaterno	varchar(30), 
		@Nombre				varchar(30), 
		@Tipo				varchar(20), 
		@Direccion			varchar(100), 
		@DireccionNumero	varchar(20), 
		@DireccionNumeroInt varchar(20), 
		@Colonia			varchar(100), 
		@Delegacion			varchar(100), 
		@Poblacion			varchar(100),	
		@Estado				varchar(30), 
		@Pais				varchar(30), 
		@CodigoPostal		varchar(15), 
		@Telefono			varchar(50), 
		@eMail				varchar(50), 
		@eMailAuto			bit   ,		
		@ZonaEconomica		varchar(30), 
		@Registro			varchar(30), 
		@Registro2			varchar(30), 
		@Registro3			varchar(30), 
		@Registro4			varchar(30), 
		@FormaPago			varchar(50), 
		@CtaDinero			varchar(10), 
		@Afore				varchar(10), 
		@PersonalSucursal   varchar(50), 
		@PersonalCuenta		varchar(20), 
		@FechaNacimiento	datetime   , 
		@LugarNacimiento	varchar(50), 
		@Nacionalidad		varchar(30), 
		@Pasaporte			varchar(30), 
		@Cartilla			varchar(30), 
		@Permiso			varchar(30), 
		@NivelAcademico		varchar(50), 
		@Sexo				varchar(10), 
		@EstadoCivil		varchar(20), 
		@Hijos				int   , 
		@Dependientes		int   , 
		@Beneficiario		varchar(50), 
		@BeneficiarioNacimiento   datetime   , 
		@Parentesco			varchar(20), 
		@Porcentaje			float   , 
		@Beneficiario2		varchar(50), 
		@Beneficiario2Nacimiento   datetime   , 
		@Parentesco2		varchar(20), 
		@Porcentaje2		float   , 
		@Beneficiario3		varchar(50), 
		@Beneficiario3Nacimiento   datetime   , 
		@Parentesco3		varchar(20), 
		@Porcentaje3		float   , 
		@Beneficiario4		varchar(50), 
		@Beneficiario4Nacimiento   datetime   , 
		@Parentesco4		varchar(20), 
		@Porcentaje4		float   ,	
		@Beneficiario5		varchar(50), 
		@Beneficiario5Nacimiento   datetime   , 
		@Parentesco5		varchar(20), 
		@Porcentaje5		float   , 
		@Beneficiario6		varchar(50), 
		@Beneficiario6Nacimiento   datetime   , 
		@Parentesco6		varchar(20), 
		@Porcentaje6		float   , 
		@Beneficiario7		varchar(50), 
		@Beneficiario7Nacimiento   datetime   , 
		@Parentesco7		varchar(20), 
		@Porcentaje7		float   , 
		@Beneficiario8		varchar(50), 
		@Beneficiario8Nacimiento   datetime   , 
		@Parentesco8		varchar(20), 
		@Porcentaje8		float   , 
		@Valuacion			varchar(50), 
		@Padre				varchar(50), 
		@Madre				varchar(50), 
		@UnidadMedica		int   , 
		@CentroCostos		varchar(20), 
		@ReportaA			varchar(10), 
		@AspiraSueldo		varchar(50), 
		@AspiraCategoria	varchar(50), 
		@AspiraDepartamento varchar(50), 
		@AspiraGrupo		varchar(50), 
		@AspiraPuesto		varchar(50),	
		@AspiraFecha		datetime   , 
		@Categoria			varchar(50), 
		@Departamento		varchar(50), 
		@Grupo				varchar(50), 
		@Puesto				varchar(50), 
		@TipoContrato		varchar(50), 
		@PeriodoTipo		varchar(20), 
		@Jornada			varchar(20), 
		@TipoSueldo			varchar(10), 
		@Moneda				varchar(10), 
		@DiasPeriodo		varchar(20), 
		@SueldoDiario		money   , 
		@SDI				money   , 
		@SDIBimestral		money   , 
		@SDIAnterior		money   , 
		@SueldoDiarioComplemento   money   , 
		@FechaAlta			datetime   , 
		@FechaBaja			datetime   , 
		@ConceptoBaja		varchar(50), 
		@FechaAntiguedad	datetime   , 
		@UltimaModificacion datetime   , 
		@UltimoPago			datetime   , 
		@VencimientoContrato datetime   , 
		@Estatus			varchar(15), 
		@UltimoCambio		datetime   , 
		@Situacion			varchar(50), 
		@SituacionFecha		datetime   , 
		@SituacionUsuario   varchar(10), 
		@SituacionNota		varchar(100), 
		@Logico1			bit   , 
		@Logico2			bit   , 
		@Logico3			bit   , 
		@Logico4			bit   , 
		@Logico5			bit   , 
		@Logico6			bit   , 
		@Logico7			bit   , 
		@Logico8			bit   , 
		@EstaPresente		bit   , 
		@TieneMovimientos   bit   , 
		@SucursalTrabajo	int   , 
		@NivelAcceso		varchar(50), 
		@MinimoProfesional  int   , 
		@Sindicato			varchar(50), 
		@Vehiculo			varchar(10), 
		@TablaCobranza		varchar(50), 
		@TablaCobranzaBono  varchar(50), 
		@TablaCobranzaCascada   varchar(50), 
		@TablaCobranzaBonoCascada   varchar(50), 
		@TablaVentaCascada  varchar(50), 
		@UEN				int   , 
		@Actividad			varchar(100), 
		@Area				varchar(50), 
		@Fuente				varchar(50), 
		@Reclutador			varchar(10), 
		@RecomendadoPor		varchar(10), 
		@Cuenta				varchar(20), 
		@CuentaRetencion	varchar(20), 
		@MovNomina			varchar(20), 
		@Contrasena			varchar(100), 
		@Configuracion		varchar(50), 
		@Referencia			varchar(50), 
		@ReferenciaDireccion varchar(50),	
		@ReferenciaTelefono varchar(20), 
		@Referencia2		varchar(50), 
		@Referencia2Direccion   varchar(50), 
		@Referencia2Telefono   varchar(20), 
		@Referencia3		varchar(50), 
		@Referencia3Direccion   varchar(50), 
		@Referencia3Telefono varchar(20), 
		@Licencia			varchar(20), 
		@LicenciaVencimiento   datetime   , 
		@Cliente			varchar(10), 
		@Incremento			float   , 
		@EsSocio			bit   , 
		@IndemnizacionPct   float   , 
		@Proyecto			varchar(50), 
		@Plaza				varchar(20), 
		@Empresa			varchar(5), 
		@SueldoMensual		money   , 
		@ISRFijoPeriodo		money   , 
		@RataHora			money   , 
		@DeclaraRenta		bit   , 
		@EsRecurso			bit   , 
		@EsAgente			bit   , 
		@EsUsuarioWeb		bit   , 
		@FechaInicioContrato   datetime   , 
		@DuracionContrato   int   , 
		@Confidencial		bit   , 
		@EntreCalles		varchar(100), 
		@Plano				varchar(15), 
		@Observaciones		varchar(100), 
		@MapaLatitud		float   , 
		@MapaLongitud		float   , 
		@MapaPrecision		int   , 
		@ActividadMedicion  varchar(50), 
		@SueldoDiarioAsimilable   money,   
		@Texto				xml,
		@ReferenciaIS		varchar(100),
		@SubReferencia		varchar(100)




  SELECT  @Personal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Personal'
  SELECT  @ApellidoPaterno = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ApellidoPaterno'
  SELECT  @ApellidoMaterno = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ApellidoMaterno'
  SELECT  @Nombre = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Nombre'
  SELECT  @Tipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Tipo'
  SELECT  @Direccion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Direccion'
  SELECT  @DireccionNumero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DireccionNumero'
  SELECT  @DireccionNumeroInt = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DireccionNumeroInt'
  SELECT  @Colonia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Colonia'
  SELECT  @Delegacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Delegacion'
  SELECT  @Poblacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Poblacion'
  SELECT  @Estado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Estado'
  SELECT  @Pais = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Pais'
  SELECT  @CodigoPostal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CodigoPostal'
  SELECT  @Telefono = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Telefono'
  SELECT  @eMail = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'eMail'
  SELECT  @eMailAuto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'eMailAuto'
  SELECT  @ZonaEconomica = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ZonaEconomica'
  SELECT  @Registro = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Registro'
  SELECT  @Registro2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Registro2'
  SELECT  @Registro3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Registro3'
  SELECT  @Registro4 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Registro4'
  SELECT  @FormaPago = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FormaPago'
  SELECT  @CtaDinero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CtaDinero'
  SELECT  @Afore = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Afore'
  SELECT  @PersonalSucursal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'PersonalSucursal'
  SELECT  @PersonalCuenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'PersonalCuenta'
  SELECT  @FechaNacimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FechaNacimiento'
  SELECT  @LugarNacimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'LugarNacimiento'
  SELECT  @Nacionalidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Nacionalidad'
  SELECT  @Pasaporte = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Pasaporte'
  SELECT  @Cartilla = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Cartilla'
  SELECT  @Permiso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Permiso'
  SELECT  @NivelAcademico = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'NivelAcademico'
  SELECT  @Sexo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')

    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Sexo'
  SELECT  @EstadoCivil = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EstadoCivil'
  SELECT  @Hijos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Hijos'
  SELECT  @Dependientes = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Dependientes'
  SELECT  @Beneficiario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario'
  SELECT  @BeneficiarioNacimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'BeneficiarioNacimiento'
  SELECT  @Parentesco = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Parentesco'
  SELECT  @Porcentaje = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Porcentaje'
  SELECT  @Beneficiario2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario2'
  SELECT  @Beneficiario2Nacimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario2Nacimiento'
  SELECT  @Parentesco2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Parentesco2'
  SELECT  @Porcentaje2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Porcentaje2'
  SELECT  @Beneficiario3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario3'
  SELECT  @Beneficiario3Nacimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario3Nacimiento'
  SELECT  @Parentesco3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Parentesco3'
  SELECT  @Porcentaje3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Porcentaje3'
  SELECT  @Beneficiario4 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario4'
  SELECT  @Beneficiario4Nacimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario4Nacimiento'
  SELECT  @Parentesco4 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Parentesco4'
  SELECT  @Porcentaje4 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Porcentaje4'
  SELECT  @Beneficiario5 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario5'
  SELECT  @Beneficiario5Nacimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario5Nacimiento'
  SELECT  @Parentesco5 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Parentesco5'
  SELECT  @Porcentaje5 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Porcentaje5'
  SELECT  @Beneficiario6 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario6'
  SELECT  @Beneficiario6Nacimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario6Nacimiento'
  SELECT  @Parentesco6 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Parentesco6'
  SELECT  @Porcentaje6 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Porcentaje6'
  SELECT  @Beneficiario7 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario7'
  SELECT  @Beneficiario7Nacimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario7Nacimiento'
  SELECT  @Parentesco7 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Parentesco7'
  SELECT  @Porcentaje7 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Porcentaje7'
  SELECT  @Beneficiario8 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario8'
  SELECT  @Beneficiario8Nacimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Beneficiario8Nacimiento'
  SELECT  @Parentesco8 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Parentesco8'
  SELECT  @Porcentaje8 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Porcentaje8'
  SELECT  @Valuacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Valuacion'
  SELECT  @Padre = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Padre'
  SELECT  @Madre = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Madre'
  SELECT  @UnidadMedica = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'UnidadMedica'
  SELECT  @CentroCostos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CentroCostos'
  SELECT  @ReportaA = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ReportaA'
  SELECT  @AspiraSueldo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'AspiraSueldo'
  SELECT  @AspiraCategoria = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'AspiraCategoria'
  SELECT  @AspiraDepartamento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'AspiraDepartamento'
  SELECT  @AspiraGrupo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'AspiraGrupo'
  SELECT  @AspiraPuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'AspiraPuesto'
  SELECT  @AspiraFecha = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'AspiraFecha'
  SELECT  @Categoria = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Categoria'
  SELECT  @Departamento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Departamento'
  SELECT  @Grupo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Grupo'
  SELECT  @Puesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Puesto'
  SELECT  @TipoContrato = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'TipoContrato'
  SELECT  @PeriodoTipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'PeriodoTipo'
  SELECT  @Jornada = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Jornada'
  SELECT  @TipoSueldo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'TipoSueldo'
  SELECT  @Moneda = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Moneda'
  SELECT  @DiasPeriodo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DiasPeriodo'
  SELECT  @SueldoDiario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SueldoDiario'
  SELECT  @SDI = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SDI'
  SELECT  @SDIBimestral = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SDIBimestral'
  SELECT  @SDIAnterior = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SDIAnterior'
  SELECT  @SueldoDiarioComplemento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SueldoDiarioComplemento'
  SELECT  @FechaAlta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FechaAlta'
  SELECT  @FechaBaja = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FechaBaja'
  SELECT  @ConceptoBaja = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ConceptoBaja'
  SELECT  @FechaAntiguedad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FechaAntiguedad'
  SELECT  @UltimaModificacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'UltimaModificacion'
  SELECT  @UltimoPago = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'UltimoPago'
  SELECT  @VencimientoContrato = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'VencimientoContrato'
  SELECT  @Estatus = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Estatus'
  SELECT  @UltimoCambio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'UltimoCambio'
  SELECT  @Situacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Situacion'
  SELECT  @SituacionFecha = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SituacionFecha'
  SELECT  @SituacionUsuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SituacionUsuario'
  SELECT  @SituacionNota = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SituacionNota'
  SELECT  @Logico1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Logico1'
  SELECT  @Logico2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Logico2'
  SELECT  @Logico3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Logico3'
  SELECT  @Logico4 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Logico4'
  SELECT  @Logico5 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Logico5'
  SELECT  @Logico6 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Logico6'
  SELECT  @Logico7 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Logico7'
  SELECT  @Logico8 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Logico8'
  SELECT  @EstaPresente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EstaPresente'
  SELECT  @TieneMovimientos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'TieneMovimientos'
  SELECT  @SucursalTrabajo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SucursalTrabajo'
  SELECT  @NivelAcceso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'NivelAcceso'
  SELECT  @MinimoProfesional = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'MinimoProfesional'
  SELECT  @Sindicato = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Sindicato'
  SELECT  @Vehiculo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Vehiculo'
  SELECT  @TablaCobranza = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'TablaCobranza'
  SELECT  @TablaCobranzaBono = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'TablaCobranzaBono'
  SELECT  @TablaCobranzaCascada = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'TablaCobranzaCascada'
  SELECT  @TablaCobranzaBonoCascada = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'TablaCobranzaBonoCascada'
  SELECT  @TablaVentaCascada = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'TablaVentaCascada'
  SELECT  @UEN = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'UEN'
  SELECT  @Actividad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Actividad'
  SELECT  @Area = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Area'
  SELECT  @Fuente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Fuente'
  SELECT  @Reclutador = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Reclutador'
  SELECT  @RecomendadoPor = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'RecomendadoPor'
  SELECT  @Cuenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Cuenta'
  SELECT  @CuentaRetencion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CuentaRetencion'
  SELECT  @MovNomina = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'MovNomina'
  SELECT  @Contrasena = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Contrasena'
  SELECT  @Configuracion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Configuracion'
  SELECT  @Referencia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Referencia'
  SELECT  @ReferenciaDireccion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ReferenciaDireccion'
  SELECT  @ReferenciaTelefono = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ReferenciaTelefono'
  SELECT  @Referencia2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Referencia2'
  SELECT  @Referencia2Direccion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Referencia2Direccion'
  SELECT  @Referencia2Telefono = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Referencia2Telefono'
  SELECT  @Referencia3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Referencia3'
  SELECT  @Referencia3Direccion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Referencia3Direccion'
  SELECT  @Referencia3Telefono = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Referencia3Telefono'
  SELECT  @Licencia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Licencia'
  SELECT  @LicenciaVencimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'LicenciaVencimiento'
  SELECT  @Cliente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Cliente'
  SELECT  @Incremento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Incremento'
  SELECT  @EsSocio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EsSocio'
  SELECT  @IndemnizacionPct = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'IndemnizacionPct'
  SELECT  @Proyecto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Proyecto'
  SELECT  @Plaza = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Plaza'
  SELECT  @Empresa = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Empresa'
  SELECT  @SueldoMensual = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SueldoMensual'
  SELECT  @ISRFijoPeriodo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ISRFijoPeriodo'
  SELECT  @RataHora = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'RataHora'
  SELECT  @DeclaraRenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DeclaraRenta'
  SELECT  @EsRecurso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EsRecurso'
  SELECT  @EsAgente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EsAgente'
  SELECT  @EsUsuarioWeb = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EsUsuarioWeb'
  SELECT  @FechaInicioContrato = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FechaInicioContrato'
  SELECT  @DuracionContrato = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DuracionContrato'
  SELECT  @Confidencial = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Confidencial'
  SELECT  @EntreCalles = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EntreCalles'
  SELECT  @Plano = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Plano'
  SELECT  @Observaciones = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Observaciones'
  SELECT  @MapaLatitud = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'MapaLatitud'
  SELECT  @MapaLongitud = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'MapaLongitud'
  SELECT  @MapaPrecision = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'MapaPrecision'
  SELECT  @ActividadMedicion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ActividadMedicion'
  SELECT  @SueldoDiarioAsimilable = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SueldoDiarioAsimilablable'

  

  SELECT @Texto =(SELECT * FROM Personal
   WHERE ISNULL(Personal,'') = ISNULL(ISNULL(@Personal,Personal),'')
     AND ISNULL(ApellidoPaterno,'') = ISNULL(ISNULL(@ApellidoPaterno,ApellidoPaterno),'')
     AND ISNULL(ApellidoMaterno,'') = ISNULL(ISNULL(@ApellidoMaterno,ApellidoMaterno),'')
     AND ISNULL(Nombre,'') = ISNULL(ISNULL(@Nombre,Nombre),'')
     AND ISNULL(Tipo,'') = ISNULL(ISNULL(@Tipo,Tipo),'')
     AND ISNULL(Direccion,'') = ISNULL(ISNULL(@Direccion,Direccion),'')
     AND ISNULL(DireccionNumero,'') = ISNULL(ISNULL(@DireccionNumero,DireccionNumero),'')
     AND ISNULL(DireccionNumeroInt,'') = ISNULL(ISNULL(@DireccionNumeroInt,DireccionNumeroInt),'')
     AND ISNULL(Colonia,'') = ISNULL(ISNULL(@Colonia,Colonia),'')
     AND ISNULL(Delegacion,'') = ISNULL(ISNULL(@Delegacion,Delegacion),'')
     AND ISNULL(Poblacion,'') = ISNULL(ISNULL(@Poblacion,Poblacion),'')
     AND ISNULL(Estado,'') = ISNULL(ISNULL(@Estado,Estado),'')
     AND ISNULL(Pais,'') = ISNULL(ISNULL(@Pais,Pais),'')
     AND ISNULL(CodigoPostal,'') = ISNULL(ISNULL(@CodigoPostal,CodigoPostal),'')
     AND ISNULL(Telefono,'') = ISNULL(ISNULL(@Telefono,Telefono),'')
     AND ISNULL(eMail,'') = ISNULL(ISNULL(@eMail,eMail),'')
     AND ISNULL(eMailAuto,'') = ISNULL(ISNULL(@eMailAuto,eMailAuto),'')
     AND ISNULL(ZonaEconomica,'') = ISNULL(ISNULL(@ZonaEconomica,ZonaEconomica),'')
     AND ISNULL(Registro,'') = ISNULL(ISNULL(@Registro,Registro),'')
     AND ISNULL(Registro2,'') = ISNULL(ISNULL(@Registro2,Registro2),'')
     AND ISNULL(Registro3,'') = ISNULL(ISNULL(@Registro3,Registro3),'')
     AND ISNULL(Registro4,'') = ISNULL(ISNULL(@Registro4,Registro4),'')
     AND ISNULL(FormaPago,'') = ISNULL(ISNULL(@FormaPago,FormaPago),'')
     AND ISNULL(CtaDinero,'') = ISNULL(ISNULL(@CtaDinero,CtaDinero),'')
     AND ISNULL(Afore,'') = ISNULL(ISNULL(@Afore,Afore),'')
     AND ISNULL(PersonalSucursal,'') = ISNULL(ISNULL(@PersonalSucursal,PersonalSucursal),'')
     AND ISNULL(PersonalCuenta,'') = ISNULL(ISNULL(@PersonalCuenta,PersonalCuenta),'')
     AND ISNULL(FechaNacimiento,'') = ISNULL(ISNULL(@FechaNacimiento,FechaNacimiento),'')
     AND ISNULL(LugarNacimiento,'') = ISNULL(ISNULL(@LugarNacimiento,LugarNacimiento),'')
     AND ISNULL(Nacionalidad,'') = ISNULL(ISNULL(@Nacionalidad,Nacionalidad),'')
     AND ISNULL(Pasaporte,'') = ISNULL(ISNULL(@Pasaporte,Pasaporte),'')
     AND ISNULL(Cartilla,'') = ISNULL(ISNULL(@Cartilla,Cartilla),'')
     AND ISNULL(Permiso,'') = ISNULL(ISNULL(@Permiso,Permiso),'')
     AND ISNULL(NivelAcademico,'') = ISNULL(ISNULL(@NivelAcademico,NivelAcademico),'')
     AND ISNULL(Sexo,'') = ISNULL(ISNULL(@Sexo,Sexo),'')
     AND ISNULL(EstadoCivil,'') = ISNULL(ISNULL(@EstadoCivil,EstadoCivil),'')
     AND ISNULL(Hijos,'') = ISNULL(ISNULL(@Hijos,Hijos),'')
     AND ISNULL(Dependientes,'') = ISNULL(ISNULL(@Dependientes,Dependientes),'')
     AND ISNULL(Beneficiario,'') = ISNULL(ISNULL(@Beneficiario,Beneficiario),'')
     AND ISNULL(BeneficiarioNacimiento,'') = ISNULL(ISNULL(@BeneficiarioNacimiento,BeneficiarioNacimiento),'')
     AND ISNULL(Parentesco,'') = ISNULL(ISNULL(@Parentesco,Parentesco),'')
     AND ISNULL(Porcentaje,'') = ISNULL(ISNULL(@Porcentaje,Porcentaje),'')
     AND ISNULL(Beneficiario2,'') = ISNULL(ISNULL(@Beneficiario2,Beneficiario2),'')
     AND ISNULL(Beneficiario2Nacimiento,'') = ISNULL(ISNULL(@Beneficiario2Nacimiento,Beneficiario2Nacimiento),'')
     AND ISNULL(Parentesco2,'') = ISNULL(ISNULL(@Parentesco2,Parentesco2),'')
     AND ISNULL(Porcentaje2,'') = ISNULL(ISNULL(@Porcentaje2,Porcentaje2),'')
     AND ISNULL(Beneficiario3,'') = ISNULL(ISNULL(@Beneficiario3,Beneficiario3),'')
     AND ISNULL(Beneficiario3Nacimiento,'') = ISNULL(ISNULL(@Beneficiario3Nacimiento,Beneficiario3Nacimiento),'')
     AND ISNULL(Parentesco3,'') = ISNULL(ISNULL(@Parentesco3,Parentesco3),'')
     AND ISNULL(Porcentaje3,'') = ISNULL(ISNULL(@Porcentaje3,Porcentaje3),'')
     AND ISNULL(Beneficiario4,'') = ISNULL(ISNULL(@Beneficiario4,Beneficiario4),'')
     AND ISNULL(Beneficiario4Nacimiento,'') = ISNULL(ISNULL(@Beneficiario4Nacimiento,Beneficiario4Nacimiento),'')
     AND ISNULL(Parentesco4,'') = ISNULL(ISNULL(@Parentesco4,Parentesco4),'')
     AND ISNULL(Porcentaje4,'') = ISNULL(ISNULL(@Porcentaje4,Porcentaje4),'')
     AND ISNULL(Beneficiario5,'') = ISNULL(ISNULL(@Beneficiario5,Beneficiario5),'')
     AND ISNULL(Beneficiario5Nacimiento,'') = ISNULL(ISNULL(@Beneficiario5Nacimiento,Beneficiario5Nacimiento),'')
     AND ISNULL(Parentesco5,'') = ISNULL(ISNULL(@Parentesco5,Parentesco5),'')
     AND ISNULL(Porcentaje5,'') = ISNULL(ISNULL(@Porcentaje5,Porcentaje5),'')
     AND ISNULL(Beneficiario6,'') = ISNULL(ISNULL(@Beneficiario6,Beneficiario6),'')
     AND ISNULL(Beneficiario6Nacimiento,'') = ISNULL(ISNULL(@Beneficiario6Nacimiento,Beneficiario6Nacimiento),'')
     AND ISNULL(Parentesco6,'') = ISNULL(ISNULL(@Parentesco6,Parentesco6),'')
     AND ISNULL(Porcentaje6,'') = ISNULL(ISNULL(@Porcentaje6,Porcentaje6),'')
     AND ISNULL(Beneficiario7,'') = ISNULL(ISNULL(@Beneficiario7,Beneficiario7),'')
     AND ISNULL(Beneficiario7Nacimiento,'') = ISNULL(ISNULL(@Beneficiario7Nacimiento,Beneficiario7Nacimiento),'')
     AND ISNULL(Parentesco7,'') = ISNULL(ISNULL(@Parentesco7,Parentesco7),'')
     AND ISNULL(Porcentaje7,'') = ISNULL(ISNULL(@Porcentaje7,Porcentaje7),'')
     AND ISNULL(Beneficiario8,'') = ISNULL(ISNULL(@Beneficiario8,Beneficiario8),'')
     AND ISNULL(Beneficiario8Nacimiento,'') = ISNULL(ISNULL(@Beneficiario8Nacimiento,Beneficiario8Nacimiento),'')
     AND ISNULL(Parentesco8,'') = ISNULL(ISNULL(@Parentesco8,Parentesco8),'')
     AND ISNULL(Porcentaje8,'') = ISNULL(ISNULL(@Porcentaje8,Porcentaje8),'')
     AND ISNULL(Valuacion,'') = ISNULL(ISNULL(@Valuacion,Valuacion),'')
     AND ISNULL(Padre,'') = ISNULL(ISNULL(@Padre,Padre),'')
     AND ISNULL(Madre,'') = ISNULL(ISNULL(@Madre,Madre),'')
     AND ISNULL(UnidadMedica,'') = ISNULL(ISNULL(@UnidadMedica,UnidadMedica),'')
     AND ISNULL(CentroCostos,'') = ISNULL(ISNULL(@CentroCostos,CentroCostos),'')
     AND ISNULL(ReportaA,'') = ISNULL(ISNULL(@ReportaA,ReportaA),'')
     AND ISNULL(AspiraSueldo,'') = ISNULL(ISNULL(@AspiraSueldo,AspiraSueldo),'')
     AND ISNULL(AspiraCategoria,'') = ISNULL(ISNULL(@AspiraCategoria,AspiraCategoria),'')
     AND ISNULL(AspiraDepartamento,'') = ISNULL(ISNULL(@AspiraDepartamento,AspiraDepartamento),'')
     AND ISNULL(AspiraGrupo,'') = ISNULL(ISNULL(@AspiraGrupo,AspiraGrupo),'')
     AND ISNULL(AspiraPuesto,'') = ISNULL(ISNULL(@AspiraPuesto,AspiraPuesto),'')
     AND ISNULL(AspiraFecha,'') = ISNULL(ISNULL(@AspiraFecha,AspiraFecha),'')
     AND ISNULL(Categoria,'') = ISNULL(ISNULL(@Categoria,Categoria),'')
     AND ISNULL(Departamento,'') = ISNULL(ISNULL(@Departamento,Departamento),'')
     AND ISNULL(Grupo,'') = ISNULL(ISNULL(@Grupo,Grupo),'')
     AND ISNULL(Puesto,'') = ISNULL(ISNULL(@Puesto,Puesto),'')
     AND ISNULL(TipoContrato,'') = ISNULL(ISNULL(@TipoContrato,TipoContrato),'')
     AND ISNULL(PeriodoTipo,'') = ISNULL(ISNULL(@PeriodoTipo,PeriodoTipo),'')
     AND ISNULL(Jornada,'') = ISNULL(ISNULL(@Jornada,Jornada),'')
     AND ISNULL(TipoSueldo,'') = ISNULL(ISNULL(@TipoSueldo,TipoSueldo),'')
     AND ISNULL(Moneda,'') = ISNULL(ISNULL(@Moneda,Moneda),'')
     AND ISNULL(DiasPeriodo,'') = ISNULL(ISNULL(@DiasPeriodo,DiasPeriodo),'')
     AND ISNULL(SueldoDiario,'') = ISNULL(ISNULL(@SueldoDiario,SueldoDiario),'')
     AND ISNULL(SDI,'') = ISNULL(ISNULL(@SDI,SDI),'')
     AND ISNULL(SDIBimestral,'') = ISNULL(ISNULL(@SDIBimestral,SDIBimestral),'')
     AND ISNULL(SDIAnterior,'') = ISNULL(ISNULL(@SDIAnterior,SDIAnterior),'')
     AND ISNULL(SueldoDiarioComplemento,'') = ISNULL(ISNULL(@SueldoDiarioComplemento,SueldoDiarioComplemento),'')
     AND ISNULL(FechaAlta,'') = ISNULL(ISNULL(@FechaAlta,FechaAlta),'')
     AND ISNULL(FechaBaja,'') = ISNULL(ISNULL(@FechaBaja,FechaBaja),'')
     AND ISNULL(ConceptoBaja,'') = ISNULL(ISNULL(@ConceptoBaja,ConceptoBaja),'')
     AND ISNULL(FechaAntiguedad,'') = ISNULL(ISNULL(@FechaAntiguedad,FechaAntiguedad),'')
     AND ISNULL(UltimaModificacion,'') = ISNULL(ISNULL(@UltimaModificacion,UltimaModificacion),'')
     AND ISNULL(UltimoPago,'') = ISNULL(ISNULL(@UltimoPago,UltimoPago),'')
     AND ISNULL(VencimientoContrato,'') = ISNULL(ISNULL(@VencimientoContrato,VencimientoContrato),'')
     AND ISNULL(Estatus,'') = ISNULL(ISNULL(@Estatus,Estatus),'')
     AND ISNULL(UltimoCambio,'') = ISNULL(ISNULL(@UltimoCambio,UltimoCambio),'')
     AND ISNULL(Situacion,'') = ISNULL(ISNULL(@Situacion,Situacion),'')
     AND ISNULL(SituacionFecha,'') = ISNULL(ISNULL(@SituacionFecha,SituacionFecha),'')
     AND ISNULL(SituacionUsuario,'') = ISNULL(ISNULL(@SituacionUsuario,SituacionUsuario),'')
     AND ISNULL(SituacionNota,'') = ISNULL(ISNULL(@SituacionNota,SituacionNota),'')
     AND ISNULL(Logico1,'') = ISNULL(ISNULL(@Logico1,Logico1),'')
     AND ISNULL(Logico2,'') = ISNULL(ISNULL(@Logico2,Logico2),'')
     AND ISNULL(Logico3,'') = ISNULL(ISNULL(@Logico3,Logico3),'')
     AND ISNULL(Logico4,'') = ISNULL(ISNULL(@Logico4,Logico4),'')
     AND ISNULL(Logico5,'') = ISNULL(ISNULL(@Logico5,Logico5),'')
     AND ISNULL(Logico6,'') = ISNULL(ISNULL(@Logico6,Logico6),'')
     AND ISNULL(Logico7,'') = ISNULL(ISNULL(@Logico7,Logico7),'')
     AND ISNULL(Logico8,'') = ISNULL(ISNULL(@Logico8,Logico8),'')
     AND ISNULL(EstaPresente,'') = ISNULL(ISNULL(@EstaPresente,EstaPresente),'')
     AND ISNULL(TieneMovimientos,'') = ISNULL(ISNULL(@TieneMovimientos,TieneMovimientos),'')
     AND ISNULL(SucursalTrabajo,'') = ISNULL(ISNULL(@SucursalTrabajo,SucursalTrabajo),'')
     AND ISNULL(NivelAcceso,'') = ISNULL(ISNULL(@NivelAcceso,NivelAcceso),'')
     AND ISNULL(MinimoProfesional,'') = ISNULL(ISNULL(@MinimoProfesional,MinimoProfesional),'')
     AND ISNULL(Sindicato,'') = ISNULL(ISNULL(@Sindicato,Sindicato),'')
     AND ISNULL(Vehiculo,'') = ISNULL(ISNULL(@Vehiculo,Vehiculo),'')
     AND ISNULL(TablaCobranza,'') = ISNULL(ISNULL(@TablaCobranza,TablaCobranza),'')
     AND ISNULL(TablaCobranzaBono,'') = ISNULL(ISNULL(@TablaCobranzaBono,TablaCobranzaBono),'')
     AND ISNULL(TablaCobranzaCascada,'') = ISNULL(ISNULL(@TablaCobranzaCascada,TablaCobranzaCascada),'')
     AND ISNULL(TablaCobranzaBonoCascada,'') = ISNULL(ISNULL(@TablaCobranzaBonoCascada,TablaCobranzaBonoCascada),'')
     AND ISNULL(TablaVentaCascada,'') = ISNULL(ISNULL(@TablaVentaCascada,TablaVentaCascada),'')
     AND ISNULL(UEN,'') = ISNULL(ISNULL(@UEN,UEN),'')
     AND ISNULL(Actividad,'') = ISNULL(ISNULL(@Actividad,Actividad),'')
     AND ISNULL(Area,'') = ISNULL(ISNULL(@Area,Area),'')
     AND ISNULL(Fuente,'') = ISNULL(ISNULL(@Fuente,Fuente),'')
     AND ISNULL(Reclutador,'') = ISNULL(ISNULL(@Reclutador,Reclutador),'')
     AND ISNULL(RecomendadoPor,'') = ISNULL(ISNULL(@RecomendadoPor,RecomendadoPor),'')
     AND ISNULL(Cuenta,'') = ISNULL(ISNULL(@Cuenta,Cuenta),'')
     AND ISNULL(CuentaRetencion,'') = ISNULL(ISNULL(@CuentaRetencion,CuentaRetencion),'')
     AND ISNULL(MovNomina,'') = ISNULL(ISNULL(@MovNomina,MovNomina),'')
     AND ISNULL(Contrasena,'') = ISNULL(ISNULL(@Contrasena,Contrasena),'')
     AND ISNULL(Configuracion,'') = ISNULL(ISNULL(@Configuracion,Configuracion),'')
     AND ISNULL(Referencia,'') = ISNULL(ISNULL(@Referencia,Referencia),'')
     AND ISNULL(ReferenciaDireccion,'') = ISNULL(ISNULL(@ReferenciaDireccion,ReferenciaDireccion),'')
     AND ISNULL(ReferenciaTelefono,'') = ISNULL(ISNULL(@ReferenciaTelefono,ReferenciaTelefono),'')
     AND ISNULL(Referencia2,'') = ISNULL(ISNULL(@Referencia2,Referencia2),'')
     AND ISNULL(Referencia2Direccion,'') = ISNULL(ISNULL(@Referencia2Direccion,Referencia2Direccion),'')
     AND ISNULL(Referencia2Telefono,'') = ISNULL(ISNULL(@Referencia2Telefono,Referencia2Telefono),'')
     AND ISNULL(Referencia3,'') = ISNULL(ISNULL(@Referencia3,Referencia3),'')
     AND ISNULL(Referencia3Direccion,'') = ISNULL(ISNULL(@Referencia3Direccion,Referencia3Direccion),'')
     AND ISNULL(Referencia3Telefono,'') = ISNULL(ISNULL(@Referencia3Telefono,Referencia3Telefono),'')
     AND ISNULL(Licencia,'') = ISNULL(ISNULL(@Licencia,Licencia),'')
     AND ISNULL(LicenciaVencimiento,'') = ISNULL(ISNULL(@LicenciaVencimiento,LicenciaVencimiento),'')
     AND ISNULL(Cliente,'') = ISNULL(ISNULL(@Cliente,Cliente),'')
     AND ISNULL(Incremento,'') = ISNULL(ISNULL(@Incremento,Incremento),'')
     AND ISNULL(EsSocio,'') = ISNULL(ISNULL(@EsSocio,EsSocio),'')
     AND ISNULL(IndemnizacionPct,'') = ISNULL(ISNULL(@IndemnizacionPct,IndemnizacionPct),'')
     AND ISNULL(Proyecto,'') = ISNULL(ISNULL(@Proyecto,Proyecto),'')
     AND ISNULL(Plaza,'') = ISNULL(ISNULL(@Plaza,Plaza),'')
     AND ISNULL(Empresa,'') = ISNULL(ISNULL(@Empresa,Empresa),'')
     AND ISNULL(SueldoMensual,'') = ISNULL(ISNULL(@SueldoMensual,SueldoMensual),'')
     AND ISNULL(ISRFijoPeriodo,'') = ISNULL(ISNULL(@ISRFijoPeriodo,ISRFijoPeriodo),'')
     AND ISNULL(RataHora,'') = ISNULL(ISNULL(@RataHora,RataHora),'')
     AND ISNULL(DeclaraRenta,'') = ISNULL(ISNULL(@DeclaraRenta,DeclaraRenta),'')
     AND ISNULL(EsRecurso,'') = ISNULL(ISNULL(@EsRecurso,EsRecurso),'')
     AND ISNULL(EsAgente,'') = ISNULL(ISNULL(@EsAgente,EsAgente),'')
     AND ISNULL(EsUsuarioWeb,'') = ISNULL(ISNULL(@EsUsuarioWeb,EsUsuarioWeb),'')
     AND ISNULL(FechaInicioContrato,'') = ISNULL(ISNULL(@FechaInicioContrato,FechaInicioContrato),'')
     AND ISNULL(DuracionContrato,'') = ISNULL(ISNULL(@DuracionContrato,DuracionContrato),'')
     AND ISNULL(Confidencial,'') = ISNULL(ISNULL(@Confidencial,Confidencial),'')
     AND ISNULL(EntreCalles,'') = ISNULL(ISNULL(@EntreCalles,EntreCalles),'')
     AND ISNULL(Plano,'') = ISNULL(ISNULL(@Plano,Plano),'')
     AND ISNULL(Observaciones,'') = ISNULL(ISNULL(@Observaciones,Observaciones),'')
     AND ISNULL(MapaLatitud,'') = ISNULL(ISNULL(@MapaLatitud,MapaLatitud),'')
     AND ISNULL(MapaLongitud,'') = ISNULL(ISNULL(@MapaLongitud,MapaLongitud),'')
     AND ISNULL(MapaPrecision,'') = ISNULL(ISNULL(@MapaPrecision,MapaPrecision),'')
     AND ISNULL(ActividadMedicion,'') = ISNULL(ISNULL(@ActividadMedicion,ActividadMedicion),'')
     AND ISNULL(SueldoDiarioAsimilable,'') = ISNULL(ISNULL(@SueldoDiarioAsimilable,SueldoDiarioAsimilable),'')
    
     FOR XML AUTO)	

  IF @@ERROR <> 0 SET @Ok = 1
  BEGIN
    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
    IF @@ERROR <> 0 SET @Ok = 1
    
    IF @Ok IS NULL
    BEGIN
      SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'
      IF @@ERROR <> 0 SET @Ok = 1
    END
  END
END
GO
/**************** spIntelisisInterfazInforTransferenciaArt ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaArt') and type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaArt
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaArt
				 @ID		 int,
				 @iSolicitud     int,
				 @Version	 float,
				 @Resultado	 varchar(max) = NULL OUTPUT,
				 @Ok		 int		  = NULL OUTPUT,    
				 @OkRef		 varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  IF @Ok IS NULL
  BEGIN
  
	DECLARE 
	@Articulo			varchar(20),	
	@Datos				varchar(max),
	@Solicitud			varchar(max),
	@ReferenciaIS			varchar(100),
	@SubReferencia			varchar(100),
	@IDNuevo			int,
	@Datos2				varchar(max),
	@Resultado2			varchar(max),
	@Usuario			varchar(10),
	@Contrasena			varchar(32)	,
	@ReferenciaIntelisisService	varchar(50)

	DECLARE
	@Tabla	table (
		CodigoArticulo		        varchar(20),	
		Descripcion			varchar(100),
		ReferenciaIntelisisService	varchar(50),
		TipoArticulo			varchar(50),
		Existencia              	float , 
		StockMinimo			float   ,
		Familia				varchar(50),
		Subfamilia 			varchar(50),
		UltimoPrecioCoste		float ,
		PrecioCosteMedio		float ,
		ProveedorHabooleanual 		varchar(50), 
		PlazoAprovisionam		int ,
		PlazoSeguridad			float ,
		SerieMinimaRentable		float ,
		StockMaximo			float ,
		UnidReservadas			float ,
		UnidOrdenadas			float,
		Codigo2				varchar(50),
		Codigo3				varchar(20) ,
		FechaUltimaCompra		datetime ,
		FechaUltimaEntrada		datetime ,
		FechaUltimaSalida		datetime ,
		FechaCreacion			datetime ,
		PesoNeto			float   , 
		PesoBruto			float   , 
		UnidMedidaCompra		varchar(50),
		UnidMedidaVenta			varchar(50),
		UnidMedidaAlmacen		varchar(50), 
		MultiploFabricacion		float   ,
		TipoEnvase			varchar(30), 
		CantidadEnvase			float   , 
		NumPlano			varchar(20) ,
		CodigoMoldeMatriz	    	varchar(20) ,
		EstadoArticulo			varchar(15),
		UnidConverCompra		float   ,
		AlmacenDefecto 			varchar(10),
		CodigoUltimoProv 		varchar	(10),
		Inventariable			bit  ,
		UbicacionDefecto        	varchar(8),
		FechaDeAlta			datetime ,
		FechaUltimaModificacion	        datetime   ,
		UsuarioAlta			varchar(10),
		UsuarioModificacion		datetime ,
		Version				int ,
		GuardaVersion           	varchar(1),
		Descripcion2			varchar(255), 	
		SumatorioComponentes		float ,
		UnidConverVenta			varchar(50),
		PrecioCosteStandard		float ,
		PrecioCompra			float ,
		PrecioCompraDivisa		varchar(10),
		CodigoMoneda			varchar(10),	
		PorcIVA				float   , 	
		PorcRecargo			float ,
		ABC				varchar(1),	
		CriterioAsignacionLote  	varchar(4) ,
		NumeroSerie			varchar(20) ,
		DiasCuarentena			int,
		RevisionPlano			varchar(10),
		FechaUltimaRevisionPlano	datetime   , 
		UnidMedidasEnvase		varchar(50),
		MedidaEnvaseLargo		float ,
		MedidaEnvaseAncho		float ,
		MedidaEnvaseAlto		float ,
		UnidVolumenEnvase		varchar(50) ,
		MedidaEnvaseVolumen		float ,
		ClientePrincipal		varchar(10) ,
		ClienteExclusivo		varchar(10) ,
		PrecioHIFO			money   , 
		FechaPrecioHIFO			datetime ,
		MultiploConsumo			float   ,
		ValorNumeroSerie		varchar(20)   , 
		CosteStandarMOE			float ,
		PrecioVenta			money   ,
 		IDDocumAdjuntos			int ,
 		MesesGarantia			int,
		SistemaDistribucionObjetivos	varchar(10) ,
		PorcComision			float ,
		CodNomenclaturaCombinada	varchar(25) ,
		RegimenEstadisticoHabooleanual	varchar(1),
		NaturalezaTransaccionA  	varchar(1) ,
		NaturalezaTransaccionB  	varchar(1) ,
		CodUnidadSuplem         	varchar(50),
		FactorConversionSuplem		varchar(50), 
		ClaseArticulo			varchar(20),
 		Plantilla			int ,
		GeneradorPlantilla		varchar(20) ,
		CodigoEstructura		varchar(20) ,
		TipoImpuesto			float   , 
		TipoArticuloVariantes		int ,
 		MesesCaducidad			decimal (6,2),
		Generico			int ,
		FijarCosteStandard		bit ,
		ProveedorHabooleanualObjeto	varchar(10),
		AlmacenDefectoObjeto		varchar(10),
		UbicacionDefectoObjeto		varchar(10),
		TipoDeAsignacion		varchar(20),    
		TiempoEntrega           	int	,
		Trazabilidad			bit,
		LotificacionPropia      	bit,
		UltimoNoLote            	int,
		UnidadesMaxLote         	int,
		TieneNumerodeSerie      	bit, 
		CantidadMinimaVenta     	float,
		INFORAlmacenProd		varchar(20),
		Tipo             		varchar(20),
		Situacion             		varchar(50)
		
	)
		
    SELECT @Articulo = Articulo FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Art')
      WITH (Articulo varchar(255))
  
    SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
      FROM IntelisisService 
     WHERE ID = @ID

    SELECT @Contrasena = Contrasena 
      FROM Usuario
     WHERE Usuario = @Usuario

    SET @Resultado	= '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'
    SET @Datos		= '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Articulo.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Articulo" Valor="'+@Articulo+'"/></Solicitud></Intelisis>'

    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

    SELECT @Solicitud = Resultado 
      FROM IntelisisService
     WHERE ID = @IDNuevo
   
    EXEC	sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
    INSERT @Tabla (CodigoArticulo, ReferenciaIntelisisService, Descripcion,  TipoArticulo,                                                                                                                             Existencia, StockMinimo,                                    Familia,				Subfamilia,     PrecioCosteMedio,							ProveedorHabooleanual,  PlazoAprovisionam,			PlazoSeguridad,					CantidadMinimaVenta ,             StockMaximo,					 Codigo2,       PesoNeto,   PesoBruto,  UnidMedidaCompra,								UnidMedidaVenta,								 UnidMedidaAlmacen,						 MultiploFabricacion,			TipoEnvase,  CantidadEnvase,            EstadoArticulo, UnidConverCompra,			AlmacenDefecto,			CodigoUltimoProv, FechaUltimaModificacion, UsuarioAlta, Descripcion2,  UnidConverVenta,				PrecioCosteStandard,                      PrecioCompra,                             PrecioCompraDivisa,							CodigoMoneda, PorcIVA,   ABC, RevisionPlano,            FechaUltimaRevisionPlano, UnidMedidasEnvase,	PrecioHIFO,					MultiploConsumo,   ValorNumeroSerie, CosteStandarMOE,							PrecioVenta, CodUnidadSuplem,  FactorConversionSuplem, ClaseArticulo,       TipoImpuesto,								ProveedorHabooleanualObjeto, AlmacenDefectoObjeto,	UltimoPrecioCoste,			UnidReservadas,     UnidOrdenadas,     Codigo3,        FechaUltimaCompra,	     FechaUltimaEntrada,        FechaUltimaSalida,        FechaCreacion,	         NumPlano,        CodigoMoldeMatriz,        Inventariable ,    UbicacionDefecto,        FechaDeAlta,	         UsuarioModificacion,        Version,     GuardaVersion ,        SumatorioComponentes,	   PorcRecargo,	      CriterioAsignacionLote,		 NumeroSerie,	DiasCuarentena,				MedidaEnvaseLargo,	        MedidaEnvaseAncho,	        MedidaEnvaseAlto,	     UnidVolumenEnvase,	        MedidaEnvaseVolumen,	    ClientePrincipal,	      ClienteExclusivo,	        FechaPrecioHIFO, 	         IDDocumAdjuntos,	 	     MesesGarantia,	    SistemaDistribucionObjetivos,	     PorcComision,	    CodNomenclaturaCombinada,	     RegimenEstadisticoHabooleanual,	    NaturalezaTransaccionA,	        NaturalezaTransaccionB , 	    Plantilla,	        GeneradorPlantilla,	        CodigoEstructura,	     MesesCaducidad,									Generico,     FijarCosteStandard,	    UbicacionDefectoObjeto,			TiempoEntrega,																																						Trazabilidad,		LotificacionPropia  ,    UltimoNoLote,                    UnidadesMaxLote,                   TieneNumerodeSerie, SerieMinimaRentable,	TipoDeAsignacion,		INFORAlmacenProd, Tipo, Situacion)
    SELECT	   Articulo,		ReferenciaIntelisisService,	Descripcion1, CASE INFORTipo WHEN 'PRODUCTO ACABADO' THEN 1 WHEN 'SEMIELABORADO' THEN 2 WHEN 'TRABAJO EXTERIOR' THEN 3 WHEN 'MATERIA PRIMA' THEN 4 END, '0',        INFORStockMinimo=ISNULL(INFORStockMinimo,0),	SUBSTRING(Familia,1,4), Linea,			CONVERT(float,ISNULL(CostoPromedio,0.00)),  ISNULL(Proveedor,''),	ISNULL(TiempoEntrega,0),	ISNULL(TiempoEntregaSeg,0.00),	ISNULL(CantidadMinimaVenta,0.00), ISNULL(INFORStockMaximo,0.00), CodigoAlterno, Peso,		Peso, UnidadCompra, UnidadTraspaso, Unidad, ISNULL(MultiplosOrdenar,0.00), LoteOrdenar, ISNULL(CantidadOrdenar,0), Estatus,        ISNULL(FactorCompra,''),	ISNULL(AlmacenROP,''),  Proveedor,        UltimoCambio,            Usuario,     Descripcion2,  ISNULL(UnidadTraspaso,''),   CONVERT(float,ISNULL(CostoEstandar,0.0)), CONVERT(float,ISNULL(CostoEstandar,0.0)), CONVERT(float,ISNULL(CostoEstandar,0.0)),   MonedaCosto,  Impuesto1, ABC, RevisionFrecuenciaUnidad, RevisionUltima,           ISNULL(UnidadCompra,''),	ISNULL(PrecioLista,0.00),	MultiplosOrdenar,  Consecutivo,		 CONVERT(float,ISNULL(CostoEstandar,0.0)),  PrecioLista, CodigoAlterno,    Factor,                 SUBSTRING(Tipo,1,4), SUBSTRING(CONVERT(varchar,Impuesto1),1,3),	Proveedor,                   ISNULL(AlmacenROP,''),	ISNULL(UltimoCosto,0.0),	UnidReservadas = 0, UnidOrdenadas = 0, Codigo3 = NULL, FechaUltimaCompra = NULL, FechaUltimaEntrada = NULL, FechaUltimaSalida = NULL, FechaCreacion = GETDATE(), NumPlano = NULL, CodigoMoldeMatriz = NULL, Inventariable = 1 ,UbicacionDefecto = NULL, FechaDeAlta = GETDATE(), UsuarioModificacion = Null, Version = 0, GuardaVersion = NULL , SumatorioComponentes = 0, PorcRecargo = 0.0, CriterioAsignacionLote = NULL, INFORNoSerie,	isnull(INFORCuarentena,''),	MedidaEnvaseLargo = NULL,	MedidaEnvaseAncho = NULL,	MedidaEnvaseAlto = NULL, UnidVolumenEnvase = NULL,	MedidaEnvaseVolumen	= NULL,	ClientePrincipal = NULL,  ClienteExclusivo = NULL,	FechaPrecioHIFO	= GETDATE(), IDDocumAdjuntos	= NULL,  MesesGarantia = 0,	SistemaDistribucionObjetivos = NULL, PorcComision = 0,	CodNomenclaturaCombinada = NULL, RegimenEstadisticoHabooleanual = NULL,	NaturalezaTransaccionA = NULL,	NaturalezaTransaccionB = NULL, 	Plantilla = NULL,	GeneradorPlantilla = NULL,	CodigoEstructura = NULL, CEILING(CONVERT(float,CaducidadMinima) / 30.0) ,	Generico = 0, FijarCosteStandard = 1,	UbicacionDefectoObjeto = NULL,	isnull(TiempoEntrega * CASE WHEN TiempoEntregaUnidad ='Dias' Then 1 WHEN TiempoEntregaUnidad ='Semanas' Then 7 WHEN TiempoEntregaUnidad ='Meses' Then 30 END, 0),	INFORTrazabilidad,	INFORLotificacionPropia, ISNULL(INFORUltimoNumeroLote,0), ISNULL(INFORUnidadesMaximaLote,0), INFORTieneNoSerie,  ISNULL(INFORSMR,0.0),	INFORTipoDeAsignacion,	isnull(INFORAlmacenProd,''), ISNULL(Tipo,''), ISNULL(Situacion,'')
      FROM	OPENXML (@iSolicitud, '/Intelisis/Resultado/Art',1)  
      WITH	(Articulo varchar(100),ReferenciaIntelisisService varchar(100), Descripcion1 varchar(100), INFORTipo varchar(100), INFORStockMinimo varchar(100), Familia varchar(100), Linea varchar(100), CostoEstandar varchar(100), GarantiaPlazo varchar(100), TiempoEntregaSeg varchar(100), CantidadMinimaVenta    float, INFORStockMaximo varchar(100), CodigoAlterno varchar(100), Peso varchar(100), UnidadCompra varchar(100), UnidadTraspaso varchar(100), Unidad varchar(100), MultiplosOrdenar varchar(100), LoteOrdenar varchar(100), CantidadOrdenar varchar(100), Estatus varchar(100), FactorCompra varchar(100), AlmacenROP varchar(100), Proveedor varchar(100), UltimoCambio varchar(100), Alta varchar(100), Usuario varchar(100),Descripcion2 varchar(100), MonedaCosto varchar(100), Impuesto1 varchar(100), ABC varchar(100), RevisionFrecuenciaUnidad varchar(100), RevisionUltima varchar(100), LotesAuto varchar(100), Consecutivo varchar(100), PrecioLista varchar(100), Factor varchar(100), Tipo varchar(100),CostoPromedio varchar(100),UltimoCosto varchar(100) ,TiempoEntrega varchar(100) ,TiempoEntregaUnidad varchar(100),CaducidadMinima varchar(100),INFORCuarentena varchar(100),INFORTrazabilidad varchar(100), INFORLotificacionPropia varchar(100), INFORUltimoNumeroLote varchar(100), INFORUnidadesMaximaLote varchar(100), INFORTieneNoSerie varchar(100), INFORSMR varchar(100),INFORTipoDeAsignacion varchar(100),INFORNoSerie varchar(100),INFORAlmacenProd varchar(20),  Situacion varchar(50))
    EXEC	sp_xml_removedocument @iSolicitud		
     
    SELECT	@ReferenciaIntelisisService = ReferenciaIntelisisService 
      FROM	@Tabla
     
    SET		@Resultado2 = CONVERT(varchar(max), (SELECT * FROM @Tabla oArticulo FOR XML AUTO))
    SET		@Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Articulo.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + ISNULL(@Resultado2,'') + '</Solicitud></Intelisis>'  
     
    EXEC	spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
    IF @@ERROR <> 0 SET @Ok = 1
    IF @Ok IS NULL AND @@ERROR <> 0 
    SET @Ok = 1

  END 

END
GO
/**************** spIntelisisCuentaArticuloListado ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaArticuloListado') and type = 'P') drop procedure dbo.spIntelisisCuentaArticuloListado
GO  
CREATE PROCEDURE spIntelisisCuentaArticuloListado  
 @ID            int,  
 @iSolicitud	int,  
 @Version		float,  
 @Resultado		varchar(max) = NULL OUTPUT,  
 @Ok			int = NULL OUTPUT,     
 @OkRef			varchar(255) = NULL OUTPUT  
--//WITH ENCRYPTION  
AS BEGIN  
  -- SET nocount ON  
  DECLARE 
 @Articulo varchar (20),
 @Rama varchar (20),
 @Descripcion1 varchar (100),
 @Descripcion2 varchar (255),
 @NombreCorto varchar (20),
 @Grupo varchar (50),
 @Categoria varchar (50),
 @CategoriaActivoFijo varchar (50),
 @Familia varchar (50),
 @Linea varchar (50),
 @Fabricante varchar (50),
 @ClaveFabricante varchar (50),
 @Impuesto1 float,
 @Impuesto2 float,
 @Impuesto3 float,
 @Factor varchar (50),
 @Unidad varchar (50),
 @UnidadCompra varchar (50),
 @UnidadTraspaso varchar (50),
 @UnidadCantidad float,
 @TipoCosteo varchar (10),
 @Peso float,
 @Tara float,
 @Volumen float,
 @Tipo varchar (20),
 @TipoOpcion varchar (20),
 @Accesorios bit,
 @Refacciones bit,
 @Sustitutos bit,
 @Servicios bit,
 @Consumibles bit,
 @MonedaCosto varchar (10),
 @MonedaPrecio varchar (10),
 @MargenMinimo money,
 @PrecioLista money,
 @PrecioMinimo money,
 @FactorAlterno float,
 @PrecioAnterior money,
 @Utilidad varchar (50),
 @DescuentoCompra float,
 @Clase varchar (15),
 @Estatus varchar (15),
 @UltimoCambio datetime,
 @Alta datetime,
 @Conciliar bit,
 @Mensaje varchar (50),
 @Comision varchar (50),
 @Arancel varchar (50),
 @ArancelDesperdicio varchar (50),
 @ABC varchar (1),
 @Usuario varchar (10),
 @Precio2 money,
 @Precio4 money,
 @Precio5 money,
 @Precio6 money,
 @Precio7 money,
 @Precio8 money,
 @Precio9 money,
 @Precio10 money,
 @Refrigeracion bit,
 @TieneCaducidad bit,
 @BasculaPesar bit,
 @SeProduce bit,
 @Situacion varchar (50),
 @SituacionFecha datetime,
 @SituacionUsuario varchar (10),
 @SituacionNota varchar (100),
 @EstatusPrecio varchar (15),
 @wMostrar bit,
 @Merma float,
 @Desperdicio float,
 @SeCompra bit,
 @SeVende bit,
 @EsFormula bit,
 @TiempoEntrega int,
 @TiempoEntregaUnidad varchar (10),
 @TiempoEntregaSeg int,
 @TiempoEntregaSegUnidad varchar (10),
 @LoteOrdenar varchar (30),
 @CantidadOrdenar float,
 @MultiplosOrdenar float,
 @InvSeguridad float,
 @ProdRuta varchar (20),
 @AlmacenROP varchar (10),
 @CategoriaProd varchar (50),
 @ProdCantidad float,
 @ProdUsuario varchar (10),
 @ProdPasoTotal int,
 @ProdMovGrupo varchar (50),
 @ProdEstacion varchar (10),
 @ProdOpciones bit,
 @ProdVerConcentracion bit,
 @ProdVerCostoAcumulado bit,
 @ProdVerMerma bit,
 @ProdVerDesperdicio bit,
 @ProdVerPorcentaje bit,
 @RevisionUltima datetime,
 @RevisionUsuario varchar (10),
 @RevisionFrecuencia int,
 @RevisionFrecuenciaUnidad varchar (10),
 @RevisionSiguiente datetime,
 @ProdMov varchar (20),
 @TipoCompra varchar (20),
 @TieneMovimientos bit,
 @Registro1 varchar (20),
 @Registro1Vencimiento datetime,
 @AlmacenEspecificoVenta varchar (10),
 @AlmacenEspecificoVentaMov varchar (20),
 @RutaDistribucion varchar (50),
 @CostoEstandar float,
 @CostoReposicion float,
 @EstatusCosto varchar (15),
 @Margen money,
 @Proveedor varchar (10),
 @NivelAcceso varchar (50),
 @Temporada varchar (50),
 @SolicitarPrecios bit,
 @AutoRecaudacion varchar (30),
 @Concepto varchar (50),
 @Cuenta varchar (20),
 @Retencion1 float,
 @Retencion2 float,
 @Retencion3 float,
 @Espacios bit,
 @EspaciosEspecificos bit,
 @EspaciosSobreventa float,
 @EspaciosNivel varchar (50),
 @EspaciosMinutos int,
 @EspaciosBloquearAnteriores bit,
 @EspaciosHoraD varchar (5),
 @EspaciosHoraA varchar (5),
 @SerieLoteInfo bit,
 @CantidadMinimaVenta float,
 @CantidadMaximaVenta float,
 @EstimuloFiscal float,
 @OrigenPais varchar (50),
 @OrigenLocalidad varchar (50),
 @Incentivo money,
 @FactorCompra float,
 @Horas float,
 @ISAN bit,
 @ExcluirDescFormaPago bit,
 @EsDeducible bit,
 @Peaje money,
 @CodigoAlterno varchar (50),
 @TipoCatalogo varchar (20),
 @AnexosAlFacturar bit,
 @CaducidadMinima int,
 @Actividades bit,
 @ValidarPresupuestoCompra varchar (20),
 @SeriesLotesAutoOrden varchar (20),
 @LotesFijos bit,
 @LotesAuto bit,
 @Consecutivo int,
 @TipoEmpaque varchar (50),
 @Modelo varchar (4),
 @ArtVersion varchar (50),
 @TieneDireccion bit,
 @Direccion varchar (100),
 @DireccionNumero varchar (20),
 @DireccionNumeroInt varchar (20),
 @EntreCalles varchar (100),
 @Plano varchar (15),
 @Observaciones varchar (100),
 @Colonia varchar (100),
 @Delegacion varchar (100),
 @Poblacion varchar (100),
 @Estado varchar (30),
 @Pais varchar (30),
 @CodigoPostal varchar (15),
 @Ruta varchar (50),
 @Codigo varchar (50),
 @ClaveVehicular varchar (20),
 @TipoVehiculo varchar (20),
 @DiasLibresIntereses int,
 @PrecioLiberado bit,
 @ValidarCodigo bit,
 @Presentacion varchar (50),
 @GarantiaPlazo int,
 @CostoIdentificado bit,
 @CantidadTarima float,
 @UnidadTarima varchar (50),
 @MinimoTarima float,
 @DepartamentoDetallista int,
 @TratadoComercial varchar (50),
 @CuentaPresupuesto varchar (20),
 @ProgramaSectorial varchar (50),
 @PedimentoClave varchar (5),
 @PedimentoRegimen varchar (5),
 @Permiso varchar (20),
 @PermisoRenglon varchar (20),
 @Cuenta2 varchar (20),
 @Cuenta3 varchar (20),
 @Impuesto1Excento bit,
 @CalcularPresupuesto bit,
 @InflacionPresupuesto float,
 @Excento2 bit,
 @Excento3 bit,
 @ContUso varchar (20),
 @ContUso2 varchar (20),
 @ContUso3 varchar (20),
 @NivelToleranciaCosto varchar (10),
 @ToleranciaCosto money,
 @ToleranciaCostoInferior money,
 @ObjetoGasto varchar (10),
 @ObjetoGastoRef varchar (10),
 @ClavePresupuestalImpuesto1 varchar (50),
 @Estructura varchar (50),
 @TipoImpuesto1 varchar (10),
 @TipoImpuesto2 varchar (10),
 @TipoImpuesto3 varchar (10),
 @TipoRetencion1 varchar (10),
 @TipoRetencion2 varchar (10),
 @TipoRetencion3 varchar (10),
 @TipoImpuesto4 varchar (10),
 @Calificacion smallint,
 @Texto xml,
 @ReferenciaIS varchar(100),
 @SubReferencia varchar(100),
 @UltimoCosto float,
 @CostoPromedio float,
 @Empresa varchar(20),
 @ID0 int,
 @Sucursal int,
 @Precio3 money
  BEGIN TRANSACTION  
  IF @Ok IS NULL  
  BEGIN  
    SELECT @ID0 = dbo.fnAccesoID(@@SPID)  
  
    SELECT @Empresa = Empresa, @Sucursal = Sucursal FROM Acceso WHERE ID = @ID0  
  
  
  
    SELECT @Articulo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Articulo'  
    SELECT @Rama = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Rama'  
    SELECT @Descripcion1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Descripcion1'  
    SELECT @Descripcion2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Descripcion2'  
    SELECT @NombreCorto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'NombreCorto'  
    SELECT @Grupo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Grupo'  
    SELECT @Categoria = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Categoria'  
    SELECT @CategoriaActivoFijo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CategoriaActivoFijo'  
    SELECT @Familia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Familia'  
    SELECT @Linea = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Linea'  
    SELECT @Fabricante = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Fabricante'  
    SELECT @ClaveFabricante = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ClaveFabricante'  
    SELECT @Impuesto1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Impuesto1'  
    SELECT @Impuesto2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Impuesto2'  
    SELECT @Impuesto3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Impuesto3'  
    SELECT @Factor = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Factor'  
    SELECT @Unidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Unidad'  
    SELECT @UnidadCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'UnidadCompra'  
    SELECT @UnidadTraspaso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'UnidadTraspaso'  
    SELECT @UnidadCantidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'UnidadCantidad'  
    SELECT @TipoCosteo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TipoCosteo'  
    SELECT @Peso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Peso'  
    SELECT @Tara = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Tara'  
    SELECT @Volumen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Volumen'  
    SELECT @Tipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Tipo'  
    SELECT @TipoOpcion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TipoOpcion'  
    SELECT @Accesorios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Accesorios'  
    SELECT @Refacciones = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Refacciones'  
    SELECT @Sustitutos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Sustitutos'  
    SELECT @Servicios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Servicios'  
    SELECT @Consumibles = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Consumibles'  
    SELECT @MonedaCosto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'MonedaCosto'  
    SELECT @MonedaPrecio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'MonedaPrecio'  
    SELECT @MargenMinimo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'MargenMinimo'  
    SELECT @PrecioLista = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'PrecioLista'  
    SELECT @PrecioMinimo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'PrecioMinimo'  
    SELECT @FactorAlterno = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'FactorAlterno'  
    SELECT @PrecioAnterior = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'PrecioAnterior'  
    SELECT @Utilidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Utilidad'  
    SELECT @DescuentoCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'DescuentoCompra'  
    SELECT @Clase = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Clase'  
    SELECT @Estatus = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Estatus'  
    SELECT @UltimoCambio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'UltimoCambio'  
    SELECT @Alta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Alta'  
    SELECT @Conciliar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Conciliar'  
    SELECT @Mensaje = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Mensaje'  
    SELECT @Comision = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Comision'  
    SELECT @Arancel = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Arancel'  
    SELECT @ArancelDesperdicio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ArancelDesperdicio'  
    SELECT @ABC = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ABC'  
    SELECT @Usuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Usuario'  
    SELECT @Precio2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Precio2'  
    SELECT @Precio3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Precio3'  
    SELECT @Precio4 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Precio4'  
    SELECT @Precio5 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Precio5'  
    SELECT @Precio6 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Precio6'  
    SELECT @Precio7 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Precio7'  
    SELECT @Precio8 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Precio8'  
    SELECT @Precio9 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Precio9'  
    SELECT @Precio10 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Precio10'  
    SELECT @Refrigeracion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Refrigeracion'  
    SELECT @TieneCaducidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TieneCaducidad'  
    SELECT @BasculaPesar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'BasculaPesar'  
    SELECT @SeProduce = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'SeProduce'  
    SELECT @Situacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Situacion'  
    SELECT @SituacionFecha = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'SituacionFecha'  
    SELECT @SituacionUsuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'SituacionUsuario'  
    SELECT @SituacionNota = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'SituacionNota'  
    SELECT @EstatusPrecio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'EstatusPrecio'  
    SELECT @wMostrar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'wMostrar'  
    SELECT @Merma = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Merma'  
    SELECT @Desperdicio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Desperdicio'  
    SELECT @SeCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'SeCompra'  
    SELECT @SeVende = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'SeVende'  
    SELECT @EsFormula = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'EsFormula'  
    SELECT @TiempoEntrega = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TiempoEntrega'  
    SELECT @TiempoEntregaUnidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TiempoEntregaUnidad'  
    SELECT @TiempoEntregaSeg = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TiempoEntregaSeg'  
    SELECT @TiempoEntregaSegUnidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TiempoEntregaSegUnidad'  
    SELECT @LoteOrdenar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'LoteOrdenar'  
    SELECT @CantidadOrdenar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CantidadOrdenar'  
    SELECT @MultiplosOrdenar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'MultiplosOrdenar'  
    SELECT @InvSeguridad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'InvSeguridad'  
    SELECT @ProdRuta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProdRuta'  
    SELECT @AlmacenROP = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'AlmacenROP'  
    SELECT @CategoriaProd = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CategoriaProd'  
    SELECT @ProdCantidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProdCantidad'  
    SELECT @ProdUsuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProdUsuario'  
    SELECT @ProdPasoTotal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProdPasoTotal'  
    SELECT @ProdMovGrupo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProdMovGrupo'  
    SELECT @ProdEstacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProdEstacion'  
    SELECT @ProdOpciones = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProdOpciones'  
    SELECT @ProdVerConcentracion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProdVerConcentracion'  
    SELECT @ProdVerCostoAcumulado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProdVerCostoAcumulado'  
    SELECT @ProdVerMerma = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProdVerMerma'  
    SELECT @ProdVerDesperdicio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProdVerDesperdicio'  
    SELECT @ProdVerPorcentaje = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProdVerPorcentaje'  
    SELECT @RevisionUltima = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'RevisionUltima'  
    SELECT @RevisionUsuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'RevisionUsuario'  
    SELECT @RevisionFrecuencia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'RevisionFrecuencia'  
    SELECT @RevisionFrecuenciaUnidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'RevisionFrecuenciaUnidad'  
    SELECT @RevisionSiguiente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'RevisionSiguiente'  
    SELECT @ProdMov = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProdMov'  
    SELECT @TipoCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TipoCompra'  
    SELECT @TieneMovimientos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TieneMovimientos'  
    SELECT @Registro1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Registro1'  
    SELECT @Registro1Vencimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Registro1Vencimiento'  
    SELECT @AlmacenEspecificoVenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'AlmacenEspecificoVenta'  
    SELECT @AlmacenEspecificoVentaMov = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'AlmacenEspecificoVentaMov'  
    SELECT @RutaDistribucion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'RutaDistribucion'  
    SELECT @CostoEstandar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CostoEstandar'  
    SELECT @CostoReposicion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CostoReposicion'  
    SELECT @EstatusCosto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'EstatusCosto'  
    SELECT @Margen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Margen'  
    SELECT @Proveedor = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Proveedor'  
    SELECT @NivelAcceso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'NivelAcceso'  
    SELECT @Temporada = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Temporada'  
    SELECT @SolicitarPrecios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'SolicitarPrecios'  
  SELECT @AutoRecaudacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'AutoRecaudacion'  
    SELECT @Concepto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Concepto'  
    SELECT @Cuenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Cuenta'  
    SELECT @Retencion1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Retencion1'  
    SELECT @Retencion2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Retencion2'  
    SELECT @Retencion3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Retencion3'  
    SELECT @Espacios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Espacios'  
    SELECT @EspaciosEspecificos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'EspaciosEspecificos'  
    SELECT @EspaciosSobreventa = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'EspaciosSobreventa'  
    SELECT @EspaciosNivel = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'EspaciosNivel'  
    SELECT @EspaciosMinutos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'EspaciosMinutos'  
    SELECT @EspaciosBloquearAnteriores = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'EspaciosBloquearAnteriores'  
   SELECT @EspaciosHoraD = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'EspaciosHoraD'  
    SELECT @EspaciosHoraA = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'EspaciosHoraA'  
    SELECT @SerieLoteInfo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'SerieLoteInfo'  
    SELECT @CantidadMinimaVenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CantidadMinimaVenta'  
    SELECT @CantidadMaximaVenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CantidadMaximaVenta'  
    SELECT @EstimuloFiscal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'EstimuloFiscal'  
    SELECT @OrigenPais = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'OrigenPais'  
    SELECT @OrigenLocalidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'OrigenLocalidad'  
    SELECT @Incentivo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Incentivo'  
    SELECT @FactorCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'FactorCompra'  
    SELECT @Horas = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Horas'  
    SELECT @ISAN = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ISAN'  
    SELECT @ExcluirDescFormaPago = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ExcluirDescFormaPago'  
    SELECT @EsDeducible = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'EsDeducible'  
    SELECT @Peaje = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Peaje'  
    SELECT @CodigoAlterno = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CodigoAlterno'  
    SELECT @TipoCatalogo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TipoCatalogo'  
    SELECT @AnexosAlFacturar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'AnexosAlFacturar'  
    SELECT @CaducidadMinima = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CaducidadMinima'  
    SELECT @Actividades = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Actividades'  
    SELECT @ValidarPresupuestoCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ValidarPresupuestoCompra'  
    SELECT @SeriesLotesAutoOrden = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'SeriesLotesAutoOrden'  
    SELECT @LotesFijos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'LotesFijos'  
    SELECT @LotesAuto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'LotesAuto'  
    SELECT @Consecutivo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Consecutivo'  
    SELECT @TipoEmpaque = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TipoEmpaque'  
    SELECT @Modelo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Modelo'  
    SELECT @ArtVersion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Version'  
    SELECT @TieneDireccion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TieneDireccion'  
    SELECT @Direccion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Direccion'  
    SELECT @DireccionNumero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'DireccionNumero'  
    SELECT @DireccionNumeroInt = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'DireccionNumeroInt'  
    SELECT @EntreCalles = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'EntreCalles'  
    SELECT @Plano = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Plano'  
    SELECT @Observaciones = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Observaciones'  
    SELECT @Colonia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Colonia'  
    SELECT @Delegacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Delegacion'  
    SELECT @Poblacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Poblacion'  
    SELECT @Estado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Estado'  
    SELECT @Pais = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Pais'  
    SELECT @CodigoPostal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CodigoPostal'  
    SELECT @Ruta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Ruta'  
    SELECT @Codigo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Codigo'  
    SELECT @ClaveVehicular = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ClaveVehicular'  
    SELECT @TipoVehiculo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TipoVehiculo'  
    SELECT @DiasLibresIntereses = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'DiasLibresIntereses'  
    SELECT @PrecioLiberado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'PrecioLiberado'  
    SELECT @ValidarCodigo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ValidarCodigo'  
    SELECT @Presentacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Presentacion'  
    SELECT @GarantiaPlazo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'GarantiaPlazo'  
    SELECT @CostoIdentificado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CostoIdentificado'  
    SELECT @CantidadTarima = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CantidadTarima'  
    SELECT @UnidadTarima = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'UnidadTarima'  
    SELECT @MinimoTarima = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'MinimoTarima'  
    SELECT @DepartamentoDetallista = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'DepartamentoDetallista'  
    SELECT @TratadoComercial = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TratadoComercial'  
    SELECT @CuentaPresupuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CuentaPresupuesto'  
    SELECT @ProgramaSectorial = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ProgramaSectorial'  
    SELECT @PedimentoClave = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'PedimentoClave'  
    SELECT @PedimentoRegimen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'PedimentoRegimen'  
    SELECT @Permiso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Permiso'  
    SELECT @PermisoRenglon = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'PermisoRenglon'  
    SELECT @Cuenta2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Cuenta2'  
    SELECT @Cuenta3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Cuenta3'  
    SELECT @Impuesto1Excento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Impuesto1Excento'  
    SELECT @CalcularPresupuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'CalcularPresupuesto'  
    SELECT @InflacionPresupuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'InflacionPresupuesto'  
    SELECT @Excento2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Excento2'  
    SELECT @Excento3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Excento3'  
    SELECT @ContUso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ContUso'  
    SELECT @ContUso2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ContUso2'  
    SELECT @ContUso3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ContUso3'  
    SELECT @NivelToleranciaCosto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'NivelToleranciaCosto'  
    SELECT @ToleranciaCosto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ToleranciaCosto'  
    SELECT @ToleranciaCostoInferior = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ToleranciaCostoInferior'  
    SELECT @ObjetoGasto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ObjetoGasto'  
    SELECT @ObjetoGastoRef = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ObjetoGastoRef'  
    SELECT @ClavePresupuestalImpuesto1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'ClavePresupuestalImpuesto1'  
    SELECT @Estructura = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Estructura'  
    SELECT @TipoImpuesto1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TipoImpuesto1'  
    SELECT @TipoImpuesto2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TipoImpuesto2'  
    SELECT @TipoImpuesto3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TipoImpuesto3'  
    SELECT @TipoRetencion1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TipoRetencion1'  
    SELECT @TipoRetencion2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TipoRetencion2'  
    SELECT @TipoRetencion3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TipoRetencion3'  
    SELECT @TipoImpuesto4 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'TipoImpuesto4'  
    SELECT @Calificacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')  
      WITH (Campo varchar(255), Valor varchar(255))  
     WHERE Campo = 'Calificacion'  
  
    IF NOT EXISTS(SELECT * FROM ArtIntelisisService WHERE Empresa=@Empresa AND Sucursal=@Sucursal AND Articulo =@Articulo)select @Empresa=null,@sucursal=null  
    SELECT @Texto =(SELECT * FROM ArtIntelisisService Art   
      WHERE ISNULL(Empresa,'') = ISNULL(ISNULL(@Empresa,Empresa),'')  
		AND ISNULL(Sucursal,'')= ISNULL(ISNULL(@Sucursal,Sucursal),'')  
		AND ISNULL(Articulo,'' ) = ISNULL(ISNULL(@Articulo,Articulo),'')  
		AND ISNULL(Rama,'' ) = ISNULL(ISNULL(@Rama,Rama),'')  
		AND ISNULL(Descripcion1,'' ) = ISNULL(ISNULL(@Descripcion1,Descripcion1),'')  
		AND ISNULL(Descripcion2,'' ) = ISNULL(ISNULL(@Descripcion2,Descripcion2),'')  
		AND ISNULL(NombreCorto,'' ) = ISNULL(ISNULL(@NombreCorto,NombreCorto),'')  
		AND ISNULL(Grupo,'' ) = ISNULL(ISNULL(@Grupo,Grupo),'')  
		AND ISNULL(Categoria,'' ) = ISNULL(ISNULL(@Categoria,Categoria),'')  
		AND ISNULL(CategoriaActivoFijo,'' ) = ISNULL(ISNULL(@CategoriaActivoFijo,CategoriaActivoFijo),'')  
		AND ISNULL(Familia,'' ) = ISNULL(ISNULL(@Familia,Familia),'')  
		AND ISNULL(Linea,'' ) = ISNULL(ISNULL(@Linea,Linea),'')  
		AND ISNULL(Fabricante,'' ) = ISNULL(ISNULL(@Fabricante,Fabricante),'')  
		AND ISNULL(ClaveFabricante,'' ) = ISNULL(ISNULL(@ClaveFabricante,ClaveFabricante),'')  
		AND ISNULL(Impuesto1,'' ) = ISNULL(ISNULL(@Impuesto1,Impuesto1),'')  
		AND ISNULL(Impuesto2,'' ) = ISNULL(ISNULL(@Impuesto2,Impuesto2),'')  
		AND ISNULL(Impuesto3,'' ) = ISNULL(ISNULL(@Impuesto3,Impuesto3),'')  
		AND ISNULL(Factor,'' ) = ISNULL(ISNULL(@Factor,Factor),'')  
		AND ISNULL(Unidad,'' ) = ISNULL(ISNULL(@Unidad,Unidad),'')  
		AND ISNULL(UnidadCompra,'' ) = ISNULL(ISNULL(@UnidadCompra,UnidadCompra),'')  
		AND ISNULL(UnidadTraspaso,'' ) = ISNULL(ISNULL(@UnidadTraspaso,UnidadTraspaso),'')  
		AND ISNULL(UnidadCantidad,'' ) = ISNULL(ISNULL(@UnidadCantidad,UnidadCantidad),'')  
		AND ISNULL(TipoCosteo,'' ) = ISNULL(ISNULL(@TipoCosteo,TipoCosteo),'')  
		AND ISNULL(Peso,'' ) = ISNULL(ISNULL(@Peso,Peso),'')  
		AND ISNULL(Tara,'' ) = ISNULL(ISNULL(@Tara,Tara),'')  
		AND ISNULL(Volumen,'' ) = ISNULL(ISNULL(@Volumen,Volumen),'')  
		AND ISNULL(Tipo,'' ) = ISNULL(ISNULL(@Tipo,Tipo),'')  
		AND ISNULL(TipoOpcion,'' ) = ISNULL(ISNULL(@TipoOpcion,TipoOpcion),'')  
		AND ISNULL(Accesorios,'' ) = ISNULL(ISNULL(@Accesorios,Accesorios),'')  
		AND ISNULL(Refacciones,'' ) = ISNULL(ISNULL(@Refacciones,Refacciones),'')  
		AND ISNULL(Sustitutos,'' ) = ISNULL(ISNULL(@Sustitutos,Sustitutos),'')  
		AND ISNULL(Servicios,'' ) = ISNULL(ISNULL(@Servicios,Servicios),'')  
		AND ISNULL(Consumibles,'' ) = ISNULL(ISNULL(@Consumibles,Consumibles),'')  
		AND ISNULL(MonedaCosto,'' ) = ISNULL(ISNULL(@MonedaCosto,MonedaCosto),'')  
		AND ISNULL(MonedaPrecio,'' ) = ISNULL(ISNULL(@MonedaPrecio,MonedaPrecio),'')  
		AND ISNULL(MargenMinimo,'' ) = ISNULL(ISNULL(@MargenMinimo,MargenMinimo),'')  
		AND ISNULL(PrecioLista,'' ) = ISNULL(ISNULL(@PrecioLista,PrecioLista),'')  
		AND ISNULL(PrecioMinimo,'' ) = ISNULL(ISNULL(@PrecioMinimo,PrecioMinimo),'')  
		AND ISNULL(FactorAlterno,'' ) = ISNULL(ISNULL(@FactorAlterno,FactorAlterno),'')  
		AND ISNULL(PrecioAnterior,'' ) = ISNULL(ISNULL(@PrecioAnterior,PrecioAnterior),'')  
		AND ISNULL(Utilidad,'' ) = ISNULL(ISNULL(@Utilidad,Utilidad),'')  
		AND ISNULL(DescuentoCompra,'' ) = ISNULL(ISNULL(@DescuentoCompra,DescuentoCompra),'')  
		AND ISNULL(Clase,'' ) = ISNULL(ISNULL(@Clase,Clase),'')  
		AND ISNULL(Estatus,'' ) = ISNULL(ISNULL(@Estatus,Estatus),'')  
		AND ISNULL(UltimoCambio,'' ) = ISNULL(ISNULL(@UltimoCambio,UltimoCambio),'')  
		AND ISNULL(Alta,'' ) = ISNULL(ISNULL(@Alta,Alta),'')  
		AND ISNULL(Conciliar,'' ) = ISNULL(ISNULL(@Conciliar,Conciliar),'')  
		AND ISNULL(Mensaje,'' ) = ISNULL(ISNULL(@Mensaje,Mensaje),'')  
		AND ISNULL(Comision,'' ) = ISNULL(ISNULL(@Comision,Comision),'')  
		AND ISNULL(Arancel,'' ) = ISNULL(ISNULL(@Arancel,Arancel),'')  
		AND ISNULL(ArancelDesperdicio,'' ) = ISNULL(ISNULL(@ArancelDesperdicio,ArancelDesperdicio),'')  
		AND ISNULL(ABC,'' ) = ISNULL(ISNULL(@ABC,ABC),'')  
		AND ISNULL(Usuario,'' ) = ISNULL(ISNULL(@Usuario,Usuario),'')  
		AND ISNULL(Precio2,'' ) = ISNULL(ISNULL(@Precio2,Precio2),'')  
		AND ISNULL(Precio3,'' ) = ISNULL(ISNULL(@Precio3,Precio3),'')  
		AND ISNULL(Precio4,'' ) = ISNULL(ISNULL(@Precio4,Precio4),'')  
		AND ISNULL(Precio5,'' ) = ISNULL(ISNULL(@Precio5,Precio5),'')  
		AND ISNULL(Precio6,'' ) = ISNULL(ISNULL(@Precio6,Precio6),'')  
		AND ISNULL(Precio7,'' ) = ISNULL(ISNULL(@Precio7,Precio7),'')  
		AND ISNULL(Precio8,'' ) = ISNULL(ISNULL(@Precio8,Precio8),'')  
		AND ISNULL(Precio9,'' ) = ISNULL(ISNULL(@Precio9,Precio9),'')  
		AND ISNULL(Precio10,'' ) = ISNULL(ISNULL(@Precio10,Precio10),'')  
		AND ISNULL(Refrigeracion,'' ) = ISNULL(ISNULL(@Refrigeracion,Refrigeracion),'')  
		AND ISNULL(TieneCaducidad,'' ) = ISNULL(ISNULL(@TieneCaducidad,TieneCaducidad),'')  
		AND ISNULL(BasculaPesar,'' ) = ISNULL(ISNULL(@BasculaPesar,BasculaPesar),'')  
		AND ISNULL(SeProduce,'' ) = ISNULL(ISNULL(@SeProduce,SeProduce),'')  
		AND ISNULL(Situacion,'' ) = ISNULL(ISNULL(@Situacion,Situacion),'')  
		AND ISNULL(SituacionFecha,'' ) = ISNULL(ISNULL(@SituacionFecha,SituacionFecha),'')  
		AND ISNULL(SituacionUsuario,'' ) = ISNULL(ISNULL(@SituacionUsuario,SituacionUsuario),'')  
		AND ISNULL(SituacionNota,'' ) = ISNULL(ISNULL(@SituacionNota,SituacionNota),'')  
		AND ISNULL(EstatusPrecio,'' ) = ISNULL(ISNULL(@EstatusPrecio,EstatusPrecio),'')  
		AND ISNULL(wMostrar,'' ) = ISNULL(ISNULL(@wMostrar,wMostrar),'')  
		AND ISNULL(Merma,'' ) = ISNULL(ISNULL(@Merma,Merma),'')  
		AND ISNULL(Desperdicio,'' ) = ISNULL(ISNULL(@Desperdicio,Desperdicio),'')  
		AND ISNULL(SeCompra,'' ) = ISNULL(ISNULL(@SeCompra,SeCompra),'')  
		AND ISNULL(SeVende,'' ) = ISNULL(ISNULL(@SeVende,SeVende),'')  
		AND ISNULL(EsFormula,'' ) = ISNULL(ISNULL(@EsFormula,EsFormula),'')  
		AND ISNULL(TiempoEntrega,'' ) = ISNULL(ISNULL(@TiempoEntrega,TiempoEntrega),'')  
		AND ISNULL(TiempoEntregaUnidad,'' ) = ISNULL(ISNULL(@TiempoEntregaUnidad,TiempoEntregaUnidad),'')  
		AND ISNULL(TiempoEntregaSeg,'' ) = ISNULL(ISNULL(@TiempoEntregaSeg,TiempoEntregaSeg),'')  
		AND ISNULL(TiempoEntregaSegUnidad,'' ) = ISNULL(ISNULL(@TiempoEntregaSegUnidad,TiempoEntregaSegUnidad),'')  
		AND ISNULL(LoteOrdenar,'' ) = ISNULL(ISNULL(@LoteOrdenar,LoteOrdenar),'')  
		AND ISNULL(CantidadOrdenar,'' ) = ISNULL(ISNULL(@CantidadOrdenar,CantidadOrdenar),'')  
		AND ISNULL(MultiplosOrdenar,'' ) = ISNULL(ISNULL(@MultiplosOrdenar,MultiplosOrdenar),'')  
		AND ISNULL(InvSeguridad,'' ) = ISNULL(ISNULL(@InvSeguridad,InvSeguridad),'')  
		AND ISNULL(ProdRuta,'' ) = ISNULL(ISNULL(@ProdRuta,ProdRuta),'')  
		AND ISNULL(AlmacenROP,'' ) = ISNULL(ISNULL(@AlmacenROP,AlmacenROP),'')  
		AND ISNULL(CategoriaProd,'' ) = ISNULL(ISNULL(@CategoriaProd,CategoriaProd),'')  
		AND ISNULL(ProdCantidad,'' ) = ISNULL(ISNULL(@ProdCantidad,ProdCantidad),'')  
		AND ISNULL(ProdUsuario,'' ) = ISNULL(ISNULL(@ProdUsuario,ProdUsuario),'')  
		AND ISNULL(ProdPasoTotal,'' ) = ISNULL(ISNULL(@ProdPasoTotal,ProdPasoTotal),'')  
		AND ISNULL(ProdMovGrupo,'' ) = ISNULL(ISNULL(@ProdMovGrupo,ProdMovGrupo),'')  
		AND ISNULL(ProdEstacion,'' ) = ISNULL(ISNULL(@ProdEstacion,ProdEstacion),'')  
		AND ISNULL(ProdOpciones,'' ) = ISNULL(ISNULL(@ProdOpciones,ProdOpciones),'')  
		AND ISNULL(ProdVerConcentracion,'' ) = ISNULL(ISNULL(@ProdVerConcentracion,ProdVerConcentracion),'')  
		AND ISNULL(ProdVerCostoAcumulado,'' ) = ISNULL(ISNULL(@ProdVerCostoAcumulado,ProdVerCostoAcumulado),'')  
		AND ISNULL(ProdVerMerma,'' ) = ISNULL(ISNULL(@ProdVerMerma,ProdVerMerma),'')  
		AND ISNULL(ProdVerDesperdicio,'' ) = ISNULL(ISNULL(@ProdVerDesperdicio,ProdVerDesperdicio),'')  
		AND ISNULL(ProdVerPorcentaje,'' ) = ISNULL(ISNULL(@ProdVerPorcentaje,ProdVerPorcentaje),'')  
		AND ISNULL(RevisionUltima,'' ) = ISNULL(ISNULL(@RevisionUltima,RevisionUltima),'')  
		AND ISNULL(RevisionUsuario,'' ) = ISNULL(ISNULL(@RevisionUsuario,RevisionUsuario),'')  
		AND ISNULL(RevisionFrecuencia,'' ) = ISNULL(ISNULL(@RevisionFrecuencia,RevisionFrecuencia),'')  
		AND ISNULL(RevisionFrecuenciaUnidad,'' ) = ISNULL(ISNULL(@RevisionFrecuenciaUnidad,RevisionFrecuenciaUnidad),'')  
		AND ISNULL(RevisionSiguiente,'' ) = ISNULL(ISNULL(@RevisionSiguiente,RevisionSiguiente),'')  
		AND ISNULL(ProdMov,'' ) = ISNULL(ISNULL(@ProdMov,ProdMov),'')  
		AND ISNULL(TipoCompra,'' ) = ISNULL(ISNULL(@TipoCompra,TipoCompra),'')  
		AND ISNULL(TieneMovimientos,'' ) = ISNULL(ISNULL(@TieneMovimientos,TieneMovimientos),'')  
		AND ISNULL(Registro1,'' ) = ISNULL(ISNULL(@Registro1,Registro1),'')  
		AND ISNULL(Registro1Vencimiento,'' ) = ISNULL(ISNULL(@Registro1Vencimiento,Registro1Vencimiento),'')  
		AND ISNULL(AlmacenEspecificoVenta,'' ) = ISNULL(ISNULL(@AlmacenEspecificoVenta,AlmacenEspecificoVenta),'')  
		AND ISNULL(AlmacenEspecificoVentaMov,'' ) = ISNULL(ISNULL(@AlmacenEspecificoVentaMov,AlmacenEspecificoVentaMov),'')  
		AND ISNULL(RutaDistribucion,'' ) = ISNULL(ISNULL(@RutaDistribucion,RutaDistribucion),'')  
		AND ISNULL(CostoEstandar,'' ) = ISNULL(ISNULL(@CostoEstandar,CostoEstandar),'')  
		AND ISNULL(CostoReposicion,'' ) = ISNULL(ISNULL(@CostoReposicion,CostoReposicion),'')  
		AND ISNULL(EstatusCosto,'' ) = ISNULL(ISNULL(@EstatusCosto,EstatusCosto),'')  
		AND ISNULL(Margen,'' ) = ISNULL(ISNULL(@Margen,Margen),'')  
		AND ISNULL(Proveedor,'' ) = ISNULL(ISNULL(@Proveedor,Proveedor),'')  
		AND ISNULL(NivelAcceso,'' ) = ISNULL(ISNULL(@NivelAcceso,NivelAcceso),'')  
		AND ISNULL(Temporada,'' ) = ISNULL(ISNULL(@Temporada,Temporada),'')  
		AND ISNULL(SolicitarPrecios,'' ) = ISNULL(ISNULL(@SolicitarPrecios,SolicitarPrecios),'')  
		AND ISNULL(AutoRecaudacion,'' ) = ISNULL(ISNULL(@AutoRecaudacion,AutoRecaudacion),'')  
		AND ISNULL(Concepto,'' ) = ISNULL(ISNULL(@Concepto,Concepto),'')  
		AND ISNULL(Cuenta,'' ) = ISNULL(ISNULL(@Cuenta,Cuenta),'')  
		AND ISNULL(Retencion1,'' ) = ISNULL(ISNULL(@Retencion1,Retencion1),'')  
		AND ISNULL(Retencion2,'' ) = ISNULL(ISNULL(@Retencion2,Retencion2),'')  
		AND ISNULL(Retencion3,'' ) = ISNULL(ISNULL(@Retencion3,Retencion3),'')  
		AND ISNULL(Espacios,'' ) = ISNULL(ISNULL(@Espacios,Espacios),'')  
		AND ISNULL(EspaciosEspecificos,'' ) = ISNULL(ISNULL(@EspaciosEspecificos,EspaciosEspecificos),'')  
		AND ISNULL(EspaciosSobreventa,'' ) = ISNULL(ISNULL(@EspaciosSobreventa,EspaciosSobreventa),'')  
		AND ISNULL(EspaciosNivel,'' ) = ISNULL(ISNULL(@EspaciosNivel,EspaciosNivel),'')  
		AND ISNULL(EspaciosMinutos,'' ) = ISNULL(ISNULL(@EspaciosMinutos,EspaciosMinutos),'')  
		AND ISNULL(EspaciosBloquearAnteriores,'' ) = ISNULL(ISNULL(@EspaciosBloquearAnteriores,EspaciosBloquearAnteriores),'')  
		AND ISNULL(EspaciosHoraD,'' ) = ISNULL(ISNULL(@EspaciosHoraD,EspaciosHoraD),'')  
		AND ISNULL(EspaciosHoraA,'' ) = ISNULL(ISNULL(@EspaciosHoraA,EspaciosHoraA),'')  
		AND ISNULL(SerieLoteInfo,'' ) = ISNULL(ISNULL(@SerieLoteInfo,SerieLoteInfo),'')  
		AND ISNULL(CantidadMinimaVenta,'' ) = ISNULL(ISNULL(@CantidadMinimaVenta,CantidadMinimaVenta),'')  
		AND ISNULL(CantidadMaximaVenta,'' ) = ISNULL(ISNULL(@CantidadMaximaVenta,CantidadMaximaVenta),'')  
		AND ISNULL(EstimuloFiscal,'' ) = ISNULL(ISNULL(@EstimuloFiscal,EstimuloFiscal),'')  
		AND ISNULL(OrigenPais,'' ) = ISNULL(ISNULL(@OrigenPais,OrigenPais),'')  
		AND ISNULL(OrigenLocalidad,'' ) = ISNULL(ISNULL(@OrigenLocalidad,OrigenLocalidad),'')  
		AND ISNULL(Incentivo,'' ) = ISNULL(ISNULL(@Incentivo,Incentivo),'')  
		AND ISNULL(FactorCompra,'' ) = ISNULL(ISNULL(@FactorCompra,FactorCompra),'')  
		AND ISNULL(Horas,'' ) = ISNULL(ISNULL(@Horas,Horas),'')  
		AND ISNULL(ISAN,'' ) = ISNULL(ISNULL(@ISAN,ISAN),'')  
		AND ISNULL(ExcluirDescFormaPago,'' ) = ISNULL(ISNULL(@ExcluirDescFormaPago,ExcluirDescFormaPago),'')  
		AND ISNULL(EsDeducible,'' ) = ISNULL(ISNULL(@EsDeducible,EsDeducible),'')  
		AND ISNULL(Peaje,'' ) = ISNULL(ISNULL(@Peaje,Peaje),'')  
		AND ISNULL(CodigoAlterno,'' ) = ISNULL(ISNULL(@CodigoAlterno,CodigoAlterno),'')  
		AND ISNULL(TipoCatalogo,'' ) = ISNULL(ISNULL(@TipoCatalogo,TipoCatalogo),'')  
		AND ISNULL(AnexosAlFacturar,'' ) = ISNULL(ISNULL(@AnexosAlFacturar,AnexosAlFacturar),'')  
		AND ISNULL(CaducidadMinima,'' ) = ISNULL(ISNULL(@CaducidadMinima,CaducidadMinima),'')  
		AND ISNULL(Actividades,'' ) = ISNULL(ISNULL(@Actividades,Actividades),'')  
		AND ISNULL(ValidarPresupuestoCompra,'' ) = ISNULL(ISNULL(@ValidarPresupuestoCompra,ValidarPresupuestoCompra),'')  
		AND ISNULL(SeriesLotesAutoOrden,'' ) = ISNULL(ISNULL(@SeriesLotesAutoOrden,SeriesLotesAutoOrden),'')  
		AND ISNULL(LotesFijos,'' ) = ISNULL(ISNULL(@LotesFijos,LotesFijos),'')  
		AND ISNULL(LotesAuto,'' ) = ISNULL(ISNULL(@LotesAuto,LotesAuto),'')  
		AND ISNULL(Consecutivo,'' ) = ISNULL(ISNULL(@Consecutivo,Consecutivo),'')  
		AND ISNULL(TipoEmpaque,'' ) = ISNULL(ISNULL(@TipoEmpaque,TipoEmpaque),'')  
		AND ISNULL(Modelo,'' ) = ISNULL(ISNULL(@Modelo,Modelo),'')  
		AND ISNULL(Version,'' ) = ISNULL(ISNULL(@ArtVersion,Version),'')  
		AND ISNULL(TieneDireccion,'' ) = ISNULL(ISNULL(@TieneDireccion,TieneDireccion),'')  
		AND ISNULL(Direccion,'' ) = ISNULL(ISNULL(@Direccion,Direccion),'')  
		AND ISNULL(DireccionNumero,'' ) = ISNULL(ISNULL(@DireccionNumero,DireccionNumero),'')  
		AND ISNULL(DireccionNumeroInt,'' ) = ISNULL(ISNULL(@DireccionNumeroInt,DireccionNumeroInt),'')  
		AND ISNULL(EntreCalles,'' ) = ISNULL(ISNULL(@EntreCalles,EntreCalles),'')  
		AND ISNULL(Plano,'' ) = ISNULL(ISNULL(@Plano,Plano),'')  
		AND ISNULL(Observaciones,'' ) = ISNULL(ISNULL(@Observaciones,Observaciones),'')  
		AND ISNULL(Colonia,'' ) = ISNULL(ISNULL(@Colonia,Colonia),'')  
		AND ISNULL(Delegacion,'' ) = ISNULL(ISNULL(@Delegacion,Delegacion),'')  
		AND ISNULL(Poblacion,'' ) = ISNULL(ISNULL(@Poblacion,Poblacion),'')  
		AND ISNULL(Estado,'' ) = ISNULL(ISNULL(@Estado,Estado),'')  
		AND ISNULL(Pais,'' ) = ISNULL(ISNULL(@Pais,Pais),'')  
		AND ISNULL(CodigoPostal,'' ) = ISNULL(ISNULL(@CodigoPostal,CodigoPostal),'')  
		AND ISNULL(Ruta,'' ) = ISNULL(ISNULL(@Ruta,Ruta),'')  
		AND ISNULL(Codigo,'' ) = ISNULL(ISNULL(@Codigo,Codigo),'')  
		AND ISNULL(ClaveVehicular,'' ) = ISNULL(ISNULL(@ClaveVehicular,ClaveVehicular),'')  
		AND ISNULL(TipoVehiculo,'' ) = ISNULL(ISNULL(@TipoVehiculo,TipoVehiculo),'')  
		AND ISNULL(DiasLibresIntereses,'' ) = ISNULL(ISNULL(@DiasLibresIntereses,DiasLibresIntereses),'')  
		AND ISNULL(PrecioLiberado,'' ) = ISNULL(ISNULL(@PrecioLiberado,PrecioLiberado),'')  
		AND ISNULL(ValidarCodigo,'' ) = ISNULL(ISNULL(@ValidarCodigo,ValidarCodigo),'')  
		AND ISNULL(Presentacion,'' ) = ISNULL(ISNULL(@Presentacion,Presentacion),'')  
		AND ISNULL(GarantiaPlazo,'' ) = ISNULL(ISNULL(@GarantiaPlazo,GarantiaPlazo),'')  
		AND ISNULL(CostoIdentificado,'' ) = ISNULL(ISNULL(@CostoIdentificado,CostoIdentificado),'')  
		AND ISNULL(CantidadTarima,'' ) = ISNULL(ISNULL(@CantidadTarima,CantidadTarima),'')  
		AND ISNULL(UnidadTarima,'' ) = ISNULL(ISNULL(@UnidadTarima,UnidadTarima),'')  
		AND ISNULL(MinimoTarima,'' ) = ISNULL(ISNULL(@MinimoTarima,MinimoTarima),'')  
		AND ISNULL(DepartamentoDetallista,'' ) = ISNULL(ISNULL(@DepartamentoDetallista,DepartamentoDetallista),'')  
		AND ISNULL(TratadoComercial,'' ) = ISNULL(ISNULL(@TratadoComercial,TratadoComercial),'')  
		AND ISNULL(CuentaPresupuesto,'' ) = ISNULL(ISNULL(@CuentaPresupuesto,CuentaPresupuesto),'')  
		AND ISNULL(ProgramaSectorial,'' ) = ISNULL(ISNULL(@ProgramaSectorial,ProgramaSectorial),'')  
		AND ISNULL(PedimentoClave,'' ) = ISNULL(ISNULL(@PedimentoClave,PedimentoClave),'')  
		AND ISNULL(PedimentoRegimen,'' ) = ISNULL(ISNULL(@PedimentoRegimen,PedimentoRegimen),'')  
		AND ISNULL(Permiso,'' ) = ISNULL(ISNULL(@Permiso,Permiso),'')  
		AND ISNULL(PermisoRenglon,'' ) = ISNULL(ISNULL(@PermisoRenglon,PermisoRenglon),'')  
		AND ISNULL(Cuenta2,'' ) = ISNULL(ISNULL(@Cuenta2,Cuenta2),'')  
		AND ISNULL(Cuenta3,'' ) = ISNULL(ISNULL(@Cuenta3,Cuenta3),'')  
		AND ISNULL(Impuesto1Excento,'' ) = ISNULL(ISNULL(@Impuesto1Excento,Impuesto1Excento),'')  
		AND ISNULL(CalcularPresupuesto,'' ) = ISNULL(ISNULL(@CalcularPresupuesto,CalcularPresupuesto),'')  
		AND ISNULL(InflacionPresupuesto,'' ) = ISNULL(ISNULL(@InflacionPresupuesto,InflacionPresupuesto),'')  
		AND ISNULL(Excento2,'' ) = ISNULL(ISNULL(@Excento2,Excento2),'')  
		AND ISNULL(Excento3,'' ) = ISNULL(ISNULL(@Excento3,Excento3),'')  
		AND ISNULL(ContUso,'' ) = ISNULL(ISNULL(@ContUso,ContUso),'')  
		AND ISNULL(ContUso2,'' ) = ISNULL(ISNULL(@ContUso2,ContUso2),'')  
		AND ISNULL(ContUso3,'' ) = ISNULL(ISNULL(@ContUso3,ContUso3),'')  
		AND ISNULL(NivelToleranciaCosto,'' ) = ISNULL(ISNULL(@NivelToleranciaCosto,NivelToleranciaCosto),'')  
		AND ISNULL(ToleranciaCosto,'' ) = ISNULL(ISNULL(@ToleranciaCosto,ToleranciaCosto),'')  
		AND ISNULL(ToleranciaCostoInferior,'' ) = ISNULL(ISNULL(@ToleranciaCostoInferior,ToleranciaCostoInferior),'')  
		AND ISNULL(ObjetoGasto,'' ) = ISNULL(ISNULL(@ObjetoGasto,ObjetoGasto),'')  
		AND ISNULL(ObjetoGastoRef,'' ) = ISNULL(ISNULL(@ObjetoGastoRef,ObjetoGastoRef),'')  
		AND ISNULL(ClavePresupuestalImpuesto1,'' ) = ISNULL(ISNULL(@ClavePresupuestalImpuesto1,ClavePresupuestalImpuesto1),'')  
		AND ISNULL(Estructura,'' ) = ISNULL(ISNULL(@Estructura,Estructura),'')  
		AND ISNULL(TipoImpuesto1,'' ) = ISNULL(ISNULL(@TipoImpuesto1,TipoImpuesto1),'')  
		AND ISNULL(TipoImpuesto2,'' ) = ISNULL(ISNULL(@TipoImpuesto2,TipoImpuesto2),'')  
		AND ISNULL(TipoImpuesto3,'' ) = ISNULL(ISNULL(@TipoImpuesto3,TipoImpuesto3),'')  
		AND ISNULL(TipoRetencion1,'' ) = ISNULL(ISNULL(@TipoRetencion1,TipoRetencion1),'')  
		AND ISNULL(TipoRetencion2,'' ) = ISNULL(ISNULL(@TipoRetencion2,TipoRetencion2),'')  
		AND ISNULL(TipoRetencion3,'' ) = ISNULL(ISNULL(@TipoRetencion3,TipoRetencion3),'')  
		AND ISNULL(TipoImpuesto4,'' ) = ISNULL(ISNULL(@TipoImpuesto4,TipoImpuesto4),'')  
		AND ISNULL(Calificacion,'' ) = ISNULL(ISNULL(@Calificacion,Calificacion),'')                                                  
		FOR XML AUTO)                
  
    SELECT @ReferenciaIS = Referencia  
      FROM IntelisisService  
     WHERE ID = @ID  
  
    SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + ISNULL(CONVERT(varchar(max),@Texto),'')+ '</Resultado></Intelisis>'  
  
  IF @@ERROR <> 0 SET @Ok = 1  
  IF @Ok IS NULL  
   BEGIN  
     COMMIT TRANSACTION  
   END ELSE  
    BEGIN  
      ROLLBACK TRANSACTION  
    END  
  END  
END  
GO
/**************** spIntelisisInterfazInforTransferenciaArtContadorLotes ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaArtContadorLotes') and type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaArtContadorLotes
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaArtContadorLotes
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
	@Articulo				varchar(20),	
	@Datos					varchar(max),
	@Solicitud				varchar(max),
	@ReferenciaIS			varchar(100),
	@SubReferencia			varchar(100),
	@IDNuevo				int,
	@Datos2					varchar(max),
	@Resultado2				varchar(max),
	@Usuario				varchar(10),
	@Contrasena				varchar(32),
	@ReferenciaIntelisisService			varchar(50)	
    				
								

  DECLARE
		 @Tabla			 table
		(
	TipoContador 			varchar(4),	
	Codigo  				varchar(20),
	UltimoNumeroLote		int,
	Prefijo  				varchar(20),
	Sufijo  				varchar(20),
    UnidadesMaxLote			int,
    Formato					varchar(20),
	CantidadPorLote         float , 
	ImpresionEtiqueta		bit   ,
    FechaUltimaAsignacion	datetime ,
    FechaDeAlta				datetime ,
    ReferenciaIntelisisService  varchar(100)
		 )
		
  IF @Ok IS NULL
  BEGIN
  
    SELECT @Articulo = Articulo FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Art')
      WITH (Articulo varchar(255))
  
    SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
      FROM IntelisisService 
     WHERE ID = @ID
    SELECT @Contrasena = Contrasena 
      FROM Usuario
     WHERE Usuario = @Usuario

 
    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'


    SET @Datos=
             '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Articulo.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Articulo" Valor="'+@Articulo+'"/></Solicitud></Intelisis>'

    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

    SELECT @Solicitud = Resultado 
      FROM IntelisisService
     WHERE ID = @IDNuevo

     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
     INSERT @Tabla (TipoContador ,    Codigo,   UltimoNumeroLote,        Prefijo,      Sufijo,  CantidadPorLote,   ImpresionEtiqueta,    FechaUltimaAsignacion,           FechaDeAlta,           UnidadesMaxLote,          ReferenciaIntelisisService   )
             SELECT TipoContador='A', Articulo, UltimoNumeroLote=0, INFORPrefijo, INFORSufijo,  CantidadPorLote=0, ImpresionEtiqueta=0,  FechaUltimaAsignacion=getdate(), FechaDeAlta=getdate(), INFORUnidadesMaximaLote , ReferenciaIntelisisService

               FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Art',1)  
               WITH (Articulo    varchar(100), INFORPrefijo    varchar(100), INFORSufijo  varchar(100),ReferenciaIntelisisService  varchar(100), INFORUnidadesMaximaLote  varchar(100)) 	
     EXEC sp_xml_removedocument @iSolicitud		
     SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService from @Tabla
     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oContadoresLotes FOR XML AUTO))

     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.ArtContadorLotes.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>'  
     EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
     IF @@ERROR <> 0 SET @Ok = 1
  END 
END
GO
/**************** spIntelisisInterfazInforTransferenciaArtFam ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaArtFam') and type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaArtFam
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaArtFam
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

 DECLARE 
	@Familia  				varchar(50),	
	@Datos					varchar(max),
	@Solicitud				varchar(max),
	@ReferenciaIS			varchar(100),
	@SubReferencia			varchar(100),
	@IDNuevo				int,
	@Datos2					varchar(max),
	@Resultado2				varchar(max),
	@Usuario				varchar(10),
	@Contrasena				varchar(32)	,
    @Verificar				int,
	@ReferenciaIntelisisService			varchar(50)
    				
								

  DECLARE
		 @Tabla			 table
		(
	Codigo  				varchar(20),
	Descripcion  				varchar(30),
    ReferenciaIntelisisService  varchar(50)
		 )
		

  SELECT @Familia = Familia FROM openxml (@iSolicitud,'/Intelisis/Solicitud/ArtFam')
    WITH (Familia varchar(255))
  SELECT @Verificar =LEN(@Familia)
  IF  @Verificar  > 4  SELECT @Ok = 10265, @OkRef = @Familia

  
 SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
   FROM IntelisisService 
  WHERE ID = @ID
  
  
 SELECT @Contrasena = Contrasena 
   FROM Usuario
  WHERE Usuario = @Usuario
  
  
 IF @Ok IS NULL
 BEGIN 

   SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'
   SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.ArtFam.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Familia" Valor="'+@Familia+'"/></Solicitud></Intelisis>'
   EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output
   IF @Ok IS NULL
     SELECT @Solicitud = Resultado 
       FROM IntelisisService
      WHERE ID = @IDNuevo
  
     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
     IF @@ERROR <> 0 SET @Ok = 1
          INSERT @Tabla (	      Codigo,				Descripcion ,ReferenciaIntelisisService   )
             SELECT SUBSTRING(Familia,1,4), SUBSTRING(INFORDescripcion,1,30),ReferenciaIntelisisService 
               FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/ArtFam',1)  
               WITH (Familia    varchar(100), INFORDescripcion  varchar(100),ReferenciaIntelisisService varchar(100)) 
     IF @@ERROR <> 0 SET @Ok = 1
     EXEC sp_xml_removedocument @iSolicitud



     IF @@ERROR <> 0 SET @Ok = 1 
       SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService from @Tabla      
       SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oFamilia FOR XML AUTO))
       SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.ArtFam.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>'  
  END
  ELSE
  BEGIN
    SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.ArtFam.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud><ERROR Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + '/></Solicitud></Intelisis>' 		   
  END
  EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
					
END
GO
/**************** spIntelisisInterfazInforTransferenciaArtLinea ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaArtLinea')           AND type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaArtLinea
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaArtLinea
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
		@Linea     				        varchar(50),
		@Datos								varchar(max),
		@Solicitud							varchar(max),
		@ReferenciaIS						varchar(100),
		@SubReferencia						varchar(100),
		@IDNuevo							int,
		@Datos2								varchar(max),
		@Resultado2							varchar(max),
		@Usuario							varchar(10),
		@Contrasena							varchar(32)
								

  DECLARE
		@Tabla			 table
		(
         SubFamilia   varchar(50)
		 )
		
 

  SELECT @Linea = Linea FROM openxml (@iSolicitud,'/Intelisis/Solicitud/ArtLinea')
    WITH (Linea varchar(255))

  
 SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
   FROM IntelisisService 
  WHERE ID = @ID
  
  
 SELECT @Contrasena = Contrasena 
   FROM Usuario
  WHERE Usuario = @Usuario
  
  
 IF @Ok IS NULL
 BEGIN 

    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@ID,'')),'') + CHAR(34) +  ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@Ok,'')),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(ISNULL(@OkRef,''),'') + CHAR(34) + '/></Intelisis>'
    SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.ArtLinea.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Linea" Valor="'+@Linea+'"/></Solicitud></Intelisis>'
     
    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDnuevo Output
  
    IF @Ok IS NULL
      SELECT @Solicitud = Resultado 
        FROM IntelisisService
       WHERE ID = @IDNuevo
  
      EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
      IF @@ERROR <> 0 SET @Ok = 1
      INSERT @Tabla (SubFamilia)
             
            SELECT Linea
             FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/ArtLinea',1)  
                WITH (Linea varchar(100))
      IF @@ERROR <> 0 SET @Ok = 1
      EXEC sp_xml_removedocument @iSolicitud
      IF @@ERROR <> 0 SET @Ok = 1
      
    END
        SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oSubFamilia FOR XML AUTO))
        SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.ArtLinea.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>'  
  
  EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
					
END
GO
/**************** spIntelisisInterfazInforTransferenciaUsuario ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaUsuario') and type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaUsuario
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaUsuario
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
	@Usuario				varchar(10),	
	@Nombre					varchar(100),	
	@Datos					varchar(max),
	@Solicitud				varchar(max),
	@ReferenciaIS			varchar(100),
	@SubReferencia			varchar(100),
	@IDNuevo				int,
	@Datos2					varchar(max),
	@Resultado2				varchar(max),
	@Usuario1				varchar(10),
	@Contrasena				varchar(32),
	@ReferenciaIntelisisService			varchar(50)	
    				
								

  DECLARE
		 @Tabla			 table
		(
	Usuario		 			varchar(30),	
	Nombre		 			varchar(100),	
	FechaCreacion			datetime,
	NumeroConec				int,
	FechaUltAcceso			datetime,
	TiempoConec		        float , 
	FechaDeAlta				datetime,
	FechaUltimaModificacion	datetime,
	UsuarioAlta		 		varchar(10),	
	UsuarioModificacion		varchar(10),
	Supervisor				int   ,
	ClaveAccesoAccess 		varchar(10),	
	GrupoParaAccess			varchar(30),	
	Grupo		 			varchar(30),	
	GrupoObjeto	 			varchar(30),	
	IdCRM	  				varchar(50),
	CRM		  				int ,
    ReferenciaIntelisisService  varchar(50),
    PerfilMES				varchar(20)
		 )
		
  IF @Ok IS NULL
  BEGIN
  
    SELECT @Usuario = Usuario FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Usuario')
      WITH (Usuario varchar(255))
  
    SELECT @ReferenciaIS = Referencia ,@Usuario1 = Usuario , @SubReferencia = SubReferencia
      FROM IntelisisService 
     WHERE ID = @ID
    SELECT @Contrasena = Contrasena 
      FROM Usuario
     WHERE Usuario = @Usuario1

 
    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'


    SET @Datos=
             '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Usuario.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Usuario" Valor="'+@Usuario+'"/></Solicitud></Intelisis>'

    EXEC spIntelisisService @Usuario1,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

    SELECT @Solicitud = Resultado 
      FROM IntelisisService
     WHERE ID = @IDNuevo

     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
     INSERT @Tabla (	Usuario, Nombre,	FechaCreacion,             NumeroConec,     FechaUltAcceso,                   TiempoConec,     FechaDeAlta,            FechaUltimaModificacion, UsuarioAlta,        UsuarioModificacion,        Supervisor,      ClaveAccesoAccess,        GrupoParaAccess,        Grupo,        GrupoObjeto,        IdCRM,        CRM ,       ReferenciaIntelisisService ,PerfilMES  )
             SELECT     Usuario, Nombre,	FechaCreacion = GETDATE(), NumeroConec = 0, ISNULL(UltimoAcceso,GETDATE()),   TiempoConec = 0, ISNULL(Alta,GETDATE()), UltimoCambio,            UsuarioAlta = Null, UsuarioModificacion = Null, INFORSupervisor, ClaveAccesoAccess = Null, GrupoParaAccess = Null, GrupoTrabajo, GrupoObjeto = Null, IdCRM = Null, CRM = Null, ReferenciaIntelisisService  ,INFORPerfil
               FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Usuario',1)  
               WITH (Usuario    varchar(100), Nombre    varchar(100), UltimoAcceso    varchar(100), Alta  varchar(100), UltimoCambio  varchar(100), INFORSupervisor  varchar(100), GrupoTrabajo  varchar(100),ReferenciaIntelisisService  varchar(100),INFORPerfil  varchar(100)) 	
     EXEC sp_xml_removedocument @iSolicitud		
     SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService from @Tabla
     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla Usuario FOR XML AUTO))

     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Usuario.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>'  
     EXEC spIntelisisService @Usuario1,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
     IF @@ERROR <> 0 SET @Ok = 1
     IF @Ok IS NULL
     IF @@ERROR <> 0 SET @Ok = 1
  END 
END
GO
/**************** spIntelisisCuentaUsuarioListado  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaUsuarioListado') and type = 'P') drop procedure dbo.spIntelisisCuentaUsuarioListado
GO             
CREATE PROCEDURE spIntelisisCuentaUsuarioListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
					@Usuario						varchar(10),
					@Nombre							varchar(100),
					@Sucursal						int,
					@DefEmpresa						varchar(5),
					@GrupoTrabajo					varchar(50),
					@Departamento					varchar(50),
					@Contrasena						varchar(32),
					@ContrasenaConfirmacion			varchar(32),
					@ContrasenaFecha				datetime,
					@ContrasenaModificar			bit,
					@Telefono						varchar(100),
					@Extencion						varchar(10),
					@DefAgente						varchar(10),
					@DefCajero						varchar(10),
					@DefAlmacen						varchar(10),
					@DefAlmacenTrans				varchar(10),
					@DefCtaDinero					varchar(10),
					@DefCtaDineroTrans				varchar(10),
					@DefMoneda						varchar(10),
					@DefProyecto					varchar(50),
					@DefLocalidad					varchar(50),
					@DefCliente						varchar(10),
					@DefActividad					varchar(50),
					@DefMovVentas					varchar(20),
					@DefZonaImpuesto				varchar(30),
					@DefFormaPago					varchar(50),
					@Afectar						bit,
					@Cancelar						bit,
					@Desafectar						bit,
					@Autorizar						bit,
					@AutorizarVenta					bit,
					@AutorizarCxp					bit,
					@AutorizarGasto					bit,
					@AutorizarDinero				bit,
					@AutorizarPV					bit,
					@AutorizarCompra				bit,
					@AutorizarGestion				bit,
					@AutorizarSeriesLotes			bit,
					@AfectarOtrosMovs				bit,
					@CancelarOtrosMovs				bit,
					@ConsultarOtrosMovs				bit,
					@ConsultarOtrosMovsGrupo		bit,
					@ConsultarOtrasEmpresas			bit,
					@ConsultarOtrasSucursales		bit,
					@AccesarOtrasSucursalesEnLinea	bit,
					@AfectarOtrasSucursalesEnLinea	bit,
					@ModificarOtrosMovs				bit,
					@ModificarVencimientos			bit,
					@ModificarEntregas				bit,
					@ModificarFechaRequerida		bit,
					@ModificarEnvios				bit,
					@ModificarReferencias			bit,
					@ModificarAlmacenEntregas		bit,
					@ModificarSituacion				bit,
					@ModificarAgente				bit,
					@ModificarUsuario				bit,
					@ModificarListaPrecios			bit,
					@ModificarZonaImpuesto			bit,
					@ModificarSucursalDestino		bit,
					@ModificarProyUENActCC			bit,
					@AgregarCteExpress				bit,
					@AgregarArtExpress				bit,
					@Costos							bit,
					@BloquearCostos					bit,
					@VerInfoDeudores				bit,
					@VerInfoAcreedores				bit,
					@VerComisionesPendientes		bit,
					@BloquearEncabezadoVenta		bit,
					@BloquearCxcCtaDinero			bit,
					@BloquearCxpCtaDinero			bit,
					@BloquearDineroCtaDinero		bit,
					@EnviarExcel					bit,
					@ImprimirMovs					bit,
					@PreliminarMovs					bit,
					@Reservar						bit,
					@DesReservar					bit,
					@Asignar						bit,
					@DesAsignar						bit,
					@ModificarAlmacenPedidos		bit,
					@ModificarConceptos				bit,
					@ModificarReferenciasSiempre	bit,
					@ModificarAgenteCxcPendiente	bit,
					@ModificarMovsNominaVigentes	bit,
					@BloquearPrecios				bit,
					@BloquearDescGlobal				bit,
					@BloquearDescLinea				bit,
					@BloquearCondiciones			bit,
					@BloquearAlmacen				bit,
					@BloquearMoneda					bit,
					@BloquearAgente					bit,
					@BloquearFechaEmision			bit,
					@BloquearProyecto				bit,
					@BloquearFormaPago				bit,
					@Oficina						varchar(50),
					@DefArtTipo						varchar(20),
					@DefUnidad						varchar(50),
					@AbrirCajon						bit,
					@BloquearCobroInmediato			bit,
					@ConsultarCompraPendiente		bit,
					@AccesoTotalCuentas				bit,
					@Estatus						varchar(15),
					@UltimoCambio					datetime,
					@Alta							datetime,
					@Configuracion					varchar(10),
					@Acceso							varchar(10),
					@TieneMovimientos				bit,
					@Refacturar						bit,
					@DefListaPreciosEsp				varchar(20),
					@LimiteTableroControl			int,
					@CteInfo						bit,
					@CteBloquearOtrosDatos			bit,
					@ArtBloquearOtrosDatos			bit,
					@CteSucursalVenta				bit,
					@CtaDineroInfo					bit,
					@ImpresionInmediata				bit,
					@MostrarCampos					bit,
					@AsistentePrecios				bit,
					@CambioValidarCobertura			bit,
					@CambioNormatividad				bit,
					@CambioEditarCobertura			bit,
					@CambioVerPosicionEmpresa		bit,
					@CambioVerPosicionSucursal		bit,
					@CambioVerPosicionOtraSucursal	bit,
					@CambioAutorizarOperacionLimite	bit,
					@AutoDobleCapturaPrecios		bit,
					@AutoArtGrupo					varchar(50),
					@AutoAgregarRecaudacionConsumo	bit,
					@AutoDiesel						bit,
					@BloquearActividad				bit,
					@UEN							int,
					@eMail							varchar(50),
					@CteMov							bit,
					@CteArt							bit,
					@ProvMov						bit,
					@ArtMov							bit,
					@DefContUso						varchar(20),
					@BloquearContUso				bit,
					@Observaciones					varchar(255),
					@TraspasarTodo					bit,
					@BloquearNotasNegativas			bit,
					@ModificarSerieLoteProp			bit,
					@NominaEliminacionParcial		bit,
					@ModificarPropiedadesLotes		bit,
					@PVAbrirCajonSiempre			bit,
					@PVBloquearEgresos				bit,
					@PVCobrarNotasEstatusBorrador	bit,
					@PVModificarEstatusBorrador		bit,
					@BloquearPersonalCfg			bit,
					@BloquearFacturacionDirecta		bit,
					@BloquearInvSalidaDirecta		bit,
					@Idioma							varchar(50),
					@ModificarDatosVIN				bit,
					@ModificarDatosCliente			bit,
					@CxcExpress						bit,
					@CxpExpress						bit,
					@Cliente						varchar(10),
					@SubModuloAtencion				varchar(5),
					@BloquearCancelarFactura		bit,
					@CambioPresentacionExpress		bit,
					@ModificarConsecutivos			bit,
					@ModificarVINFechaBaja			bit,
					@ModificarVINFechaPago			bit,
					@ModificarVINAccesorio			bit,
					@PVEditarNota					bit,
					@ModificarDescGlobalImporte		bit,
					@ConsultarClientesOtrosAgentes	bit,
					@ACLCUsoEspecifico				varchar(20),
					@ACEditarTablaAmortizacion		bit,
					@PlantillasOffice				bit,
					@ConfigPlantillasOffice			bit,
					@ACTasaGrupo					varchar(50),
					@CambioAgregarBeneficiarios		bit,
					@AgregarConceptoExpress			bit,
					@BloquearArtMaterial			bit,
					@InfoPath						bit,
					@InfoPathExe					varchar(255),
					@FEA							bit,
					@FEACertificado					varchar(100),
					@FEALlave						varchar(100),
					@ContrasenaNuncaExpira			bit,
					@Menu							varchar(50),
					@MenuAccesoTotal				bit,
					@BloquearPDF					bit,
					@VerificarOrtografia			bit,
					@ContSinOrigen					bit,
					@UnidadOrganizacional			varchar(20),
					@ProyectoMov					bit,
					@CompraDevTodo					bit,
					@BloquearWebContenido			bit,
					@BloquearWebHTML				bit,
					@DBMailPerfil					varchar(50),
					@UltimoAcceso					datetime,
					@BloquearSituacionUsuario		bit,
					@InformacionConfidencial		bit,
					@PerfilForma					varchar(50),
					@Licenciamiento					varchar(50),
					@SituacionArea					varchar(50),
					@ModificarTipoImpuesto			bit,
					@AgregarProvExpress				bit,
					@ProyMov						bit,
					@Texto							xml,
					@ReferenciaIS					varchar(100),
					@SubReferencia					varchar(100)

  BEGIN TRANSACTION 
  IF @Ok IS NULL
  BEGIN
  
  SELECT @Usuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Usuario'
  SELECT @Nombre = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Nombre'
  SELECT @Sucursal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Sucursal'
  SELECT @DefEmpresa = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefEmpresa'
  SELECT @GrupoTrabajo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'GrupoTrabajo'
  SELECT @Departamento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Departamento'
  SELECT @Contrasena = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Contrasena'
  SELECT @ContrasenaConfirmacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ContrasenaConfirmacion'
  SELECT @ContrasenaFecha = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ContrasenaFecha'
  SELECT @ContrasenaModificar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ContrasenaModificar'
  SELECT @Telefono = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Telefono'
  SELECT @Extencion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Extencion'
  SELECT @DefAgente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefAgente'
  SELECT @DefCajero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DefCajero'
  SELECT @DefAlmacen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefAlmacen'
  SELECT @DefAlmacenTrans = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefAlmacenTrans'
  SELECT @DefCtaDinero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefCtaDinero'
  SELECT @DefCtaDineroTrans = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefCtaDineroTrans'
  SELECT @DefMoneda = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefMoneda'
  SELECT @DefProyecto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefProyecto' 
  SELECT @DefLocalidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefLocalidad'
  SELECT @DefCliente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefCliente'
  SELECT @DefActividad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefActividad'
  SELECT @DefMovVentas = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefMovVentas'
  SELECT @DefZonaImpuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefZonaImpuesto'
  SELECT @DefFormaPago = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefFormaPago'
  SELECT @Afectar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Afectar'
  SELECT @Cancelar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Cancelar' 
  SELECT @Desafectar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Desafectar'
  SELECT @Autorizar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Autorizar'
  SELECT @AutorizarVenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AutorizarVenta'
  SELECT @AutorizarCxp = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AutorizarCxp'
  SELECT @AutorizarGasto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AutorizarGasto'
  SELECT @AutorizarDinero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AutorizarDinero'
  SELECT @AutorizarPV = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'AutorizarPV'
  SELECT @AutorizarCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AutorizarCompra'
  SELECT @AutorizarGestion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AutorizarGestion'
  SELECT @AutorizarSeriesLotes = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AutorizarSeriesLotes'
  SELECT @AfectarOtrosMovs = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AfectarOtrosMovs'
  SELECT @CancelarOtrosMovs = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CancelarOtrosMovs'
  SELECT @ConsultarOtrosMovs = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ConsultarOtrosMovs'
  SELECT @ConsultarOtrosMovsGrupo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ConsultarOtrosMovsGrupo'
  SELECT @ConsultarOtrasEmpresas = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ConsultarOtrasEmpresas'
  SELECT @ConsultarOtrasSucursales = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ConsultarOtrasSucursales'
  SELECT @AccesarOtrasSucursalesEnLinea = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AccesarOtrasSucursalesEnLinea'
  SELECT @AfectarOtrasSucursalesEnLinea = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AfectarOtrasSucursalesEnLinea'
  SELECT @ModificarOtrosMovs = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ModificarOtrosMovs'
  SELECT @ModificarVencimientos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarVencimientos'
  SELECT @ModificarEntregas = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarEntregas'
  SELECT @ModificarFechaRequerida = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ModificarFechaRequerida'
  SELECT @ModificarEnvios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarEnvios'
  SELECT @ModificarReferencias = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarReferencias'
  SELECT @ModificarAlmacenEntregas = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarAlmacenEntregas'
  SELECT @ModificarSituacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarSituacion'
  SELECT @ModificarAgente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ModificarAgente'
  SELECT @ModificarUsuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarUsuario'
  SELECT @ModificarListaPrecios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarListaPrecios'
  SELECT @ModificarZonaImpuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ModificarZonaImpuesto'
  SELECT @ModificarSucursalDestino = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarSucursalDestino'
  SELECT @ModificarProyUENActCC = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarProyUENActCC'
  SELECT @AgregarCteExpress = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'AgregarCteExpress'
  SELECT @AgregarArtExpress = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AgregarArtExpress'
  SELECT @Costos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Costos'
  SELECT @BloquearCostos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearCostos'
  SELECT @VerInfoDeudores = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'VerInfoDeudores'
  SELECT @VerInfoAcreedores = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'VerInfoAcreedores'
  SELECT @VerComisionesPendientes = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'VerComisionesPendientes'
  SELECT @BloquearEncabezadoVenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearEncabezadoVenta'
  SELECT @BloquearCxcCtaDinero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearCxcCtaDinero'
  SELECT @BloquearCxpCtaDinero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearCxpCtaDinero'
  SELECT @BloquearDineroCtaDinero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearDineroCtaDinero'
  SELECT @EnviarExcel = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'EnviarExcel'
  SELECT @ImprimirMovs = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ImprimirMovs'
  SELECT @PreliminarMovs = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'PreliminarMovs'
  SELECT @Reservar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Reservar'
  SELECT @DesReservar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DesReservar'
  SELECT @Asignar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Asignar'
  SELECT @DesAsignar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DesAsignar'
  SELECT @ModificarAlmacenPedidos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarAlmacenPedidos'
  SELECT @ModificarConceptos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ModificarConceptos'
  SELECT @ModificarReferenciasSiempre = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ModificarReferenciasSiempre'
  SELECT @ModificarAgenteCxcPendiente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarAgenteCxcPendiente'
  SELECT @ModificarMovsNominaVigentes = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarMovsNominaVigentes'
  SELECT @BloquearPrecios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearPrecios'
  SELECT @BloquearDescGlobal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearDescGlobal'
  SELECT @BloquearDescLinea = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearDescLinea'
  SELECT @BloquearCondiciones = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearCondiciones'
  SELECT @BloquearAlmacen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearAlmacen'
  SELECT @BloquearMoneda = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearMoneda'
  SELECT @BloquearAgente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearAgente'
  SELECT @BloquearFechaEmision = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearFechaEmision'
  SELECT @BloquearProyecto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearProyecto'
  SELECT @BloquearFormaPago = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearFormaPago'
  SELECT @Oficina = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Oficina'
  SELECT @DefArtTipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefArtTipo'
  SELECT @DefUnidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DefUnidad'
  SELECT @AbrirCajon = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AbrirCajon'
  SELECT @BloquearCobroInmediato = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'BloquearCobroInmediato'
  SELECT @ConsultarCompraPendiente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ConsultarCompraPendiente'
  SELECT @AccesoTotalCuentas = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AccesoTotalCuentas'
  SELECT @Estatus = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
   WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Estatus'
  SELECT @UltimoCambio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'UltimoCambio'
  SELECT @Alta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Alta'
  SELECT @Configuracion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Configuracion'
  SELECT @Acceso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Acceso'
  SELECT @TieneMovimientos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'TieneMovimientos'
  SELECT @Refacturar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Refacturar'
  SELECT @DefListaPreciosEsp = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefListaPreciosEsp'
  SELECT @LimiteTableroControl = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'LimiteTableroControl'
  SELECT @CteInfo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CteInfo'
  SELECT @CteBloquearOtrosDatos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CteBloquearOtrosDatos'
  SELECT @ArtBloquearOtrosDatos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ArtBloquearOtrosDatos'
  SELECT @CteSucursalVenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CteSucursalVenta'
  SELECT @CtaDineroInfo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CtaDineroInfo'
  SELECT @ImpresionInmediata = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ImpresionInmediata'
  SELECT @MostrarCampos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'MostrarCampos'
  SELECT @AsistentePrecios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AsistentePrecios'
  SELECT @CambioValidarCobertura = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CambioValidarCobertura'
  SELECT @CambioNormatividad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CambioNormatividad'
  SELECT @CambioEditarCobertura = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CambioEditarCobertura'
  SELECT @CambioVerPosicionEmpresa = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CambioVerPosicionEmpresa'
  SELECT @CambioVerPosicionSucursal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CambioVerPosicionSucursal'
  SELECT @CambioVerPosicionOtraSucursal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CambioVerPosicionOtraSucursal'
  SELECT @CambioAutorizarOperacionLimite = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CambioAutorizarOperacionLimite'
  SELECT @AutoDobleCapturaPrecios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AutoDobleCapturaPrecios'
  SELECT @AutoArtGrupo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'AutoArtGrupo'
  SELECT @AutoAgregarRecaudacionConsumo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AutoAgregarRecaudacionConsumo'
  SELECT @AutoDiesel = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AutoDiesel'
  SELECT @BloquearActividad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearActividad'
  SELECT @UEN = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'UEN'
  SELECT @eMail = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'eMail'
  SELECT @CteMov = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CteMov'
  SELECT @CteArt = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CteArt' 
  SELECT @ProvMov = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ProvMov'
  SELECT @ArtMov = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ArtMov'
  SELECT @DefContUso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'DefContUso' 
  SELECT @BloquearContUso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearContUso'
  SELECT @Observaciones = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Observaciones'
  SELECT @TraspasarTodo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'TraspasarTodo'
  SELECT @BloquearNotasNegativas = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'BloquearNotasNegativas'
  SELECT @ModificarSerieLoteProp = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ModificarSerieLoteProp'
  SELECT @NominaEliminacionParcial = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'NominaEliminacionParcial'
  SELECT @ModificarPropiedadesLotes = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarPropiedadesLotes'
  SELECT @PVAbrirCajonSiempre = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'PVAbrirCajonSiempre'
  SELECT @PVBloquearEgresos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'PVBloquearEgresos'
  SELECT @PVCobrarNotasEstatusBorrador = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'PVCobrarNotasEstatusBorrador'
  SELECT @PVModificarEstatusBorrador = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'PVModificarEstatusBorrador'
  SELECT @BloquearPersonalCfg = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearPersonalCfg'
  SELECT @BloquearFacturacionDirecta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearFacturacionDirecta'
  SELECT @BloquearInvSalidaDirecta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearInvSalidaDirecta'
  SELECT @Idioma = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Idioma'
  SELECT @ModificarDatosVIN = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ModificarDatosVIN'
  SELECT @ModificarDatosCliente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ModificarDatosCliente'
  SELECT @CxcExpress = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CxcExpress'
  SELECT @CxpExpress = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CxpExpress'
  SELECT @Cliente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Cliente'
  SELECT @SubModuloAtencion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'SubModuloAtencion'
  SELECT @BloquearCancelarFactura = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearCancelarFactura'
  SELECT @CambioPresentacionExpress = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CambioPresentacionExpress'
  SELECT @ModificarConsecutivos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarConsecutivos'
  SELECT @ModificarVINFechaBaja = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ModificarVINFechaBaja'
  SELECT @ModificarVINFechaPago = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarVINFechaPago'
  SELECT @ModificarVINAccesorio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarVINAccesorio'
  SELECT @PVEditarNota = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'PVEditarNota'
  SELECT @ModificarDescGlobalImporte = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ModificarDescGlobalImporte'
  SELECT @ConsultarClientesOtrosAgentes = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ConsultarClientesOtrosAgentes'
  SELECT @ACLCUsoEspecifico = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ACLCUsoEspecifico'
  SELECT @ACEditarTablaAmortizacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ACEditarTablaAmortizacion'
  SELECT @PlantillasOffice = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'PlantillasOffice'
  SELECT @ConfigPlantillasOffice = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ConfigPlantillasOffice'
  SELECT @ACTasaGrupo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ACTasaGrupo'
  SELECT @CambioAgregarBeneficiarios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CambioAgregarBeneficiarios'
  SELECT @AgregarConceptoExpress = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'AgregarConceptoExpress'
  SELECT @BloquearArtMaterial = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearArtMaterial'
  SELECT @InfoPath = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'InfoPath'
  SELECT @InfoPathExe = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'InfoPathExe'
  SELECT @FEA = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'FEA'
  SELECT @FEACertificado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'FEACertificado'
  SELECT @FEALlave = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'FEALlave'
  SELECT @ContrasenaNuncaExpira = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ContrasenaNuncaExpira'
  SELECT @Menu = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Menu'
  SELECT @MenuAccesoTotal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'MenuAccesoTotal'
  SELECT @BloquearPDF = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearPDF'
  SELECT @VerificarOrtografia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'VerificarOrtografia'
  SELECT @ContSinOrigen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ContSinOrigen'
  SELECT @UnidadOrganizacional = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'UnidadOrganizacional'
  SELECT @ProyectoMov = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ProyectoMov'
  SELECT @CompraDevTodo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CompraDevTodo'
  SELECT @BloquearWebContenido = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BloquearWebContenido'
  SELECT @BloquearWebHTML = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'BloquearWebHTML'
  SELECT @DBMailPerfil = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DBMailPerfil'
  SELECT @UltimoAcceso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'UltimoAcceso'
  SELECT @BloquearSituacionUsuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'BloquearSituacionUsuario'
  SELECT @InformacionConfidencial = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'InformacionConfidencial'
  SELECT @PerfilForma = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'PerfilForma'
  SELECT @Licenciamiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Licenciamiento'
  SELECT @SituacionArea = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'SituacionArea'
  SELECT @ModificarTipoImpuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ModificarTipoImpuesto'
  SELECT @AgregarProvExpress = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'AgregarProvExpress'
  SELECT @ProyMov = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'ProyMov'


  SELECT @Texto =(SELECT * FROM Usuario 
     WHERE ISNULL(Usuario,'' ) = ISNULL(ISNULL(@Usuario,Usuario),'') 
	 AND ISNULL(Nombre,'' ) = ISNULL(ISNULL(@Nombre,Nombre),'') 
	 AND ISNULL(Sucursal,'' ) = ISNULL(ISNULL(@Sucursal,Sucursal),'') 
	 AND ISNULL(DefEmpresa,'' ) = ISNULL(ISNULL(@DefEmpresa,DefEmpresa),'') 
	 AND ISNULL(GrupoTrabajo,'' ) = ISNULL(ISNULL(@GrupoTrabajo,GrupoTrabajo),'') 
	 AND ISNULL(Departamento,'' ) = ISNULL(ISNULL(@Departamento,Departamento),'') 
	 AND ISNULL(Contrasena,'' ) = ISNULL(ISNULL(@Contrasena,Contrasena),'') 
	 AND ISNULL(ContrasenaConfirmacion,'' ) = ISNULL(ISNULL(@ContrasenaConfirmacion,ContrasenaConfirmacion),'') 
	 AND ISNULL(ContrasenaFecha,'' ) = ISNULL(ISNULL(@ContrasenaFecha,ContrasenaFecha),'') 
	 AND ISNULL(ContrasenaModificar,'' ) = ISNULL(ISNULL(@ContrasenaModificar,ContrasenaModificar),'') 
	 AND ISNULL(Telefono,'' ) = ISNULL(ISNULL(@Telefono,Telefono),'') 
	 AND ISNULL(Extencion,'' ) = ISNULL(ISNULL(@Extencion,Extencion),'') 
	 AND ISNULL(DefAgente,'' ) = ISNULL(ISNULL(@DefAgente,DefAgente),'') 
	 AND ISNULL(DefCajero,'' ) = ISNULL(ISNULL(@DefCajero,DefCajero),'') 
	 AND ISNULL(DefAlmacen,'' ) = ISNULL(ISNULL(@DefAlmacen,DefAlmacen),'') 
	 AND ISNULL(DefAlmacenTrans,'' ) = ISNULL(ISNULL(@DefAlmacenTrans,DefAlmacenTrans),'') 
	 AND ISNULL(DefCtaDinero,'' ) = ISNULL(ISNULL(@DefCtaDinero,DefCtaDinero),'') 
	 AND ISNULL(DefCtaDineroTrans,'' ) = ISNULL(ISNULL(@DefCtaDineroTrans,DefCtaDineroTrans),'') 
	 AND ISNULL(DefMoneda,'' ) = ISNULL(ISNULL(@DefMoneda,DefMoneda),'') 
	 AND ISNULL(DefProyecto,'' ) = ISNULL(ISNULL(@DefProyecto,DefProyecto),'') 
	 AND ISNULL(DefLocalidad,'' ) = ISNULL(ISNULL(@DefLocalidad,DefLocalidad),'') 
	 AND ISNULL(DefCliente,'' ) = ISNULL(ISNULL(@DefCliente,DefCliente),'') 
	 AND ISNULL(DefActividad,'' ) = ISNULL(ISNULL(@DefActividad,DefActividad),'') 
	 AND ISNULL(DefMovVentas,'' ) = ISNULL(ISNULL(@DefMovVentas,DefMovVentas),'') 
	 AND ISNULL(DefZonaImpuesto,'' ) = ISNULL(ISNULL(@DefZonaImpuesto,DefZonaImpuesto),'') 
	 AND ISNULL(DefFormaPago,'' ) = ISNULL(ISNULL(@DefFormaPago,DefFormaPago),'') 
	 AND ISNULL(Afectar,'' ) = ISNULL(ISNULL(@Afectar,Afectar),'') 
	 AND ISNULL(Cancelar,'' ) = ISNULL(ISNULL(@Cancelar,Cancelar),'') 
	 AND ISNULL(Desafectar,'' ) = ISNULL(ISNULL(@Desafectar,Desafectar),'') 
	 AND ISNULL(Autorizar,'' ) = ISNULL(ISNULL(@Autorizar,Autorizar),'') 
	 AND ISNULL(AutorizarVenta,'' ) = ISNULL(ISNULL(@AutorizarVenta,AutorizarVenta),'') 
	 AND ISNULL(AutorizarCxp,'' ) = ISNULL(ISNULL(@AutorizarCxp,AutorizarCxp),'') 
	 AND ISNULL(AutorizarGasto,'' ) = ISNULL(ISNULL(@AutorizarGasto,AutorizarGasto),'') 
	 AND ISNULL(AutorizarDinero,'' ) = ISNULL(ISNULL(@AutorizarDinero,AutorizarDinero),'') 
	 AND ISNULL(AutorizarPV,'' ) = ISNULL(ISNULL(@AutorizarPV,AutorizarPV),'') 
	 AND ISNULL(AutorizarCompra,'' ) = ISNULL(ISNULL(@AutorizarCompra,AutorizarCompra),'') 
	 AND ISNULL(AutorizarGestion,'' ) = ISNULL(ISNULL(@AutorizarGestion,AutorizarGestion),'') 
	 AND ISNULL(AutorizarSeriesLotes,'' ) = ISNULL(ISNULL(@AutorizarSeriesLotes,AutorizarSeriesLotes),'') 
	 AND ISNULL(AfectarOtrosMovs,'' ) = ISNULL(ISNULL(@AfectarOtrosMovs,AfectarOtrosMovs),'') 
	 AND ISNULL(CancelarOtrosMovs,'' ) = ISNULL(ISNULL(@CancelarOtrosMovs,CancelarOtrosMovs),'') 
	 AND ISNULL(ConsultarOtrosMovs,'' ) = ISNULL(ISNULL(@ConsultarOtrosMovs,ConsultarOtrosMovs),'') 
	 AND ISNULL(ConsultarOtrosMovsGrupo,'' ) = ISNULL(ISNULL(@ConsultarOtrosMovsGrupo,ConsultarOtrosMovsGrupo),'') 
	 AND ISNULL(ConsultarOtrasEmpresas,'' ) = ISNULL(ISNULL(@ConsultarOtrasEmpresas,ConsultarOtrasEmpresas),'') 
	 AND ISNULL(ConsultarOtrasSucursales,'' ) = ISNULL(ISNULL(@ConsultarOtrasSucursales,ConsultarOtrasSucursales),'') 
	 AND ISNULL(AccesarOtrasSucursalesEnLinea,'' ) = ISNULL(ISNULL(@AccesarOtrasSucursalesEnLinea,AccesarOtrasSucursalesEnLinea),'') 
	 AND ISNULL(AfectarOtrasSucursalesEnLinea,'' ) = ISNULL(ISNULL(@AfectarOtrasSucursalesEnLinea,AfectarOtrasSucursalesEnLinea),'') 
	 AND ISNULL(ModificarOtrosMovs,'' ) = ISNULL(ISNULL(@ModificarOtrosMovs,ModificarOtrosMovs),'') 
	 AND ISNULL(ModificarVencimientos,'' ) = ISNULL(ISNULL(@ModificarVencimientos,ModificarVencimientos),'') 
	 AND ISNULL(ModificarEntregas,'' ) = ISNULL(ISNULL(@ModificarEntregas,ModificarEntregas),'') 
	 AND ISNULL(ModificarFechaRequerida,'' ) = ISNULL(ISNULL(@ModificarFechaRequerida,ModificarFechaRequerida),'') 
	 AND ISNULL(ModificarEnvios,'' ) = ISNULL(ISNULL(@ModificarEnvios,ModificarEnvios),'') 
	 AND ISNULL(ModificarReferencias,'' ) = ISNULL(ISNULL(@ModificarReferencias,ModificarReferencias),'') 
	 AND ISNULL(ModificarAlmacenEntregas,'' ) = ISNULL(ISNULL(@ModificarAlmacenEntregas,ModificarAlmacenEntregas),'') 
	 AND ISNULL(ModificarSituacion,'' ) = ISNULL(ISNULL(@ModificarSituacion,ModificarSituacion),'') 
	 AND ISNULL(ModificarAgente,'' ) = ISNULL(ISNULL(@ModificarAgente,ModificarAgente),'') 
	 AND ISNULL(ModificarUsuario,'' ) = ISNULL(ISNULL(@ModificarUsuario,ModificarUsuario),'') 
	 AND ISNULL(ModificarListaPrecios,'' ) = ISNULL(ISNULL(@ModificarListaPrecios,ModificarListaPrecios),'') 
	 AND ISNULL(ModificarZonaImpuesto,'' ) = ISNULL(ISNULL(@ModificarZonaImpuesto,ModificarZonaImpuesto),'') 
	 AND ISNULL(ModificarSucursalDestino,'' ) = ISNULL(ISNULL(@ModificarSucursalDestino,ModificarSucursalDestino),'') 
	 AND ISNULL(ModificarProyUENActCC,'' ) = ISNULL(ISNULL(@ModificarProyUENActCC,ModificarProyUENActCC),'') 
	 AND ISNULL(AgregarCteExpress,'' ) = ISNULL(ISNULL(@AgregarCteExpress,AgregarCteExpress),'') 
	 AND ISNULL(AgregarArtExpress,'' ) = ISNULL(ISNULL(@AgregarArtExpress,AgregarArtExpress),'') 
	 AND ISNULL(Costos,'' ) = ISNULL(ISNULL(@Costos,Costos),'') 
	 AND ISNULL(BloquearCostos,'' ) = ISNULL(ISNULL(@BloquearCostos,BloquearCostos),'') 
	 AND ISNULL(VerInfoDeudores,'' ) = ISNULL(ISNULL(@VerInfoDeudores,VerInfoDeudores),'') 
	 AND ISNULL(VerInfoAcreedores,'' ) = ISNULL(ISNULL(@VerInfoAcreedores,VerInfoAcreedores),'') 
	 AND ISNULL(VerComisionesPendientes,'' ) = ISNULL(ISNULL(@VerComisionesPendientes,VerComisionesPendientes),'') 
	 AND ISNULL(BloquearEncabezadoVenta,'' ) = ISNULL(ISNULL(@BloquearEncabezadoVenta,BloquearEncabezadoVenta),'') 
	 AND ISNULL(BloquearCxcCtaDinero,'' ) = ISNULL(ISNULL(@BloquearCxcCtaDinero,BloquearCxcCtaDinero),'') 
	 AND ISNULL(BloquearCxpCtaDinero,'' ) = ISNULL(ISNULL(@BloquearCxpCtaDinero,BloquearCxpCtaDinero),'') 
	 AND ISNULL(BloquearDineroCtaDinero,'' ) = ISNULL(ISNULL(@BloquearDineroCtaDinero,BloquearDineroCtaDinero),'') 
	 AND ISNULL(EnviarExcel,'' ) = ISNULL(ISNULL(@EnviarExcel,EnviarExcel),'') 
	 AND ISNULL(ImprimirMovs,'' ) = ISNULL(ISNULL(@ImprimirMovs,ImprimirMovs),'') 
	 AND ISNULL(PreliminarMovs,'' ) = ISNULL(ISNULL(@PreliminarMovs,PreliminarMovs),'') 
	 AND ISNULL(Reservar,'' ) = ISNULL(ISNULL(@Reservar,Reservar),'') 
	 AND ISNULL(DesReservar,'' ) = ISNULL(ISNULL(@DesReservar,DesReservar),'') 
	 AND ISNULL(Asignar,'' ) = ISNULL(ISNULL(@Asignar,Asignar),'') 
	 AND ISNULL(DesAsignar,'' ) = ISNULL(ISNULL(@DesAsignar,DesAsignar),'') 
	 AND ISNULL(ModificarAlmacenPedidos,'' ) = ISNULL(ISNULL(@ModificarAlmacenPedidos,ModificarAlmacenPedidos),'') 
	 AND ISNULL(ModificarConceptos,'' ) = ISNULL(ISNULL(@ModificarConceptos,ModificarConceptos),'') 
	 AND ISNULL(ModificarReferenciasSiempre,'' ) = ISNULL(ISNULL(@ModificarReferenciasSiempre,ModificarReferenciasSiempre),'') 
	 AND ISNULL(ModificarAgenteCxcPendiente,'' ) = ISNULL(ISNULL(@ModificarAgenteCxcPendiente,ModificarAgenteCxcPendiente),'') 
	 AND ISNULL(ModificarMovsNominaVigentes,'' ) = ISNULL(ISNULL(@ModificarMovsNominaVigentes,ModificarMovsNominaVigentes),'') 
	 AND ISNULL(BloquearPrecios,'' ) = ISNULL(ISNULL(@BloquearPrecios,BloquearPrecios),'') 
	 AND ISNULL(BloquearDescGlobal,'' ) = ISNULL(ISNULL(@BloquearDescGlobal,BloquearDescGlobal),'') 
	 AND ISNULL(BloquearDescLinea,'' ) = ISNULL(ISNULL(@BloquearDescLinea,BloquearDescLinea),'') 
	 AND ISNULL(BloquearCondiciones,'' ) = ISNULL(ISNULL(@BloquearCondiciones,BloquearCondiciones),'') 
	 AND ISNULL(BloquearAlmacen,'' ) = ISNULL(ISNULL(@BloquearAlmacen,BloquearAlmacen),'') 
	 AND ISNULL(BloquearMoneda,'' ) = ISNULL(ISNULL(@BloquearMoneda,BloquearMoneda),'') 
	 AND ISNULL(BloquearAgente,'' ) = ISNULL(ISNULL(@BloquearAgente,BloquearAgente),'') 
	 AND ISNULL(BloquearFechaEmision,'' ) = ISNULL(ISNULL(@BloquearFechaEmision,BloquearFechaEmision),'') 
	 AND ISNULL(BloquearProyecto,'' ) = ISNULL(ISNULL(@BloquearProyecto,BloquearProyecto),'') 
	 AND ISNULL(BloquearFormaPago,'' ) = ISNULL(ISNULL(@BloquearFormaPago,BloquearFormaPago),'') 
	 AND ISNULL(Oficina,'' ) = ISNULL(ISNULL(@Oficina,Oficina),'') 
	 AND ISNULL(DefArtTipo,'' ) = ISNULL(ISNULL(@DefArtTipo,DefArtTipo),'') 
	 AND ISNULL(DefUnidad,'' ) = ISNULL(ISNULL(@DefUnidad,DefUnidad),'') 
	 AND ISNULL(AbrirCajon,'' ) = ISNULL(ISNULL(@AbrirCajon,AbrirCajon),'') 
	 AND ISNULL(BloquearCobroInmediato,'' ) = ISNULL(ISNULL(@BloquearCobroInmediato,BloquearCobroInmediato),'') 
	 AND ISNULL(ConsultarCompraPendiente,'' ) = ISNULL(ISNULL(@ConsultarCompraPendiente,ConsultarCompraPendiente),'') 
	 AND ISNULL(AccesoTotalCuentas,'' ) = ISNULL(ISNULL(@AccesoTotalCuentas,AccesoTotalCuentas),'') 
	 AND ISNULL(Estatus,'' ) = ISNULL(ISNULL(@Estatus,Estatus),'') 
	 AND ISNULL(UltimoCambio,'' ) = ISNULL(ISNULL(@UltimoCambio,UltimoCambio),'') 
	 AND ISNULL(Alta,'' ) = ISNULL(ISNULL(@Alta,Alta),'') 
	 AND ISNULL(Configuracion,'' ) = ISNULL(ISNULL(@Configuracion,Configuracion),'') 
	 AND ISNULL(Acceso,'' ) = ISNULL(ISNULL(@Acceso,Acceso),'') 
	 AND ISNULL(TieneMovimientos,'' ) = ISNULL(ISNULL(@TieneMovimientos,TieneMovimientos),'') 
	 AND ISNULL(Refacturar,'' ) = ISNULL(ISNULL(@Refacturar,Refacturar),'') 
	 AND ISNULL(DefListaPreciosEsp,'' ) = ISNULL(ISNULL(@DefListaPreciosEsp,DefListaPreciosEsp),'') 
	 AND ISNULL(LimiteTableroControl,'' ) = ISNULL(ISNULL(@LimiteTableroControl,LimiteTableroControl),'') 
	 AND ISNULL(CteInfo,'' ) = ISNULL(ISNULL(@CteInfo,CteInfo),'') 
	 AND ISNULL(CteBloquearOtrosDatos,'' ) = ISNULL(ISNULL(@CteBloquearOtrosDatos,CteBloquearOtrosDatos),'') 
	 AND ISNULL(ArtBloquearOtrosDatos,'' ) = ISNULL(ISNULL(@ArtBloquearOtrosDatos,ArtBloquearOtrosDatos),'') 
	 AND ISNULL(CteSucursalVenta,'' ) = ISNULL(ISNULL(@CteSucursalVenta,CteSucursalVenta),'') 
	 AND ISNULL(CtaDineroInfo,'' ) = ISNULL(ISNULL(@CtaDineroInfo,CtaDineroInfo),'') 
	 AND ISNULL(ImpresionInmediata,'' ) = ISNULL(ISNULL(@ImpresionInmediata,ImpresionInmediata),'') 
	 AND ISNULL(MostrarCampos,'' ) = ISNULL(ISNULL(@MostrarCampos,MostrarCampos),'') 
	 AND ISNULL(AsistentePrecios,'' ) = ISNULL(ISNULL(@AsistentePrecios,AsistentePrecios),'') 
	 AND ISNULL(CambioValidarCobertura,'' ) = ISNULL(ISNULL(@CambioValidarCobertura,CambioValidarCobertura),'') 
	 AND ISNULL(CambioNormatividad,'' ) = ISNULL(ISNULL(@CambioNormatividad,CambioNormatividad),'') 
	 AND ISNULL(CambioEditarCobertura,'' ) = ISNULL(ISNULL(@CambioEditarCobertura,CambioEditarCobertura),'') 
	 AND ISNULL(CambioVerPosicionEmpresa,'' ) = ISNULL(ISNULL(@CambioVerPosicionEmpresa,CambioVerPosicionEmpresa),'') 
	 AND ISNULL(CambioVerPosicionSucursal,'' ) = ISNULL(ISNULL(@CambioVerPosicionSucursal,CambioVerPosicionSucursal),'') 
	 AND ISNULL(CambioVerPosicionOtraSucursal,'' ) = ISNULL(ISNULL(@CambioVerPosicionOtraSucursal,CambioVerPosicionOtraSucursal),'') 
	 AND ISNULL(CambioAutorizarOperacionLimite,'' ) = ISNULL(ISNULL(@CambioAutorizarOperacionLimite,CambioAutorizarOperacionLimite),'') 
	 AND ISNULL(AutoDobleCapturaPrecios,'' ) = ISNULL(ISNULL(@AutoDobleCapturaPrecios,AutoDobleCapturaPrecios),'') 
	 AND ISNULL(AutoArtGrupo,'' ) = ISNULL(ISNULL(@AutoArtGrupo,AutoArtGrupo),'') 
	 AND ISNULL(AutoAgregarRecaudacionConsumo,'' ) = ISNULL(ISNULL(@AutoAgregarRecaudacionConsumo,AutoAgregarRecaudacionConsumo),'') 
	 AND ISNULL(AutoDiesel,'' ) = ISNULL(ISNULL(@AutoDiesel,AutoDiesel),'') 
	 AND ISNULL(BloquearActividad,'' ) = ISNULL(ISNULL(@BloquearActividad,BloquearActividad),'') 
	 AND ISNULL(UEN,'' ) = ISNULL(ISNULL(@UEN,UEN),'') 
	 AND ISNULL(eMail,'' ) = ISNULL(ISNULL(@eMail,eMail),'') 
	 AND ISNULL(CteMov,'' ) = ISNULL(ISNULL(@CteMov,CteMov),'') 
	 AND ISNULL(CteArt,'' ) = ISNULL(ISNULL(@CteArt,CteArt),'') 
	 AND ISNULL(ProvMov,'' ) = ISNULL(ISNULL(@ProvMov,ProvMov),'') 
	 AND ISNULL(ArtMov,'' ) = ISNULL(ISNULL(@ArtMov,ArtMov),'') 
	 AND ISNULL(DefContUso,'' ) = ISNULL(ISNULL(@DefContUso,DefContUso),'') 
	 AND ISNULL(BloquearContUso,'' ) = ISNULL(ISNULL(@BloquearContUso,BloquearContUso),'') 
	 AND ISNULL(Observaciones,'' ) = ISNULL(ISNULL(@Observaciones,Observaciones),'') 
	 AND ISNULL(TraspasarTodo,'' ) = ISNULL(ISNULL(@TraspasarTodo,TraspasarTodo),'') 
	 AND ISNULL(BloquearNotasNegativas,'' ) = ISNULL(ISNULL(@BloquearNotasNegativas,BloquearNotasNegativas),'') 
	 AND ISNULL(ModificarSerieLoteProp,'' ) = ISNULL(ISNULL(@ModificarSerieLoteProp,ModificarSerieLoteProp),'') 
	 AND ISNULL(NominaEliminacionParcial,'' ) = ISNULL(ISNULL(@NominaEliminacionParcial,NominaEliminacionParcial),'') 
	 AND ISNULL(ModificarPropiedadesLotes,'' ) = ISNULL(ISNULL(@ModificarPropiedadesLotes,ModificarPropiedadesLotes),'') 
	 AND ISNULL(PVAbrirCajonSiempre,'' ) = ISNULL(ISNULL(@PVAbrirCajonSiempre,PVAbrirCajonSiempre),'') 
	 AND ISNULL(PVBloquearEgresos,'' ) = ISNULL(ISNULL(@PVBloquearEgresos,PVBloquearEgresos),'') 
	 AND ISNULL(PVCobrarNotasEstatusBorrador,'' ) = ISNULL(ISNULL(@PVCobrarNotasEstatusBorrador,PVCobrarNotasEstatusBorrador),'') 
	 AND ISNULL(PVModificarEstatusBorrador,'' ) = ISNULL(ISNULL(@PVModificarEstatusBorrador,PVModificarEstatusBorrador),'') 
	 AND ISNULL(BloquearPersonalCfg,'' ) = ISNULL(ISNULL(@BloquearPersonalCfg,BloquearPersonalCfg),'') 
	 AND ISNULL(BloquearFacturacionDirecta,'' ) = ISNULL(ISNULL(@BloquearFacturacionDirecta,BloquearFacturacionDirecta),'') 
	 AND ISNULL(BloquearInvSalidaDirecta,'' ) = ISNULL(ISNULL(@BloquearInvSalidaDirecta,BloquearInvSalidaDirecta),'') 
	 AND ISNULL(Idioma,'' ) = ISNULL(ISNULL(@Idioma,Idioma),'') 
	 AND ISNULL(ModificarDatosVIN,'' ) = ISNULL(ISNULL(@ModificarDatosVIN,ModificarDatosVIN),'') 
	 AND ISNULL(ModificarDatosCliente,'' ) = ISNULL(ISNULL(@ModificarDatosCliente,ModificarDatosCliente),'') 
	 AND ISNULL(CxcExpress,'' ) = ISNULL(ISNULL(@CxcExpress,CxcExpress),'') 
	 AND ISNULL(CxpExpress,'' ) = ISNULL(ISNULL(@CxpExpress,CxpExpress),'') 
	 AND ISNULL(Cliente,'' ) = ISNULL(ISNULL(@Cliente,Cliente),'') 
	 AND ISNULL(SubModuloAtencion,'' ) = ISNULL(ISNULL(@SubModuloAtencion,SubModuloAtencion),'') 
	 AND ISNULL(BloquearCancelarFactura,'' ) = ISNULL(ISNULL(@BloquearCancelarFactura,BloquearCancelarFactura),'') 
	 AND ISNULL(CambioPresentacionExpress,'' ) = ISNULL(ISNULL(@CambioPresentacionExpress,CambioPresentacionExpress),'') 
	 AND ISNULL(ModificarConsecutivos,'' ) = ISNULL(ISNULL(@ModificarConsecutivos,ModificarConsecutivos),'') 
	 AND ISNULL(ModificarVINFechaBaja,'' ) = ISNULL(ISNULL(@ModificarVINFechaBaja,ModificarVINFechaBaja),'') 
	 AND ISNULL(ModificarVINFechaPago,'' ) = ISNULL(ISNULL(@ModificarVINFechaPago,ModificarVINFechaPago),'') 
	 AND ISNULL(ModificarVINAccesorio,'' ) = ISNULL(ISNULL(@ModificarVINAccesorio,ModificarVINAccesorio),'') 
	 AND ISNULL(PVEditarNota,'' ) = ISNULL(ISNULL(@PVEditarNota,PVEditarNota),'') 
	 AND ISNULL(ModificarDescGlobalImporte,'' ) = ISNULL(ISNULL(@ModificarDescGlobalImporte,ModificarDescGlobalImporte),'') 
	 AND ISNULL(ConsultarClientesOtrosAgentes,'' ) = ISNULL(ISNULL(@ConsultarClientesOtrosAgentes,ConsultarClientesOtrosAgentes),'') 
	 AND ISNULL(ACLCUsoEspecifico,'' ) = ISNULL(ISNULL(@ACLCUsoEspecifico,ACLCUsoEspecifico),'') 
	 AND ISNULL(ACEditarTablaAmortizacion,'' ) = ISNULL(ISNULL(@ACEditarTablaAmortizacion,ACEditarTablaAmortizacion),'') 
	 AND ISNULL(PlantillasOffice,'' ) = ISNULL(ISNULL(@PlantillasOffice,PlantillasOffice),'') 
	 AND ISNULL(ConfigPlantillasOffice,'' ) = ISNULL(ISNULL(@ConfigPlantillasOffice,ConfigPlantillasOffice),'') 
	 AND ISNULL(ACTasaGrupo,'' ) = ISNULL(ISNULL(@ACTasaGrupo,ACTasaGrupo),'') 
	 AND ISNULL(CambioAgregarBeneficiarios,'' ) = ISNULL(ISNULL(@CambioAgregarBeneficiarios,CambioAgregarBeneficiarios),'') 
	 AND ISNULL(AgregarConceptoExpress,'' ) = ISNULL(ISNULL(@AgregarConceptoExpress,AgregarConceptoExpress),'') 
	 AND ISNULL(BloquearArtMaterial,'' ) = ISNULL(ISNULL(@BloquearArtMaterial,BloquearArtMaterial),'') 
	 AND ISNULL(InfoPath,'' ) = ISNULL(ISNULL(@InfoPath,InfoPath),'') 
	 AND ISNULL(InfoPathExe,'' ) = ISNULL(ISNULL(@InfoPathExe,InfoPathExe),'') 
	 AND ISNULL(FEA,'' ) = ISNULL(ISNULL(@FEA,FEA),'') 
	 AND ISNULL(FEACertificado,'' ) = ISNULL(ISNULL(@FEACertificado,FEACertificado),'') 
	 AND ISNULL(FEALlave,'' ) = ISNULL(ISNULL(@FEALlave,FEALlave),'') 
	 AND ISNULL(ContrasenaNuncaExpira,'' ) = ISNULL(ISNULL(@ContrasenaNuncaExpira,ContrasenaNuncaExpira),'') 
	 AND ISNULL(Menu,'' ) = ISNULL(ISNULL(@Menu,Menu),'') 
	 AND ISNULL(MenuAccesoTotal,'' ) = ISNULL(ISNULL(@MenuAccesoTotal,MenuAccesoTotal),'') 
	 AND ISNULL(BloquearPDF,'' ) = ISNULL(ISNULL(@BloquearPDF,BloquearPDF),'') 
	 AND ISNULL(VerificarOrtografia,'' ) = ISNULL(ISNULL(@VerificarOrtografia,VerificarOrtografia),'') 
	 AND ISNULL(ContSinOrigen,'' ) = ISNULL(ISNULL(@ContSinOrigen,ContSinOrigen),'') 
	 AND ISNULL(UnidadOrganizacional,'' ) = ISNULL(ISNULL(@UnidadOrganizacional,UnidadOrganizacional),'') 
	 AND ISNULL(ProyectoMov,'' ) = ISNULL(ISNULL(@ProyectoMov,ProyectoMov),'') 
	 AND ISNULL(CompraDevTodo,'' ) = ISNULL(ISNULL(@CompraDevTodo,CompraDevTodo),'') 
	 AND ISNULL(BloquearWebContenido,'' ) = ISNULL(ISNULL(@BloquearWebContenido,BloquearWebContenido),'') 
	 AND ISNULL(BloquearWebHTML,'' ) = ISNULL(ISNULL(@BloquearWebHTML,BloquearWebHTML),'') 
	 AND ISNULL(DBMailPerfil,'' ) = ISNULL(ISNULL(@DBMailPerfil,DBMailPerfil),'') 
	 AND ISNULL(UltimoAcceso,'' ) = ISNULL(ISNULL(@UltimoAcceso,UltimoAcceso),'') 
	 AND ISNULL(BloquearSituacionUsuario,'' ) = ISNULL(ISNULL(@BloquearSituacionUsuario,BloquearSituacionUsuario),'') 
	 AND ISNULL(InformacionConfidencial,'' ) = ISNULL(ISNULL(@InformacionConfidencial,InformacionConfidencial),'') 
	 AND ISNULL(PerfilForma,'' ) = ISNULL(ISNULL(@PerfilForma,PerfilForma),'') 
	 AND ISNULL(Licenciamiento,'' ) = ISNULL(ISNULL(@Licenciamiento,Licenciamiento),'') 
	 AND ISNULL(SituacionArea,'' ) = ISNULL(ISNULL(@SituacionArea,SituacionArea),'') 
	 AND ISNULL(ModificarTipoImpuesto,'' ) = ISNULL(ISNULL(@ModificarTipoImpuesto,ModificarTipoImpuesto),'') 
	 AND ISNULL(AgregarProvExpress,'' ) = ISNULL(ISNULL(@AgregarProvExpress,AgregarProvExpress),'') 
	 AND ISNULL(ProyMov,'' ) = ISNULL(ISNULL(@ProyMov,ProyMov),'')    			
		  FOR XML AUTO)	

    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
  
    SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'
 
  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
   BEGIN
     COMMIT TRANSACTION 
   END ELSE
    BEGIN
      ROLLBACK TRANSACTION 
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')    
    END
  END
END
GO
SET DATEFIRST 7
SET ANSI_NULLS OFF
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET LOCK_TIMEOUT -1
SET QUOTED_IDENTIFIER OFF
SET ARITHABORT OFF 
GO


/**************** spIntelisisVTASMovListado  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisVTASMovListado') and type = 'P') drop procedure dbo.spIntelisisVTASMovListado
GO             
CREATE PROCEDURE spIntelisisVTASMovListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
 
        @IDO					int   , 
		@Empresa				varchar(5), 
		@Mov					varchar(20), 
		@MovID					varchar(20), 
		@FechaEmision			datetime   , 
		@UltimoCambio			datetime   , 
		@Concepto				varchar(50), 
		@Proyecto				varchar(50), 
		@UEN					int   , 
        @Moneda					varchar(10), 
        @TipoCambio			    float   , 
        @Usuario				varchar(10), 
        @Autorizacion		    varchar(10), 
        @Referencia				varchar(50), 
        @DocFuente				int   , 
        @Observaciones			varchar(100), 
        @Estatus				varchar(15), 
        @Situacion				varchar(50), 
        @SituacionFecha			datetime   , 
        @SituacionUsuario		varchar(10), 
        @SituacionNota			varchar(100), 
        @Directo				bit   , 
        @Prioridad				varchar(10), 
        @RenglonID				int   , 
        @FechaOriginal			datetime   , 
        @Codigo					varchar(30), 
        @Cliente				varchar(10), 
        @EnviarA				int   , 
        @Almacen				varchar(10), 
        @AlmacenDestino			varchar(10), 
        @Agente					varchar(10), 
        @AgenteServicio			varchar(10), 
        @AgenteComision			float   , 
        @FormaEnvio				varchar(50), 
        @FechaRequerida			datetime   , 
        @HoraRequerida			varchar(5), 
        @FechaProgramadaEnvio   datetime   , 
        @FechaOrdenCompra		datetime   , 
        @ReferenciaOrdenCompra  varchar(50), 
        @OrdenCompra			varchar(50), 
        @Condicion				varchar(50), 
        @Vencimiento			datetime   , 
        @CtaDinero				varchar(10), 
        @Descuento				varchar(30), 
        @DescuentoGlobal		float   , 
        @Importe				money   , 
        @Impuestos				money   , 
        @Saldo					money   , 
        @AnticiposFacturados	money   , 
        @AnticiposImpuestos		money   , 
        @Retencion				money   , 
        @DescuentoLineal		money   , 
        @ComisionTotal			money   ,
        @CostoTotal				money   , 
        @PrecioTotal			money   ,
        @Paquetes				int   , 
        @ServicioTipo			varchar(50), 
        @ServicioArticulo		varchar(20), 
        @ServicioSerie			varchar(50), 
        @ServicioContrato		varchar(20), 
        @ServicioContratoID		varchar(20), 
        @ServicioContratoTipo   varchar(50), 
        @ServicioGarantia		bit   , 
        @ServicioDescripcion	varchar(100), 
        @ServicioFecha			datetime   , 
        @ServicioFlotilla		bit   , 
        @ServicioRampa			bit   , 
        @ServicioIdentificador  varchar(20), 
        @ServicioPlacas			varchar(20), 
        @ServicioKms			int   , 
        @ServicioTipoOrden		varchar(20), 
        @ServicioTipoOperacion  varchar(50), 
        @ServicioSiniestro		varchar(20), 
        @ServicioExpress		bit   , 
        @ServicioDemerito		bit   , 
        @ServicioDeducible		bit   , 
        @ServicioDeducibleImporte   money   , 
        @ServicioNumero			float   , 
        @ServicioNumeroEconomico  varchar(20), 
        @ServicioAseguradora	varchar(10), 
        @ServicioPuntual		bit   , 
        @ServicioPoliza			varchar(20), 
        @OrigenTipo				varchar(10), 
        @Origen					varchar(20), 
        @OrigenID				varchar(20),
        @Poliza					varchar(20),
        @PolizaID				varchar(20),
        @GenerarPoliza			bit   ,
        @ContID					int   ,
        @Ejercicio				int   ,
        @Periodo				int   ,
        @FechaRegistro			datetime   ,
        @FechaConclusion		datetime   ,
        @FechaCancelacion		datetime   ,
        @FechaEntrega			datetime   ,
        @EmbarqueEstado			varchar(50),
        @EmbarqueGastos			money   ,
        @Peso					float   ,
        @Volumen				float   ,
        @Causa					varchar(50),
        @Atencion				varchar(50),
        @AtencionTelefono		varchar(50),
        @ListaPreciosEsp		varchar(20),
        @ZonaImpuesto			varchar(30),
        @Extra					bit   ,
        @CancelacionID			int   ,
        @Mensaje				int   ,
        @Departamento			int   ,
        @Sucursal				int   ,
        @GenerarOP				bit   ,
        @DesglosarImpuestos		bit   ,
        @DesglosarImpuesto2		bit   ,
        @ExcluirPlaneacion		bit   ,
        @ConVigencia			bit   ,
        @VigenciaDesde			datetime   ,
        @VigenciaHasta			datetime   ,
        @Enganche				money   ,
        @Bonificacion			float   ,
        @IVAFiscal				float   ,
        @IEPSFiscal				float   ,
        @EstaImpreso			bit   ,
        @Periodicidad			varchar(20),
        @SubModulo				varchar(5),
        @ContUso				varchar(20),
        @Espacio				varchar(10),
        @AutoCorrida			varchar(20),
        @AutoCorridaHora		varchar(5),
        @AutoCorridaServicio	varchar(50),
        @AutoCorridaRol			varchar(50),
        @AutoCorridaOrigen		varchar(5),
        @AutoCorridaDestino		varchar(5),
        @AutoCorridaKms			int   ,
        @AutoCorridaLts			int   ,
        @AutoCorridaRuta		varchar(5),
        @AutoOperador2			varchar(10),
        @AutoBoleto				varchar(11),
        @AutoKms				int   ,
        @AutoKmsActuales		int   ,
        @AutoBomba				varchar(10),
        @AutoBombaContador		int   ,
        @Logico1				bit   ,
        @Logico2				bit   ,
        @Logico3				bit   ,
        @Logico4				bit   ,
        @DifCredito				money   ,
        @EspacioResultado		bit   ,
        @Clase					varchar(50),
        @Subclase				varchar(50),
        @GastoAcreedor			varchar(10),
        @GastoConcepto			varchar(50), 
        @Pagado					float   ,
        @GenerarDinero			bit   ,
        @Dinero					varchar(20),
        @DineroID				varchar(20),
        @DineroCtaDinero		varchar(10),
        @DineroConciliado		bit   ,
        @DineroFechaConciliacion datetime   ,
        @Extra1					bit   ,
        @Extra2					bit   ,
        @Extra3					bit   ,
        @Reabastecido			bit   ,
        @SucursalVenta			int   ,
        @AF						bit   ,
        @AFArticulo				varchar(20),
        @AFSerie				varchar(20),
        @ContratoTipo			varchar(50),
        @ContratoDescripcion	varchar(100),
        @ContratoSerie			varchar(20),
        @ContratoValor			money   ,
        @ContratoValorMoneda	varchar(10),
        @ContratoSeguro			varchar(20),
        @ContratoVencimiento	datetime   ,
        @ContratoResponsabl		varchar(10),
        @Incentivo				money   ,
        @IncentivoConcepto		varchar(50),
        @EndosarA				varchar(10),
        @InteresTasa			float   ,
        @InteresIVA				float   ,
        @AnexoID				int   ,
        @FordVisitoOASIS		bit   ,
        @LineaCredito			varchar(20),
        @TipoAmortizacion		varchar(20),
        @TipoTasa				varchar(20),
        @Comisiones				money   ,
        @ComisionesIVA			money   ,
        @CompraID				int   ,
        @OperacionRelevante		bit   ,
        @TieneTasaEsp			bit   ,
        @TasaEsp				float   ,
        @FormaPagoTipo			varchar(50),
        @SobrePrecio			float   ,
        @SincroID				timestamp   ,
        @SincroC				int   ,
        @SucursalOrigen			int   ,
        @SucursalDestino		int   ,
        @ContUso2				varchar(20),
        @ContUso3				varchar(20),
        @Actividad				varchar(50),
        @ContratoID				int   ,
        @ContratoMov			varchar(20),
        @ContratoMovID			varchar(20),
        @MAFCiclo				int   ,
        @TipoComprobante		varchar(20),
        @SustentoComprobante	varchar(20),
        @TipoIdentificacion		varchar(20),
        @DerechoDevolucion		bit   ,
        @Establecimiento		varchar(20),
        @PuntoEmision			varchar(50),
        @SecuencialSRI			varchar(50),
        @AutorizacionSRI		varchar(50),
        @VigenteA				datetime   ,
        @SecuenciaRetencion		varchar(50),
        @Comprobante			bit   ,
        @FechaContableMov		datetime   ,
  		@Texto					xml,
  		@Texto2					xml,
		@ReferenciaIS			varchar(100),
		@SubReferencia			varchar(100)


  BEGIN TRANSACTION 
  IF @Ok IS NULL
  BEGIN
  

   SELECT @IDO = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ID'
   SELECT @Empresa = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Empresa'
   SELECT @Mov = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Mov'
   SELECT @MovID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='MovID'
   SELECT @FechaEmision = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='FechaEmision'
   SELECT @UltimoCambio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='UltimoCambio'
   SELECT @Concepto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Concepto'
   SELECT @Proyecto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Proyecto'
   SELECT @UEN = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='UEN'
   SELECT @Moneda = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Moneda'
   SELECT @TipoCambio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='TipoCambio'
   SELECT @Usuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Usuario'
   SELECT @Autorizacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Autorizacion'
   SELECT @Referencia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
        WHERE Campo ='Referencia'
   SELECT @DocFuente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='DocFuente'
   SELECT @Observaciones = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Observaciones'
   SELECT @Estatus = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Estatus'
   SELECT @Situacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Situacion'
   SELECT @SituacionFecha = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='SituacionFecha'
   SELECT @SituacionUsuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='SituacionUsuario'
   SELECT @SituacionNota = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='SituacionNota'
   SELECT @Directo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Directo'
   SELECT @Prioridad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Prioridad'
   SELECT @RenglonID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='RenglonID'
   SELECT @FechaOriginal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='FechaOriginal'
   SELECT @Codigo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Codigo'
   SELECT @Cliente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Cliente'
   SELECT @EnviarA = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='EnviarA'
   SELECT @Almacen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Almacen'
   SELECT @AlmacenDestino = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AlmacenDestino'
   SELECT @Agente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Agente'
   SELECT @AgenteServicio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AgenteServicio'
   SELECT @AgenteComision = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AgenteComision'
   SELECT @FormaEnvio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='FormaEnvio'
   SELECT @FechaRequerida = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='FechaRequerida'
   SELECT @HoraRequerida = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='HoraRequerida'
   SELECT @FechaProgramadaEnvio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='FechaProgramadaEnvio'
   SELECT @FechaOrdenCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='FechaOrdenCompra'
   SELECT @ReferenciaOrdenCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ReferenciaOrdenCompra'
   SELECT @OrdenCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='OrdenCompra'
   SELECT @Condicion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Condicion'
   SELECT @Vencimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Vencimiento'
   SELECT @CtaDinero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='CtaDinero'
   SELECT @Descuento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Descuento'
   SELECT @DescuentoGlobal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='DescuentoGlobal'
   SELECT @Importe = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Importe'
   SELECT @Impuestos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Impuestos'
   SELECT @Saldo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Saldo'
   SELECT @AnticiposFacturados = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AnticiposFacturados'
   SELECT @AnticiposImpuestos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AnticiposImpuestos'
   SELECT @Retencion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Retencion'
   SELECT @DescuentoLineal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='DescuentoLineal'
   SELECT @ComisionTotal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ComisionTotal'
   SELECT @CostoTotal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='CostoTotal'
   SELECT @PrecioTotal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='PrecioTotal'
   SELECT @Paquetes = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Paquetes'
   SELECT @ServicioTipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioTipo'
   SELECT @ServicioArticulo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioArticulo'
   SELECT @ServicioSerie = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioSerie'
   SELECT @ServicioContrato = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioContrato'
   SELECT @ServicioContratoID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioContratoID'
   SELECT @ServicioContratoTipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioContratoTipo'
   SELECT @ServicioGarantia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioGarantia'
   SELECT @ServicioDescripcion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioDescripcion'
   SELECT @ServicioFecha = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioFecha'
   SELECT @ServicioFlotilla = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioFlotilla'
   SELECT @ServicioRampa = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioRampa'
   SELECT @ServicioIdentificador = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioIdentificador'
   SELECT @ServicioPlacas = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioPlacas'
   SELECT @ServicioKms = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioKms'
   SELECT @ServicioTipoOrden = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioTipoOrden'
   SELECT @ServicioTipoOperacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioTipoOperacion'
   SELECT @ServicioSiniestro = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioSiniestro'
   SELECT @ServicioExpress = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioExpress'
   SELECT @ServicioDemerito = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioDemerito'
   SELECT @ServicioDeducible = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioDeducible'
   SELECT @ServicioDeducibleImporte = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioDeducibleImporte'
   SELECT @ServicioNumero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioNumero'
   SELECT @ServicioNumeroEconomico = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioNumeroEconomico'
   SELECT @ServicioAseguradora = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioAseguradora'
   SELECT @ServicioPuntual = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioPuntual'
   SELECT @ServicioPoliza = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ServicioPoliza'
   SELECT @OrigenTipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='OrigenTipo'
   SELECT @Origen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Origen'
   SELECT @OrigenID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='OrigenID'
   SELECT @Poliza = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Poliza'
   SELECT @PolizaID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='PolizaID'
   SELECT @GenerarPoliza = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='GenerarPoliza'
   SELECT @ContID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContID'
   SELECT @Ejercicio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Ejercicio'
   SELECT @Periodo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Periodo'
   SELECT @FechaRegistro = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='FechaRegistro'
   SELECT @FechaConclusion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='FechaConclusion'
   SELECT @FechaCancelacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='FechaCancelacion'
   SELECT @FechaEntrega = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='FechaEntrega'
   SELECT @EmbarqueEstado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='EmbarqueEstado'
   SELECT @EmbarqueGastos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='EmbarqueGastos'
   SELECT @Peso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Peso'
   SELECT @Volumen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Volumen'
   SELECT @Causa = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Causa'
   SELECT @Atencion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Atencion'
   SELECT @AtencionTelefono = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AtencionTelefono'
   SELECT @ListaPreciosEsp = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ListaPreciosEsp'
   SELECT @ZonaImpuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ZonaImpuesto'
   SELECT @Extra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Extra'
   SELECT @CancelacionID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='CancelacionID'
   SELECT @Mensaje = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Mensaje'
   SELECT @Departamento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Departamento'
   SELECT @Sucursal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Sucursal'
   SELECT @GenerarOP = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='GenerarOP'
   SELECT @DesglosarImpuestos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='DesglosarImpuestos'
   SELECT @DesglosarImpuesto2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='DesglosarImpuesto2'
   SELECT @ExcluirPlaneacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ExcluirPlaneacion'
   SELECT @ConVigencia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ConVigencia'
   SELECT @VigenciaDesde = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='VigenciaDesde'
   SELECT @VigenciaHasta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='VigenciaHasta'
   SELECT @Enganche = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Enganche'
   SELECT @Bonificacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Bonificacion'
   SELECT @IVAFiscal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='IVAFiscal'
   SELECT @IEPSFiscal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='IEPSFiscal'
   SELECT @EstaImpreso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='EstaImpreso'
   SELECT @Periodicidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Periodicidad'
   SELECT @SubModulo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='SubModulo'
   SELECT @ContUso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContUso'
   SELECT @Espacio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Espacio'
   SELECT @AutoCorrida = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoCorrida'
   SELECT @AutoCorridaHora = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoCorridaHora'
   SELECT @AutoCorridaServicio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoCorridaServicio'
   SELECT @AutoCorridaRol = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoCorridaRol'
   SELECT @AutoCorridaOrigen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoCorridaOrigen'
   SELECT @AutoCorridaDestino = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoCorridaDestino'
   SELECT @AutoCorridaKms = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoCorridaKms'
   SELECT @AutoCorridaLts = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoCorridaLts'
   SELECT @AutoCorridaRuta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoCorridaRuta'
   SELECT @AutoOperador2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')     WITH(Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoOperador2'
   SELECT @AutoBoleto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoBoleto'
   SELECT @AutoKms = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoKms'
   SELECT @AutoKmsActuales = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoKmsActuales'
   SELECT @AutoBomba = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoBomba'
   SELECT @AutoBombaContador = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutoBombaContador'
   SELECT @Logico1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Logico1'
   SELECT @Logico2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Logico2'
   SELECT @Logico3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Logico3'
   SELECT @Logico4 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Logico4'
   SELECT @DifCredito = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='DifCredito'
   SELECT @EspacioResultado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='EspacioResultado'
   SELECT @Clase = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Clase'
   SELECT @Subclase = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Subclase'
   SELECT @GastoAcreedor = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='GastoAcreedor'
   SELECT @GastoConcepto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='GastoConcepto'
   SELECT @Pagado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Pagado'
   SELECT @GenerarDinero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='GenerarDinero'
   SELECT @Dinero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Dinero'
   SELECT @DineroID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='DineroID'
   SELECT @DineroCtaDinero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='DineroCtaDinero'
   SELECT @DineroConciliado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='DineroConciliado'
   SELECT @DineroFechaConciliacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='DineroFechaConciliacion'
   SELECT @Extra1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Extra1'
   SELECT @Extra2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Extra2'
   SELECT @Extra3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Extra3'
   SELECT @Reabastecido = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Reabastecido'
   SELECT @SucursalVenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='SucursalVenta'
   SELECT @AF = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AF'
   SELECT @AFArticulo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AFArticulo'
   SELECT @AFSerie = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AFSerie'
   SELECT @ContratoTipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContratoTipo'
   SELECT @ContratoDescripcion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContratoDescripcion'
   SELECT @ContratoSerie = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContratoSerie'
   SELECT @ContratoValor = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContratoValor'
   SELECT @ContratoValorMoneda = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContratoValorMoneda'
   SELECT @ContratoSeguro = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContratoSeguro'
   SELECT @ContratoVencimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContratoVencimiento'
   SELECT @Incentivo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Incentivo'
   SELECT @IncentivoConcepto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='IncentivoConcepto'
   SELECT @EndosarA = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='EndosarA'
   SELECT @InteresTasa = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='InteresTasa'
   SELECT @InteresIVA = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='InteresIVA'
   SELECT @AnexoID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AnexoID'
   SELECT @FordVisitoOASIS = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='FordVisitoOASIS'
   SELECT @LineaCredito = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='LineaCredito'
   SELECT @TipoAmortizacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='TipoAmortizacion'
   SELECT @TipoTasa = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='TipoTasa'
   SELECT @Comisiones = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Comisiones'
   SELECT @ComisionesIVA = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ComisionesIVA'
   SELECT @CompraID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='CompraID'
   SELECT @OperacionRelevante = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='OperacionRelevante'
   SELECT @TieneTasaEsp = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='TieneTasaEsp'
   SELECT @TasaEsp = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='TasaEsp'
   SELECT @FormaPagoTipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='FormaPagoTipo'
   SELECT @SobrePrecio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='SobrePrecio'
   SELECT @SincroC = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='SincroC'
   SELECT @SucursalOrigen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='SucursalOrigen'
   SELECT @SucursalDestino = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='SucursalDestino'
   SELECT @ContUso2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContUso2'
   SELECT @ContUso3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContUso3'
   SELECT @Actividad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Actividad'
   SELECT @ContratoID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContratoID'
   SELECT @ContratoMov = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContratoMov'
   SELECT @ContratoMovID = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='ContratoMovID'
   SELECT @MAFCiclo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='MAFCiclo'
   SELECT @TipoComprobante = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='TipoComprobante'
   SELECT @SustentoComprobante = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='SustentoComprobante'
   SELECT @TipoIdentificacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='TipoIdentificacion'
   SELECT @DerechoDevolucion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='DerechoDevolucion'
   SELECT @Establecimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Establecimiento'
   SELECT @PuntoEmision = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='PuntoEmision'
   SELECT @SecuencialSRI = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='SecuencialSRI'
   SELECT @AutorizacionSRI = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='AutorizacionSRI'
   SELECT @VigenteA = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='VigenteA'
   SELECT @SecuenciaRetencion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='SecuenciaRetencion'
   SELECT @Comprobante = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='Comprobante'
   SELECT @FechaContableMov = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
     WITH (Campo varchar(255), Valor varchar(255))
    WHERE Campo ='FechaContableMov'
  
  
  SELECT @Texto =(SELECT * FROM Venta
     WHERE ISNULL(ID,'') = ISNULL(ISNULL(@IDO,ID),'') 
       AND ISNULL(Empresa,'') = ISNULL(ISNULL(@Empresa,Empresa),'') 
       AND ISNULL(Mov,'') = ISNULL(ISNULL(@Mov,Mov),'') 
       AND ISNULL(MovID,'') = ISNULL(ISNULL(@MovID,MovID),'') 
       AND ISNULL(FechaEmision,'') = ISNULL(ISNULL(@FechaEmision,FechaEmision),'') 
       AND ISNULL(UltimoCambio,'') = ISNULL(ISNULL(@UltimoCambio,UltimoCambio),'') 
       AND ISNULL(Concepto,'') = ISNULL(ISNULL(@Concepto,Concepto),'') 
       AND ISNULL(Proyecto,'') = ISNULL(ISNULL(@Proyecto,Proyecto),'') 
       AND ISNULL(UEN,'') = ISNULL(ISNULL(@UEN,UEN),'') 
       AND ISNULL(Moneda,'') = ISNULL(ISNULL(@Moneda,Moneda),'') 
       AND ISNULL(TipoCambio,'') = ISNULL(ISNULL(@TipoCambio,TipoCambio),'') 
       AND ISNULL(Usuario,'') = ISNULL(ISNULL(@Usuario,Usuario),'') 
       AND ISNULL(Autorizacion,'') = ISNULL(ISNULL(@Autorizacion,Autorizacion),'') 
       AND ISNULL(Referencia,'') = ISNULL(ISNULL(@Referencia,Referencia),'') 
       AND ISNULL(DocFuente,'') = ISNULL(ISNULL(@DocFuente,DocFuente),'') 
       AND ISNULL(Observaciones,'') = ISNULL(ISNULL(@Observaciones,Observaciones),'') 
       AND ISNULL(Estatus,'') = ISNULL(ISNULL(@Estatus,Estatus),'') 
       AND ISNULL(Situacion,'') = ISNULL(ISNULL(@Situacion,Situacion),'') 
       AND ISNULL(SituacionFecha,'') = ISNULL(ISNULL(@SituacionFecha,SituacionFecha),'') 
       AND ISNULL(SituacionUsuario,'') = ISNULL(ISNULL(@SituacionUsuario,SituacionUsuario),'') 
       AND ISNULL(SituacionNota,'') = ISNULL(ISNULL(@SituacionNota,SituacionNota),'') 
       AND ISNULL(Directo,'') = ISNULL(ISNULL(@Directo,Directo),'') 
       AND ISNULL(Prioridad,'') = ISNULL(ISNULL(@Prioridad,Prioridad),'') 
       AND ISNULL(RenglonID,'') = ISNULL(ISNULL(@RenglonID,RenglonID),'') 
       AND ISNULL(FechaOriginal,'') = ISNULL(ISNULL(@FechaOriginal,FechaOriginal),'') 
       AND ISNULL(Codigo,'') = ISNULL(ISNULL(@Codigo,Codigo),'') 
       AND ISNULL(Cliente,'') = ISNULL(ISNULL(@Cliente,Cliente),'') 
       AND ISNULL(EnviarA,'') = ISNULL(ISNULL(@EnviarA,EnviarA),'') 
       AND ISNULL(Almacen,'') = ISNULL(ISNULL(@Almacen,Almacen),'') 
       AND ISNULL(AlmacenDestino,'') = ISNULL(ISNULL(@AlmacenDestino,AlmacenDestino),'') 
       AND ISNULL(Agente,'') = ISNULL(ISNULL(@Agente,Agente),'') 
       AND ISNULL(AgenteServicio,'') = ISNULL(ISNULL(@AgenteServicio,AgenteServicio),'') 
       AND ISNULL(AgenteComision,'') = ISNULL(ISNULL(@AgenteComision,AgenteComision),'') 
       AND ISNULL(FormaEnvio,'') = ISNULL(ISNULL(@FormaEnvio,FormaEnvio),'') 
       AND ISNULL(FechaRequerida,'') = ISNULL(ISNULL(@FechaRequerida,FechaRequerida),'') 
       AND ISNULL(HoraRequerida,'') = ISNULL(ISNULL(@HoraRequerida,HoraRequerida),'') 
       AND ISNULL(FechaProgramadaEnvio,'') = ISNULL(ISNULL(@FechaProgramadaEnvio,FechaProgramadaEnvio),'') 
       AND ISNULL(FechaOrdenCompra,'') = ISNULL(ISNULL(@FechaOrdenCompra,FechaOrdenCompra),'') 
       AND ISNULL(ReferenciaOrdenCompra,'') = ISNULL(ISNULL(@ReferenciaOrdenCompra,ReferenciaOrdenCompra),'') 
       AND ISNULL(OrdenCompra,'') = ISNULL(ISNULL(@OrdenCompra,OrdenCompra),'') 
       AND ISNULL(Condicion,'') = ISNULL(ISNULL(@Condicion,Condicion),'') 
       AND ISNULL(Vencimiento,'') = ISNULL(ISNULL(@Vencimiento,Vencimiento),'') 
       AND ISNULL(CtaDinero,'') = ISNULL(ISNULL(@CtaDinero,CtaDinero),'') 
       AND ISNULL(Descuento,'') = ISNULL(ISNULL(@Descuento,Descuento),'') 
       AND ISNULL(DescuentoGlobal,'') = ISNULL(ISNULL(@DescuentoGlobal,DescuentoGlobal),'') 
       AND ISNULL(Importe,'') = ISNULL(ISNULL(@Importe,Importe),'') 
       AND ISNULL(Impuestos,'') = ISNULL(ISNULL(@Impuestos,Impuestos),'') 
       AND ISNULL(Saldo,'') = ISNULL(ISNULL(@Saldo,Saldo),'') 
       AND ISNULL(AnticiposFacturados,'') = ISNULL(ISNULL(@AnticiposFacturados,AnticiposFacturados),'') 
       AND ISNULL(AnticiposImpuestos,'') = ISNULL(ISNULL(@AnticiposImpuestos,AnticiposImpuestos),'') 
       AND ISNULL(Retencion,'') = ISNULL(ISNULL(@Retencion,Retencion),'') 
       AND ISNULL(DescuentoLineal,'') = ISNULL(ISNULL(@DescuentoLineal,DescuentoLineal),'') 
       AND ISNULL(ComisionTotal,'') = ISNULL(ISNULL(@ComisionTotal,ComisionTotal),'') 
       AND ISNULL(CostoTotal,'') = ISNULL(ISNULL(@CostoTotal,CostoTotal),'') 
       AND ISNULL(PrecioTotal,'') = ISNULL(ISNULL(@PrecioTotal,PrecioTotal),'') 
       AND ISNULL(Paquetes,'') = ISNULL(ISNULL(@Paquetes,Paquetes),'') 
       AND ISNULL(ServicioTipo,'') = ISNULL(ISNULL(@ServicioTipo,ServicioTipo),'') 
       AND ISNULL(ServicioArticulo,'') = ISNULL(ISNULL(@ServicioArticulo,ServicioArticulo),'') 
       AND ISNULL(ServicioSerie,'') = ISNULL(ISNULL(@ServicioSerie,ServicioSerie),'') 
       AND ISNULL(ServicioContrato,'') = ISNULL(ISNULL(@ServicioContrato,ServicioContrato),'') 
       AND ISNULL(ServicioContratoID,'') = ISNULL(ISNULL(@ServicioContratoID,ServicioContratoID),'') 
       AND ISNULL(ServicioContratoTipo,'') = ISNULL(ISNULL(@ServicioContratoTipo,ServicioContratoTipo),'') 
       AND ISNULL(ServicioGarantia,'') = ISNULL(ISNULL(@ServicioGarantia,ServicioGarantia),'') 
       AND ISNULL(ServicioDescripcion,'') = ISNULL(ISNULL(@ServicioDescripcion,ServicioDescripcion),'') 
       AND ISNULL(ServicioFecha,'') = ISNULL(ISNULL(@ServicioFecha,ServicioFecha),'') 
       AND ISNULL(ServicioFlotilla,'') = ISNULL(ISNULL(@ServicioFlotilla,ServicioFlotilla),'') 
       AND ISNULL(ServicioRampa,'') = ISNULL(ISNULL(@ServicioRampa,ServicioRampa),'') 
       AND ISNULL(ServicioIdentificador,'') = ISNULL(ISNULL(@ServicioIdentificador,ServicioIdentificador),'') 
       AND ISNULL(ServicioPlacas,'') = ISNULL(ISNULL(@ServicioPlacas,ServicioPlacas),'') 
       AND ISNULL(ServicioKms,'') = ISNULL(ISNULL(@ServicioKms,ServicioKms),'') 
       AND ISNULL(ServicioTipoOrden,'') = ISNULL(ISNULL(@ServicioTipoOrden,ServicioTipoOrden),'') 
       AND ISNULL(ServicioTipoOperacion,'') = ISNULL(ISNULL(@ServicioTipoOperacion,ServicioTipoOperacion),'') 
       AND ISNULL(ServicioSiniestro,'') = ISNULL(ISNULL(@ServicioSiniestro,ServicioSiniestro),'') 
       AND ISNULL(ServicioExpress,'') = ISNULL(ISNULL(@ServicioExpress,ServicioExpress),'') 
       AND ISNULL(ServicioDemerito,'') = ISNULL(ISNULL(@ServicioDemerito,ServicioDemerito),'') 
       AND ISNULL(ServicioDeducible,'') = ISNULL(ISNULL(@ServicioDeducible,ServicioDeducible),'') 
       AND ISNULL(ServicioDeducibleImporte,'') = ISNULL(ISNULL(@ServicioDeducibleImporte,ServicioDeducibleImporte),'') 
       AND ISNULL(ServicioNumero,'') = ISNULL(ISNULL(@ServicioNumero,ServicioNumero),'') 
       AND ISNULL(ServicioNumeroEconomico,'') = ISNULL(ISNULL(@ServicioNumeroEconomico,ServicioNumeroEconomico),'') 
       AND ISNULL(ServicioAseguradora,'') = ISNULL(ISNULL(@ServicioAseguradora,ServicioAseguradora),'') 
       AND ISNULL(ServicioPuntual,'') = ISNULL(ISNULL(@ServicioPuntual,ServicioPuntual),'') 
       AND ISNULL(ServicioPoliza,'') = ISNULL(ISNULL(@ServicioPoliza,ServicioPoliza),'') 
       AND ISNULL(OrigenTipo,'') = ISNULL(ISNULL(@OrigenTipo,OrigenTipo),'') 
       AND ISNULL(Origen,'') = ISNULL(ISNULL(@Origen,Origen),'') 
       AND ISNULL(OrigenID,'') = ISNULL(ISNULL(@OrigenID,OrigenID),'') 
       AND ISNULL(Poliza,'') = ISNULL(ISNULL(@Poliza,Poliza),'') 
       AND ISNULL(PolizaID,'') = ISNULL(ISNULL(@PolizaID,PolizaID),'') 
       AND ISNULL(GenerarPoliza,'') = ISNULL(ISNULL(@GenerarPoliza,GenerarPoliza),'') 
       AND ISNULL(ContID,'') = ISNULL(ISNULL(@ContID,ContID),'') 
       AND ISNULL(Ejercicio,'') = ISNULL(ISNULL(@Ejercicio,Ejercicio),'') 
       AND ISNULL(Periodo,'') = ISNULL(ISNULL(@Periodo,Periodo),'') 
       AND ISNULL(FechaRegistro,'') = ISNULL(ISNULL(@FechaRegistro,FechaRegistro),'') 
       AND ISNULL(FechaConclusion,'') = ISNULL(ISNULL(@FechaConclusion,FechaConclusion),'') 
       AND ISNULL(FechaCancelacion,'') = ISNULL(ISNULL(@FechaCancelacion,FechaCancelacion),'') 
       AND ISNULL(FechaEntrega,'') = ISNULL(ISNULL(@FechaEntrega,FechaEntrega),'') 
       AND ISNULL(EmbarqueEstado,'') = ISNULL(ISNULL(@EmbarqueEstado,EmbarqueEstado),'') 
       AND ISNULL(EmbarqueGastos,'') = ISNULL(ISNULL(@EmbarqueGastos,EmbarqueGastos),'') 
       AND ISNULL(Peso,'') = ISNULL(ISNULL(@Peso,Peso),'') 
       AND ISNULL(Volumen,'') = ISNULL(ISNULL(@Volumen,Volumen),'') 
       AND ISNULL(Causa,'') = ISNULL(ISNULL(@Causa,Causa),'') 
       AND ISNULL(Atencion,'') = ISNULL(ISNULL(@Atencion,Atencion),'') 
       AND ISNULL(AtencionTelefono,'') = ISNULL(ISNULL(@AtencionTelefono,AtencionTelefono),'') 
       AND ISNULL(ListaPreciosEsp,'') = ISNULL(ISNULL(@ListaPreciosEsp,ListaPreciosEsp),'') 
       AND ISNULL(ZonaImpuesto,'') = ISNULL(ISNULL(@ZonaImpuesto,ZonaImpuesto),'') 
       AND ISNULL(Extra,'') = ISNULL(ISNULL(@Extra,Extra),'') 
       AND ISNULL(CancelacionID,'') = ISNULL(ISNULL(@CancelacionID,CancelacionID),'') 
       AND ISNULL(Mensaje,'') = ISNULL(ISNULL(@Mensaje,Mensaje),'') 
       AND ISNULL(Departamento,'') = ISNULL(ISNULL(@Departamento,Departamento),'') 
       AND ISNULL(Sucursal,'') = ISNULL(ISNULL(@Sucursal,Sucursal),'') 
       AND ISNULL(GenerarOP,'') = ISNULL(ISNULL(@GenerarOP,GenerarOP),'') 
       AND ISNULL(DesglosarImpuestos,'') = ISNULL(ISNULL(@DesglosarImpuestos,DesglosarImpuestos),'') 
       AND ISNULL(DesglosarImpuesto2,'') = ISNULL(ISNULL(@DesglosarImpuesto2,DesglosarImpuesto2),'') 
       AND ISNULL(ExcluirPlaneacion,'') = ISNULL(ISNULL(@ExcluirPlaneacion,ExcluirPlaneacion),'') 
       AND ISNULL(ConVigencia,'') = ISNULL(ISNULL(@ConVigencia,ConVigencia),'') 
       AND ISNULL(VigenciaDesde,'') = ISNULL(ISNULL(@VigenciaDesde,VigenciaDesde),'') 
       AND ISNULL(VigenciaHasta,'') = ISNULL(ISNULL(@VigenciaHasta,VigenciaHasta),'') 
       AND ISNULL(Enganche,'') = ISNULL(ISNULL(@Enganche,Enganche),'') 
       AND ISNULL(Bonificacion,'') = ISNULL(ISNULL(@Bonificacion,Bonificacion),'') 
       AND ISNULL(IVAFiscal,'') = ISNULL(ISNULL(@IVAFiscal,IVAFiscal),'') 
       AND ISNULL(IEPSFiscal,'') = ISNULL(ISNULL(@IEPSFiscal,IEPSFiscal),'') 
       AND ISNULL(EstaImpreso,'') = ISNULL(ISNULL(@EstaImpreso,EstaImpreso),'') 
       AND ISNULL(Periodicidad,'') = ISNULL(ISNULL(@Periodicidad,Periodicidad),'') 
       AND ISNULL(SubModulo,'') = ISNULL(ISNULL(@SubModulo,SubModulo),'') 
       AND ISNULL(ContUso,'') = ISNULL(ISNULL(@ContUso,ContUso),'') 
       AND ISNULL(Espacio,'') = ISNULL(ISNULL(@Espacio,Espacio),'') 
       AND ISNULL(AutoCorrida,'') = ISNULL(ISNULL(@AutoCorrida,AutoCorrida),'') 
       AND ISNULL(AutoCorridaHora,'') = ISNULL(ISNULL(@AutoCorridaHora,AutoCorridaHora),'') 
       AND ISNULL(AutoCorridaServicio,'') = ISNULL(ISNULL(@AutoCorridaServicio,AutoCorridaServicio),'') 
       AND ISNULL(AutoCorridaRol,'') = ISNULL(ISNULL(@AutoCorridaRol,AutoCorridaRol),'') 
       AND ISNULL(AutoCorridaOrigen,'') = ISNULL(ISNULL(@AutoCorridaOrigen,AutoCorridaOrigen),'') 
       AND ISNULL(AutoCorridaDestino,'') = ISNULL(ISNULL(@AutoCorridaDestino,AutoCorridaDestino),'') 
       AND ISNULL(AutoCorridaKms,'') = ISNULL(ISNULL(@AutoCorridaKms,AutoCorridaKms),'') 
       AND ISNULL(AutoCorridaLts,'') = ISNULL(ISNULL(@AutoCorridaLts,AutoCorridaLts),'') 
       AND ISNULL(AutoCorridaRuta,'') = ISNULL(ISNULL(@AutoCorridaRuta,AutoCorridaRuta),'') 
       AND ISNULL(AutoOperador2,'') = ISNULL(ISNULL(@AutoOperador2,AutoOperador2),'') 
       AND ISNULL(AutoBoleto,'') = ISNULL(ISNULL(@AutoBoleto,AutoBoleto),'') 
       AND ISNULL(AutoKms,'') = ISNULL(ISNULL(@AutoKms,AutoKms),'') 
       AND ISNULL(AutoKmsActuales,'') = ISNULL(ISNULL(@AutoKmsActuales,AutoKmsActuales),'') 
       AND ISNULL(AutoBomba,'') = ISNULL(ISNULL(@AutoBomba,AutoBomba),'') 
       AND ISNULL(AutoBombaContador,'') = ISNULL(ISNULL(@AutoBombaContador,AutoBombaContador),'') 
       AND ISNULL(Logico1,'') = ISNULL(ISNULL(@Logico1,Logico1),'') 
       AND ISNULL(Logico2,'') = ISNULL(ISNULL(@Logico2,Logico2),'') 
       AND ISNULL(Logico3,'') = ISNULL(ISNULL(@Logico3,Logico3),'') 
       AND ISNULL(Logico4,'') = ISNULL(ISNULL(@Logico4,Logico4),'') 
       AND ISNULL(DifCredito,'') = ISNULL(ISNULL(@DifCredito,DifCredito),'') 
       AND ISNULL(EspacioResultado,'') = ISNULL(ISNULL(@EspacioResultado,EspacioResultado),'') 
       AND ISNULL(Clase,'') = ISNULL(ISNULL(@Clase,Clase),'') 
       AND ISNULL(Subclase,'') = ISNULL(ISNULL(@Subclase,Subclase),'') 
       AND ISNULL(GastoAcreedor,'') = ISNULL(ISNULL(@GastoAcreedor,GastoAcreedor),'') 
       AND ISNULL(GastoConcepto,'') = ISNULL(ISNULL(@GastoConcepto,GastoConcepto),'') 
       AND ISNULL(Pagado,'') = ISNULL(ISNULL(@Pagado,Pagado),'') 
       AND ISNULL(GenerarDinero,'') = ISNULL(ISNULL(@GenerarDinero,GenerarDinero),'') 
       AND ISNULL(Dinero,'') = ISNULL(ISNULL(@Dinero,Dinero),'') 
       AND ISNULL(DineroID,'') = ISNULL(ISNULL(@DineroID,DineroID),'') 
       AND ISNULL(DineroCtaDinero,'') = ISNULL(ISNULL(@DineroCtaDinero,DineroCtaDinero),'') 
       AND ISNULL(DineroConciliado,'') = ISNULL(ISNULL(@DineroConciliado,DineroConciliado),'') 
       AND ISNULL(DineroFechaConciliacion,'') = ISNULL(ISNULL(@DineroFechaConciliacion,DineroFechaConciliacion),'') 
       AND ISNULL(Extra1,'') = ISNULL(ISNULL(@Extra1,Extra1),'') 
       AND ISNULL(Extra2,'') = ISNULL(ISNULL(@Extra2,Extra2),'') 
       AND ISNULL(Extra3,'') = ISNULL(ISNULL(@Extra3,Extra3),'') 
       AND ISNULL(Reabastecido,'') = ISNULL(ISNULL(@Reabastecido,Reabastecido),'') 
       AND ISNULL(SucursalVenta,'') = ISNULL(ISNULL(@SucursalVenta,SucursalVenta),'') 
       AND ISNULL(AF,'') = ISNULL(ISNULL(@AF,AF),'') 
       AND ISNULL(AFArticulo,'') = ISNULL(ISNULL(@AFArticulo,AFArticulo),'') 
       AND ISNULL(AFSerie,'') = ISNULL(ISNULL(@AFSerie,AFSerie),'') 
       AND ISNULL(ContratoTipo,'') = ISNULL(ISNULL(@ContratoTipo,ContratoTipo),'') 
       AND ISNULL(ContratoDescripcion,'') = ISNULL(ISNULL(@ContratoDescripcion,ContratoDescripcion),'') 
       AND ISNULL(ContratoSerie,'') = ISNULL(ISNULL(@ContratoSerie,ContratoSerie),'') 
       AND ISNULL(ContratoValor,'') = ISNULL(ISNULL(@ContratoValor,ContratoValor),'') 
       AND ISNULL(ContratoValorMoneda,'') = ISNULL(ISNULL(@ContratoValorMoneda,ContratoValorMoneda),'') 
       AND ISNULL(ContratoSeguro,'') = ISNULL(ISNULL(@ContratoSeguro,ContratoSeguro),'') 
       AND ISNULL(ContratoVencimiento,'') = ISNULL(ISNULL(@ContratoVencimiento,ContratoVencimiento),'') 
       AND ISNULL(Incentivo,'') = ISNULL(ISNULL(@Incentivo,Incentivo),'') 
       AND ISNULL(IncentivoConcepto,'') = ISNULL(ISNULL(@IncentivoConcepto,IncentivoConcepto),'') 
       AND ISNULL(EndosarA,'') = ISNULL(ISNULL(@EndosarA,EndosarA),'') 
       AND ISNULL(InteresTasa,'') = ISNULL(ISNULL(@InteresTasa,InteresTasa),'') 
       AND ISNULL(InteresIVA,'') = ISNULL(ISNULL(@InteresIVA,InteresIVA),'') 
       AND ISNULL(AnexoID,'') = ISNULL(ISNULL(@AnexoID,AnexoID),'') 
       AND ISNULL(FordVisitoOASIS,'') = ISNULL(ISNULL(@FordVisitoOASIS,FordVisitoOASIS),'') 
       AND ISNULL(LineaCredito,'') = ISNULL(ISNULL(@LineaCredito,LineaCredito),'') 
       AND ISNULL(TipoAmortizacion,'') = ISNULL(ISNULL(@TipoAmortizacion,TipoAmortizacion),'') 
       AND ISNULL(TipoTasa,'') = ISNULL(ISNULL(@TipoTasa,TipoTasa),'') 
       AND ISNULL(Comisiones,'') = ISNULL(ISNULL(@Comisiones,Comisiones),'') 
       AND ISNULL(ComisionesIVA,'') = ISNULL(ISNULL(@ComisionesIVA,ComisionesIVA),'') 
       AND ISNULL(CompraID,'') = ISNULL(ISNULL(@CompraID,CompraID),'') 
       AND ISNULL(OperacionRelevante,'') = ISNULL(ISNULL(@OperacionRelevante,OperacionRelevante),'') 
       AND ISNULL(TieneTasaEsp,'') = ISNULL(ISNULL(@TieneTasaEsp,TieneTasaEsp),'') 
       AND ISNULL(TasaEsp,'') = ISNULL(ISNULL(@TasaEsp,TasaEsp),'') 
       AND ISNULL(FormaPagoTipo,'') = ISNULL(ISNULL(@FormaPagoTipo,FormaPagoTipo),'') 
       AND ISNULL(SobrePrecio,'') = ISNULL(ISNULL(@SobrePrecio,SobrePrecio),'') 
       AND ISNULL(SincroC,'') = ISNULL(ISNULL(@SincroC,SincroC),'') 
       AND ISNULL(SucursalOrigen,'') = ISNULL(ISNULL(@SucursalOrigen,SucursalOrigen),'') 
       AND ISNULL(SucursalDestino,'') = ISNULL(ISNULL(@SucursalDestino,SucursalDestino),'') 
       AND ISNULL(ContUso2,'') = ISNULL(ISNULL(@ContUso2,ContUso2),'') 
       AND ISNULL(ContUso3,'') = ISNULL(ISNULL(@ContUso3,ContUso3),'') 
       AND ISNULL(Actividad,'') = ISNULL(ISNULL(@Actividad,Actividad),'') 
       AND ISNULL(ContratoID,'') = ISNULL(ISNULL(@ContratoID,ContratoID),'') 
       AND ISNULL(ContratoMov,'') = ISNULL(ISNULL(@ContratoMov,ContratoMov),'') 
       AND ISNULL(ContratoMovID,'') = ISNULL(ISNULL(@ContratoMovID,ContratoMovID),'') 
       AND ISNULL(MAFCiclo,'') = ISNULL(ISNULL(@MAFCiclo,MAFCiclo),'') 
       AND ISNULL(TipoComprobante,'') = ISNULL(ISNULL(@TipoComprobante,TipoComprobante),'') 
       AND ISNULL(SustentoComprobante,'') = ISNULL(ISNULL(@SustentoComprobante,SustentoComprobante),'') 
       AND ISNULL(TipoIdentificacion,'') = ISNULL(ISNULL(@TipoIdentificacion,TipoIdentificacion),'') 
       AND ISNULL(DerechoDevolucion,'') = ISNULL(ISNULL(@DerechoDevolucion,DerechoDevolucion),'') 
       AND ISNULL(Establecimiento,'') = ISNULL(ISNULL(@Establecimiento,Establecimiento),'') 
       AND ISNULL(PuntoEmision,'') = ISNULL(ISNULL(@PuntoEmision,PuntoEmision),'') 
       AND ISNULL(SecuencialSRI,'') = ISNULL(ISNULL(@SecuencialSRI,SecuencialSRI),'') 
       AND ISNULL(AutorizacionSRI,'') = ISNULL(ISNULL(@AutorizacionSRI,AutorizacionSRI),'') 
       AND ISNULL(VigenteA,'') = ISNULL(ISNULL(@VigenteA,VigenteA),'') 
       AND ISNULL(SecuenciaRetencion,'') = ISNULL(ISNULL(@SecuenciaRetencion,SecuenciaRetencion),'') 
       AND ISNULL(Comprobante,'') = ISNULL(ISNULL(@Comprobante,Comprobante),'') 
       AND ISNULL(FechaContableMov,'') = ISNULL(ISNULL(@FechaContableMov,FechaContableMov),'')  					
	   FOR XML AUTO)	
    SELECT @Texto2 =(SELECT * FROM VentaD 
     WHERE ID = @IDO   					
	   FOR XML AUTO)	


    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
  
    SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + CONVERT(varchar(max),@Texto2)+'</Resultado></Intelisis>'

  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
   BEGIN
     COMMIT TRANSACTION 
   END ELSE
    BEGIN
      ROLLBACK TRANSACTION 
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')    
    END
  END
END
GO
SET DATEFIRST 7
SET ANSI_NULLS OFF
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET LOCK_TIMEOUT -1
SET QUOTED_IDENTIFIER OFF
SET ARITHABORT OFF 
GO
/**************** spIntelisisCuentaMonListado ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaMonListado') and type = 'P') drop procedure dbo.spIntelisisCuentaMonListado
GO             
CREATE PROCEDURE spIntelisisCuentaMonListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
		@Moneda					varchar(10),
		@Orden					int,
		@Nombre					varchar(50),
		@Clave					varchar(3),
		@InforClave				varchar(4),
		@Texto					xml,
		@ReferenciaIS			varchar(100),
		@SubReferencia			varchar(100)
			




  SELECT @Moneda = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Moneda'
  SELECT @Orden = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Orden'
  SELECT @Clave = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Clave'
  SELECT @InforClave = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'InforClave'
  
  

  SELECT @Texto =(SELECT * FROM Mon
   WHERE  ISNULL(Moneda,'') = ISNULL(ISNULL(@Moneda,Moneda),'')
     AND ISNULL(Orden,'') = ISNULL(ISNULL(@Orden,Orden),'')
     AND ISNULL(Clave,'') = ISNULL(ISNULL(@Clave,Clave),'')		
     AND ISNULL(InforClave,'') = ISNULL(ISNULL(@InforClave,InforClave),'')		
     FOR XML AUTO)	
  IF @@ERROR <> 0 SET @Ok = 1
  BEGIN
    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
    IF @@ERROR <> 0 SET @Ok = 1
    
    IF @Ok IS NULL
    BEGIN
      SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'
      IF @@ERROR <> 0 SET @Ok = 1
    END
  END
END
GO
/**************** spIntelisisCuentaAlmListado ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaAlmListado') and type = 'P') drop procedure dbo.spIntelisisCuentaAlmListado
GO             
CREATE PROCEDURE spIntelisisCuentaAlmListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
		@ProdInterfazINFOR		bit,
  		@Almacen				varchar(10),
		@Rama					varchar(20),
		@Nombre 				varchar(100),
		@Colonia     			varchar(100),
		@Delegacion				varchar(100),
		@Poblacion				varchar(100),
		@Estado					varchar(30),
		@Pais					varchar(30),		
		@CodigoPostal 			varchar(15),
		@Encargado				varchar(50),
		@Grupo      			varchar(50),
		@Categoria     			varchar(50),
		@Zona        			varchar(30),
		@Ruta       			varchar(50),
		@Tipo       			varchar(15),
		@Sucursal     			int,
		@Estatus    			varchar(15),
		@Alta       			datetime,
		@ExcluirPlaneacion      bit,
		@Cuenta					varchar(20),
		@PermiteRechazos		bit,
		@PermiteUbicaciones     bit,
		@Texto					xml,
		@ReferenciaIS			varchar(100),
		@SubReferencia			varchar(100),
		@EsAlmacenDeDeposito    bit,
		@EsAlmacenMaterialesExteriores  bit,
		@NoDisponibleConsumos    bit
			

  IF @Ok IS NULL
  BEGIN
  
  SELECT @Almacen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Almacen'
  SELECT @Rama = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Rama'
  SELECT @Nombre = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Nombre'
  SELECT @Colonia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Colonia'
  SELECT @Delegacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Delegacion'
  SELECT @Poblacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Poblacion'
  SELECT @Estado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Estado'
  SELECT @Pais = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Pais'
  SELECT @CodigoPostal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CodigoPostal'
  SELECT @Encargado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Encargado'
  SELECT @Grupo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Grupo '
  SELECT @Categoria = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Categoria'
  SELECT @Zona = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Zona'
  SELECT @Ruta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Ruta'
  SELECT @Tipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Tipo'
  SELECT @Sucursal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Sucursal'
  SELECT @Estatus = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Estatus'
  SELECT @Alta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Alta'
  SELECT @ExcluirPlaneacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ExcluirPlaneacion'  
  SELECT @Cuenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Cuenta'
  SELECT @PermiteRechazos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'PermiteRechazos'
  SELECT @PermiteUbicaciones = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'PermiteUbicaciones'
  SELECT @EsAlmacenDeDeposito = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EsAlmacenDeDeposito'  
  SELECT @EsAlmacenMaterialesExteriores = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EsAlmacenMaterialesExteriores' 
  SELECT @NoDisponibleConsumos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'NoDisponibleConsumos'


  SELECT @Texto =(SELECT * FROM Alm 
     WHERE  ISNULL(Almacen,'') = ISNULL(ISNULL(@Almacen,Almacen),'')
	   AND ISNULL(Rama,'') = ISNULL(ISNULL(@Rama,Rama),'')		
	   AND ISNULL(Nombre,'') = ISNULL(ISNULL(@Nombre,Nombre),'') 				
	   AND ISNULL(Colonia,'') = ISNULL(ISNULL(@Colonia,Colonia),'')     			
	   AND ISNULL(Delegacion,'') =	ISNULL(ISNULL(@Delegacion,Delegacion),'')				
	   AND ISNULL(Poblacion,'')  =	ISNULL(ISNULL(@Poblacion,Poblacion),'')				
	   AND ISNULL(Estado,'') =	ISNULL(ISNULL(@Estado,Estado),'')					
	   AND ISNULL(Pais,'') =	ISNULL(ISNULL(@Pais,Pais),'')							
	   AND ISNULL(CodigoPostal,'') = ISNULL(ISNULL(@CodigoPostal,CodigoPostal),'') 			
	   AND ISNULL(Encargado,'') = ISNULL(ISNULL(@Encargado,Encargado),'')				
	   AND ISNULL(Grupo,'') = ISNULL(ISNULL(@Grupo,Grupo),'')      			
	   AND ISNULL(Categoria,'') = ISNULL(ISNULL(@Categoria,Categoria),'')     			
	   AND ISNULL(Zona,'') = ISNULL(ISNULL(@Zona,Zona),'')        			
	   AND ISNULL(Ruta,'') = ISNULL(ISNULL(@Ruta,Ruta),'')       			
	   AND ISNULL(Tipo,'') = ISNULL(ISNULL(@Tipo,Tipo),'')       			
	   AND ISNULL(Sucursal,'') = ISNULL(ISNULL(@Sucursal,Sucursal),'')     			
	   AND ISNULL(Estatus,'') = ISNULL(ISNULL(@Estatus,Estatus),'')    			
	   AND ISNULL(Alta,'') = ISNULL(ISNULL(@Alta,Alta),'')
	   AND ISNULL(ExcluirPlaneacion,'') = ISNULL(ISNULL(@ExcluirPlaneacion,ExcluirPlaneacion),'')       			
	   AND ISNULL(Cuenta,'') =	ISNULL(ISNULL(@Cuenta,Cuenta),'')	

      FOR XML AUTO)	

    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
  
    SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'

    IF @@ERROR <> 0 SET @Ok = 1
  END
END
GO
/**************** spIntelisisCuentaPlantaListado ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaPlantaListado') and type = 'P') drop procedure dbo.spIntelisisCuentaPlantaListado
GO             
CREATE PROCEDURE spIntelisisCuentaPlantaListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
		@Clave					varchar(100),
		@Descripcion			varchar(50),
		@Texto					xml,
		@ReferenciaIS			varchar(100),
		@SubReferencia			varchar(100)
			



  BEGIN TRANSACTION 
  IF @Ok IS NULL
  BEGIN
  
  SELECT @Descripcion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Descripcion'
  SELECT @Clave = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Clave '
  
  
  SELECT @Texto =(SELECT * FROM PlantaProductiva 
     WHERE ISNULL(Clave,'') = ISNULL(ISNULL(@Clave,Clave),'')
	   AND ISNULL(Descripcion,'') = ISNULL(ISNULL(@Descripcion,Descripcion),'')		
				
	   					
	   FOR XML AUTO)	

    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
  
    SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'
 
  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
   BEGIN
     COMMIT TRANSACTION 
   END ELSE
    BEGIN
      ROLLBACK TRANSACTION 
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')    
    END
  END
END
GO
/**************** spIntelisisCuentaArtFamListado  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaArtFamListado') and type = 'P') drop procedure dbo.spIntelisisCuentaArtFamListado
GO             
CREATE PROCEDURE spIntelisisCuentaArtFamListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
		 @Familia		   varchar(50),
		 @FamiliaMaestra   varchar(50), 
		 @Icono			   int   ,
		 @Precios		   bit   , 
		 @PrecioLista	   money   , 
         @Precio2          money   ,
         @Precio3          money   , 
         @Precio4          money   , 
         @CostoReposicion  float   ,
         @BasePresupuesto  varchar(20), 
         @UltimoQuiebre    datetime   ,
         @QuiebreFechaD    datetime   , 
         @QuiebreFechaA    datetime   ,
         @Impuesto1        float   , 
         @Impuesto2        float   , 
         @Impuesto3        float   ,  
         @Clave            varchar(20),
		 @Texto						xml,
		 @ReferenciaIS				varchar(100),
		 @SubReferencia				varchar(100)
							

  BEGIN TRANSACTION 
  IF @Ok IS NULL
  BEGIN

  SELECT @Familia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Familia'
  SELECT @FamiliaMaestra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'FamiliaMaestra'
  SELECT @Icono = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Icono'
  SELECT @Precios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Precios'
  SELECT @PrecioLista = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'PrecioLista'
  SELECT @Precio2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Precio3'
  SELECT @Precio3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Precio3'
  SELECT @Precio4 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Precio4'
  SELECT @CostoReposicion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'CostoReposicion'
  SELECT @BasePresupuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'BasePresupuesto'
  SELECT @UltimoQuiebre = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'UltimoQuiebre'
  SELECT @QuiebreFechaD = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'QuiebreFechaD'
  SELECT @QuiebreFechaA = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'QuiebreFechaA'
  SELECT @Impuesto1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Impuesto1'
  SELECT @Impuesto2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Impuesto2'
  SELECT @Impuesto3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Impuesto3'
  SELECT @Clave = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Clave'


  SELECT @Texto =(SELECT * FROM ArtFam
     WHERE  ISNULL(Familia,'' ) = ISNULL(ISNULL(@Familia,Familia),'') 
		AND ISNULL(FamiliaMaestra,'' ) = ISNULL(ISNULL(@FamiliaMaestra,FamiliaMaestra),'') 
		AND ISNULL(Icono,'' ) = ISNULL(ISNULL(@Icono,Icono),'') 
		AND ISNULL(PrecioLista,'' ) = ISNULL(ISNULL(@PrecioLista,PrecioLista),'') 
		AND ISNULL(Precio2,'' ) = ISNULL(ISNULL(@Precio2,Precio2),'') 
		AND ISNULL(Precio3,'' ) = ISNULL(ISNULL(@Precio3,Precio3),'') 
		AND ISNULL(Precio4,'' ) = ISNULL(ISNULL(@Precio4,Precio4),'') 
		AND ISNULL(CostoReposicion,'' ) = ISNULL(ISNULL(@CostoReposicion,CostoReposicion),'') 
		AND ISNULL(BasePresupuesto,'' ) = ISNULL(ISNULL(@BasePresupuesto,BasePresupuesto),'') 
		AND ISNULL(UltimoQuiebre,'' ) = ISNULL(ISNULL(@UltimoQuiebre,UltimoQuiebre),'') 
		AND ISNULL(Impuesto1,'' ) = ISNULL(ISNULL(@Impuesto1,Impuesto1),'') 
		AND ISNULL(Impuesto2,'' ) = ISNULL(ISNULL(@Impuesto2,Impuesto2),'') 
		AND ISNULL(Impuesto3,'' ) = ISNULL(ISNULL(@Impuesto3,Impuesto3),'') 
		AND ISNULL(QuiebreFechaD,'' ) = ISNULL(ISNULL(@QuiebreFechaD,QuiebreFechaD),'') 
		AND ISNULL(QuiebreFechaA,'' ) = ISNULL(ISNULL(@QuiebreFechaA,QuiebreFechaA),'') 
		AND ISNULL(Clave,'' ) = ISNULL(ISNULL(@Clave,Clave),'')     			
	  FOR XML AUTO)	

    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
  
    SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'

  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
   BEGIN
     COMMIT TRANSACTION 
   END ELSE
    BEGIN
      ROLLBACK TRANSACTION 
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')    
    END
  END
END
GO
/**************** spIntelisisCuentaEmpresaListado  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaEmpresaListado') and type = 'P') drop procedure dbo.spIntelisisCuentaEmpresaListado
GO             
CREATE PROCEDURE spIntelisisCuentaEmpresaListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
        @Empresa			    varchar(5),
	    @Nombre                 varchar(100), 
        @Grupo                  varchar(100),
        @Direccion              varchar(100), 
        @DireccionNumero        varchar(20), 
        @DireccionNumeroInt     varchar(20),
        @Colonia                varchar(30),
        @Poblacion              varchar(30),
        @Estado                 varchar(30), 
        @Pais                   varchar(30), 
        @CodigoPostal           varchar(15), 
        @Telefonos              varchar(100), 
        @Fax                    varchar(50),
        @Encabezado1            varchar(255), 
        @Encabezado2            varchar(255),
        @Estatus                varchar(15), 
        @UltimoCambio           datetime   , 
        @UltimaCorrida          datetime   , 
        @Alta                   datetime   , 
        @RFC                    varchar(20), 
        @RegistroPatronal       varchar(20), 
        @ClaveActividad         varchar(20), 
        @Representante          varchar(100),
        @RepresentanteRFC       varchar(20), 
        @RepresentanteCURP      varchar(20), 
        @Zona                   varchar(50),  
        @Numero                 int   ,
        @TieneMovimientos       bit   , 
        @CambioBloquear         bit   , 
        @Controladora           varchar(5), 
        @FactorIntegracion      float   , 
        @Tipo                   varchar(20), 
        @ImportadorRegimen      varchar(30), 
        @ImportadorRegistro     varchar(30),
        @ImportadorFechaD       datetime   ,
        @ImportadorFechaA       datetime   , 
        @Delegacion             varchar(100), 
        @GLN                    varchar(50),
        @CFD                    bit   , 
        @CFD_noCertificado      varchar(20), 
        @CFD_version            varchar(10), 
        @CFD_versionFecha       datetime   , 
        @CFD_versionAnterior    varchar(10), 
        @CFD_EAN13              varchar(20), 
        @CFD_DUN14              varchar(20), 
        @CFD_SKU                varchar(20), 
        @CFD_SKUCodigoInterno   bit   , 
        @CFD_Llave              varchar(255), 
        @CFD_Certificado        varchar(255), 
        @CFD_ContrasenaSello    varchar(100), 
        @FiscalRegimen          varchar(30),
        @Organizacion           int   , 
        @TipoRegistro           varchar(20), 
        @IdentificacionRepresentante   varchar(20),
        @Contador               varchar(20),
        @RFCContador            varchar(15),
        @EsEcuador              bit   , 
        @EsGuatemala            bit   ,
        @GtImporteMinimoSinRetencion   float   , 
        @EsColombia             bit   , 
        @LongitudEstablecimiento   int   , 
        @LongitudPuntoEmision   int   , 
        @LongitudSecuencialSRI   int   , 
        @LongitudAutorizacion   int   , 
        @EcuadorRepresentantelegal   varchar(40), 
        @EcuadorNumeroidentificacion   varchar(15), 
        @EcuadorRepresentantelegalTipo   varchar(20), 
        @EcuadorRUCContadorTipo   varchar(20),
		@Texto					xml,
		@ReferenciaIS			varchar(100),
		@SubReferencia			varchar(100)
			



  BEGIN TRANSACTION 
  IF @Ok IS NULL
  BEGIN
 
  SELECT @Empresa = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Empresa'
  SELECT @Nombre = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Nombre'
  SELECT @Grupo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Grupo'
  SELECT @Direccion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Direccion'
  SELECT @DireccionNumero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DireccionNumero'
  SELECT @DireccionNumeroInt = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = '@DireccionNumeroInt'  
  SELECT @Colonia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Colonia'
  SELECT @Poblacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Poblacion'
  SELECT @Estado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Estado'
  SELECT @Pais = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Pais'   
  SELECT @CodigoPostal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CodigoPostal'
  SELECT @Telefonos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Telefonos'
  SELECT @Fax = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Fax'
  SELECT @Encabezado1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Encabezado1'
  SELECT @Encabezado2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Encabezado2'
  SELECT @Estatus = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Estatus'
  SELECT @UltimoCambio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'UltimoCambio'
  SELECT @UltimaCorrida = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'UltimaCorrida'
  SELECT @Alta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Alta'
  SELECT @RFC = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'RFC'
  SELECT @RegistroPatronal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'RegistroPatronal'
  SELECT @Estatus = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
  SELECT @ClaveActividad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ClaveActividad'
  SELECT @Representante = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Representante'
  SELECT @RepresentanteRFC = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'RepresentanteRFC'
  SELECT @RepresentanteCURP = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'RepresentanteCURP'
  SELECT @Zona = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Zona'
  SELECT @Numero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Numero'
  SELECT @TieneMovimientos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'TieneMovimientos'
  SELECT @CambioBloquear = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CambioBloquear'
  SELECT @Controladora = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Controladora'
  SELECT @FactorIntegracion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FactorIntegracion'
  SELECT @Tipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Tipo'
  SELECT @ImportadorRegimen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ImportadorRegimen'
  SELECT @ImportadorRegistro = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ImportadorRegistro'
  SELECT @ImportadorFechaD = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ImportadorFechaD'
  SELECT @ImportadorFechaA = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ImportadorFechaA'
  SELECT @Delegacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Delegacion'
  SELECT @GLN = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'GLN'
  SELECT @CFD = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CFD'
  SELECT @CFD_noCertificado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CFD_noCertificado'
  SELECT @CFD_version = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CFD_version'
  SELECT @CFD_versionFecha = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CFD_versionFecha'
  SELECT @CFD_versionAnterior = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CFD_versionAnterior'
  SELECT @CFD_EAN13 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CFD_EAN13'
  SELECT @CFD_DUN14 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CFD_DUN14'
  SELECT @CFD_SKU = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CFD_SKU'
  SELECT @CFD_SKUCodigoInterno = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CFD_SKUCodigoInterno'
  SELECT @CFD_Llave = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CFD_Llave'
  SELECT @CFD_Certificado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CFD_Certificado'
  SELECT @CFD_ContrasenaSello = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = '@CFD_ContrasenaSello'
  SELECT @FiscalRegimen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FiscalRegimen'
  SELECT @Organizacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Organizacion'


  SELECT @TipoRegistro = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'TipoRegistro'
  SELECT @IdentificacionRepresentante = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'IdentificacionRepresentante'
 SELECT @Contador = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Contador'
 SELECT @RFCContador = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'RFCContador'
 SELECT @EsEcuador = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EsEcuador'
 SELECT @EsGuatemala = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EsGuatemala'
 SELECT @GtImporteMinimoSinRetencion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'GtImporteMinimoSinRetencion'
 SELECT @EsColombia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EsColombia'
 SELECT @LongitudEstablecimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'LongitudEstablecimiento'
 SELECT @LongitudPuntoEmision = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'LongitudPuntoEmision'
 SELECT @LongitudSecuencialSRI = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'LongitudSecuencialSRI'
 SELECT @LongitudAutorizacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'LongitudAutorizacion'
 SELECT @EcuadorRepresentantelegal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EcuadorRepresentantelegal'
 SELECT @EcuadorNumeroidentificacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EcuadorNumeroidentificacion'
 SELECT @EcuadorRepresentantelegalTipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EcuadorRepresentantelegalTipo'
 SELECT @EcuadorRUCContadorTipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EcuadorRUCContadorTipo'
 

  SELECT @Texto =(SELECT * FROM Empresa
     WHERE  ISNULL(Empresa,'') = ISNULL(ISNULL(@Empresa,Empresa),'') 
		AND ISNULL(Nombre,'') = ISNULL(ISNULL(@Nombre,Nombre),'') 
		AND ISNULL(Grupo,'') = ISNULL(ISNULL(@Grupo,Grupo),'') 
		AND ISNULL(Direccion,'') = ISNULL(ISNULL(@Direccion,Direccion),'') 
		AND ISNULL(DireccionNumero,'') = ISNULL(ISNULL(@DireccionNumero,DireccionNumero),'') 
		AND ISNULL(DireccionNumeroInt,'') = ISNULL(ISNULL(@DireccionNumeroInt,DireccionNumeroInt),'')
		AND ISNULL(Colonia,'') = ISNULL(ISNULL(@Colonia,Colonia),'') 
		AND ISNULL(Poblacion,'') = ISNULL(ISNULL(@Poblacion,Poblacion),'')
		AND ISNULL(Estado,'') = ISNULL(ISNULL(@Estado,Estado),'') 
		AND ISNULL(Pais,'') = ISNULL(ISNULL(@Pais,Pais),'') 
		AND ISNULL(CodigoPostal,'') = ISNULL(ISNULL(@CodigoPostal,CodigoPostal),'')
		AND ISNULL(Telefonos,'') = ISNULL(ISNULL(@Telefonos,Telefonos),'')
		AND ISNULL(Fax,'') = ISNULL(ISNULL(@Fax,Fax),'') 
		AND ISNULL(Encabezado1,'') = ISNULL(ISNULL(@Encabezado1,Encabezado1),'')
		AND ISNULL(Encabezado2,'') = ISNULL(ISNULL(@Encabezado2,Encabezado2),'') 
		AND ISNULL(UltimoCambio,'') = ISNULL(ISNULL(@UltimoCambio,UltimoCambio),'')
		AND ISNULL(UltimaCorrida,'') = ISNULL(ISNULL(@UltimaCorrida,UltimaCorrida),'') 
		AND ISNULL(Alta,'') = ISNULL(ISNULL(@Alta,Alta),'') 
		AND ISNULL(RFC,'') = ISNULL(ISNULL(@RFC,RFC),'') 
		AND ISNULL(RegistroPatronal,'') = ISNULL(ISNULL(@RegistroPatronal,RegistroPatronal),'') 
		AND ISNULL(ClaveActividad,'') = ISNULL(ISNULL(@ClaveActividad,ClaveActividad),'')
		AND ISNULL(Representante,'') = ISNULL(ISNULL(@Representante,Representante),'') 
		AND ISNULL(RepresentanteRFC,'') = ISNULL(ISNULL(@RepresentanteRFC,RepresentanteRFC),'') 
		AND ISNULL(RepresentanteCURP,'') = ISNULL(ISNULL(@RepresentanteCURP,RepresentanteCURP),'')
		AND ISNULL(Zona,'') = ISNULL(ISNULL(@Zona,Zona),'')
		AND ISNULL(Numero,'') = ISNULL(ISNULL(@Numero,Numero),'')
		AND ISNULL(TieneMovimientos,'') = ISNULL(ISNULL(@TieneMovimientos,TieneMovimientos),'')
		AND ISNULL(CambioBloquear,'') = ISNULL(ISNULL(@CambioBloquear,CambioBloquear),'')
		AND ISNULL(Controladora,'') = ISNULL(ISNULL(@Controladora,Controladora),'') 
		AND ISNULL(FactorIntegracion,'') = ISNULL(ISNULL(@FactorIntegracion,FactorIntegracion),'')
		AND ISNULL(Tipo,'') = ISNULL(ISNULL(@Tipo,Tipo),'')
		AND ISNULL(ImportadorRegimen,'') = ISNULL(ISNULL(@ImportadorRegimen,ImportadorRegimen),'')
		AND ISNULL(ImportadorRegistro,'') = ISNULL(ISNULL(@ImportadorRegistro,ImportadorRegistro),'')
		AND ISNULL(ImportadorFechaD,'') = ISNULL(ISNULL(@ImportadorFechaD,ImportadorFechaD),'')
		AND ISNULL(ImportadorFechaA,'') = ISNULL(ISNULL(@ImportadorFechaA,ImportadorFechaA),'')
		AND ISNULL(Delegacion,'') = ISNULL(ISNULL(@Delegacion,Delegacion),'') 
		AND ISNULL(GLN,'') = ISNULL(ISNULL(@GLN,GLN),'')
		AND ISNULL(CFD,'') = ISNULL(ISNULL(@CFD,CFD),'')
		AND ISNULL(CFD_noCertificado,'') = ISNULL(ISNULL(@CFD_noCertificado,CFD_noCertificado),'')
		AND ISNULL(CFD_version,'') = ISNULL(ISNULL(@CFD_version,CFD_version),'') 
		AND ISNULL(CFD_versionFecha,'') = ISNULL(ISNULL(@CFD_versionFecha,CFD_versionFecha),'') 
		AND ISNULL(CFD_versionAnterior,'') = ISNULL(ISNULL(@CFD_versionAnterior,CFD_versionAnterior),'') 
		AND ISNULL(CFD_EAN13,'') = ISNULL(ISNULL(@CFD_EAN13,CFD_EAN13),'') 
		AND ISNULL(CFD_DUN14,'') = ISNULL(ISNULL(@CFD_DUN14,CFD_DUN14),'')
		AND ISNULL(CFD_SKU,'') = ISNULL(ISNULL(@CFD_SKU,CFD_SKU),'')
		AND ISNULL(CFD_SKUCodigoInterno,'') = ISNULL(ISNULL(@CFD_SKUCodigoInterno,CFD_SKUCodigoInterno),'')
		AND ISNULL(CFD_Llave,'') = ISNULL(ISNULL(@CFD_Llave,CFD_Llave),'') 
		AND ISNULL(CFD_Certificado,'') = ISNULL(ISNULL(@CFD_Certificado,CFD_Certificado),'') 
		AND ISNULL(CFD_ContrasenaSello,'') = ISNULL(ISNULL(@CFD_ContrasenaSello,CFD_ContrasenaSello),'')
		AND ISNULL(FiscalRegimen,'') = ISNULL(ISNULL(@FiscalRegimen,FiscalRegimen),'')
		AND ISNULL(Organizacion,'') = ISNULL(ISNULL(@Organizacion,Organizacion),'') 
		AND ISNULL(TipoRegistro,'') = ISNULL(ISNULL(@TipoRegistro,TipoRegistro),'') 
		AND ISNULL(IdentificacionRepresentante,'') = ISNULL(ISNULL(@IdentificacionRepresentante,IdentificacionRepresentante),'')
		AND ISNULL(Contador,'') = ISNULL(ISNULL(@Contador,Contador),'')
        AND ISNULL(RFCContador,'') = ISNULL(ISNULL(@RFCContador,RFCContador),'')
		AND ISNULL(EsEcuador,'') = ISNULL(ISNULL(@EsEcuador,EsEcuador),'')
		AND ISNULL(EsGuatemala,'') = ISNULL(ISNULL(@EsGuatemala,EsGuatemala),'')
		AND ISNULL(GtImporteMinimoSinRetencion,'') = ISNULL(ISNULL(@GtImporteMinimoSinRetencion,GtImporteMinimoSinRetencion),'')
		AND ISNULL(LongitudEstablecimiento,'') = ISNULL(ISNULL(@LongitudEstablecimiento,LongitudEstablecimiento),'')
		AND ISNULL(LongitudPuntoEmision,'') = ISNULL(ISNULL(@LongitudPuntoEmision,LongitudPuntoEmision),'') 
		AND ISNULL(LongitudSecuencialSRI,'') = ISNULL(ISNULL(@LongitudSecuencialSRI,LongitudSecuencialSRI),'')
		AND ISNULL(LongitudAutorizacion,'') = ISNULL(ISNULL(@LongitudAutorizacion,LongitudAutorizacion),'')
		AND ISNULL(EcuadorRepresentantelegal,'') = ISNULL(ISNULL(@EcuadorRepresentantelegal,EcuadorRepresentantelegal),'') 
		AND ISNULL(EcuadorNumeroidentificacion,'') = ISNULL(ISNULL(@EcuadorNumeroidentificacion,EcuadorNumeroidentificacion),'') 
		AND ISNULL(EcuadorRepresentantelegalTipo,'') = ISNULL(ISNULL(@EcuadorRepresentantelegalTipo,EcuadorRepresentantelegalTipo),'')
		AND ISNULL(EcuadorRUCContadorTipo,'') = ISNULL(ISNULL(@EcuadorRUCContadorTipo,EcuadorRUCContadorTipo),'')				
	   					
	   FOR XML AUTO)	

    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
  
    SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'
 
  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
   BEGIN
     COMMIT TRANSACTION 
   END ELSE
    BEGIN
      ROLLBACK TRANSACTION 
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')    
    END
  END
END
GO
/************** spIntelisisCuentaCteTipoListado ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaCteTipoListado') and type = 'P') drop procedure dbo.spIntelisisCuentaCteTipoListado
GO             
CREATE PROCEDURE spIntelisisCuentaCteTipoListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
		
		@Orden				int,
		@Tipo				varchar(20),
		@INFORDescripcion		varchar(255),
		@Texto				xml,
		@ReferenciaIS			varchar(100),
		@SubReferencia			varchar(100)
			




  SELECT @Orden = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Orden'
  SELECT @Tipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Tipo'
  SELECT @INFORDescripcion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'INFORDescripcion'
  

  SELECT @Texto =(SELECT * FROM CteTipo 
   WHERE  ISNULL(Tipo,'') = ISNULL(ISNULL(@Tipo,Tipo),'')
     AND  ISNULL(Orden,'') = ISNULL(ISNULL(@Orden,Orden),'')
     FOR XML AUTO)	

  IF @@ERROR <> 0 SET @Ok = 1
  BEGIN
    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
    IF @@ERROR <> 0 SET @Ok = 1
    
    IF @Ok IS NULL
    BEGIN
      SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'
      IF @@ERROR <> 0 SET @Ok = 1
    END
  END
END
GO
/**************** spIntelisisCuentaSucursalListado  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaSucursalListado') and type = 'P') drop procedure dbo.spIntelisisCuentaSucursalListado
GO             
CREATE PROCEDURE spIntelisisCuentaSucursalListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
         @Sucursal  			    varchar(10)  ,
         @Nombre  					varchar(100),
         @Prefijo  					char(5),
         @Relacion  			    varchar(20),
         @Direccion  			    varchar(100),
         @DireccionNumero  			varchar(20),
         @DireccionNumeroInt  		varchar(20),
         @Delegacion  			    varchar(100),
         @GLN  						varchar(50),
         @Colonia  					varchar(30),
         @Poblacion  			    varchar(30),
         @Estado  					varchar(30),
         @Pais  					varchar(30),
         @CodigoPostal  			varchar(15),
         @Telefonos  			    varchar(100),
         @Fax  						varchar(50),
         @Estatus  					char(15),
         @UltimoCambio  			datetime   ,
         @RFC  						varchar(20),
         @RegistroPatronal  		varchar(20),
         @Encargado  			    varchar(100),
         @Alta  					datetime   ,
         @Region  					varchar(50),
         @CentralRegional  			bit   ,
         @EnLinea  					bit   ,
         @SucursalPrincipal  		int   ,
         @ListaPreciosEsp  			varchar(20),
         @Cajeros  					bit   ,
         @CentroCostos  			varchar(20),
         @OperacionContinua  		bit   ,
         @ZonaEconomica  			varchar(30),
         @Grupo  					varchar(50),
         @AlmacenPrincipal  		char(10),
         @Servidor  			    varchar(50),
         @BaseDatos  			    varchar(50),
         @Usuario  					varchar(10),
         @ZonaImpuesto  			varchar(30),
         @CajaCentral  			    varchar(10),
         @wMovVentas  			    varchar(20),
         @wAlmacen  			    varchar(10),
         @wAgente  					varchar(10),
         @wUsuario  			    varchar(10),
         @wUEN  					int   ,
         @wConcepto  			    varchar(50),
         @CRTipoCredito  			varchar(20),
         @Cliente  					varchar(10),
         @Categoria  			    varchar(50),
         @Acreedor  			    varchar(10),
         @LocalidadCNBV  		    varchar(10),
         @Tipo  					varchar(50),
         @FechaApertura  		    datetime   ,
         @VencimientoContrato  	    datetime   ,
         @Metros   					float   ,
         @CostoBase  			    varchar(50),
         @UltimaSincronizacion      datetime   ,
         @IP  						varchar(20),
         @IPDinamica  			    bit   ,
         @IPPuerto  			    int   ,
         @ComunicacionEncriptada    bit   ,
         @MapaLatitud   		    float   ,
         @MapaLongitud   		    float   ,
         @MapaPrecision  		    int   ,
         @BloquearCobroTarjeta      bit   ,
         @FiscalRegimen  		    varchar(30),
         @ReferenciaIntelisisService varchar(50),
		 @Texto						xml,
		 @ReferenciaIS				varchar(100),
		 @SubReferencia				varchar(100)
			
 SELECT @Sucursal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Sucursal'   
  SELECT @Nombre = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Nombre'  
  SELECT @Prefijo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Prefijo'   
  SELECT @Relacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Relacion'   
  SELECT @Direccion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Direccion'   
  SELECT @DireccionNumero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DireccionNumero'   
  SELECT @DireccionNumeroInt = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'DireccionNumeroInt'   
  SELECT @Delegacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Delegacion'
  SELECT @GLN = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'GLN'
  SELECT @Colonia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Colonia'  
  SELECT @Poblacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Poblacion'   
  SELECT @Estado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Estado' 
  SELECT @Pais = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Pais'  
  SELECT @CodigoPostal  = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CodigoPostal'  
  SELECT @Telefonos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Telefonos' 
  SELECT @Fax = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Fax'
  SELECT @Estatus = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Estatus'  
  SELECT @UltimoCambio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'UltimoCambio'   
  SELECT @RFC = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'RFC'
  SELECT @RegistroPatronal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'RegistroPatronal'   
  SELECT @Encargado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Encargado'
  SELECT @Alta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Alta'
  SELECT @Region = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Region'   
  SELECT @CentralRegional = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CentralRegional'  
  SELECT @EnLinea = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'EnLinea'
  SELECT @SucursalPrincipal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'SucursalPrincipal'  
  SELECT @ListaPreciosEsp = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ListaPreciosEsp'  
  SELECT @Cajeros = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Cajeros'
  SELECT @CentroCostos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CentroCostos'   
  SELECT @OperacionContinua = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'OperacionContinua'   
  SELECT @ZonaEconomica = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ZonaEconomica'
  SELECT @Grupo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Grupo'
  SELECT @AlmacenPrincipal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'AlmacenPrincipal'   
  SELECT @Servidor = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Servidor'
  SELECT @BaseDatos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'BaseDatos'
  SELECT @Usuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Usuario'  
  SELECT @ZonaImpuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ZonaImpuesto'  
  SELECT @CajaCentral = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CajaCentral'   
  SELECT @wMovVentas = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'wMovVentas'   
  SELECT @wAlmacen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'wAlmacen'  
  SELECT @wAgente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'wAgente'   
  SELECT @wUsuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'wUsuario'   
  SELECT @wUEN = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'wUEN'
  SELECT @wConcepto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'wConcepto'   
  SELECT @CRTipoCredito = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CRTipoCredito'  
  SELECT @Cliente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Cliente'
  SELECT @Categoria = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Categoria'   
  SELECT @Acreedor = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Acreedor'   
  SELECT @LocalidadCNBV = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'LocalidadCNBV'   
  SELECT @Tipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Tipo'
  SELECT @FechaApertura = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FechaApertura'   
  SELECT @VencimientoContrato = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'VencimientoContrato' 
  SELECT @Metros = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Metros'
  SELECT @CostoBase = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CostoBase'   
  SELECT @UltimaSincronizacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'UltimaSincronizacion'   
  SELECT @IP = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'IP'
  SELECT @IPDinamica = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'IPDinamica' 
  SELECT @IPPuerto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'IPPuerto'  
  SELECT @ComunicacionEncriptada = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'ComunicacionEncriptada'   
  SELECT @MapaLatitud = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'MapaLatitud'
  SELECT @MapaLongitud = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'MapaLongitud'   
  SELECT @MapaPrecision = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'MapaPrecision'   
  SELECT @BloquearCobroTarjeta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'BloquearCobroTarjeta'  
  SELECT @FiscalRegimen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH(Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'FiscalRegimen'

  SELECT @Texto =(SELECT * FROM Sucursal
   WHERE ISNULL(Sucursal,'') = ISNULL(ISNULL(@Sucursal,Sucursal),'') 
	 AND ISNULL(Nombre,'') = ISNULL(ISNULL(@Nombre,Nombre),'') 
     AND ISNULL(Prefijo,'') = ISNULL(ISNULL(@Prefijo,Prefijo),'') 
	 AND ISNULL(Relacion,'') = ISNULL(ISNULL(@Relacion,Relacion),'') 
	 AND ISNULL(Direccion,'') = ISNULL(ISNULL(@Direccion,Direccion),'') 
	 AND ISNULL(DireccionNumero,'') = ISNULL(ISNULL(@DireccionNumero,DireccionNumero),'') 
	 AND ISNULL(DireccionNumeroInt,'') = ISNULL(ISNULL(@DireccionNumeroInt,DireccionNumeroInt),'') 
	 AND ISNULL(Delegacion,'') = ISNULL(ISNULL(@Delegacion,Delegacion),'') 
	 AND ISNULL(GLN,'') = ISNULL(ISNULL(@GLN,GLN),'') 
	 AND ISNULL(Colonia,'') = ISNULL(ISNULL(@Colonia,Colonia),'') 
	 AND ISNULL(Poblacion,'') = ISNULL(ISNULL(@Poblacion,Poblacion),'') 
	 AND ISNULL(Estado,'') = ISNULL(ISNULL(@Estado,Estado),'') 
	 AND ISNULL(Pais,'') = ISNULL(ISNULL(@Pais,Pais),'') 
	 AND ISNULL(CodigoPostal,'') = ISNULL(ISNULL(@CodigoPostal,CodigoPostal),'') 
	 AND ISNULL(Telefonos,'') = ISNULL(ISNULL(@Telefonos,Telefonos),'') 
	 AND ISNULL(Fax,'') = ISNULL(ISNULL(@Fax,Fax),'') 
	 AND ISNULL(Estatus,'') = ISNULL(ISNULL(@Estatus,Estatus),'') 
	 AND ISNULL(UltimoCambio,'') = ISNULL(ISNULL(@UltimoCambio,UltimoCambio),'') 
	 AND ISNULL(RFC,'') = ISNULL(ISNULL(@RFC,RFC),'') 
	 AND ISNULL(RegistroPatronal,'') = ISNULL(ISNULL(@RegistroPatronal,RegistroPatronal),'') 
	 AND ISNULL(Encargado,'') = ISNULL(ISNULL(@Encargado,Encargado),'') 
	 AND ISNULL(Alta,'') = ISNULL(ISNULL(@Alta,Alta),'') 
	 AND ISNULL(Region,'') = ISNULL(ISNULL(@Region,Region),'') 
	 AND ISNULL(CentralRegional,'') = ISNULL(ISNULL(@CentralRegional,CentralRegional),'') 
	 AND ISNULL(EnLinea,'') = ISNULL(ISNULL(@EnLinea,EnLinea),'') 
	 AND ISNULL(SucursalPrincipal,'') = ISNULL(ISNULL(@SucursalPrincipal,SucursalPrincipal),'') 
	 AND ISNULL(ListaPreciosEsp,'') = ISNULL(ISNULL(@ListaPreciosEsp,ListaPreciosEsp),'') 
	 AND ISNULL(Cajeros,'') = ISNULL(ISNULL(@Cajeros,Cajeros),'') 
	 AND ISNULL(CentroCostos,'') = ISNULL(ISNULL(@CentroCostos,CentroCostos),'') 
	 AND ISNULL(OperacionContinua,'') = ISNULL(ISNULL(@OperacionContinua,OperacionContinua),'') 
	 AND ISNULL(ZonaEconomica,'') = ISNULL(ISNULL(@ZonaEconomica,ZonaEconomica),'') 
	 AND ISNULL(Grupo,'') = ISNULL(ISNULL(@Grupo,Grupo),'') 
	 AND ISNULL(AlmacenPrincipal,'') = ISNULL(ISNULL(@AlmacenPrincipal,AlmacenPrincipal),'') 
	 AND ISNULL(Servidor,'') = ISNULL(ISNULL(@Servidor,Servidor),'') 
	 AND ISNULL(BaseDatos,'') = ISNULL(ISNULL(@BaseDatos,BaseDatos),'') 
	 AND ISNULL(Usuario,'') = ISNULL(ISNULL(@Usuario,Usuario),'') 
	 AND ISNULL(ZonaImpuesto,'') = ISNULL(ISNULL(@ZonaImpuesto,ZonaImpuesto),'') 
	 AND ISNULL(CajaCentral,'') = ISNULL(ISNULL(@CajaCentral,CajaCentral),'') 
	 AND ISNULL(wMovVentas,'') = ISNULL(ISNULL(@wMovVentas,wMovVentas),'') 
	 AND ISNULL(wAlmacen,'') = ISNULL(ISNULL(@wAlmacen,wAlmacen),'') 
	 AND ISNULL(wAgente,'') = ISNULL(ISNULL(@wAgente,wAgente),'') 
	 AND ISNULL(wUsuario,'') = ISNULL(ISNULL(@wUsuario,wUsuario),'') 
	 AND ISNULL(wUEN,'') = ISNULL(ISNULL(@wUEN,wUEN),'') 
	 AND ISNULL(wConcepto,'') = ISNULL(ISNULL(@wConcepto,wConcepto),'') 
	 AND ISNULL(CRTipoCredito,'') = ISNULL(ISNULL(@CRTipoCredito,CRTipoCredito),'') 
	 AND ISNULL(Cliente,'') = ISNULL(ISNULL(@Cliente,Cliente),'') 
	 AND ISNULL(Categoria,'') = ISNULL(ISNULL(@Categoria,Categoria),'') 
	 AND ISNULL(Acreedor,'') = ISNULL(ISNULL(@Acreedor,Acreedor),'') 
	 AND ISNULL(LocalidadCNBV,'') = ISNULL(ISNULL(@LocalidadCNBV,LocalidadCNBV),'') 
	 AND ISNULL(Tipo,'') = ISNULL(ISNULL(@Tipo,Tipo),'') 
	 AND ISNULL(FechaApertura,'') = ISNULL(ISNULL(@FechaApertura,FechaApertura),'') 
	 AND ISNULL(VencimientoContrato,'') = ISNULL(ISNULL(@VencimientoContrato,VencimientoContrato),'') 
	 AND ISNULL(Metros,'') = ISNULL(ISNULL(@Metros,Metros),'') 
	 AND ISNULL(CostoBase,'') = ISNULL(ISNULL(@CostoBase,CostoBase),'') 
	 AND ISNULL(UltimaSincronizacion,'') = ISNULL(ISNULL(@UltimaSincronizacion,UltimaSincronizacion),'') 
	 AND ISNULL(IP,'') = ISNULL(ISNULL(@IP,IP),'') 
	 AND ISNULL(IPDinamica,'') = ISNULL(ISNULL(@IPDinamica,IPDinamica),'') 
	 AND ISNULL(IPPuerto,'') = ISNULL(ISNULL(@IPPuerto,IPPuerto),'') 
	 AND ISNULL(ComunicacionEncriptada,'') = ISNULL(ISNULL(@ComunicacionEncriptada,ComunicacionEncriptada),'') 
	 AND ISNULL(MapaLatitud,'') = ISNULL(ISNULL(@MapaLatitud,MapaLatitud),'') 
	 AND ISNULL(MapaLongitud,'') = ISNULL(ISNULL(@MapaLongitud,MapaLongitud),'') 
	 AND ISNULL(MapaPrecision,'') = ISNULL(ISNULL(@MapaPrecision,MapaPrecision),'') 
	 AND ISNULL(BloquearCobroTarjeta,'') = ISNULL(ISNULL(@BloquearCobroTarjeta,BloquearCobroTarjeta),'') 
	 AND ISNULL(FiscalRegimen,'') = ISNULL(ISNULL(@FiscalRegimen,FiscalRegimen),'') 			
	   					
	   FOR XML AUTO)	

  IF @@ERROR <> 0 SET @Ok = 1
  BEGIN
    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
    IF @@ERROR <> 0 SET @Ok = 1
    
    IF @Ok IS NULL
    BEGIN
      SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'
      IF @@ERROR <> 0 SET @Ok = 1
    END
  END
END
GO
/**************** spIntelisisCuentaArticuloListado  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaArticuloListado') and type = 'P') drop procedure dbo.spIntelisisCuentaArticuloListado
GO             
CREATE PROCEDURE spIntelisisCuentaArticuloListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
					@Articulo					varchar	(20),
					@Rama						varchar	(20),
					@Descripcion1				varchar	(100),
					@Descripcion2				varchar	(255),
					@NombreCorto				varchar	(20),
					@Grupo						varchar	(50),
					@Categoria					varchar	(50),
					@CategoriaActivoFijo		varchar	(50),
					@Familia					varchar	(50),
					@Linea						varchar	(50),
					@Fabricante					varchar	(50),
					@ClaveFabricante			varchar	(50),
					@Impuesto1					float,	
					@Impuesto2					float,	
					@Impuesto3					float,	
					@Factor						varchar	(50),
					@Unidad						varchar	(50),
					@UnidadCompra				varchar	(50),
					@UnidadTraspaso				varchar	(50),
					@UnidadCantidad				float,	
					@TipoCosteo					varchar	(10),
					@Peso						float,	
					@Tara						float,	
					@Volumen					float,	
					@Tipo						varchar	(20),
					@TipoOpcion					varchar	(20),
					@Accesorios					bit,	
					@Refacciones				bit,
					@Sustitutos					bit,
					@Servicios					bit,
					@Consumibles				bit,	
					@MonedaCosto				varchar	(10),
					@MonedaPrecio				varchar	(10),
					@MargenMinimo				money,	
					@PrecioLista				money,	
					@PrecioMinimo				money,	
					@FactorAlterno				float,	
					@PrecioAnterior				money,	
					@Utilidad					varchar	(50),
					@DescuentoCompra			float,	
					@Clase						varchar	(15),
					@Estatus					varchar	(15),
					@UltimoCambio				datetime,	
					@Alta						datetime,	
					@Conciliar					bit,	
					@Mensaje					varchar	(50),
					@Comision					varchar	(50),
					@Arancel					varchar	(50),
					@ArancelDesperdicio			varchar	(50),
					@ABC						varchar	(1),
					@Usuario					varchar	(10),
					@Precio2					money,	
					@Precio3					money,	
					@Precio4					money,	
					@Precio5					money,	
					@Precio6					money,	
					@Precio7					money,	
					@Precio8					money,	
					@Precio9					money,	
					@Precio10					money,	
					@Refrigeracion				bit,	
					@TieneCaducidad				bit,
					@BasculaPesar				bit,	
					@SeProduce					bit,	
					@Situacion					varchar	(50),
					@SituacionFecha				datetime,	
					@SituacionUsuario			varchar	(10),
					@SituacionNota				varchar	(100),
					@EstatusPrecio				varchar	(15),
					@wMostrar					bit,	
					@Merma						float,	
					@Desperdicio				float,	
					@SeCompra					bit,	
					@SeVende					bit,	
					@EsFormula					bit,	
					@TiempoEntrega				int,	
					@TiempoEntregaUnidad		varchar	(10),
					@TiempoEntregaSeg			int,	
					@TiempoEntregaSegUnidad		varchar	(10),
					@LoteOrdenar				varchar	(30),
					@CantidadOrdenar			float,	
					@MultiplosOrdenar			float,	
					@InvSeguridad				float,	
					@ProdRuta					varchar	(20),
					@AlmacenROP					varchar	(10),
					@CategoriaProd				varchar	(50),
					@ProdCantidad				float,	
					@ProdUsuario				varchar	(10),
					@ProdPasoTotal				int,	
					@ProdMovGrupo				varchar	(50),
					@ProdEstacion				varchar	(10),
					@ProdOpciones				bit,	
					@ProdVerConcentracion		bit,
					@ProdVerCostoAcumulado		bit,	
					@ProdVerMerma				bit,	
					@ProdVerDesperdicio			bit,	
					@ProdVerPorcentaje			bit,	
					@RevisionUltima				datetime,	
					@RevisionUsuario			varchar	(10),
					@RevisionFrecuencia			int,	
					@RevisionFrecuenciaUnidad	varchar	(10),
					@RevisionSiguiente			datetime,	
					@ProdMov					varchar	(20),
					@TipoCompra					varchar	(20),
					@TieneMovimientos			bit,	
					@Registro1					varchar	(20),
					@Registro1Vencimiento		datetime,	
					@AlmacenEspecificoVenta		varchar	(10),
					@AlmacenEspecificoVentaMov	varchar	(20),
					@RutaDistribucion			varchar	(50),
					@CostoEstandar				float,	
					@CostoReposicion			float,	
					@EstatusCosto				varchar	(15),
					@Margen						money,	
					@Proveedor					varchar	(10),
					@NivelAcceso				varchar	(50),
					@Temporada					varchar	(50),
					@SolicitarPrecios			bit,	
					@AutoRecaudacion			varchar	(30),
					@Concepto					varchar	(50),
					@Cuenta						varchar	(20),
					@Retencion1					float,	
					@Retencion2					float,	
					@Retencion3					float,	
					@Espacios					bit,	
					@EspaciosEspecificos		bit,	
					@EspaciosSobreventa			float,	
					@EspaciosNivel				varchar	(50),
					@EspaciosMinutos			int,	
					@EspaciosBloquearAnteriores	bit,	
					@EspaciosHoraD				varchar	(5),
					@EspaciosHoraA				varchar	(5),
					@SerieLoteInfo				bit,	
					@CantidadMinimaVenta		float,	
					@CantidadMaximaVenta		float,	
					@EstimuloFiscal				float,	
					@OrigenPais					varchar	(50),
					@OrigenLocalidad			varchar	(50),
					@Incentivo					money,	
					@FactorCompra				float,	
					@Horas						float,	
					@ISAN						bit,	
					@ExcluirDescFormaPago		bit,	
					@EsDeducible				bit,	
					@Peaje						money,	
					@CodigoAlterno				varchar	(50),
					@TipoCatalogo				varchar	(20),
					@AnexosAlFacturar			bit,	
					@CaducidadMinima			int,	
					@Actividades				bit,	
					@ValidarPresupuestoCompra	varchar	(20),
					@SeriesLotesAutoOrden		varchar	(20),
					@LotesFijos					bit,	
					@LotesAuto					bit,
					@Consecutivo				int,	
					@TipoEmpaque				varchar	(50),
					@Modelo						varchar	(4),
					@ArtVersion					varchar	(50),
					@TieneDireccion				bit,	
					@Direccion					varchar	(100),
					@DireccionNumero			varchar	(20),
					@DireccionNumeroInt			varchar	(20),
					@EntreCalles				varchar	(100),
					@Plano						varchar	(15),
					@Observaciones				varchar	(100),
					@Colonia					varchar	(100),
					@Delegacion					varchar	(100),
					@Poblacion					varchar	(100),
					@Estado						varchar	(30),
					@Pais						varchar	(30),
					@CodigoPostal				varchar	(15),
					@Ruta						varchar	(50),
					@Codigo						varchar	(50),
					@ClaveVehicular				varchar	(20),
					@TipoVehiculo				varchar	(20),
					@DiasLibresIntereses		int,	
					@PrecioLiberado				bit,	
					@ValidarCodigo				bit,	
					@Presentacion				varchar	(50),
					@GarantiaPlazo				int,	
					@CostoIdentificado			bit,	
					@CantidadTarima				float,	
					@UnidadTarima				varchar	(50),
					@MinimoTarima				float,	
					@DepartamentoDetallista		int,	
					@TratadoComercial			varchar	(50),
					@CuentaPresupuesto			varchar	(20),
					@ProgramaSectorial			varchar	(50),
					@PedimentoClave				varchar	(5),
					@PedimentoRegimen			varchar	(5),
					@Permiso					varchar	(20),
					@PermisoRenglon				varchar	(20),
					@Cuenta2					varchar	(20),
					@Cuenta3					varchar	(20),
					@Impuesto1Excento			bit,	
					@CalcularPresupuesto		bit,
					@InflacionPresupuesto		float,	
					@Excento2					bit,	
					@Excento3					bit,	
					@ContUso					varchar	(20),
					@ContUso2					varchar	(20),
					@ContUso3					varchar	(20),
					@NivelToleranciaCosto		varchar	(10),
					@ToleranciaCosto			money,	
					@ToleranciaCostoInferior	money,	
					@ObjetoGasto				varchar	(10),
					@ObjetoGastoRef				varchar	(10),
					@ClavePresupuestalImpuesto1	varchar	(50),
					@Estructura					varchar	(50),
					@TipoImpuesto1				varchar	(10),
					@TipoImpuesto2				varchar	(10),
					@TipoImpuesto3				varchar	(10),
					@TipoRetencion1				varchar	(10),
					@TipoRetencion2				varchar	(10),
					@TipoRetencion3				varchar	(10),
					@TipoImpuesto4				varchar	(10),
					@Calificacion				smallint,
					@Texto						xml,
					@ReferenciaIS				varchar(100),
					@SubReferencia				varchar(100),
					@UltimoCosto				float,
					@CostoPromedio				float,
					@Empresa					varchar(20),
					@ID0						int,
					@Sucursal					int

  BEGIN TRANSACTION 
  IF @Ok IS NULL
  BEGIN
    SELECT @ID0 = dbo.fnAccesoID(@@SPID)
  
    SELECT @Empresa = Empresa, @Sucursal = Sucursal FROM Acceso WHERE ID = @ID0
									


    SELECT @Articulo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Articulo'
    SELECT @Rama = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Rama'
    SELECT @Descripcion1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Descripcion1'
    SELECT @Descripcion2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Descripcion2'
    SELECT @NombreCorto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'NombreCorto'
    SELECT @Grupo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Grupo'
    SELECT @Categoria = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Categoria'
    SELECT @CategoriaActivoFijo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'CategoriaActivoFijo'
    SELECT @Familia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Familia'
    SELECT @Linea = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Linea'
    SELECT @Fabricante = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Fabricante'
    SELECT @ClaveFabricante = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ClaveFabricante'
    SELECT @Impuesto1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Impuesto1'
    SELECT @Impuesto2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Impuesto2'
    SELECT @Impuesto3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Impuesto3'
    SELECT @Factor = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Factor'
    SELECT @Unidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Unidad'
    SELECT @UnidadCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'UnidadCompra'
    SELECT @UnidadTraspaso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'UnidadTraspaso'
    SELECT @UnidadCantidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'UnidadCantidad'
    SELECT @TipoCosteo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'TipoCosteo'
    SELECT @Peso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Peso'
    SELECT @Tara = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Tara'
    SELECT @Volumen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Volumen'
    SELECT @Tipo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Tipo'
    SELECT @TipoOpcion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'TipoOpcion'
    SELECT @Accesorios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Accesorios'
    SELECT @Refacciones = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Refacciones'
    SELECT @Sustitutos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Sustitutos'
    SELECT @Servicios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Servicios'
    SELECT @Consumibles = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Consumibles'
    SELECT @MonedaCosto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'MonedaCosto'
    SELECT @MonedaPrecio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'MonedaPrecio'
    SELECT @MargenMinimo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'MargenMinimo'
    SELECT @PrecioLista = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'PrecioLista'
    SELECT @PrecioMinimo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'PrecioMinimo'
    SELECT @FactorAlterno = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'FactorAlterno'
    SELECT @PrecioAnterior = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'PrecioAnterior'
    SELECT @Utilidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Utilidad'
    SELECT @DescuentoCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'DescuentoCompra'
    SELECT @Clase = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Clase'
    SELECT @Estatus = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Estatus'
    SELECT @UltimoCambio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'UltimoCambio'
    SELECT @Alta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Alta'
    SELECT @Conciliar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Conciliar'
    SELECT @Mensaje = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Mensaje'
    SELECT @Comision = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Comision'
    SELECT @Arancel = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Arancel'
    SELECT @ArancelDesperdicio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ArancelDesperdicio'
    SELECT @ABC = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ABC'
    SELECT @Usuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Usuario'
    SELECT @Precio2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Precio2'
    SELECT @Precio3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Precio3'
    SELECT @Precio4 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Precio4'
    SELECT @Precio5 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Precio5'
    SELECT @Precio6 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Precio6'
    SELECT @Precio7 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Precio7'
    SELECT @Precio8 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Precio8'
    SELECT @Precio9 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Precio9'
    SELECT @Precio10 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Precio10'
    SELECT @Refrigeracion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Refrigeracion'
    SELECT @TieneCaducidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'TieneCaducidad'
    SELECT @BasculaPesar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'BasculaPesar'
    SELECT @SeProduce = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'SeProduce'
    SELECT @Situacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Situacion'
    SELECT @SituacionFecha = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'SituacionFecha'
    SELECT @SituacionUsuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'SituacionUsuario'
    SELECT @SituacionNota = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'SituacionNota'
    SELECT @EstatusPrecio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'EstatusPrecio'
    SELECT @wMostrar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'wMostrar'
    SELECT @Merma = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Merma'
    SELECT @Desperdicio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Desperdicio'
    SELECT @SeCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'SeCompra'
    SELECT @SeVende = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'SeVende'
    SELECT @EsFormula = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'EsFormula'
    SELECT @TiempoEntrega = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'TiempoEntrega'
    SELECT @TiempoEntregaUnidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'TiempoEntregaUnidad'
    SELECT @TiempoEntregaSeg = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'TiempoEntregaSeg'
    SELECT @TiempoEntregaSegUnidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'TiempoEntregaSegUnidad'
    SELECT @LoteOrdenar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'LoteOrdenar'
    SELECT @CantidadOrdenar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'CantidadOrdenar'
    SELECT @MultiplosOrdenar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'MultiplosOrdenar'
    SELECT @InvSeguridad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'InvSeguridad'
    SELECT @ProdRuta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ProdRuta'
    SELECT @AlmacenROP = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'AlmacenROP'
    SELECT @CategoriaProd = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'CategoriaProd'
    SELECT @ProdCantidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ProdCantidad'
    SELECT @ProdUsuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ProdUsuario'
    SELECT @ProdPasoTotal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ProdPasoTotal'
    SELECT @ProdMovGrupo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ProdMovGrupo'
    SELECT @ProdEstacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ProdEstacion'
    SELECT @ProdOpciones = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ProdOpciones'
    SELECT @ProdVerConcentracion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ProdVerConcentracion'
    SELECT @ProdVerCostoAcumulado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ProdVerCostoAcumulado'
    SELECT @ProdVerMerma = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ProdVerMerma'
    SELECT @ProdVerDesperdicio = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ProdVerDesperdicio'
    SELECT @ProdVerPorcentaje = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ProdVerPorcentaje'
    SELECT @RevisionUltima = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'RevisionUltima'
    SELECT @RevisionUsuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'RevisionUsuario'
    SELECT @RevisionFrecuencia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'RevisionFrecuencia'
    SELECT @RevisionFrecuenciaUnidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'RevisionFrecuenciaUnidad'
    SELECT @RevisionSiguiente = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'RevisionSiguiente'
    SELECT @ProdMov = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ProdMov'
    SELECT @TipoCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'TipoCompra'
    SELECT @TieneMovimientos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'TieneMovimientos'
    SELECT @Registro1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Registro1'
    SELECT @Registro1Vencimiento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Registro1Vencimiento'
    SELECT @AlmacenEspecificoVenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'AlmacenEspecificoVenta'
    SELECT @AlmacenEspecificoVentaMov = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'AlmacenEspecificoVentaMov'
    SELECT @RutaDistribucion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'RutaDistribucion'
    SELECT @CostoEstandar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'CostoEstandar'
    SELECT @CostoReposicion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'CostoReposicion'
    SELECT @EstatusCosto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'EstatusCosto'
    SELECT @Margen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Margen'
    SELECT @Proveedor = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Proveedor'
    SELECT @NivelAcceso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'NivelAcceso'
    SELECT @Temporada = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Temporada'
    SELECT @SolicitarPrecios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'SolicitarPrecios'
    SELECT @AutoRecaudacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'AutoRecaudacion'
    SELECT @Concepto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Concepto'
    SELECT @Cuenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Cuenta'
    SELECT @Retencion1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Retencion1'
    SELECT @Retencion2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Retencion2'
    SELECT @Retencion3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Retencion3'
    SELECT @Espacios = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Espacios'
    SELECT @EspaciosEspecificos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'EspaciosEspecificos'
    SELECT @EspaciosSobreventa = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'EspaciosSobreventa'
    SELECT @EspaciosNivel = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'EspaciosNivel'
    SELECT @EspaciosMinutos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'EspaciosMinutos'
    SELECT @EspaciosBloquearAnteriores = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'EspaciosBloquearAnteriores'
    SELECT @EspaciosHoraD = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'EspaciosHoraD'
    SELECT @EspaciosHoraA = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'EspaciosHoraA'
    SELECT @SerieLoteInfo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'SerieLoteInfo'
    SELECT @CantidadMinimaVenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'CantidadMinimaVenta'
    SELECT @CantidadMaximaVenta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'CantidadMaximaVenta'
    SELECT @EstimuloFiscal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'EstimuloFiscal'
    SELECT @OrigenPais = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'OrigenPais'
    SELECT @OrigenLocalidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'OrigenLocalidad'
    SELECT @Incentivo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Incentivo'
    SELECT @FactorCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'FactorCompra'
    SELECT @Horas = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Horas'
    SELECT @ISAN = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ISAN'
    SELECT @ExcluirDescFormaPago = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ExcluirDescFormaPago'
    SELECT @EsDeducible = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'EsDeducible'
    SELECT @Peaje = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Peaje'
    SELECT @CodigoAlterno = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'CodigoAlterno'
    SELECT @TipoCatalogo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'TipoCatalogo'
    SELECT @AnexosAlFacturar = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'AnexosAlFacturar'
    SELECT @CaducidadMinima = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'CaducidadMinima'
    SELECT @Actividades = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Actividades'
    SELECT @ValidarPresupuestoCompra = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ValidarPresupuestoCompra'
    SELECT @SeriesLotesAutoOrden = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'SeriesLotesAutoOrden'
    SELECT @LotesFijos = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'LotesFijos'
    SELECT @LotesAuto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'LotesAuto'
    SELECT @Consecutivo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Consecutivo' 
    SELECT @TipoEmpaque = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'TipoEmpaque'
    SELECT @Modelo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Modelo'
    SELECT @ArtVersion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Version'
    SELECT @TieneDireccion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'TieneDireccion'
    SELECT @Direccion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Direccion'
    SELECT @DireccionNumero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'DireccionNumero'
    SELECT @DireccionNumeroInt = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'DireccionNumeroInt'
    SELECT @EntreCalles = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'EntreCalles'
    SELECT @Plano = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Plano'
    SELECT @Observaciones = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Observaciones'
    SELECT @Colonia = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Colonia'
    SELECT @Delegacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Delegacion'
    SELECT @Poblacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Poblacion'
    SELECT @Estado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Estado'
    SELECT @Pais = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Pais'
    SELECT @CodigoPostal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'CodigoPostal'
    SELECT @Ruta = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Ruta'
    SELECT @Codigo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Codigo'
    SELECT @ClaveVehicular = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'ClaveVehicular'
    SELECT @TipoVehiculo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'TipoVehiculo'
    SELECT @DiasLibresIntereses = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'DiasLibresIntereses'
    SELECT @PrecioLiberado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'PrecioLiberado'
    SELECT @ValidarCodigo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'ValidarCodigo'
    SELECT @Presentacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Presentacion'
    SELECT @GarantiaPlazo = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'GarantiaPlazo'
    SELECT @CostoIdentificado = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'CostoIdentificado'
    SELECT @CantidadTarima = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'CantidadTarima'
    SELECT @UnidadTarima = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'UnidadTarima'
    SELECT @MinimoTarima = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'MinimoTarima'
    SELECT @DepartamentoDetallista = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'DepartamentoDetallista'
    SELECT @TratadoComercial = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'TratadoComercial'
    SELECT @CuentaPresupuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'CuentaPresupuesto'
    SELECT @ProgramaSectorial = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'ProgramaSectorial'
    SELECT @PedimentoClave = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'PedimentoClave'
    SELECT @PedimentoRegimen = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'PedimentoRegimen'
    SELECT @Permiso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Permiso'
    SELECT @PermisoRenglon = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'PermisoRenglon'
    SELECT @Cuenta2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Cuenta2'
    SELECT @Cuenta3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Cuenta3'
    SELECT @Impuesto1Excento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Impuesto1Excento'
    SELECT @CalcularPresupuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'CalcularPresupuesto'
    SELECT @InflacionPresupuesto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'InflacionPresupuesto'
    SELECT @Excento2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Excento2'
    SELECT @Excento3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'Excento3'
    SELECT @ContUso = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'ContUso'
    SELECT @ContUso2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'ContUso2'
    SELECT @ContUso3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'ContUso3'
    SELECT @NivelToleranciaCosto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'NivelToleranciaCosto'
    SELECT @ToleranciaCosto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'ToleranciaCosto'
    SELECT @ToleranciaCostoInferior = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'ToleranciaCostoInferior'
    SELECT @ObjetoGasto = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'ObjetoGasto'
    SELECT @ObjetoGastoRef = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'ObjetoGastoRef'
    SELECT @ClavePresupuestalImpuesto1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'ClavePresupuestalImpuesto1'
    SELECT @Estructura = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Estructura'
    SELECT @TipoImpuesto1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'TipoImpuesto1'
    SELECT @TipoImpuesto2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'TipoImpuesto2'
    SELECT @TipoImpuesto3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'TipoImpuesto3'
    SELECT @TipoRetencion1 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'TipoRetencion1'
    SELECT @TipoRetencion2 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'TipoRetencion2'
    SELECT @TipoRetencion3 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'TipoRetencion3'
    SELECT @TipoImpuesto4 = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255)) 
     WHERE Campo = 'TipoImpuesto4'
    SELECT @Calificacion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
      WITH (Campo varchar(255), Valor varchar(255))
     WHERE Campo = 'Calificacion'
     

    IF NOT EXISTS(SELECT * FROM ArtIntelisisService WHERE Empresa=@Empresa AND Sucursal=@Sucursal AND Articulo =@Articulo)select @Empresa=null,@sucursal=null

    SELECT @Texto =(SELECT * FROM ArtIntelisisService Art  
      WHERE ISNULL(Empresa,'') = ISNULL(ISNULL(@Empresa,Empresa),'')
		AND ISNULL(Sucursal,'')= ISNULL(ISNULL(@Sucursal,Sucursal),'')
		AND ISNULL(Articulo,'' ) = ISNULL(ISNULL(@Articulo,Articulo),'') 
	    AND ISNULL(Rama,'' ) = ISNULL(ISNULL(@Rama,Rama),'') 
	  	AND ISNULL(Descripcion1,'' ) = ISNULL(ISNULL(@Descripcion1,Descripcion1),'') 
		AND ISNULL(Descripcion2,'' ) = ISNULL(ISNULL(@Descripcion2,Descripcion2),'') 
		AND ISNULL(NombreCorto,'' ) = ISNULL(ISNULL(@NombreCorto,NombreCorto),'') 
		AND ISNULL(Grupo,'' ) = ISNULL(ISNULL(@Grupo,Grupo),'') 
		AND ISNULL(Categoria,'' ) = ISNULL(ISNULL(@Categoria,Categoria),'') 
		AND ISNULL(CategoriaActivoFijo,'' ) = ISNULL(ISNULL(@CategoriaActivoFijo,CategoriaActivoFijo),'') 
		AND ISNULL(Familia,'' ) = ISNULL(ISNULL(@Familia,Familia),'') 
		AND ISNULL(Linea,'' ) = ISNULL(ISNULL(@Linea,Linea),'') 
		AND ISNULL(Fabricante,'' ) = ISNULL(ISNULL(@Fabricante,Fabricante),'') 
		AND ISNULL(ClaveFabricante,'' ) = ISNULL(ISNULL(@ClaveFabricante,ClaveFabricante),'') 
		AND ISNULL(Impuesto1,'' ) = ISNULL(ISNULL(@Impuesto1,Impuesto1),'') 
		AND ISNULL(Impuesto2,'' ) = ISNULL(ISNULL(@Impuesto2,Impuesto2),'') 
		AND ISNULL(Impuesto3,'' ) = ISNULL(ISNULL(@Impuesto3,Impuesto3),'') 
		AND ISNULL(Factor,'' ) = ISNULL(ISNULL(@Factor,Factor),'') 
		AND ISNULL(Unidad,'' ) = ISNULL(ISNULL(@Unidad,Unidad),'') 
		AND ISNULL(UnidadCompra,'' ) = ISNULL(ISNULL(@UnidadCompra,UnidadCompra),'') 
		AND ISNULL(UnidadTraspaso,'' ) = ISNULL(ISNULL(@UnidadTraspaso,UnidadTraspaso),'') 
		AND ISNULL(UnidadCantidad,'' ) = ISNULL(ISNULL(@UnidadCantidad,UnidadCantidad),'') 
		AND ISNULL(TipoCosteo,'' ) = ISNULL(ISNULL(@TipoCosteo,TipoCosteo),'') 
		AND ISNULL(Peso,'' ) = ISNULL(ISNULL(@Peso,Peso),'') 
		AND ISNULL(Tara,'' ) = ISNULL(ISNULL(@Tara,Tara),'') 
		AND ISNULL(Volumen,'' ) = ISNULL(ISNULL(@Volumen,Volumen),'') 
		AND ISNULL(Tipo,'' ) = ISNULL(ISNULL(@Tipo,Tipo),'') 
		AND ISNULL(TipoOpcion,'' ) = ISNULL(ISNULL(@TipoOpcion,TipoOpcion),'') 
		AND ISNULL(Accesorios,'' ) = ISNULL(ISNULL(@Accesorios,Accesorios),'') 
		AND ISNULL(Refacciones,'' ) = ISNULL(ISNULL(@Refacciones,Refacciones),'') 
		AND ISNULL(Sustitutos,'' ) = ISNULL(ISNULL(@Sustitutos,Sustitutos),'') 
		AND ISNULL(Servicios,'' ) = ISNULL(ISNULL(@Servicios,Servicios),'') 
		AND ISNULL(Consumibles,'' ) = ISNULL(ISNULL(@Consumibles,Consumibles),'') 
		AND ISNULL(MonedaCosto,'' ) = ISNULL(ISNULL(@MonedaCosto,MonedaCosto),'') 
		AND ISNULL(MonedaPrecio,'' ) = ISNULL(ISNULL(@MonedaPrecio,MonedaPrecio),'') 
		AND ISNULL(MargenMinimo,'' ) = ISNULL(ISNULL(@MargenMinimo,MargenMinimo),'') 
		AND ISNULL(PrecioLista,'' ) = ISNULL(ISNULL(@PrecioLista,PrecioLista),'') 
		AND ISNULL(PrecioMinimo,'' ) = ISNULL(ISNULL(@PrecioMinimo,PrecioMinimo),'') 
		AND ISNULL(FactorAlterno,'' ) = ISNULL(ISNULL(@FactorAlterno,FactorAlterno),'') 
		AND ISNULL(PrecioAnterior,'' ) = ISNULL(ISNULL(@PrecioAnterior,PrecioAnterior),'') 
		AND ISNULL(Utilidad,'' ) = ISNULL(ISNULL(@Utilidad,Utilidad),'') 
		AND ISNULL(DescuentoCompra,'' ) = ISNULL(ISNULL(@DescuentoCompra,DescuentoCompra),'') 
		AND ISNULL(Clase,'' ) = ISNULL(ISNULL(@Clase,Clase),'') 
		AND ISNULL(Estatus,'' ) = ISNULL(ISNULL(@Estatus,Estatus),'') 
		AND ISNULL(UltimoCambio,'' ) = ISNULL(ISNULL(@UltimoCambio,UltimoCambio),'') 
		AND ISNULL(Alta,'' ) = ISNULL(ISNULL(@Alta,Alta),'') 
		AND ISNULL(Conciliar,'' ) = ISNULL(ISNULL(@Conciliar,Conciliar),'') 
		AND ISNULL(Mensaje,'' ) = ISNULL(ISNULL(@Mensaje,Mensaje),'') 
		AND ISNULL(Comision,'' ) = ISNULL(ISNULL(@Comision,Comision),'') 
		AND ISNULL(Arancel,'' ) = ISNULL(ISNULL(@Arancel,Arancel),'') 
		AND ISNULL(ArancelDesperdicio,'' ) = ISNULL(ISNULL(@ArancelDesperdicio,ArancelDesperdicio),'') 
		AND ISNULL(ABC,'' ) = ISNULL(ISNULL(@ABC,ABC),'') 
		AND ISNULL(Usuario,'' ) = ISNULL(ISNULL(@Usuario,Usuario),'') 
		AND ISNULL(Precio2,'' ) = ISNULL(ISNULL(@Precio2,Precio2),'') 
		AND ISNULL(Precio3,'' ) = ISNULL(ISNULL(@Precio3,Precio3),'') 
		AND ISNULL(Precio4,'' ) = ISNULL(ISNULL(@Precio4,Precio4),'') 
		AND ISNULL(Precio5,'' ) = ISNULL(ISNULL(@Precio5,Precio5),'') 
		AND ISNULL(Precio6,'' ) = ISNULL(ISNULL(@Precio6,Precio6),'') 
		AND ISNULL(Precio7,'' ) = ISNULL(ISNULL(@Precio7,Precio7),'') 
		AND ISNULL(Precio8,'' ) = ISNULL(ISNULL(@Precio8,Precio8),'') 
		AND ISNULL(Precio9,'' ) = ISNULL(ISNULL(@Precio9,Precio9),'') 
		AND ISNULL(Precio10,'' ) = ISNULL(ISNULL(@Precio10,Precio10),'') 
		AND ISNULL(Refrigeracion,'' ) = ISNULL(ISNULL(@Refrigeracion,Refrigeracion),'') 
		AND ISNULL(TieneCaducidad,'' ) = ISNULL(ISNULL(@TieneCaducidad,TieneCaducidad),'') 
		AND ISNULL(BasculaPesar,'' ) = ISNULL(ISNULL(@BasculaPesar,BasculaPesar),'') 
		AND ISNULL(SeProduce,'' ) = ISNULL(ISNULL(@SeProduce,SeProduce),'') 
		AND ISNULL(Situacion,'' ) = ISNULL(ISNULL(@Situacion,Situacion),'') 
		AND ISNULL(SituacionFecha,'' ) = ISNULL(ISNULL(@SituacionFecha,SituacionFecha),'') 
		AND ISNULL(SituacionUsuario,'' ) = ISNULL(ISNULL(@SituacionUsuario,SituacionUsuario),'') 
		AND ISNULL(SituacionNota,'' ) = ISNULL(ISNULL(@SituacionNota,SituacionNota),'') 
		AND ISNULL(EstatusPrecio,'' ) = ISNULL(ISNULL(@EstatusPrecio,EstatusPrecio),'') 
		AND ISNULL(wMostrar,'' ) = ISNULL(ISNULL(@wMostrar,wMostrar),'') 
		AND ISNULL(Merma,'' ) = ISNULL(ISNULL(@Merma,Merma),'') 
		AND ISNULL(Desperdicio,'' ) = ISNULL(ISNULL(@Desperdicio,Desperdicio),'') 
		AND ISNULL(SeCompra,'' ) = ISNULL(ISNULL(@SeCompra,SeCompra),'') 
		AND ISNULL(SeVende,'' ) = ISNULL(ISNULL(@SeVende,SeVende),'') 
		AND ISNULL(EsFormula,'' ) = ISNULL(ISNULL(@EsFormula,EsFormula),'') 
		AND ISNULL(TiempoEntrega,'' ) = ISNULL(ISNULL(@TiempoEntrega,TiempoEntrega),'') 
		AND ISNULL(TiempoEntregaUnidad,'' ) = ISNULL(ISNULL(@TiempoEntregaUnidad,TiempoEntregaUnidad),'') 
		AND ISNULL(TiempoEntregaSeg,'' ) = ISNULL(ISNULL(@TiempoEntregaSeg,TiempoEntregaSeg),'') 
		AND ISNULL(TiempoEntregaSegUnidad,'' ) = ISNULL(ISNULL(@TiempoEntregaSegUnidad,TiempoEntregaSegUnidad),'') 
		AND ISNULL(LoteOrdenar,'' ) = ISNULL(ISNULL(@LoteOrdenar,LoteOrdenar),'') 
		AND ISNULL(CantidadOrdenar,'' ) = ISNULL(ISNULL(@CantidadOrdenar,CantidadOrdenar),'') 
		AND ISNULL(MultiplosOrdenar,'' ) = ISNULL(ISNULL(@MultiplosOrdenar,MultiplosOrdenar),'') 
		AND ISNULL(InvSeguridad,'' ) = ISNULL(ISNULL(@InvSeguridad,InvSeguridad),'') 
		AND ISNULL(ProdRuta,'' ) = ISNULL(ISNULL(@ProdRuta,ProdRuta),'') 
		AND ISNULL(AlmacenROP,'' ) = ISNULL(ISNULL(@AlmacenROP,AlmacenROP),'') 
		AND ISNULL(CategoriaProd,'' ) = ISNULL(ISNULL(@CategoriaProd,CategoriaProd),'') 
		AND ISNULL(ProdCantidad,'' ) = ISNULL(ISNULL(@ProdCantidad,ProdCantidad),'') 
		AND ISNULL(ProdUsuario,'' ) = ISNULL(ISNULL(@ProdUsuario,ProdUsuario),'') 
		AND ISNULL(ProdPasoTotal,'' ) = ISNULL(ISNULL(@ProdPasoTotal,ProdPasoTotal),'') 
		AND ISNULL(ProdMovGrupo,'' ) = ISNULL(ISNULL(@ProdMovGrupo,ProdMovGrupo),'') 
		AND ISNULL(ProdEstacion,'' ) = ISNULL(ISNULL(@ProdEstacion,ProdEstacion),'') 
		AND ISNULL(ProdOpciones,'' ) = ISNULL(ISNULL(@ProdOpciones,ProdOpciones),'') 
		AND ISNULL(ProdVerConcentracion,'' ) = ISNULL(ISNULL(@ProdVerConcentracion,ProdVerConcentracion),'') 
		AND ISNULL(ProdVerCostoAcumulado,'' ) = ISNULL(ISNULL(@ProdVerCostoAcumulado,ProdVerCostoAcumulado),'') 
		AND ISNULL(ProdVerMerma,'' ) = ISNULL(ISNULL(@ProdVerMerma,ProdVerMerma),'') 
		AND ISNULL(ProdVerDesperdicio,'' ) = ISNULL(ISNULL(@ProdVerDesperdicio,ProdVerDesperdicio),'') 
		AND ISNULL(ProdVerPorcentaje,'' ) = ISNULL(ISNULL(@ProdVerPorcentaje,ProdVerPorcentaje),'') 
		AND ISNULL(RevisionUltima,'' ) = ISNULL(ISNULL(@RevisionUltima,RevisionUltima),'') 
		AND ISNULL(RevisionUsuario,'' ) = ISNULL(ISNULL(@RevisionUsuario,RevisionUsuario),'') 
		AND ISNULL(RevisionFrecuencia,'' ) = ISNULL(ISNULL(@RevisionFrecuencia,RevisionFrecuencia),'') 
		AND ISNULL(RevisionFrecuenciaUnidad,'' ) = ISNULL(ISNULL(@RevisionFrecuenciaUnidad,RevisionFrecuenciaUnidad),'') 
		AND ISNULL(RevisionSiguiente,'' ) = ISNULL(ISNULL(@RevisionSiguiente,RevisionSiguiente),'') 
		AND ISNULL(ProdMov,'' ) = ISNULL(ISNULL(@ProdMov,ProdMov),'') 
		AND ISNULL(TipoCompra,'' ) = ISNULL(ISNULL(@TipoCompra,TipoCompra),'') 
		AND ISNULL(TieneMovimientos,'' ) = ISNULL(ISNULL(@TieneMovimientos,TieneMovimientos),'') 
		AND ISNULL(Registro1,'' ) = ISNULL(ISNULL(@Registro1,Registro1),'') 
		AND ISNULL(Registro1Vencimiento,'' ) = ISNULL(ISNULL(@Registro1Vencimiento,Registro1Vencimiento),'') 
		AND ISNULL(AlmacenEspecificoVenta,'' ) = ISNULL(ISNULL(@AlmacenEspecificoVenta,AlmacenEspecificoVenta),'') 
		AND ISNULL(AlmacenEspecificoVentaMov,'' ) = ISNULL(ISNULL(@AlmacenEspecificoVentaMov,AlmacenEspecificoVentaMov),'') 
		AND ISNULL(RutaDistribucion,'' ) = ISNULL(ISNULL(@RutaDistribucion,RutaDistribucion),'') 
		AND ISNULL(CostoEstandar,'' ) = ISNULL(ISNULL(@CostoEstandar,CostoEstandar),'') 
		AND ISNULL(CostoReposicion,'' ) = ISNULL(ISNULL(@CostoReposicion,CostoReposicion),'') 
		AND ISNULL(EstatusCosto,'' ) = ISNULL(ISNULL(@EstatusCosto,EstatusCosto),'') 
		AND ISNULL(Margen,'' ) = ISNULL(ISNULL(@Margen,Margen),'') 
		AND ISNULL(Proveedor,'' ) = ISNULL(ISNULL(@Proveedor,Proveedor),'') 
		AND ISNULL(NivelAcceso,'' ) = ISNULL(ISNULL(@NivelAcceso,NivelAcceso),'') 
		AND ISNULL(Temporada,'' ) = ISNULL(ISNULL(@Temporada,Temporada),'') 
		AND ISNULL(SolicitarPrecios,'' ) = ISNULL(ISNULL(@SolicitarPrecios,SolicitarPrecios),'') 
		AND ISNULL(AutoRecaudacion,'' ) = ISNULL(ISNULL(@AutoRecaudacion,AutoRecaudacion),'') 
		AND ISNULL(Concepto,'' ) = ISNULL(ISNULL(@Concepto,Concepto),'') 
		AND ISNULL(Cuenta,'' ) = ISNULL(ISNULL(@Cuenta,Cuenta),'') 
		AND ISNULL(Retencion1,'' ) = ISNULL(ISNULL(@Retencion1,Retencion1),'') 
		AND ISNULL(Retencion2,'' ) = ISNULL(ISNULL(@Retencion2,Retencion2),'') 
		AND ISNULL(Retencion3,'' ) = ISNULL(ISNULL(@Retencion3,Retencion3),'') 
		AND ISNULL(Espacios,'' ) = ISNULL(ISNULL(@Espacios,Espacios),'') 
		AND ISNULL(EspaciosEspecificos,'' ) = ISNULL(ISNULL(@EspaciosEspecificos,EspaciosEspecificos),'') 
		AND ISNULL(EspaciosSobreventa,'' ) = ISNULL(ISNULL(@EspaciosSobreventa,EspaciosSobreventa),'') 
		AND ISNULL(EspaciosNivel,'' ) = ISNULL(ISNULL(@EspaciosNivel,EspaciosNivel),'') 
		AND ISNULL(EspaciosMinutos,'' ) = ISNULL(ISNULL(@EspaciosMinutos,EspaciosMinutos),'') 
		AND ISNULL(EspaciosBloquearAnteriores,'' ) = ISNULL(ISNULL(@EspaciosBloquearAnteriores,EspaciosBloquearAnteriores),'') 
		AND ISNULL(EspaciosHoraD,'' ) = ISNULL(ISNULL(@EspaciosHoraD,EspaciosHoraD),'') 
		AND ISNULL(EspaciosHoraA,'' ) = ISNULL(ISNULL(@EspaciosHoraA,EspaciosHoraA),'') 
		AND ISNULL(SerieLoteInfo,'' ) = ISNULL(ISNULL(@SerieLoteInfo,SerieLoteInfo),'') 
		AND ISNULL(CantidadMinimaVenta,'' ) = ISNULL(ISNULL(@CantidadMinimaVenta,CantidadMinimaVenta),'') 
		AND ISNULL(CantidadMaximaVenta,'' ) = ISNULL(ISNULL(@CantidadMaximaVenta,CantidadMaximaVenta),'') 
		AND ISNULL(EstimuloFiscal,'' ) = ISNULL(ISNULL(@EstimuloFiscal,EstimuloFiscal),'') 
		AND ISNULL(OrigenPais,'' ) = ISNULL(ISNULL(@OrigenPais,OrigenPais),'') 
		AND ISNULL(OrigenLocalidad,'' ) = ISNULL(ISNULL(@OrigenLocalidad,OrigenLocalidad),'') 
		AND ISNULL(Incentivo,'' ) = ISNULL(ISNULL(@Incentivo,Incentivo),'') 
		AND ISNULL(FactorCompra,'' ) = ISNULL(ISNULL(@FactorCompra,FactorCompra),'') 
		AND ISNULL(Horas,'' ) = ISNULL(ISNULL(@Horas,Horas),'') 
		AND ISNULL(ISAN,'' ) = ISNULL(ISNULL(@ISAN,ISAN),'') 
		AND ISNULL(ExcluirDescFormaPago,'' ) = ISNULL(ISNULL(@ExcluirDescFormaPago,ExcluirDescFormaPago),'') 
		AND ISNULL(EsDeducible,'' ) = ISNULL(ISNULL(@EsDeducible,EsDeducible),'') 
		AND ISNULL(Peaje,'' ) = ISNULL(ISNULL(@Peaje,Peaje),'') 
		AND ISNULL(CodigoAlterno,'' ) = ISNULL(ISNULL(@CodigoAlterno,CodigoAlterno),'') 
		AND ISNULL(TipoCatalogo,'' ) = ISNULL(ISNULL(@TipoCatalogo,TipoCatalogo),'') 
		AND ISNULL(AnexosAlFacturar,'' ) = ISNULL(ISNULL(@AnexosAlFacturar,AnexosAlFacturar),'') 
		AND ISNULL(CaducidadMinima,'' ) = ISNULL(ISNULL(@CaducidadMinima,CaducidadMinima),'') 
		AND ISNULL(Actividades,'' ) = ISNULL(ISNULL(@Actividades,Actividades),'') 
		AND ISNULL(ValidarPresupuestoCompra,'' ) = ISNULL(ISNULL(@ValidarPresupuestoCompra,ValidarPresupuestoCompra),'') 
		AND ISNULL(SeriesLotesAutoOrden,'' ) = ISNULL(ISNULL(@SeriesLotesAutoOrden,SeriesLotesAutoOrden),'') 
		AND ISNULL(LotesFijos,'' ) = ISNULL(ISNULL(@LotesFijos,LotesFijos),'') 
		AND ISNULL(LotesAuto,'' ) = ISNULL(ISNULL(@LotesAuto,LotesAuto),'') 
		AND ISNULL(Consecutivo,'' ) = ISNULL(ISNULL(@Consecutivo,Consecutivo),'') 
		AND ISNULL(TipoEmpaque,'' ) = ISNULL(ISNULL(@TipoEmpaque,TipoEmpaque),'') 
		AND ISNULL(Modelo,'' ) = ISNULL(ISNULL(@Modelo,Modelo),'') 
		AND ISNULL(Version,'' ) = ISNULL(ISNULL(@ArtVersion,Version),'') 
		AND ISNULL(TieneDireccion,'' ) = ISNULL(ISNULL(@TieneDireccion,TieneDireccion),'') 
		AND ISNULL(Direccion,'' ) = ISNULL(ISNULL(@Direccion,Direccion),'') 
		AND ISNULL(DireccionNumero,'' ) = ISNULL(ISNULL(@DireccionNumero,DireccionNumero),'') 
		AND ISNULL(DireccionNumeroInt,'' ) = ISNULL(ISNULL(@DireccionNumeroInt,DireccionNumeroInt),'') 
		AND ISNULL(EntreCalles,'' ) = ISNULL(ISNULL(@EntreCalles,EntreCalles),'') 
		AND ISNULL(Plano,'' ) = ISNULL(ISNULL(@Plano,Plano),'') 
		AND ISNULL(Observaciones,'' ) = ISNULL(ISNULL(@Observaciones,Observaciones),'') 
		AND ISNULL(Colonia,'' ) = ISNULL(ISNULL(@Colonia,Colonia),'') 
		AND ISNULL(Delegacion,'' ) = ISNULL(ISNULL(@Delegacion,Delegacion),'') 
		AND ISNULL(Poblacion,'' ) = ISNULL(ISNULL(@Poblacion,Poblacion),'') 
		AND ISNULL(Estado,'' ) = ISNULL(ISNULL(@Estado,Estado),'') 
		AND ISNULL(Pais,'' ) = ISNULL(ISNULL(@Pais,Pais),'') 
		AND ISNULL(CodigoPostal,'' ) = ISNULL(ISNULL(@CodigoPostal,CodigoPostal),'') 
		AND ISNULL(Ruta,'' ) = ISNULL(ISNULL(@Ruta,Ruta),'') 
		AND ISNULL(Codigo,'' ) = ISNULL(ISNULL(@Codigo,Codigo),'') 
		AND ISNULL(ClaveVehicular,'' ) = ISNULL(ISNULL(@ClaveVehicular,ClaveVehicular),'') 
		AND ISNULL(TipoVehiculo,'' ) = ISNULL(ISNULL(@TipoVehiculo,TipoVehiculo),'') 
		AND ISNULL(DiasLibresIntereses,'' ) = ISNULL(ISNULL(@DiasLibresIntereses,DiasLibresIntereses),'') 
		AND ISNULL(PrecioLiberado,'' ) = ISNULL(ISNULL(@PrecioLiberado,PrecioLiberado),'') 
		AND ISNULL(ValidarCodigo,'' ) = ISNULL(ISNULL(@ValidarCodigo,ValidarCodigo),'') 
		AND ISNULL(Presentacion,'' ) = ISNULL(ISNULL(@Presentacion,Presentacion),'') 
		AND ISNULL(GarantiaPlazo,'' ) = ISNULL(ISNULL(@GarantiaPlazo,GarantiaPlazo),'') 
		AND ISNULL(CostoIdentificado,'' ) = ISNULL(ISNULL(@CostoIdentificado,CostoIdentificado),'') 
		AND ISNULL(CantidadTarima,'' ) = ISNULL(ISNULL(@CantidadTarima,CantidadTarima),'') 
		AND ISNULL(UnidadTarima,'' ) = ISNULL(ISNULL(@UnidadTarima,UnidadTarima),'') 
		AND ISNULL(MinimoTarima,'' ) = ISNULL(ISNULL(@MinimoTarima,MinimoTarima),'') 
		AND ISNULL(DepartamentoDetallista,'' ) = ISNULL(ISNULL(@DepartamentoDetallista,DepartamentoDetallista),'') 
		AND ISNULL(TratadoComercial,'' ) = ISNULL(ISNULL(@TratadoComercial,TratadoComercial),'') 
		AND ISNULL(CuentaPresupuesto,'' ) = ISNULL(ISNULL(@CuentaPresupuesto,CuentaPresupuesto),'') 
		AND ISNULL(ProgramaSectorial,'' ) = ISNULL(ISNULL(@ProgramaSectorial,ProgramaSectorial),'') 
		AND ISNULL(PedimentoClave,'' ) = ISNULL(ISNULL(@PedimentoClave,PedimentoClave),'') 
		AND ISNULL(PedimentoRegimen,'' ) = ISNULL(ISNULL(@PedimentoRegimen,PedimentoRegimen),'') 
		AND ISNULL(Permiso,'' ) = ISNULL(ISNULL(@Permiso,Permiso),'') 
		AND ISNULL(PermisoRenglon,'' ) = ISNULL(ISNULL(@PermisoRenglon,PermisoRenglon),'') 
		AND ISNULL(Cuenta2,'' ) = ISNULL(ISNULL(@Cuenta2,Cuenta2),'') 
		AND ISNULL(Cuenta3,'' ) = ISNULL(ISNULL(@Cuenta3,Cuenta3),'') 
		AND ISNULL(Impuesto1Excento,'' ) = ISNULL(ISNULL(@Impuesto1Excento,Impuesto1Excento),'') 
		AND ISNULL(CalcularPresupuesto,'' ) = ISNULL(ISNULL(@CalcularPresupuesto,CalcularPresupuesto),'') 
		AND ISNULL(InflacionPresupuesto,'' ) = ISNULL(ISNULL(@InflacionPresupuesto,InflacionPresupuesto),'') 
		AND ISNULL(Excento2,'' ) = ISNULL(ISNULL(@Excento2,Excento2),'') 
		AND ISNULL(Excento3,'' ) = ISNULL(ISNULL(@Excento3,Excento3),'') 
		AND ISNULL(ContUso,'' ) = ISNULL(ISNULL(@ContUso,ContUso),'') 
		AND ISNULL(ContUso2,'' ) = ISNULL(ISNULL(@ContUso2,ContUso2),'') 
		AND ISNULL(ContUso3,'' ) = ISNULL(ISNULL(@ContUso3,ContUso3),'') 
		AND ISNULL(NivelToleranciaCosto,'' ) = ISNULL(ISNULL(@NivelToleranciaCosto,NivelToleranciaCosto),'') 
		AND ISNULL(ToleranciaCosto,'' ) = ISNULL(ISNULL(@ToleranciaCosto,ToleranciaCosto),'') 
		AND ISNULL(ToleranciaCostoInferior,'' ) = ISNULL(ISNULL(@ToleranciaCostoInferior,ToleranciaCostoInferior),'') 
		AND ISNULL(ObjetoGasto,'' ) = ISNULL(ISNULL(@ObjetoGasto,ObjetoGasto),'') 
		AND ISNULL(ObjetoGastoRef,'' ) = ISNULL(ISNULL(@ObjetoGastoRef,ObjetoGastoRef),'') 
		AND ISNULL(ClavePresupuestalImpuesto1,'' ) = ISNULL(ISNULL(@ClavePresupuestalImpuesto1,ClavePresupuestalImpuesto1),'') 
		AND ISNULL(Estructura,'' ) = ISNULL(ISNULL(@Estructura,Estructura),'') 
		AND ISNULL(TipoImpuesto1,'' ) = ISNULL(ISNULL(@TipoImpuesto1,TipoImpuesto1),'') 
		AND ISNULL(TipoImpuesto2,'' ) = ISNULL(ISNULL(@TipoImpuesto2,TipoImpuesto2),'') 
		AND ISNULL(TipoImpuesto3,'' ) = ISNULL(ISNULL(@TipoImpuesto3,TipoImpuesto3),'') 
		AND ISNULL(TipoRetencion1,'' ) = ISNULL(ISNULL(@TipoRetencion1,TipoRetencion1),'') 
		AND ISNULL(TipoRetencion2,'' ) = ISNULL(ISNULL(@TipoRetencion2,TipoRetencion2),'') 
		AND ISNULL(TipoRetencion3,'' ) = ISNULL(ISNULL(@TipoRetencion3,TipoRetencion3),'') 
		AND ISNULL(TipoImpuesto4,'' ) = ISNULL(ISNULL(@TipoImpuesto4,TipoImpuesto4),'') 
		AND ISNULL(Calificacion,'' ) = ISNULL(ISNULL(@Calificacion,Calificacion),'')    			
	  FOR XML AUTO)	




    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
  
    SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + ISNULL(CONVERT(varchar(max),@Texto),'')+ '</Resultado></Intelisis>'

  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
   BEGIN
     COMMIT TRANSACTION 
   END ELSE
    BEGIN
      ROLLBACK TRANSACTION 
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')    
    END
  END
END
GO
/************** spIntelisisCuentaArtLineaListado ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaArtLineaListado')           AND type = 'P') drop procedure dbo.spIntelisisCuentaArtLineaListado
GO             
CREATE PROCEDURE spIntelisisCuentaArtLineaListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
		
		@Linea              Varchar(50),
		@LineaMaestra       varchar(50),
		@Icono              int,
		@Clave				varchar(20),
		@Texto				xml,
		@ReferenciaIS		varchar(100),
		@SubReferencia		varchar(100)




  SELECT  @Linea = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Linea'
  SELECT  @LineaMaestra= Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'LineaMaestra'
  SELECT  @Icono = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Icono'
  SELECT  @Clave = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Clave'
  

  

  SELECT @Texto =(SELECT * FROM ArtLinea
   WHERE           ISNULL(Linea,'') = ISNULL(ISNULL(@Linea,Linea),'') 
               AND ISNULL(LineaMaestra,'') = ISNULL(ISNULL(@LineaMaestra,LineaMaestra),'') 
               AND ISNULL(Icono,'') = ISNULL(ISNULL(@Icono,Icono),'') 
               AND ISNULL(Clave,'') = ISNULL(ISNULL(@Clave,Clave),'') 
                   FOR XML AUTO)	

  IF @@ERROR <> 0 SET @Ok = 1
  BEGIN
    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
    IF @@ERROR <> 0 SET @Ok = 1
    
    IF @Ok IS NULL
    BEGIN
      SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'
      IF @@ERROR <> 0 SET @Ok = 1
    END
  END
END
GO
/**************** spIntelisisCuentaDepartamentoListado  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaDepartamentoListado') and type = 'P') drop procedure dbo.spIntelisisCuentaDepartamentoListado
GO             
CREATE PROCEDURE spIntelisisCuentaDepartamentoListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
		@Departamento			varchar(50),
		@Descripcion			varchar(100),
		@Localidad				varchar(50),
		@CtaDinero				varchar(10),
		@Sucursal			    int,
		@Texto					xml,
		@ReferenciaIS			varchar(100),
		@SubReferencia			varchar(100)
			



  BEGIN TRANSACTION 
  IF @Ok IS NULL
  BEGIN
  
  SELECT @Departamento = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Departamento'
  SELECT @Descripcion = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Descripcion'
  SELECT @Localidad = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Localidad'
  SELECT @CtaDinero = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'CtaDinero'
  SELECT @Sucursal = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Sucursal'
  
  
  SELECT @Texto =(SELECT * FROM Departamento 
     WHERE ISNULL(Departamento,'') = ISNULL(ISNULL(@Departamento,Departamento),'')
	   AND ISNULL(Descripcion,'') = ISNULL(ISNULL(@Descripcion,Descripcion),'')		
	   AND ISNULL(Localidad,'') = ISNULL(ISNULL(@Localidad,Localidad),'') 				
	   AND ISNULL(CtaDinero,'') = ISNULL(ISNULL(@CtaDinero,CtaDinero),'')     			
	   AND ISNULL(Sucursal,'') =	ISNULL(ISNULL(@Sucursal,Sucursal),'')				
	   					
	   FOR XML AUTO)	

    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
  
    SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'
 
  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
   BEGIN
     COMMIT TRANSACTION 
   END ELSE
    BEGIN
      ROLLBACK TRANSACTION 
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')    
    END
  END
END
GO
/**************** spIntelisisCuentaPlantaUsuarioListado  ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisCuentaPlantaUsuarioListado') and type = 'P') drop procedure dbo.spIntelisisCuentaPlantaUsuarioListado
GO             
CREATE PROCEDURE spIntelisisCuentaPlantaUsuarioListado
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
		@Usuario				varchar(50),
		@Clave					varchar(100),
		@Localidad				varchar(50),
		@CtaDinero				varchar(10),
		@Sucursal			    int,
		@Texto					xml,
		@ReferenciaIS			varchar(100),
		@SubReferencia			varchar(100)
			



  BEGIN TRANSACTION 
  IF @Ok IS NULL
  BEGIN
  
  SELECT @Usuario = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro')
    WITH (Campo varchar(255), Valor varchar(255))
   WHERE Campo = 'Usuario'
  SELECT @Clave = Valor FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Parametro') 
    WITH (Campo varchar(255), Valor varchar(255)) 
   WHERE Campo = 'Clave '
  
  
  SELECT @Texto =(SELECT * FROM UsuarioPlantaAcceso 
     WHERE ISNULL(Clave,'') = ISNULL(ISNULL(@Clave,Clave),'')
	   AND ISNULL(Usuario,'') = ISNULL(ISNULL(@Usuario,Usuario),'')		
				
	   					
	   FOR XML AUTO)	

    SELECT @ReferenciaIS = Referencia 
      FROM IntelisisService 
     WHERE ID = @ID
  
    SELECT @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + CHAR(34) + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')  + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '>' + CONVERT(varchar(max),@Texto) + '</Resultado></Intelisis>'
 
  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
   BEGIN
     COMMIT TRANSACTION 
   END ELSE
    BEGIN
      ROLLBACK TRANSACTION 
    --SELECT @OkRef = 'ERROR: ' + CONVERT(varchar,@Ok) + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok) +'. ' + ISNULL(@OkRef,'')    
    END
  END
END
GO
/**************** spIntelisisInterfazInforNOM_P ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforNOM_P') and type = 'P') drop procedure dbo.spIntelisisInterfazInforNOM_P
GO             
CREATE PROCEDURE spIntelisisInterfazInforNOM_P
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 

		@Datos								varchar(max),
		@Solicitud							varchar(max),
		@ReferenciaIS						varchar(100),
		@SubReferencia						varchar(100)

	
		
  SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'
																																							

END
GO
/**************** spIntelisisInterfazInforTransferenciaMon ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaMon') and type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaMon
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaMon
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
		@Moneda							    varchar(10),
		@Datos								varchar(max),
		@Solicitud							varchar(max),
		@ReferenciaIS						varchar(100),
		@SubReferencia						varchar(100),
		@IDNuevo							int,
		@Datos2								varchar(max),
		@Resultado2							varchar(max),
		@Usuario							varchar(10),
		@Contrasena							varchar(32)	,
		@ReferenciaIntelisisService			varchar(50)						
								

  DECLARE
		@Tabla			 table
		(
		 Codigo			    	 varchar(10),
		 Descripcion			 varchar(30),
		 DescripcionAbreviada    varchar(4),
         ReferenciaIntelisisService      varchar(50),
		 DecimalesMoneda			int ,
		 DecimalesPrecios			int
		 )
		

  SELECT @Moneda = Moneda FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Mon')
    WITH (Moneda varchar(255))
  
  SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
    FROM IntelisisService 
   WHERE ID = @ID
  
  SELECT @Contrasena = Contrasena 
	FROM Usuario
   WHERE Usuario = @Usuario

 
  SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34) + 'Alm' + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'

  SET @Datos=
             '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Mon.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Moneda" Valor="'+@Moneda+'"/></Solicitud></Intelisis>'
    
  EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok OUTPUT,@OkRef OUTPUT,1,0,@IDNuevo Output
  
  IF @Ok IS NULL
    SELECT @Solicitud = Resultado 
      FROM IntelisisService
     WHERE ID = @IDNuevo
  
  IF @Ok IS NULL
  BEGIN
    EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
    IF @@ERROR <> 0 SET @Ok = 1
    INSERT @Tabla ( Codigo, Descripcion, DescripcionAbreviada,ReferenciaIntelisisService,DecimalesMoneda  ,DecimalesPrecios)
             
          SELECT     Moneda, Nombre,     InforClave,ReferenciaIntelisisService,DecimalesMoneda =2, DecimalesPrecios=2
           FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Mon',1)  
              WITH (Moneda varchar(100),Nombre varchar(100), InforClave varchar(100),ReferenciaIntelisisService varchar(100))
    IF @@ERROR <> 0 SET @Ok = 1
--    EXEC sp_xml_removedocument @iSolicitud
    IF @@ERROR <> 0 SET @Ok = 1
  END
   SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService from @Tabla
   SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oMoneda FOR XML AUTO))
  SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +  'Infor.Cuenta.Moneda.Mantenimiento'  + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>'  		
  
  IF @Ok IS NULL
    EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
					
END
GO
/**************** spIntelisisInterfazInforTransferenciaAlm ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaAlm') and type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaAlm
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaAlm
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
		@Almacen							varchar(10),
		@EsAlmacenDeDeposito				int,
		@EsAlmacenMaterialesExteriores		int,
		@NoDisponibleConsumos				int,
		@Datos								varchar(max),
		@Solicitud							varchar(max),
		@ReferenciaIS						varchar(100),
		@SubReferencia						varchar(100),
		@IDNuevo							int,
		@Datos2								varchar(max),
		@Resultado2							varchar(max),
		@Usuario							varchar(10),
		@Contrasena							varchar(32)	,
		@ReferenciaIntelisisService			varchar(50)	,
		@Planta								varchar(8),
        @PlantaDescripcion					varchar(40)
					
								

  DECLARE
		 @Tabla			 table
		(
		 CodigoAlmacen			    	 varchar(10),
		 RazonSocial			         varchar(40),
		 NombreComercial                 varchar(40),
		 ContemplarEnCalculoNecesidades  bit,
		 PermiteRechazos	             bit,
		 PermiteUbicaciones              bit,
		 EsAlmacenDeDeposito             bit,
		 EsAlmacenMaterialesExteriores   bit,
		 NoDisponibleConsumos            bit,
		 ReferenciaIntelisisService      varchar(50),
         Planta							 varchar(8)
		 )
		
  IF @Ok IS NULL
  BEGIN
  
    SELECT @Almacen = Almacen FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Alm')
      WITH (Almacen varchar(255))
    SELECT @Planta = INFORClavePlanta FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Alm')
      WITH (INFORClavePlanta varchar(255))
  
    SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
      FROM IntelisisService 
     WHERE ID = @ID
    SELECT @Contrasena = Contrasena 
      FROM Usuario
     WHERE Usuario = @Usuario

    SELECT @PlantaDescripcion = Descripcion FROM PlantaProductiva WHERE Clave = @Planta

 
    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'


    SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Alm.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Almacen" Valor="'+@Almacen+'"/></Solicitud></Intelisis>'
    
    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

    SELECT @Solicitud = Resultado 
      FROM IntelisisService
     WHERE ID = @IDNuevo

     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud

     INSERT @Tabla (CodigoAlmacen,          RazonSocial ,             NombreComercial,         ContemplarEnCalculoNecesidades, PermiteRechazos,                   PermiteUbicaciones,      EsAlmacenDeDeposito,  EsAlmacenMaterialesExteriores, NoDisponibleConsumos, ReferenciaIntelisisService,Planta)
             SELECT Almacen ,SUBSTRING(Nombre,1,40)  , SUBSTRING(Nombre,1,40) , ExcluirPlaneacion  ,            ISNULL(PermiteRechazos,''), ISNULL(PermiteUbicaciones,''),  EsAlmacenDeDeposito,  EsAlmacenMaterialesExteriores, NoDisponibleConsumos ,ReferenciaIntelisisService ,INFORClavePlanta
               FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Alm',1)  
               WITH (Almacen varchar(100), Nombre varchar(100),ExcluirPlaneacion varchar(100),PermiteRechazos varchar(100),PermiteUbicaciones varchar(100),ReferenciaIntelisisService varchar(100), EsAlmacenDeDeposito varchar(100),   EsAlmacenMaterialesExteriores varchar(100), NoDisponibleConsumos varchar(100), INFORClavePlanta varchar(100)) 

     EXEC sp_xml_removedocument @iSolicitud	
     SELECT  @ReferenciaIntelisisService =  ReferenciaIntelisisService	FROM @Tabla

     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oAlmacen FOR XML AUTO))

     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) + 'Infor.Cuenta.Almacen.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  +' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>'  		
     EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							

     IF @@ERROR <> 0 SET @Ok = 1
  END 
END
GO
/**************** spIntelisisInterfazInforTransferenciaPlanta ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaPlanta') and type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaPlanta
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaPlanta
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
	@Clave				varchar(20),	
	@Datos					varchar(max),
	@Solicitud				varchar(max),
	@ReferenciaIS			varchar(100),
	@SubReferencia			varchar(100),
	@IDNuevo				int,
	@Datos2					varchar(max),
	@Resultado2				varchar(max),
	@Usuario				varchar(10),
	@Contrasena				varchar(32),
	@ReferenciaIntelisisService			varchar(50)	   				
								

  DECLARE
		 @Tabla			 table
		(
			Clave				varchar(8),
			Descripcion			varchar(40)


		 )
		
  IF @Ok IS NULL
  BEGIN
  
    SELECT @Clave = Clave FROM openxml (@iSolicitud,'/Intelisis/Solicitud/PlantaProductiva')
      WITH (Clave varchar(255))
  
    SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
      FROM IntelisisService 
     WHERE ID = @ID
    SELECT @Contrasena = Contrasena 
      FROM Usuario
     WHERE Usuario = @Usuario

 
    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'


    SET @Datos=
             '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Planta.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Clave" Valor="'+@Clave+'"/></Solicitud></Intelisis>'

    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

    SELECT @Solicitud = Resultado 
      FROM IntelisisService
     WHERE ID = @IDNuevo

     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
     INSERT @Tabla (Clave,Descripcion  )
             SELECT Clave,Descripcion

               FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/PlantaProductiva',1)  
               WITH (Clave    varchar(100), Descripcion    varchar(100)) 	
     EXEC sp_xml_removedocument @iSolicitud		
     
     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oPlanta FOR XML AUTO))

     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Planta.Mantenimiento' + CHAR(34) + + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' >' + @Resultado2 + '</Solicitud></Intelisis>'  		
     EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
     IF @@ERROR <> 0 SET @Ok = 1
  END 
END
GO
/**************** spIntelisisInterfazInforTransferenciaPlantaUsuario ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaPlantaUsuario') and type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaPlantaUsuario
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaPlantaUsuario
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
	@Usuario2				varchar(20),	
	@Datos					varchar(max),
	@Solicitud				varchar(max),
	@ReferenciaIS			varchar(100),
	@SubReferencia			varchar(100),
	@IDNuevo				int,
	@Datos2					varchar(max),
	@Resultado2				varchar(max),
	@Usuario				varchar(10),
	@Contrasena				varchar(32),
	@ReferenciaIntelisisService			varchar(50)	
    				
								

  DECLARE
		 @Tabla			 table
		(
	Usuario 				varchar(8),
	Clave				varchar(8)

		 )
		
  IF @Ok IS NULL
  BEGIN
  
    SELECT @Usuario2 = Usuario FROM openxml (@iSolicitud,'/Intelisis/Solicitud/UsuarioPlantaAcceso')
      WITH (Usuario varchar(255))
  
    SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
      FROM IntelisisService 
     WHERE ID = @ID
    SELECT @Contrasena = Contrasena 
      FROM Usuario
     WHERE Usuario = @Usuario

 
    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'


    SET @Datos=
             '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Planta.Usuario.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Usuario" Valor="'+@Usuario2+'"/></Solicitud></Intelisis>'

    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

    SELECT @Solicitud = Resultado 
      FROM IntelisisService
     WHERE ID = @IDNuevo

     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
     INSERT @Tabla (	Usuario,	Clave  )
             SELECT Usuario,Clave

               FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/UsuarioPlantaAcceso',1)  
               WITH (Usuario    varchar(100), Clave    varchar(100)) 	
     EXEC sp_xml_removedocument @iSolicitud		
     
     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oPlantaUsuario FOR XML AUTO))

     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Planta.Usuario.Mantenimiento' + CHAR(34) + + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' >' + @Resultado2 + '</Solicitud></Intelisis>'  		
     EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
     IF @@ERROR <> 0 SET @Ok = 1
  END 
END
GO
/**************** spIntelisisInterfazInforTransferenciaEmpresa****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaEmpresa') and type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaEmpresa
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaEmpresa
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS 
BEGIN
  -- SET nocount ON

  DECLARE 
	@Empresa     			varchar(20),	
	@Datos					varchar(max),
	@Solicitud				varchar(max),
	@ReferenciaIS			varchar(100),
	@SubReferencia			varchar(100),
	@IDNuevo				int,
	@Datos2					varchar(max),
	@Resultado2				varchar(max),
	@Usuario				varchar(10),
	@Contrasena				varchar(32)	,
	@ReferenciaIntelisisService			varchar(50),
    @ContMoneda				varchar(20)
    				
								

  DECLARE
		 @Tabla			 table
		(
        Clave			varchar(5),
		CodigoId			int,
		RazonSocial		varchar(40),
		NombreComercial	varchar(40),
		Moneda	 		varchar(4),
		MonedaObjeto	varchar(4),
		Direccion1	 	varchar(40),
		Direccion2	 	varchar(40),
		Poblacion	 	varchar(40),
		Provincia	 	varchar(40),
		CodigoPostal 	varchar(10),
		CodigoPais	 	varchar(4),
		Telefono1	 	varchar(16),
		Fax	 			varchar(16),
		FormaDePago		varchar(2),
		TipoDeEfecto	int,
		ReferenciaIntelisisService  varchar(50),
		ContMoneda				varchar(20)
		 )
		
  IF @Ok IS NULL
  BEGIN
  
    SELECT @Empresa = Empresa FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Empresa')
      WITH (Empresa varchar(255))
  
    SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
      FROM IntelisisService 
     WHERE ID = @ID
    SELECT @Contrasena = Contrasena 
      FROM Usuario
     WHERE Usuario = @Usuario

    SELECT @ContMoneda = ContMoneda FROM EmpresaCfg WHERE Empresa = @Empresa

 
    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'


    SET @Datos=
             '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Empresa.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Empresa" Valor="'+@Empresa+'"/></Solicitud></Intelisis>'

    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

    SELECT @Solicitud = Resultado 
      FROM IntelisisService
     WHERE ID = @IDNuevo

     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
     INSERT @Tabla (Clave,   CodigoId,     RazonSocial, NombreComercial, Moneda,        MonedaObjeto,       Direccion1,                 Direccion2,                                 Poblacion, Provincia, CodigoPostal, CodigoPais, Telefono1,                Fax,                     FormaDePago,        TipoDeEfecto,      ReferenciaIntelisisService,ContMoneda)
             SELECT Empresa, CodigoId = 1, Nombre,      Nombre,          @ContMoneda, MonedaObjeto='PESO', substring(Direccion,1,40), (DireccionNumero + ' ' + DireccionNumeroInt), Poblacion, Estado,    CodigoPostal, Pais,       substring(Telefonos,1,16),Fax=substring(Fax,1,16), FormadePAgo = 'CO', TipodeEfecto= 1, ReferenciaIntelisisService,@ContMoneda
               FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Empresa',1)  
               WITH (Empresa varchar (100),Nombre  varchar(100), Direccion    varchar(100), DireccionNumero  varchar(100), DireccionNumeroInt varchar(100), Estado varchar(100), CodigoPostal varchar(100), Pais varchar(100), Telefonos varchar(100), Fax varchar(100), Poblacion varchar(100),ReferenciaIntelisisService  varchar(100))
     EXEC sp_xml_removedocument @iSolicitud		
     SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService from @Tabla
     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oEmpresa FOR XML AUTO))

     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Empresa.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+ ' >' + @Resultado2 + '</Solicitud></Intelisis>'  
     EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							


  END 
END
GO
/**************** spIntelisisInterfazInforTransferenciaCteTipo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaCteTipo') and type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaCteTipo
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaCteTipo
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
		@Tipo							     varchar(10),
		@Datos								varchar(max),
		@Solicitud							varchar(max),
		@ReferenciaIS						varchar(100),
		@SubReferencia						varchar(100),
		@IDNuevo							int,
		@Datos2								varchar(max),
		@Resultado2							varchar(max),
		@Usuario							varchar(10),
		@Contrasena							varchar(32),
		@Verificar							bit,
		@ReferenciaIntelisisService			varchar(50)
								

  DECLARE
		@Tabla			 table
		(
		 TipoCliente			    	 varchar(8),
		 Descripcion			         varchar(255),
		 ReferenciaIntelisisService      varchar(50)
		 )
		
 

  SELECT @Tipo = Tipo FROM openxml (@iSolicitud,'/Intelisis/Solicitud/CteTipo')
    WITH (Tipo varchar(255))


 --SELECT @Verificar = ISNUMERIC(@Tipo)
 --IF  @Verificar = 0 SELECT @Ok = 73030, @OkRef = @Tipo

  
 SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
   FROM IntelisisService 
  WHERE ID = @ID
  
  
 SELECT @Contrasena = Contrasena 
   FROM Usuario
  WHERE Usuario = @Usuario
  
  
 IF @Ok IS NULL
 BEGIN 

    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@ID,'')),'') + CHAR(34) +  ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,ISNULL(@Ok,'')),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(ISNULL(@OkRef,''),'') + CHAR(34) + '/></Intelisis>'
    SET @Datos='<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.CteTipo.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Tipo" Valor="'+@Tipo+'"/></Solicitud></Intelisis>'
     
    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDnuevo Output
  
    IF @Ok IS NULL
      SELECT @Solicitud = Resultado 
        FROM IntelisisService
       WHERE ID = @IDNuevo
  
      EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
      IF @@ERROR <> 0 SET @Ok = 1
      INSERT @Tabla (TipoCliente,Descripcion,ReferenciaIntelisisService)
             
            SELECT Tipo,INFORDescripcion,ReferenciaIntelisisService
             FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/CteTipo',1)  
                WITH (Tipo varchar(100), INFORDescripcion varchar(100),ReferenciaIntelisisService varchar(100))
      IF @@ERROR <> 0 SET @Ok = 1
      EXEC sp_xml_removedocument @iSolicitud
      IF @@ERROR <> 0 SET @Ok = 1
      
        SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService from @Tabla
        SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oTipoCliente FOR XML AUTO))
        SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.CteTipo.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' >' + @Resultado2 + '</Solicitud></Intelisis>'  
  --END
  --ELSE
  --BEGIN
  --  SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.CteTipo.Mantenimiento' + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud><ERROR Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + '/></Solicitud></Intelisis>' 		
    
  END      

  EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
					
END
GO
/**************** spIntelisisInterfazInforTransferenciaSucursal****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaSucursal') and type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaSucursal
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaSucursal
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
	@Sucursal     			varchar(10),	
	@Datos					varchar(max),
	@Solicitud				varchar(max),
	@ReferenciaIS			varchar(100),
	@SubReferencia			varchar(100),
	@IDNuevo				int,
	@Datos2					varchar(max),
	@Resultado2				varchar(max),
	@Usuario				varchar(10),
	@Contrasena				varchar(32),
	@ReferenciaIntelisisService			varchar(50)	
    				
								

  DECLARE
		 @Tabla			 table
		(
        Clave			varchar(5),
		CodigoId			varchar(40),
		RazonSocial		varchar(40),
		NombreComercial	varchar(40),
		Moneda	 		varchar(4),
		MonedaObjeto	varchar(4),
		Direccion1	 	varchar(40),
		Direccion2	 	varchar(40),
		Poblacion	 	varchar(40),
		Provincia	 	varchar(40),
		CodigoPostal 	varchar(10),
		CodigoPais	 	varchar(4),
		Telefono1	 	varchar(16),
		Fax	 			varchar(16),
		FormaDePago		varchar(2),
		TipoDeEfecto	int,
		ReferenciaIntelisisService  varchar(50)
		 )
		
  IF @Ok IS NULL
  BEGIN
  
    SELECT @Sucursal = Sucursal FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Sucursal')
      WITH (Sucursal varchar(255))
  
    SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
      FROM IntelisisService 
     WHERE ID = @ID
    SELECT @Contrasena = Contrasena 
      FROM Usuario
     WHERE Usuario = @Usuario

 
    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'


    SET @Datos=
             '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Sucursal.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Sucursal" Valor="'+@Sucursal+'"/></Solicitud></Intelisis>'

    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

    SELECT @Solicitud = Resultado 
      FROM IntelisisService
     WHERE ID = @IDNuevo

     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
     INSERT @Tabla (Clave,   CodigoId,     RazonSocial, NombreComercial, Moneda,        MonedaObjeto,       Direccion1,                 Direccion2,                                   Poblacion, Provincia, CodigoPostal, CodigoPais, Telefono1,                Fax,                     FormaDePago,        TipoDeEfecto,      ReferenciaIntelisisService)
             SELECT Sucursal, CodigoId = 1   , Nombre,  Nombre,          Moneda='PESO', MonedaObjeto='PESO', substring(Direccion,1,40), (DireccionNumero + ' ' + DireccionNumeroInt), Poblacion, Estado,    CodigoPostal, Pais,       substring(Telefonos,1,16),Fax=substring(Fax,1,16), FormadePAgo = 'CO', TipodeEfecto= 1,   ReferenciaIntelisisService
               FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Sucursal',1)  
               WITH (Sucursal varchar (100),Nombre  varchar(100), Direccion    varchar(100), DireccionNumero  varchar(100), DireccionNumeroInt varchar(100), Estado varchar(100), CodigoPostal varchar(100), Pais varchar(100), Telefonos varchar(100), Fax varchar(100), Poblacion varchar(100),ReferenciaIntelisisService  varchar(100))
     EXEC sp_xml_removedocument @iSolicitud		
     SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService from @Tabla
     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla oEmpresa FOR XML AUTO))

     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Empresa.Mantenimiento' + CHAR(34) + + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' >' + @Resultado2 + '</Solicitud></Intelisis>'  		
     EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
     IF @@ERROR <> 0 SET @Ok = 1
  END 
END
GO
/**************** spIntelisisInterfazInforTransferenciaDepartamento ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIntelisisInterfazInforTransferenciaDepartamento') and type = 'P') drop procedure dbo.spIntelisisInterfazInforTransferenciaDepartamento
GO             
CREATE PROCEDURE spIntelisisInterfazInforTransferenciaDepartamento
		@ID				int,
		@iSolicitud		int,
		@Version		float,
		@Resultado		varchar(max) = NULL OUTPUT,
		@Ok				int = NULL OUTPUT,    
		@OkRef			varchar(255) = NULL OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON

  DECLARE 
	@Departamento			varchar(20),	
	@Datos					varchar(max),
	@Solicitud				varchar(max),
	@ReferenciaIS			varchar(100),
	@SubReferencia			varchar(100),
	@IDNuevo				int,
	@Datos2					varchar(max),
	@Resultado2				varchar(max),
	@Usuario				varchar(10),
	@Contrasena				varchar(32),
	@ReferenciaIntelisisService			varchar(50)	
    				
								

  DECLARE
		 @Tabla			 table
		(
	Planta  				varchar(8),
	Descripcion				varchar(40),
	ReferenciaIntelisisService  varchar(50)
		 )
		
  IF @Ok IS NULL
  BEGIN
  
    SELECT @Departamento = Departamento FROM openxml (@iSolicitud,'/Intelisis/Solicitud/Departamento')
      WITH (Departamento varchar(255))
  
    SELECT @ReferenciaIS = Referencia ,@Usuario = Usuario , @SubReferencia = SubReferencia
      FROM IntelisisService 
     WHERE ID = @ID
    SELECT @Contrasena = Contrasena 
      FROM Usuario
     WHERE Usuario = @Usuario

 
    SET @Resultado = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Resultado" Referencia=' + ISNULL(@ReferenciaIS,'') + CHAR(34) + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Resultado IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'') + CHAR(34)  + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34) + '/></Intelisis>'


    SET @Datos=
             '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Cuenta.Departamento.Listado" SubReferencia="'+@SubReferencia+'" Version="1.0"><Solicitud><Parametro Campo="Departamento" Valor="'+@Departamento+'"/></Solicitud></Intelisis>'

    EXEC spIntelisisService @Usuario,@Contrasena,@Datos,@Resultado,@Ok Output,@OkRef Output,1,0,@IDNuevo Output

    SELECT @Solicitud = Resultado 
      FROM IntelisisService
     WHERE ID = @IDNuevo

     EXEC sp_xml_preparedocument @iSolicitud OUTPUT, @Solicitud
     INSERT @Tabla (	Planta,	Descripcion,ReferenciaIntelisisService  )
             SELECT SUBSTRING(Departamento,1,8),SUBSTRING(Descripcion,1,40),ReferenciaIntelisisService  

               FROM OPENXML (@iSolicitud, '/Intelisis/Resultado/Departamento',1)  
               WITH (Departamento    varchar(100), Descripcion    varchar(100),ReferenciaIntelisisService  varchar(100)) 	
     EXEC sp_xml_removedocument @iSolicitud		
     SELECT @ReferenciaIntelisisService = ReferenciaIntelisisService from @Tabla
     SET @Resultado2 = CONVERT(varchar(max) ,(SELECT * FROM @Tabla Departamento FOR XML AUTO))

     SET @Datos2 = '<?xml version="1.0" encoding="windows-1252"?><Intelisis Sistema="Infor" Contenido="Solicitud" Referencia=' + CHAR(34) +'Infor.Cuenta.Planta.Mantenimiento' + CHAR(34) + + ' SubReferencia=' + CHAR(34) + ISNULL(@SubReferencia,'') + CHAR(34) + ' Version=' + CHAR(34) + ISNULL(CONVERT(varchar ,@Version),'') + CHAR(34) + '><Solicitud IntelisisServiceID=' + CHAR(34) + ISNULL(CONVERT(varchar,@ID),'')   + CHAR(34) + ' Ok=' + CHAR(34) + ISNULL(CONVERT(varchar,@Ok),'') + CHAR(34) + ' OkRef=' + CHAR(34) + ISNULL(@OkRef,'') + CHAR(34)  + ' ReferenciaIntelisisService='+ CHAR(34)+ ISNULL(@ReferenciaIntelisisService,'')+CHAR(34)+' >' + @Resultado2 + '</Solicitud></Intelisis>'  		
     EXEC spIntelisisService @Usuario,@Contrasena,@Datos2,@Resultado2,@Ok Output,@OkRef Output,0,0,@IDNuevo Output																																							
  IF @@ERROR <> 0 SET @Ok = 1
  IF @Ok IS NULL
     IF @@ERROR <> 0 SET @Ok = 1
  END 
END
GO

SET DATEFIRST 7
SET ANSI_NULLS OFF
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET LOCK_TIMEOUT -1
SET QUOTED_IDENTIFIER OFF
SET ARITHABORT OFF
SET ANSI_WARNINGS OFF
GO

/**************** fnPOSVentaCobroReferencia ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSVentaCobroReferencia') DROP FUNCTION fnPOSVentaCobroReferencia
GO
CREATE FUNCTION dbo.fnPOSVentaCobroReferencia (
	@ID						varchar(36), 
	@FormaPago				varchar(50), 
	@TipoCambio				float, 
	@MonederoTipoCambio		float
)
	RETURNS varchar(50)
AS 
BEGIN
	DECLARE @Contador			int,
			@TotalRegistros		int,
			@Referencia			varchar	(50)

	DECLARE @ReferenciaT table (
		ID			INT IDENTITY(1,1) NOT NULL, 
		Referencia	varchar(50)
		)

	INSERT INTO @ReferenciaT (Referencia)
	SELECT Referencia FROM POSLCobro 
	WHERE ID = @ID AND FormaPago = @FormaPago 
	AND TipoCambio = @TipoCambio AND MonederoTipoCambio = @MonederoTipoCambio

	SET @Contador = 1
	SELECT @TotalRegistros = COUNT(1) FROM POSLCobro 
	WHERE ID = @ID AND FormaPago = @FormaPago 
	AND TipoCambio = @TipoCambio AND MonederoTipoCambio = @MonederoTipoCambio
	
	SET @Referencia = ''
	WHILE (@Contador <= @TotalRegistros)
		BEGIN		
			IF @Contador > 1
				SET @Referencia = @Referencia + ', '

			SELECT @Referencia = @Referencia + Referencia FROM @ReferenciaT WHERE ID = @Contador
			SET @Contador = @Contador + 1
		END
	RETURN (@Referencia)
END
GO


/**************** fnPOSVentaCobroMonedero ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSVentaCobroMonedero') DROP FUNCTION fnPOSVentaCobroMonedero
GO
CREATE FUNCTION dbo.fnPOSVentaCobroMonedero (
	@ID						varchar(36), 
	@FormaPago				varchar(50), 
	@MonederoTipoCambio		float
)
	RETURNS varchar(50)
AS 
BEGIN
	DECLARE @Contador		int,
			@TotalRegistros int,
			@Monedero		varchar	(50)

	DECLARE @MonederoT table (
		ID			INT IDENTITY(1,1) NOT NULL, 
		Monedero	varchar(50)
		)

	IF @MonederoTipoCambio IS NOT NULL
		BEGIN
			INSERT INTO @MonederoT (Monedero)
			SELECT Monedero FROM POSLCobro 
			WHERE ID = @ID AND FormaPago = @FormaPago 
			AND MonederoTipoCambio = @MonederoTipoCambio

			SET @Contador = 1
			SELECT @TotalRegistros = COUNT(1) FROM POSLCobro 
			WHERE ID = @ID AND FormaPago = @FormaPago 
			AND MonederoTipoCambio = @MonederoTipoCambio
			
			SET @Monedero = ''
			WHILE (@Contador <= @TotalRegistros)
				BEGIN		
					IF @Contador > 1
						SET @Monedero = @Monedero + ', '

					SELECT @Monedero = @Monedero + Monedero FROM @MonederoT WHERE ID = @Contador
					SET @Contador = @Contador + 1
				END
		END
	RETURN (@Monedero)
END
GO


/**************** fnPOSVentaCobroMonederoImporte ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSVentaCobroMonederoImporte') DROP FUNCTION fnPOSVentaCobroMonederoImporte
GO
CREATE FUNCTION dbo.fnPOSVentaCobroMonederoImporte (
	@ID						varchar(36), 
	@FormaPago				varchar(50), 
	@MonederoTipoCambio		float
)
	RETURNS float
AS 
BEGIN
	DECLARE @Contador			int,
			@TotalRegistros		int,
			@MonederoImporte	float

	IF @MonederoTipoCambio IS NOT NULL
		SELECT @MonederoImporte = SUM(ISNULL(MonederoImporte,0)) FROM POSLCobro 
		WHERE ID = @ID AND FormaPago = @FormaPago AND MonederoTipoCambio = @MonederoTipoCambio

	RETURN (@MonederoImporte)
END
GO


 /**************** fnAlinearIzquierda ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnAlinearIzquierda') DROP FUNCTION fnAlinearIzquierda
GO
CREATE FUNCTION dbo.fnAlinearIzquierda (
	@Texto		varchar(max), 
	@Espacio	int
)
	RETURNS varchar(max)
--//WITH ENCRYPTION
AS 
BEGIN
	IF LEN(@Texto)>@Espacio 
		SELECT @Texto = SUBSTRING(@Texto, 1, @Espacio)
	
	RETURN(@Texto+SPACE(@Espacio-LEN(@Texto)))
END
GO


 /**************** fnWebSepararCombinacionesPOS ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnWebSepararCombinacionesPOS') DROP FUNCTION fnWebSepararCombinacionesPOS
GO
CREATE FUNCTION fnWebSepararCombinacionesPOS (
	@Expresion				varchar(max)
)
RETURNS @Tabla TABLE (Parametro varchar(max), Valor varchar(max),Cadena varchar(max))
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @Resultado			varchar(8000),
    @Longitud			bigint,
    @Contador			bigint,
    @Caracter			char(1),
    @Estado				int,
    @EstadoAnterior		int,
    @Variable			varchar(255),
    @Valor				varchar(8000),
    @Tipo				varchar(50),
    @Posicion           int,
    @IDOpcion           int,
    @Cadena             varchar(max),
    @Lcadena            int,
    @PosicionCaracter	int
    
	SET @Resultado = ''
    
	IF NULLIF(@Expresion,'') IS NULL 
		RETURN 

	SET @Longitud = LEN(@Expresion)
	SET @Contador = 1
	SET @Estado = 0
	SET @Variable = ''
    
	WHILE @Contador <= @Longitud 
	BEGIN
		SET @EstadoAnterior = @Estado
		SET @Caracter = SUBSTRING(@Expresion,@Contador,1)
		
		IF @Estado = 0 AND @Caracter ='&'   SET @Estado =1
		IF @Estado = 0 AND @Contador = @Longitud SET @Estado =3

		IF @Estado IN( 0,3) 
			SELECT @Variable = @Variable + @Caracter
    
		IF  @Estado IN( 1,3)
			BEGIN
				INSERT @Tabla(Cadena )
				SELECT       @Variable

				SET @Estado = 0
				SELECT @Variable = ''
			END     
    
		SET @Contador = @Contador + 1
	END
	 
    UPDATE @Tabla SET Parametro = SUBSTRING(Cadena,1,CHARINDEX('=',Cadena)-1)     
    UPDATE @Tabla SET Valor = REPLACE(Cadena,Parametro+'=','')
     
	RETURN 
END
GO


 /**************** fnPOSLDISeparaCadena ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSLDISeparaCadena') DROP FUNCTION fnPOSLDISeparaCadena
GO
CREATE FUNCTION fnPOSLDISeparaCadena (
	@Expresion				varchar(max)
)
RETURNS @Tabla TABLE (Parametro varchar(max), Valor varchar(max),Cadena varchar(max))
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @Resultado			varchar(max),
    @Longitud			bigint,
    @Contador			bigint,
    @Caracter			char(1),
    @Estado				int,
    @EstadoAnterior		int,
    @Variable			varchar(max),
    @Valor				varchar(max),
    @Tipo				varchar(50),
    @Posicion           int,
    @IDOpcion           int,
    @Cadena             varchar(max),
    @Lcadena            int,
    @PosicionCaracter   int
    
	SET @Resultado = ''
  
	SELECT @Expresion = REPLACE(REPLACE(@Expresion,'{',''),'}','')  
	
	IF NULLIF(@Expresion,'') IS NULL RETURN 

	SET @Longitud = LEN(@Expresion)
	SET @Contador = 1
	SET @Estado = 0
	SET @Variable = ''  
  
	WHILE @Contador <= @Longitud 
		BEGIN
			SET @EstadoAnterior = @Estado
			SET @Caracter = SUBSTRING(@Expresion,@Contador,1)
    
			IF @Estado = 0 AND @Caracter =';'   SET @Estado =1
			IF @Estado = 0 AND @Contador = @Longitud SET @Estado =3

			IF @Estado IN( 0,3) 
				SELECT @Variable = @Variable + @Caracter
    
			IF  @Estado IN( 1,3)
				BEGIN
					INSERT @Tabla(Cadena )
					SELECT       @Variable
			
					SET @Estado = 0
					SELECT @Variable = ''
				END     
			SET @Contador = @Contador + 1
		END 
    
	UPDATE @Tabla SET Parametro = SUBSTRING(Cadena,1,CHARINDEX(':',Cadena)-1)     
    UPDATE @Tabla SET Valor = REPLACE(Cadena,Parametro+':','')     
	RETURN 
END
GO

 
/************************ spPOSLDIAnalizaCadena *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDIAnalizaCadena') AND type = 'P') DROP PROCEDURE dbo.spPOSLDIAnalizaCadena
GO             
CREATE PROCEDURE spPOSLDIAnalizaCadena
	     @Cadena		nvarchar(2048),
	     @NumeroCampo	varchar(10),
	     @Valor		nvarchar(2048) OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
		@CaracterInicial	int,
		@CaracterFinal	int,
		@Separador		varchar(1),
		@CadenaTruncada	nvarchar(2048)
  	 
	SELECT @NumeroCampo = @NumeroCampo + ':', @Separador = ';'
  
	SELECT @Cadena = REPLACE(@Cadena, '}', '')	  
  
	SELECT @CaracterInicial = CHARINDEX(@NumeroCampo, @Cadena) + LEN(@NumeroCampo)
	
	IF @CaracterInicial < 0 
		SELECT @CaracterInicial = 2048
  
	SELECT @CadenaTruncada = SUBSTRING(@Cadena, @CaracterInicial, 2048)
	SELECT @CaracterFinal = CHARINDEX(@Separador, @CadenaTruncada) -  LEN(@Separador)
  
	IF @CaracterFinal < 0 
		SELECT @CaracterFinal = 2048
	
	SELECT @CadenaTruncada = SUBSTRING(@CadenaTruncada, 1, ISNULL(@CaracterFinal, 1)) 
	SELECT @Valor = @CadenaTruncada
END
GO
  

/************************ spPOSLDIGeneraCadena *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDIGeneraCadena') AND type = 'P') DROP PROCEDURE dbo.spPOSLDIGeneraCadena
GO             
CREATE PROCEDURE spPOSLDIGeneraCadena
	     @Servicio				varchar(20),
	     @ID					varchar(36),
	     @NoTarjeta				varchar(36),
	     @NoTarjetaReemplazo	varchar(36),
	     @Cadena				nvarchar(2048) OUTPUT,
	     @Importe				float = NULL,
	     @NoTelefono			varchar(10) = NULL,
	     @Modulo				varchar(5),
	     @Ok					int	OUTPUT,
	     @OkRef					varchar(255) OUTPUT,
	     @Cuenta                varchar(255) = NULL,
	     @Referencia            varchar(255) = NULL,
	     @EsCancelacion			bit = 0,
	     @EsConsulta            bit = 0,
	     @Mes                   varchar(2) = NULL,
	     @Ano                   varchar(4) = NULL,
	     @FechaD                datetime = NULL,
	     @FechaA                datetime = NULL	     
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
		@Separador					varchar(1),
		@CadenaRespuesta	        nvarchar(max),
		@MensajeError		        nvarchar(MAX),
		@ReferenciaLDI              varchar(255),
		@CuentaLDI                  varchar(255),	  
		@NoTarjetaLDI		        varchar(45),
		@NoTarjetaReemplazoLDI		varchar(45),
		@NoTelefonoLDI				varchar(45),
		@Empresa					varchar(5),
		@EmpresaLDI					varchar(20),
		@Sucursal					int,
		@SucursalLDI		        varchar(20),
		@Caja						varchar(20),
		@CajaLDI					varchar(30),
		@FechaEmision				datetime,
		@FechaEmisionLDI			varchar(16),
		@FechaEmisionEjercicio		varchar(4),
		@FechaEmisionPeriodo		varchar(2),
		@FechaEmisionDia			varchar(2),
		@FechaEmisionHora			varchar(2),
		@FechaEmisionMinuto			varchar(2),
		@FechaEmisionSegundo		varchar(2),
		@Cliente					varchar(20),
		@ClienteLDI					varchar(20),
		@MovID						varchar(20),
		@MovIDLDI					varchar(30),
		@ImporteLDI					varchar(30),
		@ArticuloLDI				varchar(30), 
		@ServicioLDI				varchar(30),
		@TrxType					varchar(10),
		@TrxTypeLDI					varchar(20),
		@TrxSubType					varchar(10),
		@TrxSubTypeLDI				varchar(20),
		@EntryMode					varchar(10),
		@EntryModeLDI				varchar(20),
		@GeneraVoucher				varchar(10),
		@GeneraVoucherLDI			varchar(20),
		@AnchoVoucher				int,
		@AnchoVoucherLDI			varchar(20),
		@Tipo						varchar(20),
		@TipoLDI					varchar(30),
		@TransaccionesManuales		varchar(50),
		@Consulta                   varchar(50),
		@ConceptoMonedero           varchar(50),
		@PuntosLDI                  varchar(50),
		@TrxID                      int,
		@TrxIDLDI                   varchar(50),
		@AutCode                    varchar(50),
		@AutCodeLDI                 varchar(50),
		@LDIMes                     varchar(50),
		@LDIAno                     varchar(50),
		@LDIFechaD                  varchar(50),
		@LDIFechaA                  varchar(50),
		@Consecutivo                varchar(50),
		@NotasLDI                   varchar(50),
		@LDIPromocion				varchar(50),
		@LDITipoPromocion           varchar(50)
		
	--Campos comunes en cualquier transaccion
	/* Siempre el separador de campos será ; y el string se abrira con {	   */
	SELECT	@Separador = ';',
			@Cadena = '{'

	IF @Modulo = 'POS'
		SELECT	@Empresa = pl.Empresa,
 				@Sucursal = pl.Sucursal,
				@Caja = c.CtaDinero,
				@FechaEmision = GETDATE(),
				@MovID ='a'+ pl.MovID,
				@Cliente = pl.Cliente,
				@Consecutivo = pl.Mov+' '+pl.MovID
		FROM POSL pl LEFT JOIN CtaDinero c ON pl.CtaDinero = c.CtaDinero
		WHERE pl.ID = @ID
  
	IF @Modulo = 'NOM'
	  BEGIN
		SELECT @Empresa = n.Empresa,
 			@Sucursal = n.Sucursal,
			@Caja = '1',
			@FechaEmision = GETDATE(),
			@MovID = n.MovID
		  FROM Nomina n
		 WHERE n.ID = @ID
     
		 SELECT @Caja = ISNULL(@Caja,'1')
     		 
		 IF (SELECT COUNT(*) FROM NominaD WHERE ID = @ID) > 1
			SELECT @ok = 20180, @OkRef = 'Solamente se puede afectar a una persona por movimiento'
     
		 SELECT TOP 1 @Cliente = nd.Personal
		 FROM NominaD nd
		 WHERE nd.ID = @ID  
	   END
   
   IF @Modulo = 'VALE'
	   BEGIN
		 SELECT @Empresa = n.Empresa,
 			@Sucursal = n.Sucursal,
			@Caja = '1',
			@FechaEmision = GETDATE(),
			@MovID = n.MovID ,
			@Cliente = ISNULL(Cliente,''),
			@Consecutivo = n.Mov+' '+n.MovID
		   FROM Vale n
		  WHERE n.ID = @ID  
	   END       
   
	/* Determina los Datos del Servicio */
	SELECT 
		@TrxType = pls.TrxType,
		@TrxSubType = pls.TrxSubType,
		@EntryMode = pls.EntryMode,
		@GeneraVoucher = pls.GeneraVoucher, 
		@AnchoVoucher = pls.AnchoVoucher,
		@Tipo = pls.Tipo
    FROM POSLDIServicio pls
	WHERE pls.Servicio = @Servicio

	/* Determina el numero de Originador (Sucursal) asignado por LDI */
	SELECT @SucursalLDI = '1:' + pls.SucursalLDI
    FROM POSLDISucursal pls
	WHERE pls.Empresa = @Empresa
    AND pls.Sucursal = @Sucursal
     
	/* Determina el numero de Nodo (Caja) asignado por LDI y el No Ticket (MovID) del movimiento*/
	SELECT @CajaLDI = '2:' + @Caja     
  
    /*Fecha y Hora de Emision(El formato debe ser AAAAMMDDHHMMSS)*/
	SELECT 
		@FechaEmisionEjercicio = CONVERT(varchar(4), YEAR(@FechaEmision)),
		@FechaEmisionPeriodo = RIGHT('00' + CONVERT(varchar(2), MONTH(@FechaEmision)),2),
        @FechaEmisionDia = RIGHT('00' + CONVERT(varchar(2), DAY(@FechaEmision)),2),
        @FechaEmisionHora = RIGHT('00' + CONVERT(varchar(2), DatePart(hh, @FechaEmision)),2),
        @FechaEmisionMinuto = RIGHT('00' + CONVERT(varchar(2), DatePart(mi, @FechaEmision)),2),
        @FechaEmisionSegundo = RIGHT('00' + CONVERT(varchar(2), DatePart(ss, @FechaEmision)),2)
  
	SELECT @FechaEmisionLDI = '3:' + @FechaEmisionEjercicio + @FechaEmisionPeriodo + @FechaEmisionDia + 
	@FechaEmisionHora + @FechaEmisionMinuto + @FechaEmisionSegundo      

	/* Determina el numero de empresa asignado por LDI */
	SELECT @EmpresaLDI = '161:' + ple.EmpresaLDI
    FROM POSLDIEmpresa ple
	WHERE ple.Empresa = @Empresa
    
    /* Type, SubType y Tipo*/
	SELECT @TrxTypeLDI = '7:' + @TrxType,
    @MovIDLDI = '19:' + ISNULL(@MovID, 1),
	@TrxSubTypeLDI = '56:'+ @TrxSubType,
	@TipoLDI = '36:' + @Tipo

	/* Importe, va sin centavos*/
	IF @TrxType IN ('241', '251', '611', '262', '263')/** Linea Original se modifico para filtar por la clave del servicio @Servicio IN ('MON ABONO','MON CARGO','SANTANDERPP', 'MEGACABLE')**/
		SELECT @ImporteLDI = '45:' + CONVERT(varchar, ROUND(@Importe, 2))
	ELSE  
		SELECT @ImporteLDI = '45:' + CONVERT(varchar, ROUND(@Importe, 2)  * 100)

	IF @TrxType IN ('91')/** Linea Original se modifico para filtar por la clave del servicio @Servicio IN ('MON ABONO','MON CARGO','SANTANDERPP', 'MEGACABLE')**/
		SELECT @ArticuloLDI = '22:' + CONVERT(varchar, ROUND(@Importe, 2)) 
     
	IF @Servicio IN ('MON ABONO','MON CARGO')    
		BEGIN
			SELECT @ConceptoMonedero = '174:'+CASE WHEN @Servicio = 'MON ABONO' THEN '1' ELSE '2' END,
				@PuntosLDI ='266:'+ CONVERT(varchar, ROUND(0.0, 2)) ,
				@NotasLDI ='239:'+@Consecutivo 
		END
  
	/* Si se debe generar voucher */
	IF @NoTelefono IS NULL
		BEGIN
			SELECT @GeneraVoucherLDI ='163:'+@GeneraVoucher 
		END 
	ELSE
		SELECT @GeneraVoucherLDI ='163:'+@GeneraVoucher ,
            @NoTelefonoLDI = '82:' + ISNULL(@NoTelefono,'000000')
  
	/* Cliente para el alta del monedero*/
	 IF @Servicio IN ('MON ABONO', 'MON ALTA MODIFICA', 'MON ALTA NUEVO','MON ALTA REEMPLAZO','MON CARGO','MON CONSULTA','EDOCTAMES','EDOCTAPERIODO')
		  BEGIN
			SELECT 
				@ClienteLDI = '41:' + @Cliente,
				@NoTarjetaLDI = '35:' + @NoTarjeta,
				@NoTarjetaReemplazoLDI = '265:' + @NoTarjetaReemplazo
		  END 
   
	/*Cuenta para pago servicios*/
    SELECT @CuentaLDI = '42:'+@Cuenta  
  
	/*Referencia para pago servicios*/
    SELECT @ReferenciaLDI = '57:'+ISNULL(@Referencia,'') 

	IF @EsConsulta = 1
		SELECT @Consulta = '86:C'
			  
	IF @Servicio IN('EDOCTAMES')
		BEGIN
			SELECT @LDIMes = '254:'+@Mes,@LDIAno = '255:'+@Ano
		END
	IF @Servicio IN('EDOCTAPERIODO')
		BEGIN
			SELECT @LDIFechaD= '83:'+dbo.fnDateTimeFmt(@FechaD,'AAAAMMDD'), @LDIFechaA = '84:'+dbo.fnDateTimeFmt(@FechaA,'AAAAMMDD')    
		END  
  
	/* Type, SubType y Tipo*/
	SELECT 
		@TrxTypeLDI = '7:' + @TrxType,
		@TrxSubTypeLDI = '56:'+ @TrxSubType,
		@TipoLDI = '36:' + @Tipo
	 
	IF @EsCancelacion = 1 
		BEGIN
			IF @TrxTypeLDI = '251'
				SELECT @TrxTypeLDI = '7:' + '253'
      
			IF @TrxTypeLDI = '241'
				SELECT @TrxTypeLDI = '7:' + '243'     
      
			IF @TrxTypeLDI = '611'
				SELECT @TrxTypeLDI = '7:' + '613'                    

			SELECT TOP 1 @TrxID = IDTransaccion, @AutCode = CodigoAutorizacion
			FROM POSLDILog WHERE IDModulo = @ID AND Servicio = @Servicio AND CodigoRespuesta = 0 AND Importe = @Importe
      
			SELECT @TrxIDLDI = '74:' + CONVERT(varchar,@TrxID), @AutCodeLDI = '50:' + CONVERT(varchar,@AutCode)
		END   
  
	IF @Servicio = 'SANTANDERPP'
		BEGIN
			/*Utilizo Referencia para enviar los meses de las promociones con tarjetas JLMR Agosto2014*/
			SELECT @LDIPromocion = '79:'+ISNULL(@Referencia,'')
			/*Bandera 78 aplica para Meses sin intereses JLMR Agosto2014 */
			SELECT @LDITipoPromocion = '78:'+'3' 
		END 
  
	/*Concatena la Cadena */
	SELECT @Cadena = @Cadena + CASE WHEN @EmpresaLDI IS NOT NULL THEN ISNULL(@EmpresaLDI, '') ELSE '' END
			   + ISNULL(@Separador + @SucursalLDI, '')
			   + ISNULL(@Separador + @CajaLDI, '')
			   + ISNULL(@Separador + @TrxTypeLDI, '')		
			   + CASE WHEN @TrxSubType IS NOT NULL THEN ISNULL(@Separador + @TrxSubTypeLDI, '') ELSE '' END
			   + ISNULL(@Separador + @CuentaLDI, '')		
			   + ISNULL(@Separador + @ReferenciaLDI, '')		
			   + ISNULL(@Separador + @TipoLDI, '')		
			   + CASE WHEN @NoTarjeta IS NOT NULL THEN ISNULL(@Separador + @NoTarjetaLDI, '') ELSE '' END
			   + CASE WHEN @NoTarjetaReemplazo IS NOT NULL THEN ISNULL(@Separador + @NoTarjetaReemplazoLDI, '') ELSE '' END
			   + ISNULL(@Separador + @ConceptoMonedero, '')	
			   + ISNULL(@Separador + @PuntosLDI, '')
			   + ISNULL(@Separador + @NotasLDI, '')
			   + ISNULL(@Separador + @NoTelefonoLDI, '')		
			   + ISNULL(@Separador + @FechaEmisionLDI, '')
			   + ISNULL(@Separador + @MovIDLDI, '')			   
			   + ISNULL(@Separador + @ClienteLDI, '')			   
			   + ISNULL(@Separador + @ImporteLDI, '')
			   + ISNULL(@Separador + @ArticuloLDI, '')			   
			   + ISNULL(@Separador + @GeneraVoucherLDI, '')
			   + ISNULL(@Separador + @Consulta, '')
			   + ISNULL(@Separador + @TrxIDLDI, '')	  
			   + ISNULL(@Separador + @AutCodeLDI, '')
			   + ISNULL(@Separador + @LDIMes, '')	  
			   + ISNULL(@Separador + @LDIAno, '')	  
			   + ISNULL(@Separador + @LDIFechaD, '')	  
			   + ISNULL(@Separador + @LDIFechaA, '')	  
			   + ISNULL(@Separador + @TransaccionesManuales, '') 
			   + ISNULL(@Separador + @LDIPromocion, '') 
			   + ISNULL(@Separador + @LDITipoPromocion, '') 
			   + '}'		   		
END
GO


/************************ spPOSLDIMuestraFormaPago *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDIMuestraFormaPago') AND type = 'P') DROP PROCEDURE dbo.spPOSLDIMuestraFormaPago
GO             
CREATE PROCEDURE spPOSLDIMuestraFormaPago
	@FormaPago		varchar(50),
	@Importe		money
--//WITH ENCRYPTION
AS
BEGIN
	DECLARE 
		@AplicaMeses	varchar(50),
		@Aplicar		varchar(50),
		@ApartirDe		money

	SELECT TOP 1 @AplicaMeses = POSLDIFormaPago.AplicaMeses, @ApartirDe = POSLDIFormaPago.ApartirDe
    FROM POSLDIFormaPago
    JOIN POSLDIFormaPagoDMeses ON POSLDIFormaPago.FormaPago=POSLDIFormaPagoDMeses.FormaPago
	WHERE POSLDIFormaPago.FormaPago = @FormaPago

	IF @AplicaMeses = 'Si' AND @Importe >= @ApartirDe	
		BEGIN
			SELECT @Aplicar = 'Si'
		END 
	ELSE
		SELECT @Aplicar = 'NO'  

	SELECT @Aplicar  
END	
GO


/**************** spPOSLDIActivacionMonedero  ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSLDIActivacionMonedero') and type = 'P') DROP PROCEDURE dbo.spPOSLDIActivacionMonedero
GO             
CREATE PROCEDURE spPOSLDIActivacionMonedero
	@ID				varchar(36),
	@Usuario	    varchar(10),
	@Empresa        varchar(5),
	@Sucursal       int,
	@Cliente		varchar(10),
	@NoTarjeta		varchar(20),
	@Importe        float,
	@Ok				int = NULL OUTPUT,
	@OkRef			varchar(255) = NULL OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
		@Mensaje	varchar(255)
  
	EXEC spPOSLDI 'MON ALTA NUEVO', @ID, @NoTarjeta, @Empresa, @Usuario, @Sucursal, NULL, NULL, 1, NULL, @Ok OUTPUT, @OkRef  OUTPUT, 'POS'
  
	IF @OK IS NULL
		EXEC spPOSActivacionMonederoLDI  @ID, @Usuario, @Empresa, @Sucursal, @Cliente, @NoTarjeta, @Ok OUTPUT, @OkRef  OUTPUT
    
	IF @Ok IS NULL
		SELECT @Mensaje = 'Monedero Registrado Exitosamente'     
    
	SELECT @Ok, @OkRef, @Mensaje  

	RETURN
END
GO 


/************************ spPOSLDI *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDI') AND type = 'P') DROP PROCEDURE dbo.spPOSLDI
GO             
CREATE PROCEDURE spPOSLDI
	     @Servicio				varchar(20),
	     @ID					varchar(36),
	     @NoTarjeta				varchar(36),
	     @Empresa               varchar(5),
	     @Usuario               varchar(10),
	     @Sucursal              int,
	     @NoTarjetaReemplazo	varchar(36) = NULL,
	     @Importe				float = NULL,
	     @EnSilencio			bit = 0,
	     @NoTelefono			varchar(10) = NULL,
	     @Ok					int = NULL	OUTPUT,
	     @OkRef					varchar(255) = NULL OUTPUT,	     
	     @Modulo				varchar(5) = 'POS',
	     @Cuenta                varchar(255) = NULL,
	     @Referencia            varchar(255) = NULL,
	     @RIDCobro              int = NULL,
	     @ADO                   bit = 0,
	     @Mes                   varchar(2) = NULL,
	     @Ano                   varchar(4) = NULL,
	     @FechaD                datetime = NULL,
	     @FechaA                datetime = NULL	     	     
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
		@Cadena					nvarchar(2048),
		@CadenaRespuesta		nvarchar(2048),
		@MensajeError			nvarchar(2048),
  		@DireccionIP			varchar(15),
		@Puerto					varchar(10),
		@TiempoEspera			nvarchar(4),
		@Cliente				varchar(10),
		@ImporteOUT				varchar(20),
		@OkLDI	                varchar(255),
		@OkRefLDI	            varchar(500),
		@Mensaje	            varchar(255),
		@Voucher	            varchar(MAX),
		@Voucher2	            varchar(MAX),
		@Banco	                varchar(255),
		@IDLDI                  int,
		@MonedaMonedero         varchar(10),
		@Moneda                 varchar(10),
		@TipoCambio             float,
		@MonederoTipoCambio		float

	--Monedero
	IF (SELECT ISNULL(VentaMonederoA,0) FROM EmpresaCfg2 WHERE Empresa = @Empresa) = 1 AND @Servicio LIKE 'MON %'
		RETURN
	  
	IF @Modulo = 'POS'	
	IF NOT EXISTS (SELECT * FROM POSL WHERE ID = @ID)	  
		SELECT @Ok = 14055
  
	IF @Modulo = 'NOM'
    IF NOT EXISTS (SELECT * FROM Nomina WHERE ID = @ID)	  
		SELECT @Ok = 14055
      
	DELETE POSLDIIDTemp WHERE Estacion = @@SPID
      
	SELECT @TiempoEspera = '45'
  
	SELECT 
		@DireccionIP = pls.DireccionIP,
		@Puerto = pls.Puerto
    FROM POSLDIServicio pls
	WHERE pls.Servicio = @Servicio
   
	IF @Ok IS NULL	  
		EXEC spPOSLDIGeneraCadena @Servicio, @ID, @NoTarjeta, @NoTarjetaReemplazo, @Cadena OUTPUT, @Importe, @NoTelefono, @Modulo, @Ok OUTPUT, @OkRef OUTPUT, @Cuenta, @Referencia, @Mes = @Mes, @Ano = @Ano, @FechaD = @FechaD, @FechaA = @FechaA
       
	--Aqui se envia la transaccion a LDI
	IF @OK IS NULL
	    EXEC usp_EnviarMensaje @Cadena, @DireccionIP, @Puerto, @TiempoEspera, @CadenaRespuesta OUTPUT, @MensajeError OUTPUT
  
	IF NULLIF(@CadenaRespuesta,'') IS NULL
		SELECT @Ok = 2, @OkRef ='El Proveedor No envio Ninguna Respuesta'
    
	/* Determina si fue exitosa o hubo error */
	EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '14', @OkLDI OUTPUT

	/* Si @MensajeError Es diferente de NULL, significa que hubo error de conexion */
	IF @MensajeError IS NOT NULL
		SELECT @Ok = 2, @OkRef = @MensajeError
  
	/* Determina el voucher */
	EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '163', @Voucher OUTPUT
	EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '27', @Banco OUTPUT
  
	IF @Voucher IS NOT NULL OR @Banco IS NOT NULL AND @Modulo = 'POS'
		BEGIN
			INSERT POSLRefBancaria (ID, Voucher, Banco)
			VALUES                (@ID, @Voucher, @Banco)
    
			SELECT @Voucher2 = REPLACE(@Voucher,'^',':')
			
			IF NOT EXISTS (SELECT * FROM POSLDIVentaID WHERE ID = @ID)
				INSERT POSLDIVentaID(ID,Referencia2)
				SELECT              @ID,@Voucher2
    
			IF EXISTS (SELECT * FROM POSLDIVentaID WHERE ID = @ID)
				UPDATE POSLDIVentaID SET Referencia2= @Voucher2 WHERE ID = @ID
		END

	/* Si @OKLDI es diferente de 0, es que hubo error de LDI o de los proveedores de servicio*/  
	IF @Ok IS NULL AND @OkLDI <> 0
		BEGIN
			EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '16', @OkRefLDI OUTPUT
   
			SELECT @Ok = 2, @OkRef = 'El Proveedor de transacción mandó el mensaje ' + @OkRefLDI
		END
  
	IF @Ok IS NULL
		BEGIN
			/* Inserta el dato del monedero solo cuando se dio de alta*/
			IF @Servicio = 'MON ALTA NUEVO'
				BEGIN
					EXEC spPOSLDIAnalizaCadena @Cadena, '41', @Cliente OUTPUT
    
					INSERT POSLDIMonedero (Monedero, Cliente)
					VALUES (@NoTarjeta, @Cliente)	
		     	
					IF @Modulo = 'POS'	     
						EXEC spPOSAltaMonedero @ID, @Usuario, @Empresa ,@Sucursal, @Cliente, @NoTarjeta, @Ok OUTPUT	
           
					IF @Ok IS NULL
							SELECT @Mensaje = 'Monedero Registrado Exitosamente'   		     
				END	     
    
			IF @Servicio = 'MON CONSULTA'
				BEGIN
					DELETE POSLDISaldoMonederoTemp 
					WHERE Estacion = @@SPID
      
					SELECT @MonedaMonedero = Moneda, @Cliente = Cliente 
					FROM POSValeSerie 
					WHERE Serie = @NoTarjeta
					
					SELECT @Moneda = Moneda, @TipoCambio = TipoCambio 
					FROM POSLTipoCambioRef 
					WHERE EsPrincipal = 1 AND Sucursal = @Sucursal
					
					SELECT @MonederoTipoCambio = TipoCambio 
					FROM POSLTipoCambioRef 
					WHERE Sucursal = @Sucursal AND Moneda = @MonedaMonedero
      
					EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '45', @Importe OUTPUT
			
					SELECT @Mensaje = 'El Saldo del Monedero es de :<BR>' + dbo.fnFormatoMoneda(@Importe,@Empresa)+' '+
						@MonedaMonedero+'<BR>'+ CASE WHEN @Moneda <> @MonedaMonedero THEN dbo.fnFormatoMoneda(dbo.fnImporteMonTarjeta(@Importe, ISNULL(NULLIF(@MonedaMonedero,''),'Pesos'), ISNULL(@MonederoTipoCambio,1), ISNULL(NULLIF(@Moneda,''),'Pesos'), ISNULL(@TipoCambio,1), @Sucursal ),@Empresa)+' '+@Moneda ELSE '' END+
                          '<BR> Desea Imprimir El Saldo?'
					IF @Ok IS NULL                          
						INSERT POSLDISaldoMonederoTemp(
							Estacion, Monedero, Cliente, MonedaMonedero, TipoCambio, Importe, ImporteMonedaSuc)
						SELECT
							@@SPID, @NoTarjeta, @Cliente, @MonedaMonedero, @MonederoTipoCambio, @Importe, @TipoCambio
				END	     
    
			/* Inserta el dato del monedero solo cuando se hizo una modificacion*/
			IF @Servicio = 'MON ALTA MODIFICA'
				BEGIN
					UPDATE POSLDIMonedero SET Monedero = @NoTarjetaReemplazo
					WHERE Monedero = @NoTarjeta
				END
    
			IF @Servicio IN ('IUSACELL', 'MOVISTAR', 'NEXTEL', 'TELCEL', 'UNEFON')
				BEGIN
					SELECT @Mensaje = 'Recarga Exitosa'
      
					IF NOT EXISTS (SELECT * FROM POSLDIVentaID WHERE ID = @ID)
						INSERT POSLDIVentaID (
							ID, Referencia1)
						SELECT
							@ID, @NoTelefono   
      
					IF EXISTS (SELECT * FROM POSLDIVentaID WHERE ID = @ID)
						UPDATE POSLDIVentaID SET Referencia1= @NoTelefono WHERE ID = @ID   
				END  
		END
  
	IF @CadenaRespuesta IS NOT NULL
		BEGIN
			INSERT POSLDILog(
				IDModulo, Servicio, Modulo, Cadena, CadenaRespuesta, Importe, RIDCobro, Fecha, TipoTransaccion, 
				TipoSubservicio, CodigoRespuesta, DescripcionRespuesta, OrigenRespuesta, InfoAdicional, IDTransaccion,
				CodigoAutorizacion, Comprobante, TotalRegistros, ListaMontos, ListaReferencias, ListaFechas, 
				ListaConceptos, ListaMovimientos)
			SELECT 
				@ID, @Servicio, @Modulo, @Cadena, @CadenaRespuesta, @Importe, @RIDCobro, *
			FROM(SELECT Parametro, Valor FROM dbo.fnPOSLDISeparaCadena (@CadenaRespuesta)) tabla
				  PIVOT( MAX(Valor)
			FOR [Parametro] IN ([[3], [7], [56], [14], [16], [13], [27],  [8], [50],  [163], [111],[45],[51],[149],[174],[239])) p
       
			SELECT @IDLDI = SCOPE_IDENTITY()
     
			UPDATE POSLDILog SET   Comprobante = REPLACE(REPLACE(REPLACE(Comprobante,'^',':'),'@dd',':'),CHAR(10),'<BR>') 
			WHERE  ID = @IDLDI
     
			INSERT POSLDIIDTemp(ID,Estacion) SELECT @IDLDI, @@SPID 
     
			IF @Servicio IN('EDOCTAMES','EDOCTAPERIODO')
				EXEC spPOSReporteEdoCtaLDI @IDLDI  
		END  
  
	IF @EnSilencio = 0
		SELECT @Ok, @OkRef, @Mensaje, @CadenaRespuesta, @Cadena
    
	IF @ADO = 1
		BEGIN
			IF EXISTS(SELECT * FROM POSLDIRespuestaTemp WHERE ID = @ID)
				DELETE POSLDIRespuestaTemp WHERE ID = @ID
			
			INSERT POSLDIRespuestaTemp(
				ID, Ok, OkRef, Mensaje, CadenaRespuesta, Cadena, IDLog)
			SELECT
				@ID, @Ok, @OkRef, @Mensaje, @CadenaRespuesta, @Cadena, @IDLDI
		END
END
GO


/************************ spPOSLDIReverso *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDIReverso') AND type = 'P') DROP PROCEDURE dbo.spPOSLDIReverso
GO             
CREATE PROCEDURE spPOSLDIReverso
	    @ID				varchar(36),
	    @FormaPago		varchar(50),
	    @Empresa        varchar(5),
	    @Usuario        varchar(10),
	    @Sucursal       int,
	    @Ok				int	OUTPUT,
	    @OkRef			varchar(255) OUTPUT
--//WITH ENCRYPTION	    
AS 
BEGIN
	DECLARE 
		@Importe			float,
		@Referencia			varchar(50),
		@Monedero			varchar(36),
		@CtaDinero			varchar(10),
		@Servicio			varchar(20),
		@ServicioInverso	varchar(20),
		@Fecha				datetime,
		@Caja				varchar(10),
		@Cajero				varchar(10),
		@Host				varchar(20),
		@Cluster			varchar(20),
		@ImporteRef         float, 
		@TipoCambio         float, 
		@MonedaRef          varchar(10),
		@MovClave           varchar(20)

	EXEC spPOSHost @Host	OUTPUT, @Cluster OUTPUT

	SELECT 
		@Caja = Caja,
		@Cajero = Cajero
    FROM POSHost
	WHERE Host = @Host
  
	SELECT @MovClave = mt.Clave 
	FROM POSL p JOIN MovTipo mt ON p.Mov = mt.Mov AND mt.Modulo = 'POS' 
	WHERE p.ID = @ID
	
	SELECT @Fecha = GETDATE()
  	  
	DECLARE crFormaPago CURSOR LOCAL FOR
	SELECT 
		SUM(Importe),
		Referencia, 
		Monedero,
		CtaDinero,
		SUM(ImporteRef), 
		TipoCambio, 
		MonedaRef
    FROM POSLCobro pc
    WHERE pc.ID = @ID
    AND FormaPago = @FormaPago
    GROUP BY ID, Referencia, Monedero, CtaDinero, TipoCambio, MonedaRef
	HAVING SUM(Importe) > 0	   
	OPEN crFormaPago
	FETCH NEXT FROM crFormaPago INTO @Importe, @Referencia, @Monedero, @CtaDinero, @ImporteRef, @TipoCambio, @MonedaRef
	WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @@FETCH_STATUS <> -2
				BEGIN
					SELECT 
						@Servicio = Servicio,
						@ServicioInverso = ServicioInverso
					FROM POSLDIFormaPago plfp
					WHERE plfp.FormaPago = @FormaPago
      
					IF @MovClave NOT IN ('POS.N','POS.F', 'POS.FA', 'POS.P')
						SELECT @Servicio = NULL, @ServicioInverso = NULL
      
					IF @Servicio IS NOT NULL AND @ServicioInverso IS NULL
						SELECT @Ok = 20500, @OkRef = 'Es necesario configurar el Servicio Inverso de la Forma de Pago'
        
					IF @Importe IS NULL OR @Importe <0.1 OR @Importe = 0.0 
						SELECT @Ok  = 30447
      
					IF @Ok IS NULL AND @ServicioInverso IS NOT NULL
						BEGIN
							EXEC spPOSLDI @ServicioInverso, @ID, @Monedero, @Empresa, @Usuario, @Sucursal, NULL, @Importe, 1, NULL, @Ok OUTPUT, @OkRef OUTPUT
						END
      
					IF @Ok IS NULL 
						BEGIN
							IF NULLIF(@ServicioInverso,'') IS NULL 
								AND @MovClave IN ('POS.AC', 'POS.ACM', 'POS.AP', 'POS.CAC', 'POS.CACM', 'POS.CC', 'POS.CCC',
									'POS.CCCM', 'POS.CCM', 'POS.CPC', 'POS.CPCM', 'POS.N', 'POS.F', 'POS.CTCM', 'POS.CTRM', 
									'POS.EC', 'POS.IC', 'POS.TCM', 'POS.TRM')
								BEGIN
									DELETE POSLCobro WHERE ID = @ID AND FormaPago = @FormaPago
								END  
							ELSE
								IF NULLIF(@ServicioInverso,'') IS NULL 
									AND @MovClave NOT IN ('POS.AC', 'POS.ACM', 'POS.AP', 'POS.CAC', 'POS.CACM', 'POS.CC', 'POS.CCC',
										'POS.CCCM', 'POS.CCM', 'POS.CPC', 'POS.CPCM', 'POS.N', 'POS.F', 'POS.CTCM', 'POS.CTRM', 
										'POS.EC', 'POS.IC', 'POS.TCM', 'POS.TRM')
									BEGIN
										INSERT POSLCobro (
											ID, FormaPago, Importe, Referencia, CtaDinero, Monedero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio, MonedaRef)
										VALUES (
											@ID, @FormaPago, @Importe*(-1), @Referencia, @CtaDinero, @Monedero, @Fecha, @Caja, @Cajero, @Host, @ImporteRef*(-1), @TipoCambio, @MonedaRef)  
									END             
						END
				END
				FETCH NEXT FROM crFormaPago INTO @Importe, @Referencia, @Monedero, @CtaDinero, @ImporteRef, @TipoCambio, @MonedaRef                                     
		END
	CLOSE crFormaPago
	DEALLOCATE crFormaPago
END
GO


/************************ spPOSLDIValidarTarjeta *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDIValidarTarjeta') AND type = 'P') DROP PROCEDURE dbo.spPOSLDIValidarTarjeta
GO             
CREATE PROCEDURE spPOSLDIValidarTarjeta
	     @Servicio		varchar(20),
	     @ID			varchar(36),
	     @NoTarjeta		varchar(36),
	     @Empresa       varchar(5),
	     @Usuario       varchar(10),
	     @Sucursal      int,
	     @Importe		float = NULL OUTPUT,
	     @Ok			int = NULL	OUTPUT,
	     @OkRef			varchar(255) = NULL OUTPUT,
	     @OkRefLDI	    varchar(500) = NULL OUTPUT,
	     @Mostrar       bit = 0,
	     @Modulo        varchar(5) = 'POS'
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE 
		@Cadena				nvarchar(2048),
		@CadenaRespuesta	nvarchar(2048),
		@MensajeError		nvarchar(2048),
  		@DireccionIP		varchar(15),
		@Puerto				varchar(10),
		@TiempoEspera		nvarchar(4),
		@Cliente			varchar(10),
		@ImporteOUT			varchar(20),	  
		@OkLDI				varchar(255),
		@Mensaje			varchar(255),
		@Voucher			varchar(MAX),
		@Voucher2			varchar(MAX),
		@Banco				varchar(255)
      
		SELECT @TiempoEspera = '45'
  
		SELECT 
			@DireccionIP = pls.DireccionIP,
			@Puerto = pls.Puerto
		FROM POSLDIServicio pls
		WHERE pls.Servicio = @Servicio
   
		IF @Ok IS NULL	  
			EXEC spPOSLDIGeneraCadena @Servicio, @ID, @NoTarjeta, NULL, @Cadena OUTPUT, @Importe, NULL, @Modulo, @Ok OUTPUT, @OkRef OUTPUT

		--Aqui se envia la transaccion a LDI
		EXEC usp_EnviarMensaje @Cadena, @DireccionIP, @Puerto, @TiempoEspera, @CadenaRespuesta OUTPUT, @MensajeError OUTPUT		

		/* Determina si fue exitosa o hubo error */
		EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '14', @OkLDI OUTPUT

		/* Si @MensajeError Es diferente de NULL, significa que hubo error de conexion */
		IF @MensajeError IS NOT NULL
			SELECT @Ok = 2, @OkRef = @MensajeError
  
		/* Determina el voucher */
		EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '163', @Voucher OUTPUT
		EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '27', @Banco OUTPUT
  
		IF @Voucher IS NOT NULL OR @Banco IS NOT NULL
			BEGIN
				INSERT POSLRefBancaria (
					ID, Voucher, Banco)
				VALUES (
					@ID, @Voucher, @Banco)
    
				SELECT @Voucher2 = REPLACE(@Voucher,'^',':')
				
				IF NOT EXISTS (SELECT * FROM POSLDIVentaID WHERE ID = @ID)AND @Modulo = 'POS'
					INSERT POSLDIVentaID (
						ID, Referencia2)
					SELECT
						@ID, @Voucher2
				
				IF EXISTS (SELECT * FROM POSLDIVentaID WHERE ID = @ID)
					UPDATE POSLDIVentaID SET Referencia2= @Voucher2 WHERE ID = @ID
			END

		/* Si @OKLDI es diferente de 0, es que hubo error de LDI o de los proveedores de servicio*/  
		IF @Ok IS NULL AND @OkLDI <> 0
			BEGIN
				EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '16', @OkRefLDI OUTPUT
				SELECT @Ok = 2, @OkRef = 'El Proveedor de transacción mandó el mensaje ' + @OkRefLDI
			END

		IF @Ok IS NULL
			BEGIN
				/* Inserta el dato del monedero solo cuando se dio de alta*/  
				IF @Servicio = 'MON CONSULTA'
					BEGIN
						EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '45', @Importe OUTPUT      
						SELECT @Importe = ISNULL(@Importe,0.0) 
					END	         
			END  
  
		IF @Ok IS NULL AND @Mostrar = 1 
			SELECT @Importe
  
		IF @Ok IS NOT NULL AND @Mostrar = 1
			SELECT @OkRefLDI 
END
GO


/**************** fnAlinearCampoValor2 ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnAlinearCampoValor2') DROP FUNCTION fnAlinearCampoValor2
GO
CREATE FUNCTION fnAlinearCampoValor2 (
	@Campo		varchar(max), 
	@Valor		varchar(max), 
	@Espacio	int
)
	RETURNS varchar(max)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@Contador   int,
	@Longitud   int,
	@Campo2		varchar(max),
	@Campo3		varchar(max)
  
	SET @Contador = (@Espacio-LEN(@VALOR))
	SET @Longitud = 0
    
	IF (LEN(@Campo)+LEN(@Valor))>@Espacio
		BEGIN
			WHILE @Longitud < @Contador
				BEGIN
				  SET @Campo2 =''
				  SELECT @Campo2 = dbo.fnAlinearCampoValor(SUBSTRING(@Campo,ISNULL(@Longitud,1)+1,(@Espacio-(LEN(@Valor)+1))),@Valor,@Espacio)
				  SELECT @Campo3 = ISNULL(@Campo3,'')+ISNULL(@Campo2,'')
				  SELECT @Longitud = @Longitud+ LEN(SUBSTRING(@Campo,ISNULL(@Longitud,1)+1,(@Espacio-(LEN(@Valor)+1))))
				END
		END 
	ELSE 
		SELECT @Campo3 = dbo.fnAlinearCampoValor(@Campo,@Valor,@Espacio)
  
	RETURN(@Campo3)
END
GO


/**************** fnFormatoMoneda ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnFormatoMoneda') DROP FUNCTION fnFormatoMoneda
GO
CREATE FUNCTION dbo.fnFormatoMoneda (
	@Valor      decimal(30,10), 
	@Empresa	varchar(5)
) 
RETURNS varchar(20) 
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado				varchar(20),
    @Negativo				bit,
    @Antes					varchar(20),   
    @Despues				varchar(20),
    @Coma					int,
    @RedondeoMonetarios		int
        
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)	
	SELECT @Negativo = CASE WHEN @Valor<0 THEN 1 ELSE 0 END
    SELECT @Valor=ROUND(@Valor,@RedondeoMonetarios)
        
	IF   @Negativo = 1
		SET @Valor = -1*  @Valor

	SET @Resultado= CONVERT(varchar, ISNULL(  @Valor, 0.0))
	
	IF CHARINDEX ('.',  @Resultado)>0 
		BEGIN
			SET   @Despues= SUBSTRING(  @Resultado,  CHARINDEX ('.',  @Resultado), LEN(  @Resultado))	
			SET   @Antes= SUBSTRING(  @Resultado,1,  CHARINDEX ('.',  @Resultado)-1)	
		END
	ELSE
		BEGIN
			SET   @Antes =   @Resultado
			SET   @Despues=''
		END
	
	IF LEN(@Antes)>3 
		BEGIN
			SET @Coma = 3
			WHILE @Coma>1 and @Coma < LEN(  @Antes)
				BEGIN
					SET   @Antes = SUBSTRING(  @Antes,1,LEN(  @Antes)-@Coma) + ',' + RIGHT(  @Antes,@Coma)
					SET @Coma = @Coma + 4
				END
		END
	
	SET  @Resultado=   @Antes +   SUBSTRING(@Despues,1,@RedondeoMonetarios+1)

	IF   @Negativo = 1
		SET  @Resultado= '-' + @Resultado
    
	SELECT @Resultado = '$' +@Resultado	
	RETURN  @Resultado	

  RETURN (@Resultado)
 END
GO


/**************** fnPOSTablaTicket ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSTablaTicket') DROP FUNCTION fnPOSTablaTicket
GO
CREATE FUNCTION dbo.fnPOSTablaTicket (
	@Cadena			varchar(max), 
	@LargoLinea		int
)
 RETURNS @Tabla TABLE (Campo varchar(255))
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@Contador	int,
	@Numero		int

	SET @Contador = LEN(@Cadena)
	SELECT @LargoLinea = @LargoLinea-4

	SET @Numero =0
	WHILE  @Contador>=@Numero
		BEGIN
			INSERT @Tabla(Campo)
			SELECT SUBSTRING(@Cadena,ISNULL(@Numero,0)+1,@LargoLinea)
			SET @Numero = @Numero+@LargoLinea
		END 
 
	RETURN
END
GO


/**************** fnPOSTablaTicketCadena ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSTablaTicketCadena') DROP FUNCTION fnPOSTablaTicketCadena
GO
CREATE FUNCTION dbo.fnPOSTablaTicketCadena(
	@Cadena			varchar(max), 
	@LargoLinea		int
)
RETURNS varchar(max)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
		@Columns varchar(max)

	SELECT @Columns = ISNULL(@Columns,'') + '<BR>' + dbo.fnCentrar(dbo.fnRellenarConCaracter(ISNULL(Campo,''),@LargoLinea,'D',CHAR(32)) ,@LargoLinea)
    FROM dbo.fnPOSTablaTicket(@Cadena,52)
	SELECT @Columns =STUFF(@Columns,1,4,'' )+ '<BR>' 

	RETURN @Columns
END
GO


/************************ spPOSTicketDesgloseCorte   *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSTicketDesgloseCorte') AND type = 'P') DROP PROCEDURE dbo.spPOSTicketDesgloseCorte
GO             
CREATE PROCEDURE spPOSTicketDesgloseCorte
	@ID                 varchar(36),
    @Empresa            varchar(5),
    @Sucursal           int,
    @Host               varchar(20),
    @Usuario            varchar(10),
    @MovClave           varchar(20),
    @Caja               varchar(50),
    @Estacion           int,
    @LargoLineaTicket   int,
    @Ticket             varchar(max)=NULL  OUTPUT,
    @Ok                 int       =NULL    OUTPUT,
    @OkRef              varchar(255)=NULL  OUTPUT
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE    
	@Nombre              varchar(50), 
	@Denominacion        float, 
	@Cantidad            float,
	@String              varchar(max),
	@String2             varchar(max),
	@Fecha               datetime,
	@Mov                 varchar(20), 
	@MovID               varchar(20), 
	@Importe             varchar(20),
	@ImporteRef          varchar(20), 
	@Moneda              varchar(10),
	@MonedaPrincipal     varchar(10),
	@OtraMoneda          bit,
	@Orden               int,
	@OrdenMov            int
   
	SET @OtraMoneda = 0   
    
	SELECT TOP 1 @MonedaPrincipal = Moneda 
    FROM POSLTipoCambioRef 
	WHERE TipoCambio = 1	  
	AND Sucursal = @Sucursal    AND EsPrincipal = 1   
   
	SELECT @OrdenMov = Orden 
	FROM POSL 
	WHERE ID = @ID

    SELECT @Orden= max(p.Orden)
    FROM POSL p JOIN MovTipo  m ON p.Mov = m.Mov AND m.Modulo='POS'
    WHERE p.Host = @Host AND p.Empresa = @Empresa 
	AND p.Usuario = @Usuario AND p.CtaDineroDestino = @Caja
    AND m.Clave IN ('POS.AC','POS.ACM')
    AND p.Estatus IN('CONCLUIDO','TRASPASADO')
    AND p.ID <> @ID
    AND p.Orden < @OrdenMov
    GROUP BY p.Orden         
    ORDER BY p.Orden asc       

	SET @Ticket = ISNULL(@Ticket,'')

	IF EXISTS (SELECT * FROM POSL p JOIN POSLCobro c ON p.ID = c.ID  JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo='POS'
      WHERE m.Clave IN ('POS.AC', 'POS.ACM', 'POS.AP', 'POS.CAC', 'POS.CACM', 'POS.CC', 'POS.CCC', 'POS.CCCM', 'POS.CCM', 'POS.CPC', 'POS.CPCM', 'POS.CTCAC', 'POS.CTCM', 'POS.CTCRC', 'POS.CTRM', 'POS.EC', 'POS.F', 'POS.FA', 'POS.IC', 'POS.N', 'POS.TCAC', 'POS.TCM', 'POS.TCM', 'POS.TCRC', 'POS.TRM','POS.TCM','POS.CTCM','POS.CXCC','POS.CXCD')
        AND p.Estatus IN('CONCLUIDO','TRASPASADO')
        AND p.Orden BETWEEN @Orden AND @OrdenMov
        AND p.Host = @Host AND p.Empresa = @Empresa AND p.Usuario = @Usuario  
        AND c.MonedaRef <> @MonedaPrincipal
        AND (CASE WHEN m.Clave IN('POS.AC','POS.AP','POS.ACM','POS.CCC','POS.CCCM') THEN p.CtaDineroDestino 
		ELSE c.Caja
	   END) = @Caja)
		SET @OtraMoneda = 1       
   
	IF @MovClave IN('POS.CCM','POS.CC') 
		BEGIN
			IF @OtraMoneda = 1   
				SELECT @String2 = dbo.fnCentrar(UPPER('Movimiento '), @LargoLineaTicket /4) + dbo.fnAlinearDerecha(UPPER('IMPORTE M/N'), 15) +
				dbo.fnCentrar(UPPER('IMPORTE'), @LargoLineaTicket /2) + '<BR>' +REPLICATE('-', @LargoLineaTicket+40) + '<BR>' 
			ELSE
				SELECT @String2 = dbo.fnCentrar(UPPER('Movimiento '), @LargoLineaTicket /4) + dbo.fnCentrar(UPPER('IMPORTE'), @LargoLineaTicket/2 ) + 
					'<BR>' + REPLICATE('-', @LargoLineaTicket+40) + '<BR>' 

			DECLARE crSaldos CURSOR LOCAL FOR
			SELECT p.Mov,p.MovID,SUM(c.Importe*m.Factor),SUM(c.ImporteRef*m.Factor), c.MonedaRef
			FROM POSL p JOIN POSLCobro c ON p.ID = c.ID
			JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo='POS'
			WHERE m.Clave IN ('POS.AC', 'POS.ACM', 'POS.AP', 'POS.CAC', 'POS.CACM', 'POS.CC', 'POS.CCC', 'POS.CCCM', 'POS.CCM', 'POS.CPC', 'POS.CPCM', 'POS.CTCAC', 'POS.CTCM', 'POS.CTCRC', 'POS.CTRM', 'POS.EC', 'POS.F', 'POS.FA', 'POS.IC', 'POS.N', 'POS.TCAC', 'POS.TCM', 'POS.TCM', 'POS.TCRC', 'POS.TRM','POS.TCM','POS.CTCM','POS.CXCC','POS.CXCD')
			AND p.Estatus IN('CONCLUIDO','TRASPASADO')
			AND p.Orden BETWEEN @Orden AND @OrdenMov
			AND p.Host = @Host AND p.Empresa = @Empresa AND p.Usuario = @Usuario
			AND (CASE WHEN m.Clave IN('POS.AC','POS.AP','POS.ACM','POS.CCC','POS.CCCM') THEN p.CtaDineroDestino ELSE c.Caja  END) = @Caja        
			GROUP BY   p.Mov,p.MovID, c.MonedaRef,p.Orden
			ORDER BY p.Orden Asc    
			
			OPEN crSaldos
			FETCH NEXT FROM crSaldos INTO @Mov, @MovID, @Importe,@ImporteRef, @Moneda
			WHILE @@FETCH_STATUS <> -1
			BEGIN
				IF @@FETCH_STATUS <> -2
					BEGIN      
      					IF @OtraMoneda = 1 
      						SELECT @String =dbo.fnRellenarConCaracter(SUBSTRING(ISNULL(@Mov+' '+@MovID ,''),1,30),25,'D',' ') + 
								dbo.fnRellenarConCaracter(SUBSTRING(ISNULL(dbo.fnFormatoMoneda((@Importe),@Empresa),0.0),1,15),15,'I',' ') + 
								dbo.fnRellenarConCaracter(SUBSTRING(ISNULL(dbo.fnFormatoMoneda((@ImporteRef),@Empresa),0.0),1,15),15,'I',' ') + '<BR>'
      					ELSE  
      						SELECT @String =dbo.fnRellenarConCaracter(SUBSTRING(ISNULL(@Mov+' '+@MovID ,''),1,25),25,'D',' ') + 
								dbo.fnRellenarConCaracter(SUBSTRING(ISNULL(dbo.fnFormatoMoneda((@ImporteRef),@Empresa),0.0),1,15),15,'I',' ') + '<BR>'
					END
  
				SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
      
				FETCH NEXT FROM crSaldos INTO  @Mov, @MovID, @Importe, @ImporteRef, @Moneda
			END
		CLOSE crSaldos
		DEALLOCATE crSaldos   
          
		SELECT @Ticket = @String2 + @Ticket
	  END

	RETURN
END
GO 


/************************ spPOSTicketDenominacion   *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSTicketDenominacion') AND type = 'P') DROP PROCEDURE dbo.spPOSTicketDenominacion
GO             
CREATE PROCEDURE spPOSTicketDenominacion            
	@ID                 varchar(36),
    @Empresa            varchar(5),
    @MovClave           varchar(20),
    @FormaPago          varchar(50),
    @Estacion           int,
    @LargoLineaTicket   int,
    @EsImpresion        bit =0,
    @Ticket             varchar(max)=NULL  OUTPUT,
    @Ok                 int       =NULL    OUTPUT,
    @OkRef              varchar(255)=NULL  OUTPUT
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE    
	@Nombre              varchar(50), 
	@Denominacion        float, 
	@Cantidad            float,
	@String              varchar(max),
	@String2              varchar(max)
       
	SET @Ticket = ''

	IF @MovClave IN('POS.CCM','POS.CPCM','POS.CC','POS.CPC') AND EXISTS(SELECT * FROM POSLDenominacion WHERE ID = @ID AND Formapago = @FormaPago)
		BEGIN
			SELECT @String2 = dbo.fnCentrar(UPPER('   DENOMINACION '), @LargoLineaTicket /3) + 
				dbo.fnCentrar(UPPER('    CANTIDAD'), @LargoLineaTicket /3) + 
				dbo.fnCentrar(UPPER('         TOTAL'), @LargoLineaTicket /3) + '<BR>' + 
				REPLICATE('-', @LargoLineaTicket +CASE WHEN @EsImpresion=0 THEN 32 ELSE 0 END) + '<BR>' 

			DECLARE crDenominacion CURSOR LOCAL FOR
			SELECT Nombre, Denominacion, Cantidad
			FROM POSLDenominacion
			WHERE ID = @ID AND ISNULL(Cantidad,0) > 0
			AND Formapago = @FormaPago
    
			OPEN crDenominacion
			FETCH NEXT FROM crDenominacion INTO @Nombre, @Denominacion, @Cantidad
			WHILE @@FETCH_STATUS <> -1
				BEGIN
					IF @@FETCH_STATUS <> -2
						BEGIN      	 
      						SELECT @String = dbo.fnCentrar(CONVERT(varchar,dbo.fnRellenarConCaracter(@Denominacion,5,'i',CHAR(32)) ), @LargoLineaTicket /3) + 
								dbo.fnCentrar(CONVERT(varchar,dbo.fnRellenarConCaracter(ISNULL(@Cantidad,0.0),8,'i',CHAR(32)) ), @LargoLineaTicket /2) + 
								dbo.fnCentrar(dbo.fnRellenarConCaracter(ISNULL(dbo.fnFormatoMoneda((@Cantidad*@Denominacion),@Empresa),0.0),9,'i',CHAR(32)), @LargoLineaTicket /2) + '<BR>' 
						END
  
					SELECT @Ticket = @Ticket + @String      
      
					FETCH NEXT FROM crDenominacion INTO @Nombre, @Denominacion, @Cantidad
				END
			CLOSE crDenominacion
			DEALLOCATE crDenominacion  
  
			SELECT @Ticket = @String2 + @Ticket
		END

	RETURN
END
GO 


/************************ xpPOSConcatenaTicket *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.xpPOSConcatenaTicket') AND type = 'P') DROP PROCEDURE dbo.xpPOSConcatenaTicket
GO       
CREATE PROCEDURE xpPOSConcatenaTicket
	@CajaActual				varchar(20),
    @CajeroActual			varchar(20),
    @ID						varchar(50) = NULL,
    @RecalcularTodo			bit   = 1,
    @Accion					varchar(50) = NULL,
    @ArtDescripcionRef		varchar(50) = NULL,
    @ArtConsulta			varchar(50) = NULL,
    @SucursalTrabajo		int = NULL,
    @Ticket					varchar(MAX) OUTPUT,
    @Totales				varchar(MAX) OUTPUT,
    @Saldos					varchar(MAX) OUTPUT,
    @Total					float	     OUTPUT,
    @Saldo					float	     OUTPUT,
    @CodigoAccion			varchar(30) = NULL,
    @Estacion				int,
    @DesgloseCC				bit = 0,
    @EsImpresion			bit = 0
AS
BEGIN
	DECLARE 
	@Ok								int,
	@OkRef							varchar(255),
	@LargoLineaTicket				int,
	@LargoLineaTotales				int,
	@LargoLineaSaldos				int,
	@String							varchar(MAX),
	@String2						varchar(MAX),	
	@Empresa						varchar(5),
    @Sucursal						int,
	@EmpresaNombre					varchar(100),
	@EmpresaDireccion				varchar(100),
	@EmpresaDireccionNumero			varchar(20),
	@EmpresaDireccionNumeroInt		varchar(20),
	@EmpresaColonia					varchar(30),
	@EmpresaPoblacion				varchar(30),
	@EmpresaDelegacion				varchar(100),
	@EmpresaEstado					varchar(30),
	@EmpresaPais					varchar(30),
	@EmpresaCodigoPostal			varchar(15),
	@EmpresaTelefonos				varchar(100),
	@EmpresaFax						varchar(50),
	@EmpresaRFC						varchar(20),	  
	@SucursalNombre					varchar(100),
	@SucursalDireccion				varchar(100),
	@SucursalDireccionNumero		varchar(20),
	@SucursalDireccionNumeroInt		varchar(20),
	@SucursalColonia				varchar(30),
	@SucursalPoblacion				varchar(30),
	@SucursalDelegacion				varchar(100),
	@SucursalEstado					varchar(30),
	@SucursalPais					varchar(30),
	@SucursalCodigoPostal			varchar(15),
	@SucursalTelefonos				varchar(100),
	@SucursalFax					varchar(50),
	@Mov							varchar(20),
	@MovID							varchar(20),
	@MovClave						varchar(20),	  
	@FechaEmision					DateTime,
	@FechaEntrega					DateTime,
	@FechaRegistro					DateTime,
	@Concepto						varchar(50),
	@Proyecto						varchar(50),
	@UEN							int,
	@Moneda							varchar(10),
	@TipoCambio						float,
	@Usuario						varchar(10),
	@Referencia						varchar(50),
	@Observaciones					varchar(200),
	@Estatus						varchar(15),
	@Cliente						varchar(10),
	@CteEnviarA						int,
	@Almacen						varchar(10),
	@Agente							varchar(10),
	@Cajero							varchar(10),
	@FormaEnvio						varchar(50),
	@Condicion						varchar(50),
	@Vencimiento					datetime,
	@Descuento						varchar(30),
	@DescuentoGlobal				float,
	@ListaPreciosEsp				varchar(20),
	@ZonaImpuesto					varchar(30),
	@Origen							varchar(20),
	@OrigenID						varchar(20),	  
	@CteNombre						varchar(100),
	@CteDireccion					varchar(100),
	@CteDireccionNumero				varchar(20),
	@CteDireccionNumeroInt			varchar(20),
	@CteColonia						varchar(100),
	@CtePoblacion					varchar(100),
	@CteDelegacion					varchar(100),
	@CteEstado						varchar(30),
	@CtePais						varchar(30),
	@CteCodigoPostal				varchar(15),
	@CteTelefonos					varchar(100),
	@CteRFC							varchar(15),
	@CteEnviarANombre				varchar(100),
	@CteEnviarADireccion			varchar(100),
	@CteEnviarADireccionNumero		varchar(20),
	@CteEnviarADireccionNumeroInt	varchar(20),
	@CteEnviarAColonia				varchar(100),
	@CteEnviarAPoblacion			varchar(100),
	@CteEnviarADelegacion			varchar(100),
	@CteEnviarAEstado				varchar(30),
	@CteEnviarAPais					varchar(30),
	@CteEnviarACodigoPostal			varchar(15),
	@CteEnviarATelefonos			varchar(100),
	@CodigoBarras					varchar(30),
	@Articulo						varchar(20),
	@Unidad							varchar(50),
    @SubCuenta						varchar(50),
    @ArtDescripcion					varchar(100),
    @Cantidad						float,	
    @CantidadObsequio				float,
    @Precio							float,
    @DescuentoLinea					money,
	@DescuentoLineaAcumulado		money,
    @Impuesto1						float,
    @Impuesto2						float,
    @Impuesto3						float,     	  
    @SubTotal						float,
    @TotalDescuento					float,
    @TotalImpuesto1					float,     	  
    @CodigoFormaPago				varchar(50),
    @FormaPago						varchar(50),
    @Importe						float,     	  
    @ImporteCobrado					float,
    @SumaCobrado					float,     	  
    @RedondeoVenta					bit,
    @CodigoRedondeo					varchar(30),
    @ArticuloRedondeo				varchar(20),
    @Redondeo						float,
    @Inventario						float,    
    @CtaDinero						varchar(10),
    @CtaDineroDestino				varchar(10),    
    @FechaAmortizacion				datetime,
	@ImporteAmortizacion			float,
	@InteresAmortizacion			float,
    @TotalAmortizacion				float,    
    @CajaAbierta					bit,
    @MovOrden						int,
    @ImporteRef						float,
    @POSMoneda						varchar(20),
    @SucursalInv					int,
    @SucursalInvNombre				char(10),
    @IDTemp                         int,
    @Beneficiario                   varchar(100),
    @Renglon                        float,
    @OfertaPuntos                   float,
    @OfertaPrecio                   float,
    @LineaAhorro                    varchar(255),
    @Ahorro                         float,
    @PuntosUtilizados               float,
    @Monedero                       varchar(20),
    @MonedaMonedero                 varchar(50),
    @Puntos                         float,
    @PrecioSugerido                 float,
    @Aplicado                       bit,
    @POSImpuestoIncluido            bit,
    @PrecioImpuestoInc              float,
    @UsuarioPerfil                  varchar(10),
    @Numero                         int,
    @ConceptoCXC                    varchar(50),
    @TotalCxc                       float,
    @Descripcion                    varchar(20),
    @Descripcion2                   varchar(20),
    @Host                           varchar(20),
    @Cluster                        varchar(20),
    @OfertaID                       int,
    @NoCertificadoSAT               varchar(20),
    @UUID                           varchar(50),
    @Sello							varchar(255),
    @SelloSat                       varchar(255),
    @CadenaOriginal					varchar(max),
    @FechaTimbrado                  datetime,
    @NoCertificado					varchar(20),
    @AplicaDescGlobal               bit,
    @SubClave                       varchar(20),
    @EmidaResponseMessage           varchar(500),
    @ArticuloOfertaFP               varchar(20),
    @AlmacenDestino                 varchar(10),
    @AlmacenDestinoNombre           varchar(100),
    @AlmacenD                       varchar(10),
    @AlmacenDNombre                 varchar(30), 
    @AlmacenNombre                  varchar(100),
    @PedidoReferencia               varchar(50), 
    @MovSubClave                    varchar(20),
    @Aplica                         varchar(20),
    @AplicaID                       varchar(20),
    @CXCSaldoTotal                  float,    
    @AlmacenV						varchar(10),
    @AlmacenVNombre					varchar(10),
    @FormaEnvioV					varchar(50),
    @ConceptoDIN                    varchar(50),
    @Orden							int,
    @ControlAnticipos				varchar(20),
    @Cadena                         varchar(max),
    @ImporteMov						float, 
    @ImpuestosMov					float,
    @ClaveCte                       varchar(10),
     	  
	@ValidacionTEMP					int,
	@OrdenCorteCaja					int,
	@OrdenMovAnterior				int,
	@FechaCorteCaja					datetime,
	@CampoCorteTemp					varchar(max),
    @DirectorioEstilo               varchar(256),

	@CtaDineroMM					varchar(10),
	@CtaDineroMMDescripcion			varchar(100)


     	  
  EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT     	  
 
 -- En esta variable se especifica el largo de la linea para la funciones dbo.fncentrar, dbo.fnAlinearDerecha, dbo.fnAlinearCampoValor2
IF @EsImpresion = 0	
   SELECT @LargoLineaTicket = 110, @LargoLineaTotales = 70, @LargoLineaSaldos = 70 
ELSE
  SELECT @LargoLineaTicket = 52, @LargoLineaTotales = 50, @LargoLineaSaldos = 50   
	
IF @RecalcularTodo = 1
BEGIN
	SELECT 
	  @Empresa = e.Empresa,
	  @EmpresaNombre = e.Nombre,
  	  @EmpresaDireccion = e.Direccion,
	  @EmpresaDireccionNumero = e.DireccionNumero,
	  @EmpresaDireccionNumeroInt = e.DireccionNumeroInt,
	  @EmpresaColonia = e.Colonia,
 	  @EmpresaPoblacion = e.Poblacion,
	  @EmpresaDelegacion = e.Delegacion,
	  @EmpresaEstado = e.Estado,
	  @EmpresaPais = e.Pais,
	  @EmpresaCodigoPostal = e.CodigoPostal,
	  @EmpresaTelefonos = e.Telefonos,
	  @EmpresaFax = e.Fax,
	  @EmpresaRFC = e.RFC	     
     FROM Empresa e
    INNER JOIN POSL p ON e.Empresa = p.Empresa AND p.ID = @ID

	SELECT 
	  @SucursalNombre = s.Nombre,
	  @SucursalDireccion = s.Direccion,
	  @SucursalDireccionNumero = s.DireccionNumero,
	  @SucursalDireccionNumeroInt = s.DireccionNumeroInt,
	  @SucursalColonia = s.Colonia,
	  @SucursalPoblacion = s.Poblacion,
	  @SucursalDelegacion = s.Delegacion,
	  @SucursalEstado = s.Estado,
	  @SucursalPais = s.Pais,
	  @SucursalCodigoPostal = s.CodigoPostal,
	  @SucursalTelefonos = s.Telefonos,
	  @SucursalFax = s.Fax,
	  @Sucursal=s.Sucursal
     FROM Sucursal s
    INNER JOIN POSL p ON p.Sucursal = s.Sucursal AND p.ID = @ID

-- Aqui se arma el encabezado del ticket con los datos de la empresa
  IF @EsImpresion = 1
  BEGIN
     -- Nombre de la Empresa
     SELECT @String = '<BR>' + dbo.fnAlinearCampoValor2(dbo.fnCentrar(UPPER(@EmpresaNombre), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
     SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
 
     --Dirección de la Empresa
     SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER(@EmpresaDireccion) , '')+ ' ' + ISNULL(UPPER(@EmpresaDireccionNumero), '')+ ' ' + 
			ISNULL(UPPER(@EmpresaDireccionNumeroInt), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
     SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
 
     --Colonia de la Empresa
     SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('COL.' + @EmpresaColonia), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
     SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
 
     --Poblacion de la Empresa
     IF NULLIF(@EmpresaPoblacion,'') IS NOT NULL
     BEGIN
       SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER(@EmpresaPoblacion), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
       SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
     END
   
   --Delegacion o Municipio de la Empresa
	 SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER(@EmpresaDelegacion + ', ' + 
			ISNULL(@EmpresaEstado, '')), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
     SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')    
 
     --RFC de la Empresa
     SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('RFC: ' + @EmpresaRFC), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
     SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')    
 
     --Telefonos de la Empresa
     SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('Telefonos: ' + @EmpresaTelefonos), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
     SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')       
   
   -- Aqui se arma el encabezado del ticket con los datos de la Sucursal                   
     SELECT @Ticket = ISNULL(@Ticket,'')  + dbo.fnAlinearCampoValor2(dbo.fnCentrar(UPPER('DATOS SUCURSAL:'), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
   
     -- Nombre de la Sucursal
     SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(UPPER(ISNULL(@SucursalNombre,'')), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
     SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')       
 
     -- Dirección de la Sucursal
     SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER(@SucursalDireccion), '') + ' ' + ISNULL(UPPER(@SucursalDireccionNumero), '')+ ' ' + 
			ISNULL(UPPER(@SucursalDireccionNumeroInt), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
     SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')       
 
     -- Colonia de la Sucursal
     SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('COL. ' + @SucursalColonia), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
     SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')         
 
     -- Población de la Sucursal
     SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER(@SucursalPoblacion), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
     SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')         	
 
     -- Delegación de la Sucursal
     SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER(@SucursalDelegacion + ', ' + 
			ISNULL(@SucursalEstado, '')), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
     SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')         		
 
     -- Teléfonos de la Sucursal
     SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('Telefonos: ' + @SucursalTelefonos), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
     SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
   END         		  
 
   IF @ID IS NOT NULL
   BEGIN
     SELECT 
	  @Mov = p.Mov,		
	  @MovID = p.MovID,					
	  @MovClave = mt.Clave,
	  @FechaEmision = p.FechaEmision,					
	  @FechaEntrega = p.FechaEntrega,
	  @FechaRegistro = p.FechaRegistro,	     
	  @Concepto = p.Concepto,				
	  @Proyecto = p.Proyecto,			
	  @UEN	= p.UEN,			
	  @Moneda = p.Moneda,					
	  @TipoCambio = p.TipoCambio,
	  @Usuario = p.Usuario,			
	  @Referencia	= p.Referencia,			
	  @Observaciones = p.Observaciones,
	  @Estatus = p.Estatus,					
	  @Cliente = p.Cliente,				
	  @CteEnviarA = p.EnviarA,
	  @Almacen = p.Almacen,					
	  @Agente = p.Agente,					
	  @Cajero = p.Cajero,
	  @CtaDinero = p.CtaDinero,
	  @CtaDineroDestino = p.CtaDineroDestino,
	  @FormaEnvio = p.FormaEnvio,
	  @Condicion = p.Condicion,					
	  @Vencimiento	= p.Vencimiento,
	  @Descuento = p.Descuento,					
	  @DescuentoGlobal = p.DescuentoGlobal,
	  @ListaPreciosEsp = p.ListaPreciosEsp,				
	  @ZonaImpuesto = p.ZonaImpuesto,
	  @Origen = p.Origen,
	  @OrigenID = p.OrigenID,
	  @Importe = p.Importe,
	  @Monedero = p.Monedero,
	  @NoCertificadoSAT =   p.NoCertificadoSAT,
	  @UUID  =   p.UUID,            
	  @Sello =  p.Sello,
	  @SelloSat =  p.SelloSat,          
	  @CadenaOriginal = p.CadenaOriginal,
	  @FechaTimbrado  = p.FechaTimbrado,     
	  @NoCertificado = p.Certificado,
	  @Beneficiario = p.BeneficiarioNombre,
	  @SubClave = mt.SubClave,
	  @EmidaResponseMessage = p.EmidaResponseMessage,
	  @AlmacenDestino = p.AlmacenDestino,
	  @PedidoReferencia = p.PedidoReferencia,
	  @MovSubClave = mt.SubClave,
	  @CXCSaldoTotal = p.CXCSaldoTotal
     FROM POSL p
    INNER JOIN MovTipo mt ON p.Mov = mt.Mov AND mt.Modulo = 'POS'
    WHERE p.ID = @ID  	
     
     SELECT
        @ClaveCte = c.Cliente, 
        @CteNombre = c.Nombre,
 	    @CteDireccion = c.Direccion,
	    @CteDireccionNumero = c.DireccionNumero,
	    @CteDireccionNumeroInt = c.DireccionNumeroInt,
	    @CteColonia = c.Colonia,
	    @CtePoblacion = c.Poblacion,
	    @CteDelegacion = c.Delegacion,
	    @CteEstado = c.Estado,
	    @CtePais = c.Pais,
	    @CteCodigoPostal = c.CodigoPostal,
	    @CteTelefonos = c.Telefonos,
	    @CteRFC = RFC
       FROM Cte c
      WHERE c.Cliente = @Cliente
      
      SELECT @AlmacenDestinoNombre = Nombre FROM Alm WHERE Almacen = @AlmacenDestino
      SELECT @AlmacenNombre = Nombre FROM Alm WHERE Almacen = @Almacen    
      
     SELECT @UsuarioPerfil = NULLIF(POSPerfil,'') FROM Usuario WHERE Usuario = @Usuario   
     
     IF @EsImpresion = 1
       SELECT @Ticket = ISNULL(@Ticket,'') + REPLICATE('-', @LargoLineaTicket+CASE WHEN @EsImpresion=0 THEN 32 ELSE 0 END) + '<BR>'
     IF @EsImpresion = 0
     BEGIN
            SELECT @DirectorioEstilo = Directorio
              FROM POSUsuarioEstacion
             WHERE Empresa = @Empresa
               AND Sucursal = @Sucursal
               AND Usuario = @Usuario
               AND Estacion = @Estacion
   
            SET @DirectorioEstilo = ISNULL(@DirectorioEstilo,'')

            IF ISNULL(@DirectorioEstilo,'') <> '' AND RIGHT(@DirectorioEstilo,1) <> '\'
               SET @DirectorioEstilo = @DirectorioEstilo + '\'

            SET @String = ''
            SET @String = @String + '<!DOCTYPE HTML>'
            SET @String = @String + '<html>'
            SET @String = @String + '<head>'
            SET @String = @String + '<title>Ticket POS</title>'
            SET @String = @String + '<meta name="viewport" content="width=device-width, initial-scale=1">'
            SET @String = @String + '<meta http-equiv="Content-Type" content="text/html; charset=latin1" />'
            SET @String = @String + '<meta name="keywords" content="POS, SDK"/>'
            SET @String = @String + '<base href="'+@DirectorioEstilo+'">'
            SET @String = @String + '<link href="web/css/bootstrap.min.css" rel="stylesheet" type="text/css" />'
            SET @String = @String + '<link href="web/css/style.css" rel="stylesheet" type="text/css" />'
            SET @String = @String + '<link rel="stylesheet" href="web/css/morris.css" type="text/css"/>'
            SET @String = @String + '<link href="web/css/font-awesome.css" rel="stylesheet">'
            SET @String = @String + '<link rel="stylesheet" type="text/css" href="web/css/table-style.css" />'
            SET @String = @String + '<link rel="stylesheet" type="text/css" href="web/css/basictable.css" />'
            SET @String = @String + '<link rel="stylesheet" href="web/css/icon-font.min.css" type="text/css" />'
            SET @String = @String + '</head>'
            SET @String = @String + '<body>'
		    SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
            SET @String = ''

     END   
    --Fecha Emision y Movimiento
     IF @EsImpresion = 1 
     BEGIN
		    SELECT @String = dbo.fnAlinearCampoValor2(((ISNULL('MOVIMIENTO: ' + (RTRIM(LTRIM(@Mov)) + ' ' + ISNULL(@MovID,'')), '')) + '                    	         ' + 
			    dbo.fnCentrar(ISNULL('FECHA: ' + CONVERT(varchar,@FechaEmision, 105), ''), @LargoLineaTicket)), '', @LargoLineaTicket) + '<BR>'
		    SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
     END
     
	 IF @EsImpresion = 0
     BEGIN
    
		    SELECT @String = @String + '<table width="100%" style="margin:0;">'
		    SELECT @String = @String + '  <tr style="border-bottom:0px;">'
		    SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">MOVIMIENTO: ' + ISNULL(RTRIM(LTRIM(@Mov)),'') + ' ' + ISNULL(@MovID,'') + '</th>'
		    SELECT @String = @String + '    <th style="text-align:right; padding:3px 12px; border-bottom:0px; background:#337ab7;">FECHA: '+ ISNULL(CONVERT(varchar,@FechaEmision, 105), '') + '</th>'
		    SELECT @String = @String + '  </tr>'
		    SELECT @String = @String + '</table>'
    
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
     END
     
     
     EXEC spPOSGenereDoctos @ID,@Mov,@Cadena OUTPUT    
     
     IF @MovClave IN ('POS.N', 'POS.A', 'POS.F','POS.P','POS.P','POS.NPC','POS.NPC','POS.FA','POS.CXCC','POS.CXCD')
     BEGIN
		IF @EsImpresion = 1 
		BEGIN
			-- Nombre del Cliente
			SELECT @String = dbo.fnAlinearCampoValor2((ISNULL('CLIENTE:            '+UPPER(@CteNombre), '')), '<BR>', @LargoLineaTicket)
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')       
    
			-- RFC del Cliente
			SELECT @String = dbo.fnAlinearCampoValor2((ISNULL(UPPER('RFC:                    ' + @CteRFC), '')), '<BR>', @LargoLineaTicket)
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')            
       
			--Condicion 
			IF NULLIF(@Condicion,'')IS NOT NULL
			BEGIN
				SELECT @String = dbo.fnAlinearCampoValor2((ISNULL(UPPER('Condiciones: ' + @Condicion), '')), '<BR>', @LargoLineaTicket)
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')            
			END
             
			-- Origen
			IF NULLIF(@Origen,'') IS NOT NULL
			BEGIN
				SELECT @Ticket = @Ticket + '<BR>'
				SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('ORIGEN: ' + LTRIM(RTRIM(@Origen)) + ' ' + 
					   @OrigenID), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
				SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
			END             
		END
		IF @EsImpresion = 0
		BEGIN
			SET @String = ''
			SELECT @String = @String + '<table width="100%">'
			SELECT @String = @String + '  <tr>'
			SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">CLIENTE: ' + ISNULL(RTRIM(LTRIM(UPPER(@CteNombre))),'') + ' ' + ISNULL(@MovID,'') + '</th>'
			SELECT @String = @String + '    <th style="text-align:right; padding:3px 12px; border-bottom:0px; background:#337ab7;">RFC: '+ ISNULL(UPPER(@CteRFC), '') + '</th>'
			SELECT @String = @String + '  </tr>'
			SELECT @String = @String + '</table>'
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')    

			--Condicion 
			IF NULLIF(@Condicion,'')IS NOT NULL
			BEGIN
				SET @String = ''
				SELECT @String = @String + '<table width="100%">'
				SELECT @String = @String + '  <tr>'
				SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">CONDICIONES: ' + ISNULL(RTRIM(LTRIM(UPPER(@Condicion))),'') + '</th>'
				SELECT @String = @String + '  </tr>'
				SELECT @String = @String + '</table>'
				SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')                
			END
      
			-- Origen
			IF NULLIF(@Origen,'') IS NOT NULL
			BEGIN
				SET @String = ''
				SELECT @String = @String + '<table width="100%">'
				SELECT @String = @String + '  <tr>'
				SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">ORIGEN: ' + ISNULL(RTRIM(LTRIM(UPPER(@Origen))),'') + ' ' + ISNULL(RTRIM(LTRIM(UPPER(@OrigenID))),'')+ '</th>'
				SELECT @String = @String + '  </tr>'
				SELECT @String = @String + '</table>'
				SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')            
			END
		END
     END

	IF @EsImpresion = 1
	BEGIN
		-- Cajero y Agente
		IF NULLIF(@Cajero,'') IS NOT NULL
		BEGIN    
			SELECT @String = dbo.fnAlinearCampoValor2((ISNULL(UPPER('CAJERO:       ' + @Cajero), '	') + '                                ' + 
				   ISNULL(UPPER('AGENTE: ' + @Agente), '')), '<BR>', @LargoLineaTicket)
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')            
		END
  
		--Monedero
		IF NULLIF(@Monedero,'') IS NOT NULL
		BEGIN
			SELECT @String ='<BR>'+ dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('MONEDERO : ' + 
				   ISNULL(@Monedero,'')), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
		END            
    
		--Referencia Pedido
		IF NULLIF(@PedidoReferencia,'') IS NOT NULL
		BEGIN
			SELECT @String ='<BR>'+ dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('Pedido Referencia : ' + 
				   ISNULL(@PedidoReferencia,'')), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')            
		END
	END
    
	IF @EsImpresion = 0
	BEGIN
		-- Cajero y Agente
		IF NULLIF(@Cajero,'') IS NOT NULL
		BEGIN    
			SET @String = ''
			SELECT @String = @String + '<table width="100%">'
			SELECT @String = @String + '  <tr>'
			SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">CAJERO: ' + ISNULL(UPPER(@Cajero),'') + '</th>'
			SELECT @String = @String + '    <th style="text-align:right; padding:3px 12px; border-bottom:0px; background:#337ab7;">AGENTE: '+ ISNULL(UPPER(@Agente), '') + '</th>'
			SELECT @String = @String + '  </tr>'
			SELECT @String = @String + '</table>'
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')     
		END
  
		--Monedero
		IF NULLIF(@Monedero,'') IS NOT NULL
		BEGIN
			SET @String = ''
			SELECT @String = @String + '<table width="100%">'
			SELECT @String = @String + '  <tr>'
			SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">MONEDERO: ' + ISNULL(UPPER(@Monedero),'') + '</th>'
			SELECT @String = @String + '  </tr>'
			SELECT @String = @String + '</table>'
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
		END     
    
		--Referencia Pedido
		IF NULLIF(@PedidoReferencia,'') IS NOT NULL
		BEGIN
			SET @String = ''
			SELECT @String = @String + '<table width="100%">'
			SELECT @String = @String + '  <tr>'
			SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">PEDIDO REFERENCIA: ' + ISNULL(UPPER(@PedidoReferencia),'') + '</th>'
			SELECT @String = @String + '  </tr>'
			SELECT @String = @String + '</table>'
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
		END     
	END
     
	-- Linea Original, se quita la clave POS.CXCCC para que no aparesca en el ticket de la cabecera
	IF @MovClave IN('POS.CXCD')
	BEGIN
		SELECT TOP 1 @Aplica = Aplica, @AplicaID = AplicaID FROM POSLVenta WHERE ID = @ID		
		IF @Aplica IS NOT NULL AND @AplicaID IS NOT NULL
		BEGIN
			IF @EsImpresion = 1
			BEGIN
				SELECT @String ='<BR>'+ dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('Aplica : ' + 
					   ISNULL(@Aplica+' '+@AplicaID,'')), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
				SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
         
				IF @CXCSaldoTotal IS NOT NULL
				BEGIN
					SELECT @String ='<BR>'+ dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('Saldo Total : ' + 
						   dbo.fnFormatoMoneda(@CXCSaldoTotal,@Empresa)), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
					SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')          
				END
			END  
			IF @EsImpresion = 0
			BEGIN
				SET @String = ''
				SET @String = @String + '<table width="100%">'
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">APLICA: ' + ISNULL(UPPER(@Aplica),'') + ISNULL(UPPER(@AplicaID),'') + '</th>'
				SET @String = @String + '  </tr>'
				SET @String = @String + '</table>'

				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
         
				IF @CXCSaldoTotal IS NOT NULL
				BEGIN
					SET @String = ''
					SET @String = @String + '<table width="100%">'
					SET @String = @String + '  <tr>'
					SET @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">SALDO TOTAL: ' + ISNULL(dbo.fnFormatoMoneda(@CXCSaldoTotal,@Empresa),'') + '</th>'
					SET @String = @String + '  </tr>'
					SET @String = @String + '</table>'

					SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
				END  
			END
		END
	END
     
	IF @MovClave IN('POS.FA') AND @MovSubClave = 'POS.ANTREF'
	BEGIN
		IF @EsImpresion = 1
		BEGIN
			SELECT @String ='<BR>'+ dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('Saldo PEDIDO : ' + 
				   dbo.fnFormatoMoneda(@CXCSaldoTotal,@Empresa)), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')          
		END  
		IF @EsImpresion = 0
		BEGIN
			SET @String = ''
			SET @String = @String + '<table width="100%">'
			SET @String = @String + '  <tr>'
			SET @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">SALDO PEDIDO: ' + ISNULL(dbo.fnFormatoMoneda(@CXCSaldoTotal,@Empresa),'') + '</th>'
			SET @String = @String + '  </tr>'
			SET @String = @String + '</table>'

			SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
		END
	END

	--Beneficiario 
	IF @MovClave = 'POS.EC'
	BEGIN
		IF @EsImpresion = 1
		BEGIN
			SELECT @String ='<BR>'+ dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('BENEFICIARIO : ' + 
				   ISNULL(@Beneficiario,'')), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
		END     
		IF @EsImpresion = 0
		BEGIN
			SET @String = ''
			SET @String = @String + '<table width="100%">'
			SET @String = @String + '  <tr>'
			SET @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">BENEFICIARIO: ' + ISNULL(UPPER(@Beneficiario),'') + '</th>'
			SET @String = @String + '  </tr>'
			SET @String = @String + '</table>'

			SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
		END
	END     

      --AlmDestino
     IF @MovClave IN('POS.INVD', 'POS.INVA')
     BEGIN
		IF @EsImpresion = 1
		BEGIN
			IF NULLIF(@Almacen,'')IS NOT NULL 
			BEGIN
				SELECT @String = CASE WHEN @EsImpresion= 1 THEN '<BR>' ELSE '' END + 
					   dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('Almacen Origen:   ' + @Almacen+ ' ' + 
					   SUBSTRING(@AlmacenNombre,1,30)), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
				SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			END      
			
			IF NULLIF(@AlmacenDestino,'')IS NOT NULL 
			BEGIN
				SELECT @String = dbo.fnAlinearCampoValor2(dbo.fnCentrar(ISNULL(UPPER('Almacen Destino: ' + @AlmacenDestino+ ' ' + 
					   SUBSTRING(@AlmacenDestinoNombre,1,30)), ''), @LargoLineaTicket-4), '<BR>', @LargoLineaTicket)
				SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			END                  
		END        
		IF @EsImpresion = 0
		BEGIN
			IF NULLIF(@Almacen,'')IS NOT NULL 
			BEGIN
				SET @String = ''
				SET @String = @String + '<table width="100%">'
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">ALMACEN ORIGEN: ' + ISNULL(UPPER(@Almacen),'')+ ' ' + SUBSTRING(UPPER(ISNULL(@AlmacenNombre,'')),1,30) + '</th>'
				SET @String = @String + '  </tr>'
				SET @String = @String + '</table>'

				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
			END      
			
			IF NULLIF(@AlmacenDestino,'')IS NOT NULL 
			BEGIN
				SET @String = ''
				SET @String = @String + '<table width="100%">'
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">ALMACEN DESTINO: ' + ISNULL(UPPER(@AlmacenDestino),'')+ ' ' + SUBSTRING(UPPER(ISNULL(@AlmacenDestinoNombre,'')),1,30) + '</th>'
				SET @String = @String + '  </tr>'
				SET @String = @String + '</table>'

				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
			END 
		END
     END

	IF @MovClave IN('POS.CC','POS.CCM') AND @DesgloseCC = 1
	BEGIN
		EXEC spPOSTicketDesgloseCorte    @ID, @Empresa, @Sucursal, @Host, @Usuario, @MovClave, @CtaDinero, @Estacion, @LargoLineaTicket, @String2 OUTPUT, @Ok  OUTPUT, @OkRef  OUTPUT
		SELECT @Ticket = @Ticket +'<BR>'+ISNULL(@String2,'') 
	END       
     
	IF @MovClave IN ('POS.AC','POS.AP', 'POS.CC', 'POS.CPC','POS.CAC','POS.CCC')
	BEGIN
		IF @EsImpresion = 1
		BEGIN
			SELECT @Ticket = @Ticket + '<BR>' + REPLICATE('-', @LargoLineaTicket +CASE WHEN @EsImpresion=0 THEN 32 ELSE 0 END) + '<BR>' + 
							 dbo.fnCentrar(UPPER('Cuenta'), @LargoLineaTicket /2) + dbo.fnCentrar(UPPER('Cuenta Destino'), @LargoLineaTicket /2)  + '<BR>' +
							 REPLICATE('-', @LargoLineaTicket+CASE WHEN @EsImpresion=0 THEN 32 ELSE 0 END) + '<BR>' 
			SELECT @String = dbo.fnCentrar(ISNULL(@CtaDinero,''), @LargoLineaTicket/2) + dbo.fnCentrar(ISNULL(@CtaDineroDestino,''), @LargoLineaTicket/2) + '<BR>'
			SELECT @Ticket = @Ticket + @String
		END
		IF @EsImpresion = 0
		BEGIN
			SET @String = ''
			SET @String = @String + '<table width="100%">'
			SET @String = @String + '  <tr>'
			SET @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">CUENTA: ' + ISNULL(UPPER(@CtaDinero),'') + '</th>'
			SET @String = @String + '    <th style="text-align:right; padding:3px 12px; border-bottom:0px; background:#337ab7;">CUENTA DESTINO: ' + ISNULL(UPPER(@CtaDineroDestino),'') + '</th>'
			SET @String = @String + '  </tr>'
			SET @String = @String + '</table>'

			SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
		END
	END
     
	IF @MovClave IN ('POS.IC', 'POS.EC')
	BEGIN
		IF @EsImpresion = 1
		BEGIN
			SELECT @Ticket = @Ticket + '<BR>' + REPLICATE('-', @LargoLineaTicket +CASE WHEN @EsImpresion=0 THEN 32 ELSE 0 END) + '<BR>' + 
							 dbo.fnCentrar(UPPER('Cuenta :'), @LargoLineaTicket /2) + dbo.fnCentrar(ISNULL(@CtaDinero,''), @LargoLineaTicket /2)  + '<BR>' +
							 REPLICATE('-', @LargoLineaTicket+CASE WHEN @EsImpresion=0 THEN 32 ELSE 0 END) + '<BR>' 
      
			SELECT @Ticket = @Ticket + '<BR>' 
		END
		IF @EsImpresion = 0
		BEGIN
			SET @String = ''
			SET @String = @String + '<table width="100%">'
			SET @String = @String + '  <tr>'
			SET @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">CUENTA: ' + ISNULL(UPPER(@CtaDinero),'') + '</th>'
			SET @String = @String + '  </tr>'
			SET @String = @String + '</table>'

			SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
		END
	END
    
	--Aqui se llenan los datos de la sucursal del cliente
	IF @CteEnviarA IS NOT NULL
	BEGIN
		SELECT @CteEnviarANombre = c.Nombre           
		  FROM CteEnviarA c
		 WHERE c.Cliente = @Cliente
		   AND c.ID = @CteEnviarA
		
		IF @EsImpresion = 1
		BEGIN
			SELECT @Ticket = @Ticket + '<BR>' +   
							CASE @Cliente WHEN NULL THEN '' 
							ELSE dbo.fnCentrar(ISNULL(UPPER('SUCURSAL: ' + @CteEnviarANombre), ''), @LargoLineaTicket) 
							END + '<BR>' 
		END
		IF @EsImpresion = 0
		BEGIN
			SET @String = ''
			SET @String = @String + '<table width="100%">'
			SET @String = @String + '  <tr>'
			SET @String = @String + '    <th style="text-align:center; padding:3px 12px; border-bottom:0px; background:#337ab7;">SUCURSAL: ' + ISNULL(UPPER(@CteEnviarANombre),'') + '</th>'
			SET @String = @String + '  </tr>'
			SET @String = @String + '</table>'
        
			SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
		END
	END
     
	--Aqui se inserta el titulo del detalle del ticket
	IF @MovClave IN ('POS.N', 'POS.A', 'POS.F','POS.P','POS.NPC')
	BEGIN
		SELECT @CodigoRedondeo = pc.RedondeoVentaCodigo,
			   @RedondeoVenta = pc.RedondeoVenta,
			   @POSImpuestoIncluido = ISNULL(ImpuestoIncluido,0),
			   @ArticuloOfertaFP = pc.ArtOfertaFP
		  FROM POSCfg pc
		 WHERE pc.Empresa = @Empresa

		SELECT @ArticuloRedondeo = cb.Cuenta
		  FROM CB
		 WHERE CB.Cuenta = @CodigoRedondeo
		   AND CB.TipoCuenta = 'Articulos'
                  
		IF @EsImpresion = 0
		BEGIN      
			SET @String = ''
			SET @String = @String + '<table width="100%" style="border-spacing:0px; border-color:#A8A4A4;">'
			SET @String = @String + '  <tr style="background-color:#333; border-spacing:0px; border-color:#333;">'
			SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;">CANT</th>'
			SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;">PRODUCTO</th>'
			SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;">DESCRIPCION</th>'
			SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;">PRECIO</th>'
			SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;">DESCTO</th>'
			SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;">IMPORTE</th>'
			SET @String = @String + '  </tr>'
			--SET @String = @String + '</table>'
                  
			SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
		END
		IF @EsImpresion = 1	
		BEGIN
			SELECT @Ticket = @Ticket + '<BR>' + REPLICATE('-', @LargoLineaTicket) + '<BR>' + '   CANT '  + ' PRODUCTO ' + ' ' + 
							 dbo.fnAlinearDerecha('PRECIO', 9)  + dbo.fnAlinearDerecha('DESCTO.', 8) +  dbo.fnAlinearDerecha('IMPORTE',8) + 
							 '<BR>' + REPLICATE('-', @LargoLineaTicket) + '<BR>'        
		END	        
		        
		IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID)
		BEGIN
			DECLARE crArticulos CURSOR LOCAL FOR
			SELECT plv.Articulo,
				   plv.Renglon,
				   plv.SubCuenta,
				   plv.Cantidad,
				   plv.Precio,
				   plv.DescuentoLinea,
				   plv.Impuesto1,
				   plv.Impuesto2,
				   plv.Impuesto3,
				   plv.Unidad,
				   ISNULL(plv.CantidadObsequio,0.0),
				   plv.Puntos, 
				   plv.PrecioSugerido ,
				   plv.Aplicado,
				   plv.PrecioImpuestoInc,
				   dbo.fnRellenarConCaracter(SUBSTRING(ISNULL(a.Descripcion1,''),1,20),20,'D',CHAR(32)) ,    	         
				   dbo.fnRellenarConCaracter(SUBSTRING(ISNULL(a.Descripcion1,''),1,50),50,'D',CHAR(32)) ,
				   plv.OfertaID,
				   ISNULL(plv.AplicaDescGlobal,1)    	         
			  FROM POSLVenta plv JOIN Art a ON plv.Articulo = a.Articulo
			 WHERE plv.ID = @ID
			   AND plv.Articulo <> ISNULL(@ArticuloRedondeo,'')
			   AND plv.RenglonTipo <> 'K'   
			  OPEN crArticulos
			  FETCH NEXT FROM crArticulos INTO @Articulo, @Renglon, @SubCuenta, @Cantidad, @Precio, @DescuentoLinea, @Impuesto1, @Impuesto2, @Impuesto3, 
											   @Unidad, @CantidadObsequio, @Puntos, @PrecioSugerido, @Aplicado, @PrecioImpuestoInc,@Descripcion, @Descripcion2, 
											   @OfertaID, @AplicaDescGlobal
			  WHILE @@FETCH_STATUS <> -1 
			  BEGIN
			  IF @@FETCH_STATUS <> -2 
			  BEGIN        
				IF @EsImpresion = 0
				BEGIN
					IF @Cantidad-@CantidadObsequio <> 0.0 
					BEGIN
						SET @String = ''
						SET @String = @String + '  <tr>'
						SET @String = @String + '    <td>'+CONVERT(varchar,@Cantidad-@CantidadObsequio)+'</td>'
						SET @String = @String + '    <td>'+RTRIM(@Articulo)+'</td>'
						SET @String = @String + '    <td>'+RTRIM(@Descripcion)+'</td>'
						SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda(ISNULL(CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END ,0.0),@Empresa)+'</td>'
						SET @String = @String + '    <td style="text-align:right;">'+CONVERT(varchar, ISNULL(@DescuentoLinea, 0.0))+ ' %'+'</td>'
						SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda((@Cantidad - ISNULL(@CantidadObsequio, 0.0)) * ISNULL((CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END - (CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END * (ISNULL(@DescuentoLinea,0.0)/100))),0.0),@Empresa)+'</td>'
						SET @String = @String + '  </tr>'
						SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
					END
                 
					SELECT @DescuentoLineaAcumulado = ISNULL(@DescuentoLineaAcumulado,0) + ((@Cantidad - ISNULL(@CantidadObsequio, 0)) * 
													  ISNULL((CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END * 
													  (ISNULL(@DescuentoLinea,0)/100)),0))

					--Articulos Obsequiados
					IF ISNULL(@CantidadObsequio,0) >= 1.0
					BEGIN
						IF @EsImpresion = 0
						BEGIN
							SET @String = ''
							SET @String = @String + '  <tr>'
							SET @String = @String + '    <td colspan="6" style="text-align:center;">'+'******    ' + CONVERT(varchar, @CantidadObsequio) + ' ' + @Unidad + ' ' + dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ') + '  ' + @Descripcion + ' Articulo' + CASE WHEN @CantidadObsequio > 1 THEN 's' ELSE '' END + ' Obsequiado' + CASE WHEN @CantidadObsequio > 1 THEN 's' ELSE '' END +'    ******'+'</td>'
							SET @String = @String + '  </tr>'

							SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
						END
						IF @EsImpresion = 1 
						BEGIN
							SELECT @String = @String+'<BR>'+dbo.fnCentrar('******    ' + CONVERT(varchar, @CantidadObsequio) + ' ' + @Unidad + ' ' +
											 dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ') + '  ' + @Descripcion + ' Articulo' + 
											 CASE WHEN @CantidadObsequio > 1 THEN 's' ELSE '' END + 
											 ' Obsequiados    ******',@LargoLineaTicket) + ' <BR><BR>'
							SELECT @Ticket = @Ticket + @String
						END 
						--Aqui se incluye en el usted ahorro los obsequios
						SELECT @DescuentoLineaAcumulado = ISNULL(@DescuentoLineaAcumulado,0) + ISNULL(@CantidadObsequio, 0) * ISNULL((CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END * 
														  (ISNULL(NULLIF(@DescuentoLinea,0),1))),0) END  
                 
						IF EXISTS(SELECT * FROM Oferta WHERE ID = @OfertaID AND Forma = 'Precio') AND (ISNULL(@PrecioSugerido,0.0)-ISNULL(@Precio,0.0))>0.0
						BEGIN
							IF @EsImpresion = 0
							BEGIN
								SET @String = ''
								SET @String = @String + '  <tr>'
								SET @String = @String + '    <td colspan="6" style="text-align:center;">'+'******     USTED AHORRO ' + 
											  dbo.fnFormatoMoneda((ISNULL(@PrecioSugerido,0.0)-ISNULL(CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END ,0.0)) * 
											  @Cantidad,@Empresa) + ' ' + @Moneda + '  ******     '+'</td>'
								SET @String = @String + '  </tr>'
              
								SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
							END  
							IF @EsImpresion = 1
							BEGIN
								SELECT @Ticket = @Ticket+dbo.fnCentrar('******     USTED AHORRO ' + dbo.fnFormatoMoneda((ISNULL(@PrecioSugerido,0.0)-ISNULL(CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END ,0.0)) * 
												 @Cantidad,@Empresa) + ' ' + @Moneda + '  ******     ',@LargoLineaTicket-4)+' <BR>' END
							END
                                
							IF @Cantidad < 0.0 
							BEGIN
								IF @EsImpresion = 0
								BEGIN
									SET @String = ''
									SET @String = @String + '  <tr>'
									SET @String = @String + '    <td colspan="6" style="text-align:center;">'+dbo.fnRellenarConCaracter(CONVERT(varchar,@Cantidad),6,'i',CHAR(32)) + '  ' + 
												  dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ') + '  ' + @Descripcion + ' ' + 
												  dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END ,0.0), @Empresa), 8) + 
												  dbo.fnAlinearDerecha(CONVERT(varchar, ISNULL(@DescuentoLinea,0.0)), 6) + '% ' +  dbo.fnAlinearDerecha(dbo.fnFormatoMoneda((@Cantidad - ISNULL(@CantidadObsequio, 0.0)) * 
												  ISNULL((@Precio - (@Precio * (ISNULL(@DescuentoLinea,0.0)/100))),0.0),@Empresa),10)+'</td>'
									SET @String = @String + '  </tr>'
									SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
								END
								IF @EsImpresion = 1
								BEGIN
									SELECT @String = ISNULL(@String,'') + dbo.fnRellenarConCaracter(CONVERT(varchar,@Cantidad),6,'i',CHAR(32)) + '  ' + 
													 dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ') + '  ' + @Descripcion + ' ' + 
													 dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END ,0.0), @Empresa), 8) + 
													 dbo.fnAlinearDerecha(CONVERT(varchar, ISNULL(@DescuentoLinea,0.0)), 6) + '% ' +  dbo.fnAlinearDerecha(dbo.fnFormatoMoneda((@Cantidad - 
													 ISNULL(@CantidadObsequio, 0.0)) * ISNULL((@Precio - (@Precio * (ISNULL(@DescuentoLinea,0.0)/100))),0.0),@Empresa),10) + '<BR>' 
								END

							END
							IF ISNULL(@CantidadObsequio,0) < 0.0
							BEGIN
								IF @EsImpresion =0
								BEGIN       
									SET @String = ''
									SET @String = @String + '  <tr>'
									SET @String = @String + '    <td colspan="6" style="text-align:center;">'+CONVERT(varchar, @CantidadObsequio) + ' ' + 
												  dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ') + ' Articulo' + CASE WHEN @CantidadObsequio > 1 THEN 's' ELSE '' END + ' Obsequiados    ******'+'</td>'
									SET @String = @String + '  </tr>'

									SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
								END 
								IF @EsImpresion =1
								BEGIN 
									SELECT @String = @String + '<BR>' + dbo.fnCentrar('******    ' + CONVERT(varchar, @CantidadObsequio) + ' ' + 
													 dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ') + ' Articulo' + CASE WHEN @CantidadObsequio > 1 THEN 's' ELSE '' END + 
													 ' Obsequiados    ******',@LargoLineaTicket-4)+' <BR>'
									SELECT @Ticket = @Ticket + @String
								END
								SELECT @DescuentoLineaAcumulado = ISNULL(@DescuentoLineaAcumulado,0) + ISNULL(@CantidadObsequio, 0) * ISNULL((CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END * 
																 (ISNULL(NULLIF(@DescuentoLinea,0),1))),0)              

							END
				END
				ELSE
				BEGIN
					-- Linea del Detalle 
					-- Linea Original, Modificada para que solo entren los Obsequios mayores a 0 (cero) JLMR Abril 2014
					-- EAS Modifica la linea para que la descripción aparezca en la siguiente líena Enero 2017
					IF @Cantidad-@CantidadObsequio <>0.0 
					BEGIN 
						SELECT @String = dbo.fnRellenarConCaracter(CONVERT(varchar,@Cantidad-@CantidadObsequio),5,'i',CHAR(32)) +' '+ 
										 --dbo.fnRellenarConCaracter(Rtrim(@Articulo),20,'D', SPACE(1))+''+ dbo.fnRellenarConCaracter(@Descripcion,20,'I', SPACE(1))+'   ' + 
										 dbo.fnRellenarConCaracter(Rtrim(@Articulo),10,'D', SPACE(1))+' ' + 
										 dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END ,0.0),@Empresa), 8)
										 +' '+ dbo.fnAlinearDerecha(CONVERT(varchar, ISNULL(@DescuentoLinea, 0.0))+ ' % ', 8) +' '+  dbo.fnAlinearDerecha(dbo.fnFormatoMoneda( (@Cantidad - ISNULL(@CantidadObsequio, 0.0)) * 
										 ISNULL((CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END - 
										 (CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END * (ISNULL(@DescuentoLinea,0.0)/100))),0.0),@Empresa),12) + '<BR>' 
						SELECT @String = @String + '       '+ dbo.fnRellenarConCaracter(@Descripcion,20,'I', SPACE(1))+ + '<BR>' 
					END
					ELSE 
						SELECT @String =''
                 
					SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')                        
					SELECT @String =''
                
					IF @Cantidad - @CantidadObsequio > 0.0   
					BEGIN
						IF @EsImpresion = 0
						BEGIN     
							SET @String = ''
							SET @String = @String + '  <tr>'
							SET @String = @String + '    <td colspan="6" style="text-align:center;">'+CONVERT(varchar,@Cantidad-@CantidadObsequio) +'  '+
										  dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ')+' ' + 
										  dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(CASE WHEN @POSImpuestoIncluido =1 THEN @PrecioImpuestoInc ELSE @Precio END ,0.0),@Empresa), 8)  + 
										  dbo.fnAlinearDerecha(CONVERT(varchar, ISNULL(@DescuentoLinea,0.0)), 6) + '% ' +  dbo.fnAlinearDerecha(dbo.fnFormatoMoneda((@Cantidad - ISNULL(@CantidadObsequio, 0.0)) * 
										  ISNULL((@Precio - (@Precio * (ISNULL(@DescuentoLinea,0.0)/100))),0.0),@Empresa),10)+'</td>'
							SET @String = @String + '  </tr>'

							SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 

							SET @String = ''
							SET @String = @String + '  <tr>'
							SET @String = @String + '    <td colspan="6" style="text-align:center;">'+
										  CASE WHEN @Articulo = @ArticuloOfertaFP THEN @Descripcion2+ ' IMPUESTOS AL '+CONVERT(varchar,@Impuesto1)+'%' ELSE +@Descripcion2+ '' END+'</td>'
							SET @String = @String + '  </tr>'

							SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
						END
						IF @EsImpresion = 1
						BEGIN
							SELECT @String =dbo.fnRellenarConCaracter(CONVERT(varchar,@Cantidad-@CantidadObsequio),6,'i',CHAR(32)) +'  '+
											dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ')+' ' + 
											dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(CASE WHEN @POSImpuestoIncluido =1 THEN @PrecioImpuestoInc ELSE @Precio END ,0.0),@Empresa), 8)  + 
											dbo.fnAlinearDerecha(CONVERT(varchar, ISNULL(@DescuentoLinea,0.0)), 6) + '% ' +  dbo.fnAlinearDerecha(dbo.fnFormatoMoneda((@Cantidad - ISNULL(@CantidadObsequio, 0.0)) * 
											ISNULL((@Precio - (@Precio * (ISNULL(@DescuentoLinea,0.0)/100))),0.0),@Empresa),10) + '<BR>' +
											dbo.fnRellenarConCaracter('',6,'i',CHAR(32))+'  '+ 
											CASE WHEN @Articulo = @ArticuloOfertaFP THEN @Descripcion2+ ' IMPUESTOS AL '+CONVERT(varchar,@Impuesto1)+'%  <BR>' ELSE +@Descripcion2+ '<BR>'  END
						END
					END
                
					IF @Cantidad < 0.0   
					BEGIN
						IF @EsImpresion = 0
						BEGIN
							SET @String = ''
							SET @String = @String + '  <tr>'
							SET @String = @String + '    <td>'+CONVERT(varchar,@Cantidad)+'</td>'
							SET @String = @String + '    <td>'+RTRIM(@Articulo)+'</td>'
							SET @String = @String + '    <td>'+RTRIM(@Descripcion2)+'</td>'
							SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda(ISNULL(CASE WHEN @POSImpuestoIncluido = 1 THEN @PrecioImpuestoInc ELSE @Precio END ,0.0),@Empresa)+'</td>'
							SET @String = @String + '    <td style="text-align:right;">'+CONVERT(varchar, ISNULL(@DescuentoLinea, 0.0))+ ' %'+'</td>'
							SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda( (@Cantidad - ISNULL(@CantidadObsequio, 0.0)) * ISNULL((@Precio - (@Precio * (ISNULL(@DescuentoLinea,0.0)/100))),0.0),@Empresa)+'</td>'
							SET @String = @String + '  </tr>'
							SET @String = @String + '</table>'
							SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
						END
						IF @EsImpresion = 1
						BEGIN
							SELECT @String = ISNULL(@String,'')+dbo.fnRellenarConCaracter(CONVERT(varchar,@Cantidad),6,'i',CHAR(32))+'  '+ dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ')+' ' + 
											 dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(CASE WHEN @POSImpuestoIncluido =1 THEN @PrecioImpuestoInc ELSE @Precio END ,0.0),@Empresa), 8)  + 
											 dbo.fnAlinearDerecha(CONVERT(varchar, ISNULL(@DescuentoLinea,0.0)), 6) + '%' +  
											 dbo.fnAlinearDerecha(dbo.fnFormatoMoneda( (@Cantidad - ISNULL(@CantidadObsequio, 0.0)) * ISNULL((@Precio - (@Precio * (ISNULL(@DescuentoLinea,0.0)/100))),0.0),@Empresa),10) + '<BR>' +
											 dbo.fnRellenarConCaracter('',6,'i',CHAR(32))+'  '+@Descripcion2+ '<BR>'    
                 
							SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')                        
						END
					END
					SELECT @DescuentoLineaAcumulado = ISNULL(@DescuentoLineaAcumulado,0) + ((@Cantidad - ISNULL(@CantidadObsequio, 0)) * 
													  ISNULL((CASE WHEN @POSImpuestoIncluido =1 THEN @PrecioImpuestoInc ELSE @Precio END * 
													  (ISNULL(@DescuentoLinea,0)/100)),0))

					IF ISNULL(@CantidadObsequio,0) >= 1.0
					BEGIN
						IF @EsImpresion = 0
						BEGIN
							SET @String = ''
							SET @String = @String + '  <tr>'
							SET @String = @String + '    <td>'+CONVERT(varchar,@CantidadObsequio)+'</td>'
							SET @String = @String + '    <td>'+RTRIM(@Articulo)+'</td>'
							SET @String = @String + '    <td>'+RTRIM(@Descripcion2)+'</td>'
							SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda(0.0,@Empresa)+'</td>'
							SET @String = @String + '    <td style="text-align:right;">'+CONVERT(varchar,0.0)+ ' %'+'</td>'
							SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda(0.0,@Empresa)+'</td>'
							SET @String = @String + '  </tr>'

							SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 

                   
							SET @String = ''
							SET @String = @String + '  <tr>'
							SET @String = @String + '    <td colspan="6" style="text-align:center;">'+CONVERT(varchar, @CantidadObsequio) + ' ' + 
										  dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ') + ' Articulo' + 
										  CASE WHEN @CantidadObsequio > 1 THEN 's' ELSE '' END + ' Obsequiados    ******'+'</td>'
							SET @String = @String + '  </tr>'

							SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
						END
						IF @EsImpresion = 1
						BEGIN
							SELECT @String = '' + dbo.fnRellenarConCaracter(CONVERT(varchar,@CantidadObsequio),6,'i',CHAR(32)) + '  ' + dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ') + ' ' + 
											 dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(0.0,@Empresa), 8) + dbo.fnAlinearDerecha(CONVERT(varchar,0.0), 6) + '% ' +  dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(0.0,@Empresa),10) + '<BR>' +
											 dbo.fnRellenarConCaracter('',6,'i',CHAR(32)) + '  ' + @Descripcion2 + '<BR>' 
                   
							SELECT @String = @String + '<BR>' + dbo.fnCentrar('******    ' + CONVERT(varchar, @CantidadObsequio) + ' ' + dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ') + ' Articulo' + 
										     CASE WHEN @CantidadObsequio > 1 THEN 's' ELSE '' END + ' Obsequiados    ******',@LargoLineaTicket-4)+' <BR><BR>'
                   
							SELECT @Ticket = @Ticket + @String
						END
              
						SELECT @DescuentoLineaAcumulado = ISNULL(@DescuentoLineaAcumulado,0) + ISNULL(@CantidadObsequio, 0) * ISNULL((CASE WHEN @POSImpuestoIncluido =1 THEN @PrecioImpuestoInc ELSE @Precio END * (ISNULL(NULLIF(@DescuentoLinea,0),1))),0)              
					END                          
				END
              
				IF EXISTS(SELECT * FROM POSOfertaTemp WHERE Estacion = @Estacion AND Articulo = @Articulo AND IDR = @ID AND Renglon = @Renglon) AND ISNULL(@Aplicado,0)=0
				BEGIN
					SELECT @OfertaPuntos = (Puntos), @OfertaPrecio = Precio
					  FROM POSOfertaTemp 
					 WHERE Estacion = @Estacion AND Articulo = @Articulo 
					   AND IDR = @ID AND Renglon = @Renglon

					IF @EsImpresion = 0
					BEGIN
						SET @String = ''
						SET @String = @String + '  <tr>'
						SET @String = @String + '    <td colspan="6" style="text-align:center;">'+'******    CON  ' + CONVERT(varchar, @OfertaPuntos) + '  PUNTOS PAGUE SOLO ' +
									  dbo.fnFormatoMoneda((@OfertaPrecio*@Cantidad),@Empresa) + '    ******'+'</td>'
						SET @String = @String + '  </tr>'

						SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
					END
					IF @EsImpresion = 1
					BEGIN
						SELECT @String = '<BR>' + dbo.fnCentrar('******    CON  ' + CONVERT(varchar, @OfertaPuntos) + '  PUNTOS PAGUE SOLO ' +
										 dbo.fnFormatoMoneda((@OfertaPrecio*@Cantidad),@Empresa) + '    ******',@LargoLineaTicket-4) + ' <BR><BR>'
                 
						SELECT @Ticket = @Ticket + @String              
					END 
				END

				IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID ) AND NULLIF(@Monedero,'') IS NOT NULL AND ISNULL(@Puntos,0.0) < 0.0 AND ISNULL(@Aplicado,0)=1
				BEGIN    
					IF @EsImpresion = 0
					BEGIN    
						SELECT @Ahorro = SUM((ISNULL(@PrecioSugerido,0.0) * @Cantidad) - (ISNULL(@Precio,0.0)*@Cantidad)),@PuntosUtilizados = ABS(SUM(@Puntos))

						SET @String = ''
						SET @String = @String + '  <tr>'
						SET @String = @String + '    <td colspan="6" style="text-align:center;">'+'*****  USTED UTILIZO ' + CONVERT(varchar,@PuntosUtilizados) + ' PUNTOS  Y AHORRO :' + 
									  dbo.fnFormatoMoneda(ISNULL(@Ahorro,0.0),@Empresa) + '    ******'+'</td>'
						SET @String = @String + '  </tr>'
						SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
					END
					IF @EsImpresion = 1
					BEGIN
						SELECT @String = '<BR>' + dbo.fnCentrar('*****  USTED UTILIZO ' + CONVERT(varchar,@PuntosUtilizados) + ' PUNTOS  Y AHORRO :' + 
										 dbo.fnFormatoMoneda(ISNULL(@Ahorro,0.0),@Empresa) + '    ******',@LargoLineaTicket-4) + '<BR><BR>'

						SELECT @Ticket = @Ticket + @String                   
					END                    
				END
               
				IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID ) AND NULLIF(@Monedero,'') IS NOT NULL AND ISNULL(@Puntos,0.0) > 0.0 AND @Estatus NOT IN ('CONCLUIDO','TRASPASADO')
				BEGIN    
					SELECT @MonedaMonedero =  Moneda 
					  FROM POSValeSerie
					 WHERE Serie = @Monedero 
           
					IF @EsImpresion = 0
					BEGIN   
						SET @String = ''
						SET @String = @String + '  <tr>'
						SET @String = @String + '    <td colspan="6" style="text-align:center;">'+'***** EN EL ARTICULO ' + dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ') + ' GANARA  ' + 
									  CONVERT(varchar,@Puntos) + ' ' + @MonedaMonedero + '    *****'+'</td>'
						SET @String = @String + '  </tr>'
						SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
					END
					IF @EsImpresion = 1
					BEGIN  
						SELECT @String = '<BR>' + dbo.fnCentrar('***** EN EL ARTICULO ' + dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ') + ' GANARA  ' + 
										  CONVERT(varchar,@Puntos) + ' ' + @MonedaMonedero + '    *****',@LargoLineaTicket-4) + ' <BR><BR>'
                 
						SELECT @Ticket = @Ticket + @String                   
					END                                       
				END                                       
           			      
				SET @Puntos = NULL           			      
			  END
			  FETCH NEXT FROM crArticulos INTO @Articulo, @Renglon, @SubCuenta, @Cantidad, @Precio, @DescuentoLinea, @Impuesto1, @Impuesto2, @Impuesto3, 
											   @Unidad, @CantidadObsequio, @Puntos, @PrecioSugerido, @Aplicado, @PrecioImpuestoInc,@Descripcion, @Descripcion2, 
											   @OfertaID, @AplicaDescGlobal
			  END
			CLOSE crArticulos
			DEALLOCATE crArticulos    
              
			SELECT @SubTotal = SUM(ISNULL(((Cantidad - ISNULL(CantidadObsequio,0)) * Precio) ,0))
			  FROM POSLVenta
			 WHERE ID = @ID  
			   AND Articulo <> ISNULL(@ArticuloRedondeo,'')	 
              
			SELECT @ImporteMov = SUM((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0)/100))) - 
								 ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0)/100))) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),
				   @ImpuestosMov = (SUM(dbo.fnPOSImporteMov(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * 
				   (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),plv.Impuesto1,plv.Impuesto2,plv.Impuesto3,plv.Cantidad))-@ImporteMov)
			  FROM POSLVenta plv 
			 INNER JOIN POSL p ON p.ID = plv.ID
			 WHERE plv.ID = @ID
				
			SELECT @TotalImpuesto1 = @ImpuestosMov
			SELECT @TotalDescuento = @SubTotal - @ImporteMov 
			SELECT @Total = @ImporteMov + @ImpuestosMov 
			SELECT @Totales = dbo.fnAlinearCampoValor2('SUBTOTAL', dbo.fnFormatoMoneda(@SubTotal,@Empresa), @LargoLineaTotales/2) + '<BR>' + 
							  dbo.fnAlinearCampoValor2('DESCUENTO', dbo.fnFormatoMoneda(@TotalDescuento,@Empresa), @LargoLineaTotales/2) + '<BR>' + 
							  dbo.fnAlinearCampoValor2('IMPUESTOS',dbo.fnFormatoMoneda(@TotalImpuesto1,@Empresa), @LargoLineaTotales/2) + '<BR>' +
							  dbo.fnAlinearCampoValor2('TOTAL', dbo.fnFormatoMoneda(@Total,@Empresa), @LargoLineaTotales/2) + '<BR>'
			
			IF @EsImpresion = 1
			BEGIN
				SET @String = ''
				SET @String = @String + '<BR><BR><BR>' + @Totales
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
			END

			IF @EsImpresion = 0
			BEGIN
				SET @String = ''
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <td colspan="5" style="text-align:right;">SUBTOTAL</td>'
				SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda(@SubTotal,@Empresa)+'</td>'
				SET @String = @String + '  </tr>'
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 

				SET @String = ''
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <td colspan="5" style="text-align:right;">DESCUENTO</td>'
				SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda(@TotalDescuento,@Empresa)+'</td>'
				SET @String = @String + '  </tr>'
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 

				SET @String = ''
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <td colspan="5" style="text-align:right;">IMPUESTOS</td>'
				SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda(@TotalImpuesto1,@Empresa)+'</td>'
				SET @String = @String + '  </tr>'
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 

				SET @String = ''
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <td colspan="5" style="text-align:right;">TOTAL</td>'
				SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda(@Total,@Empresa)+'</td>'
				SET @String = @String + '  </tr>'
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
			END
			 
 
		END
       
		IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND ISNULL(Puntos,0.0) < 0.0) AND NULLIF(@Monedero,'') IS NOT NULL
		BEGIN
			SELECT @Ahorro = SUM((ISNULL(PrecioSugerido,0.0)*Cantidad)-(ISNULL(Precio,0.0)*Cantidad)),@PuntosUtilizados = ABS(SUM(Puntos))
			  FROM POSLVenta 
			 WHERE ID = @ID 
			   AND ISNULL(Puntos,0.0) < 0.0
          
			SELECT @LineaAhorro = dbo.fnAlinearCampoValor2(ISNULL(UPPER(REPLICATE(' ', 9) + ' TOTAL PUNTOS UTILIZADOS ' + CONVERT(varchar,@PuntosUtilizados) + '  Y AHORRO :'), '') + 
								  dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(@Ahorro,0.0),@Empresa), 13), '<BR>', @LargoLineaTicket)

			IF @EsImpresion = 0
			BEGIN
				SET @String = ''
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <td colspan="5" style="text-align:right;">TOTAL PUNTOS UTILIZADOS</td>'
				SET @String = @String + '    <td style="text-align:right;">'+CONVERT(varchar,@PuntosUtilizados)+'</td>'
				SET @String = @String + '  </tr>'
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
       
				SET @String = ''
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <td colspan="5" style="text-align:right;">AHORRO</td>'
				SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda(ISNULL(@Ahorro,0.0),@Empresa)+'</td>'
				SET @String = @String + '  </tr>'
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			END
		END
       
		IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND ISNULL(Puntos,0.0) >0.0)AND NULLIF(@Monedero,'') IS NOT NULL 
		BEGIN
			SELECT @PuntosUtilizados = ABS(SUM(Puntos))
			  FROM POSLVenta 
			 WHERE ID = @ID AND ISNULL(Puntos,0.0)> 0.0
          
			SELECT @MonedaMonedero =  Moneda
			  FROM POSValeSerie
			 WHERE Serie = @Monedero 
          
			IF @Estatus IN ('CONCLUIDO','TRASPASADO')
			BEGIN
				SELECT @LineaAhorro = dbo.fnAlinearCampoValor2(ISNULL(UPPER(REPLICATE(' ', 9) + ' SE ABONARON  ' + CONVERT(varchar,@PuntosUtilizados) + ' ' + 
									  @MonedaMonedero + ' AL MONEDERO : '), '') +  @Monedero, '<BR>', @LargoLineaTicket)
				IF @EsImpresion = 0
				BEGIN
					SET @String = ''
					SET @String = @String + '  <tr>'
					SET @String = @String + '    <td colspan="6" style="text-align:center;">SE ABONARON: '+CONVERT(varchar,@PuntosUtilizados) + ' ' + @MonedaMonedero + ' AL MONEDERO : '+ @Monedero +'</td>'
					SET @String = @String + '  </tr>'
					SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
				END
			END
		END
     
		--Puntos Ahorrados
        SELECT @String = ISNULL(@LineaAhorro,'')+'<BR>'
        SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')        
     
        --Ahorro Final 
        IF @DescuentoLineaAcumulado > 0.0 OR EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID  AND NULLIF(@Monedero,'') IS NOT NULL AND  ISNULL(Aplicado,0)=1 HAVING SUM(Puntos) < 0.0 )
        BEGIN
			SELECT @Ahorro = @TotalDescuento
            
			IF @EsImpresion = 0
			BEGIN
				SET @String = ''
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <td colspan="6" style="text-align:center;">'+'********** USTED AHORRO   ' + dbo.fnFormatoMoneda(ISNULL(@Ahorro,0.0),@Empresa) + ' ' + @Moneda + ' **********' +'</td>'
				SET @String = @String + '  </tr>'
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
			END
			IF @EsImpresion = 1
			BEGIN
				SELECT @String = ' <BR> ' + dbo.fnCentrar('********** USTED AHORRO   ' +dbo.fnFormatoMoneda(ISNULL(@Ahorro,0.0),@Empresa) + ' ' + @Moneda + ' **********', @LargoLineaTicket) + ' <BR> '
				SELECT @Ticket = @Ticket + ISNULL(@String, '')
			END
		END

		IF (ISNULL(@Total,0.0) + ISNULL(@Redondeo, 0.0))<>0.0
		BEGIN
			IF @EsImpresion = 0
			BEGIN
				SET @String = ''
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <td colspan="6" style="text-align:center;">(SON ' + dbo.fnNumeroEnEspanol(ISNULL(@Total,0.0) + ISNULL(@Redondeo, 0.0),@Moneda) +') ' +'</td>'
				SET @String = @String + '  </tr>'
				SET @String = @String + '</table>'
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
			END
			IF @EsImpresion = 1
			BEGIN
				SELECT @String = ' <BR>' + dbo.fnCentrar('(SON ' + dbo.fnNumeroEnEspanol(ISNULL(@Total,0.0) + ISNULL(@Redondeo, 0.0),@Moneda) +') ', @LargoLineaTicket) + '<BR><BR>' + ISNULL(@Cadena,'')
				SELECT @Ticket = @Ticket + ISNULL(@String, '')        
			END  
		END
        
		IF (@MovClave = 'POS.F' OR (@MovClave  = 'POS.P' AND @MovSubClave = 'POS.FACCRED')) AND @OK IS NULL AND @EsImpresion=1
		BEGIN
			SELECT @String = dbo.fnCentrar('CERTIFICADO DIGITAL: ' + @noCertificadoSAT, @LargoLineaTicket-4) + '<BR>' + 
							 dbo.fnCentrar('  FOLIO FISCAL: ' + @UUID, @LargoLineaTicket-4) + '<BR>' + 
							 dbo.fnPOSTablaTicketCadena('SELLO DIGITAL DEL CFDI: ' + @Sello,@LargoLineaTicket) + 
							 dbo.fnPOSTablaTicketCadena('SELLO DIGITAL DEL SAT: ' + @SelloSAT,@LargoLineaTicket) + 
							 dbo.fnPOSTablaTicketCadena('CADENA ORIGINAL: ' + @CadenaOriginal,@LargoLineaTicket) + 
							 dbo.fnCentrar('FECHA DE CERTIFICACIÓN: ' + CONVERT(varchar,@FechaTimbrado), @LargoLineaTicket-4) + '<BR>' + 
							 dbo.fnCentrar('  CERTIFICADO DIGITAL SAT: ' + @noCertificado, @LargoLineaTicket-4) + 
							 '<BR>' + UPPER('Este documento es una representación impresa de un CFDI')
          
			SELECT @Ticket = @Ticket + ISNULL(@String, '') 
		END
	END
	END
    
	IF @MovClave IN('POS.INVD', 'POS.INVA') AND @Estatus NOT IN ('CONCLUIDO', 'TRASPASADO')
    BEGIN
		IF @EsImpresion = 0
		BEGIN      
			SELECT @Ticket = @Ticket + 
							 REPLICATE('-', @LargoLineaTicket+32) + '<BR>' + ' CANTIDAD    '  + '  PRODUCTO ' + '             DESCRIPCION       ' + '<BR>' +
							 REPLICATE('-', @LargoLineaTicket+32) + '<BR>' 
		END
		ELSE 	
		BEGIN
			SELECT @Ticket = @Ticket + '<BR>' + 
							 REPLICATE('-', @LargoLineaTicket) + '<BR>' +  ' CANTIDAD    '  + 'PRODUCTO ' + '       DESCRIPCION       ' + '<BR>' +
							 REPLICATE('-', @LargoLineaTicket) + '<BR>'        
		END	        
		        
		SET @String = ''		        
		IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID)
		BEGIN
			DECLARE crArticulos CURSOR LOCAL FOR
			  SELECT plv.Articulo,
					 plv.Renglon,
     				 plv.SubCuenta,
     				 plv.Cantidad,
     				 plv.Precio,
     				 plv.DescuentoLinea,
     				 plv.Impuesto1,
     				 plv.Impuesto2,
     				 plv.Impuesto3,
     				 plv.Unidad,
     				 ISNULL(plv.CantidadObsequio,0.0),
     				 plv.Puntos, 
     				 plv.PrecioSugerido ,
     				 plv.Aplicado,
     				 plv.PrecioImpuestoInc,
					 dbo.fnRellenarConCaracter(SUBSTRING(ISNULL(a.Descripcion1,''),1,20),20,'D',CHAR(32)) ,    	         
					 dbo.fnRellenarConCaracter(SUBSTRING(ISNULL(a.Descripcion1,''),1,50),50,'D',CHAR(32)) ,
					 plv.OfertaID,
					 ISNULL(plv.AplicaDescGlobal,1)    	         
     	         
     			FROM POSLVenta plv JOIN Art a ON plv.Articulo = a.Articulo
    		   WHERE plv.ID = @ID
     			 AND plv.Articulo <> ISNULL(@ArticuloRedondeo,'')
     			 AND plv.RenglonTipo <> 'K'
				OPEN crArticulos
			FETCH NEXT FROM crArticulos INTO @Articulo, @Renglon, @SubCuenta, @Cantidad, @Precio, @DescuentoLinea, @Impuesto1, @Impuesto2, 
											 @Impuesto3, @Unidad, @CantidadObsequio, @Puntos, @PrecioSugerido, @Aplicado, @PrecioImpuestoInc,
											 @Descripcion, @Descripcion2, @OfertaID, @AplicaDescGlobal
			WHILE @@FETCH_STATUS <> -1 
			BEGIN
				IF @@FETCH_STATUS <> -2 
				BEGIN        
					IF @EsImpresion = 0
					BEGIN  	
						-- Linea del Detalle 
						SELECT @String = ISNULL(@String,'') + dbo.fnRellenarConCaracter(CONVERT(varchar,@Cantidad),6,'i',CHAR(32)) + '         ' + 
										 dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,15),15,'D',' ') + '  ' + @Descripcion + '   ' + '<BR>' 

						SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')                        
					END
					ELSE
					BEGIN
					-- Linea del Detalle 
						SELECT @String = dbo.fnRellenarConCaracter(CONVERT(varchar,@Cantidad),6,'i',CHAR(32)) + '       ' + 
										 dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ') + ' ' + 
										 dbo.fnRellenarConCaracter('',6,'i',CHAR(32)) + '  ' + @Descripcion2+ '<BR>' 
					END  
				END
			FETCH NEXT FROM crArticulos INTO @Articulo, @Renglon, @SubCuenta, @Cantidad, @Precio, @DescuentoLinea, @Impuesto1, @Impuesto2, 
											 @Impuesto3, @Unidad, @CantidadObsequio, @Puntos, @PrecioSugerido, @Aplicado, @PrecioImpuestoInc,
											 @Descripcion, @Descripcion2, @OfertaID, @AplicaDescGlobal
			END
			CLOSE crArticulos
			DEALLOCATE crArticulos 
		END
    END  
    
	IF @MovClave IN('POS.INVD', 'POS.INVA') AND @Estatus IN ('CONCLUIDO', 'TRASPASADO')
    BEGIN
		IF @EsImpresion = 0
		BEGIN      
			SELECT @Ticket = @Ticket + 
							 REPLICATE('-', @LargoLineaTicket+32) + '<BR>' + ' CANTIDAD    '  + '  PRODUCTO ' + '             DESCRIPCION       ' + '<BR>' +
							 REPLICATE('-', @LargoLineaTicket+32) + '<BR>' 
		END
		ELSE 	
		BEGIN
			SELECT @Ticket = @Ticket + '<BR>' + 
							 REPLICATE('-', @LargoLineaTicket) + '<BR>' +  ' CANTIDAD    '  + 'PRODUCTO ' + '       DESCRIPCION       ' + '<BR>' +
							 REPLICATE('-', @LargoLineaTicket) + '<BR>'        
		END	        
		        
		SET @String = ''		        
		IF EXISTS(SELECT * FROM POSLInv WHERE ID = @ID)
		BEGIN
			DECLARE crArticulos CURSOR LOCAL FOR
			  SELECT plv.Articulo,
					 plv.Renglon,
     				 plv.SubCuenta,
     				 plv.Cantidad,
     				 plv.Precio,
     				 NULL,
     				 NULL,
     				 NULL,
     				 NULL,
     				 plv.Unidad,
     				 0.0,
     				 0, 
     				 0,
     				 NULL,
     				 NULL,
					 dbo.fnRellenarConCaracter(SUBSTRING(ISNULL(a.Descripcion1,''),1,20),20,'D',CHAR(32)) ,    	         
					 dbo.fnRellenarConCaracter(SUBSTRING(ISNULL(a.Descripcion1,''),1,50),50,'D',CHAR(32)) ,
					 NULL,
					 NULL
     	         
     			FROM POSLInv plv JOIN Art a ON plv.Articulo = a.Articulo
    		   WHERE plv.ID = @ID
     			 AND plv.Articulo <> ISNULL(@ArticuloRedondeo,'')
     			 AND plv.RenglonTipo <> 'K'
				OPEN crArticulos
			FETCH NEXT FROM crArticulos INTO @Articulo, @Renglon, @SubCuenta, @Cantidad, @Precio, @DescuentoLinea, @Impuesto1, @Impuesto2, 
											 @Impuesto3, @Unidad, @CantidadObsequio, @Puntos, @PrecioSugerido, @Aplicado, @PrecioImpuestoInc,
											 @Descripcion, @Descripcion2, @OfertaID, @AplicaDescGlobal
			WHILE @@FETCH_STATUS <> -1 
			BEGIN
				IF @@FETCH_STATUS <> -2 
				BEGIN        
					IF @EsImpresion = 0
					BEGIN  	
						-- Linea del Detalle 
						SELECT @String = ISNULL(@String,'') + dbo.fnRellenarConCaracter(CONVERT(varchar,@Cantidad),6,'i',CHAR(32)) + '         ' + 
										 dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,15),15,'D',' ') + '  ' + @Descripcion + '   ' + '<BR>' 

						SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')                        
					END
					ELSE
					BEGIN
					-- Linea del Detalle 
						SELECT @String = dbo.fnRellenarConCaracter(CONVERT(varchar,@Cantidad),6,'i',CHAR(32)) + '       ' + 
										 dbo.fnRellenarConCaracter(SUBSTRING(@Articulo,1,10),10,'D',' ') + ' ' + 
										 dbo.fnRellenarConCaracter('',6,'i',CHAR(32)) + '  ' + @Descripcion2+ '<BR>' 
					END  
     
					SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')                           
				END
			FETCH NEXT FROM crArticulos INTO @Articulo, @Renglon, @SubCuenta, @Cantidad, @Precio, @DescuentoLinea, @Impuesto1, @Impuesto2, 
											 @Impuesto3, @Unidad, @CantidadObsequio, @Puntos, @PrecioSugerido, @Aplicado, @PrecioImpuestoInc,
											 @Descripcion, @Descripcion2, @OfertaID, @AplicaDescGlobal
			END
			CLOSE crArticulos
			DEALLOCATE crArticulos 
		END
    END  
    
	--Aqui se inserta el titulo del detalle del ticket
	IF @MovClave IN ('POS.FA','POS.CXCD')
	BEGIN
		IF @EsImpresion = 1
		BEGIN
			IF NULLIF(@Concepto,'') IS NOT NULL 
				SELECT @Ticket =@Ticket+ '<BR>' + dbo.fnCentrar('CONCEPTO : '+@Concepto, @LargoLineaTicket-4) + '<BR>'
       
			SELECT @Ticket = @Ticket + '<BR>' + REPLICATE('-', @LargoLineaTicket + CASE WHEN @EsImpresion = 0 THEN 32 ELSE 0 END) + '<BR>' + 
							 dbo.fnCentrar(UPPER('FORMA PAGO'), @LargoLineaTicket /2) + dbo.fnCentrar(UPPER('IMPORTE'), @LargoLineaTicket /2) + 
							 dbo.fnCentrar(UPPER('IMPORTE  M/N'), @LargoLineaTicket /2) + '<BR>' +
							 REPLICATE('-', @LargoLineaTicket + CASE WHEN @EsImpresion=0 THEN 32 ELSE 0 END) + '<BR>' 
		END
		IF @EsImpresion = 0
		BEGIN
			
			IF NULLIF(@Concepto,'') IS NOT NULL
			BEGIN
				SET @String = ''
				SET @String = @String + '<table width="100%" style="border-spacing:0px; border-color:#A8A4A4;">'
				SET @String = @String + '  <tr style="background-color:#333; border-spacing:0px; border-color:#333;">'
				SET @String = @String + '    <th colspan="5" style="text-align:left; color:#f5f5f5; background:#777;"> CONCEPTO :  </th>'
				SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;">' + @Concepto + '</th>'
				SET @String = @String + '  </tr>'

				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			END
			
			IF @SubClave = 'POS.ANTREF'
			BEGIN
				SET @String = ''
				SET @String = @String + '<table width="100%" style="border-spacing:0px; border-color:#A8A4A4;">'
				SET @String = @String + '  <tr style="background-color:#333; border-spacing:0px; border-color:#333;">'			
				SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;"> FORMA PAGO </th>'
				SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;"> IMPORTE </th>'
				SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;"> IMPORTE  M/N </th>'
				SET @String = @String + '  </tr>'

				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			END
		END

		IF @SubClave = 'POS.ANTREF'
		BEGIN
		DECLARE crSaldos CURSOR LOCAL FOR
		 SELECT dbo.fnRellenarConCaracter(p.FormaPago,30,'d',CHAR(32)), SUM(p.Importe), SUM(p.ImporteRef), fp.Moneda
		   FROM POSLCobro p
		  INNER JOIN FormaPago fp ON p.FormaPago = fp.FormaPago
		  WHERE p.ID = @ID AND p.CtadineroDestino =@CtaDineroDestino
		  GROUP BY p.FormaPago,fp.Moneda  
      
		   OPEN crSaldos
		FETCH NEXT FROM crSaldos INTO @FormaPago, @ImporteCobrado, @ImporteRef, @POSMoneda
		WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @@FETCH_STATUS <> -2
			BEGIN
				IF @EsImpresion = 1
				SELECT @String = dbo.fnCentrar(REPLICATE(' ', 5) + UPPER(@FormaPago) + ': '+ '  $  ' + STUFF(dbo.fnFormatoMoneda( @ImporteRef,@Empresa),1,1,'') + 
								 CASE WHEN @ImporteRef IS NOT NULL THEN '  $ '+ STUFF(dbo.fnFormatoMoneda( @ImporteCobrado,@Empresa),1,1,'') + ' ' + @Moneda ELSE '' END, 
								 @LargoLineaTicket-4) + '<BR>'

			END

			EXEC spPOSTicketDenominacion @ID, @Empresa, @MovClave, @FormaPago, @Estacion, @LargoLineaTicket, @EsImpresion, @String2  OUTPUT
       
			SELECT @Ticket = @Ticket + @String+'<BR>'+ISNULL(@String2,'')  
        
		FETCH NEXT FROM crSaldos INTO @FormaPago, @ImporteCobrado, @ImporteRef, @POSMoneda
		END
		CLOSE crSaldos
		DEALLOCATE crSaldos
		END
		  
		SELECT @Ticket = ISNULL(@Ticket,'') + '<BR><BR>'
		SELECT @SubTotal = SUM(Importe) FROM POSL WHERE ID = @ID
		SELECT @TotalImpuesto1 = ISNULL(Impuestos,0) FROM POSL WHERE ID = @ID
		SELECT @TotalCxc = ISNULL(@SubTotal,0.0) + ISNULL(@TotalImpuesto1,0.0)

		IF @EsImpresion = 1
		BEGIN
			-- SubTotal
			SELECT @String = dbo.fnAlinearCampoValor2(ISNULL(UPPER(REPLICATE(' ', @LargoLineaTicket - 30)+' SUBTOTAL: '), '') + 
							 dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(@SubTotal,0.0),@Empresa), 13), '<BR>', @LargoLineaTicket)
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
		   
			-- IVA
			SELECT @String = dbo.fnAlinearCampoValor2(ISNULL(UPPER(REPLICATE(' ', @LargoLineaTicket - 30)+'IMPUESTOS: '), '') + 
							 dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(@TotalImpuesto1,0.0),@Empresa),13), '<BR>', @LargoLineaTicket)
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')            
		
			--Total
			SELECT @String = dbo.fnAlinearCampoValor2(ISNULL(UPPER(REPLICATE(' ', @LargoLineaTicket - 30)+'    TOTAL: '), '') + 
							 dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(@TotalCxc,0.0) + ISNULL(@Redondeo, 0.0),@Empresa),13), '<BR>', @LargoLineaTicket) + '<BR><BR>'
			   
			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
		END 
		         	        
		IF @EsImpresion = 0
		BEGIN
				SET @String = ''
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <td colspan="5" style="text-align:right;">SUBTOTAL</td>'
				SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda(@SubTotal,@Empresa)+'</td>'
				SET @String = @String + '  </tr>'
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 



				SET @String = ''
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <td colspan="5" style="text-align:right;">IMPUESTOS</td>'
				SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda(@TotalImpuesto1,@Empresa)+'</td>'
				SET @String = @String + '  </tr>'
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 

				SET @String = ''
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <td colspan="5" style="text-align:right;">TOTAL</td>'
				SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda(@TotalCxc,@Empresa)+'</td>'
				SET @String = @String + '  </tr>'
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
		END
	END     

	-- Se separo el ticket para los cobros de Facturas Anticpo JLMR Marzo 2014   
	IF @MovClave IN ('POS.CXCC')
	BEGIN
		IF @EsImpresion = 1
		BEGIN
			IF NULLIF(@Concepto,'') IS NOT NULL 
				SELECT @Ticket =@Ticket+ '<BR>' + dbo.fnCentrar('CONCEPTO : ' + @Concepto, @LargoLineaTicket-4) + '<BR>'
		   
			SELECT @Ticket = @Ticket + '<BR>' + REPLICATE('-', @LargoLineaTicket + CASE WHEN @EsImpresion = 0 THEN 32 ELSE 0 END) + '<BR>' + 
							 dbo.fnCentrar(UPPER('APLICA'), @LargoLineaTicket /3)+ dbo.fnCentrar(UPPER('MOVIMIENTO'), @LargoLineaTicket /2) + 
							 dbo.fnCentrar(UPPER('IMPORTE'), @LargoLineaTicket/2)+ '<BR>' + REPLICATE('-', @LargoLineaTicket + CASE WHEN @EsImpresion = 0 THEN 32 ELSE 0 END) + '<BR>'     
      
			SELECT @Ticket = ISNULL(@Ticket,'') + '<BR><BR>'
		END
		IF @EsImpresion = 0
		BEGIN
			SET @String = ''
			SET @String = @String + '<table width="100%" style="border-spacing:0px; border-color:#A8A4A4;">'
			SET @String = @String + '  <tr style="background-color:#333; border-spacing:0px; border-color:#333;">'
			SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;"> APLICA </th>'
			SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;"> MOVIMIENTO </th>'
			SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;">IMPORTE</th>'
			SET @String = @String + '  </tr>'
                  
			SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
		END


		SELECT @SubTotal = SUM(Importe) FROM POSL WHERE ID = @ID
		SELECT @TotalImpuesto1 = Impuestos FROM POSL WHERE ID = @ID
		SELECT @TotalCxc = ISNULL(@SubTotal,0.0) + ISNULL(@TotalImpuesto1,0.0)
      	   
		DECLARE crDoc CURSOR LOCAL FOR
		 SELECT Aplica, AplicaID, Articulo, ROUND(Precio,4)
		   FROM POSLVenta p
		  WHERE p.ID = @ID   
		   OPEN crDoc
		FETCH NEXT FROM crDoc INTO @Aplica, @AplicaID, @Articulo, @Precio
		WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @@FETCH_STATUS <> -2
			BEGIN
				IF @EsImpresion = 1
					SELECT @String = dbo.fnAlinearIzquierda(REPLICATE(' ', 2) + @Articulo , @LargoLineaTicket/3) + dbo.fnAlinearIzquierda(UPPER(@Aplica) + ' ' + @AplicaID, @LargoLineaTicket/3) + 
									 dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(@Precio,0.0) + ISNULL(@Redondeo, 0.0),@Empresa), @LargoLineaTicket / 4) + '<BR>'

				IF @EsImpresion = 0
				BEGIN

					SET @String = ''
					SET @String = @String + '  <tr>'
					SET @String = @String + '    <td> '+@Articulo+' </td>'
					SET @String = @String + '    <td> '+UPPER(@Aplica) + ' ' + @AplicaID+' </td>'
					SET @String = @String + '    <td style="text-align:right;"> '+dbo.fnFormatoMoneda(ISNULL(@Precio,0.0) + ISNULL(@Redondeo, 0.0),@Empresa)+' </td>'
					SET @String = @String + '  </tr>'

					SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 

				END
			END       
			IF @EsImpresion = 1
				SELECT @Ticket = @Ticket + @String+'<BR>'+ISNULL(@String2,'')  
        
		FETCH NEXT FROM crDoc INTO @Aplica, @AplicaID, @Articulo, @Precio
		END
		CLOSE crDoc
		DEALLOCATE crDoc
	   
		--SubTotal
		SELECT @SubTotal = ISNULL(SUM(ISNULL(((Cantidad - ISNULL(CantidadObsequio,0)) * (Precio - (Precio * (ISNULL(DescuentoLinea,0)/100)))),0)),0.0)
		  FROM POSLVenta
         WHERE ID = @ID  
		   AND Articulo <> ISNULL(@ArticuloRedondeo,'')	 
      
		--DescuentoGlobal
		SELECT @TotalDescuento = SUM(ISNULL(((Cantidad - ISNULL(CantidadObsequio,0)) * (Precio - (Precio * (ISNULL(DescuentoLinea,0)/100)))),0) * 
								(CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END) /100)
		  FROM POSLVenta plv JOIN POSL p ON p.ID = plv.ID
		 WHERE p.ID = @ID  
      
		--Impuestos
		SELECT @TotalImpuesto1 = SUM(dbo.fnPOSImporteMov(( ISNULL(((plv.Cantidad - ISNULL(plv.CantidadObsequio,0)) * ((plv.Precio - (plv.Precio * (ISNULL(plv.DescuentoLinea,0)/100))) - ((plv.Precio - (plv.Precio * (ISNULL(plv.DescuentoLinea,0)/100))) * 
								(CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),0)),plv.Impuesto1,plv.Impuesto2, plv.Impuesto3 ,plv.Cantidad) - (ISNULL(((plv.Cantidad - ISNULL(plv.CantidadObsequio,0)) * 
								((plv.Precio - (plv.Precio * (ISNULL(plv.DescuentoLinea,0)/100))) - ((plv.Precio - (plv.Precio * (ISNULL(plv.DescuentoLinea,0)/100))) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),0)))
		  FROM POSLVenta plv JOIN POSL p ON p.ID = plv.ID
		 WHERE p.ID = @ID  
				
		SELECT @Total = ISNULL(@SubTotal,0) - ISNULL(@TotalDescuento,0) + ISNULL(@TotalImpuesto1,0)
     
		SELECT @Totales = dbo.fnAlinearCampoValor2('SUBTOTAL', dbo.fnFormatoMoneda(@SubTotal,@Empresa), @LargoLineaTotales/2) + '<BR>' + 
						  dbo.fnAlinearCampoValor2('DESCUENTO', dbo.fnFormatoMoneda(@TotalDescuento,@Empresa), @LargoLineaTotales/2) + '<BR>' + 
						  dbo.fnAlinearCampoValor2('IMPUESTOS',dbo.fnFormatoMoneda(@TotalImpuesto1,@Empresa), @LargoLineaTotales/2) + '<BR>' +
						  dbo.fnAlinearCampoValor2('TOTAL', dbo.fnFormatoMoneda(@Total,@Empresa), @LargoLineaTotales/2) + '<BR>'      	      
	END
 
	--Aqui se concatenan los saldos con sus formas de pago ya liquidadas
	IF @MovClave IN ('POS.AC','POS.AP','POS.CC','POS.CPC','POS.CAC','POS.CCC', 'POS.IC','POS.EC') 
	BEGIN
	
		IF @EsImpresion = 0
		BEGIN
			SET @String = ''
			SET @String = @String + '<table width="100%" style="border-spacing:0px; border-color:#A8A4A4;">'
			SET @String = @String + '  <tr style="background-color:#333; border-spacing:0px; border-color:#333;">'
			SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;">FORMA PAGO </th>'
			SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;">IMPORTE</th>'
			SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;">IMPORTE</th>'
			SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;">MONEDA</th>'
			SET @String = @String + '  </tr>'
		
			SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
		
		END

		IF @EsImpresion = 1
			SELECT @Ticket = @Ticket + '<BR>'
			
		DECLARE crSaldos CURSOR LOCAL FOR
		 SELECT dbo.fnRellenarConCaracter(p.FormaPago,30,'d',CHAR(32)),
				SUM(p.Importe),
				SUM(p.ImporteRef),
				fp.Moneda
		   FROM POSLCobro p
		  INNER JOIN FormaPago fp ON p.FormaPago = fp.FormaPago
		  WHERE ID = @ID
		  GROUP BY p.FormaPago,fp.Moneda
		   OPEN crSaldos
		FETCH NEXT FROM crSaldos INTO @FormaPago, @ImporteCobrado, @ImporteRef, @POSMoneda
		WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @@FETCH_STATUS <> -2
			BEGIN
				IF @EsImpresion = 1
				BEGIN
					SELECT @String = dbo.fnCentrar(REPLICATE(' ', 5) + UPPER(@FormaPago) + ': '+ '  $  ' + STUFF(dbo.fnFormatoMoneda( @ImporteCobrado,@Empresa),1,1,'') + 
									 CASE WHEN @ImporteRef IS NOT NULL THEN '  $ ' + STUFF(dbo.fnFormatoMoneda( @ImporteRef,@Empresa),1,1,'') + ' ' + @POSMoneda 
									 ELSE '' END  , @LargoLineaTicket-4) + '<BR>'

      				SELECT @Saldos = ISNULL(@Saldos,'') + ISNULL(@String,'')        
      				SELECT @ImporteRef = NULL
					SELECT @Ticket = @Ticket + @String
				END
				IF @EsImpresion = 0
				BEGIN

					SET @String = ''
					SET @String = @String + '  <tr>'
					SET @String = @String + '    <td>'+UPPER(@FormaPago)+'</td>'
					SET @String = @String + '    <td> '+dbo.fnFormatoMoneda( @ImporteCobrado,@Empresa)+'</td>'
					SET @String = @String + '    <td> '+dbo.fnFormatoMoneda( @ImporteRef,@Empresa)+'</td>'
					SET @String = @String + '    <td style="text-align:right;"> '+@POSMoneda+'</td>'
					SET @String = @String + '  </tr>'
					
					SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 

				END
			END
			
			IF @EsImpresion = 1
				EXEC spPOSTicketDenominacion @ID, @Empresa, @MovClave, @FormaPago, @Estacion, @LargoLineaTicket, @EsImpresion, @String2  OUTPUT
       
			SELECT @Ticket = @Ticket + '<BR>' + ISNULL(@String2,'')
			FETCH NEXT FROM crSaldos INTO @FormaPago, @ImporteCobrado, @ImporteRef, @POSMoneda
			END
			CLOSE crSaldos
			DEALLOCATE crSaldos

			SELECT @String = '<BR>' + dbo.fnAlinearCampoValor2(ISNULL(UPPER(REPLICATE(' ', @LargoLineaTicket - 30) + '    SALDO: '), '') +  
							 dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(@Saldo,0.0),@Empresa),13), '<BR>', @LargoLineaTicket)
	END
 
	IF @MovClave IN('POS.ACM','POS.CCCM','POS.TCM','POS.TRM')
	BEGIN

		IF @EsImpresion = 0
		BEGIN
			SET @String = ''
			SET @String = @String + '<table width="100%" style="border-spacing:0px; border-color:#A8A4A4;">'
			SET @String = @String + '  <tr style="background-color:#333; border-spacing:0px; border-color:#333;">'
			SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;">FORMA PAGO </th>'
			SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;">IMPORTE</th>'
			SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;">IMPORTE</th>'
			SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;">MONEDA</th>'
			SET @String = @String + '  </tr>'
		
			SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
		
		END

		IF @EsImpresion = 1
			SELECT @Ticket = @Ticket + '<BR>'

		DECLARE crCta CURSOR LOCAL FOR
		 SELECT p.CtaDinero
		   FROM POSLCobro p
		  WHERE ID = @ID
		  GROUP BY p.CtaDinero
		   OPEN crCta
		FETCH NEXT FROM crCta INTO @CtaDinero
		WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @EsImpresion = 1
			BEGIN
				SELECT @Ticket = @Ticket + '<BR>' + REPLICATE('-', @LargoLineaTicket+ CASE WHEN @EsImpresion=0 THEN 32 ELSE 0 END) + 
								 '<BR>' + dbo.fnCentrar(UPPER('Cuenta'), @LargoLineaTicket /2) + dbo.fnCentrar(UPPER('Cuenta Destino'), @LargoLineaTicket /2) + 
								 '<BR>' +REPLICATE('-', @LargoLineaTicket+32) + '<BR>' 
				SELECT @Ticket =@Ticket + dbo.fnCentrar(ISNULL(@CtaDinero,''), @LargoLineaTicket/2) + dbo.fnCentrar(ISNULL(@CtaDineroDestino,''), @LargoLineaTicket/2) + '<BR>'

				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 

			END
			
			IF @EsImpresion = 0
			BEGIN
				SET @String = ''
				SET @String = @String + '<table width="100%" style="border-spacing:0px; border-color:#A8A4A4;">'
				SET @String = @String + '  <tr style="background-color:#333; border-spacing:0px; border-color:#333;">'
				SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;"> CUENTA </th>'
				SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;"> CUENTA DESTINO </th>'
				SET @String = @String + '  </tr>'

				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
			END

			
      
			DECLARE crSaldos CURSOR LOCAL FOR
			 SELECT dbo.fnRellenarConCaracter(p.FormaPago,30,'d',CHAR(32)), p.Importe, p.ImporteRef, fp.Moneda
			   FROM POSLCobro p
			  INNER JOIN FormaPago fp ON p.FormaPago = fp.FormaPago
			  WHERE p.ID = @ID AND p.Ctadinero =@CtaDinero
			   OPEN crSaldos
			FETCH NEXT FROM crSaldos INTO @FormaPago, @ImporteCobrado, @ImporteRef, @POSMoneda
			WHILE @@FETCH_STATUS <> -1
			BEGIN
				IF @@FETCH_STATUS <> -2
				BEGIN
					IF @EsImpresion = 1
					BEGIN
						SELECT @Saldos = ISNULL(@Saldos,'') + ISNULL(@String,'')
						SELECT @String =dbo.fnCentrar(REPLICATE(' ', 5) + UPPER(@FormaPago) + ': '+ '  $  ' + STUFF(dbo.fnFormatoMoneda( @ImporteCobrado,@Empresa),1,1,'') + 
										CASE WHEN @ImporteRef IS NOT NULL THEN '  $ ' + STUFF(dbo.fnFormatoMoneda( @ImporteRef,@Empresa),1,1,'') + ' ' + @POSMoneda ELSE '' END, @LargoLineaTicket-4) + '<BR>'
					END

					IF @EsImpresion = 0
					BEGIN
						SET @String = ''
						SET @String = @String + '  <tr>'
						SET @String = @String + '    <td> '+UPPER(@CtaDinero)+' </td>'
						SET @String = @String + '    <td style="text-align:right;"> '+@CtaDineroDestino+' </td>'
						SET @String = @String + '  </tr>'


						--SET @String = ''
						SET @String = @String + '  <tr>'
						SET @String = @String + '    <td>'+UPPER(@FormaPago)+'</td>'
						SET @String = @String + '    <td> '+dbo.fnFormatoMoneda( @ImporteCobrado,@Empresa)+'</td>'
						SET @String = @String + '    <td> '+dbo.fnFormatoMoneda( @ImporteRef,@Empresa)+'</td>'
						SET @String = @String + '    <td style="text-align:right;"> '+@POSMoneda+'</td>'
						SET @String = @String + '  </tr>'
					
						SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
					END

					SELECT @ImporteRef = NULL
				END
				IF @EsImpresion = 1
				BEGIN
					EXEC spPOSTicketDenominacion @ID, @Empresa, @MovClave, @FormaPago, @Estacion, @LargoLineaTicket, @EsImpresion, @String2  OUTPUT

					SELECT @Ticket = @Ticket + @String + '<BR>' + ISNULL(@String2,'')
				END
        
			FETCH NEXT FROM crSaldos INTO @FormaPago, @ImporteCobrado, @ImporteRef, @POSMoneda
			END
			CLOSE crSaldos
			DEALLOCATE crSaldos

		FETCH NEXT FROM crCta INTO @CtaDinero
		END
		CLOSE crCta
		DEALLOCATE crCta
	END

	IF @MovClave IN('POS.CCM','POS.CPCM','POS.CACM','POS.CTCM','POS.CTRM')
	BEGIN
		DECLARE crCta CURSOR LOCAL FOR
		 SELECT p.CtaDineroDestino
		   FROM POSLCobro p
		  WHERE ID = @ID
		  GROUP BY p.CtaDineroDestino
		   OPEN crCta
		FETCH NEXT FROM crCta INTO @CtaDineroDestino
		WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @EsImpresion = 1
			BEGIN
				SELECT @Ticket = @Ticket + '<BR>' + REPLICATE('-', @LargoLineaTicket + CASE WHEN @EsImpresion = 0 THEN 32 ELSE 0 END) + '<BR>' + 
								 dbo.fnCentrar(UPPER('Cuenta'), @LargoLineaTicket /2) + dbo.fnCentrar(UPPER('Cuenta Destino'), @LargoLineaTicket /2) + '<BR>' + 
								 REPLICATE('-', @LargoLineaTicket + CASE WHEN @EsImpresion = 0 THEN 32 ELSE 0 END) + '<BR>' 
        
				SELECT @Ticket =@Ticket + dbo.fnCentrar(ISNULL(@CtaDinero,''), @LargoLineaTicket/2) + dbo.fnCentrar(ISNULL(@CtaDineroDestino,''), @LargoLineaTicket/2) + '<BR>'
			END

			IF @EsImpresion = 0
			BEGIN
				SET @String = ''
				SET @String = @String + '<table width="100%" style="border-spacing:0px; border-color:#A8A4A4;">'
				SET @String = @String + '  <tr style="background-color:#333; border-spacing:0px; border-color:#333;">'
				SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;"> CUENTA </th>'
				SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;"> CUENTA DESTINO </th>'
				SET @String = @String + '  </tr>'

				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
			END
			
			
			        
			DECLARE crSaldos CURSOR LOCAL FOR
			 SELECT dbo.fnRellenarConCaracter(p.FormaPago,30,'d',CHAR(32)), SUM(p.Importe), SUM(p.ImporteRef), fp.Moneda
			   FROM POSLCobro p
			  INNER JOIN FormaPago fp ON p.FormaPago = fp.FormaPago
			  WHERE p.ID = @ID AND p.CtadineroDestino =@CtaDineroDestino
			  GROUP BY p.FormaPago,fp.Moneda  
			   OPEN crSaldos
			FETCH NEXT FROM crSaldos INTO @FormaPago, @ImporteCobrado, @ImporteRef, @POSMoneda
			WHILE @@FETCH_STATUS <> -1
			BEGIN
				IF @@FETCH_STATUS <> -2
				BEGIN

					IF @EsImpresion = 1
					BEGIN
						SELECT @String = dbo.fnCentrar(REPLICATE(' ', 5) + UPPER(@FormaPago) + ': '+ '  $  ' + STUFF(dbo.fnFormatoMoneda( @ImporteRef,@Empresa),1,1,'') + 
										 CASE WHEN @ImporteRef IS NOT NULL THEN '  $ '+ STUFF(dbo.fnFormatoMoneda( @ImporteCobrado,@Empresa),1,1,'') + ' ' + @Moneda ELSE '' END, 
										 @LargoLineaTicket-4) + '<BR>'
					END

					IF @EsImpresion = 0
					BEGIN
						SET @String = ''
						SET @String = @String + '  <tr>'
						SET @String = @String + '    <td> '+UPPER(@CtaDinero)+' </td>'
						SET @String = @String + '    <td style="text-align:right;"> '+@CtaDineroDestino+' </td>'
						SET @String = @String + '  </tr>'

						--SET @String = ''
						SET @String = @String + '  <tr>'
						SET @String = @String + '    <td>'+UPPER(@FormaPago)+'</td>'
						SET @String = @String + '    <td> '+dbo.fnFormatoMoneda( @ImporteCobrado,@Empresa)+'</td>'
						SET @String = @String + '    <td> '+dbo.fnFormatoMoneda( @ImporteRef,@Empresa)+'</td>'
						SET @String = @String + '    <td style="text-align:right;"> '+@POSMoneda+'</td>'
						SET @String = @String + '  </tr>'
					
						SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
					END

					SELECT @ImporteRef = NULL

				END
				IF @EsImpresion = 1
				BEGIN       
					EXEC spPOSTicketDenominacion @ID, @Empresa, @MovClave, @FormaPago, @Estacion, @LargoLineaTicket, @EsImpresion, @String2  OUTPUT
       
					SELECT @Ticket = @Ticket + @String + '<BR>' + ISNULL(@String2,'')
				END
        
			FETCH NEXT FROM crSaldos INTO @FormaPago, @ImporteCobrado, @ImporteRef, @POSMoneda
			END
			CLOSE crSaldos
			DEALLOCATE crSaldos

		FETCH NEXT FROM crCta INTO @CtaDineroDestino
		END
		CLOSE crCta
		DEALLOCATE crCta
	END

	IF @MovClave IN ('POS.N', 'POS.A', 'POS.F','POS.P','POS.NPC','POS.FA')
		SELECT @Saldos = ISNULL(@Saldos,'') + ISNULL(@String,'')    

END

  --Aqui mostrará la amortización sugerida de los pagos
IF EXISTS(SELECT * FROM POSLAmortizacionPagos pap WHERE pap.ID = @ID)
BEGIN
	SELECT @String = '<BR>' + dbo.fnCentrar(UPPER('FECHA AMORT.') + REPLICATE(' ', 4) + 'MONTO' + REPLICATE(' ', 4) + 'INTERES' + REPLICATE(' ', 4) + 'MONTO TOTAL' , @LargoLineaTicket) +  '<BR>'
    
	DECLARE crPOSLAmortizacionPagos CURSOR LOCAL FOR
     SELECT pap.Fecha, pap.Importe, pap.Interes
	   FROM POSLAmortizacionPagos pap
	  WHERE pap.ID = @ID
      
	   OPEN crPOSLAmortizacionPagos
	FETCH NEXT FROM crPOSLAmortizacionPagos INTO @FechaAmortizacion, @ImporteAmortizacion, @InteresAmortizacion
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			SELECT @InteresAmortizacion = @ImporteAmortizacion * (ISNULL(@InteresAmortizacion,0)/100)
			SELECT @TotalAmortizacion = @ImporteAmortizacion + ISNULL(@InteresAmortizacion,0)
        
			SELECT @String = @String + dbo.fnCentrar(CONVERT(varchar, @FechaAmortizacion, 103) + '    ' + dbo.fnFormatoMoneda(@ImporteAmortizacion,@Empresa) + '    ' + 
							 dbo.fnFormatoMoneda(@InteresAmortizacion,@Empresa) + '    ' + dbo.fnFormatoMoneda(@TotalAmortizacion,@Empresa) + '<BR>', @LargoLineaTicket)
		END
	FETCH NEXT FROM crPOSLAmortizacionPagos INTO @FechaAmortizacion, @ImporteAmortizacion, @InteresAmortizacion
	END
	CLOSE crPOSLAmortizacionPagos
	DEALLOCATE crPOSLAmortizacionPagos
    
	SELECT @Ticket = ISNULL(@Ticket,'') + '<BR>'+ ISNULL(@String,'')
END
    
IF @CodigoAccion = 'MODIFICAR CONDICION'
BEGIN
	SELECT @Ticket = '<BR>' + dbo.fnCentrar('CONDICION', @LargoLineaTicket) + '<BR>'
	SELECT @Ticket = @Ticket + REPLICATE('-', @LargoLineaTicket) + '<BR>'
  
	DECLARE crCondicion CURSOR LOCAL FOR
	 SELECT DISTINCT Condicion, ControlAnticipos
	   FROM Condicion 
	   OPEN crCondicion  
	FETCH NEXT FROM crCondicion INTO @Condicion, @ControlAnticipos
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			SELECT @Ticket = @Ticket + dbo.fnCentrar(@Condicion, @LargoLineaTicket) + CASE WHEN @ControlAnticipos = 'Cobrar Pedido' THEN ' ** <BR>' ELSE '<BR>' END
		END
	FETCH NEXT FROM crCondicion INTO @Condicion, @ControlAnticipos
	END  
	CLOSE crCondicion
	DEALLOCATE crCondicion
END

IF @CodigoAccion = 'MODIFICAR ALM SUC'
BEGIN
	SELECT @Ticket = '<BR>' + dbo.fnCentrar('ALMACEN', @LargoLineaTicket) + '<BR>'
	SELECT @Ticket = @Ticket + REPLICATE('-', @LargoLineaTicket) + '<BR>'
  
	DECLARE crAlm CURSOR LOCAL FOR
	 SELECT dbo.fnRellenarConCaracter(CONVERT(varchar,Rtrim(Almacen)),10,'i',CHAR(32)) , SUBSTRING(Nombre,1,30)
	   FROM Alm 
	  WHERE Sucursal = @Sucursal
	   OPEN crAlm
	FETCH NEXT FROM crAlm INTO @AlmacenV, @AlmacenVNombre
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			SELECT @Ticket = @Ticket + @AlmacenV +'  '+@AlmacenVNombre+ '<BR>'
		END			
	FETCH NEXT FROM crAlm INTO @AlmacenV, @AlmacenVNombre
	END  
	CLOSE crAlm
	DEALLOCATE crAlm
END

IF @CodigoAccion = 'MODIFICAR ALM FOR'
BEGIN
	SELECT @Ticket = '<BR>' + dbo.fnCentrar('ALMACEN', @LargoLineaTicket) + '<BR>'
	SELECT @Ticket = @Ticket + REPLICATE('-', @LargoLineaTicket) + '<BR>'
  
	DECLARE crAlm CURSOR LOCAL FOR
	 SELECT dbo.fnRellenarConCaracter(CONVERT(varchar,Rtrim(Almacen)),10,'i',CHAR(32)) , SUBSTRING(Nombre,1,30)
	   FROM Alm 
	  WHERE Sucursal <> @Sucursal
	   OPEN crAlm
	FETCH NEXT FROM crAlm INTO @AlmacenV, @AlmacenVNombre
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			SELECT @Ticket = @Ticket + @AlmacenV +'  '+@AlmacenVNombre+ '<BR>'
		END
	FETCH NEXT FROM crAlm INTO @AlmacenV, @AlmacenVNombre
	END  
	CLOSE crAlm
	DEALLOCATE crAlm
END

IF @CodigoAccion IN('FORMA ENVIO')
BEGIN
	
	 IF @MovClave IN ('POS.P', 'POS.N')
	BEGIN
   
		DELETE POSFormaEnvioTemp WHERE Estacion = @Estacion
      
		INSERT POSFormaEnvioTemp(Estacion, FormaEnvio)
		SELECT					@Estacion, FormaEnvio
		FROM FormaEnvio
     
		SELECT @Orden = 0
		UPDATE POSFormaEnvioTemp
			SET @Orden = Orden = @Orden + 1
		FROM POSFormaEnvioTemp
		WHERE  Estacion = @Estacion          
	END

	IF @EsImpresion = 0
	BEGIN
		SET @Ticket = ''
		SET @String = ''
		SET @String = @String + '<table width="100%" style="border-spacing:0px; border-color:#A8A4A4;">'
		SET @String = @String + '  <tr style="background-color:#333; border-spacing:0px; border-color:#333;">'
		SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;"> NUMERO </th>'
		SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;"> FORMA ENVIO </th>'
		SET @String = @String + '  </tr>'

		SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
	END
	
	IF @EsImpresion = 1
	BEGIN
		SELECT @Ticket = '<BR>' + 'NUMERO' + dbo.fnCentrar('FORMA ENVIO', @LargoLineaTicket) + '<BR>'
		SELECT @Ticket = @Ticket + REPLICATE('-', @LargoLineaTicket) + REPLICATE('-', @LargoLineaTicket) + '<BR>'
	END
		
	DECLARE crCondicion CURSOR LOCAL FOR
	 SELECT Orden, FormaEnvio 
	   FROM POSFormaEnvioTemp 
	  WHERE Estacion = @Estacion
	   OPEN crCondicion  
	FETCH NEXT FROM crCondicion INTO @Numero , @FormaEnvio
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			IF @EsImpresion = 1
				SELECT @Ticket = @Ticket + CONVERT(varchar,@Numero) + '  ' + @FormaEnvio + '<BR>'
			
			IF @EsImpresion = 0
			BEGIN
				SET @String = ''
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <td> '+CONVERT(varchar,@Numero)+'  </td>'
				SET @String = @String + '    <td style="text-align:right;"> '+@FormaEnvio+'  </td>'
				SET @String = @String + '  </tr>'
					
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 				
			END
		END
	FETCH NEXT FROM crCondicion INTO @Numero , @FormaEnvio
	END  
	CLOSE crCondicion
	DEALLOCATE crCondicion
END

IF @CodigoAccion = 'INTRODUCIR CONCEPTOCXC'
BEGIN
	IF @EsImpresion = 0
	BEGIN
		SET @Ticket = ''
		SET @String = ''
		SET @String = @String + '<table width="100%" style="border-spacing:0px; border-color:#A8A4A4;">'
		SET @String = @String + '  <tr style="background-color:#333; border-spacing:0px; border-color:#333;">'
		SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;"> NUMERO </th>'
		SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;"> CONCEPTO </th>'
		SET @String = @String + '  </tr>'

	SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
	END

	IF @EsImpresion = 1
	BEGIN
		SELECT @Ticket = '<BR>' + 'NUMERO' + dbo.fnCentrar('CONCEPTO', @LargoLineaTicket) + '<BR>'
		SELECT @Ticket = @Ticket + REPLICATE('-', @LargoLineaTicket) + REPLICATE('-', @LargoLineaTicket) + '<BR>'
	END

	DECLARE crCondicion CURSOR LOCAL FOR
	 SELECT Orden,Concepto
	   FROM POSConceptoCXCTemp
	  WHERE Estacion = @Estacion
	   OPEN crCondicion  
	FETCH NEXT FROM crCondicion INTO @Numero , @Conceptocxc
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			IF @EsImpresion = 1
				SELECT @Ticket = @Ticket + CONVERT(varchar,@Numero)+ dbo.fnCentrar(@Conceptocxc, @LargoLineaTicket-4) + '<BR>'


			IF @EsImpresion = 0
			BEGIN
				SET @String = ''
				SET @String = @String + '  <tr>'
				SET @String = @String + '    <td> '+CONVERT(varchar,@Numero)+'  </td>'
				SET @String = @String + '    <td style="text-align:right;"> '+@Conceptocxc+'  </td>'
				SET @String = @String + '  </tr>'
					
				SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 				
			END
		END
	FETCH NEXT FROM crCondicion INTO @Numero , @Conceptocxc
	END  
	CLOSE crCondicion
	DEALLOCATE crCondicion
END

IF @CodigoAccion = 'INTRODUCIR CONCEPTODIN'
BEGIN
	DELETE POSConceptoDINTemp WHERE Estacion = @Estacion
      
	INSERT INTO POSConceptoDINTemp (Estacion, Concepto)
	SELECT							@Estacion, Concepto
	  FROM Concepto
	 WHERE Modulo = 'DIN'
       
	SELECT @Orden = 0

	UPDATE POSConceptoDINTemp SET @Orden = Orden = @Orden + 1
	  FROM POSConceptoDINTemp
	 WHERE Estacion = @Estacion    
  
	SELECT @Ticket = '<BR>' + 'NUMERO' + dbo.fnCentrar('CONCEPTO', @LargoLineaTicket) + '<BR>'
	SELECT @Ticket = @Ticket + REPLICATE('-', @LargoLineaTicket)  +REPLICATE('-', @LargoLineaTicket) + '<BR>'
  
	DECLARE crCondicion CURSOR LOCAL FOR
	 SELECT Orden, Concepto
	   FROM POSConceptoDINTemp
	  WHERE Estacion = @Estacion
	   OPEN crCondicion  
	FETCH NEXT FROM crCondicion INTO @Numero , @ConceptoDIN
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			SELECT @Ticket = @Ticket + CONVERT(varchar,@Numero) + ' ' + @ConceptoDIN + '<BR>'
		END
	FETCH NEXT FROM crCondicion INTO @Numero , @ConceptoDIN
	END  
	CLOSE crCondicion
	DEALLOCATE crCondicion
END

IF @CodigoAccion IN('ALMACEN DESTINO')
BEGIN
	SELECT @Ticket = '<BR>' + 'NUMERO' + dbo.fnCentrar('ALMACEN', @LargoLineaTicket) + '<BR>'
	SELECT @Ticket = @Ticket + REPLICATE('-', @LargoLineaTicket) + REPLICATE('-', @LargoLineaTicket) + '<BR>'
  
	DECLARE crCondicion CURSOR LOCAL FOR
	 SELECT dbo.fnRellenarConCaracter(CONVERT(varchar,p.Orden),4,'i',CHAR(32)), 
		    dbo.fnRellenarConCaracter(CONVERT(varchar,p.Almacen),10,'i',CHAR(32)) , SUBSTRING(a.Nombre,1,30)
	   FROM POSAlmTemp p JOIN Alm a ON p.Almacen = a.Almacen
	  WHERE p.Estacion = @Estacion
	   OPEN crCondicion  
	FETCH NEXT FROM crCondicion INTO @Numero , @AlmacenD, @AlmacenDNombre
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			SELECT @Ticket = @Ticket + CONVERT(varchar,@Numero) + '  ' + @AlmacenD + '  ' + @AlmacenDNombre + '<BR>'
		END
	FETCH NEXT FROM crCondicion INTO @Numero , @AlmacenD,  @AlmacenDNombre
	END  
	CLOSE crCondicion
	DEALLOCATE crCondicion
END  
  
IF @Accion = 'VER CORTE CAJA'
BEGIN

	SELECT TOP 1 @Moneda = Moneda 
	  FROM POSLTipoCambioRef 
	 WHERE TipoCambio = 1	  
	   AND Sucursal = @Sucursal  
	   AND EsPrincipal = 1

	SELECT @DirectorioEstilo = Directorio
	  FROM POSUsuarioEstacion
	 WHERE Empresa = @Empresa
	   AND Sucursal = @Sucursal
	   AND Usuario = @Usuario
	   AND Estacion = @Estacion

	SET @DirectorioEstilo = ISNULL(@DirectorioEstilo,'')

	IF ISNULL(@DirectorioEstilo,'') <> '' AND RIGHT(@DirectorioEstilo,1) <> '\'
		SET @DirectorioEstilo = @DirectorioEstilo + '\'

	SET @Ticket = ''
	SET @String = ''
	SET @String = @String + '<!DOCTYPE HTML>'
	SET @String = @String + '<html>'
	SET @String = @String + '<head>'
	SET @String = @String + '<title>Ticket POS</title>'
	SET @String = @String + '<meta name="viewport" content="width=device-width, initial-scale=1">'
	SET @String = @String + '<meta http-equiv="Content-Type" content="text/html; charset=latin1" />'
	SET @String = @String + '<meta name="keywords" content="POS, SDK"/>'
	SET @String = @String + '<base href="'+@DirectorioEstilo+'">'
	SET @String = @String + '<link href="web/css/bootstrap.min.css" rel="stylesheet" type="text/css" />'
	SET @String = @String + '<link href="web/css/style.css" rel="stylesheet" type="text/css" />'
	SET @String = @String + '<link rel="stylesheet" href="web/css/morris.css" type="text/css"/>'
	SET @String = @String + '<link href="web/css/font-awesome.css" rel="stylesheet">'
	SET @String = @String + '<link rel="stylesheet" type="text/css" href="web/css/table-style.css" />'
	SET @String = @String + '<link rel="stylesheet" type="text/css" href="web/css/basictable.css" />'
	SET @String = @String + '<link rel="stylesheet" href="web/css/icon-font.min.css" type="text/css" />'
	SET @String = @String + '</head>'
	SET @String = @String + '<body>'
	
	SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  

	SET @String = ''
	SET @String = @String + '<table width="100%" style="border-spacing:0px; border-color:#A8A4A4;">'
	SET @String = @String + '  <tr style="background-color:#333; border-spacing:0px; border-color:#333;">'
	SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;">CODIGO</th>'
	SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;">FORMA</th>'
	SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;">IMPORTE</th>'
	SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;">IMPORTE REF</th>'
	SET @String = @String + '  </tr>'
	SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 
    
	DECLARE crFormaPago CURSOR LOCAL FOR
	 SELECT plc.FormaPago, SUM(plc.Importe * mt.Factor), SUM(plc.ImporteRef * mt.Factor) 
	   FROM POSLCobro plc
	   LEFT JOIN POSL p ON plc.ID = p.ID          
	  INNER JOIN MovTipo mt ON p.Mov = mt.Mov AND mt.Modulo = 'POS'      			   
	  WHERE p.Caja = @CajaActual
		AND p.Estatus NOT IN ('CANCELADO', 'SINAFECTAR','PENDIENTE', 'TRASPASADO', 'CONERROR', 'NOTFOUND35')
		AND p.Empresa = @Empresa                   
	  GROUP BY plc.FormaPago     
	   OPEN crFormaPago   
	FETCH NEXT FROM crFormaPago INTO @FormaPago, @Importe, @ImporteRef
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			SELECT @CodigoFormaPago = codigo
			  FROM CB
			 WHERE cb.FormaPago = @FormaPago
			   AND cb.TipoCuenta = 'Forma Pago'


			SET @String = ''
			SET @String = @String + '  <tr>'
			SET @String = @String + '    <td>'+UPPER(@CodigoFormaPago)+'</td>'
			SET @String = @String + '    <td>'+UPPER(@FormaPago)+'</td>'
			SET @String = @String + '    <td>'+dbo.fnFormatoMoneda(@Importe,@Empresa)+'</td>'
			SET @String = @String + '    <td style="text-align:right;">'+dbo.fnFormatoMoneda(@ImporteRef,@Empresa)+'</td>'
			SET @String = @String + '  </tr>'
			SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 

		END
	FETCH NEXT FROM crFormaPago INTO @FormaPago, @Importe, @ImporteRef
	END
	CLOSE crFormaPago
	DEALLOCATE crFormaPago

	SET @String = ''
	SET @String = @String + '</body>'
	SET @String = @String + '</html>'
	SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
	SET @String = ''
END
  
IF @Accion = 'CONSULTAR INV'
BEGIN
	SELECT @Articulo = NULL, @SubCuenta = NULL, @ArtDescripcion = NULL
    
	SELECT @Articulo = cb.Cuenta, 
		   @SubCuenta = cb.SubCuenta,
		   @ArtDescripcion = a.Descripcion1
	  FROM CB
	 INNER JOIN Art a ON CB.Cuenta = a.Articulo
	 WHERE cb.Codigo = @ArtConsulta
	   AND cb.TipoCuenta = 'Articulos'
    
	SELECT @Ticket = REPLICATE('-', @LargoLineaTicket + 3) + '<BR>' + dbo.fnCentrar('SUCURSAL   ' + UPPER('Codigo'), @LargoLineaTicket /3.5) + 
					 dbo.fnCentrar(UPPER('Articulo'), @LargoLineaTicket /5) + dbo.fnCentrar(UPPER('Opcion'), @LargoLineaTicket /5) +  
					 dbo.fnCentrar(UPPER('Descripcion'), @LargoLineaTicket /3) +  dbo.fnCentrar(UPPER('Inventario'), @LargoLineaTicket /2.8) + '<BR>' + 
					 REPLICATE('-', @LargoLineaTicket+32) + '<BR>' 
    
	IF @Articulo IS NOT NULL 
	BEGIN
		DECLARE crSuc CURSOR LOCAL FOR
		 SELECT Sucursal
		   FROM Sucursal
		   OPEN crSuc
		FETCH NEXT FROM crSUC INTO @SucursalInv
		WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @@FETCH_STATUS <> -2
			BEGIN
				SELECT @SucursalInvNombre = Nombre + ' ' +  CONVERT(varchar, Sucursal)
				  FROM Sucursal
				 WHERE Sucursal = @SucursalInv
             
				EXEC spPOSInvSucursal @Empresa, @SucursalInv, @Articulo, @SubCuenta, @Inventario OUTPUT
            
				IF ISNULL(@Inventario,0) <> 0
					SELECT @Ticket = @Ticket + LEFT(UPPER(@SucursalInvNombre) + '   ',10)  + ' ' + 
									 LEFT(UPPER(@ArtConsulta) + '                        ',8) + ' ' + 
									 LEFT(UPPER(@Articulo) + '   ',10) + ' ' + LEFT(UPPER(@SubCuenta) + '                ',10) + ' ' + 
									 LEFT(UPPER(@ArtDescripcion) + '                       ',16) + ' ' + RIGHT( + '                  ' +
									 UPPER(Convert(varchar,Convert(money, ISNULL(@Inventario,0)),102)),10) + '<BR>'                    
			END
		FETCH NEXT FROM crSUC INTO @SucursalInv  
		END
		CLOSE crSuc
		DEALLOCATE crSuc
	END      
END
  
IF @Accion = 'VERIFICAR PRECIOS'
BEGIN
	EXEC spPOSVerificadorPrecios @ID, @ArtConsulta, @Usuario, @Estacion, @Ticket OUTPUT, @Ok OUTPUT, @okRef OUTPUT    
END  
  
IF @Accion = 'BUSCAR ARTICULOS'
BEGIN
	SELECT @Ticket = REPLICATE('-', @LargoLineaTicket) + '<BR>' + dbo.fnCentrar(UPPER('Codigo'), @LargoLineaTicket /5) + 
					 dbo.fnCentrar(UPPER('Articulo'), @LargoLineaTicket /4) + dbo.fnCentrar(UPPER('Descripcion'), @LargoLineaTicket /3) + 
					 dbo.fnCentrar(UPPER(''), @LargoLineaTicket /1.5) + '<BR>' +REPLICATE('-', @LargoLineaTicket) + '<BR>' 
		        
	DECLARE crCB CURSOR LOCAL FOR
	 SELECT c.Codigo, c.Cuenta, c.SubCuenta, a.Descripcion1, a.Unidad
	   FROM CB c
	  INNER JOIN Art a ON c.Cuenta = a.Articulo AND a.Descripcion1 LIKE '%'+ @ArtConsulta +'%'
	  WHERE c.TipoCuenta = 'Articulos'        		        
	  ORDER BY Descripcion1 
	   OPEN crCB
	FETCH NEXT FROM crCB INTO @CodigoBarras, @Articulo, @SubCuenta, @ArtDescripcion, @Unidad
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			SELECT @Precio = NULL, @DescuentoLinea = NULL        
        
			EXEC spArtPrecio @Articulo, 1, @Unidad, @Precio OUTPUT, @DescuentoLinea OUTPUT, NULL,
							 @SubCuenta, @FechaEmision, @Agente, @Moneda, @TipoCambio, @Condicion,
							 @Almacen, @Proyecto, @FormaEnvio, @Mov, @Empresa, @Sucursal, @ListaPreciosEsp, 
							 @Cliente
           	        
			SELECT @Ticket = @Ticket + '  '+UPPER(@CodigoBarras) +'         '  + dbo.fnAlinearDerecha(@Articulo, 10) + '   ' + 
							 LEFT(CONVERT(char(30),UPPER(@ArtDescripcion)) + REPLICATE(' ', 8),30) + '<BR>'
		END
	FETCH NEXT FROM crCB INTO @CodigoBarras, @Articulo, @SubCuenta, @ArtDescripcion, @Unidad
	END
	CLOSE crCB
	DEALLOCATE crCB
END
  
IF @CodigoAccion = 'CAMBIAR MOVIMIENTO'
BEGIN
	SELECT @Ticket = '<BR>' + dbo.fnCentrar('MOVIMIENTO', @LargoLineaTicket-2) + '<BR>'
	SELECT @Ticket = @Ticket + REPLICATE('-', @LargoLineaTicket-2) + '<BR>'
    
	DECLARE crMovTipo CURSOR LOCAL FOR
	 SELECT dbo.fnRellenarConCaracter(CONVERT(varchar, mt.Orden),5,'d',CHAR(32)) + '  ' + mt.Mov
	   FROM MovTipo mt JOIN POSUsuarioMov pu ON mt.Mov = pu.Mov
	  WHERE mt.Modulo = 'POS'
	    AND mt.Clave NOT IN('POS.CTCAC','POS.CTCRC','POS.STE','POS.FTE','POS.TCRC','POS.TCAC','POS.ET')
		AND pu.Usuario = ISNULL(NULLIF(@UsuarioPerfil,''),@Usuario)
	  ORDER BY mt.Orden
	   OPEN crMovTipo
	FETCH NEXT FROM crMovTipo INTO @String
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			SELECT @Ticket = @Ticket + @String + '<BR>'
		END
	FETCH NEXT FROM crMovTipo INTO @String
	END
	CLOSE crMovTipo
	DEALLOCATE crMovTipo
END
  
IF @CodigoAccion IN( 'REVERSAR COBRO')
BEGIN
	SELECT @Ticket = '<BR>' + 'FORMAS DE PAGO' + '<BR>'
	SELECT @Ticket = @Ticket + REPLICATE('-', @LargoLineaTicket-2) + '<BR>'
    
	DECLARE crMovTipo CURSOR LOCAL FOR
	 SELECT Codigo + SPACE(15) + FormaPago
	   FROM CB
	  WHERE TipoCuenta = 'Forma Pago'
	   OPEN crMovTipo
	FETCH NEXT FROM crMovTipo INTO @String
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			SELECT @Ticket = @Ticket + @String + '<BR>'
		END
	FETCH NEXT FROM crMovTipo INTO @String
	END
	CLOSE crMovTipo
	DEALLOCATE crMovTipo
END
  
IF @CodigoAccion = 'INTRODUCIR CUENTA DINERO'
BEGIN

	SELECT @DirectorioEstilo = Directorio
	  FROM POSUsuarioEstacion
	 WHERE Empresa = @Empresa
	   AND Sucursal = @Sucursal
	   AND Usuario = @Usuario
	   AND Estacion = @Estacion

	SET @DirectorioEstilo = ISNULL(@DirectorioEstilo,'')

	IF ISNULL(@DirectorioEstilo,'') <> '' AND RIGHT(@DirectorioEstilo,1) <> '\'
		SET @DirectorioEstilo = @DirectorioEstilo + '\'

	SET @Ticket = ''
	SET @String = ''
	SET @String = @String + '<!DOCTYPE HTML>'
	SET @String = @String + '<html>'
	SET @String = @String + '<head>'
	SET @String = @String + '<title>Ticket POS</title>'
	SET @String = @String + '<meta name="viewport" content="width=device-width, initial-scale=1">'
	SET @String = @String + '<meta http-equiv="Content-Type" content="text/html; charset=latin1" />'
	SET @String = @String + '<meta name="keywords" content="POS, SDK"/>'
	SET @String = @String + '<base href="'+@DirectorioEstilo+'">'
	SET @String = @String + '<link href="web/css/bootstrap.min.css" rel="stylesheet" type="text/css" />'
	SET @String = @String + '<link href="web/css/style.css" rel="stylesheet" type="text/css" />'
	SET @String = @String + '<link rel="stylesheet" href="web/css/morris.css" type="text/css"/>'
	SET @String = @String + '<link href="web/css/font-awesome.css" rel="stylesheet">'
	SET @String = @String + '<link rel="stylesheet" type="text/css" href="web/css/table-style.css" />'
	SET @String = @String + '<link rel="stylesheet" type="text/css" href="web/css/basictable.css" />'
	SET @String = @String + '<link rel="stylesheet" href="web/css/icon-font.min.css" type="text/css" />'
	SET @String = @String + '</head>'
	SET @String = @String + '<body>'
	
	SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  

	SET @String = ''
	SET @String = @String + '<table width="100%" style="border-spacing:0px; border-color:#A8A4A4;">'
	SET @String = @String + '  <tr style="background-color:#333; border-spacing:0px; border-color:#333;">'
	SET @String = @String + '    <th style="text-align:left; color:#f5f5f5; background:#777;"> CUENTA </th>'
	SET @String = @String + '    <th style="text-align:right; color:#f5f5f5; background:#777;"> DESCRIPCIÓN </th>'
	SET @String = @String + '  </tr>'
	SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 



	--SELECT @Ticket = '<BR>' + dbo.fnCentrar('CUENTA', @LargoLineaTicket) + '<BR>'
	--SELECT @Ticket = @Ticket + REPLICATE('-', @LargoLineaTicket) + '<BR>'
    SET @CtaDineroMM = NULL
	SET @CtaDineroMM = @CtaDineroMMDescripcion

	DECLARE crCtaDinero CURSOR LOCAL FOR
	 SELECT c.CtaDinero , ISNULL(c.Descripcion, '')
	  FROM CtaDinero c JOIN POSL p ON c.Sucursal = p.Sucursal
	 WHERE Tipo = CASE WHEN @MovClave IN('POS.TCM','POS.TRM') THEN 'Caja' ELSE 'Banco' END
	   AND c.Empresa = @Empresa
	   AND p.ID = @ID
	   AND c.EsConcentradora = CASE WHEN @MovClave IN('POS.TCM','POS.TRM') THEN 1 ELSE 0 END
	  OPEN crCtaDinero
	FETCH NEXT FROM crCtaDinero INTO @CtaDineroMM, @CtaDineroMMDescripcion
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			
			--SELECT @Ticket = @Ticket + dbo.fnCentrar(@String, @LargoLineaTicket) + '<BR>'

			SET @String = ''
			SET @String = @String + '  <tr>'
			SET @String = @String + '    <td> '+UPPER(@CtaDineroMM)+' </td>'
			SET @String = @String + '    <td style="text-align:right;"> '+@CtaDineroMMDescripcion+' </td>'
			SET @String = @String + '  </tr>'

			SET @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'') 


		END
	FETCH NEXT FROM crCtaDinero INTO @CtaDineroMM, @CtaDineroMMDescripcion
	END
	CLOSE crCtaDinero
	DEALLOCATE crCtaDinero
END
  
IF @CodigoAccion = 'ASIGNAR CAJA'
BEGIN
	SELECT @Ticket = '<BR>' + dbo.fnCentrar('CAJA', @LargoLineaTicket) + '<BR>'
	SELECT @Ticket = @Ticket + REPLICATE('-', @LargoLineaTicket) + '<BR>'
    
	DECLARE crCtaDinero CURSOR LOCAL FOR
	 SELECT c.CtaDinero + '  ' + ISNULL(c.Descripcion, '')
	   FROM CtaDinero c JOIN POSL p ON c.Sucursal = p.Sucursal
	  WHERE Tipo = 'Caja'
		AND c.Empresa = @Empresa
		AND p.ID = @ID
	   OPEN crCtaDinero
	FETCH NEXT FROM crCtaDinero INTO @String
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			SELECT @Ticket = @Ticket + dbo.fnCentrar(@String, @LargoLineaTicket) + '<BR>'
		END
	FETCH NEXT FROM crCtaDinero INTO @String
	END
	CLOSE crCtaDinero
	DEALLOCATE crCtaDinero
END

IF @CodigoAccion = 'MODIFICAR COMPONENTE'
BEGIN
	DELETE POSTempArtJuego WHERE Estacion = @Estacion

	INSERT POSTempArtJuego(Estacion, ID, RID, RenglonID, Articulo)
	SELECT				   @Estacion,NULL,@ID,RenglonID, Articulo
	  FROM POSLVenta 
	 WHERE ID = @ID 
	   AND RenglonTipo = 'J'
      
	SET @IDTemp = 0
	UPDATE POSTempArtJuego SET @IDTemp = ID = @IDTemp + 1
	  FROM POSTempArtJuego  
	 WHERE RID = @ID 
	   AND Estacion = @Estacion
    
	SELECT @Ticket = '<BR>' + REPLICATE('-', @LargoLineaTicket + CASE WHEN @EsImpresion = 0 THEN 32 ELSE 0 END) + '<BR>' + 
					 dbo.fnCentrar(UPPER('Numero'), @LargoLineaTicket /2) + dbo.fnCentrar(UPPER('Articulo'), @LargoLineaTicket /2) + '<BR>'
    
	DECLARE crArt CURSOR LOCAL FOR
	 SELECT CONVERT(varchar,v.ID)+ '            ' + ISNULL(a.Descripcion1, '')
	   FROM POSTempArtJuego v JOIN Art a ON v.Articulo = a.Articulo
	  WHERE v.RID = @ID AND Estacion = @Estacion  
	   OPEN crArt
	FETCH NEXT FROM crArt INTO @String
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			SELECT @Ticket = @Ticket + dbo.fnCentrar(@String, @LargoLineaTicket) + '<BR>'
		END
	FETCH NEXT FROM crArt INTO @String
	END
	CLOSE crArt
	DEALLOCATE crArt
END  
    
IF @EsImpresion = 0
BEGIN
	SET @String = ''
	SET @String = @String + '</body>'
	SET @String = @String + '</html>'
	SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
	SET @String = ''
END  
END
GO



/**************** xpPOSOfertaAplicar ****************/
IF EXISTS (SELECT * FROM SysObjects WHERE name='xpPOSOfertaAplicar' AND type='P') DROP PROCEDURE xpPOSOfertaAplicar
GO
CREATE PROCEDURE xpPOSOfertaAplicar
	@ID			varchar(50),
	@Aplica		bit OUTPUT
AS
BEGIN
	RETURN
END
GO


/************************ xpPOSVentaInsertaClienteVerificar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.xpPOSVentaInsertaClienteVerificar') AND type = 'P') DROP PROCEDURE dbo.xpPOSVentaInsertaClienteVerificar
GO             
CREATE PROCEDURE xpPOSVentaInsertaClienteVerificar
	     @Empresa		varchar(5),
	     @ID			varchar(50),
	     @Codigo		varchar(30),
	     @Cliente		varchar(10),
	     @CtaDinero		varchar(10),	     
	     @Ok			int	OUTPUT,
	     @OkRef			int	OUTPUT     	
AS 
BEGIN
	RETURN
END
GO


/************************ xpPOSVentaInsertaArticuloVerificar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.xpPOSVentaInsertaArticuloVerificar') AND type = 'P') DROP PROCEDURE dbo.xpPOSVentaInsertaArticuloVerificar
GO             
CREATE PROCEDURE xpPOSVentaInsertaArticuloVerificar
	@Codigo				varchar(30),
    @Articulo			varchar(20),
    @ID					varchar(50),
    @FechaEmision		datetime,
    @Agente				varchar(10),
    @Moneda				varchar(10),
    @TipoCambio			float,
    @Condicion			varchar(50),
    @Almacen			varchar(10),
    @Proyecto			varchar(50),
    @FormaEnvio			varchar(50),
    @Mov				varchar(20),
    @Empresa			varchar(5),
    @Sucursal			int,
    @ListaPreciosEsp	varchar(20),	
    @Cliente			varchar(10),
    @Accion				varchar(50),
    @ArtDescripcion		varchar(100)	OUTPUT,
    @Imagen				varchar(255)	OUTPUT,
    @Ok					int				OUTPUT,
    @OkRef				varchar(255)	OUTPUT    	     
AS 
BEGIN
	RETURN
END
GO


/************************ xpPOSVentaInsertaArticulo *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.xpPOSVentaInsertaArticulo') AND type = 'P') DROP PROCEDURE dbo.xpPOSVentaInsertaArticulo
GO             
CREATE PROCEDURE xpPOSVentaInsertaArticulo
	@Codigo				varchar(30),
    @ID					varchar(50),
    @FechaEmision		datetime,
    @Agente				varchar(10),
    @Moneda				varchar(10),
    @TipoCambio			float,
    @Condicion			varchar(50),
    @Almacen			varchar(10),
    @Proyecto			varchar(50),
    @FormaEnvio			varchar(50),
    @Mov				varchar(20),
    @Empresa			varchar(5),
    @Sucursal			int,
    @ListaPreciosEsp	varchar(20),	
    @Cliente			varchar(10),
    @CtaDinero			varchar(10),
    @Accion				varchar(50),
    @ArtDescripcion		varchar(100)	OUTPUT,
    @Imagen				varchar(255)	OUTPUT,
    @Ok					int				OUTPUT,
    @OkRef				varchar(255)	OUTPUT    	     
AS 
BEGIN
	RETURN
END
GO


/************************ xpPOSMovCobrarVerificar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.xpPOSMovCobrarVerificar') AND type = 'P') DROP PROCEDURE dbo.xpPOSMovCobrarVerificar
GO             
CREATE PROCEDURE xpPOSMovCobrarVerificar
	@ID						varchar(50),
	@Codigo					varchar(30),
	@Referencia				varchar(50),
	@FormaPago				varchar(50),
	@CtaDinero				varchar(10),
	@ToleranciaRedondeo		float,
	@CodigoAccion			varchar(50)		OUTPUT,
	@Importe				float			OUTPUT, 
	@Saldo					float			OUTPUT,
	@Ok						int				OUTPUT,
	@OkRef					varchar(255)	OUTPUT
AS 
BEGIN
	RETURN
END
GO


/************************ xpPOSMovCobrarDespues *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.xpPOSMovCobrarDespues') AND type = 'P') DROP PROCEDURE dbo.xpPOSMovCobrarDespues
GO             
CREATE PROCEDURE xpPOSMovCobrarDespues
	@ID						varchar(50),
	@Codigo					varchar(30),
	@Referencia				varchar(50),
	@FormaPago				varchar(50),
	@CtaDinero				varchar(10),
	@ToleranciaRedondeo		float,
	@CodigoAccion			varchar(50)		OUTPUT,
	@Importe				float			OUTPUT, 
	@Saldo					float			OUTPUT,
	@Ok						int				OUTPUT,
	@OkRef					varchar(255)	OUTPUT
AS 
BEGIN
	RETURN
END
GO


/************************ xpPOSAfectarVenta *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.xpPOSAfectarVenta') AND type = 'P') DROP PROCEDURE dbo.xpPOSAfectarVenta
GO             
CREATE PROCEDURE xpPOSAfectarVenta
	@ID			varchar(36),
	@IDVenta	int,	
	@Ok			int				OUTPUT,
	@OkRef		varchar(255)	OUTPUT
AS 
BEGIN
	RETURN
END
GO


/************************ xpPOSAfectar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.xpPOSAfectar') AND type = 'P') DROP PROCEDURE dbo.xpPOSAfectar
GO             
CREATE PROCEDURE xpPOSAfectar
	@Empresa	varchar(5),
    @Modulo		varchar(5),
    @Sucursal	int,
    @Usuario	varchar(10),
    @ID			varchar(36),
    @Host 		varchar(20)	= NULL,
    @Ok			int				OUTPUT,
    @OkRef		varchar(255)    OUTPUT
AS 
BEGIN
	RETURN
END
GO


/************************ spActualizaResumenGerencial*****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spActualizaResumenGerencial') AND type = 'P') DROP PROCEDURE dbo.spActualizaResumenGerencial
GO             
CREATE PROCEDURE spActualizaResumenGerencial
	@MovTipo		varchar(30),
	@Empresa		varchar(80),
	@Mov			varchar(20),
	@Mov2			varchar(20),
	@Modulo			varchar(20),
	@Moneda			varchar(20),
	@Moneda1		varchar(20),
	@Usuario		varchar(10)
--//WITH ENCRYPTION
AS
	IF @Modulo = 'CXC' AND @MovTipo = 'CXC.F'
		BEGIN
		  DELETE ResumenGerencial WHERE Usuario = @Usuario AND Modulo = 'CXC' AND MovTipo = 'CXC.F'
		  INSERT ResumenGerencial VALUES('CXC','Factura', 0, 0, 0, 0, 0, 0, 'CXC.F', @Usuario)
	  
		  UPDATE ResumenGerencial SET TotalMov = (SELECT COUNT(*) 
													FROM CxcInfo JOIN Cte ON CxcInfo.Cliente=Cte.Cliente
													JOIN MovTipo ON MovTipo.Mov = CxcInfo.Mov AND MovTipo.Clave = @MovTipo
													JOIN Cxc ON Cxc.ID = CxcInfo.ID
												   WHERE CxcInfo.Empresa = @Empresa 
													 AND Cxc.Usuario = @Usuario											     
													 AND ISNULL(cxcInfo.Saldo,0) > 0), 
	
								   ImportePesos = (SELECT ISNULL(SUM(CxcInfo.Saldo), 0.0)	
													FROM CxcInfo JOIN Cte ON CxcInfo.Cliente=Cte.Cliente
													JOIN MovTipo ON MovTipo.Mov = CxcInfo.Mov AND MovTipo.Clave = @MovTipo
												   WHERE CxcInfo.Empresa = @Empresa 								
													  AND CxcInfo.Moneda = @Moneda),
	
								 ImporteDolares = (SELECT ISNULL(SUM(CxcInfo.Saldo), 0.0)
													FROM CxcInfo JOIN Cte ON CxcInfo.Cliente=Cte.Cliente
													JOIN MovTipo ON MovTipo.Mov = CxcInfo.Mov AND MovTipo.Clave = @MovTipo
												   WHERE CxcInfo.Empresa = @Empresa 								
													 AND CxcInfo.Moneda = @Moneda1),
	
								   TotalVencido = (SELECT COUNT(*)
													FROM CxcInfo JOIN Cte ON CxcInfo.Cliente=Cte.Cliente
													JOIN MovTipo ON MovTipo.Mov = CxcInfo.Mov AND MovTipo.Clave = @MovTipo
												   WHERE CxcInfo.Empresa = @Empresa 								
													  AND ISNULL(CxcInfo.Vencimiento, '19010101') < GETDATE()  
													  AND ISNULL(cxcInfo.Saldo,0) > 0),
								
								 TotalPorVencer = (SELECT COUNT(*)
													FROM CxcInfo JOIN Cte ON CxcInfo.Cliente=Cte.Cliente
													JOIN MovTipo ON MovTipo.Mov = CxcInfo.Mov AND MovTipo.Clave = @MovTipo
												   WHERE CxcInfo.Empresa = @Empresa 								
													  AND ISNULL(CxcInfo.Vencimiento, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) 
													  AND ISNULL(cxcInfo.Saldo,0) > 0),
								
								  TotalEnTiempo = (SELECT COUNT(*)
													FROM CxcInfo JOIN Cte ON CxcInfo.Cliente=Cte.Cliente
													JOIN MovTipo ON MovTipo.Mov = CxcInfo.Mov AND MovTipo.Clave = @MovTipo
												   WHERE CxcInfo.Empresa = @Empresa 								
													  AND ISNULL(CxcInfo.Vencimiento, '19010101') > DATEADD(DAY,2,GETDATE()) 
													  AND ISNULL(cxcInfo.Saldo,0) > 0)
							
		  WHERE Modulo = @Modulo AND Mov = @Mov
		END
	ELSE IF @Modulo = 'CXC' AND @MovTipo = 'CXC.D'
		BEGIN
		  DELETE ResumenGerencial WHERE Usuario = @Usuario AND Modulo = 'CXC' AND MovTipo = 'CXC.D'
		  INSERT ResumenGerencial VALUES('CXC','Documento', 0, 0, 0, 0, 0, 0, 'CXC.D', @Usuario)
	  
		  UPDATE ResumenGerencial SET TotalMov = (SELECT COUNT(*) 
													FROM CxcInfo JOIN Cte ON CxcInfo.Cliente=Cte.Cliente
													JOIN MovTipo ON MovTipo.Mov = CxcInfo.Mov AND MovTipo.Clave = @MovTipo
													JOIN Cxc ON Cxc.ID = CxcInfo.ID
												   WHERE CxcInfo.Empresa = @Empresa 
													 AND Cxc.Usuario = @Usuario											     
													 AND ISNULL(cxcInfo.Saldo,0) > 0), 
	
								   ImportePesos = (SELECT ISNULL(SUM(CxcInfo.Saldo), 0.0)	
													FROM CxcInfo JOIN Cte ON CxcInfo.Cliente=Cte.Cliente
													JOIN MovTipo ON MovTipo.Mov = CxcInfo.Mov AND MovTipo.Clave = @MovTipo
												   WHERE CxcInfo.Empresa = @Empresa 								
													  AND CxcInfo.Moneda = @Moneda),
	
								 ImporteDolares = (SELECT ISNULL(SUM(CxcInfo.Saldo), 0.0)
													FROM CxcInfo JOIN Cte ON CxcInfo.Cliente=Cte.Cliente
													JOIN MovTipo ON MovTipo.Mov = CxcInfo.Mov AND MovTipo.Clave = @MovTipo
												   WHERE CxcInfo.Empresa = @Empresa 								
													 AND CxcInfo.Moneda = @Moneda1),
	
								   TotalVencido = (SELECT COUNT(*)
													FROM CxcInfo JOIN Cte ON CxcInfo.Cliente=Cte.Cliente
													JOIN MovTipo ON MovTipo.Mov = CxcInfo.Mov AND MovTipo.Clave = @MovTipo
												   WHERE CxcInfo.Empresa = @Empresa 								
													  AND ISNULL(CxcInfo.Vencimiento, '19010101') < GETDATE()  
													  AND ISNULL(cxcInfo.Saldo,0) > 0),
								
								 TotalPorVencer = (SELECT COUNT(*)
													FROM CxcInfo JOIN Cte ON CxcInfo.Cliente=Cte.Cliente
													JOIN MovTipo ON MovTipo.Mov = CxcInfo.Mov AND MovTipo.Clave = @MovTipo
												   WHERE CxcInfo.Empresa = @Empresa 								
													  AND ISNULL(CxcInfo.Vencimiento, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) 
													  AND ISNULL(cxcInfo.Saldo,0) > 0),
								
								  TotalEnTiempo = (SELECT COUNT(*)
													FROM CxcInfo JOIN Cte ON CxcInfo.Cliente=Cte.Cliente
													JOIN MovTipo ON MovTipo.Mov = CxcInfo.Mov AND MovTipo.Clave = @MovTipo
												   WHERE CxcInfo.Empresa = @Empresa 								
													  AND ISNULL(CxcInfo.Vencimiento, '19010101') > DATEADD(DAY,2,GETDATE()) 
													  AND ISNULL(cxcInfo.Saldo,0) > 0)
							
		  WHERE Modulo = @Modulo AND Mov = @Mov
		END
	ELSE IF @Modulo = 'VTAS' AND @MovTipo = 'VTAS.C'
		BEGIN
		  DELETE ResumenGerencial WHERE Usuario = @Usuario AND Modulo = 'VTAS' AND MovTipo = 'VTAS.C'
		  INSERT ResumenGerencial VALUES('VTAS','Cotizacion', 0, 0, 0, 0, 0, 0, 'VTAS.C', @Usuario)

		  UPDATE ResumenGerencial SET TotalMov = (SELECT COUNT(*) 
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente 
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND ISNULL(VentaPendiente.Importe, 0) >0 ),
												 
								  ImportePesos = (SELECT ISNULL(SUM(VentaPendiente.Importe),0)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente 
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND VentaPendiente.Moneda=@Moneda),

								ImporteDolares = (SELECT ISNULL(SUM(VentaPendiente.Importe),0)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente 
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND VentaPendiente.Moneda=@Moneda1),

								  TotalVencido = (SELECT COUNT(*)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente 
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND ISNULL(VentaPendiente.FechaRequerida, '19010101') < GETDATE()  
													 AND ISNULL(VentaPendiente.Importe,0) > 0 ),

								TotalPorVencer = (SELECT COUNT(*)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente 
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND ISNULL(VentaPendiente.FechaRequerida, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) 
													 AND ISNULL(VentaPendiente.Importe,0) > 0),

								TotalEnTiempo = (SELECT COUNT(*)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente 
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND ISNULL(VentaPendiente.FechaRequerida, '19010101') > DATEADD(DAY,2,GETDATE()) 
													 AND ISNULL(VentaPendiente.Importe,0) > 0)

		  WHERE Modulo = @Modulo AND MovTipo = @MovTipo
		END
	ELSE IF @Modulo = 'VTAS' AND @MovTipo = 'VTAS.P'
		BEGIN
		  DELETE ResumenGerencial WHERE Usuario = @Usuario AND Modulo = 'VTAS' AND MovTipo = 'VTAS.P'
		  INSERT ResumenGerencial VALUES('VTAS','Pedido', 0, 0, 0, 0, 0, 0, 'VTAS.P', @Usuario)

		  UPDATE ResumenGerencial SET TotalMov = (SELECT COUNT(*)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND VentaPendiente.Importe > 0), 

								  ImportePesos = (SELECT ISNULL(SUM(VentaPendiente.Importe),0)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente							  
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND VentaPendiente.Importe > 0  
													 AND VentaPendiente.Moneda=@Moneda),

								ImporteDolares = (SELECT ISNULL(SUM(VentaPendiente.Importe),0)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente							
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND VentaPendiente.Importe > 0  
													 AND VentaPendiente.Moneda=@Moneda1),

								  TotalVencido = (SELECT COUNT(*)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente							  
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND VentaPendiente.Importe > 0  
													 AND ISNULL(VentaPendiente.FechaRequerida, '19010101') < GETDATE()),  													

								TotalPorVencer = (SELECT COUNT(*)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND VentaPendiente.Importe > 0
													 AND ISNULL(VentaPendiente.FechaRequerida, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE())),

								 TotalEnTiempo = (SELECT COUNT(*)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND VentaPendiente.Importe > 0
													 AND ISNULL(VentaPendiente.FechaRequerida, '19010101') > DATEADD(DAY,2,GETDATE())) 

		  WHERE Modulo = @Modulo AND MovTipo = @MovTipo
		END
	ELSE IF @Modulo = 'VTAS' AND @MovTipo = 'VTAS.S'
		BEGIN
		  DELETE ResumenGerencial WHERE Usuario = @Usuario AND Modulo = 'VTAS' AND MovTipo = 'VTAS.S'
		  INSERT ResumenGerencial VALUES('VTAS','Servicio', 0, 0, 0, 0, 0, 0, 'VTAS.S', @Usuario)
	  
		  UPDATE ResumenGerencial SET TotalMov = (SELECT COUNT(*)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND VentaPendiente.Estatus = 'CONFIRMAR' 
													 AND VentaPendiente.Importe > 0),

								  ImportePesos = (SELECT ISNULL(SUM(VentaPendiente.Importe),0)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND VentaPendiente.Estatus = 'CONFIRMAR' 
													 AND VentaPendiente.Moneda = @Moneda),

								ImporteDolares = (SELECT ISNULL(SUM(VentaPendiente.Importe),0)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario 
													 AND VentaPendiente.Estatus = 'CONFIRMAR' 
													 AND VentaPendiente.Moneda = @Moneda1),

								  TotalVencido = (SELECT COUNT(*)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND VentaPendiente.Estatus = 'CONFIRMAR' 
													 AND ISNULL(VentaPendiente.FechaRequerida, '19010101') < GETDATE()  
													 AND VentaPendiente.Importe > 0),

								TotalPorVencer = (SELECT COUNT(*)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND VentaPendiente.Estatus = 'CONFIRMAR' 
													 AND ISNULL(VentaPendiente.FechaRequerida, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) 
													 AND VentaPendiente.Importe > 0),

								 TotalEnTiempo = (SELECT COUNT(*)
													FROM VentaPendiente JOIN Cte ON VentaPendiente.Cliente = Cte.Cliente
													JOIN Venta ON VentaPendiente.ID = Venta.ID
												   WHERE VentaPendiente.Empresa = @Empresa 
										  			 AND VentaPendiente.MovTipo = @MovTipo 
										  			 AND Venta.Usuario = @Usuario
													 AND VentaPendiente.Estatus = 'CONFIRMAR' 
													 AND ISNULL(VentaPendiente.FechaRequerida, '19010101') > DATEADD(DAY,2,GETDATE()) 
													 AND VentaPendiente.Importe > 0)

		  WHERE Modulo = @Modulo AND MovTipo = @MovTipo
		END
	ELSE IF @Modulo = 'CXP' 
		BEGIN
		  DELETE ResumenGerencial WHERE Usuario = @Usuario AND Modulo = 'CXP' AND MovTipo = 'CXP.P'
		  INSERT ResumenGerencial VALUES('CXP','Pagos', 0, 0, 0, 0, 0, 0, 'CXP.P', @Usuario)	

		  UPDATE ResumenGerencial SET TotalMov = (SELECT COUNT(*)
													FROM CxpInfo JOIN Prov ON CxpInfo.Proveedor = Prov.Proveedor
													JOIN Cxp ON Cxp.ID = CxpInfo.ID 
												   WHERE CxpInfo.Empresa = @Empresa 
													 AND Cxp.Usuario = @Usuario
													 AND CxpInfo.Mov IN (@Mov, @Mov2)),

								  ImportePesos = (SELECT ISNULL(SUM(CxpInfo.Saldo),0)
													FROM CxpInfo JOIN Prov ON CxpInfo.Proveedor = Prov.Proveedor
													JOIN Cxp ON Cxp.ID = CxpInfo.ID 
												   WHERE CxpInfo.Empresa = @Empresa 
													 AND Cxp.Usuario = @Usuario
													 AND CxpInfo.Mov IN (@Mov, @Mov2)
													 AND CxpInfo.Moneda = @Moneda),

								ImporteDolares = (SELECT ISNULL(SUM(CxpInfo.Saldo),0)
													FROM CxpInfo JOIN Prov ON CxpInfo.Proveedor = Prov.Proveedor
													JOIN Cxp ON Cxp.ID = CxpInfo.ID 
												   WHERE CxpInfo.Empresa = @Empresa 
													 AND Cxp.Usuario = @Usuario
													 AND CxpInfo.Mov IN (@Mov, @Mov2)
													 AND CxpInfo.Moneda = @Moneda1),
											     
								  TotalVencido = (SELECT COUNT(*)
													FROM CxpInfo JOIN Prov ON CxpInfo.Proveedor = Prov.Proveedor
													JOIN Cxp ON Cxp.ID = CxpInfo.ID 
												   WHERE CxpInfo.Empresa = @Empresa 
													 AND Cxp.Usuario = @Usuario
													 AND CxpInfo.Mov IN (@Mov, @Mov2)
													 AND ISNULL(CxpInfo.Vencimiento, '19010101') < GETDATE()),

								TotalPorVencer = (SELECT COUNT(*)
													FROM CxpInfo JOIN Prov ON CxpInfo.Proveedor = Prov.Proveedor
													JOIN Cxp ON Cxp.ID = CxpInfo.ID 
												   WHERE CxpInfo.Empresa = @Empresa 
													 AND Cxp.Usuario = @Usuario
													 AND CxpInfo.Mov IN (@Mov, @Mov2)
													 AND ISNULL(CxpInfo.Vencimiento, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE())),
							
								 TotalEnTiempo = (SELECT COUNT(*)
													FROM CxpInfo JOIN Prov ON CxpInfo.Proveedor = Prov.Proveedor
													JOIN Cxp ON Cxp.ID = CxpInfo.ID 
												   WHERE CxpInfo.Empresa = @Empresa 
													 AND Cxp.Usuario = @Usuario
													 AND CxpInfo.Mov IN (@Mov, @Mov2)
													 AND ISNULL(CxpInfo.Vencimiento, '19010101') > DATEADD(DAY,2,GETDATE()))

		  WHERE Modulo = @Modulo
		END
	ELSE IF @Modulo = 'COMS' 
		BEGIN
		  DELETE ResumenGerencial WHERE Usuario = @Usuario AND Modulo = 'COMS' AND MovTipo = 'COMS.FL'
		  INSERT ResumenGerencial VALUES('COMS','Compras', 0, 0, 0, 0, 0, 0, 'COMS.FL', @Usuario)

		  UPDATE ResumenGerencial set TotalMov = (SELECT COUNT(*)
													FROM CompraPendiente JOIN Compra ON CompraPendiente.ID = Compra.ID
												   WHERE CompraPendiente.Empresa = @Empresa 
													 AND Compra.Usuario = @Usuario
													 AND CompraPendiente.Clave LIKE ('COMS.O%') 
													 AND CompraPendiente.Saldo > 0),

								  ImportePesos = (SELECT ISNULL(SUM(CompraPendiente.Saldo),0)
													FROM CompraPendiente JOIN Compra ON CompraPendiente.ID = Compra.ID
												   WHERE CompraPendiente.Empresa = @Empresa 
													 AND Compra.Usuario = @Usuario
													 AND CompraPendiente.Clave LIKE ('COMS.O%') 
													 AND CompraPendiente.Moneda=@Moneda
													 AND CompraPendiente.Saldo > 0),

								ImporteDolares = (SELECT ISNULL(SUM(CompraPendiente.Saldo),0)
													FROM CompraPendiente JOIN Compra ON CompraPendiente.ID = Compra.ID
												   WHERE CompraPendiente.Empresa = @Empresa 
													 AND Compra.Usuario = @Usuario
													 AND CompraPendiente.Clave LIKE ('COMS.O%') 
													 AND CompraPendiente.Moneda=@Moneda1 
													 AND CompraPendiente.Saldo > 0),

								  TotalVencido = (SELECT COUNT(*)
													FROM CompraPendiente JOIN Compra ON CompraPendiente.ID = Compra.ID
												   WHERE CompraPendiente.Empresa = @Empresa 
													 AND Compra.Usuario = @Usuario 
													 AND CompraPendiente.Clave LIKE ('COMS.O%') 
													 AND ISNULL(CompraPendiente.FechaRequerida, '19010101') < GETDATE()  
													 AND CompraPendiente.Saldo > 0),

								TotalPorVencer = (SELECT COUNT(*)
													FROM CompraPendiente JOIN Compra ON CompraPendiente.ID = Compra.ID
												   WHERE CompraPendiente.Empresa = @Empresa 
													 AND Compra.Usuario = @Usuario
													 AND CompraPendiente.Clave LIKE ('COMS.O%') 
													 AND ISNULL(CompraPendiente.FechaRequerida, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) 
													 AND CompraPendiente.Saldo > 0),
											     

								 TotalEnTiempo = (SELECT COUNT(*)
													FROM CompraPendiente JOIN Compra ON CompraPendiente.ID = Compra.ID
												   WHERE CompraPendiente.Empresa = @Empresa 
													 AND Compra.Usuario = @Usuario
													 AND CompraPendiente.Clave LIKE ('COMS.O%') 
													 AND ISNULL(CompraPendiente.FechaRequerida, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) 
													 AND CompraPendiente.Saldo > 0)

		  WHERE Modulo = @Modulo
		END
GO


/************************ ActualizaGerenciaDetalle*****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.ActualizaGerenciaDetalle') AND type = 'P') DROP PROCEDURE dbo.ActualizaGerenciaDetalle
GO             
CREATE PROCEDURE ActualizaGerenciaDetalle
	@MovTipo	 varchar(30),
	@Empresa	 varchar(80),
	@Mov		 varchar(20),
	@Mov2		 varchar(20),
	@Modulo		 varchar(20),
	@Moneda		 varchar(20),
	@Moneda1	 varchar(20),
	@Usuario	 varchar(20),
	@Grupo	 	 varchar(20)
--//WITH ENCRYPTION
AS 
BEGIN
	DELETE ResumenGerencialDetalle

	IF @Modulo = 'CXC' AND @Grupo NOT IN ('Direccion', 'Sistemas')
	  BEGIN
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Cxc', CxcInfo.Id, CxcInfo.Mov, CxcInfo.MovID, Cte.Cliente, Cte.Nombre, Cxc.FechaEmision, Cxc.Concepto, Cxc.Proyecto, Cxc.Uen, Cxc.TipoCambio, Cxc.Usuario, Cxc.Autorizacion, Cxc.Referencia, Cxc.Observaciones, Cxc.CtaDinero, Cxc.Condicion, Cxc.FormaCobro, Cxc.Importe, Cxc.Impuestos, Cxc.Retencion, Cxc.MovAplica, Cxc.MovAplicaID, Cxc.Origen, Cxc.OrigenID,CxcInfo.Vencimiento, CxcInfo.DiasMoratorios, CxcInfo.Saldo, 'ROJO2', Cxc.Moneda
			FROM CxcInfo, Cte, Cxc	
			WHERE CxcInfo.Cliente=Cte.Cliente AND
			   CxcInfo.ID = Cxc.Id AND
			   Cxc.Usuario = @Usuario AND
			   CxcInfo.Empresa=@Empresa AND 
			   ISNULL(CxcInfo.Vencimiento, '19010101') < GETDATE()  AND 
			   CxcInfo.Mov=@Mov AND
			   ISNULL(cxcInfo.Saldo,0) > 0

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Cxc', CxcInfo.Id, CxcInfo.Mov, CxcInfo.MovID, Cte.Cliente, Cte.Nombre, Cxc.FechaEmision, Cxc.Concepto, Cxc.Proyecto, Cxc.Uen, Cxc.TipoCambio, Cxc.Usuario, Cxc.Autorizacion, Cxc.Referencia, Cxc.Observaciones, Cxc.CtaDinero, Cxc.Condicion, Cxc.FormaCobro, Cxc.Importe, Cxc.Impuestos, Cxc.Retencion, Cxc.MovAplica, Cxc.MovAplicaID, Cxc.Origen, Cxc.OrigenID,CxcInfo.Vencimiento, CxcInfo.DiasMoratorios, CxcInfo.Saldo, 'AMARILLO2', Cxc.Moneda
			FROM CxcInfo, Cte, Cxc	
			WHERE CxcInfo.Cliente=Cte.Cliente AND
			   CxcInfo.ID = Cxc.Id AND
			   Cxc.Usuario = @Usuario AND
			   CxcInfo.Empresa=@Empresa AND 
			   ISNULL(CxcInfo.Vencimiento, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) AND 
			   CxcInfo.Mov=@Mov AND
			   ISNULL(cxcInfo.Saldo,0) > 0

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Cxc', CxcInfo.Id, CxcInfo.Mov, CxcInfo.MovID, Cte.Cliente, Cte.Nombre, Cxc.FechaEmision, Cxc.Concepto, Cxc.Proyecto, Cxc.Uen, Cxc.TipoCambio, Cxc.Usuario, Cxc.Autorizacion, Cxc.Referencia, Cxc.Observaciones, Cxc.CtaDinero, Cxc.Condicion, Cxc.FormaCobro, Cxc.Importe, Cxc.Impuestos, Cxc.Retencion, Cxc.MovAplica, Cxc.MovAplicaID, Cxc.Origen, Cxc.OrigenID,CxcInfo.Vencimiento, CxcInfo.DiasMoratorios, CxcInfo.Saldo, 'VERDE2', Cxc.Moneda
			FROM CxcInfo, Cte, Cxc	
			WHERE CxcInfo.Cliente=Cte.Cliente AND
			   CxcInfo.ID = Cxc.Id AND
			   Cxc.Usuario = @Usuario AND
			   CxcInfo.Empresa=@Empresa AND 
			   ISNULL(CxcInfo.Vencimiento, '19010101') > DATEADD(DAY,2,GETDATE()) AND 
			   CxcInfo.Mov=@Mov AND
			   ISNULL(cxcInfo.Saldo,0) > 0
		END
	ELSE IF @Modulo = 'CXC' AND @Grupo IN ('Direccion', 'Sistemas')		
	  BEGIN
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Cxc', CxcInfo.Id, CxcInfo.Mov, CxcInfo.MovID, Cte.Cliente, Cte.Nombre, Cxc.FechaEmision, Cxc.Concepto, Cxc.Proyecto, Cxc.Uen, Cxc.TipoCambio, Cxc.Usuario, Cxc.Autorizacion, Cxc.Referencia, Cxc.Observaciones, Cxc.CtaDinero, Cxc.Condicion, Cxc.FormaCobro, Cxc.Importe, Cxc.Impuestos, Cxc.Retencion, Cxc.MovAplica, Cxc.MovAplicaID, Cxc.Origen, Cxc.OrigenID,CxcInfo.Vencimiento, CxcInfo.DiasMoratorios, CxcInfo.Saldo, 'ROJO2', Cxc.Moneda
			FROM CxcInfo, Cte, Cxc	
			WHERE CxcInfo.Cliente=Cte.Cliente AND
			   CxcInfo.ID = Cxc.Id AND
			   CxcInfo.Empresa=@Empresa AND 
			   ISNULL(CxcInfo.Vencimiento, '19010101') < GETDATE()  AND 
			   CxcInfo.Mov=@Mov AND
			   ISNULL(cxcInfo.Saldo,0) > 0

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Cxc', CxcInfo.Id, CxcInfo.Mov, CxcInfo.MovID, Cte.Cliente, Cte.Nombre, Cxc.FechaEmision, Cxc.Concepto, Cxc.Proyecto, Cxc.Uen, Cxc.TipoCambio, Cxc.Usuario, Cxc.Autorizacion, Cxc.Referencia, Cxc.Observaciones, Cxc.CtaDinero, Cxc.Condicion, Cxc.FormaCobro, Cxc.Importe, Cxc.Impuestos, Cxc.Retencion, Cxc.MovAplica, Cxc.MovAplicaID, Cxc.Origen, Cxc.OrigenID,CxcInfo.Vencimiento, CxcInfo.DiasMoratorios, CxcInfo.Saldo, 'AMARILLO2', Cxc.Moneda
			FROM CxcInfo, Cte, Cxc	
			WHERE CxcInfo.Cliente=Cte.Cliente AND
			   CxcInfo.ID = Cxc.Id AND
			   CxcInfo.Empresa=@Empresa AND 
			   ISNULL(CxcInfo.Vencimiento, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) AND 
			   CxcInfo.Mov=@Mov AND
			   ISNULL(cxcInfo.Saldo,0) > 0

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Cxc', CxcInfo.Id, CxcInfo.Mov, CxcInfo.MovID, Cte.Cliente, Cte.Nombre, Cxc.FechaEmision, Cxc.Concepto, Cxc.Proyecto, Cxc.Uen, Cxc.TipoCambio, Cxc.Usuario, Cxc.Autorizacion, Cxc.Referencia, Cxc.Observaciones, Cxc.CtaDinero, Cxc.Condicion, Cxc.FormaCobro, Cxc.Importe, Cxc.Impuestos, Cxc.Retencion, Cxc.MovAplica, Cxc.MovAplicaID, Cxc.Origen, Cxc.OrigenID,CxcInfo.Vencimiento, 
	CxcInfo.DiasMoratorios, CxcInfo.Saldo, 'VERDE2', Cxc.Moneda
			FROM CxcInfo, Cte, Cxc	
			WHERE CxcInfo.Cliente=Cte.Cliente AND
			   CxcInfo.ID = Cxc.Id AND
			   CxcInfo.Empresa=@Empresa AND 
			   ISNULL(CxcInfo.Vencimiento, '19010101') > DATEADD(DAY,2,GETDATE()) AND 
			   CxcInfo.Mov=@Mov AND
			   ISNULL(cxcInfo.Saldo,0) > 0
		END
    ELSE IF @Modulo = 'VTAS' AND @MovTipo = 'VTAS.C' 
	  BEGIN
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'ROJO2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta, Usuario
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
				Venta.Usuario = @Usuario AND
				Venta.Usuario = Usuario.Usuario AND
				VentaPendiente.Empresa=@Empresa AND
				VentaPendiente.MovTipo=@MovTipo AND 
				ISNULL(VentaPendiente.FechaRequerida, '19010101') < GETDATE()  AND 
				VentaPendiente.ID=Venta.ID AND
				ISNULL(VentaPendiente.Importe,0) > 0

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'AMARILLO2', Venta.Moneda
	 		FROM VentaPendiente, Cte, Venta, Usuario
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
			   Venta.Usuario = @Usuario AND
			   Venta.Usuario = Usuario.Usuario AND
			   VentaPendiente.Empresa=@Empresa AND
			   VentaPendiente.MovTipo=@MovTipo AND 
			   ISNULL(VentaPendiente.FechaRequerida, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) AND 
			   VentaPendiente.ID=Venta.ID  AND
			   ISNULL(VentaPendiente.Importe,0) > 0

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, 
						Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'VERDE2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta, Usuario
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
				Venta.Usuario = @Usuario AND
				Venta.Usuario = Usuario.Usuario AND
				VentaPendiente.Empresa=@Empresa AND
				VentaPendiente.MovTipo=@MovTipo AND 
				ISNULL(VentaPendiente.FechaRequerida, '19010101') > DATEADD(DAY,2,GETDATE()) AND 
				VentaPendiente.ID=Venta.ID AND
				ISNULL(VentaPendiente.Importe,0) > 0
		END
    ELSE IF @Modulo = 'VTAS' AND @MovTipo = 'VTAS.C' 
	  BEGIN
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'ROJO2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta, Usuario
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
				Venta.Usuario = Usuario.Usuario AND
				VentaPendiente.Empresa=@Empresa AND
				VentaPendiente.MovTipo=@MovTipo AND 
				ISNULL(VentaPendiente.FechaRequerida, '19010101') < GETDATE()  AND 
				VentaPendiente.ID=Venta.ID AND
				ISNULL(VentaPendiente.Importe,0) > 0

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'AMARILLO2', Venta.Moneda
	 		FROM VentaPendiente, Cte, Venta, Usuario
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
				Venta.Usuario = Usuario.Usuario AND
				VentaPendiente.Empresa=@Empresa AND
				VentaPendiente.MovTipo=@MovTipo AND 
				ISNULL(VentaPendiente.FechaRequerida, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) AND 
				VentaPendiente.ID=Venta.ID  AND
				ISNULL(VentaPendiente.Importe,0) > 0

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, 
	MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'VERDE2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta, Usuario
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
				Venta.Usuario = Usuario.Usuario AND
				VentaPendiente.Empresa=@Empresa AND
				VentaPendiente.MovTipo=@MovTipo AND 
				ISNULL(VentaPendiente.FechaRequerida, '19010101') > DATEADD(DAY,2,GETDATE()) AND 
				VentaPendiente.ID=Venta.ID AND
				ISNULL(VentaPendiente.Importe,0) > 0
		END
    ELSE IF @Modulo = 'VTAS' AND @MovTipo = 'VTAS.P' 
	  BEGIN
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'ROJO2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
				Venta.Usuario = @Usuario AND
				VentaPendiente.Empresa=@Empresa AND
				VentaPendiente.MovTipo=@MovTipo AND 
				ISNULL(VentaPendiente.FechaRequerida, '19010101') < GETDATE()  AND 
				VentaPendiente.ID=Venta.ID AND
				ISNULL(VentaPendiente.Importe,0) > 0 AND
				CAST(RTRIM(VentaPendiente.Mov) AS varchar(20))+VentaPendiente.MovID NOT IN (
					SELECT RTRIM(od.Destino)+od.DestinoID FROM Compra o, CompraD od, MovTipo omt 
					WHERE o.ID = od.ID AND omt.Mov = o.Mov AND omt.Clave like ('COMS.O%') AND o.Estatus = 'PENDIENTE' 
					AND od.Destino IS NOT NULL AND od.DestinoID IS NOT NULL )

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'AMARILLO2', Venta.Moneda
	 		FROM VentaPendiente, Cte, Venta
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
			   Venta.Usuario = @Usuario AND
			   VentaPendiente.Empresa=@Empresa AND
			   VentaPendiente.MovTipo=@MovTipo AND 
			   ISNULL(VentaPendiente.FechaRequerida, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) AND 
			   VentaPendiente.ID=Venta.ID  AND
			   ISNULL(VentaPendiente.Importe,0) > 0 AND
			   CAST(RTRIM(VentaPendiente.Mov) AS varchar(20))+VentaPendiente.MovID NOT IN (
					SELECT RTRIM(od.Destino)+od.DestinoID FROM Compra o, CompraD od, MovTipo omt 
					WHERE o.ID = od.ID AND omt.Mov = o.Mov AND omt.Clave like ('COMS.O%') AND o.Estatus = 'PENDIENTE' 
					AND od.Destino IS NOT NULL AND od.DestinoID IS NOT NULL )

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'VERDE2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
				Venta.Usuario = @Usuario AND
				VentaPendiente.Empresa=@Empresa AND
				VentaPendiente.MovTipo=@MovTipo AND 
				ISNULL(VentaPendiente.FechaRequerida, '19010101') > DATEADD(DAY,2,GETDATE()) AND 
				VentaPendiente.ID=Venta.ID AND
				ISNULL(VentaPendiente.Importe,0) > 0 AND
				CAST(RTRIM(VentaPendiente.Mov) AS varchar(20))+VentaPendiente.MovID NOT IN (
					SELECT RTRIM(od.Destino)+od.DestinoID FROM Compra o, CompraD od, MovTipo omt 
					WHERE o.ID = od.ID AND omt.Mov = o.Mov AND omt.Clave like ('COMS.O%') AND o.Estatus = 'PENDIENTE' 
					AND od.Destino IS NOT NULL AND od.DestinoID IS NOT NULL )
		END
    ELSE IF @Modulo = 'VTAS' AND @MovTipo = 'VTAS.P' AND @Grupo IN ('Direccion', 'Sistemas')	
	  BEGIN
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'ROJO2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
				VentaPendiente.Empresa=@Empresa AND
				VentaPendiente.MovTipo=@MovTipo AND 
				ISNULL(VentaPendiente.FechaRequerida, '19010101') < GETDATE()  AND 
				VentaPendiente.ID=Venta.ID AND
				ISNULL(VentaPendiente.Importe,0) > 0 AND
			    CAST(RTRIM(VentaPendiente.Mov) AS varchar(20))+VentaPendiente.MovID NOT IN (
					SELECT RTRIM(od.Destino)+od.DestinoID FROM Compra o, CompraD od, MovTipo omt 
					WHERE o.ID = od.ID AND omt.Mov = o.Mov AND omt.Clave like ('COMS.O%') AND o.Estatus = 'PENDIENTE' 
					AND od.Destino IS NOT NULL AND od.DestinoID IS NOT NULL )

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'AMARILLO2', Venta.Moneda
	 		FROM VentaPendiente, Cte, Venta
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
			   VentaPendiente.Empresa=@Empresa AND
			   VentaPendiente.MovTipo=@MovTipo AND 
			   ISNULL(VentaPendiente.FechaRequerida, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) AND 
			   VentaPendiente.ID=Venta.ID  AND
			   ISNULL(VentaPendiente.Importe,0) > 0 AND
			   CAST(RTRIM(VentaPendiente.Mov) AS varchar(20))+VentaPendiente.MovID NOT IN (
					SELECT RTRIM(od.Destino)+od.DestinoID FROM Compra o, CompraD od, MovTipo omt 
					WHERE o.ID = od.ID AND omt.Mov = o.Mov AND omt.Clave like ('COMS.O%') AND o.Estatus = 'PENDIENTE' 
					AND od.Destino IS NOT NULL AND od.DestinoID IS NOT NULL )

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'VERDE2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
				VentaPendiente.Empresa=@Empresa AND
				VentaPendiente.MovTipo=@MovTipo AND 
				ISNULL(VentaPendiente.FechaRequerida, '19010101') > DATEADD(DAY,2,GETDATE()) AND 
				VentaPendiente.ID=Venta.ID AND
				ISNULL(VentaPendiente.Importe,0) > 0 AND
			    CAST(RTRIM(VentaPendiente.Mov) AS varchar(20))+VentaPendiente.MovID NOT IN (
					SELECT RTRIM(od.Destino)+od.DestinoID FROM Compra o, CompraD od, MovTipo omt 
					WHERE o.ID = od.ID AND omt.Mov = o.Mov AND omt.Clave like ('COMS.O%') AND o.Estatus = 'PENDIENTE' 
					AND od.Destino IS NOT NULL AND od.DestinoID IS NOT NULL )
		END
    ELSE IF @Modulo = 'VTAS' AND @MovTipo = 'VTAS.S' 
	  BEGIN
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'ROJO2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
			   VentaPendiente.ID = Venta.ID AND
			   Venta.Usuario = @Usuario AND
			   VentaPendiente.Empresa=@Empresa AND
			   ISNULL(VentaPendiente.FechaRequerida, '19010101') < GETDATE()  AND 
			   VentaPendiente.MovTipo=@MovTipo AND 
			   VentaPendiente.Estatus='CONFIRMAR'

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'AMARILLO2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
			   VentaPendiente.ID = Venta.ID AND
			   Venta.Usuario = @Usuario AND
			   VentaPendiente.Empresa=@Empresa AND
			   ISNULL(VentaPendiente.FechaRequerida, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) AND 
			   VentaPendiente.MovTipo=@MovTipo AND 
			   VentaPendiente.Estatus='CONFIRMAR'

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'VERDE2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
			   VentaPendiente.ID = Venta.ID AND
			   Venta.Usuario = @Usuario AND
			   VentaPendiente.Empresa=@Empresa AND
			   ISNULL(VentaPendiente.FechaRequerida, '19010101') > DATEADD(DAY,2,GETDATE()) AND 
			   VentaPendiente.MovTipo=@MovTipo AND 
			   VentaPendiente.Estatus='CONFIRMAR'
		END
    ELSE IF @Modulo = 'VTAS' AND @MovTipo = 'VTAS.S' 
	  BEGIN
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'ROJO2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
			   VentaPendiente.ID = Venta.ID AND
			   VentaPendiente.Empresa=@Empresa AND
			   ISNULL(VentaPendiente.FechaRequerida, '19010101') < GETDATE()  AND 
			   VentaPendiente.MovTipo=@MovTipo AND 
			   VentaPendiente.Estatus='CONFIRMAR' 

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'AMARILLO2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
			   VentaPendiente.ID = Venta.ID AND
			   VentaPendiente.Empresa=@Empresa AND
			   ISNULL(VentaPendiente.FechaRequerida, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) AND 
			   VentaPendiente.MovTipo=@MovTipo AND 
			   VentaPendiente.Estatus='CONFIRMAR' 

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Venta', VentaPendiente.Id, VentaPendiente.Mov, VentaPendiente.MovID, Cte.Cliente, Cte.Nombre, Venta.FechaEmision, Venta.Concepto, Venta.Proyecto, Venta.Uen, Venta.TipoCambio, Venta.Usuario, Venta.Autorizacion, Venta.Referencia, Venta.Observaciones, Venta.CtaDinero, Venta.Condicion, NULL, Venta.Importe, Venta.Impuestos, Venta.Retencion, NULL, NULL, Venta.Origen, Venta.OrigenID, VentaPendiente.FechaRequerida, DATEDIFF(dd,VentaPendiente.FechaEmision,VentaPendiente.FechaRequerida), VentaPendiente.Saldo, 'VERDE2', Venta.Moneda
			FROM VentaPendiente, Cte, Venta
			WHERE VentaPendiente.Cliente=Cte.Cliente AND
			   VentaPendiente.ID = Venta.ID AND
			   VentaPendiente.Empresa=@Empresa AND
			   ISNULL(VentaPendiente.FechaRequerida, '19010101') > DATEADD(DAY,2,GETDATE()) AND 
			   VentaPendiente.MovTipo=@MovTipo AND 
			   VentaPendiente.Estatus='CONFIRMAR'
		END
    ELSE IF @Modulo = 'CXP'  
	  BEGIN
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Cxp', CxpInfo.Id, CxpInfo.Mov, CxpInfo.MovID, Prov.Proveedor, Prov.Nombre, Cxp.FechaEmision, Cxp.Concepto, Cxp.Proyecto, Cxp.Uen, Cxp.TipoCambio, Cxp.Usuario, Cxp.Autorizacion, Cxp.Referencia, Cxp.Observaciones, Cxp.CtaDinero, Cxp.Condicion, Cxp.FormaPago, Cxp.Importe, Cxp.Impuestos, Cxp.Retencion, Cxp.MovAplica, Cxp.MovAplicaID, Cxp.Origen, Cxp.OrigenID, CxpInfo.Vencimiento, CxpInfo.DiasMoratorios, CxpInfo.Saldo, 'ROJO2', Cxp.Moneda
			FROM CxpInfo, Prov, Cxp
			WHERE CxpInfo.Proveedor=Prov.Proveedor AND
			   CxpInfo.ID = Cxp.ID AND
			   Cxp.Usuario = @Usuario AND
			   CxpInfo.Empresa=@Empresa AND 
			   ISNULL(CxpInfo.Vencimiento, '19010101') < GETDATE()  AND 
			   CxpInfo.Mov IN ('Entrada Compra',  'Importacion')

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Cxp', CxpInfo.Id, CxpInfo.Mov, CxpInfo.MovID, Prov.Proveedor, Prov.Nombre, Cxp.FechaEmision, Cxp.Concepto, Cxp.Proyecto, Cxp.Uen, Cxp.TipoCambio, Cxp.Usuario, Cxp.Autorizacion, Cxp.Referencia, Cxp.Observaciones, Cxp.CtaDinero, Cxp.Condicion, Cxp.FormaPago, Cxp.Importe, Cxp.Impuestos, Cxp.Retencion, Cxp.MovAplica, Cxp.MovAplicaID, Cxp.Origen, Cxp.OrigenID, CxpInfo.Vencimiento, CxpInfo.DiasMoratorios, CxpInfo.Saldo, 'AMARILLO2', Cxp.Moneda
			FROM CxpInfo, Prov, Cxp
			WHERE CxpInfo.Proveedor=Prov.Proveedor AND
			   CxpInfo.ID = Cxp.ID AND
			   Cxp.Usuario = @Usuario AND
			   CxpInfo.Empresa=@Empresa AND 
			   ISNULL(CxpInfo.Vencimiento, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) AND 
			   CxpInfo.Mov IN ('Entrada Compra',  'Importacion')
    
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Cxp', CxpInfo.Id, CxpInfo.Mov, CxpInfo.MovID, Prov.Proveedor, Prov.Nombre, Cxp.FechaEmision, Cxp.Concepto, Cxp.Proyecto, Cxp.Uen, Cxp.TipoCambio, Cxp.Usuario, Cxp.Autorizacion, Cxp.Referencia, Cxp.Observaciones, Cxp.CtaDinero, Cxp.Condicion, Cxp.FormaPago, Cxp.Importe, Cxp.Impuestos, Cxp.Retencion, Cxp.MovAplica, Cxp.MovAplicaID, Cxp.Origen, Cxp.OrigenID, CxpInfo.Vencimiento, CxpInfo.DiasMoratorios, CxpInfo.Saldo, 'VERDE2', Cxp.Moneda
			FROM CxpInfo, Prov, Cxp
			WHERE CxpInfo.Proveedor=Prov.Proveedor AND
			   CxpInfo.ID = Cxp.ID AND
			   Cxp.Usuario = @Usuario AND
			   CxpInfo.Empresa=@Empresa AND 
			   ISNULL(CxpInfo.Vencimiento, '19010101') > DATEADD(DAY,2,GETDATE()) AND 
			   CxpInfo.Mov IN ('Entrada Compra',  'Importacion')
		END
    ELSE IF @Modulo = 'CXP'  AND @Grupo IN ('Direccion', 'Sistemas')
	  BEGIN
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Cxp', CxpInfo.Id, CxpInfo.Mov, CxpInfo.MovID, Prov.Proveedor, Prov.Nombre, Cxp.FechaEmision, Cxp.Concepto, Cxp.Proyecto, Cxp.Uen, Cxp.TipoCambio, Cxp.Usuario, Cxp.Autorizacion, Cxp.Referencia, Cxp.Observaciones, Cxp.CtaDinero, Cxp.Condicion, Cxp.FormaPago, Cxp.Importe, Cxp.Impuestos, Cxp.Retencion, Cxp.MovAplica, Cxp.MovAplicaID, Cxp.Origen, Cxp.OrigenID, CxpInfo.Vencimiento, CxpInfo.DiasMoratorios, CxpInfo.Saldo, 'ROJO2', Cxp.Moneda
			FROM CxpInfo, Prov, Cxp
			WHERE CxpInfo.Proveedor=Prov.Proveedor AND
			   CxpInfo.ID = Cxp.ID AND
			   CxpInfo.Empresa=@Empresa AND 
			   ISNULL(CxpInfo.Vencimiento, '19010101') < GETDATE()  AND 
			   CxpInfo.Mov IN ('Entrada Compra',  'Importacion')

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Cxp', CxpInfo.Id, CxpInfo.Mov, CxpInfo.MovID, Prov.Proveedor, Prov.Nombre, Cxp.FechaEmision, Cxp.Concepto, Cxp.Proyecto, Cxp.Uen, Cxp.TipoCambio, Cxp.Usuario, Cxp.Autorizacion, Cxp.Referencia, Cxp.Observaciones, Cxp.CtaDinero, Cxp.Condicion, Cxp.FormaPago, Cxp.Importe, Cxp.Impuestos, Cxp.Retencion, Cxp.MovAplica, Cxp.MovAplicaID, Cxp.Origen, Cxp.OrigenID, CxpInfo.Vencimiento, CxpInfo.DiasMoratorios, CxpInfo.Saldo, 'AMARILLO2', Cxp.Moneda
			FROM CxpInfo, Prov, Cxp
			WHERE CxpInfo.Proveedor=Prov.Proveedor AND
			   CxpInfo.ID = Cxp.ID AND
			   CxpInfo.Empresa=@Empresa AND 
			   ISNULL(CxpInfo.Vencimiento, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) AND 
			   CxpInfo.Mov IN ('Entrada Compra',  'Importacion')
    
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT 'Cxp', CxpInfo.Id, CxpInfo.Mov, CxpInfo.MovID, Prov.Proveedor, Prov.Nombre, Cxp.FechaEmision, Cxp.Concepto, Cxp.Proyecto, Cxp.Uen, Cxp.TipoCambio, Cxp.Usuario, Cxp.Autorizacion, Cxp.Referencia, Cxp.Observaciones, Cxp.CtaDinero, Cxp.Condicion, Cxp.FormaPago, Cxp.Importe, Cxp.Impuestos, Cxp.Retencion, Cxp.MovAplica, Cxp.MovAplicaID, Cxp.Origen, Cxp.OrigenID, CxpInfo.Vencimiento, CxpInfo.DiasMoratorios, CxpInfo.Saldo, 'VERDE2', Cxp.Moneda
			FROM CxpInfo, Prov, Cxp
			WHERE CxpInfo.Proveedor=Prov.Proveedor AND
			   CxpInfo.ID = Cxp.ID AND
			   CxpInfo.Empresa=@Empresa AND 
			   ISNULL(CxpInfo.Vencimiento, '19010101') > DATEADD(DAY,2,GETDATE()) AND 
			   CxpInfo.Mov IN ('Entrada Compra',  'Importacion')
		END
    ELSE IF @Modulo = 'COMS' 
	  BEGIN  
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT DISTINCT 'Compra', CompraPendiente.Id, CompraPendiente.Mov, CompraPendiente.MovID, Prov.Proveedor, Prov.Nombre, Compra.FechaEmision, Compra.Concepto, Compra.Proyecto, Compra.Uen, Compra.TipoCambio, Compra.Usuario, Compra.Autorizacion, Compra.Referencia, Compra.Observaciones, NULL, Compra.Condicion, NULL, Compra.Importe, Compra.Impuestos, NULL, NULL, NULL, CompraD.Destino+Space(2)+CompraD.DestinoID, NULL, CompraPendiente.FechaRequerida, DATEDIFF(dd,CompraPendiente.FechaEmision,CompraPendiente.FechaRequerida), CompraPendiente.Saldo, 'ROJO2', Compra.Moneda
			FROM CompraPendiente, Compra,Comprad, Prov
			WHERE CompraPendiente.Empresa= @Empresa AND 
			   Compra.ID = Comprad.ID AND
			   CompraPendiente.ID = Compra.ID AND
			   Compra.Proveedor=Prov.Proveedor AND
			   Compra.Usuario = @Usuario AND
			   CompraPendiente.Clave LIKE ('COMS.O%') AND
			   ISNULL(CompraPendiente.FechaRequerida, '19010101') < GETDATE()  AND 
			   CompraPendiente.Saldo > 0

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT DISTINCT 'Compra', CompraPendiente.Id, CompraPendiente.Mov, CompraPendiente.MovID, Prov.Proveedor, Prov.Nombre, Compra.FechaEmision, Compra.Concepto, Compra.Proyecto, Compra.Uen, Compra.TipoCambio, Compra.Usuario, Compra.Autorizacion, Compra.Referencia, Compra.Observaciones, NULL, Compra.Condicion, NULL, Compra.Importe, Compra.Impuestos, NULL, NULL, NULL, CompraD.Destino+Space(2)+CompraD.DestinoID, NULL, CompraPendiente.FechaRequerida, DATEDIFF(dd,CompraPendiente.FechaEmision,CompraPendiente.FechaRequerida), CompraPendiente.Saldo, 'AMARILLO2', Compra.Moneda
			FROM CompraPendiente, Compra, Comprad, Prov
			WHERE CompraPendiente.Empresa= @Empresa AND 
			   Compra.ID = Comprad.ID AND
			   CompraPendiente.ID = Compra.ID AND
			   Compra.Proveedor=Prov.Proveedor AND
			   Compra.Usuario = @Usuario AND
			   CompraPendiente.Clave LIKE ('COMS.O%') AND
			   ISNULL(CompraPendiente.FechaRequerida, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) AND  
			   CompraPendiente.Saldo > 0

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT DISTINCT 'Compra', CompraPendiente.Id, CompraPendiente.Mov, CompraPendiente.MovID, Prov.Proveedor, Prov.Nombre, Compra.FechaEmision, Compra.Concepto, Compra.Proyecto, Compra.Uen, Compra.TipoCambio, Compra.Usuario, Compra.Autorizacion, Compra.Referencia, Compra.Observaciones, NULL, Compra.Condicion, NULL, Compra.Importe, Compra.Impuestos, NULL, NULL, NULL, Comprad.Destino+Space(2)+CompraD.DestinoID, NULL, CompraPendiente.FechaRequerida, DATEDIFF(dd,CompraPendiente.FechaEmision,CompraPendiente.FechaRequerida), CompraPendiente.Saldo, 'VERDE2', Compra.Moneda
			FROM CompraPendiente, Compra, Comprad, Prov
			WHERE CompraPendiente.Empresa= @Empresa AND 
			   Compra.ID = Comprad.ID AND
			   CompraPendiente.ID = Compra.ID AND
			   Compra.Proveedor=Prov.Proveedor AND
			   Compra.Usuario = @Usuario AND
			   CompraPendiente.Clave LIKE ('COMS.O%') AND
			   ISNULL(CompraPendiente.FechaRequerida, '19010101') > DATEADD(DAY,2,GETDATE()) AND 
			   CompraPendiente.Saldo > 0
		END
    ELSE IF @Modulo = 'COMS' 
	  BEGIN
			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT DISTINCT 'Compra', CompraPendiente.Id, CompraPendiente.Mov, CompraPendiente.MovID, Prov.Proveedor, Prov.Nombre, Compra.FechaEmision, Compra.Concepto, Compra.Proyecto, Compra.Uen, Compra.TipoCambio, Compra.Usuario, Compra.Autorizacion, Compra.Referencia, Compra.Observaciones, NULL, Compra.Condicion, NULL, Compra.Importe, Compra.Impuestos, NULL, NULL, NULL, Comprad.Destino+Space(2)+CompraD.DestinoID, NULL, CompraPendiente.FechaRequerida, DATEDIFF(dd,CompraPendiente.FechaEmision,CompraPendiente.FechaRequerida), CompraPendiente.Saldo, 'ROJO2', Compra.Moneda
			FROM CompraPendiente, Compra, Comprad, Prov
			WHERE CompraPendiente.Empresa= @Empresa AND
			   Compra.ID = Comprad.ID AND
			   CompraPendiente.ID = Compra.ID AND
			   Compra.Proveedor=Prov.Proveedor AND
			   CompraPendiente.Clave LIKE ('COMS.O%') AND
			   ISNULL(CompraPendiente.FechaRequerida, '19010101') < GETDATE()  AND 
			   CompraPendiente.Saldo > 0

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT DISTINCT 'Compra', CompraPendiente.Id, CompraPendiente.Mov, CompraPendiente.MovID, Prov.Proveedor, Prov.Nombre, Compra.FechaEmision, Compra.Concepto, Compra.Proyecto, Compra.Uen, Compra.TipoCambio, Compra.Usuario, Compra.Autorizacion, Compra.Referencia, Compra.Observaciones, NULL, Compra.Condicion, NULL, Compra.Importe, Compra.Impuestos, NULL, NULL, NULL, Comprad.Destino+Space(2)+CompraD.DestinoID, NULL, CompraPendiente.FechaRequerida, DATEDIFF(dd,CompraPendiente.FechaEmision,CompraPendiente.FechaRequerida), CompraPendiente.Saldo, 'AMARILLO2', Compra.Moneda
			FROM CompraPendiente, Compra, Comprad, Prov
			WHERE CompraPendiente.Empresa= @Empresa AND 
			   Compra.ID = Comprad.ID AND
			   CompraPendiente.ID = Compra.ID AND
			   Compra.Proveedor=Prov.Proveedor AND
			   CompraPendiente.Clave LIKE ('COMS.O%') AND
			   ISNULL(CompraPendiente.FechaRequerida, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) AND  
			   CompraPendiente.Saldo > 0

			INSERT INTO ResumenGerencialDetalle 
						(Modulo, ID, Mov, MovID, Cliente, Nombre, FechaEmision, Concepto, Proyecto, Uen, TipoCambio, Usuario, Autorizacion, Referencia, Observaciones, CtaDinero, Condicion, FormaCobro, Importe, Impuestos, Retencion, MovAplica, MovAplicaID, Origen, OrigenID, Vencimiento, DiasMoratorios, Saldo, Estatus, Moneda)
			SELECT DISTINCT 'Compra', CompraPendiente.Id, CompraPendiente.Mov, CompraPendiente.MovID, Prov.Proveedor, Prov.Nombre, Compra.FechaEmision, Compra.Concepto, Compra.Proyecto, Compra.Uen, Compra.TipoCambio, Compra.Usuario, Compra.Autorizacion, Compra.Referencia, Compra.Observaciones, NULL, Compra.Condicion, NULL, Compra.Importe, Compra.Impuestos, NULL, NULL, NULL, Comprad.Destino+Space(2)+CompraD.DestinoID, NULL, CompraPendiente.FechaRequerida, DATEDIFF(dd,CompraPendiente.FechaEmision,CompraPendiente.FechaRequerida), CompraPendiente.Saldo, 'VERDE2', Compra.Moneda
			FROM CompraPendiente, Compra, Comprad, Prov
			WHERE CompraPendiente.Empresa= @Empresa AND 
			   Compra.ID = Comprad.ID AND
			   CompraPendiente.ID = Compra.ID AND
			   Compra.Proveedor=Prov.Proveedor AND
			   CompraPendiente.Clave LIKE ('COMS.O%') AND
			   ISNULL(CompraPendiente.FechaRequerida, '19010101') > DATEADD(DAY,2,GETDATE()) AND 
			   CompraPendiente.Saldo > 0
		END
    ELSE IF @Modulo = 'Soporte' 
	  BEGIN
			INSERT INTO ResumenGerencialDetalle 
			SELECT 'Soporte', Soporte.Id, Soporte.Mov, Soporte.MovID, Cte.Cliente, Cte.Nombre, Soporte.FechaEmision, Soporte.Concepto, Soporte.Proyecto, Soporte.Uen, NULL, Soporte.Usuario, Soporte.Autorizacion, Soporte.Referencia, Soporte.Observaciones, NULL, NULL, NULL, Soporte.Importe, NULL, NULL, NULL, NULL, Soporte.Origen, Soporte.OrigenID, Soporte.FechaRequerida, DATEDIFF(dd,Soporte.FechaEmision,Soporte.FechaRequerida), Soporte.Importe, 'ROJO2', NULL
			FROM
					Soporte
					LEFT OUTER JOIN Cte ON Soporte.Cliente = Cte.Cliente
					LEFT OUTER JOIN Agente ON Soporte.Agente = Agente.Agente
					LEFT OUTER JOIN Prov ON Soporte.Proveedor = Prov.Proveedor
					LEFT OUTER JOIN Personal ON Soporte.Personal = Personal.Personal
					LEFT OUTER JOIN Proy ON Soporte.Proyecto = Proy.Proyecto
					LEFT OUTER JOIN Rep ON Soporte.Reporte = Rep.Reporte
					JOIN Usuario UsuarioRelacion ON Soporte.Usuario=UsuarioRelacion.Usuario
			WHERE Soporte.Empresa = @Empresa AND 
					   Soporte.Estatus = 'PENDIENTE' AND
					   Soporte.Usuario=@Usuario AND
					   ISNULL(Soporte.Vencimiento, '19010101') < GETDATE()  

			INSERT INTO ResumenGerencialDetalle 
			SELECT 'Soporte', Soporte.Id, Soporte.Mov, Soporte.MovID, Cte.Cliente, Cte.Nombre, Soporte.FechaEmision, Soporte.Concepto, Soporte.Proyecto, Soporte.Uen, NULL, Soporte.Usuario, Soporte.Autorizacion, Soporte.Referencia, Soporte.Observaciones, NULL, NULL, NULL, Soporte.Importe, NULL, NULL, NULL, NULL, Soporte.Origen, Soporte.OrigenID, Soporte.FechaRequerida, DATEDIFF(dd,Soporte.FechaEmision,Soporte.FechaRequerida), Soporte.Importe, 'AMARILLO2', NULL
			FROM
					   Soporte
					   LEFT OUTER JOIN Cte ON Soporte.Cliente = Cte.Cliente
					   LEFT OUTER JOIN Agente ON Soporte.Agente = Agente.Agente
					   LEFT OUTER JOIN Prov ON Soporte.Proveedor = Prov.Proveedor
					   LEFT OUTER JOIN Personal ON Soporte.Personal = Personal.Personal
					   LEFT OUTER JOIN Proy ON Soporte.Proyecto = Proy.Proyecto
					   LEFT OUTER JOIN Rep ON Soporte.Reporte = Rep.Reporte
					   JOIN Usuario UsuarioRelacion ON Soporte.Usuario=UsuarioRelacion.Usuario
			WHERE Soporte.Empresa = @Empresa AND 
					   Soporte.Estatus = 'PENDIENTE' AND
					   Soporte.Usuario=@Usuario AND
				   		  ISNULL(Soporte.Vencimiento, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) 

			INSERT INTO ResumenGerencialDetalle 
			SELECT 'Soporte', Soporte.Id, Soporte.Mov, Soporte.MovID, Cte.Cliente, Cte.Nombre, Soporte.FechaEmision, Soporte.Concepto, Soporte.Proyecto, Soporte.Uen, NULL, Soporte.Usuario, Soporte.Autorizacion, Soporte.Referencia, Soporte.Observaciones, NULL, NULL, NULL, Soporte.Importe, NULL, NULL, NULL, NULL, Soporte.Origen, Soporte.OrigenID, Soporte.FechaRequerida, DATEDIFF(dd,Soporte.FechaEmision,Soporte.FechaRequerida), Soporte.Importe, 'VERDE2', NULL
			FROM
					   Soporte
					   LEFT OUTER JOIN Cte ON Soporte.Cliente = Cte.Cliente
					   LEFT OUTER JOIN Agente ON Soporte.Agente = Agente.Agente
					   LEFT OUTER JOIN Prov ON Soporte.Proveedor = Prov.Proveedor
					   LEFT OUTER JOIN Personal ON Soporte.Personal = Personal.Personal
					   LEFT OUTER JOIN Proy ON Soporte.Proyecto = Proy.Proyecto
					   LEFT OUTER JOIN Rep ON Soporte.Reporte = Rep.Reporte
					   JOIN Usuario UsuarioRelacion ON Soporte.Usuario=UsuarioRelacion.Usuario
			WHERE Soporte.Empresa = @Empresa AND 
					   Soporte.Estatus = 'PENDIENTE' AND
					   Soporte.Usuario=@Usuario AND
					   ISNULL(Soporte.Vencimiento, '19010101') > DATEADD(DAY,2,GETDATE()) 

		END
    ELSE IF @Modulo = 'Soporte'
	  BEGIN
			INSERT INTO ResumenGerencialDetalle 
			SELECT 'Soporte', Soporte.Id, Soporte.Mov, Soporte.MovID, Cte.Cliente, Cte.Nombre, Soporte.FechaEmision, Soporte.Concepto, Soporte.Proyecto, Soporte.Uen, NULL, Soporte.Usuario, Soporte.Autorizacion, Soporte.Referencia, Soporte.Observaciones, NULL, NULL, NULL, Soporte.Importe, NULL, NULL, NULL, NULL, Soporte.Origen, Soporte.OrigenID, Soporte.FechaRequerida, DATEDIFF(dd,Soporte.FechaEmision,Soporte.FechaRequerida), Soporte.Importe, 'ROJO2', NULL
			FROM
					   Soporte
					   LEFT OUTER JOIN Cte ON Soporte.Cliente = Cte.Cliente
					   LEFT OUTER JOIN Agente ON Soporte.Agente = Agente.Agente
					   LEFT OUTER JOIN Prov ON Soporte.Proveedor = Prov.Proveedor
					   LEFT OUTER JOIN Personal ON Soporte.Personal = Personal.Personal
					   LEFT OUTER JOIN Proy ON Soporte.Proyecto = Proy.Proyecto
					   LEFT OUTER JOIN Rep ON Soporte.Reporte = Rep.Reporte
					   JOIN Usuario UsuarioRelacion ON Soporte.Usuario=UsuarioRelacion.Usuario
			WHERE Soporte.Empresa = @Empresa AND 
					   Soporte.Estatus = 'PENDIENTE' AND 
					   ISNULL(Soporte.Vencimiento, '19010101') < GETDATE()  

			INSERT INTO ResumenGerencialDetalle 
			SELECT 'Soporte', Soporte.Id, Soporte.Mov, Soporte.MovID, Cte.Cliente, Cte.Nombre, Soporte.FechaEmision, Soporte.Concepto, Soporte.Proyecto, Soporte.Uen, NULL, Soporte.Usuario, Soporte.Autorizacion, Soporte.Referencia, Soporte.Observaciones, NULL, NULL, NULL, Soporte.Importe, NULL, NULL, NULL, NULL, Soporte.Origen, Soporte.OrigenID, Soporte.FechaRequerida, 
						DATEDIFF(dd,Soporte.FechaEmision,Soporte.FechaRequerida), Soporte.Importe, 'AMARILLO2', NULL
			FROM
					   Soporte
					   LEFT OUTER JOIN Cte ON Soporte.Cliente = Cte.Cliente
					   LEFT OUTER JOIN Agente ON Soporte.Agente = Agente.Agente
					   LEFT OUTER JOIN Prov ON Soporte.Proveedor = Prov.Proveedor
					   LEFT OUTER JOIN Personal ON Soporte.Personal = Personal.Personal
					   LEFT OUTER JOIN Proy ON Soporte.Proyecto = Proy.Proyecto
					   LEFT OUTER JOIN Rep ON Soporte.Reporte = Rep.Reporte
					   JOIN Usuario UsuarioRelacion ON Soporte.Usuario=UsuarioRelacion.Usuario
			WHERE Soporte.Empresa = @Empresa AND 
					   Soporte.Estatus = 'PENDIENTE' AND
					   ISNULL(Soporte.Vencimiento, '19010101') BETWEEN GETDATE() AND DATEADD(DAY,2,GETDATE()) 

			INSERT INTO ResumenGerencialDetalle 
			SELECT 'Soporte', Soporte.Id, Soporte.Mov, Soporte.MovID, Cte.Cliente, Cte.Nombre, Soporte.FechaEmision, Soporte.Concepto, Soporte.Proyecto, Soporte.Uen, NULL, Soporte.Usuario, Soporte.Autorizacion, Soporte.Referencia, Soporte.Observaciones, NULL, NULL, NULL, Soporte.Importe, NULL, NULL, NULL, NULL, Soporte.Origen, Soporte.OrigenID, Soporte.FechaRequerida, DATEDIFF(dd,Soporte.FechaEmision,Soporte.FechaRequerida), Soporte.Importe, 'VERDE2', NULL
			FROM
					   Soporte
					   LEFT OUTER JOIN Cte ON Soporte.Cliente = Cte.Cliente
					   LEFT OUTER JOIN Agente ON Soporte.Agente = Agente.Agente
					   LEFT OUTER JOIN Prov ON Soporte.Proveedor = Prov.Proveedor
					   LEFT OUTER JOIN Personal ON Soporte.Personal = Personal.Personal
					   LEFT OUTER JOIN Proy ON Soporte.Proyecto = Proy.Proyecto
					   LEFT OUTER JOIN Rep ON Soporte.Reporte = Rep.Reporte
					   JOIN Usuario UsuarioRelacion ON Soporte.Usuario=UsuarioRelacion.Usuario
			WHERE Soporte.Empresa = @Empresa AND 
					   Soporte.Estatus = 'PENDIENTE' AND
					   ISNULL(Soporte.Vencimiento, '19010101') > DATEADD(DAY,2,GETDATE()) 
		END
END
GO


/**************** spPOSProrrateoFecha ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSProrrateoFecha') and type = 'P') DROP PROCEDURE dbo.spPOSProrrateoFecha
GO             
CREATE PROCEDURE spPOSProrrateoFecha
	@Estacion		int,
	@Total			float,
	@Fecha			datetime,
	@Periodicidad	char(20),
	@Veces			int			
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @Cantidad				float,
    @Dia					int,
    @PrimerVencimiento		datetime,
    @EsQuince				int
    
    SELECT @Dia = DATEPART(dd, @Fecha)
    
	IF @Dia <= 15 
		SELECT @EsQuince = 1, @Fecha = DATEADD(dd, 15 - @Dia, @Fecha)
    ELSE 
		SELECT @EsQuince = 0, @Fecha = DATEADD(dd, -DATEPART(dd, @Fecha), DATEADD(mm, 1, @Fecha))

	IF NULLIF(@Veces, 0) IS NULL OR @Veces > 300 
		RETURN
	
	DELETE ProrrateoFecha WHERE Estacion = @Estacion
	
	SELECT @Cantidad = @Total/NULLIF(@Veces, 0)
	WHILE ROUND(@Total, 10) > 0 
		BEGIN
			INSERT ProrrateoFecha (Estacion, Cantidad, Fecha) VALUES (@Estacion, @Cantidad, @Fecha)
			SELECT @Total = @Total - @Cantidad
			
			IF @Periodicidad = 'QUINCENAL' 
				EXEC spCalcularPeriodicidad @Fecha, @Periodicidad, @Fecha OUTPUT, NULL, NULL,0
			BEGIN
				IF DATEPART(dd, @Fecha) = 01
					SELECT @Fecha = DATEADD(dd, 14, @Fecha)

				IF DATEPART(dd, @Fecha) = 16
					SELECT @Fecha = DATEADD(dd, DATEDIFF(DD, @Fecha, CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,@Fecha))),DATEADD(mm,1,@Fecha)))), @Fecha)
			END    
	  END  
	RETURN
END
GO


/**************** fnPOSValidarCteExpress ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidarCteExpress') DROP FUNCTION fnPOSValidarCteExpress
GO
CREATE FUNCTION dbo.fnPOSValidarCteExpress (
	@RFC	varchar(15)
) 
RETURNS int
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado  int
    
	SET @Resultado = NULL 
	IF EXISTS(SELECT * FROM Cte WHERE RFC = @RFC AND @RFC NOT IN ('XAXX010101000', 'XEXX010101000'))
		SELECT @Resultado = 1
  
	RETURN (@Resultado)
 END
GO


/**************** fnPOSGenerarTicket****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSGenerarTicket') DROP FUNCTION fnPOSGenerarTicket
GO
CREATE FUNCTION dbo.fnPOSGenerarTicket (
    @Cadena		varchar(max),
    @Caracter	nvarchar(20)
)
RETURNS @Tabla TABLE 
(
    ID		int IDENTITY(1,1),
    Campo	varchar(max)
) 
--//WITH ENCRYPTION
AS
BEGIN 
    DECLARE 
    @Contador int,
    @Posicion int
    
    SET @Contador = 1
    SET @Posicion = CHARINDEX(@Caracter,@Cadena)

    WHILE (@Posicion>0)
    BEGIN
        INSERT INTO @Tabla (Campo)
        SELECT 
            Campo = RTRIM(SUBSTRING(@Cadena, 1, @Posicion - 1))

        SET @Cadena = SUBSTRING(@Cadena, @Posicion + DATALENGTH(@Caracter) / 2, LEN(@Cadena))

        SET @Contador = @Contador + 1
        SET @Posicion = CHARINDEX(@Caracter, @Cadena)
    END
    
    INSERT intO @Tabla (Campo)
    SELECT Campo = LTRIM(RTRIM(@Cadena))

    RETURN
END 
GO


 /**************** fnPOSCalcDescuentosVenta ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSCalcDescuentosVenta') DROP FUNCTION fnPOSCalcDescuentosVenta
GO
CREATE FUNCTION dbo.fnPOSCalcDescuentosVenta (
	@DescuentoGlobal   float,
 	@DescuentoLineal   float
) 
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  float

	SELECT  @Resultado =ROUND(100 - ((100-ISNULL(@DescuentoGlobal,0.0))/100 * (100-ISNULL(@DescuentoLineal,0.0))/100) * 100, 10)

	RETURN (@Resultado)
 END
GO


/**************** fnPOSRedondeoMonetarios****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSRedondeoMonetarios') DROP FUNCTION fnPOSRedondeoMonetarios
GO
CREATE FUNCTION dbo.fnPOSRedondeoMonetarios (
	@Empresa  varchar(5)
) 
RETURNS int
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado  int
    
	SELECT @Resultado = RedondeosMonetarios 
	FROM POSCfg 
	WHERE Empresa = @Empresa   
	
	SELECT @Resultado = ISNULL(@Resultado,2)

	RETURN (@Resultado)
END
GO


/**************** fnPOSTipoCambio ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSTipoCambio') DROP FUNCTION fnPOSTipoCambio
GO
CREATE FUNCTION fnPOSTipoCambio (
	@Moneda		varchar(10),
	@Sucursal	int
)
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @TipoCambio	float

	SELECT @TipoCambio = TipoCambio 
	FROM POSLTipoCambioRef 
	WHERE Moneda = @Moneda AND Sucursal = @Sucursal
  
	IF @TipoCambio IS NULL
		SELECT @TipoCambio = TipoCambio 
		FROM Mon 
		WHERE Moneda = @Moneda
  
	RETURN (@TipoCambio)
END
GO


/**************** fnPOSImporteAMoneda ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSImporteAMoneda') DROP FUNCTION fnPOSImporteAMoneda
GO
CREATE FUNCTION fnPOSImporteAMoneda (
	@Importe			float,
	@ImporteTipoCambio	float,
	@MonedaDestino		varchar(10),
	@Sucursal           int
)	
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @ImporteDestino				float,
    @TipoCambioDestino			float
    
	SET @ImporteDestino = NULL
  
	SET @TipoCambioDestino = dbo.fnPOSTipoCambio(@MonedaDestino,@Sucursal)  
  
	IF @TipoCambioDestino IS NOT NULL
		SET @ImporteDestino = (@Importe*@ImporteTipoCambio)/@TipoCambioDestino
  
	RETURN (@ImporteDestino)
END
GO


/**************** fnImporteMonTarjeta  ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnImporteMonTarjeta') DROP FUNCTION fnImporteMonTarjeta
GO
CREATE FUNCTION fnImporteMonTarjeta (
	@Importe				float,
	@Moneda					varchar(10),
	@ImporteTipoCambio		float,
	@MonedaDestino			varchar(10),
	@TipoCambioDestino      float,
	@Sucursal               int
)
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @ImporteDestino		float
    
	SET @ImporteDestino = NULL
  
	IF @ImporteTipoCambio IS NULL
 
	IF @ImporteTipoCambio IS NULL
		SELECT TOP 1 @ImporteTipoCambio = TipoCambio 
		FROM POSLTipoCambioRef m
		WHERE Moneda = @Moneda AND Sucursal = @Sucursal 

	IF @TipoCambioDestino IS NULL
		SELECT TOP 1 @TipoCambioDestino = TipoCambio 
		FROM POSLTipoCambioRef m
		WHERE Moneda = @MonedaDestino AND Sucursal = @Sucursal    
    
	IF @TipoCambioDestino IS NOT NULL
		SET @ImporteDestino = dbo.fnPOSImporteAMoneda (@Importe,@ImporteTipoCambio,@MonedaDestino,@Sucursal) 
  
	RETURN (@ImporteDestino)
END
GO


/**************** fnImporteMonTarjeta2  ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnImporteMonTarjeta2') DROP FUNCTION fnImporteMonTarjeta2
GO
CREATE FUNCTION fnImporteMonTarjeta2 (
	@Importe		float,
	@Monedero		varchar(20),
	@OfertaID       int,
	@Sucursal       int
)	
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @ImporteDestino			float,
    @TipoCambioDestino		float,
    @ImporteTipoCambio      float,
    @MonedaTarjeta          varchar(10),
    @MonedaMov			    varchar(10)
    
	SELECT @MonedaTarjeta = Moneda 
	FROM POSValeSerie 
	WHERE Serie = @Monedero
	
	SELECT @MonedaMov = Moneda 
	FROM Oferta 
	WHERE ID = @OfertaID
 
	SELECT @ImporteTipoCambio = TipoCambio 
    FROM POSLTipoCambioRef m
	WHERE Moneda = @MonedaMov AND Sucursal = @Sucursal 
   
	SELECT @TipoCambioDestino = TipoCambio 
    FROM POSLTipoCambioRef m
	WHERE Moneda = @MonedaTarjeta AND Sucursal = @Sucursal    

    SET @ImporteDestino = ((@Importe*ISNULL(@ImporteTipoCambio,1.0))/ISNULL(@TipoCambioDestino,1.0))
  
	RETURN (@ImporteDestino)
END
GO


/**************** fnPOSImpuesto1 ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSImpuesto1') DROP FUNCTION fnPOSImpuesto1
GO
CREATE FUNCTION fnPOSImpuesto1 (
	@Cantidad			float,
	@CantidadObsequio	float,
	@Precio				float,
	@DescuentoLinea		float,
	@DescuentoGlobal	float,
	@TasaImpuesto1		float,
	@Articulo			varchar(20),
	@Empresa			varchar(5)
)	 
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@Importe			float,
	@Impuesto1			float,
  	@CodigoRedondeo		varchar(50),
	@ArticuloRedondeo	varchar(20)
	  
	SELECT @CodigoRedondeo = pc.RedondeoVentaCodigo
    FROM POSCfg pc
    WHERE pc.Empresa = @Empresa

	SELECT @ArticuloRedondeo = Cuenta
    FROM CB
    WHERE Codigo = @CodigoRedondeo
    AND TipoCuenta = 'Articulos'
    
    IF @Articulo = @ArticuloRedondeo
		SELECT @DescuentoGlobal = 0
        
    SELECT @Importe = (ISNULL(@Cantidad,0) - ISNULL(@CantidadObsequio,0)) * ISNULL(@Precio,0)
    SELECT @Importe = @Importe - (@Importe * (ISNULL(@DescuentoLinea,0)/100))
    SELECT @Importe = @Importe - (@Importe * (ISNULL(@DescuentoGlobal,0)/100))
    
    SELECT @Impuesto1 = @Importe * (ISNULL(@TasaImpuesto1,0) /100)
  
	RETURN(@Impuesto1)
END
GO


/**************** fnPOSImpuesto2 ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSImpuesto2') DROP FUNCTION fnPOSImpuesto2
GO
CREATE FUNCTION fnPOSImpuesto2 (
	@Cantidad			float,
	@CantidadObsequio	float,
	@Precio				float,
	@DescuentoLinea		float,
	@DescuentoGlobal	float,
	@TasaImpuesto2		float,
	@Articulo			varchar(20),
	@Empresa			varchar(5)
)	 
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@Importe			float,
	@Impuesto2			float,
  	@CodigoRedondeo		varchar(50),
	@ArticuloRedondeo	varchar(20)
	  
	SELECT @CodigoRedondeo = pc.RedondeoVentaCodigo
    FROM POSCfg pc
    WHERE pc.Empresa = @Empresa
  
	SELECT @ArticuloRedondeo = Cuenta
    FROM CB
    WHERE Codigo = @CodigoRedondeo
    AND TipoCuenta = 'Articulos'
    
    IF @Articulo = @ArticuloRedondeo
		SELECT @DescuentoGlobal = 0
    
    SELECT @Importe = (ISNULL(@Cantidad,0) - ISNULL(@CantidadObsequio,0)) * ISNULL(@Precio,0)
    SELECT @Importe = @Importe - (@Importe * (ISNULL(@DescuentoLinea,0)/100))
    SELECT @Importe = @Importe - (@Importe * (ISNULL(@DescuentoGlobal,0)/100))
    
    SELECT @Impuesto2 = @Importe * (ISNULL(@TasaImpuesto2,0) /100)
  
	RETURN(@Impuesto2)
END
GO


/**************** fnPOSImporte ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSImporte') DROP FUNCTION fnPOSImporte
GO
CREATE FUNCTION fnPOSImporte(
	@Cantidad			float,
	@CantidadObsequio	float,
	@Precio				float,
	@DescuentoLinea		float,
	@DescuentoGlobal	float,
	@Articulo			varchar(20),
	@Empresa			varchar(5)
)	 
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@Importe			float,
  	@CodigoRedondeo		varchar(50),
	@ArticuloRedondeo	varchar(20)
	  
	SELECT @CodigoRedondeo = pc.RedondeoVentaCodigo
    FROM POSCfg pc
    WHERE pc.Empresa = @Empresa
  
	SELECT @ArticuloRedondeo = Cuenta
    FROM CB
    WHERE Codigo = @CodigoRedondeo
    AND TipoCuenta = 'Articulos'
    
    IF @Articulo = @ArticuloRedondeo
		SELECT @DescuentoGlobal = 0
    
    SELECT @Importe = (ISNULL(@Cantidad,0) - ISNULL(@CantidadObsequio,0)) * ISNULL(@Precio,0)
    SELECT @Importe = @Importe - (@Importe * (ISNULL(@DescuentoLinea,0)/100))
    SELECT @Importe = @Importe - (@Importe * (ISNULL(@DescuentoGlobal,0)/100))
  
	RETURN(@Importe)
END
GO


/**************** fnPOSImporteMov****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSImporteMov') DROP FUNCTION fnPOSImporteMov
GO
CREATE FUNCTION dbo.fnPOSImporteMov (
	@Precio         float,
    @Impuesto1      float,
    @Impuesto2      float,
    @Impuesto3		float,
    @Cantidad       float
) 
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado  float
    
	SET @Resultado = 0.0    
	
	SELECT  @Resultado = ISNULL(@Precio,0.0) + (((ISNULL(@Precio,0.0) * ISNULL(@Impuesto2,0.0))/100.00))
	SELECT @Resultado = @Resultado + ((@Resultado * ISNULL(@Impuesto1,0.0))/100.00)
	SELECT @Resultado = @Resultado + (ISNULL(@Impuesto3,0.0) * ISNULL(@Cantidad,0.0))

	RETURN (@Resultado)
END
GO


/**************** fnPOSPrecioConImpuestos ***************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSPrecioConImpuestos') DROP FUNCTION fnPOSPrecioConImpuestos
GO
CREATE FUNCTION dbo.fnPOSPrecioConImpuestos (
	@Precio         float,
    @Impuesto1      float,
    @Impuesto2      float,
    @Impuesto3		float,
	@Empresa		varchar(5)
) 
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado  float
    
	SET @Resultado = 0.0    
  
	SELECT  @Resultado = ISNULL(@Precio,0.0) + (((ISNULL(@Precio,0.0) * ISNULL(@Impuesto2,0.0))/100.00))
	SELECT @Resultado = @Resultado + ((@Resultado * ISNULL(@Impuesto1,0.0))/100.00)
	SELECT @Resultado = @Resultado + (ISNULL(@Impuesto3,0.0))

	RETURN (@Resultado)
END
GO


/**************** fnPOSPrecioSinImpuestos ***************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSPrecioSinImpuestos') DROP FUNCTION fnPOSPrecioSinImpuestos
GO
CREATE FUNCTION dbo.fnPOSPrecioSinImpuestos (
	@Precio         float,
    @Impuesto1		float,
    @Impuesto2      float,
    @Impuesto3      float
) 
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado  float
    
	SET @Resultado = 0.0    
	
	SELECT @Resultado = (@Precio-ISNULL(@Impuesto3,0.0))/ (1.0 + (ISNULL(@Impuesto2, 0.0)/100) + ((ISNULL(@Impuesto1,0.0)/100) * (1+(ISNULL(@Impuesto2, 0.0)/100)))) 

	RETURN (@Resultado)
END
GO


/**************** fnPOSPrecioSinImpuestos2 ***************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSPrecioSinImpuestos2') DROP FUNCTION fnPOSPrecioSinImpuestos2
GO
CREATE FUNCTION dbo.fnPOSPrecioSinImpuestos2 (
	@Precio         float,
    @Impuesto1      float,
    @Impuesto2		float,
    @Impuesto3      float,
    @Empresa        varchar(5)
) 
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado  float
    
	SET @Resultado = 0.0    
  
	SELECT @Resultado = (@Precio-ISNULL(@Impuesto3,0.0))/ (1.0 + (ISNULL(@Impuesto2, 0.0)/100) + ((ISNULL(@Impuesto1,0.0)/100) * (1+(ISNULL(@Impuesto2, 0.0)/100)))) 

	RETURN @Resultado
END
GO
   
      
/**************** fnPOSPrecio ***************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSPrecio') DROP FUNCTION fnPOSPrecio
GO
CREATE FUNCTION dbo.fnPOSPrecio (
	@Empresa        varchar(5),
    @Precio         float,
    @Impuesto1		float,
    @Impuesto2      float,
    @Impuesto3      float
) 
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado                  float,
    @cfgImpuestoIncluido        bit,
    @RedondeoMonetarios         int
    
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)  
    
	SELECT @cfgImpuestoIncluido = ISNULL(VentaPreciosImpuestoIncluido,0) FROM EmpresaCfg WHERE Empresa = @Empresa  
  
	SET @Resultado = 0.0    
  
	IF @cfgImpuestoIncluido = 1 
		SELECT @Resultado = (@Precio-ISNULL(@Impuesto3,0.0))/ (1.0 + (ISNULL(@Impuesto2, 0.0)/100) + ((ISNULL(@Impuesto1,0.0)/100) * (1+(ISNULL(@Impuesto2, 0.0)/100)))) 
	ELSE 
		SELECT  @Resultado = @Precio

	RETURN (@Resultado)
END
GO


/**************** fnPOSPrecio2 ***************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSPrecio2') DROP FUNCTION fnPOSPrecio2
GO
CREATE FUNCTION dbo.fnPOSPrecio2 (
	@Empresa        varchar(5),
    @Precio         float,
    @Impuesto1		float,
    @Impuesto2      float,
    @Impuesto3      float
)
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado						float,
    @cfgImpuestoIncluido			bit,
    @POSCfgPOSCFGImpuestoIncluido	bit,
    @RedondeoMonetarios				int
    
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa) 
    
	SELECT @cfgImpuestoIncluido = ISNULL(VentaPreciosImpuestoIncluido,0) FROM EmpresaCfg WHERE Empresa = @Empresa
  
	SELECT @POSCfgPOSCFGImpuestoIncluido = ISNULL(ImpuestoIncluido,0) FROM POSCfg WHERE Empresa = @Empresa  
  
	SET @Resultado = 0.0    
  
	IF @cfgImpuestoIncluido = 1 OR @POSCfgPOSCFGImpuestoIncluido = 1
		SELECT @Resultado = (@Precio-ISNULL(@Impuesto3,0.0))/ (1.0 + (ISNULL(@Impuesto2, 0.0)/100) + ((ISNULL(@Impuesto1,0.0)/100) * (1+(ISNULL(@Impuesto2, 0.0)/100)))) 
	ELSE 
		SELECT  @Resultado = @Precio

	RETURN (@Resultado)
END
GO


/**************** fnPOSPrecio3 ***************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSPrecio3') DROP FUNCTION fnPOSPrecio3
GO
CREATE FUNCTION dbo.fnPOSPrecio3 (
	@Empresa        varchar(5),
    @Precio         float,
    @Impuesto1		float,
    @Impuesto2      float,
    @Impuesto3      float
) 
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado						float,
    @cfgImpuestoIncluido			bit,
    @POSCfgPOSCFGImpuestoIncluido	bit,
    @RedondeoMonetarios				int
    
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa) 
    
	SELECT @cfgImpuestoIncluido = ISNULL(VentaPreciosImpuestoIncluido,0) 
	FROM EmpresaCfg 
	WHERE Empresa = @Empresa
  
	SELECT  @POSCfgPOSCFGImpuestoIncluido  = ISNULL(ImpuestoIncluido,0) 
	FROM POSCfg 
	WHERE Empresa = @Empresa  
  
	SET @Resultado = 0.0    
  
	IF @cfgImpuestoIncluido = 1 AND @POSCfgPOSCFGImpuestoIncluido = 1
		SELECT  @Resultado = @Precio
	ELSE IF @cfgImpuestoIncluido = 0 AND @POSCfgPOSCFGImpuestoIncluido = 0
		SELECT  @Resultado = @Precio
	ELSE IF @cfgImpuestoIncluido = 1 AND @POSCfgPOSCFGImpuestoIncluido = 0
		SELECT @Resultado = dbo.fnPOSPrecioSinImpuestos(@Precio,@Impuesto1,@Impuesto2,@Impuesto3)
	ELSE IF @cfgImpuestoIncluido = 0 AND @POSCfgPOSCFGImpuestoIncluido = 1
		SELECT @Resultado = dbo.fnPOSPrecioConImpuestos(@Precio,@Impuesto1,@Impuesto2,@Impuesto3, @Empresa)

	RETURN (ROUND(@Resultado,@RedondeoMonetarios))
END
GO


/**************** fnPOSUsuarioEsSupervisor ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSUsuarioEsSupervisor') DROP FUNCTION fnPOSUsuarioEsSupervisor
GO
CREATE FUNCTION dbo.fnPOSUsuarioEsSupervisor (
	@ID		varchar(36)
)
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Usuario    varchar(10),
	@POSPerfil  varchar(10),
	@Resultado  bit

	SELECT @Resultado    = 0
   
	SELECT @Usuario =  UsuarioAutoriza 
	FROM POSL 
	WHERE ID = @ID
  
	SELECT @POSPerfil = NULLIF(POSPerfil,'') 
	FROM Usuario 
	WHERE Usuario = @Usuario
      
	IF EXISTS(SELECT * FROM Usuario  WHERE ISNULL(POSEsSupervisor,0) = 1 AND Usuario = ISNULL(@POSPerfil,@Usuario))
		SELECT @Resultado = 1

	RETURN (@Resultado)
END
GO


/************************ spPOSHost *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSHost') AND type = 'P') DROP PROCEDURE dbo.spPOSHost
GO             
CREATE PROCEDURE spPOSHost
	     @Host		varchar(20)	OUTPUT,
	     @Cluster		varchar(20)	OUTPUT
--//WITH ENCRYPTION	     
AS 
BEGIN
	SELECT TOP 1 @Host = Host,
	@Cluster = Cluster
    FROM POSiSync 
  
	RETURN
END    
GO


/************************ spPOSEstatusCajaVerificar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSEstatusCajaVerificar') AND type = 'P') DROP PROCEDURE dbo.spPOSEstatusCajaVerificar
GO             
CREATE PROCEDURE spPOSEstatusCajaVerificar
	     @ID			varchar(36),
	     @Caja			varchar(10),
	     @Cajero		varchar(10),
	     @Accion        varchar(20),
	     @Abierto		bit	OUTPUT
--//WITH ENCRYPTION	     
AS 
BEGIN
	SELECT 
		@Caja = CtaDinero,
		@Cajero = Cajero
    FROM POSL
	WHERE ID = @ID
   
	IF @Accion = 'Abierto' 
		SELECT @Abierto = pec.Abierto
		FROM POSEstatusCaja pec
		WHERE pec.Caja = @Caja
		AND pec.Cajero = @Cajero
     
	IF @Accion = 'Bloqueado' 
		SELECT @Abierto = pec.Bloqueado
		FROM POSEstatusCaja pec
		WHERE pec.Caja = @Caja
		AND pec.Cajero = @Cajero     
  
	SELECT @Abierto = ISNULL(@Abierto,0)  
END
GO	     


/************************ spPOSTipoCambioRefCalc *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSTipoCambioRefCalc') AND type = 'P') DROP PROCEDURE dbo.spPOSTipoCambioRefCalc
GO             
CREATE PROCEDURE spPOSTipoCambioRefCalc
	     @Sucursal			int,
	     @CodigoFormaPago	varchar(50),
	     @Empresa           varchar(5)
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@TipoCambio				float,
	@Importe				float,
	@Moneda					varchar(10),
	@FormaPago				varchar(50),
	@MonedaPrincipal		varchar(20),
	@RedondeoMonetarios		int,
	@POSMonedaAct			bit
  
	SELECT @POSMonedaAct = POSMonedaAct 
	FROM POSCFG 
	WHERE Empresa = @Empresa
  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)
	
	SELECT TOP 1 @MonedaPrincipal = Moneda 
    FROM POSLTipoCambioRef m
	WHERE TipoCambio = 1 AND Sucursal = @Sucursal AND EsPrincipal = 1
  
	SELECT @FormaPago = FormaPago 
    FROM CB 
	WHERE Codigo = @CodigoFormaPago
  
	SELECT @Moneda = CASE WHEN @POSMonedaAct = 0 THEN NULLIF(fp.Moneda,'') ELSE NULLIF(fp.POSMoneda,'') END
    FROM FormaPago fp
	WHERE fp.FormaPago = @FormaPago
    
	IF ISNULL(@Moneda, @MonedaPrincipal) <> @MonedaPrincipal
		SELECT @TipoCambio = ptcr.TipoCambio
		FROM POSLTipoCambioRef ptcr
		WHERE ptcr.Sucursal = @Sucursal AND ptcr.Moneda = @Moneda
  
	SELECT ROUND(ISNULL(@TipoCambio,1), @RedondeoMonetarios)
END
GO


/************************ spPOSImporteRefCalc *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSImporteRefCalc') AND type = 'P') DROP PROCEDURE dbo.spPOSImporteRefCalc
GO             
CREATE PROCEDURE spPOSImporteRefCalc
	     @Sucursal		        int,
	     @ImporteRef			float,
	     @CodigoFormaPago		varchar(50),
	     @Empresa               varchar(5)
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@TipoCambio				float,
	@Importe				float,
	@Moneda					varchar(10),
	@FormaPago				varchar(50),
	@MonedaPrincipal		varchar(20),
	@RedondeoMonetarios		int,
	@POSMonedaAct			bit
  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)
	  
	SELECT @POSMonedaAct = POSMonedaAct 
	FROM POSCfg 
	WHERE Empresa = @Empresa  
  
	SELECT TOP 1 @MonedaPrincipal = Moneda 
    FROM POSLTipoCambioRef 
	WHERE TipoCambio = 1	  AND Sucursal = @Sucursal AND EsPrincipal = 1
  
	SELECT @FormaPago = FormaPago 
    FROM CB 
	WHERE Codigo = @CodigoFormaPago
    AND TipoCuenta = 'Forma Pago'
  
	SELECT @Moneda = CASE WHEN @POSMonedaAct = 0 THEN NULLIF(fp.Moneda,'') ELSE NULLIF(fp.POSMoneda,'') END
	FROM FormaPago fp
	WHERE fp.FormaPago = @FormaPago
 
	IF ISNULL(@Moneda, @MonedaPrincipal) <> @MonedaPrincipal
		SELECT @TipoCambio = ptcr.TipoCambio
		FROM POSLTipoCambioRef ptcr
		WHERE ptcr.Sucursal = @Sucursal 
		AND ptcr.Moneda = @Moneda
  
	SELECT @Importe = @ImporteRef * ISNULL(@TipoCambio,1)
	SELECT ROUND(@Importe, @RedondeoMonetarios)  
END
GO


/************************ spPOSEstatusCaja *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSEstatusCaja') AND type = 'P') DROP PROCEDURE dbo.spPOSEstatusCaja
GO             
CREATE PROCEDURE spPOSEstatusCaja
	@Caja			varchar(10),
	@Host			varchar(20),
	@Cajero			varchar(10),
	@Usuario		varchar(20),
	@Abrir			bit = NULL,
	@Bloquear		bit = NULL,	     
	@Ok				int				OUTPUT,
	@OkRef			varchar(255)	OUTPUT
--//WITH ENCRYPTION	     	     	     
AS 
BEGIN
  DECLARE 
  @Abierto	bit
  
  IF @Abrir = 1
	  BEGIN
			SELECT @Abierto = Abierto 
			FROM POSEstatusCaja 
			WHERE Caja = @Caja
      
			IF ISNULL(@Abierto,0) = 1 AND @Ok IS NULL
				BEGIN
					SELECT @Ok = 30435, @OkRef = @Caja
				END
   
			IF @Ok IS NULL AND ISNULL(@Abierto,0) = 0
				BEGIN
					IF NOT EXISTS(SELECT * FROM POSEstatusCaja WHERE Caja = @Caja) 
						INSERT POSEstatusCaja (
							Caja, Host, Cajero, Usuario, Abierto, Bloqueado)
						VALUES (
							@Caja, @Host, @Cajero, @Usuario, @Abrir, 0)
					ELSE		       
						UPDATE POSEstatusCaja
						SET Host = @Host,
							Cajero = @Cajero,
							Usuario = @Usuario,
							Abierto = @Abrir
						WHERE Caja = @Caja
				END
	  END

  IF @Abrir = 0
	  BEGIN
			IF NOT EXISTS(SELECT * FROM POSEstatusCaja WHERE Caja = @Caja)
				SELECT @Ok = 30440, @OkRef = @Caja
    
			IF (SELECT Abierto FROM POSEstatusCaja WHERE Caja = @Caja) = 0
				SELECT @Ok =30440, @OkRef = @Caja
    
			IF @Ok IS NULL
				UPDATE POSEstatusCaja
				SET Abierto = 0
				WHERE Caja = @Caja
	  END

  IF @Bloquear = 1
	  BEGIN
			UPDATE POSEstatusCaja
			   SET Bloqueado = @Bloquear
			 WHERE Caja = @Caja  AND Host = @Host AND Cajero = @Cajero  
	  END

  IF @Bloquear = 0
	  BEGIN
			UPDATE POSEstatusCaja
			   SET Bloqueado = @Bloquear
			 WHERE Caja = @Caja  AND Host = @Host AND Cajero = @Cajero
	  END  
END    
GO

/************************** spPOSInvSucursal *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInvSucursal') AND type = 'P') DROP PROCEDURE dbo.spPOSInvSucursal
GO             
CREATE PROCEDURE spPOSInvSucursal 
	     @Empresa		varchar(5),
	     @Sucursal		int,
	     @Articulo		varchar(20),
	     @SubCuenta		varchar(50),
	     @Inventario	float OUTPUT
--//WITH ENCRYPTION	     
AS 
BEGIN
	SELECT CargoU, AbonoU 
	INTO #Auxiliar
    FROM AuxiliarU au
	WHERE au.Rama = 'INV'
    AND au.Empresa =  @Empresa
    AND au.Sucursal = @Sucursal
    AND au.Cuenta = @Articulo
    AND ISNULL(au.SubCuenta, '') = ISNULL(@SubCuenta, '')
	UNION ALL
	SELECT Cargo = CASE WHEN plv.Cantidad < 0 THEN plv.Cantidad * (-1) ELSE 0 END,
	Abono = CASE WHEN plv.Cantidad > 0 THEN plv.Cantidad ELSE 0 END
    FROM POSL pl
	INNER JOIN POSLVenta plv ON pl.ID = plv.ID
	AND plv.Articulo = @Articulo
	AND ISNULL(plv.SubCuenta, '') = ISNULL(@SubCuenta, '')
	INNER JOIN MovTipo mt ON mt.Mov = pl.Mov
	AND mt.Modulo = 'POS' 
	AND mt.Clave IN ('POS.N', 'POS.F','POS.NPC')
	WHERE pl.Empresa = @Empresa
    AND pl.Sucursal = @Sucursal			 
    AND pl.Estatus = 'CONCLUIDO'
  
	SELECT @Inventario = SUM(ISNULL(CargoU,0)) - SUM(ISNULL(AbonoU,0)) 
    FROM #Auxiliar   			 
END
GO


/************************** spPOSLDIMonederoSaldoFavor *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDIMonederoSaldoFavor') AND type = 'P') DROP PROCEDURE dbo.spPOSLDIMonederoSaldoFavor
GO             
CREATE PROCEDURE spPOSLDIMonederoSaldoFavor
	@ID				varchar(36),
	@Monedero		varchar(20)
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@Mensaje	varchar(255)
  
	IF EXISTS(SELECT * FROM POSLDIMonederoSaldoFavor plmsf WHERE plmsf.ID = @ID)
		UPDATE POSLDIMonederoSaldoFavor SET Monedero = @Monedero WHERE ID = @ID
	ELSE
		INSERT POSLDIMonederoSaldoFavor (ID, Monedero) VALUES (@ID, @Monedero)
  
	SELECT @Mensaje = 'Este monedero se utilizará para abonar el Saldo a Favor de este movimiento'
  
	SELECT @Mensaje
END
GO


/************************** spPOSMuestraAcciones *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSMuestraAcciones') AND type = 'P') DROP PROCEDURE dbo.spPOSMuestraAcciones
GO             
CREATE PROCEDURE spPOSMuestraAcciones
	@Usuario         varchar(10)
--//WITH ENCRYPTION                 
AS 
BEGIN
	DECLARE 
	@UsuarioPerfil varchar(10)
  
	SELECT @UsuarioPerfil = POSPerfil 
	FROM Usuario 
	WHERE Usuario = @Usuario

	SELECT Tipo = 'Accion',
		cb.Codigo,
		a.Accion
    FROM POSUsuarioAccion a JOIN  CB cb ON cb.Accion = a.Accion
	WHERE CB.Accion IS NOT NULL AND a.Usuario = ISNULL(NULLIF(@UsuarioPerfil,''),@Usuario)
    AND a.Accion NOT IN('CANCELACION DINERO', 'EDITAR ENCABEZADO', 'EDITAR DETALLE', 'CONCLUIR MOVIMIENTO', 'INTRODUCIR CONCEPTOCXC', 
		'ALMACEN DESTINO','REFERENCIAR PEDIDO','SELECCIONARCTE', 'REFERENCIAR COBRO','REFERENCIAR VENTA')
	UNION ALL
	SELECT Tipo = 'Forma Pago',
		Codigo,
		FormaPago
    FROM CB
	WHERE CB.FormaPago IS NOT NULL
	UNION ALL
	SELECT Tipo = 'Accion', 'CTRL+P', 'Lista de Movimientos'
	UNION ALL
	SELECT Tipo = 'Accion', 'ALT+F2', 'Ofertas Puntos'
	UNION ALL
	SELECT Tipo = 'Accion', 'ALT+F3', 'Cancelar Ofertas Puntos'
    UNION ALL
	SELECT Tipo = 'Accion', 'ALT+F4', 'Buscar Cliente'  
    UNION ALL
	SELECT Tipo = 'Accion', 'ALT+F7', 'Promociones Cobro' 
    UNION ALL
	SELECT Tipo = 'Accion', 'CTRL+Q', 'Eliminar Movimiento'  
    UNION ALL
	SELECT Tipo = 'Accion', 'CTRL+T', 'Informacion del Cliente'    
    UNION ALL
	SELECT Tipo = 'Accion', 'CTRL+R', 'Regresar'     
END
GO


/************************ spPOSMuestraFormasPago *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSMuestraFormasPago') AND type = 'P') DROP PROCEDURE dbo.spPOSMuestraFormasPago
GO             
CREATE PROCEDURE spPOSMuestraFormasPago
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@String			varchar(MAX),
  	@FormasPago		varchar(MAX),	
	@Codigo			varchar(50),
	@FormaPago		varchar(50),
	@LargoLinea		int
  
	SELECT @LargoLinea = 100
  
	DECLARE crFormaPago CURSOR LOCAL FOR
    SELECT Codigo, FormaPago
    FROM CB
    WHERE TipoCuenta = 'Forma Pago'
      
	OPEN crFormaPago
	FETCH NEXT FROM crFormaPago INTO @Codigo, @FormaPago
	WHILE @@FETCH_STATUS <> -1 
	   BEGIN
			IF @@FETCH_STATUS <> -2 
				BEGIN          	  
					SELECT @String = LEFT(@Codigo + SPACE(40),40) + RIGHT(@FormaPago,30) + '<BR>' 			      
					SELECT @FormasPago = ISNULL(@FormasPago,'') + ISNULL(@String,'')
				END
			FETCH NEXT FROM crFormaPago INTO @Codigo, @FormaPago
	  END
	CLOSE crFormaPago
	DEALLOCATE crFormaPago
  
	SELECT @FormasPago
END
GO


/**************** fnHoraEnEntero ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnHoraEnEntero') DROP FUNCTION fnHoraEnEntero
GO
CREATE FUNCTION fnHoraEnEntero (
	@Hora	varchar(5) 
)
RETURNS int
--//WITH ENCRYPTION
AS 
BEGIN
  DECLARE
  @Resultado		int,
  @HoraEntero		int,
  @MinutoEntero		int
  
  IF @Hora = '00:00' 
		SET @Hora ='00:01'
  
  SET @HoraEntero = ISNULL(CONVERT(int,SUBSTRING(@Hora,1,2)),0)
  SET @MinutoEntero = ISNULL(CONVERT(int,SUBSTRING(@Hora,4,2)),0)  

  SET @Resultado = (@HoraEntero * 60) + @MinutoEntero
  
  IF NULLIF(RTRIM(@Hora),'') IS NULL 
		SET @Resultado = NULL
  
  RETURN (@Resultado)
END
GO


/************************ spPOSValidaAltaOfertaFormaPago *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSValidaAltaOfertaFormaPago') AND type = 'P') DROP PROCEDURE dbo.spPOSValidaAltaOfertaFormaPago
GO             
CREATE PROCEDURE spPOSValidaAltaOfertaFormaPago
	@ID					int,
	@Empresa			varchar(5),
  	@Estatus			varchar(15),
  	@TodasSucursales	bit, 
  	@Sucursal			int,       
  	@FormaPago			varchar(50),
  	@Descuento			float,     
  	@MontoMinimo		float,     
  	@FechaD				datetime,  
  	@FechaA				datetime,  
  	@HoraD				varchar(5),
  	@HoraA				varchar(5)
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@Resultado		bit
  
	SET @Resultado = 0  
  
	IF @TodasSucursales = 1
	  BEGIN
			IF EXISTS(SELECT * FROM  POSOfertaFormaPago WHERE ID <> @ID AND Estatus = 'ACTIVA' AND  FormaPago = @FormaPago  AND FechaD <= @FechaA AND FechaA >= @FechaD)
				BEGIN
					IF EXISTS(SELECT * FROM  POSOfertaFormaPago WHERE ID <> @ID AND Estatus = 'ACTIVA' 
							  AND FormaPago = @FormaPago AND FechaD <= @FechaA AND FechaA >= @FechaD 
							  AND (NULLIF(HoraD,'') IS NULL OR NULLIF(HoraA,'') IS NULL))
						SELECT @Resultado = 1
       
				  IF EXISTS(SELECT * FROM  POSOfertaFormaPago WHERE ID <> @ID AND Estatus = 'ACTIVA' 
							AND FormaPago = @FormaPago AND FechaD <= @FechaA AND FechaA >= @FechaD 
							AND ((dbo.fnHoraEnEntero(@HoraD) + 1 BETWEEN dbo.fnHoraEnEntero(HoraD) 
							AND dbo.fnHoraEnEntero(ISNULL(HoraA,'12:00'))) OR 
							(dbo.fnHoraEnEntero(ISNULL(@HoraA,'12:00')) - 1 BETWEEN dbo.fnHoraEnEntero(HoraD) 
							AND dbo.fnHoraEnEntero(ISNULL(HoraA,'12:00')))))
						SELECT @Resultado = 1      
        
				 IF NULLIF(@HoraD,'') IS NULL OR NULLIF(@HoraA,'')IS NULL
						SELECT @Resultado = 1       
				END
    
			IF EXISTS(SELECT * FROM  POSOfertaFormaPago WHERE ID <> @ID AND Estatus = 'ACTIVA' 
					  AND FormaPago = @FormaPago AND NULLIF(FechaA,'') IS NULL)
					SELECT @Resultado = 1  
	  END
  ELSE
	  BEGIN
			IF EXISTS(SELECT * FROM  POSOfertaFormaPago WHERE ID <> @ID AND Estatus = 'ACTIVA' 
					  AND FormaPago = @FormaPago AND ((Sucursal = @Sucursal)OR (ISNULL(TodasSucursales,1) = 1)) 
					  AND FechaD <= @FechaA AND FechaA >= @FechaD)
				BEGIN
					IF EXISTS(SELECT * FROM  POSOfertaFormaPago WHERE ID <> @ID AND Estatus = 'ACTIVA' 
							  AND FormaPago = @FormaPago AND ((Sucursal = @Sucursal)OR (ISNULL(TodasSucursales,1) = 1)) 
							  AND FechaD <= @FechaA AND FechaA >= @FechaD AND (NULLIF(HoraD,'') IS NULL OR NULLIF(HoraA,'') IS NULL))
							SELECT @Resultado = 1
       
					IF EXISTS(SELECT * FROM  POSOfertaFormaPago WHERE ID <> @ID AND Estatus = 'ACTIVA' 
							  AND FormaPago = @FormaPago AND ((Sucursal = @Sucursal)OR (ISNULL(TodasSucursales,1) = 1))  
							  AND FechaD <= @FechaA AND FechaA >= @FechaD AND ((dbo.fnHoraEnEntero(@HoraD) + 1 BETWEEN dbo.fnHoraEnEntero(HoraD) 
							  AND dbo.fnHoraEnEntero(ISNULL(HoraA,'12:00'))) OR 
							  (dbo.fnHoraEnEntero(ISNULL(@HoraA,'12:00')) - 1 BETWEEN dbo.fnHoraEnEntero(HoraD) 
							  AND dbo.fnHoraEnEntero(ISNULL(HoraA,'12:00')))))
							SELECT @Resultado = 1      
 
					IF NULLIF(@HoraD,'') IS NULL OR NULLIF(@HoraA,'')IS NULL
							SELECT @Resultado = 1              
				END
    
			IF EXISTS(SELECT * FROM  POSOfertaFormaPago WHERE ID <> @ID AND Estatus = 'ACTIVA' 
					  AND FormaPago = @FormaPago AND ((Sucursal = @Sucursal) OR (ISNULL(TodasSucursales,1) = 1)) AND NULLIF(FechaA,'') IS NULL)
				SELECT @Resultado = 1      
	  END
  
  SELECT @Resultado
END
GO 


/************************ spPOSOfertasFormasPago *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSOfertasFormasPago') AND type = 'P') DROP PROCEDURE dbo.spPOSOfertasFormasPago
GO             
CREATE PROCEDURE spPOSOfertasFormasPago(
	@ID					varchar(36), 
    @Empresa			varchar(5),
    @Sucursal			int,
    @CodigoFormaPago	varchar(50),
    @Mostrar			bit = 1
)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@String							varchar(MAX),
  	@FormasPago						varchar(MAX),	  
	@Codigo							varchar(50),
	@Moneda							varchar(20),
	@MonedaPrincipal				varchar(20),
	@TipoCambio						float,	  
	@LargoLinea						int,
	@Fecha							datetime,
	@RedondeoMonetarios				int,
	@Importe						float,
	@ArticuloRedondeo				varchar(20),
	@CodigoRedondeo					varchar(50),
	@ImporteProm					varchar(50),
    @Descuento						float,
    @FormaPago						varchar(50), 
    @Hora							int,
    @Minutos						int,
    @HoraMinutos					int,
    @MontoMinimo					float,
    @MovClave						varchar(20),
    @CfgAnticipoArticuloServicio	varchar(20),
    @POSMonedaAct					bit,
    @Comision3						float
	    
	SELECT @POSMonedaAct = POSMonedaAct 
	FROM POSCfg 
	WHERE Empresa = @Empresa 
	
	SELECT @FormaPago = FormaPago 
    FROM CB 
	WHERE Codigo = @CodigoFormaPago
    AND TipoCuenta = 'Forma Pago'	  

	SELECT @LargoLinea = 100
	SELECT @Fecha = GETDATE()
	SELECT @Hora = DATEPART(HOUR, @Fecha)
	SELECT @Minutos= DATEPART(MINUTE, @Fecha)
	SELECT @HoraMinutos = (@Hora*60) + @Minutos
  
	SELECT @CfgAnticipoArticuloServicio = NULLIF(CxcAnticipoArticuloServicio,'')    
	FROM EmpresaCfg2
	WHERE Empresa = @Empresa  
  
	SELECT @CodigoRedondeo = pc.RedondeoVentaCodigo
    FROM POSCfg pc
	WHERE Empresa = @Empresa
  
	SELECT @MovClave = mt.Clave 
	FROM MovTipo mt 
	JOIN POSL p ON mt.Mov = p.Mov AND mt.Modulo = 'POS' 
	WHERE p.ID = @ID
      
	SELECT @ArticuloRedondeo = Cuenta 
	FROM CB 
	WHERE Codigo = @CodigoRedondeo AND TipoCuenta = 'Articulos'
  
	SELECT @Importe = SUM(dbo.fnPOSImporteMov(((plv.Cantidad - ISNULL(plv.CantidadObsequio,0.0)) * 
		((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * (
			CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 
					THEN ISNULL(p.DescuentoGlobal,0.0) 
				 ELSE 0 
				 END)/100))),plv.Impuesto1,plv.Impuesto2,plv.Impuesto3,plv.Cantidad))
    FROM POSLVenta plv 
    JOIN POSL p ON p.ID = plv.ID
	WHERE plv.ID = @ID    
    AND plv.Articulo <> @ArticuloRedondeo 	  
  
	SELECT @Fecha = dbo.fnFechaSinHora(@Fecha)
  
	IF @MovClave IN ('POS.N','POS.F') AND NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo IN(SELECT Articulo FROM POSLDIArtRecargaTel))
     AND NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo = @CfgAnticipoArticuloServicio)
		  BEGIN     
				SELECT @Descuento = Descuento, @MontoMinimo = MontoMinimo 
				FROM POSOfertaFormaPago 
				WHERE Estatus = 'ACTIVA' AND FormaPago = @FormaPago AND @Fecha BETWEEN ISNULL(FechaD,@Fecha) 
				AND ISNULL(FechaA,@Fecha) AND @HoraMinutos BETWEEN ISNULL(dbo.fnHoraEnEntero(HoraD),0) AND ISNULL(dbo.fnHoraEnEntero(ISNULL(HoraA,'12:00')),1440)
				GROUP BY  Descuento,MontoMinimo
				HAVING @Importe >= MAX(MontoMinimo) 
 
				SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)	  
		
				SELECT @Moneda = CASE WHEN @POSMonedaAct = 0 THEN NULLIF(fp.Moneda,'') ELSE NULLIF(fp.POSMoneda,'') END,
				@Comision3 = Comision3
				FROM FormaPago fp
				WHERE fp.FormaPago = @FormaPago
     
				SELECT TOP 1 @MonedaPrincipal = Moneda 
				FROM POSLTipoCambioRef 
				WHERE TipoCambio = 1 
				AND Sucursal = @Sucursal AND EsPrincipal = 1
  
				IF ISNULL(@Moneda, @MonedaPrincipal) <> @MonedaPrincipal
					SELECT @TipoCambio = ROUND(ptcr.TipoCambio,@RedondeoMonetarios)
					FROM POSLTipoCambioRef ptcr
					WHERE ptcr.Sucursal = @Sucursal 
					AND ptcr.Moneda = @Moneda
				ELSE   
					SELECT @TipoCambio = 1.0          
     	  
				SELECT @ImporteProm = ROUND(@Importe,@RedondeoMonetarios) / ISNULL(@TipoCambio,1)

				IF @ImporteProm>= ISNULL(@MontoMinimo,0.0) AND @Descuento IS NOT NULL
					BEGIN
						SELECT @ImporteProm = (@ImporteProm -(@ImporteProm *ISNULL(@Descuento,0.0)/100))
						DELETE POSLVenta WHERE ID = @ID AND Articulo = @ArticuloRedondeo
					END  
				ELSE 
					SELECT @ImporteProm = NULL, @Descuento = NULL

				IF @ImporteProm>= ISNULL(@MontoMinimo,0.0) AND @Comision3 IS NOT NULL
					BEGIN   
						SELECT @ImporteProm = (@ImporteProm -(@ImporteProm *ISNULL(@Comision3,0.0)/100))
						DELETE POSLVenta WHERE ID = @ID AND Articulo = @ArticuloRedondeo
					END        
				ELSE 
					SELECT @ImporteProm = NULL,@Descuento = NULL	
		      
				SELECT @FormasPago = dbo.fnFormatoMoneda(@Importe,@Empresa)+' '+@FormaPago   
    
				IF  EXISTS(SELECT * FROM POSLCobro WHERE ID = @ID)
					SELECT @ImporteProm = NULL, @Descuento = NULL
		  END        

	IF @MovClave IN ('POS.CXCC')
	  BEGIN	
			SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)	  
	
			SELECT @Moneda = CASE WHEN @POSMonedaAct = 0 THEN NULLIF(fp.Moneda,'') ELSE NULLIF(fp.POSMoneda,'') END,
			@Comision3 = Comision3 *-1
			FROM FormaPago fp
			WHERE fp.FormaPago = @FormaPago
     
			SELECT TOP 1 @MonedaPrincipal = Moneda 
			FROM POSLTipoCambioRef 
			WHERE TipoCambio = 1 AND Sucursal = @Sucursal AND EsPrincipal = 1
  
			IF ISNULL(@Moneda, @MonedaPrincipal) <> @MonedaPrincipal
				SELECT @TipoCambio = ROUND(ptcr.TipoCambio,@RedondeoMonetarios)
				FROM POSLTipoCambioRef ptcr
				WHERE ptcr.Sucursal = @Sucursal 
				AND ptcr.Moneda = @Moneda
			ELSE   
				SELECT @TipoCambio = 1.0          
     
			SELECT @ImporteProm = ROUND(@Importe,@RedondeoMonetarios) / ISNULL(@TipoCambio,1)
			IF @ImporteProm>= ISNULL(@MontoMinimo,0.0) AND @Comision3 IS NOT NULL
				BEGIN
					SELECT @ImporteProm = (@ImporteProm +(@ImporteProm *ISNULL(@Comision3,0.0)/100))*-1
					DELETE POSLVenta WHERE ID = @ID AND Articulo = @ArticuloRedondeo
				END  
			ELSE      
				SELECT @ImporteProm = NULL,@Descuento = NULL	
		      
			SELECT @FormasPago = dbo.fnFormatoMoneda(@Importe,@Empresa)+' '+@FormaPago   
    
			IF  EXISTS(SELECT * FROM POSLCobro WHERE ID = @ID)
				SELECT @ImporteProm = NULL, @Descuento = NULL
	  END

	IF @Mostrar = 1
		IF @MovClave IN ('POS.CXCC')
			BEGIN
				SELECT ISNULL(ROUND(@ImporteProm,@RedondeoMonetarios),0.0), ISNULL(@Descuento,0.0), ISNULL(@Comision3, 0.0)
			END 
		ELSE
			SELECT ISNULL(ROUND(@ImporteProm,@RedondeoMonetarios),0.0), ISNULL(@Descuento,0.0), 0.0    
END
GO


/************************ spPOSMuestraCondicionesCobro *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSMuestraCondicionesCobro') AND type = 'P') DROP PROCEDURE dbo.spPOSMuestraCondicionesCobro
GO             
CREATE PROCEDURE spPOSMuestraCondicionesCobro (
	@ID          varchar(36), 
    @Empresa     varchar(5),
    @Sucursal    int,
    @Estacion    int,
    @FormasPago  varchar(MAX) OUTPUT
)
--//WITH ENCRYPTION                
AS 
BEGIN
	DECLARE 
	@String							varchar(MAX),
  	@Codigo							varchar(50),
	@FormaPago						varchar(50),
	@ImporteTotal					float,
	@LargoLinea						int,
	@CfgAnticipoArticuloServicio	varchar(20)

	SELECT @CfgAnticipoArticuloServicio = NULLIF(CxcAnticipoArticuloServicio,'')    
	FROM EmpresaCfg2
	WHERE Empresa = @Empresa           
         
	IF EXISTS(SELECT * FROM POSCobroCondicionTemp WHERE Estacion = @Estacion AND ID = @ID)
	AND NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo IN(SELECT Articulo FROM POSLDIArtRecargaTel))
	AND NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo =@CfgAnticipoArticuloServicio)
	  BEGIN
			SELECT @FormasPago = '<BR> ************* COBROS POR FORMA DE PAGO  *************  <BR>'  
			
			DECLARE crFormaPago CURSOR LOCAL FOR
			SELECT SUBSTRING(FormaPago,1,30), SUM(PrecioTotal)
			FROM  POSCobroCondicionTemp
			WHERE  Estacion = @Estacion AND ID = @ID
			GROUP BY  FormaPago
 
			OPEN crFormaPago
			FETCH NEXT FROM crFormaPago INTO @FormaPago, @ImporteTotal
			WHILE @@FETCH_STATUS <> -1 
				BEGIN
					IF @@FETCH_STATUS <> -2 
						BEGIN        	  
							SELECT @String = 'PAGO EN '+dbo.fnRellenarConCaracter(UPPER(@FormaPago),32,'D',CHAR(32)) + 
								dbo.fnAlinearDerecha(dbo.fnRellenarConCaracter(dbo.fnFormatoMoneda(@ImporteTotal,@Empresa),10,'i',CHAR(32)),15) + '<BR>' 
							SELECT @FormasPago = ISNULL(@FormasPago,'') + ISNULL(@String,'')
						END
					
					FETCH NEXT FROM crFormaPago INTO @FormaPago, @ImporteTotal
				END
		CLOSE crFormaPago
		DEALLOCATE crFormaPago
	  END
END
GO


/************************ spPOSMuestraOfertasFormasPago *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSMuestraOfertasFormasPago') AND type = 'P') DROP PROCEDURE dbo.spPOSMuestraOfertasFormasPago
GO             
CREATE PROCEDURE spPOSMuestraOfertasFormasPago (
	@ID          varchar(36), 
    @Empresa     varchar(5),
    @Sucursal    int,
    @Estacion    int
)
--//WITH ENCRYPTION                
AS 
BEGIN
	DECLARE 
	@String							varchar(MAX),
  	@FormasPago						varchar(MAX),
  	@FormasPago2					varchar(MAX),
	@Codigo							varchar(50),
	@FormaPago						varchar(50),
	@LargoLinea						int,
	@Moneda							varchar(20),
	@MonedaPrincipal				varchar(20),
	@TipoCambio						float,	  
	@Descuento						float,
	@Fecha							datetime,
	@RedondeoMonetarios				int,
	@Importe						float,
	@ImporteTotal					float,
	@ArticuloRedondeo				varchar(20),
	@CodigoRedondeo					varchar(50),
	@Hora							int,
    @Minutos						int,
    @HoraMinutos					int,
    @MontoMinimo					float 	,
    @MovClave						varchar(20),   
    @Descripcion					varchar(100),
    @CfgAnticipoArticuloServicio	varchar(20),
    @POSMonedaAct					bit,
    @Comision3						float

	SELECT @POSMonedaAct = POSMonedaAct 
	FROM POSCfg 
	WHERE Empresa = @Empresa

	SELECT @LargoLinea = 100
  
	SELECT @Fecha = GETDATE()
	SELECT @Hora = DATEPART(HOUR,@Fecha)
	SELECT @Minutos= DATEPART(MINUTE,@Fecha)
	SELECT @HoraMinutos = (@Hora*60)+@Minutos  
  
	SELECT @Fecha = dbo.fnFechaSinHora(@Fecha) 
  
	SELECT @CodigoRedondeo = pc.RedondeoVentaCodigo
    FROM POSCfg pc
	WHERE Empresa = @Empresa
  
	SELECT @CfgAnticipoArticuloServicio = NULLIF(CxcAnticipoArticuloServicio,'')    
	FROM EmpresaCfg2
	WHERE Empresa = @Empresa    
  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)	
  
	SELECT @ArticuloRedondeo = Cuenta 
	FROM CB 
	WHERE Codigo = @CodigoRedondeo AND TipoCuenta = 'Articulos'	  
  
	SELECT TOP 1 @MonedaPrincipal = Moneda 
    FROM POSLTipoCambioRef 
	WHERE TipoCambio = 1 AND Sucursal = @Sucursal AND EsPrincipal = 1
  
	SELECT @MovClave = mt.Clave 
	FROM MovTipo mt JOIN POSL p ON mt.Mov = p.Mov AND mt.Modulo = 'POS' 
	WHERE p.ID = @ID

	SELECT @ImporteTotal = SUM(dbo.fnPOSImporteMov(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * 
		((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * (
				CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 
						THEN ISNULL(p.DescuentoGlobal,0.0) 
					 ELSE 0 
					 END)/100))),plv.Impuesto1,plv.Impuesto2,plv.Impuesto3,plv.Cantidad))
    FROM POSLVenta plv 
    JOIN POSL p ON p.ID = plv.ID
	WHERE plv.ID = @ID    
    AND plv.Articulo <> @ArticuloRedondeo   
              
	IF @MovClave IN ('POS.N','POS.F') AND NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo IN(SELECT Articulo FROM POSLDIArtRecargaTel))
		AND NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo =@CfgAnticipoArticuloServicio)
		BEGIN 
			IF EXISTS(SELECT * FROM  POSOfertaFormaPago WHERE Estatus = 'ACTIVA' AND @Fecha BETWEEN ISNULL(FechaD,@Fecha) 
					  AND ISNULL(FechaA,@Fecha)AND   @HoraMinutos BETWEEN ISNULL(dbo.fnHoraEnEntero(HoraD),0) 
					  AND ISNULL(dbo.fnHoraEnEntero(ISNULL(HoraA,'12:00')),1440))
					  AND NOT EXISTS(SELECT * FROM POSLCobro WHERE ID = @ID)
				BEGIN
					SELECT @FormasPago = '************* DESCUENTOS POR FORMA DE PAGO  *************  <BR><BR>'  
					
					DECLARE crFormaPago CURSOR LOCAL FOR
					SELECT FormaPago,Descuento, MontoMinimo, ISNULL(SUBSTRING(Descripcion,1,57),'')
					FROM POSOfertaFormaPago 
					WHERE Estatus = 'ACTIVA' AND @Fecha BETWEEN ISNULL(FechaD,@Fecha) 
					AND ISNULL(FechaA,@Fecha) AND @HoraMinutos BETWEEN ISNULL(dbo.fnHoraEnEntero(HoraD),0) 
					AND ISNULL(dbo.fnHoraEnEntero(ISNULL(HoraA,'12:00')),1440)
					GROUP BY FormaPago,Descuento, MontoMinimo ,Descripcion
					HAVING @ImporteTotal >=MAX(MontoMinimo)
       
					OPEN crFormaPago
					FETCH NEXT FROM crFormaPago INTO @FormaPago, @Descuento, @MontoMinimo, @Descripcion
					WHILE @@FETCH_STATUS <> -1 
						BEGIN
							  IF @@FETCH_STATUS <> -2 
								  BEGIN        
										SELECT @Moneda = CASE WHEN @POSMonedaAct = 0 THEN NULLIF(fp.Moneda,'') ELSE NULLIF(fp.POSMoneda,'') END
										FROM FormaPago fp
										WHERE fp.FormaPago = @FormaPago
             
										SELECT @Importe = @ImporteTotal

										IF ISNULL(@Moneda, @MonedaPrincipal) <> @MonedaPrincipal
											SELECT @TipoCambio = ROUND(ptcr.TipoCambio,@RedondeoMonetarios)
											FROM POSLTipoCambioRef ptcr
											WHERE ptcr.Sucursal = @Sucursal 
											AND ptcr.Moneda = @Moneda   
										ELSE   
											SELECT @TipoCambio = 1.0       

										SELECT @Importe = ROUND(@Importe,@RedondeoMonetarios) / ISNULL(@TipoCambio,1)
            
										IF @Importe >= @MontoMinimo
											BEGIN
												SELECT @Importe = (@Importe -(@Importe *ISNULL(@Descuento,0.0)/100))  
                  	  
												SELECT @String = UPPER(@Descripcion) + '<BR>' + 'PAGO EN ' + LEFT(UPPER(@FormaPago) + SPACE(40),40) + 
													CONVERT(varchar,@Descuento) + '% DESCUENTO' + '<BR>' + 
													'IMPORTE CON DESCUENTO:                    ' + dbo.fnFormatoMoneda(@Importe,@Empresa) + ' ' + @Moneda + '<BR>'			      
												SELECT @FormasPago = ISNULL(@FormasPago,'') + ISNULL(@String,'')
											END  
									END
							
							FETCH NEXT FROM crFormaPago INTO @FormaPago, @Descuento, @MontoMinimo, @Descripcion
					  END      
					CLOSE crFormaPago
					DEALLOCATE crFormaPago
				END
		END

	IF @MovClave IN ('POS.CXCC') AND NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo IN(SELECT Articulo FROM POSLDIArtRecargaTel))
		AND NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo =@CfgAnticipoArticuloServicio)
		BEGIN 
			SELECT @FormasPago = '************* COMISIONES POR FORMA DE PAGO  *************  <BR><BR>'  
			
			DECLARE crFormaPago CURSOR LOCAL FOR
			SELECT FormaPago, Comision3
			FROM FormaPago 
			GROUP BY  FormaPago, Comision3 
			HAVING Comision3 >=0       
		  
			OPEN crFormaPago
			FETCH NEXT FROM crFormaPago INTO @FormaPago, @Comision3
			WHILE @@FETCH_STATUS <> -1 
				BEGIN
					IF @@FETCH_STATUS <> -2 
						BEGIN        
							SELECT @Moneda = CASE WHEN @POSMonedaAct = 0 THEN NULLIF(fp.Moneda,'') ELSE NULLIF(fp.POSMoneda,'') END
							FROM FormaPago fp
							WHERE fp.FormaPago = @FormaPago
             
							SELECT @Importe = @ImporteTotal

							IF ISNULL(@Moneda, @MonedaPrincipal) <> @MonedaPrincipal
								SELECT @TipoCambio = ROUND(ptcr.TipoCambio,@RedondeoMonetarios)
								FROM POSLTipoCambioRef ptcr
								WHERE ptcr.Sucursal = @Sucursal 
								AND ptcr.Moneda = @Moneda   
							ELSE   
								SELECT @TipoCambio = 1.0       

							SELECT @Importe = ROUND(@Importe,@RedondeoMonetarios) / ISNULL(@TipoCambio,1)
            
							SELECT @Importe = (@Importe +(@Importe *ISNULL(@Comision3,0.0)/100))  
                  	  
							SELECT @String = UPPER(@Descripcion) + '<BR>' + 'PAGO EN ' + LEFT(UPPER(@FormaPago) + SPACE(40),40) + 
								CONVERT(varchar, @Descuento) + '% COMISION' + '<BR>' + 'IMPORTE CON COMISION:                    ' + 
								dbo.fnFormatoMoneda(@Importe,@Empresa) + ' ' + @Moneda + '<BR>'			      
					  
							SELECT @FormasPago = ISNULL(@FormasPago,'') + ISNULL(@String,'')  
						END
			  
					FETCH NEXT FROM crFormaPago INTO @FormaPago, @Comision3
				END		  
			CLOSE crFormaPago
			DEALLOCATE crFormaPago    
	  END

	EXEC spPOSMuestraCondicionesCobro @ID, @Empresa, @Sucursal, @Estacion, @FormasPago2 OUTPUT

	SELECT ISNULL(@FormasPago,'')+ISNULL(@FormasPago2,'')
END
GO


/************************** spPOSCalculaCambioCalc *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSCalculaCambioCalc') AND type = 'P') DROP PROCEDURE dbo.spPOSCalculaCambioCalc
GO             
CREATE PROCEDURE spPOSCalculaCambioCalc
	@Saldo		float,
	@Empresa	varchar(5),
	@Importe	float,
	@Mostrar	bit = 0,
	@Cambio		float = NULL OUTPUT 
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@RedondeoMonetarios int

	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)

	SELECT @Cambio = ROUND(ISNULL(@Importe,0.0), @RedondeoMonetarios) - ROUND(ISNULL(@Saldo,0), @RedondeoMonetarios)
   
	SELECT @Cambio =  ROUND(@Cambio,@RedondeoMonetarios)
   
	IF @Cambio < 0.01	  
		SELECT @Cambio = 0 
   
	IF @Mostrar = 1
		SELECT @Cambio
END
GO


/************************** spPOSCalculaCambio *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSCalculaCambio') AND type = 'P') DROP PROCEDURE dbo.spPOSCalculaCambio
GO             
CREATE PROCEDURE spPOSCalculaCambio
	@Saldo				float,
	@Empresa			varchar(5),
	@Importe			float,
	@FormaPagoCodigo	varchar(50),
	@Sucursal			int	= NULL
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE 
	@Cambio					float,
	@FormaPago				varchar(50),
	@FormaPagoMoneda		varchar(20),
	@TipoCambio				float,
	@MonedaPrincipal		varchar(20),
	@RedondeoMonetarios		int,
	@POSMonedaAct			bit 
  
	SELECT @POSMonedaAct = POSMonedaAct 
	FROM POSCfg 
	WHERE Empresa = @Empresa
	
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)
  
	SELECT @Saldo = ROUND(@Saldo,@RedondeoMonetarios)
	SELECT @Importe = ROUND(@Importe,@RedondeoMonetarios)
	  
	SELECT TOP 1 @MonedaPrincipal = Moneda 
    FROM POSLTipoCambioRef m
	WHERE TipoCambio = 1	  
	AND Sucursal = @Sucursal AND EsPrincipal = 1
  
	IF @FormaPagoCodigo IS NOT NULL
		BEGIN
			SELECT @FormaPago = FormaPago 
			FROM CB
			WHERE Codigo = @FormaPagoCodigo
			AND TipoCuenta = 'Forma Pago'
       
			SELECT @FormaPagoMoneda = CASE WHEN @POSMonedaAct = 0 THEN ISNULL(NULLIF(Moneda,''), @MonedaPrincipal) ELSE ISNULL(NULLIF(POSMoneda,''), @MonedaPrincipal) END
			FROM FormaPago fp
			WHERE fp.FormaPago = @FormaPago
    
			IF ISNULL(@FormaPagoMoneda, @MonedaPrincipal) <> @MonedaPrincipal
				SELECT @TipoCambio = TipoCambio
				FROM POSLTipoCambioRef
				WHERE Sucursal = @Sucursal AND Moneda = @FormaPagoMoneda
			ELSE
				SELECT @TipoCambio = 1
		END

	SELECT @TipoCambio =  ROUND(@TipoCambio,@RedondeoMonetarios)

	EXEC spPOSCalculaCambioCalc @Saldo,@Empresa, @Importe, 0, @Cambio OUTPUT  
  
	SELECT dbo.fnFormatoMoneda(( @Cambio / ISNULL(@TipoCambio,1.0)),@Empresa) + ' ' +ISNULL(@FormaPagoMoneda, @MonedaPrincipal)
END
GO


/************************ spPOSHostDatosCaja *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSHostDatosCaja') AND type = 'P') DROP PROCEDURE dbo.spPOSHostDatosCaja
GO             
CREATE PROCEDURE spPOSHostDatosCaja
	@Host 		varchar(20),
	@Caja		varchar(10),
	@Cajero		varchar(10)
--//WITH ENCRYPTION	     
AS 
BEGIN
	IF EXISTS(SELECT * FROM POSHost WHERE Host = @Host)
		UPDATE POSHost 
		SET Caja = @Caja, Cajero = @Cajero 
		WHERE Host = @Host
	ELSE 
		INSERT POSHost (
			Host,  Caja,  Cajero)
        VALUES (
			@Host, @Caja, @Cajero)
END
GO	     


/************************ spPOSUsuarioAutoriza ***********************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSUsuarioAutoriza') AND type = 'P') DROP PROCEDURE dbo.spPOSUsuarioAutoriza
GO             
CREATE PROCEDURE spPOSUsuarioAutoriza
	@ID			varchar(36),
	@Usuario	varchar(10)
--//WITH ENCRYPTION	     
AS 
BEGIN
	UPDATE POSL 
    SET UsuarioAutoriza = @Usuario
	WHERE ID = @ID
END
GO


/************************ spPOSVerificadorPreciosInsertaAccion *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSVerificadorPreciosInsertaAccion') AND type = 'P') DROP PROCEDURE dbo.spPOSVerificadorPreciosInsertaAccion
GO             
CREATE PROCEDURE spPOSVerificadorPreciosInsertaAccion
	@ID			varchar(36),
	@Codigo		varchar(50)
--//WITH ENCRYPTION
AS
BEGIN
	DECLARE @Caja	varchar(10),
			@Host	varchar(20)


	SELECT @Caja	= Caja,
		   @Host	= Host
	  FROM POSL
	 WHERE ID = @ID

	 IF NULLIF(@Codigo,'') IS NOT NULL
	 BEGIN
		IF NOT EXISTS (SELECT * FROM POSLAccion WHERE Caja = @Caja AND Host = @Host AND Accion = 'VERIFICAR PRECIOS')
			INSERT INTO POSLAccion (Host, Caja, Accion)
			SELECT				 @Host, @Caja,'VERIFICAR PRECIOS'
	 END

END
GO

/************************ spPOSVerificadorPrecios *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSVerificadorPrecios') AND type = 'P') DROP PROCEDURE dbo.spPOSVerificadorPrecios
GO             
CREATE PROCEDURE spPOSVerificadorPrecios
	@ID			varchar(36),
	@Codigo		varchar(50),
	@Usuario	varchar(10),
	@Estacion	int,
	@Ticket		varchar(MAX)	OUTPUT,
	@Ok			int				OUTPUT,
	@OkRef		varchar(255)	OUTPUT
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE	
	@Articulo				varchar(20),
	@Descripcion1			varchar(100),
	@SubCuenta				varchar(50),
	@Unidad					varchar(50),
	@UnidadCodigo			varchar(50),
	@Precio					float,
	@DescuentoLinea			float,
	@FechaEmision			datetime,
	@Agente					varchar(10),
	@Moneda					varchar(20),
	@TipoCambio				float,
	@Condicion				varchar(50),
	@Almacen				varchar(10),
	@Proyecto				varchar(50),
	@FormaEnvio				varchar(50),
	@Mov					varchar(20),
	@Empresa				varchar(5),
	@Sucursal				int,
	@ListaPreciosEsp		varchar(20),
	@Cliente				varchar(10),
	@String					varchar(MAX),
	@OFER					bit,
	@OfertaTipo				varchar(50),
	@OfertaForma			varchar(50),
	@OfertaObsequio			varchar(20),
	@OfertaPorcentaje		float,
	@OfertaImporte			float,
	@RedondeoMonetarios		int,
	@OfertaPrecio			float,
	@OfertaCantidad			float,
	@Usar					varchar(50),
	@ContMoneda				varchar(10),
	@ContMonedaTC	        float,
	@ImpuestoIncluido		bit,
	@Impuesto1				float, 
	@Impuesto2				float, 
	@Impuesto3				float,
	@Caja					varchar(10),
	@Host					varchar(20),
    @DirectorioEstilo		varchar(256)
          
	SELECT @ContMoneda = ec.ContMoneda
      FROM EmpresaCfg ec	  
	 WHERE ec.Empresa = @Empresa
	
	SELECT @DirectorioEstilo = Directorio
	  FROM POSUsuarioEstacion
	 WHERE Empresa = @Empresa
	   AND Sucursal = @Sucursal
	   AND Usuario = @Usuario
	   AND Estacion = @Estacion   
   
	SELECT @ContMonedaTC = TipoCambio FROM POSLTipoCambioRef WHERE Sucursal = @Sucursal AND Moneda = @ContMoneda    
  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)
  	  
	SELECT @Ticket = NULL
  
	IF EXISTS(SELECT 1 FROM Art WHERE Articulo = @Codigo)
		SELECT @Articulo = @Codigo
	ELSE
		SELECT 
			@Articulo = Cuenta,
  			@SubCuenta = SubCuenta,
			@UnidadCodigo = nullif(Unidad,'')
		FROM CB
		WHERE Codigo = @Codigo
  
	IF @Articulo IS NULL
		SELECT @Ok = 72040
  
	IF @Ok IS NULL
		BEGIN
			SELECT 
				@Descripcion1 = a.Descripcion1,
				@Unidad = a.Unidad  
			FROM Art a
			WHERE a.Articulo = @Articulo
	
			IF @UnidadCodigo IS NOT NULL 
				SELECT @Unidad = @UnidadCodigo
		
			SELECT 
				@FechaEmision		= FechaEmision,
				@Agente				= Agente,
				@Moneda				= Moneda,
				@TipoCambio			= TipoCambio,
				@Condicion			= Condicion,
				@Almacen			= Almacen,
				@Proyecto			= Proyecto,
				@FormaEnvio			= FormaEnvio,
				@Mov				= Mov,
				@Empresa			= Empresa,
				@Sucursal			= Sucursal,
				@ListaPreciosEsp	= ListaPreciosEsp,
				@Cliente			= Cliente,
				@Caja				= Caja,
				@Host				= Host
				  
			FROM POSL
			WHERE ID = @ID
    
			SELECT @OFER = 0
			FROM EmpresaGral
			WHERE Empresa = @Empresa
    
			SELECT @ImpuestoIncluido = VentaPreciosImpuestoIncluido FROM EmpresaCfg WHERE Empresa = @Empresa 
	 
			SELECT @TipoCambio = CASE WHEN @Moneda <> @ContMoneda THEN  (ISNULL(@TipoCambio,1)/@ContMonedaTC) ELSE ISNULL(@TipoCambio,1) END 

			EXEC spPOSArtPrecio @Articulo = @Articulo, @Cantidad = 1, @UnidadVenta = @Unidad, @Precio = @Precio OUTPUT, 
					@Descuento = @DescuentoLinea OUTPUT, @SubCuenta = @SubCuenta, @FechaEmision = @FechaEmision, 
					@Agente = @Agente, @Moneda = @Moneda, @TipoCambio = @TipoCambio, @Condicion = @Condicion, 
					@Almacen = @Almacen, @Proyecto = @Proyecto, @FormaEnvio = @FormaEnvio, @Mov = @Mov, 
					@Empresa = @Empresa, @Sucursal = @Sucursal, @ListaPreciosEsp = @ListaPreciosEsp, 
					@Cliente = @Cliente, @VentaID = @ID
    
			SELECT @Precio = ROUND(@Precio,@RedondeoMonetarios)	
	
			IF @ImpuestoIncluido = 0
			BEGIN
				SELECT @Impuesto1 = ISNULL(Impuesto1,0), @Impuesto2 = ISNULL(Impuesto2,0), @Impuesto3 = ISNULL(Impuesto3,0) FROM Art WHERE Articulo = @Articulo
				SELECT @Precio = dbo.fnPOSPrecioConImpuestos(@Precio, @Impuesto1, @Impuesto2, @Impuesto3, @Empresa)
			END
	  
			SELECT @DescuentoLinea = ROUND(@DescuentoLinea,@RedondeoMonetarios)	  

            SET @String = ''
            SET @String = @String + '<!DOCTYPE HTML>'
            SET @String = @String + '<html>'
            SET @String = @String + '<head>'
            SET @String = @String + '<title>Ticket POS</title>'
            SET @String = @String + '<meta name="viewport" content="width=device-width, initial-scale=1">'
            SET @String = @String + '<meta http-equiv="Content-Type" content="text/html; charset=latin1" />'
            SET @String = @String + '<meta name="keywords" content="POS, SDK"/>'
            SET @String = @String + '<base href="'+@DirectorioEstilo+'">'
            SET @String = @String + '<link href="web/css/bootstrap.min.css" rel="stylesheet" type="text/css" />'
            SET @String = @String + '<link href="web/css/style.css" rel="stylesheet" type="text/css" />'
            SET @String = @String + '<link rel="stylesheet" href="web/css/morris.css" type="text/css"/>'
            SET @String = @String + '<link href="web/css/font-awesome.css" rel="stylesheet">'
            SET @String = @String + '<link rel="stylesheet" type="text/css" href="web/css/table-style.css" />'
            SET @String = @String + '<link rel="stylesheet" type="text/css" href="web/css/basictable.css" />'
            SET @String = @String + '<link rel="stylesheet" href="web/css/icon-font.min.css" type="text/css" />'
            SET @String = @String + '</head>'
            SET @String = @String + '<body>'
		    SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
            SET @String = ''



			--Titulo
		    SELECT @String = @String + '<table width="100%" style="margin:0;">'
		    SELECT @String = @String + '  <tr style="border-bottom:0px;">'
		    SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">  </th>'
		    SELECT @String = @String + '  </tr>'
		    SELECT @String = @String + '</table>'

			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			SET @String = ''

		    SELECT @String = @String + '<table width="100%" style="margin:0;">'
		    SELECT @String = @String + '  <tr style="border-bottom:0px;">'
		    SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">  </th>'
		    SELECT @String = @String + '  </tr>'
		    SELECT @String = @String + '</table>'

			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			SET @String = ''

		    SELECT @String = @String + '<table width="100%" style="margin:0;">'
		    SELECT @String = @String + '  <tr style="border-bottom:0px;">'
		    SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;"> V E R I F I C A D O R   D E   P R E C I O S </th>'
		    SELECT @String = @String + '  </tr>'
		    SELECT @String = @String + '</table>'

			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			SET @String = ''
    
			--Concatena el String con el Articulo
		    SELECT @String = @String + '<table width="100%" style="margin:0;">'
		    SELECT @String = @String + '  <tr style="border-bottom:0px;">'
		    SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">'+ @Articulo + ' ' + @Descripcion1 +'</th>'
		    SELECT @String = @String + '  </tr>'
		    SELECT @String = @String + '</table>'

			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			SET @String = ''

			--Concatena el String con el Precio
		    SELECT @String = @String + '<table width="100%" style="margin:0;">'
		    SELECT @String = @String + '  <tr style="border-bottom:0px;">'
		    SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">'+ 'Precio:    '  +dbo.fnFormatoMoneda( @Precio,@Empresa) +'</th>'
		    SELECT @String = @String + '  </tr>'
		    SELECT @String = @String + '</table>'

			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			SET @String = ''

    	
			--Concatena el String con el Descuento en Linea cuando no hay ofertas
			IF ISNULL(@OFER,0) = 0 AND @DescuentoLinea IS NOT NULL
			BEGIN
				SELECT @String = @String + '<table width="100%" style="margin:0;">'
				SELECT @String = @String + '  <tr style="border-bottom:0px;">'
				SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">'+ 'Descuento: '  + CONVERT(varchar, @DescuentoLinea, 101) + '%' +'</th>'
				SELECT @String = @String + '  </tr>'
				SELECT @String = @String + '</table>'

				SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
				SET @String = ''

			END
       
			--IF ISNULL(@OFER,0) = 1 AND @DescuentoLinea IS NOT NULL
			--	SELECT @DescuentoLinea = NULL
    
			--IF ISNULL(@OFER,0) = 1
			--	BEGIN
			--		SELECT TOP 1 @OfertaTipo = o.Tipo, @OfertaForma = o.Forma, @OfertaObsequio = od.Obsequio, @OfertaPorcentaje = od.Porcentaje, 
			--				@OfertaImporte =od.Importe,@OfertaPrecio=od.Precio, @OfertaCantidad =od.Cantidad, @Usar = o.Usar
			--		FROM Oferta o
			--		INNER JOIN OfertaD od ON o.ID = od.ID
			--		AND od.Articulo = @Articulo
			--		WHERE o.Empresa = @Empresa
			--		AND o.Estatus = 'VIGENTE'
			--		AND dbo.fnFechaSinHora(GETDATE()) BETWEEN ISNULL(o.FechaD, dbo.fnFechaSinHora(GETDATE())) AND ISNULL(o.FechaA, dbo.fnFechaSinHora(GETDATE()))
			--		AND (o.TodasSucursales = 1 OR o.Sucursal = @Sucursal)
	  
			--		SELECT @OfertaPorcentaje = ROUND(@OfertaPorcentaje,@RedondeoMonetarios)	  
			--		SELECT @OfertaImporte = ROUND(@OfertaImporte,@RedondeoMonetarios)	  
		  
			--		-- Concatenta el Ticket para la oferta
			--		IF @OfertaTipo IS NOT NULL AND @OfertaForma NOT IN('Puntos/Precio','Importe/Puntos')
			--			BEGIN
			--				SELECT @String = dbo.fnCentrar('Oferta: '  + @OfertaTipo + ' Forma:' + @OfertaForma + ' ' + ISNULL(@OfertaObsequio,'') + ' ' + 
			--					CASE WHEN @OfertaPorcentaje IS NOT NULL 
			--							THEN ISNULL(CONVERT(varchar, @OfertaPorcentaje, 101)+ '%','') 
			--						 ELSE '' 
			--						 END + ' ' + 
			--					CASE WHEN @OfertaImporte IS NOT NULL AND @Usar ='Importe' 
			--							THEN ISNULL('$' + CONVERT(varchar, @OfertaImporte),'') 
			--						 ELSE '' 
			--						 END, 75) + '<BR><BR><BR>'
						
			--				SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			--			END
		  
			--		IF @OfertaTipo IS NOT NULL AND @OfertaForma = 'Puntos/Precio'
			--			BEGIN
			--				SELECT @String = dbo.fnCentrar('Oferta: '  + @OfertaTipo + ' Forma:' + @OfertaForma + ' ' + ISNULL(@OfertaObsequio,'') + ' ' + 
			--					CASE WHEN @OfertaPorcentaje IS NOT NULL 
			--							THEN ISNULL(CONVERT(varchar, @OfertaPorcentaje, 101) + '%','') 
			--						 ELSE '' 
			--						 END + ' ' + CONVERT(varchar,@OfertaCantidad)+' / '+ ISNULL('$'+CONVERT(varchar, @OfertaPrecio),'') ,75) + '<BR><BR><BR>'
						
			--				SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			--			END      
			--	END
        
			IF @DescuentoLinea IS NOT NULL
			BEGIN
				--SELECT @Ticket = ISNULL(@Ticket, '') + dbo.fnCentrar('******** Precio Neto ' + dbo.fnFormatoMoneda(@Precio - (@Precio * (ISNULL(@DescuentoLinea,0)/100)),@Empresa) + ' ********', 75)

				SELECT @String = @String + '<table width="100%" style="margin:0;">'
				SELECT @String = @String + '  <tr style="border-bottom:0px;">'
				SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">'+ '******** Precio Neto ' + dbo.fnFormatoMoneda(@Precio - (@Precio * (ISNULL(@DescuentoLinea,0)/100)),@Empresa) + ' ********' +'</th>'
				SELECT @String = @String + '  </tr>'
				SELECT @String = @String + '</table>'

				SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
				SET @String = ''

			END

            SET @String = ''
            SET @String = @String + '</body>'
            SET @String = @String + '</html>'
		    SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
            SET @String = ''    
	  END

	IF @Ok IS NOT NULL
	BEGIN


            SET @String = ''
            SET @String = @String + '<!DOCTYPE HTML>'
            SET @String = @String + '<html>'
            SET @String = @String + '<head>'
            SET @String = @String + '<title>Ticket POS</title>'
            SET @String = @String + '<meta name="viewport" content="width=device-width, initial-scale=1">'
            SET @String = @String + '<meta http-equiv="Content-Type" content="text/html; charset=latin1" />'
            SET @String = @String + '<meta name="keywords" content="POS, SDK"/>'
            SET @String = @String + '<base href="'+@DirectorioEstilo+'">'
            SET @String = @String + '<link href="web/css/bootstrap.min.css" rel="stylesheet" type="text/css" />'
            SET @String = @String + '<link href="web/css/style.css" rel="stylesheet" type="text/css" />'
            SET @String = @String + '<link rel="stylesheet" href="web/css/morris.css" type="text/css"/>'
            SET @String = @String + '<link href="web/css/font-awesome.css" rel="stylesheet">'
            SET @String = @String + '<link rel="stylesheet" type="text/css" href="web/css/table-style.css" />'
            SET @String = @String + '<link rel="stylesheet" type="text/css" href="web/css/basictable.css" />'
            SET @String = @String + '<link rel="stylesheet" href="web/css/icon-font.min.css" type="text/css" />'
            SET @String = @String + '</head>'
            SET @String = @String + '<body>'
		    SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
            SET @String = ''



			--Titulo
		    SELECT @String = @String + '<table width="100%" style="margin:0;">'
		    SELECT @String = @String + '  <tr style="border-bottom:0px;">'
		    SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">  </th>'
		    SELECT @String = @String + '  </tr>'
		    SELECT @String = @String + '</table>'

			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			SET @String = ''

		    SELECT @String = @String + '<table width="100%" style="margin:0;">'
		    SELECT @String = @String + '  <tr style="border-bottom:0px;">'
		    SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;">  </th>'
		    SELECT @String = @String + '  </tr>'
		    SELECT @String = @String + '</table>'

			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			SET @String = ''

		    SELECT @String = @String + '<table width="100%" style="margin:0;">'
		    SELECT @String = @String + '  <tr style="border-bottom:0px;">'
		    SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;"> V E R I F I C A D O R   D E   P R E C I O S </th>'
		    SELECT @String = @String + '  </tr>'
		    SELECT @String = @String + '</table>'

			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			SET @String = ''
    
			--Concatena el String con el Articulo
		    SELECT @String = @String + '<table width="100%" style="margin:0;">'
		    SELECT @String = @String + '  <tr style="border-bottom:0px;">'
		    SELECT @String = @String + '    <th style="text-align:left; padding:3px 12px; border-bottom:0px; background:#337ab7;"> El Código no Existe, '+ @Codigo + ' </th>'
		    SELECT @String = @String + '  </tr>'
		    SELECT @String = @String + '</table>'

			SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')
			SET @String = ''

            SET @String = ''
            SET @String = @String + '</body>'
            SET @String = @String + '</html>'
		    SELECT @Ticket = ISNULL(@Ticket,'') + ISNULL(@String,'')  
            SET @String = ''  

	END



END
GO


/************************ spPOSUsuarioDesautoriza *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSUsuarioDesautoriza') AND type = 'P') DROP PROCEDURE dbo.spPOSUsuarioDesautoriza
GO             
CREATE PROCEDURE spPOSUsuarioDesautoriza
		@ID		varchar(36)
--//WITH ENCRYPTION		
AS 
BEGIN
	UPDATE POSL SET UsuarioAutoriza = NULL WHERE ID = @ID
END		
GO


/************************ spPOSUsuarioAutorizaValidaSuc *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSUsuarioAutorizaValidaSuc') AND type = 'P') DROP PROCEDURE dbo.spPOSUsuarioAutorizaValidaSuc
GO             
CREATE PROCEDURE spPOSUsuarioAutorizaValidaSuc
	@Usuario		varchar(20),
	@Sucursal		int
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@PuedeAutorizar		int
  
	SELECT @PuedeAutorizar = 0
  
	IF EXISTS(SELECT 1 FROM UsuarioSucursalAcceso us WHERE us.Usuario = @Usuario AND us.Sucursal = @Sucursal)
		SELECT @PuedeAutorizar = 1
  
	IF EXISTS(SELECT 1 FROM Usuario u WHERE u.Usuario = @Usuario AND u.Sucursal = @Sucursal) AND @PuedeAutorizar = 0
		SELECT @PuedeAutorizar = 1
    
	IF (SELECT AccesarOtrasSucursalesEnLinea FROM Usuario u WHERE u.Usuario = @Usuario) = 1 AND @PuedeAutorizar = 0
		SELECT @PuedeAutorizar = 1
    
	SELECT @PuedeAutorizar
END
GO


/************************ spPOSUsuarioAccion *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSUsuarioAccion') AND type = 'P') DROP PROCEDURE dbo.spPOSUsuarioAccion
GO             
CREATE PROCEDURE spPOSUsuarioAccion
	@Usuario			varchar(10),
	@UsuarioPerfil		varchar(10),
	@Sucursal			int,
	@Accion				varchar(50),
	@ID					varchar(36),		
	@Ok					int				OUTPUT,
	@OkRef				varchar(255)	OUTPUT
--//WITH ENCRYPTION		
AS 
BEGIN
	DECLARE 
	@UsuarioAutoriza	        varchar(10),
	@UsuarioAutorizaPerfil		varchar(10)
  
	IF NOT EXISTS(SELECT 1 FROM POSUsuarioAccion pua WHERE pua.Usuario = ISNULL(NULLIF(@UsuarioPerfil,''),@Usuario) AND pua.Accion = @Accion)
		BEGIN
			SELECT @UsuarioAutoriza = UsuarioAutoriza
			FROM POSL
			WHERE ID = @ID  
        
			SELECT @UsuarioAutoriza = ISNULL(@UsuarioAutoriza, @Usuario)
    
			SELECT @UsuarioAutorizaPerfil = NULLIF(POSPerfil,'') FROM Usuario WHERE Usuario = @UsuarioAutorizaPerfil
		
			IF NOT EXISTS(SELECT 1 FROM POSUsuarioAccion pua WHERE pua.Usuario = ISNULL(NULLIF(@UsuarioPerfil,''),@UsuarioAutoriza) 
				AND pua.Accion = @Accion) AND @Accion NOT IN('CANCELACION DINERO','BENEFICIARIO','IMPORTE ANTICIPO') 
				SELECT @Ok = 3, @OkRef = @Accion

			EXEC spPOSUsuarioDesautoriza @ID
	  END
END
GO


/************************** spPOSLArtSeleccionado *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLArtSeleccionado') AND type = 'P') DROP PROCEDURE dbo.spPOSLArtSeleccionado
GO             
CREATE PROCEDURE spPOSLArtSeleccionado
	@ID				varchar(50),
	@Articulo		varchar(20),
	@SubCuenta		varchar(50),
	@Unidad			varchar(50),
	@Codigo			varchar(30) = NULL
--//WITH ENCRYPTION	     
AS 
BEGIN
	IF NOT EXISTS(SELECT 1 FROM POSLArtSeleccionado pal WHERE pal.ID = @ID)
		INSERT POSLArtSeleccionado (
			ID,  Articulo,  SubCuenta, Unidad, Codigo)
		VALUES (
			@ID, @Articulo, @SubCuenta, @Unidad, @Codigo)
	ELSE
		UPDATE POSLArtSeleccionado
		SET Articulo = @Articulo, SubCuenta = @SubCuenta, Unidad = @Unidad, Codigo = @Codigo
		WHERE ID = @ID		
END	     
GO


/************************** spPOSLVerArtSeleccionado *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLVerArtSeleccionado') AND type = 'P') DROP PROCEDURE dbo.spPOSLVerArtSeleccionado
GO             
CREATE PROCEDURE spPOSLVerArtSeleccionado
	@ID					varchar(50),
	@Articulo			varchar(20)	OUTPUT,
	@SubCuenta			varchar(50)	OUTPUT,
	@CantidadOriginal	float		OUTPUT,
	@Unidad				varchar(50)	OUTPUT,
	@Codigo				varchar(30)	OUTPUT	     
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	SELECT 
		@Articulo	=	Articulo,
		@SubCuenta =	SubCuenta,
		@Unidad    =	Unidad,
		@Codigo	=	Codigo
    FROM POSLArtSeleccionado pal 
	WHERE pal.ID = @ID

	SELECT @CantidadOriginal = SUM(Cantidad)
    FROM POSLVenta pl
	WHERE pl.ID = @ID
    AND pl.Articulo = @Articulo
    AND ISNULL(pl.SubCuenta,'') = ISNULL(@SubCuenta,'')
    AND pl.Unidad = @Unidad
END	     
GO


/**************** spPOSOfertaVenta ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSOfertaVenta') and type = 'P') DROP PROCEDURE dbo.spPOSOfertaVenta
GO
CREATE PROCEDURE spPOSOfertaVenta
	@ID		varchar(50)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @Region				varchar(50),
    @Alm				varchar(10),
    @AlmGrupo			varchar(50),
    @Cte				varchar(10),
    @CteCategoria		varchar(50),
    @CteGrupo			varchar(50),
    @CteFamilia			varchar(50),
    @CteZona			varchar(50),
    @Agente				varchar(10),
    @AgenteCategoria	varchar(50),
    @AgenteGrupo		varchar(50),
    @AgenteFamilia		varchar(50),
    @Mov				varchar(20),
    @Moneda				varchar(10),
    @CondicionPago		varchar(50),
    @FormaPagoTipo		varchar(50),
    @FormaEnvio			varchar(50),
    @ListaPrecios		varchar(50)

	SELECT	@Region = s.Region, @Alm = e.Almacen, @AlmGrupo = a.Grupo, 
			@Cte = e.Cliente, @CteCategoria = c.Categoria, @CteGrupo = c.Grupo, @CteFamilia = c.Familia, @CteZona = c.Zona,
			@Mov = e.Mov, @Moneda = e.Moneda, @CondicionPago = e.Condicion, @FormaPagoTipo = NULL, --e.FormaPagoTipo, 
			@FormaEnvio = e.FormaEnvio, @ListaPrecios = e.ListaPreciosEsp,
			@Agente = e.Agente, @AgenteCategoria = ag.Categoria, @AgenteGrupo = ag.Grupo, @AgenteFamilia = ag.Familia
    FROM POSL e
    JOIN Sucursal s ON s.Sucursal = e.Sucursal
    JOIN Cte c ON c.Cliente = e.Cliente
    JOIN Alm a ON a.Almacen = e.Almacen
    LEFT OUTER JOIN Agente ag ON ag.Agente = e.Agente
	WHERE e.ID = @ID

	INSERT #Venta (Campo, Valor) VALUES ('Region', 		@Region)
	INSERT #Venta (Campo, Valor) VALUES ('Almacen', 		@Alm)
	INSERT #Venta (Campo, Valor) VALUES ('Grupo Almacen', 	@AlmGrupo)
	INSERT #Venta (Campo, Valor) VALUES ('Cliente', 		@Cte)
	INSERT #Venta (Campo, Valor) VALUES ('Categoria Cliente', 	@CteCategoria)
	INSERT #Venta (Campo, Valor) VALUES ('Grupo Cliente', 	@CteGrupo)
	INSERT #Venta (Campo, Valor) VALUES ('Familia Cliente', 	@CteFamilia)
	INSERT #Venta (Campo, Valor) VALUES ('Zona Cliente', 		@CteZona)
	INSERT #Venta (Campo, Valor) VALUES ('Agente', 		@Agente)
	INSERT #Venta (Campo, Valor) VALUES ('Categoria Agente', 	@AgenteCategoria)
	INSERT #Venta (Campo, Valor) VALUES ('Grupo Agente', 		@AgenteGrupo)
	INSERT #Venta (Campo, Valor) VALUES ('Familia Agente', 	@AgenteFamilia)
	INSERT #Venta (Campo, Valor) VALUES ('Movimiento', 		@Mov)
	INSERT #Venta (Campo, Valor) VALUES ('Moneda', 		@Moneda)
	INSERT #Venta (Campo, Valor) VALUES ('Condicion Pago',	@CondicionPago)
	INSERT #Venta (Campo, Valor) VALUES ('Tipo Forma Pago', 	@FormaPagoTipo)
	INSERT #Venta (Campo, Valor) VALUES ('Forma Envio', 		@FormaEnvio)
	INSERT #Venta (Campo, Valor) VALUES ('Lista Precios', 	@ListaPrecios)

	UPDATE #Venta SET Valor = '' WHERE Valor IS NULL
  
	RETURN
END
GO


/**************** spPOSOfertaAplicar ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSOfertaAplicar') and type = 'P') DROP PROCEDURE dbo.spPOSOfertaAplicar
GO
CREATE PROCEDURE spPOSOfertaAplicar
	@ID					varchar(50),
	@OfertaFechaHora	varchar(20)	= NULL,
    @PuntosPrecio		bit = 0
--//WITH ENCRYPTION
AS 
BEGIN 
	DECLARE
    @Empresa		              varchar(5),
    @Mov		                  varchar(20),
    @Sucursal		              int,
    @Usuario		              varchar(10),
    @ListaPrecios	              varchar(50),
    @FechaHora		              datetime,
    @Estatus		              varchar(15),
    @FechaEmision	              datetime,
    @FechaRequerida	              datetime,
    @HoraRequerida	              varchar(5),
    @Moneda		                  varchar(10),
    @TipoCambio		              float,
    @DescuentoGlobal	          float,
    @ImporteTotalMN	              float,
    @Aplica		                  bit,
    @SucursalDetalle	          int,
    @VentaMultiAlmacen	          bit,
    @Monedero                     varchar(20),
    @CodigoRedondeo               varchar(30),
    @ArticuloRedondeo             varchar(20),
    @ArtOfertaImporte             varchar(20),
    @ArtOfertaFP                  varchar(20),
    @CfgAnticipoArticuloServicio  varchar(20),
    @ContMoneda		              varchar(10),
    @ContMonedaTC	              float,
    @RedondeoMonetarios           int,
    @Usar                         varchar(20),
    @Forma                        varchar(20),
    @OfertaID                     int   
    
	SELECT @Empresa = Empresa, @Sucursal = Sucursal 
	FROM POSL 
	WHERE ID = @ID  	
    
	SELECT @CodigoRedondeo = RedondeoVentaCodigo , @ArtOfertaFP = ArtOfertaFP, @ArtOfertaImporte = ArtOfertaImporte
    FROM POSCfg 
	WHERE Empresa = @Empresa
  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa) --Bug 20257
    
	SELECT @ContMoneda = ec.ContMoneda
    FROM EmpresaCfg ec 
	WHERE ec.Empresa = @Empresa   
   
	SELECT @ContMonedaTC = TipoCambio 
	FROM POSLTipoCambioRef 
	WHERE Sucursal = @Sucursal AND Moneda = @ContMoneda         
    
	SELECT @ArticuloRedondeo = Cuenta
    FROM CB 
	WHERE Codigo = @CodigoRedondeo AND TipoCuenta = 'Articulos'
  
	SELECT @ArticuloRedondeo = cb.Cuenta 
	FROM CB 
	WHERE CB.Cuenta = @CodigoRedondeo AND CB.TipoCuenta = 'Articulos'       
	
	SELECT @CfgAnticipoArticuloServicio = NULLIF(CxcAnticipoArticuloServicio,'') 
	FROM EmpresaCfg2 
	WHERE Empresa = @Empresa

	SELECT @Mov = Mov, @Empresa = Empresa, @Sucursal = Sucursal, @Usuario = Usuario, @Moneda = Moneda, @TipoCambio = CASE WHEN Moneda <> @ContMoneda THEN  (ISNULL(TipoCambio,1)/@ContMonedaTC) ELSE ISNULL(TipoCambio,1) END, @Estatus = Estatus, @ListaPrecios = ListaPreciosEsp,
         @FechaEmision = FechaEmision, @FechaRequerida = FechaEmision, @HoraRequerida = '00:00', @DescuentoGlobal = DescuentoGlobal,@Monedero = Monedero 
    FROM POSL 
	WHERE ID = @ID
  
    SET @PuntosPrecio = 0     
  
    IF NULLIF(@Monedero,'') IS NOT NULL AND @PuntosPrecio = 1
		SET @PuntosPrecio = 1 
    ELSE
		SET @PuntosPrecio = 0 
     
	SELECT @VentaMultiAlmacen = ISNULL(VentaMultiAlmacen,0) FROM EmpresaCfg2 WHERE Empresa = @Empresa   

	SET @Aplica = 1  
	EXEC xpPOSOfertaAplicar @ID, @Aplica OUTPUT 

	IF @Aplica = 1 
		BEGIN
			IF @OfertaFechaHora IS NULL
				SELECT @OfertaFechaHora = OfertaFechaHora FROM EmpresaCfg2 WHERE Empresa = @Empresa

			IF UPPER(@OfertaFechaHora) = 'FECHA SERVIDOR'  SELECT @FechaHora = GETDATE() ELSE
			IF UPPER(@OfertaFechaHora) = 'FECHA EMISION'   SELECT @FechaHora = @FechaEmision ELSE
			IF UPPER(@OfertaFechaHora) = 'FECHA REQUERIDA' SELECT @FechaHora = dbo.FechaConHora(@FechaRequerida, @HoraRequerida)
    
			-- #Venta 
			CREATE TABLE #Venta (Campo varchar(50) COLLATE Database_Default NOT NULL, Valor varchar(100) COLLATE Database_Default NULL)
			CREATE TABLE #VentaDetalle (Renglon float, Campo varchar(50) COLLATE Database_Default NOT NULL, Valor varchar(100) COLLATE Database_Default NULL)
			EXEC spPOSOfertaVenta @ID
			CREATE INDEX Campo ON #Venta (Campo, Valor)

			-- #VentaD 
			CREATE TABLE #VentaD (
				RID					    int NOT NULL IDENTITY(1,1) PRIMARY KEY,
				Renglon				    float NOT NULL, 
				RenglonSub			    int NOT NULL, 
				RenglonTipo			    varchar(1)	COLLATE Database_Default NULL,
				Articulo				varchar(20) COLLATE Database_Default NOT NULL, 
				SubCuenta				varchar(50) COLLATE Database_Default NULL, 
				Rama					varchar(20) COLLATE Database_Default NULL, 
				Categoria				varchar(50) COLLATE Database_Default NULL, 
				Grupo					varchar(50) COLLATE Database_Default NULL, 
				Familia				    varchar(50) COLLATE Database_Default NULL, 
				Linea					varchar(50) COLLATE Database_Default NULL, 
				Fabricante			    varchar(50) COLLATE Database_Default NULL, 
				Proveedor				varchar(10) COLLATE Database_Default NULL, 
				ABC						varchar(50) COLLATE Database_Default NULL,
				Cantidad				float NULL, 
				Unidad				    varchar(50) COLLATE Database_Default NULL, 
				CantidadInventario		float NULL, 
				PrecioSugerido			float NULL, 
				Precio				    float NULL, 
				Impuesto1				float NULL,
				Descuento				float NULL, 
				DescuentoP1			    float NULL,
				DescuentoP2			    float NULL,
				DescuentoP3			    float NULL,
				DescuentoG1			    float NULL,
				DescuentoG2			    float NULL,
				DescuentoG3			    float NULL,
				DescuentoImporte		money NULL, 
				Puntos				    float NULL, 
				PuntosPorcentaje		float NULL, 
				Comision				float NULL, 
				ComisionPorcentaje		float NULL, 
				CantidadObsequio		float NULL, 
				SucursalDetalle			int	 NULL,
				Almacen				    varchar(20) COLLATE Database_Default NOT NULL, 
				OfertaIDP1			    int NULL,
				OfertaIDP2			    int NULL,
				OfertaIDP3			    int NULL,
				OfertaIDG1			    int NULL,
				OfertaIDG2			    int NULL,
				OfertaIDG3			    int NULL,
				OfertaID				int NULL,
				DescuentoAd				float NULL)
	  
			-- #OfertaLog 
			CREATE TABLE #OfertaLog (
				RID					    int NOT NULL IDENTITY(1,1) PRIMARY KEY,
				OfertaID				int NOT NULL,
				Mov						varchar(20)NULL,
				MovID					varchar(20)NULL,
				Prioridad				int NULL,
				PrioridadG			    int NULL,
				Tipo					varchar(50)NULL,
				Forma					varchar(50)NULL,
				Usar					varchar(50)NULL,
				Articulo				varchar(20) COLLATE Database_Default NOT NULL, 
				SubCuenta				varchar(50) COLLATE Database_Default NULL, 
				Unidad				    varchar(50) COLLATE Database_Default NULL, 
				Descuento				float NULL,
				DescuentoImporte		money NULL, 
				Puntos				    float NULL, 
				PuntosPorcentaje		float NULL, 
				Comision				float NULL, 
				ComisionPorcentaje		float NULL, 
				CantidadObsequio		float NULL,
				Costo					float NULL,
				PrecioBaseCosto			float NULL,
				PrecioBaseLista			float NULL,
				Precio				    float NULL,
				ArticuloObsequio		varchar(20)NULL,
				UnidadObsequio			varchar(5) NULL,
				SubCuentaObsequio		varchar(50) NULL,
				ArtTipo				    varchar(20)NULL,
				CantidadOferta			float NULL,
				DescuentoP1			    float NULL,
				DescuentoP2			    float NULL,
				DescuentoP3			    float NULL,
				DescuentoG1			    float NULL,
				DescuentoG2			    float NULL,
				DescuentoG3			    float NULL,
				SucursalDetalle			int	 NULL,
				OfertaIDP1			    int NULL,
				OfertaIDP2			    int NULL,
				OfertaIDP3			    int NULL,
				OfertaIDG1			    int NULL,
				OfertaIDG2			    int NULL,
				OfertaIDG3			    int NULL,
				Descripcion			    varchar(255) NULL)

			CREATE TABLE #ArtObsequio (Articulo varchar(20) COLLATE Database_Default NOT NULL, OfertaID INT NULL, Unidad varchar(50) NULL, SubCuenta varchar(50) NULL)
    
			INSERT #VentaD (
					Renglon,   RenglonSub,   RenglonTipo,   Articulo,   SubCuenta,   Rama,   Categoria,   Grupo,   Familia,   Linea,   Fabricante,   Proveedor, 
					Cantidad,   Unidad,   PrecioSugerido, CantidadInventario, Almacen,SucursalDetalle, Impuesto1, Descuento, DescuentoAd) 
    
			SELECT 
					d.Renglon, d.RenglonSub, d.RenglonTipo,d.Articulo, d.SubCuenta, a.Rama, a.Categoria, a.Grupo, a.Familia, a.Linea, a.Fabricante, a.Proveedor, 
					d.Cantidad, d.Unidad, PrecioSugerido, ISNULL(ISNULL(d.CantidadInventario, d.Cantidad*dbo.fnArtUnidadFactor(@Empresa, d.Articulo, d.Unidad)), 0.0), 
					p.Almacen,@Sucursal,d.Impuesto1, NULL, d.DescuentoAd
			FROM POSLVenta d
			JOIN POSL p ON p.ID = d.ID
			JOIN Art a ON a.Articulo = d.Articulo
			WHERE d.ID = @ID AND ISNULL(d.Aplicado,0) = 0 AND d.Articulo NOT IN(@ArticuloRedondeo,@CfgAnticipoArticuloServicio,@ArtOfertaFP) AND d.RenglonTipo <> 'K'

			CREATE INDEX Renglon    ON #VentaD (Renglon, RenglonSub)
			CREATE INDEX Articulo   ON #VentaD (Articulo)
			CREATE INDEX Rama       ON #VentaD (Rama)
			CREATE INDEX Categoria  ON #VentaD (Categoria)
			CREATE INDEX Grupo      ON #VentaD (Grupo)
			CREATE INDEX Familia    ON #VentaD (Familia)
			CREATE INDEX Linea      ON #VentaD (Linea)
			CREATE INDEX Fabricante ON #VentaD (Fabricante)
			CREATE INDEX RenglonTipo ON #VentaD (Renglon, RenglonSub, RenglonTipo)

			-- #OfertaActiva
			CREATE TABLE #OfertaActiva (ID int NOT NULL, Sucursal int NOT NULL, MovTipo varchar(20) COLLATE Database_Default NULL PRIMARY KEY (ID, Sucursal))
			EXEC spOfertaPrecioSugerido @Empresa, @Sucursal, @Moneda, @TipoCambio, @ListaPrecios

			SELECT @ImporteTotalMN = SUM(Cantidad*PrecioSugerido)*@TipoCambio FROM #VentaD
			EXEC spOfertaActiva @Empresa, @Sucursal, @FechaHora, @ImporteTotalMN
			EXEC spOfertaProcesar @Empresa, @Sucursal, @Moneda, @TipoCambio, @ListaPrecios, @ID = NULL, @PuntosPrecio=@PuntosPrecio

			UPDATE #VentaD 
			SET OfertaID = ISNULL(OfertaIDP1,ISNULL(OfertaIDP2,ISNULL(OfertaIDP3,ISNULL(OfertaIDG1,ISNULL(OfertaIDG2,ISNULL(OfertaIDG2,0)))))) 
			WHERE ISNULL(OfertaID,0) = 0

			UPDATE #VentaD
			SET Descuento = dbo.fnPorcentajeImporte(Cantidad*Precio, DescuentoImporte)
			WHERE NULLIF(DescuentoImporte, 0.0) IS NOT NULL

			UPDATE #VentaD
			SET Puntos = CASE WHEN EXISTS(SELECT ID FROM Oferta WHERE Estatus = 'VIGENTE' AND (FORMA LIKE '%PUNTOS%' AND FORMA LIKE '%CANTIDAD%'))
									THEN Puntos
							  ELSE 
									dbo.fnPorcentaje(dbo.fnDisminuyePorcentaje(Cantidad*Precio, Descuento), PuntosPorcentaje)
							  END
			WHERE NULLIF(PuntosPorcentaje, 0.0) IS NOT NULL

			UPDATE #VentaD
			SET Puntos =  CASE WHEN EXISTS(SELECT ID FROM Oferta WHERE Estatus = 'VIGENTE' AND (FORMA LIKE '%PUNTOS%' AND FORMA LIKE '%CANTIDAD%'))
									THEN Puntos
							   ELSE 
									Puntos*Cantidad
							   END
     		WHERE Puntos IS NOT NULL AND NULLIF(PuntosPorcentaje, 0.0) IS NULL

			UPDATE #VentaD
			SET Comision = dbo.fnPorcentaje(dbo.fnDisminuyePorcentaje(Cantidad*Precio, Descuento), ComisionPorcentaje)
			WHERE NULLIF(ComisionPorcentaje, 0.0) IS NOT NULL

			UPDATE #VentaD
			SET PrecioSugerido = ROUND(PrecioSugerido,@RedondeoMonetarios), Precio = ROUND(Precio,@RedondeoMonetarios)          
         
			UPDATE POSLVenta
			SET PrecioSugerido = ISNULL(d.PrecioSugerido, t.PrecioSugerido),
				Precio = dbo.fnPOSPrecio(@Empresa,ISNULL(t.Precio, t.PrecioSugerido),d.Impuesto1, d.Impuesto2, d.Impuesto3),
				DescuentoLinea = ISNULL(t.Descuento,DescuentoLinea),
				DescuentoImporte = NULL,
				Comision = t.Comision,
				CantidadObsequio = t.CantidadObsequio,
				OfertaID = t.OfertaID,
				Puntos = CASE WHEN EXISTS(SELECT ID FROM Oferta WHERE Estatus = 'VIGENTE' AND (FORMA LIKE '%IMPORTE%' AND FORMA LIKE '%PUNTOS%') 
											AND (USAR LIKE '%CANTIDAD%' OR USAR LIKE '%PORCENTAJE%') AND ID = t.OfertaID) 
									THEN t.Puntos
							  WHEN EXISTS(SELECT ID FROM Oferta WHERE Estatus = 'VIGENTE' AND FORMA LIKE '%PUNTOS%' AND USAR LIKE '%CANTIDAD%') 
									THEN t.Puntos
							  WHEN EXISTS(SELECT ID FROM Oferta WHERE Estatus = 'VIGENTE' AND FORMA LIKE '%PUNTOS%' AND ID = t.OfertaID) 
									THEN dbo.fnImporteMonTarjeta2(t.Precio*t.Cantidad,@Monedero,t.OfertaID,@Sucursal)
							  END
				FROM POSLVenta d 
				JOIN #VentaD t ON t.Renglon = d.Renglon AND t.RenglonSub = d.RenglonSub AND t.RenglonTipo = d.RenglonTipo
				WHERE d.ID = @ID AND d.RenglonTipo <>'C'
				AND ISNULL(d.Aplicado,0) = 0
     
				UPDATE POSLVenta SET PrecioImpuestoInc = dbo.fnPOSPrecioConImpuestos(Precio,Impuesto1, Impuesto2, Impuesto3, @Empresa)
				WHERE ID = @ID AND RenglonTipo <>'C'
				AND ISNULL(Aplicado,0) = 0   

				SELECT @Usar =NULLIF(o.Usar,''), @Forma = NULLIF(o.Forma,''), @OfertaID = o.id
				FROM POSLVenta d 
				JOIN #VentaD t ON t.Renglon = d.Renglon AND t.RenglonSub = d.RenglonSub AND t.RenglonTipo = d.RenglonTipo
				JOIN oferta o ON O.Id = t.OfertaID  
				WHERE d.ID = @ID AND d.RenglonTipo <>'C' AND ISNULL(d.Aplicado,0) = 0 
     
				IF (@Usar <> 'PORCENTAJE' and @Forma <> 'PUNTOS'  and  NULLIF(@Usar,'') IS NOT NULL AND NULLIF(@Forma,'') IS NOT NULL)
					BEGIN   
						IF (SELECT COUNT(*) FROM #OfertaLog) > 0 
						  BEGIN		
								  DELETE OfertaLogPos WHERE ID = @ID AND Articulo IN (SELECT Articulo FROM #OfertaLog)
			
								  INSERT OfertaLogPos (ID, OfertaID, RID, Prioridad, PrioridadG, Mov,MovID, Tipo, Forma, Usar, Articulo,
														 SubCuenta, Unidad, Descuento, DescuentoImporte, Costo, PrecioBaseCosto, PrecioBaseLista, 
												 Precio, Puntos, PuntosPorcentaje, Comision, ArticuloObsequio, CantidadObsequio, 
												 ComisionPorcentaje, UnidadObsequio, DescuentoP1,DescuentoP2, DescuentoP3, DescuentoG1, 
												 DescuentoG2, DescuentoG3, OfertaIDP1, OfertaIDP2, OfertaIDP3, OfertaIDG1, OfertaIDG2, 
												 OfertaIDG3,EsPuntos, Descripcion, SubCuentaObsequio)
											  SELECT @ID,OfertaID, RID, Prioridad, PrioridadG, Mov, MovID, Tipo, Forma, Usar, Articulo,
														 SubCuenta, Unidad, Descuento, DescuentoImporte, Costo, PrecioBaseCosto, PrecioBaseLista, 
												 Precio, Puntos, PuntosPorcentaje, Comision, ArticuloObsequio, CantidadObsequio, 
												 ComisionPorcentaje, UnidadObsequio, DescuentoP1,DescuentoP2, DescuentoP3, DescuentoG1, 
												 DescuentoG2, DescuentoG3, OfertaIDP1, OfertaIDP2, OfertaIDP3, OfertaIDG1,
														 OfertaIDG2, OfertaIDG3,1, Descripcion, SubCuentaObsequio
												  FROM #OfertaLog 
						  END
						ELSE
							RETURN
					END
				ELSE
					BEGIN 
						IF (SELECT COUNT(*) FROM #OfertaLog) > 0 
							BEGIN		
									DELETE OfertaLogPos WHERE ID = @ID AND Articulo IN (SELECT Articulo FROM #OfertaLog)
                          			
									INSERT OfertaLogPos (ID, OfertaID, RID, Prioridad, PrioridadG, Mov,MovID, Tipo, Forma, Usar, Articulo,
															 SubCuenta, Unidad, Descuento, DescuentoImporte, Costo, PrecioBaseCosto, PrecioBaseLista, 
															 Precio, Puntos, PuntosPorcentaje, Comision, ArticuloObsequio, CantidadObsequio, 
															 ComisionPorcentaje, UnidadObsequio, DescuentoP1,DescuentoP2, DescuentoP3, DescuentoG1, 
															 DescuentoG2, DescuentoG3, OfertaIDP1, OfertaIDP2, OfertaIDP3, OfertaIDG1, OfertaIDG2, 
															 OfertaIDG3,EsPuntos, Descripcion, SubCuentaObsequio)
												SELECT @ID,OfertaID, RID, Prioridad, PrioridadG, Mov, MovID, Tipo, Forma, Usar, Articulo,
															 SubCuenta, Unidad, Descuento, DescuentoImporte, Costo, PrecioBaseCosto, PrecioBaseLista, 
															 Precio, Puntos, PuntosPorcentaje, Comision, ArticuloObsequio, CantidadObsequio, 
															 ComisionPorcentaje, UnidadObsequio, DescuentoP1,DescuentoP2, DescuentoP3, DescuentoG1, 
															 DescuentoG2, DescuentoG3, OfertaIDP1, OfertaIDP2, OfertaIDP3, OfertaIDG1,
															 OfertaIDG2, OfertaIDG3,1, Descripcion, SubCuentaObsequio
												FROM #OfertaLog
							END
						ELSE
							RETURN    
					END
		END
  
	RETURN
END
GO


/************************ spPOSCFD *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSCFD') AND type = 'P') DROP PROCEDURE dbo.spPOSCFD
GO             
CREATE PROCEDURE spPOSCFD
	@ID			varchar(36),	     
	@Ok			int OUTPUT,
	@OkRef		varchar(255) OUTPUT
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@IDGenerar			int,
	@Calcular			bit,
	@Encripcion			varchar(20),
	@XMLFinal			varchar(max),
	@CadenaOriginal		varchar(MAX),
	@Certificado		varchar(20),
	@Sello				varchar(255),
	@DocumentoXML		varchar(MAX),
	@OkDesc				varchar(255)
	  
END
GO


/************************ spPOSMovCopiar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSMovCopiar') AND type = 'P') DROP PROCEDURE dbo.spPOSMovCopiar
GO             
CREATE PROCEDURE spPOSMovCopiar
	@ID	varchar(50),	
	@Codigo	varchar(50), 
	@Modulo	varchar(5),
	@Ok	int	OUTPUT,
	@OkRef	int	OUTPUT
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@IDMov		int,
	@Mov			varchar(20),
	@MovID		varchar(20),
	@Concepto		varchar(50),
	@Proyecto		varchar(50),
	@UEN			int,
	@Moneda		varchar(10),
	@TipoCambio		float,
	@Referencia		varchar(50),
	@Observaciones	varchar(100),
	@Cliente		varchar(10),
	@CteEnviarA		int,
	@Agente		varchar(10),
	@Almacen		varchar(10),
	@FormaEnvio		varchar(50),
	@OrdenCompra		varchar(50),
	@Condicion		varchar(50),
	@Vencimiento		datetime,
	@Descuento		varchar(50),
	@DescuentoGlobal	float,
	@Causa		varchar(50),
	@Atencion		varchar(50),
	@AtencionTelefono	varchar(50),
	@ListaPreciosEsp	varchar(20),
	@ZonaImpuesto		varchar(50),	  
	@Estatus		varchar(15),
	@Host			varchar(20),
	@Cluster		varchar(20),
	@Empresa		varchar(5)
  
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
  
	IF @Modulo = 'VTAS'
		BEGIN
			SELECT @IDMov = v.ID
			FROM Venta v
			WHERE CONVERT(varchar, v.ID) = @Codigo
			OR UPPER(LTRIM(RTRIM(v.Mov))+ ' ' + LTRIM(RTRIM(v.MovID))) = @Codigo
    
			SELECT 
				@Mov = v.Mov,
				@MovID = v.MovID,
				@Concepto = v.Concepto, 
				@Proyecto = v.Proyecto, 
				@UEN = v.UEN, 
				@Moneda = v.Moneda, 
				@TipoCambio = v.TipoCambio, 
				@Referencia = v.Referencia, 
				@Observaciones = v.Observaciones, 
				@Cliente = v.Cliente, 
				@CteEnviarA = v.EnviarA, 
				@Agente = v.Agente, 
				@Almacen = v.Almacen, 
				@FormaEnvio = v.FormaEnvio,
				@OrdenCompra = v.OrdenCompra,
				@Condicion = v.Condicion, 
				@Vencimiento = v.Vencimiento, 
				@Descuento = v.Descuento, 
				@DescuentoGlobal = v.DescuentoGlobal, 
				@Causa = v.Causa, 
				@Atencion = v.Atencion, 
				@AtencionTelefono = v.AtencionTelefono, 
				@ListaPreciosEsp = v.ListaPreciosEsp, 
				@ZonaImpuesto = v.ZonaImpuesto,
				@Estatus = @Estatus,
				@Empresa = Empresa
      		FROM Venta v	   
			WHERE v.ID = @IDMov
     
			UPDATE POSL 
			SET Concepto = @Concepto, Proyecto = @Proyecto, UEN = @UEN, Moneda = @Moneda, TipoCambio = @TipoCambio, Referencia = @Referencia,
				Observaciones = @Observaciones, Cliente = @Cliente, EnviarA = @CteEnviarA, Almacen = @Almacen, Agente = @Agente, FormaEnvio = @FormaEnvio,
				Condicion = @Condicion,Vencimiento = @Vencimiento, Descuento = @Descuento, DescuentoGlobal = @DescuentoGlobal, Causa = @Causa,
				Atencion = @Atencion, AtencionTelefono = @AtencionTelefono, ListaPreciosEsp = @ListaPreciosEsp, ZonaImpuesto = @ZonaImpuesto,
			Host = @Host
			WHERE ID = @ID
           
			INSERT POSLVenta (
				ID,  Renglon,    RenglonID,    RenglonTipo,    Cantidad,    Articulo,    SubCuenta,    Precio,    DescuentoLinea, 
				Impuesto1,    Impuesto2,    Impuesto3,    Unidad,    Factor,    CantidadInventario, PrecioImpuestoInc, Codigo, Almacen)
            SELECT 
				@ID, vd.Renglon, vd.RenglonID, vd.RenglonTipo, vd.Cantidad, vd.Articulo, vd.SubCuenta, vd.Precio, vd.DescuentoLinea, 
				vd.Impuesto1, vd.Impuesto2, vd.Impuesto3, vd.Unidad, vd.Factor, vd.CantidadInventario, 
				dbo.fnPOSPrecioConImpuestos(vd.precio,vd.Impuesto1, vd.Impuesto2, vd.Impuesto3, @Empresa), vd.Codigo, vd.Almacen
             FROM VentaD vd                      
             WHERE vd.ID = @IDMov
    
			IF @Estatus = 'PENDIENTE'
				BEGIN
					UPDATE POSL SET OrigenTipo = @Modulo, Origen = @Mov, OrigenID = @MovID
					WHERE ID = @ID
				 
					UPDATE POSLVenta SET Aplica = @Mov, AplicaID = @MovID
					WHERE ID = @ID
				END
		END
END	     
GO	


/************************ spPOSMovNavega *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSMovNavega') AND type = 'P') DROP PROCEDURE dbo.spPOSMovNavega
GO             
CREATE PROCEDURE spPOSMovNavega
	@ID				varchar(36) OUTPUT,
	@Usuario        varchar(10),
	@EnSilencio		bit = 0
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@IDSiguiente	varchar(36),
	@Host			varchar(20),
	@Cluster		varchar(20),
	@Caja			varchar(10),
	@MovClave		varchar(20)

	SELECT @Caja = CtaDinero
    FROM POSL
	WHERE ID = @ID
    
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT

	SELECT TOP 1 @IDSiguiente = posl.ID
    FROM POSL posl
	INNER JOIN MovTipo mt ON posl.Mov = mt.Mov	
	AND mt.Modulo = 'POS'
	WHERE posl.Host = @Host
    AND posl.Usuario = @Usuario
    AND (posl.Ctadinero = @Caja OR posl.CtaDineroDestino = @Caja)
    AND posl.ID > @ID
    AND ISNULL(posl.Estatus, 'SINAFECTAR') = 'SINAFECTAR'
	ORDER BY posl.ID ASC
  
	IF @IDSiguiente IS NULL  
		SELECT @IDSiguiente = MIN(posl.ID)
		FROM POSL posl
		INNER JOIN MovTipo mt ON posl.Mov = mt.Mov	
		AND mt.Modulo = 'POS'
		WHERE posl.Host = @Host
		AND posl.Usuario = @Usuario
		AND (posl.Ctadinero = @Caja OR posl.CtaDineroDestino = @Caja)
		AND ISNULL(posl.Estatus, 'SINAFECTAR') = 'SINAFECTAR'
              
	IF @EnSilencio = 0    
		SELECT @IDSiguiente
END
GO


/************************ spPOSSeparadorCodigoExtendido *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSSeparadorCodigoExtendido') AND type = 'P') DROP PROCEDURE dbo.spPOSSeparadorCodigoExtendido
GO             
CREATE PROCEDURE spPOSSeparadorCodigoExtendido
	@Caracter			varchar(1),
	@Mascara			varchar(50),
	@CodigoExtendido	varchar(50),
	@Decimales			int,
	@Codigo				varchar(50) OUTPUT
--//WITH ENCRYPTION		
AS 
BEGIN
	DECLARE
	@MascaraReverso		varchar(50),
	@CodigoReverso		varchar(50),
	@LargoMascara		int,		
	@PrimerCaracter		int,
	@UltimoCaracter		int
  
	IF NULLIF(@Decimales,0) IS NULL
		SELECT @Decimales = 0
    
	SELECT @MascaraReverso = REVERSE(@Mascara),
		@LargoMascara = LEN(@Mascara)

	SELECT @PrimerCaracter = CHARINDEX(@Caracter, @Mascara)
	SELECT @UltimoCaracter = @LargoMascara - CHARINDEX(@Caracter, @MascaraReverso)

	SELECT @Codigo = SUBSTRING(@CodigoExtendido, @PrimerCaracter, @UltimoCaracter + 2 - @PrimerCaracter)
  
	IF @Decimales >=1
		BEGIN
			SELECT @CodigoReverso = REVERSE(@Codigo)
			SELECT @Codigo = SUBSTRING(@CodigoReverso, 1, @Decimales) + '.' + SUBSTRING(@CodigoReverso, @Decimales + 1, LEN(@CodigoReverso))
			SELECT @Codigo = REVERSE(@Codigo)
		END
END
GO


/************************ spPOSAgregarClienteExpress *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAgregarClienteExpress') AND type = 'P') DROP PROCEDURE dbo.spPOSAgregarClienteExpress
GO             
CREATE PROCEDURE spPOSAgregarClienteExpress
	@Sucursal			int,
	@Cliente			varchar(20),
	@Nombre			varchar(100),
	@Direccion			varchar(100),
	@DireccionNumero		varchar(20),
	@DireccionNumeroInt	varchar(20),
	@EntreCalles		varchar(100),
	@Delegacion		varchar(100),
	@Colonia			varchar(100),
	@Poblacion			varchar(100),
	@Estado			varchar(50),
	@Pais			varchar(50),
	@CodigoPostal		varchar(15),
	@RFC			varchar(15),
	@CURP			varchar(50),
	@Contacto1			varchar(50) = NULL,
	@Email1			varchar(50) = NULL,
	@ClienteNuevo		bit	    = 0,
	@ZonaImpuesto              varchar(50) = NULL,
    @FechaNacimiento	        datetime  =   NULL,
    @EstadoCivil	        varchar(20)=  NULL,
    @Conyuge	                varchar(100)= NULL,	
    @Sexo	                varchar(20)  =  NULL,	
    @Profesion	                varchar(100)   = NULL,	
    @Puesto	                varchar(100)   = NULL,
    @NumeroHijos	        int            = NULL,
    @Religion	                varchar(50)    = NULL		     
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE 
	@Consecutivo		int,
	@Host			varchar(20),
	@Cluster		varchar(20)
  
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
	  
	IF EXISTS(SELECT 1 FROM Cte WHERE Cliente = @Cliente AND @ClienteNuevo = 0)
		UPDATE Cte Set Nombre = @Nombre,
  		   Direccion = @Direccion,
  		   DireccionNumero = @DireccionNumero,
		   DireccionNumeroInt = @DireccionNumeroInt,
		   EntreCalles = @EntreCalles,
		   Delegacion = @Delegacion,
		   Colonia = @Colonia,
		   Poblacion = @Poblacion,
		   Estado = @Estado,
		   Pais = @Pais,
		   CodigoPostal = @CodigoPostal,
		   RFC = @RFC,
		   CURP = CURP,
		   Contacto1 = @Contacto1,
		   Email1 = @Email1,
		   ZonaImpuesto = @ZonaImpuesto,
		   FechaNacimiento = @FechaNacimiento,	
           EstadoCivil	= @EstadoCivil,
		   Conyuge	= @Conyuge,	
		   Sexo = @Sexo	,	
		   Profesion = @Profesion ,	
		   Puesto = @Puesto,		
		   NumeroHijos	= @NumeroHijos,
           Religion = @Religion
	     WHERE Cliente = @Cliente
	ELSE
		BEGIN    
			IF NOT EXISTS(SELECT * FROM ConsecutivoSucursal WHERE Tipo = 'Cte' AND Sucursal = @Sucursal)
				INSERT ConsecutivoSucursal(Tipo,  Sucursal, Consecutivo)
				SELECT                     'CTE', @Sucursal, 0
       
			SELECT @Consecutivo = ISNULL(Consecutivo,0)
			FROM ConsecutivoSucursal cs
			WHERE cs.Tipo = 'Cte'
			AND cs.Sucursal = @Sucursal
 
			SELECT @Cliente = @Host + CONVERT(varchar, ISNULL(@Consecutivo,0) + 1)
        
			UPDATE ConsecutivoSucursal SET Consecutivo = ISNULL(Consecutivo,0) +1
			WHERE Tipo = 'Cte'
			AND Sucursal = @Sucursal
      
			IF EXISTS (SELECT 1 FROM Cte WHERE Cliente = @Cliente)
				BEGIN
					SELECT @Cliente = NULL
				END
      
			IF @Cliente IS NOT NULL
				INSERT Cte (
					Cliente, Nombre, Direccion, DireccionNumero, DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, Estado, Pais, CodigoPostal,
					RFC, CURP, Tipo, Estatus, Contacto1, eMail1, ZonaImpuesto, FechaNacimiento, EstadoCivil, Conyuge, Sexo, Profesion, Puesto, 
					NumeroHijos, Religion)	          
				VALUES (
					@Cliente, @Nombre, @Direccion, @DireccionNumero, @DireccionNumeroInt, @EntreCalles, @Delegacion, @Colonia, @Poblacion, @Estado, @Pais, @CodigoPostal,
					@RFC, @CURP, 'Cliente', 'ALTA', @Contacto1, @Email1, @ZonaImpuesto, @FechaNacimiento, @EstadoCivil, @Conyuge , @Sexo, @Profesion, @Puesto,
					@NumeroHijos, @Religion)
		END
  
  SELECT @Cliente
END
GO      


/************************ spPOSInsertaCliente *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertaCliente') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertaCliente
GO             
CREATE PROCEDURE spPOSInsertaCliente
	@Empresa		varchar(5),
	@ID				varchar(50),
	@Codigo			varchar(50),
	@CtaDinero		varchar(10),
	@Cliente		varchar(10),
	@Estacion       int,
	@Imagen			varchar(255)	OUTPUT,
	@Ok				int		OUTPUT,
	@OkRef			varchar(255)	OUTPUT
--//WITH ENCRYPTION	     	     
AS
BEGIN
	DECLARE 
	@Proyecto				varchar(50),
	@Almacen				varchar(10),
	@Agente					varchar(10),
	@Cajero					varchar(10),
	@FormaEnvio				varchar(50),
	@Condicion				varchar(50),
	@Vencimiento			varchar(50),
	@Descuento				varchar(50),
	@DescuentoGlobal		varchar(50),
	@ListaPreciosEsp		varchar(20),
	@ZonaImpuesto			varchar(50),
	@ZonaImpuestoSucursal	varchar(50),
	@ZonaImpuestoEnviarA	varchar(50),
	@ImagenNombreAnexo		varchar(255),
	@Usuario				varchar(10),
	@Sucursal				int,	  
	@Nombre					varchar(100),
	@Direccion				varchar(100),
	@DireccionNumero		varchar(20),
	@DireccionNumeroInt		varchar(20),
	@EntreCalles			varchar(100),
	@Delegacion				varchar(100),
	@Colonia				varchar(100),
	@Poblacion				varchar(100),
	@Estado					varchar(50),
	@Pais					varchar(50),
	@Zona					varchar(50),
	@CodigoPostal			varchar(15),
	@RFC					varchar(15),
	@CURP					varchar(50),	
	@ListaPreciosSucursal	varchar(20),		
	@ListaPreciosUsuario	varchar(20),
	@EnviarA				int,
    @FechaNacimiento		datetime  ,
    @EstadoCivil	        varchar(20),
    @Conyuge				varchar(100),	
    @Sexo	                varchar(20),	
    @Fuma	                bit,
    @Profesion				varchar(100),	
    @Puesto					varchar(100),
    @NumeroHijos	        int,
    @Religion				varchar(50),
    @Categoria				varchar(50),		     
    @Grupo					varchar(50),		     
    @Familia				varchar(50)
		  
	SELECT @Sucursal = p.Sucursal, @Usuario = p.Usuario, @EnviarA = p.EnviarA
    FROM POSL p
    WHERE p.ID = @ID
  
	SELECT @ListaPreciosSucursal = ListaPreciosEsp, @ZonaImpuestoSucursal = ZonaImpuesto
    FROM Sucursal
	WHERE Sucursal = @Sucursal
  
	SELECT @ListaPreciosUsuario = DefListaPreciosEsp
    FROM Usuario
	WHERE Usuario = @Usuario
   
	IF @EnviarA IS NOT NULL AND @Cliente IS NOT NULL
		SELECT @ZonaImpuestoEnviarA = ZonaImpuesto
		FROM CteEnviarA 
		WHERE Cliente = @Cliente AND ID = @EnviarA  
   
	IF @EnviarA IS NOT NULL AND @Cliente IS  NULL
		SELECT @ZonaImpuestoEnviarA = ZonaImpuesto
		FROM CB c
		JOIN CteEnviarA ct ON ct.Cliente = c.Cuenta
		WHERE c.Codigo = @Codigo AND ct.ID = @EnviarA     

	IF @Cliente IS NOT NULL
		SELECT 
			@Proyecto = ct.Proyecto,
			@Agente = ct.Agente,
			@FormaEnvio = ct.FormaEnvio,
	        @Condicion = ct.Condicion,
		    @Descuento = ct.Descuento,
			@DescuentoGlobal = d.Porcentaje,
			@ListaPreciosEsp = ISNULL(ISNULL(ISNULL(NULLIF(ct.ListaPreciosEsp,''), NULLIF(@ListaPreciosUsuario,'')), NULLIF(@ListaPreciosSucursal,'')),'(Precio Lista)'),
			@ZonaImpuesto = ISNULL(NULLIF(@ZonaImpuestoEnviarA,''),ISNULL(ISNULL(NULLIF(ct.ZonaImpuesto,''),NULLIF(u.DefZonaImpuesto,'')),NULLIF(@ZonaImpuestoSucursal,''))),
			@Nombre	= ct.Nombre,
			@Direccion = ct.Direccion,
 			@DireccionNumero = ct.DireccionNumero,
 			@DireccionNumeroInt	= ct.DireccionNumeroInt,
			@EntreCalles = ct.EntreCalles,		
			@Delegacion = ct.Delegacion,	
			@Colonia = ct.Colonia,	
			@Poblacion = ct.Poblacion,
			@Estado = ct.Estado,		
			@Pais = ct.Pais,			
			@Zona= ct.Zona,			
			@CodigoPostal = ct.CodigoPostal,
			@RFC = ct.RFC,		
			@CURP = ct.CURP,
			@FechaNacimiento = ct.FechaNacimiento,
			@EstadoCivil = ct.EstadoCivil,	 
			@Conyuge = ct.Conyuge,
			@Sexo = ct.Sexo ,     
			@Fuma = ct.Fuma  ,   
			@Profesion = ct.Profesion,
			@Puesto = ct.Puesto,
			@NumeroHijos = ct.NumeroHijos,
			@Religion = ct.Religion
		FROM Cte ct 
		LEFT OUTER JOIN Descuento d ON ct.Descuento = d.Descuento  
		JOIN Usuario u ON 1=1   
		WHERE ct.Cliente = @Cliente
		AND u.Usuario = @Usuario
     
		IF @Cliente IS NULL
			SELECT @Cliente = c.Cuenta,
				@Proyecto = ct.Proyecto,
				@Almacen = ct.AlmacenDef,
				@Agente = ct.Agente,
				@FormaEnvio = ct.FormaEnvio,
				@Condicion = ct.Condicion,
				@Descuento = ct.Descuento,
				@DescuentoGlobal = d.Porcentaje,
				@ListaPreciosEsp =  ISNULL(ISNULL(ISNULL(NULLIF(@ListaPreciosEsp,''), NULLIF(@ListaPreciosUsuario,'')), NULLIF(@ListaPreciosSucursal,'')),'(Precio Lista)'),
				@ZonaImpuesto = ISNULL(NULLIF(@ZonaImpuestoEnviarA,''),ISNULL(ISNULL(NULLIF(ct.ZonaImpuesto,''),
						NULLIF(u.DefZonaImpuesto,'')),NULLIF(@ZonaImpuestoSucursal,''))),
				@Nombre = ct.Nombre,
				@Direccion = ct.Direccion,
 				@DireccionNumero = ct.DireccionNumero,
 				@DireccionNumeroInt	= ct.DireccionNumeroInt,
				@EntreCalles = ct.EntreCalles,		
				@Delegacion = ct.Delegacion,	
				@Colonia = ct.Colonia,	
				@Poblacion = ct.Poblacion,
				@Estado	= ct.Estado,		
				@Pais = ct.Pais,			
				@Zona = ct.Zona,			
				@CodigoPostal = ct.CodigoPostal,
				@RFC = ct.RFC,		
				@CURP = ct.CURP,
				@FechaNacimiento = ct.FechaNacimiento,
				@EstadoCivil = ct.EstadoCivil,	 
				@Conyuge = ct.Conyuge,
				@Sexo = ct.Sexo ,     
				@Fuma = ct.Fuma  ,   
				@Profesion = ct.Profesion,
				@Puesto = ct.Puesto,
				@NumeroHijos = ct.NumeroHijos,
				@Religion = ct.Religion	   
			FROM CB c
			INNER JOIN Cte ct ON ct.Cliente = c.Cuenta
			LEFT OUTER JOIN Descuento d ON ct.Descuento = d.Descuento  
			JOIN Usuario u ON 1=1   
			WHERE c.Codigo = @Codigo
			AND u.Usuario = @Usuario
   
		IF @Cliente IS NULL
			SELECT @Ok = 26060, @OkRef = @Codigo

		IF @Ok IS NULL
			EXEC xpPOSVentaInsertaClienteVerificar @Empresa, @ID, @Codigo, @Cliente, @CtaDinero, @Ok OUTPUT, @OkRef OUTPUT

		IF @Ok IS NULL
			BEGIN
				UPDATE POSL SET Cliente = @Cliente, 
				Proyecto = @Proyecto, 
				Agente = ISNULL(NULLIF(@Agente,''),Agente),
				FormaEnvio = @FormaEnvio, 
				Condicion = ISNULL(NULLIF(@Condicion,''),Condicion), 
				Descuento = ISNULL(NULLIF(@Descuento,''),Descuento), 
				DescuentoGlobal = ISNULL(NULLIF(@DescuentoGlobal,''),DescuentoGlobal), 
				ListaPreciosEsp = @ListaPreciosEsp, 
				ZonaImpuesto = NULLIF(@ZonaImpuesto,''),
				Nombre = @Nombre,
				Direccion = @Direccion,
				DireccionNumero	= @DireccionNumero,
				DireccionNumeroInt = @DireccionNumeroInt,
				EntreCalles	= @EntreCalles,
				Delegacion = @Delegacion,	
				Colonia = @Colonia,
				Poblacion = @Poblacion,
				Estado = @Estado,
				Pais = @Pais,
				Zona = @Zona,
				CodigoPostal = @CodigoPostal,
				RFC	= @RFC,
				CURP = @CURP,
				FechaNacimiento = @FechaNacimiento ,
				EstadoCivil	= @EstadoCivil,	    
				Conyuge	= @Conyuge,	    
				Sexo = @Sexo,   
				Fuma = @Fuma,    
				Profesion = @Profesion,	    
				Puesto = @Puesto,	    
				NumeroHijos	= @NumeroHijos,
				Religion = @Religion	        	       
				WHERE ID = @ID

				SELECT @ImagenNombreAnexo = pc.ImagenNombreAnexo 
				FROM POSCfg pc
				WHERE pc.Empresa = @Empresa
       
				SELECT @Imagen = MAX(ac.Direccion)
				FROM AnexoCta ac
				WHERE ac.Nombre = @ImagenNombreAnexo
				AND Rama = 'CXC'
				AND ac.Cuenta = @Cliente
				AND ac.Tipo = 'Imagen'      
			END 
   
		IF @Ok IS NULL
			EXEC spPOSArtPrecioRecalcular @ID, @Estacion
END   
GO  


/************************ spPOSInsertaCliente2 *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertaCliente2') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertaCliente2
GO             
CREATE PROCEDURE spPOSInsertaCliente2
	@Empresa		varchar(5),
	@ID				varchar(50),
	@Codigo			varchar(50),
	@CtaDinero		varchar(10),
	@Cliente		varchar(10),
	@Estacion       int,
	@Imagen			varchar(255)	OUTPUT,
	@Ok				int				OUTPUT,
	@OkRef			varchar(255)	OUTPUT,
	@EsFactura		bit	= 0
--//WITH ENCRYPTION	     	     
AS
BEGIN
	DECLARE 
	@Proyecto				varchar(50),
	@Almacen				varchar(10),
	@Agente					varchar(10),
	@Cajero					varchar(10),
	@FormaEnvio				varchar(50),
	@Condicion				varchar(50),
	@Vencimiento			varchar(50),
	@Descuento				varchar(50),
	@DescuentoGlobal		varchar(50),
	@ListaPreciosEsp		varchar(20),
	@ZonaImpuesto			varchar(50),
	@ZonaImpuestoSucursal	varchar(50),
	@ZonaImpuestoEnviarA	varchar(50),
	@ImagenNombreAnexo		varchar(255),
	@Usuario				varchar(10),
	@Sucursal				int,	  
	@Nombre					varchar(100),
	@Direccion				varchar(100),
	@DireccionNumero		varchar(20),
	@DireccionNumeroInt		varchar(20),
	@EntreCalles			varchar(100),
	@Delegacion				varchar(100),
	@Colonia				varchar(100),
	@Poblacion				varchar(100),
	@Estado					varchar(50),
	@Pais					varchar(50),
	@Zona					varchar(50),
	@CodigoPostal			varchar(15),
	@RFC					varchar(15),
	@CURP					varchar(50),	
	@ListaPreciosSucursal	varchar(20),		
	@ListaPreciosUsuario	varchar(20),
	@EnviarA				int,
    @FechaNacimiento		datetime  ,
    @EstadoCivil	        varchar(20),
    @Conyuge				varchar(100),	
    @Sexo	                varchar(20),	
    @Fuma	                bit,
    @Profesion				varchar(100),	
    @Puesto					varchar(100),
    @NumeroHijos	        int,
    @Religion				varchar(50),
    @Categoria				varchar(50),		     
    @Grupo					varchar(50),		     
    @Familia				varchar(50)
		  
	SELECT @Sucursal = p.Sucursal, @Usuario = p.Usuario, @EnviarA = p.EnviarA
      FROM POSL p
     WHERE p.ID = @ID
  
	SELECT @ListaPreciosSucursal = ListaPreciosEsp, @ZonaImpuestoSucursal = ZonaImpuesto
      FROM Sucursal
	 WHERE Sucursal = @Sucursal
  
	SELECT @ListaPreciosUsuario = DefListaPreciosEsp
      FROM Usuario
	 WHERE Usuario = @Usuario
   
	IF @EnviarA IS NOT NULL AND @Cliente IS NOT NULL
		SELECT @ZonaImpuestoEnviarA = ZonaImpuesto
		  FROM CteEnviarA 
		 WHERE Cliente = @Cliente AND ID = @EnviarA  
   
	IF @EnviarA IS NOT NULL AND @Cliente IS  NULL
		SELECT @ZonaImpuestoEnviarA = ZonaImpuesto
		  FROM CB c
		  JOIN CteEnviarA ct ON ct.Cliente = c.Cuenta
		 WHERE c.Codigo = @Codigo AND ct.ID = @EnviarA     

	IF @Cliente IS NOT NULL
		SELECT 
				@Proyecto = ct.Proyecto,
				@Agente = ct.Agente,
				@FormaEnvio = ct.FormaEnvio,
				@Condicion = ct.Condicion,
				@Descuento = ct.Descuento,
				@DescuentoGlobal = d.Porcentaje,
				@ListaPreciosEsp = ISNULL(ISNULL(ISNULL(NULLIF(ct.ListaPreciosEsp,''), NULLIF(@ListaPreciosUsuario,'')), NULLIF(@ListaPreciosSucursal,'')),'(Precio Lista)'),
				@ZonaImpuesto = ISNULL(NULLIF(@ZonaImpuestoEnviarA,''),ISNULL(ISNULL(NULLIF(ct.ZonaImpuesto,''),NULLIF(u.DefZonaImpuesto,'')),
					NULLIF(@ZonaImpuestoSucursal,''))),
				@Nombre	= ct.Nombre,
				@Direccion = ct.Direccion,
 				@DireccionNumero = ct.DireccionNumero,
 				@DireccionNumeroInt	= ct.DireccionNumeroInt,
				@EntreCalles = ct.EntreCalles,		
				@Delegacion = ct.Delegacion,	
				@Colonia = ct.Colonia,	
				@Poblacion = ct.Poblacion,
				@Estado = ct.Estado,		
				@Pais = ct.Pais,			
				@Zona = ct.Zona,			
				@CodigoPostal = ct.CodigoPostal,
				@RFC = ct.RFC,		
				@CURP = ct.CURP,
				@FechaNacimiento = ct.FechaNacimiento,
				@EstadoCivil = ct.EstadoCivil,	 
				@Conyuge = ct.Conyuge,
				@Sexo = ct.Sexo ,     
				@Fuma = ct.Fuma  ,   
				@Profesion = ct.Profesion,
				@Puesto	= ct.Puesto,
				@NumeroHijos = ct.NumeroHijos,
				@Religion = ct.Religion
		  FROM Cte ct 
		 LEFT OUTER JOIN Descuento d ON ct.Descuento = d.Descuento  
		 JOIN Usuario u ON 1=1   
		 WHERE ct.Cliente = @Cliente
		 AND u.Usuario = @Usuario
     
		IF @Cliente IS NULL
			SELECT 
				@Cliente = c.Cuenta,
				@Proyecto = ct.Proyecto,
				@Almacen = ct.AlmacenDef,
				@Agente = ct.Agente,
				@FormaEnvio = ct.FormaEnvio,
				@Condicion = ct.Condicion,
				@Descuento = ct.Descuento,
				@DescuentoGlobal = d.Porcentaje,
				@ListaPreciosEsp =  ISNULL(ISNULL(ISNULL(NULLIF(@ListaPreciosEsp,''), NULLIF(@ListaPreciosUsuario,'')), NULLIF(@ListaPreciosSucursal,'')),'(Precio Lista)'),
				@ZonaImpuesto = ISNULL(NULLIF(@ZonaImpuestoEnviarA,''),ISNULL(ISNULL(NULLIF(ct.ZonaImpuesto,''),NULLIF(u.DefZonaImpuesto,'')),
					NULLIF(@ZonaImpuestoSucursal,''))),
				@Nombre = ct.Nombre,
				@Direccion = ct.Direccion,
 				@DireccionNumero = ct.DireccionNumero,
 				@DireccionNumeroInt	= ct.DireccionNumeroInt,
				@EntreCalles = ct.EntreCalles,		
				@Delegacion = ct.Delegacion,	
				@Colonia = ct.Colonia,	
				@Poblacion = ct.Poblacion,
				@Estado = ct.Estado,		
				@Pais = ct.Pais,			
				@Zona = ct.Zona,			
				@CodigoPostal = ct.CodigoPostal,
				@RFC = ct.RFC,		
				@CURP = ct.CURP,
				@FechaNacimiento = ct.FechaNacimiento,
				@EstadoCivil = ct.EstadoCivil,	 
				@Conyuge = ct.Conyuge,
				@Sexo = ct.Sexo,     
				@Fuma = ct.Fuma,
				@Profesion = ct.Profesion,
				@Puesto = ct.Puesto,
				@NumeroHijos = ct.NumeroHijos,
				@Religion = ct.Religion	   
			FROM CB c
			INNER JOIN Cte ct ON ct.Cliente = c.Cuenta
			LEFT OUTER JOIN Descuento d ON ct.Descuento = d.Descuento  
			JOIN Usuario u ON 1=1   
			WHERE c.Codigo = @Codigo
			AND u.Usuario = @Usuario
   
		IF @Cliente IS NULL
			SELECT @Ok = 26060, @OkRef = @Codigo

		IF @Ok IS NULL
			EXEC xpPOSVentaInsertaClienteVerificar @Empresa, @ID, @Codigo, @Cliente, @CtaDinero, @Ok OUTPUT, @OkRef OUTPUT

		IF @Ok IS NULL
		BEGIN
			IF @EsFactura = 1
				UPDATE POSL SET Cliente = @Cliente, 
					--Proyecto = @Proyecto, 
					--Agente = ISNULL(NULLIF(@Agente,''),Agente),
					--FormaEnvio = @FormaEnvio, 
					--Condicion = ISNULL(NULLIF(@Condicion,''),Condicion), 
					--Descuento = ISNULL(NULLIF(@Descuento,''),Descuento), 
					--DescuentoGlobal = ISNULL(NULLIF(@DescuentoGlobal,''),DescuentoGlobal), 
					--ListaPreciosEsp = @ListaPreciosEsp, 
					--ZonaImpuesto = NULLIF(@ZonaImpuesto,''),
					Nombre = @Nombre,
					Direccion = @Direccion,
					DireccionNumero	= @DireccionNumero,
					DireccionNumeroInt = @DireccionNumeroInt,
					EntreCalles	= @EntreCalles,
					Delegacion = @Delegacion,	
					Colonia = @Colonia,
					Poblacion = @Poblacion,
					Estado = @Estado,
					Pais = @Pais,
					Zona = @Zona,
					CodigoPostal = @CodigoPostal,
					RFC = @RFC,
					CURP = @CURP,
					FechaNacimiento = @FechaNacimiento,
					EstadoCivil	= @EstadoCivil,	    
					Conyuge = @Conyuge,	    
					Sexo = @Sexo,   
					Fuma = @Fuma,    
					Profesion = @Profesion,	    
					Puesto = @Puesto,	    
					NumeroHijos	= @NumeroHijos,
					Religion = @Religion	        	       
				WHERE ID = @ID
			ELSE
				UPDATE POSL SET Cliente = @Cliente, 
					Proyecto = @Proyecto, 
					Agente = ISNULL(NULLIF(@Agente,''),Agente),
					FormaEnvio = @FormaEnvio, 
					Condicion = ISNULL(NULLIF(@Condicion,''),Condicion), 
					Descuento = ISNULL(NULLIF(@Descuento,''),Descuento), 
					DescuentoGlobal = ISNULL(NULLIF(@DescuentoGlobal,''),DescuentoGlobal), 
					ListaPreciosEsp = @ListaPreciosEsp, 
					ZonaImpuesto = NULLIF(@ZonaImpuesto,''),
					Nombre = @Nombre,
					Direccion = @Direccion,
					DireccionNumero	= @DireccionNumero,
					DireccionNumeroInt = @DireccionNumeroInt,
					EntreCalles	= @EntreCalles,
					Delegacion = @Delegacion,	
					Colonia = @Colonia,
					Poblacion = @Poblacion,
					Estado = @Estado,
					Pais = @Pais,
					Zona = @Zona,
					CodigoPostal = @CodigoPostal,
					RFC = @RFC,
					CURP = @CURP,
					FechaNacimiento = @FechaNacimiento,
					EstadoCivil	= @EstadoCivil,	    
					Conyuge = @Conyuge,	    
					Sexo = @Sexo,   
					Fuma = @Fuma,    
					Profesion = @Profesion,	    
					Puesto = @Puesto,	    
					NumeroHijos	= @NumeroHijos,
					Religion = @Religion	        	       
				WHERE ID = @ID



				SELECT @ImagenNombreAnexo = pc.ImagenNombreAnexo 
				FROM POSCfg pc
				WHERE pc.Empresa = @Empresa
       
				SELECT @Imagen = MAX(ac.Direccion)
				FROM AnexoCta ac
				WHERE ac.Nombre = @ImagenNombreAnexo
				AND Rama = 'CXC'
				AND ac.Cuenta = @Cliente
				AND ac.Tipo = 'Imagen'      
		END
   
		IF @Ok IS NULL AND @EsFactura = 0
			EXEC spPOSArtPrecioRecalcular @ID, @Estacion
END   
GO


/************************ spPOSCambiaCliente *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSCambiaCliente') AND type = 'P') DROP PROCEDURE dbo.spPOSCambiaCliente
GO
CREATE PROCEDURE spPOSCambiaCliente
	@Empresa		varchar(5),
	@ID				varchar(50),
	@Codigo			varchar(50),
	@CtaDinero		varchar(10),
	@Cliente		varchar(10),
	@Estacion		int	     
--//WITH ENCRYPTION	     	     
AS
BEGIN
	DECLARE 
	@Proyecto				varchar(50),
	@Almacen				varchar(10),
	@Agente					varchar(10),
	@Cajero					varchar(10),
	@FormaEnvio				varchar(50),
	@Condicion				varchar(50),
	@Vencimiento			varchar(50),
	@Descuento				varchar(50),
	@DescuentoGlobal		varchar(50),
	@ListaPreciosEsp		varchar(20),
	@ZonaImpuesto			varchar(50),
	@ZonaImpuestoSucursal	varchar(50),
	@ZonaImpuestoEnviarA	varchar(50),
	@ImagenNombreAnexo		varchar(255),
	@Usuario				varchar(10),
	@Sucursal				int,	  
	@Nombre					varchar(100),
	@Direccion				varchar(100),
	@DireccionNumero		varchar(20),
	@DireccionNumeroInt		varchar(20),
	@EntreCalles			varchar(100),
	@Delegacion				varchar(100),
	@Colonia				varchar(100),
	@Poblacion				varchar(100),
	@Estado					varchar(50),
	@Pais					varchar(50),
	@Zona					varchar(50),
	@CodigoPostal			varchar(15),
	@RFC					varchar(15),
	@CURP					varchar(50),	
	@ListaPreciosSucursal	varchar(20),		
	@ListaPreciosUsuario	varchar(20),
	@EnviarA				int,
    @FechaNacimiento		datetime,
    @EstadoCivil	        varchar(20),
    @Conyuge				varchar(100),	
    @Sexo	                varchar(20),	
    @Fuma	                bit,
    @Profesion				varchar(100),	
    @Puesto					varchar(100),
    @NumeroHijos	        int,
    @Religion				varchar(50),
    @Ok						int,
    @OkRef					varchar(255)

	SELECT @Sucursal = p.Sucursal, @Usuario = p.Usuario, @EnviarA = p.EnviarA
    FROM POSL p
    WHERE p.ID = @ID
  
	SELECT @ListaPreciosSucursal = ListaPreciosEsp, @ZonaImpuestoSucursal = ZonaImpuesto
    FROM Sucursal
	WHERE Sucursal = @Sucursal
  
	SELECT @ListaPreciosUsuario = DefListaPreciosEsp
    FROM Usuario
	WHERE Usuario = @Usuario
   
	IF @EnviarA IS NOT NULL AND @Cliente IS NOT NULL
		SELECT @ZonaImpuestoEnviarA = ZonaImpuesto
		FROM CteEnviarA 
		WHERE Cliente = @Cliente AND ID = @EnviarA  
   
	IF @EnviarA IS NOT NULL AND @Cliente IS  NULL
		SELECT @ZonaImpuestoEnviarA = ZonaImpuesto
		FROM CB c
		JOIN CteEnviarA ct ON ct.Cliente = c.Cuenta
		WHERE c.Codigo = @Codigo AND ct.ID = @EnviarA             

	IF @Cliente IS NOT NULL
		SELECT 
		@Proyecto = ct.Proyecto,
        @Agente = ct.Agente,
        @FormaEnvio = ct.FormaEnvio,
        @Condicion = ct.Condicion,
        @Descuento = ct.Descuento,
        @DescuentoGlobal = d.Porcentaje,
        @ListaPreciosEsp = ISNULL(ISNULL(ISNULL(NULLIF(ct.ListaPreciosEsp,''), NULLIF(@ListaPreciosUsuario,'')), NULLIF(@ListaPreciosSucursal,'')),'(Precio Lista)'),
        @ZonaImpuesto = ISNULL(NULLIF(@ZonaImpuestoEnviarA,''),ISNULL(ISNULL(NULLIF(ct.ZonaImpuesto,''),NULLIF(u.DefZonaImpuesto,'')),NULLIF(@ZonaImpuestoSucursal,''))),
		@Nombre	= ct.Nombre,
		@Direccion = ct.Direccion,
 		@DireccionNumero = ct.DireccionNumero,
 		@DireccionNumeroInt	= ct.DireccionNumeroInt,
		@EntreCalles = ct.EntreCalles,		
		@Delegacion = ct.Delegacion,	
		@Colonia = ct.Colonia,	
		@Poblacion = ct.Poblacion,
		@Estado = ct.Estado,		
		@Pais = ct.Pais,			
		@Zona = ct.Zona,			
		@CodigoPostal = ct.CodigoPostal,
		@RFC = ct.RFC,		
		@CURP = ct.CURP,
		@FechaNacimiento = ct.FechaNacimiento,
		@EstadoCivil = ct.EstadoCivil,	 
		@Conyuge = ct.Conyuge,
		@Sexo = ct.Sexo,     
		@Fuma = ct.Fuma,   
		@Profesion = ct.Profesion,
		@Puesto	= ct.Puesto,
        @NumeroHijos = ct.NumeroHijos,
        @Religion = ct.Religion
		FROM Cte ct 
		LEFT OUTER JOIN Descuento d ON ct.Descuento = d.Descuento  
		JOIN Usuario u ON 1=1   
		WHERE ct.Cliente = @Cliente
		AND u.Usuario = @Usuario
     
	IF @Cliente IS NULL
		SELECT 
		@Cliente = c.Cuenta,
        @Proyecto = ct.Proyecto,
        @Almacen = ct.AlmacenDef,
        @Agente = ct.Agente,
        @FormaEnvio = ct.FormaEnvio,
        @Condicion = ct.Condicion,
        @Descuento = ct.Descuento,
        @DescuentoGlobal = d.Porcentaje,
        @ListaPreciosEsp =  ISNULL(ISNULL(ISNULL(NULLIF(@ListaPreciosEsp,''), NULLIF(@ListaPreciosUsuario,'')), NULLIF(@ListaPreciosSucursal,'')),'(Precio Lista)'),
        @ZonaImpuesto = ISNULL(NULLIF(@ZonaImpuestoEnviarA,''),ISNULL(ISNULL(NULLIF(ct.ZonaImpuesto,''),NULLIF(u.DefZonaImpuesto,'')),NULLIF(@ZonaImpuestoSucursal,''))),
		@Nombre	= ct.Nombre,
		@Direccion = ct.Direccion,
 		@DireccionNumero = ct.DireccionNumero,
 		@DireccionNumeroInt	= ct.DireccionNumeroInt,
		@EntreCalles = ct.EntreCalles,		
		@Delegacion = ct.Delegacion,	
		@Colonia = ct.Colonia,	
		@Poblacion = ct.Poblacion,
		@Estado = ct.Estado,		
		@Pais = ct.Pais,			
		@Zona = ct.Zona,			
		@CodigoPostal = ct.CodigoPostal,
		@RFC = ct.RFC,		
		@CURP = ct.CURP,
		@FechaNacimiento = ct.FechaNacimiento,
		@EstadoCivil = ct.EstadoCivil,	 
		@Conyuge = ct.Conyuge,
		@Sexo = ct.Sexo,
		@Fuma = ct.Fuma,
		@Profesion = ct.Profesion,
		@Puesto = ct.Puesto,
        @NumeroHijos = ct.NumeroHijos,
        @Religion = ct.Religion
		FROM CB c
		INNER JOIN Cte ct ON ct.Cliente = c.Cuenta
		LEFT OUTER JOIN Descuento d ON ct.Descuento = d.Descuento  
		JOIN Usuario u ON 1=1   
		WHERE c.Codigo = @Codigo
		AND u.Usuario = @Usuario

	IF @Cliente IS NULL
		SELECT @Ok = 26060, @OkRef = @Codigo

	IF @Ok IS NULL
		EXEC xpPOSVentaInsertaClienteVerificar @Empresa, @ID, @Codigo, @Cliente, @CtaDinero, @Ok OUTPUT, @OkRef OUTPUT

	IF @Ok IS NULL
	   BEGIN
			UPDATE POSL SET Cliente = @Cliente, 
				Proyecto = @Proyecto, 
				Agente = ISNULL(NULLIF(@Agente,''),Agente),
				FormaEnvio = @FormaEnvio, 
				Condicion = ISNULL(NULLIF(@Condicion,''),Condicion), 
				Descuento = ISNULL(NULLIF(@Descuento,''),Descuento), 
				DescuentoGlobal = ISNULL(NULLIF(@DescuentoGlobal,''),DescuentoGlobal), 
				ListaPreciosEsp = @ListaPreciosEsp, 
				ZonaImpuesto = NULLIF(@ZonaImpuesto,''),
				Nombre = @Nombre,
				Direccion = @Direccion,
				DireccionNumero	= @DireccionNumero,
				DireccionNumeroInt = @DireccionNumeroInt,
				EntreCalles	= @EntreCalles,
				Delegacion = @Delegacion,	
				Colonia = @Colonia,
				Poblacion = @Poblacion,
				Estado = @Estado,
				Pais = @Pais,
				Zona = @Zona,
				CodigoPostal = @CodigoPostal,
				RFC = @RFC,
				CURP = @CURP,
				FechaNacimiento = @FechaNacimiento ,
				EstadoCivil	= @EstadoCivil,	    
				Conyuge = @Conyuge,	    
				Sexo = @Sexo,   
				Fuma = @Fuma,    
				Profesion = @Profesion,	    
				Puesto = @Puesto,	    
				NumeroHijos	= @NumeroHijos,
				Religion = @Religion
			WHERE ID = @ID

			SELECT @ImagenNombreAnexo = pc.ImagenNombreAnexo 
			FROM POSCfg pc
			WHERE pc.Empresa = @Empresa
	   END 
   
	IF @Ok IS NULL
	   EXEC spPOSArtPrecioRecalcular @ID, @Estacion
END   
GO
   

/************************ spPOSMovNuevo *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSMovNuevo') AND type = 'P') DROP PROCEDURE dbo.spPOSMovNuevo
GO             
CREATE PROCEDURE spPOSMovNuevo	     
	@Empresa		varchar(5),
    @Modulo			varchar(5),
    @Sucursal		int,
    @Usuario		varchar(10),
    @Estacion       int,
    @ID				varchar(50)  OUTPUT,
    @Imagen			varchar(255) OUTPUT,
    @IDAnterior		varchar(50) = NULL
--//WITH ENCRYPTION    	     
AS
BEGIN
	DECLARE 
	@Mov					varchar(20),
	@FechaEmision			datetime,
	@FechaRegistro			datetime, 
	@Concepto				varchar(50),
	@Proyecto				varchar(50),
	@UEN					int,
	@Moneda					varchar(10),
	@TipoCambio				float,
	@Cliente				varchar(10),
	@Almacen				varchar(10),
	@Agente					varchar(10),
	@Cajero					varchar(10),
	@FormaEnvio				varchar(50),
	@Condicion				varchar(50),
	@Vencimiento			varchar(50),
	@CtaDinero				varchar(10),
	@Descuento				varchar(50),
	@DescuentoGlobal		varchar(50),
	@ListaPreciosEsp		varchar(20),
	@ZonaImpuesto			varchar(50),	  
	@FormaPago				varchar(50),	  
	@ImagenNombreAnexo		varchar(255),	  
	@Host					varchar(20),
	@Cluster				varchar(20),	  
	@Ok						int,
	@OkRef					varchar(255),
	@RedondeoMonetarios		int,
	@MovClave				varchar(20),
	@MovSubClave			varchar(20),
	@MovAnterior   			varchar(20),
	@MovIDAnterior			varchar(20),
	@PedidoReferencia		varchar(50),
	@SugerirFechaCierre		bit,
	@FechaCierre			datetime,
	@Caja					varchar(10)	  	  
	  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)	  
	SELECT @Caja = DefCtaDinero 
	FROM Usuario 
	WHERE Usuario = @Usuario	 

	--Determina el Host y Cluster de la instancia
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
  
	IF @IDAnterior IS NOT NULL
		SELECT @MovClave = m.Clave, @MovSubClave = m.SubClave--, @Caja = p.Caja
		FROM MovTipo m JOIN POSL p ON m.Mov = p.Mov AND m.Modulo = 'POS'
		WHERE p.ID = @IDAnterior 
     
	SELECT @SugerirFechaCierre = SugerirFechaCierre   
	FROM POSCfg 
	WHERE Empresa = @Empresa
  
	SELECT @FechaCierre = Fecha 
	FROM POSFechaCierre 
	WHERE Sucursal = @Sucursal
  
	SELECT @FechaCierre = dbo.fnPOSFechaCierre(@Empresa,@Sucursal,@FechaCierre,@Caja)
   
	--Aqui refresca en el mov nuevo que tome la caja del usuario
	SELECT 
		@CtaDinero = DefCtaDinero,	
		@Cajero = DefCajero
    FROM Usuario
	WHERE Usuario = @Usuario
   
	SELECT 
		@FechaEmision = CASE WHEN @SugerirFechaCierre = 1 THEN @FechaCierre ELSE dbo.fnFechaSinHora(GETDATE())END,
		@FechaRegistro = GETDATE(),
		@Proyecto = u.DefProyecto,
		@UEN = u.UEN,
		@TipoCambio = ROUND(m.TipoCambio,@RedondeoMonetarios),
		@Cliente = u.DefCliente,
		@Almacen = ISNULL(u.DefAlmacen, c.AlmacenDef),
		@Agente = ISNULL(u.DefAgente, c.Agente),
		@Cajero = u.DefCajero,
		@FormaEnvio = c.FormaEnvio,
		@Condicion = c.Condicion,
		@CtaDinero = u.DefCtaDinero,	
		@Descuento = c.Descuento,
		@DescuentoGlobal = d.Porcentaje,
		@ListaPreciosEsp = ISNULL(ISNULL(ISNULL(NULLIF(u.DefListaPreciosEsp,''), NULLIF(c.ListaPreciosEsp,'')), NULLIF(s.ListaPreciosEsp,'')),'(Precio Lista)'),
		@ZonaImpuesto = ISNULL(ISNULL(NULLIF(u.DefZonaImpuesto,''),NULLIF(c.ZonaImpuesto,'')),NULLIF(s.ZonaImpuesto,'')),	 
		@FormaPago = u.DefFormaPago
    FROM Usuario u
    LEFT OUTER JOIN Mon m ON u.DefMoneda = m.Moneda
    LEFT OUTER JOIN Cte c ON u.DefCliente = c.Cliente
    LEFT OUTER JOIN Descuento d ON c.Descuento = d.Descuento     
    LEFT OUTER JOIN Sucursal s ON s.Sucursal = @Sucursal
	WHERE u.Usuario = @Usuario
   
	SELECT @Mov = MovOmision 
	FROM CtaDinero 
	WHERE  CtaDinero = @CtaDinero
  
	IF @Mov IS NULL
		SELECT TOP 1 @Mov = mt.Mov
		FROM MovTipo mt 
		WHERE mt.ConsecutivoModulo = 'VTAS'
		AND mt.Modulo = 'POS'
		ORDER BY mt.Orden   
      
	SELECT TOP 1 @Moneda = Moneda 
    FROM POSLTipoCambioRef 
	WHERE TipoCambio = 1 AND Sucursal = @Sucursal AND EsPrincipal = 1
   
	IF EXISTS(SELECT * FROM POSHost WHERE Host = @Host)      
      SELECT @ImagenNombreAnexo = pc.ImagenNombreAnexo 
      FROM POSCfg pc
      WHERE pc.Empresa = @Empresa
       
	SELECT @Imagen = MAX(ac.Direccion)
    FROM AnexoCta ac
    WHERE ac.Nombre = @ImagenNombreAnexo
    AND Rama = 'EMP'
    AND ac.Cuenta = @Empresa
    AND ac.Tipo = 'Imagen'
          
	IF @MovClave = 'POS.P' AND @MovSubClave = 'POS.PEDANT'
		BEGIN
			SELECT TOP 1 @Mov = Mov 
			FROM MovTipo 
			WHERE Clave = 'POS.FA' AND SubClave = 'POS.ANTREF'  AND Modulo = 'POS'
			
			SELECT @MovAnterior = p.Mov, @MovIDAnterior = p.MovID, @Cliente = p.Cliente, 
				@PedidoReferencia = p.Mov+' '+p.MovID, @Modulo = 'CXC'
			FROM POSL p 
			WHERE p.ID = @IDAnterior 
		END          
   
	SELECT @ID = NEWID()
   
	INSERT POSL (
		ID, Host, Empresa, Modulo, Sucursal, Usuario, Mov, FechaEmision, FechaRegistro, Proyecto, UEN, Moneda, TipoCambio, 
		Cliente, Almacen, Agente, Cajero, FormaEnvio, Condicion, CtaDinero, Descuento, DescuentoGlobal, ListaPreciosEsp, 
		ZonaImpuesto, Estatus, Cluster, Caja, PedidoReferencia)
        VALUES (
		@ID, @Host, @Empresa, @Modulo, @Sucursal, @Usuario, @Mov, @FechaEmision, @FechaRegistro, @Proyecto, @UEN, @Moneda, 1.0, 
		@Cliente, @Almacen, @Agente, @Cajero, @FormaEnvio, @Condicion, @CtaDinero, @Descuento, @DescuentoGlobal, @ListaPreciosEsp, 
		@ZonaImpuesto, 'SINAFECTAR', @Cluster, @CtaDinero, @PedidoReferencia)
   
		--Aqui llena al cliente con todos sus datos.
		EXEC spPOSInsertaCliente @Empresa, @ID, NULL, @CtaDinero, @Cliente, @Estacion, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
END
GO


/************************ spPOSCerrarPOS *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSCerrarPOS') AND type = 'P') DROP PROCEDURE dbo.spPOSCerrarPOS
GO             
CREATE PROCEDURE spPOSCerrarPOS
	@ID		varchar(36)
--//WITH ENCRYPTION	      
AS 
BEGIN
	EXEC spPOSMovEliminar NULL, NULL, NULL, NULL, @ID, NULL, NULL, NULL, NULL, NULL, 0
END
GO	


/************************ spPOSMovEliminar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSMovEliminar') AND type = 'P') DROP PROCEDURE dbo.spPOSMovEliminar
GO
CREATE PROCEDURE spPOSMovEliminar
	@Empresa			varchar(5),
	@Modulo				varchar(5),
	@Sucursal			int,
	@Usuario			varchar(10),
	@Estacion			int,
	@ID					varchar(36)		OUTPUT,
	@Mensaje			varchar(255)	OUTPUT,
	@Imagen				varchar(255)	OUTPUT,	
	@Ok					int				OUTPUT,
	@OkRef				varchar(255)	OUTPUT,
	@GenerarNuevo		bit = 1	     
--//WITH ENCRYPTION	     
AS 
BEGIN	     
	DECLARE @MovID	varchar(20)
  
	SELECT @GenerarNuevo = 1
  
	--Valida que no tenga cobros el movimiento.
	IF ISNULL((SELECT SUM(ISNULL(Importe,0)) FROM POSLCObro pc WHERE pc.ID = @ID),0) <> 0
		SELECT @Ok = 60060
  
	SELECT @MovID = MovID
    FROM POSL pl
	WHERE pl.ID = @ID

	IF @OK IS NULL
		DELETE FROM POSLArtSeleccionado WHERE ID = @ID

	--Cuando tiene MovID se Cancela, no se puede eliminar
	IF @MovID IS NOT NULL AND @OK IS NULL
	  BEGIN
			UPDATE POSL SET Estatus = 'CANCELADO', FechaCancelacion = GETDATE() WHERE ID = @ID
    
			SELECT @Mensaje = 'MOVIMIENTO CANCELADO'
			SELECT @ID = NULL
    
			IF @ID IS NULL AND @GenerarNuevo = 1
				EXEC spPOSMovNuevo @Empresa, @Modulo, @Sucursal, @Usuario,@Estacion, @ID OUTPUT, @Imagen OUTPUT
	  END
  
	--Si no tiene MovID se elimina  
	IF @MovID IS NULL AND @Ok IS NULL 
		BEGIN    
			IF (SELECT Sum(Cantidad) FROM POSLVenta WHERE ID = @ID )> 0
				BEGIN
					IF EXISTS(SELECT * FROM POSCancelacionArticulos WHERE ID = @ID) 
						DELETE FROM POSCancelacionArticulos WHERE ID = @ID    
    
					INSERT POSCancelacionArticulos(ID, Empresa, Sucursal, Cajero, Caja, Articulo, Precio, Fecha, Cantidad)
					SELECT @ID, @Empresa, @Sucursal, p.UsuarioAutoriza, p.Caja, pd.Articulo, pd.PrecioImpuestoInc, 
							getdate()-1, pd.Cantidad
					FROM POSL p JOIN POSLVenta pd ON p.id = pd.id
					WHERE p.ID = @ID
				END
			ELSE
				DELETE FROM POSCancelacionArticulos WHERE ID = @ID 
          
			DELETE FROM POSL WHERE ID = @ID
			DELETE FROM POSLVenta WHERE ID = @ID
			DELETE FROM POSLCobro WHERE ID = @ID
			DELETE FROM POSLSerieLote WHERE ID = @ID
			DELETE FROM POSLArtSeleccionado WHERE ID = @ID
   
			SELECT @Mensaje = 'MOVIMIENTO ELIMINADO'
    
			IF @ID IS NULL AND @GenerarNuevo = 1
				EXEC spPOSMovNuevo @Empresa, @Modulo, @Sucursal, @Usuario, @Estacion, @ID OUTPUT, @Imagen OUTPUT
		END
END  
GO


/************************ spPOSAccionDisparar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAccionDisparar') AND type = 'P') DROP PROCEDURE dbo.spPOSAccionDisparar
GO             
CREATE PROCEDURE spPOSAccionDisparar
	@Empresa					varchar(5),
    @Sucursal					int,
    @Modulo						varchar(5),
    @Usuario					varchar(10),
    @Caja						varchar(10),
    @Estacion					int,
    @ID							varchar(50)		OUTPUT,
    @Codigo						varchar(50)		OUTPUT,
    @CodigoAccion				varchar(50)		OUTPUT,
    @Accion						varchar(50)		OUTPUT,
    @FormaPago					varchar(50)		OUTPUT,
    @Importe					float			OUTPUT,
    @CantidadNotasEnProceso		int,
    @Imagen						varchar(255)	OUTPUT,
    @Mensaje					varchar(255)	OUTPUT,    
    @Ok							int				OUTPUT,
    @OkRef						varchar(255)	OUTPUT,
    @Expresion					varchar(255)    OUTPUT
--//WITH ENCRYPTION    	         	     
AS 
BEGIN
	DECLARE 
	@MovimientosTraspasados		int,
	@Host						varchar(20),
	@Cluster					varchar(20),
	@MovID						varchar(20),
	@Estatus					varchar(20),
	@RedondeoMonetarios			int,
	@UsuarioPerfil				varchar(10),
	@Cajero						varchar(10),
	@MovVenta					varchar(20), 
	@IDVenta					int,
	@MovClave					varchar(20),
	@MovSubClave				varchar(20),
	@WebService					bit,
	@Cliente					varchar(10),
	@CxcLocal					bit,
	@PedidoReferencia			varchar(50),
	@PedidoReferenciaID			int,
	@RefPedidoSinWS				bit,
	@UsuarioAutoriza			varchar(10),
	@UsuarioAutorizaPerfil		varchar(10)
	  
	SELECT @UsuarioPerfil = POSPerfil 
	FROM Usuario 
	WHERE Usuario = @Usuario  
	
	SELECT @UsuarioPerfil = ISNULL(NULLIF(@UsuarioPerfil,''),@Usuario) 
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)

	SELECT @WebService = ISNULL(WebService,0), @CxcLocal = ISNULL(CxcLocal,0), @RefPedidoSinWS = ISNULL(RefPedidoSinWS,0) 
	FROM POSCfg 
	WHERE Empresa = @Empresa
	
	EXEC spPOSHost @Host	OUTPUT, @Cluster OUTPUT	  
  
	--Verifica que el usuario tenga privilegios
	EXEC spPOSUsuarioAccion @Usuario,@UsuarioPerfil, @Sucursal, @CodigoAccion, @ID, @Ok OUTPUT, @OkRef OUTPUT
  
	-- Extrae Campos de la tabla para validacion posterior
	SELECT 
		@MovID = p.MovID,
		@Estatus = p.Estatus,
		@Cliente = p.Cliente,
		@MovClave = mt.Clave,
		@MovSubClave = mt.SubClave,
		@PedidoReferencia = p.PedidoReferencia,
		@PedidoReferenciaID = p.PedidoReferenciaID,
		@UsuarioAutoriza = p.UsuarioAutoriza
    FROM POSL p JOIN MovTipo mt ON p.Mov = mt.Mov AND mt.Modulo = 'POS'
	WHERE p.ID = @ID
   
	SELECT @UsuarioAutorizaPerfil = POSPerfil 
	FROM Usuario 
	WHERE Usuario = @UsuarioAutoriza   

	--Asignar Caja
	IF @CodigoAccion = 'ASIGNAR CAJA'
		BEGIN
			IF EXISTS(SELECT * FROM POSLAccion WHERE Host = @Host AND Caja = @Caja AND Accion = @CodigoAccion)
				DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
			
			SELECT @Codigo = NULL,@Accion = NULL
			SELECT @Mensaje = 'POR FAVOR INTRODUZCA LA CAJA'        
			
			INSERT POSLAccion (
				Host,  Caja, Accion)
			VALUES (
				@Host, @Caja,@CodigoAccion )                
		END               
     
	--BENEFICIARIO
	IF @CodigoAccion = 'BENEFICIARIO'
		BEGIN
			IF EXISTS(SELECT * FROM POSLAccion WHERE Host = @Host AND Caja = @Caja AND Accion = @CodigoAccion)
				DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
		
			SELECT @Codigo = NULL,@Accion = NULL
			SELECT @Mensaje = 'POR FAVOR INTRODUZCA EL BENEFICIARIO'        
		
			INSERT POSLAccion (
				Host,  Caja, Accion)
			VALUES (
				@Host, @Caja,@CodigoAccion )                
		END    
    
	IF @CodigoAccion = 'INTRODUCIR CONCEPTOCXC'
		BEGIN
			IF EXISTS(SELECT * FROM POSLAccion WHERE Host = @Host AND Caja = @Caja AND Accion = @CodigoAccion)
				DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
    
			SELECT @Codigo = NULL,@Accion = NULL
			SELECT @Mensaje = 'POR FAVOR INTRODUZCA EL NUMERO DEL CONCEPTO'        
    
			INSERT POSLAccion (
				Host,  Caja, Accion)
            VALUES (
				@Host, @Caja,@CodigoAccion ) 
		END

	IF @CodigoAccion = 'ALMACEN DESTINO'
		BEGIN
			IF EXISTS(SELECT * FROM POSLAccion WHERE Host = @Host AND Caja = @Caja AND Accion = @CodigoAccion)
				DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja

			SELECT @Codigo = NULL,@Accion = NULL
			SELECT @Mensaje = CASE WHEN @MovClave = 'POS.INVD' 
										THEN ' POR FAVOR INTRODUZCA EL NUMERO ALMACEN DESTINO'  
								   ELSE ' POR FAVOR INTRODUZCA EL NUMERO ALMACEN ORIGEN'		
								   END     
								        
			INSERT POSLAccion (
				Host,  Caja, Accion)
            VALUES (
				@Host, @Caja,@CodigoAccion ) 
		END   

	IF @CodigoAccion = 'SUSTITUTOS ACCESORIOS'
		BEGIN
			SELECT @MovVenta = MovSustitutos 
			FROM POSCfg 
			WHERE Empresa = @Empresa
			
			INSERT Venta (
				Empresa, Mov, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, Estatus, 
				Observaciones, Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Causa, Atencion, 
				AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, Origen, OrigenID, GenerarDinero, SucursalOrigen, ServicioAseguradora)
			SELECT @Empresa, @MovVenta, p.FechaEmision,  p.FechaRegistro, p.Concepto, p.Proyecto, p.UEN, p.Moneda, p.TipoCambio, p.Usuario, p.Referencia, 'SINAFECTAR',
				p.Observaciones, p.Cliente, p.EnviarA, p.Almacen, p.Agente, p.FormaEnvio, p.Condicion, p.Vencimiento, p.CtaDinero, 0.0, 0.0, p.Causa, p.Atencion, 
				p.AtencionTelefono, p.ListaPreciosEsp, p.ZonaImpuesto, p.Sucursal, 'POS', p.Mov, p.OrigenID, 0, p.Sucursal, p.Cajero
			FROM POSL p
			WHERE p.ID = @ID  

			SELECT @IDVenta = SCOPE_IDENTITY()  
   
			IF @Ok IS NULL
				SELECT @Expresion = 'Asigna(Info.ID,'+CONVERT(varchar,@IDVenta)+')  FormaModal('+CHAR(39)+'VentaPOS'+CHAR(39)+')'    
      
			DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja
		END    

	  IF @CodigoAccion = 'FORMA ENVIO' AND @Ok IS NULL
	  BEGIN
		SELECT @Codigo = NULL
    
		SELECT @Mensaje = 'POR FAVOR INTRODUZCA LA FORMA DE ENVIO'
	  END
  
	-- SOLICITAR PESO
	IF @CodigoAccion = 'PESAR'
		BEGIN
			DELETE POSLAccion 
			WHERE Host = @Host 
			AND Caja = @Caja
			AND Accion = @CodigoAccion
       
			INSERT POSLAccion (
				Host, Caja, Accion)
			VALUES (
				@Host, @Caja, @CodigoAccion)
  
			SELECT @Codigo = NULL    
			SELECT @Mensaje = 'FAVOR DE INTRODUCIR EL PESO'
		END

	-- MODIFICAR AGENTE
	IF @CodigoAccion = 'MODIFICAR AGENTE'
		BEGIN
			DELETE POSLAccion 
			WHERE Host = @Host 
			AND Caja = @Caja
			AND Accion = @CodigoAccion
       
			INSERT POSLAccion (
				Host, Caja, Accion)
			VALUES (
				@Host, @Caja, @CodigoAccion)
  
			SELECT @Codigo = NULL    
			SELECT @Mensaje = 'FAVOR DE INTRODUCIR EL AGENTE'
		END
    
	--REGRESAR
	IF @CodigoAccion = 'REGRESAR' AND @Ok IS NULL
		BEGIN
			SELECT @Codigo = NULL
		END

	--MODIFICAR CONDICION
	IF @CodigoAccion = 'MODIFICAR CONDICION' AND @Ok IS NULL
		BEGIN
			SELECT @Codigo = NULL    
			SELECT @Mensaje = 'POR FAVOR INTRODUZCA LA CONDICION'
		END
  
	--INTRODUCIR CONCEPTODIN
	IF @CodigoAccion = 'INTRODUCIR CONCEPTODIN' AND @Ok IS NULL
		BEGIN
			SELECT @Codigo = NULL    
			SELECT @Mensaje = 'POR FAVOR INTRODUZCA EL CONCEPTO DE DINERO'
		END
  
	--MODIFICAR CAJA     
	IF @CodigoAccion = 'MODIFICAR CAJA' AND @Ok IS NULL
		BEGIN
			SELECT @Codigo = NULL    
			SELECT @Mensaje = 'POR FAVOR INTRODUZCA LA CAJA'
		END

	--MODIFICAR REFERENCIA
	IF @CodigoAccion = 'MODIFICAR REFERENCIA'
		BEGIN
			SELECT @Codigo = NULL    
			SELECT @Mensaje = 'POR FAVOR INTRODUZCA LA REFERENCIA'
		END

	--MODIFICAR CAJERO      
	IF @CodigoAccion = 'MODIFICAR CAJERO' AND @Ok IS NULL
		BEGIN
			SELECT @Codigo = NULL     
			SELECT @Mensaje = 'POR FAVOR INTRODUZCA LA CLAVE DEL CAJERO'
		END      

	-- REVERSAR COBRO
	IF @CodigoAccion = 'REVERSAR COBRO' AND @Ok IS NULL
		BEGIN
			SELECT @Codigo = NULL     
			SELECT @Mensaje = 'POR FAVOR INTRODUZCA LA FORMA DE PAGO'
		END      
      
	IF @CodigoAccion = 'MATRIZ OPCIONES'
		BEGIN
			SELECT @Codigo = NULL
			SELECT @Mensaje = 'POR FAVOR INTRODUZCA LA CLAVE DEL ARTICULO'
		END  

	--INTRODUCIR CUENTA DINERO      
	IF @CodigoAccion = 'INTRODUCIR CUENTA DINERO' AND @Ok IS NULL
		BEGIN
			SELECT @Codigo = NULL      
			SELECT @Mensaje = 'POR FAVOR INTRODUZCA LA CUENTA DE DINERO'
    
			IF EXISTS(SELECT 1 FROM POSLAccion WHERE Host = @Host AND Caja = @Caja AND Accion = @CodigoAccion)
				DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
      
			INSERT POSLAccion (
				Host,  Caja, Accion)
            VALUES (
				@Host, @Caja, @CodigoAccion)
		END
  
	--MODIFICAR COMPONENTE     
	IF @CodigoAccion = 'MODIFICAR COMPONENTE' AND @Ok IS NULL
		BEGIN
			SELECT @Codigo = NULL,@Accion = NULL      
			SELECT @Mensaje = 'POR FAVOR INTRODUZCA NUMERO DEL JUEGO A MODIFICAR'        
    
			IF EXISTS(SELECT 1 FROM POSLAccion WHERE Host = @Host AND Caja = @Caja AND Accion = @CodigoAccion)
				DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
      
			INSERT POSLAccion (
				Host,  Caja, Accion)
            VALUES (
				@Host, @Caja, @CodigoAccion)
		END
  
	--VER CORTE CAJA    
	IF @CodigoAccion = 'VER CORTE CAJA' AND @Ok IS NULL
		BEGIN 
			SELECT @Codigo = NULL
			SELECT @Accion = 'VER CORTE CAJA'
		END
  
	--VERIFICIAR SALDO      
	IF @CodigoAccion = 'VERIFICAR SALDO' AND @Ok IS NULL
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE EL FOLIO DEL SALDO O MONEDERO'
		END
    
	--CONSULTAR INV      
	IF @CodigoAccion = 'CONSULTAR INV' AND @Ok IS NULL
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE EL CODIGO DEL ARTICULO'
		END

	--VERIFICAR PRECIOS
	IF @CodigoAccion = 'VERIFICAR PRECIOS' AND @Ok IS NULL
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE EL CODIGO DEL ARTICULO BUSCAR'
		END
  
	--BUSCAR MOVIMIENTO      
	IF @CodigoAccion = 'BUSCAR MOVIMIENTO' AND @Ok IS NULL
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE EL ID DEL MOVIMIENTO'
		END
  
	--MODIFICAR CANTIDAD      
	IF @CodigoAccion = 'MODIFICAR CANTIDAD' AND @Ok IS NULL
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE LA CANTIDAD'
		END

	--MULTIPLICAR CANTIDAD      
	IF @CodigoAccion = 'MULTIPLICAR CANTIDAD' AND @Ok IS NULL
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE LA CANTIDAD'
		END

	--CANCELACION     
	IF @CodigoAccion = 'CANCELACION DINERO' AND @Ok IS NULL
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE EL ID DEL MOVIMIENTO ORIGINAL'

			INSERT POSLAccion (
				Host, Caja, Accion)
			VALUES (
				@Host, @Caja, 'REVERSAR MOV')
		END
  
	--DEVOLUCION TOTAL
	IF @CodigoAccion = 'DEVOLUCION TOTAL' AND @Ok IS NULL
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE EL ID DE LA VENTA ORIGINAL'
		END

	IF @CodigoAccion = 'DEVOLUCION TOTAL' AND @MovClave NOT IN('POS.F','POS.N','POS.NPC','POS.P')
		SELECT @Ok = 35005
    
	IF @CodigoAccion = 'DEVOLUCION PARCIAL' AND @Ok IS NULL
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE EL ID DE LA VENTA ORIGINAL'
		END

	IF @CodigoAccion = 'DEVOLUCION PARCIAL' AND @MovClave NOT IN('POS.F','POS.N','POS.NPC','POS.P')
		SELECT @Ok = 35005
    
	--DEVOLUCION REFERENCIADA
	IF @CodigoAccion = 'REFERENCIAR VENTA' AND @Ok IS NULL
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE EL ID DE LA VENTA ORIGINAL'
			
			INSERT POSLAccion (
				Host, Caja, Accion)
			VALUES (
				@Host, @Caja, 'REFERENCIAR VENTA')    
		END  

	IF  @CodigoAccion = 'REFERENCIAR VENTA' AND @MovClave NOT IN('POS.N')AND @MovSubClave <> 'POS.DREF'
		SELECT @Ok = 35005    

	--FACTURAR PEDIDOS
	IF @CodigoAccion = 'FACTURAR PEDIDO' AND @Ok IS NULL
		BEGIN

			IF @MovClave NOT IN ('POS.F','POS.N','POS.NPC') 
				SELECT @Ok = 35005
			
    
			IF @CxcLocal = 1
				BEGIN
					IF @Ok IS NULL
						EXEC spPOSSolicitudPedidoLocal  @ID, @Empresa, @Estacion, @Sucursal, @Usuario, @Ok OUTPUT, @OkRef OUTPUT    
				END
			ELSE
				BEGIN  
					IF @WebService = 0
						SELECT @Ok = 30445  
      
					IF @Ok IS NULL
						EXEC spPOSWSSolicitudPedido  @ID, @Empresa, @Estacion, @Sucursal, @Usuario, @Ok OUTPUT, @OkRef OUTPUT
				END  

			IF @Ok IS NULL     
					SELECT @Expresion = 'Asigna(Info.Cliente,'+CHAR(39)+@Cliente+CHAR(39)+')  FormaModal('+CHAR(39)+'POSVentaPedidoTemp'+CHAR(39)+')' 
		END

	IF @CodigoAccion = 'SELECCIONARCTE' AND @MovClave IN('POS.FA') AND @MovSubClave = 'POS.ANTREF'
		BEGIN   
			SELECT @Expresion = 'FormaModal('+CHAR(39)+'POSCteLista'+CHAR(39)+')'   
			SELECT @Mensaje = 'SELECCIONE EL CLIENTE'    
		END     
  
	IF @CodigoAccion = 'REFERENCIAR PEDIDO' AND @MovClave IN('POS.FA') AND @MovSubClave = 'POS.ANTREF'
		BEGIN
			IF @WebService = 0
				SELECT @Ok = 30445  
      
			IF @Ok IS NULL
				EXEC spPOSWSSolicitudPedido  @ID, @Empresa, @Estacion, @Sucursal, @Usuario, @Ok OUTPUT, @OkRef OUTPUT

			IF @Ok IS NULL     
				SELECT @Expresion = 'Asigna(Info.Cliente,'+CHAR(39)+@Cliente+CHAR(39)+')  FormaModal('+CHAR(39)+'POSVentaPedidoTemp2'+CHAR(39)+')'   
      
			IF @Ok IS  NOT NULL  AND @RefPedidoSinWS = 1
				BEGIN
					SELECT  @Ok = NULL, @OkRef = NULL
					SELECT @Mensaje = 'ERROR DE CONEXIÓN DEL WEB SERVICE POR FAVOR INGRESE EL ID DEL PEDIDO A REFERENCIAR'
      
					INSERT POSLAccion (
						Host, Caja, Accion)
					VALUES (
						@Host, @Caja, 'REFERENCIAR PEDIDOMANUAL')
				END    
		END   
 
	IF @MovClave IN('POS.CXCD', 'POS.CXCC') 
		BEGIN
			IF @WebService = 0
				SELECT @Ok = 30445  
      
			IF @Ok IS NULL AND @MovClave IN('POS.CXCD')
				EXEC spPOSWSSolicitudCxcPendiente  @ID, @Empresa, @Estacion, @Sucursal, @Usuario, @Ok OUTPUT, @OkRef OUTPUT

			IF @Ok IS NULL  AND @MovClave = 'POS.CXCC' 
				BEGIN  
					SELECT @Expresion = 'Asigna(Info.Cliente,'+CHAR(39)+@Cliente+CHAR(39)+')  FormaModal('+CHAR(39)+'POSSugerirCobro'+CHAR(39)+')'
					SELECT @Mensaje = ' SELECCIONE EL DOCUMENTO A COBRAR ' 
				END    
    
			IF @Ok IS NULL  AND @MovClave = 'POS.CXCD' 
				BEGIN  
					SELECT @Expresion = 'Asigna(Info.Cliente,'+CHAR(39)+@Cliente+CHAR(39)+')  FormaModal('+CHAR(39)+'POSCxcPendiente2'+CHAR(39)+')'
					SELECT @Mensaje = ' SELECCIONE EL MOVIMIENTO A DEVOLVER ' 
				END     
		END     

	--ANTICIPOS FACTURADOS
	IF @CodigoAccion = 'ANTICIPOS FACTURADOS' AND @Ok IS NULL
		BEGIN
			
			IF @MovClave NOT IN('POS.F','POS.N')
				IF @MovSubClave <> 'POS.FACCRED'
					SELECT @Ok = 35005

			IF @CxcLocal = 1
				BEGIN
					IF @Ok IS NULL
						EXEC spPOSSolicitudAnticiposCxcLocal  @ID, @Empresa, @Estacion, @Sucursal, @Usuario, @Ok OUTPUT, @OkRef OUTPUT    
				END
			ELSE
				BEGIN  
					IF @WebService = 0
						SELECT @Ok = 30445  
      
					IF @Ok IS NULL
						EXEC spPOSWSSolicitudAnticiposCxc  @ID, @Empresa, @Estacion, @Sucursal, @Usuario, @Ok OUTPUT, @OkRef OUTPUT
				END 
    
			IF @Ok IS NULL 
				BEGIN
					IF NULLIF(@PedidoReferencia,'') IS NOT NULL AND NULLIF(@PedidoReferenciaID,0) IS NOT NULL
						SELECT @Expresion = 'Asigna(Info.Cliente,'+CHAR(39)+@Cliente+CHAR(39)+')  FormaModal('+CHAR(39)+'POSCxcAnticipoTemp2'+CHAR(39)+')' 
					ELSE     
						SELECT @Expresion = 'Asigna(Info.Cliente,'+CHAR(39)+@Cliente+CHAR(39)+')  FormaModal('+CHAR(39)+'POSCxcAnticipoTemp'+CHAR(39)+')'  
				END
		END  

	--BUSCAR ARTICULOS      
	IF @CodigoAccion = 'BUSCAR ARTICULOS' AND @Ok IS NULL
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE PARTE DE LA DESCRIPCION DEL PRODUCTO'
		END
  
	--CANCELAR PARTIDA        
	IF @CodigoAccion = 'CANCELAR PARTIDA' AND @Ok IS NULL
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE EL ARTICULO A CANCELAR'
		END

	--ELIMINAR MOVMIENTO                
	IF @CodigoAccion = 'ELIMINAR MOVIMIENTO' AND @Ok IS NULL
		BEGIN
			EXEC spPOSMovEliminar @Empresa, @Modulo, @Sucursal, @Usuario, @Estacion, @ID OUTPUT, @Mensaje OUTPUT, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
			
			DELETE FROM POSLAccion WHERE Host = @Host AND Accion = @CodigoAccion AND Caja = @Caja
			DELETE FROM POSCxcAnticipoTemp WHERE Empresa = @Empresa AND Estacion = @Estacion
			DELETE FROM POSCxcAnticipoTempD WHERE  Sucursal = @Sucursal AND Estacion = @Estacion
		END        

	IF @CodigoAccion =   'BLOQUEAR CAJA' AND @Ok IS NULL
		BEGIN
			SELECT TOP 1 @Cajero = pec.Cajero
			FROM POSEstatusCaja  pec
			WHERE Caja = @Caja
			AND Abierto = 1

			EXEC spPOSEstatusCaja @Caja, @Host, @Cajero, @Usuario,  NULL, 1, @ok OUTPUT, @OkRef OUTPUT
    
			DELETE FROM POSLAccion WHERE Host = @Host AND Accion = @CodigoAccion AND Caja = @Caja 
    
			IF @Ok IS NULL
				SELECT @Mensaje = 'CAJA BLOQUEADA'
		END

	IF @CodigoAccion =   'DESBLOQUEAR CAJA' AND @Ok IS NULL
		BEGIN
			SELECT TOP 1 @Cajero = pec.Cajero
			FROM POSEstatusCaja  pec
			WHERE Caja = @Caja
			AND Abierto = 1

			IF NOT EXISTS(SELECT * FROM POSUsuarioAccion  WHERE Accion = 'DESBLOQUEAR CAJA' AND Usuario = ISNULL(NULLIF(@UsuarioAutorizaPerfil,''),@UsuarioAutoriza)) 
				SELECT @OK = 46130
      
			IF NOT EXISTS(SELECT * FROM Usuario WHERE Usuario = @UsuarioAutoriza AND ISNULL(POSEsSupervisor,0) = 1)
				BEGIN
					IF @UsuarioAutoriza <> @Usuario
						SELECT @OK = 46130
				END  
      
			IF @Ok IS NULL  
				EXEC spPOSEstatusCaja @Caja, @Host, @Cajero, @Usuario,  NULL, 0, @ok OUTPUT, @OkRef OUTPUT
    
			DELETE FROM POSLAccion WHERE Host = @Host AND Accion = @CodigoAccion AND Caja = @Caja 
    
			IF @Ok IS NULL
				SELECT @Mensaje = 'CAJA DESBLOQUEADA'
      
			UPDATE POSL SET UsuarioAutoriza = NULL WHERE ID = @ID
		END

	--CAMBIAR MOVIMIENTO      
	IF @CodigoAccion = 'CAMBIAR MOVIMIENTO' AND @Ok IS NULL
		BEGIN
			IF @MovID IS NOT NULL OR @Estatus <> 'SINAFECTAR'
				SELECT @Ok = 10015, @OkRef = 'Solo se pueden cambiar Movimientos Sin Afectar y/o sin aplicaciones'
    
			IF @Ok IS NULL
				SELECT @Mensaje = 'POR FAVOR INGRESE EL NOMBRE DEL MOVIMIENTO'
    
			IF @Ok IS NOT NULL
				BEGIN
					DELETE FROM POSLAccion WHERE Host = @Host AND Accion = @CodigoAccion AND Caja = @Caja
					SELECT @CodigoAccion = NULL
				END
		END

	--MOVIMIENTO NUEVO           
	IF @CodigoAccion = 'MOVIMIENTO NUEVO' AND @Ok IS NULL
		BEGIN
			IF (SELECT COUNT(ID) FROM POSL WHERE Host = @Host AND CtaDinero = @Caja AND Estatus = 'SINAFECTAR') >= ISNULL(@CantidadNotasEnProceso,1)
				SELECT @Ok = 61010, @OkRef = 'No puede tener mas de ' + CONVERT(varchar, ISNULL(@CantidadNotasEnProceso,1)) + ' movimiento(s) en proceso'
			ELSE
				BEGIN
					IF EXISTS(SELECT 1 FROM POSL p INNER JOIN MovTipo mt ON p.Mov = mt.Mov AND mt.Modulo = 'POS' 
						AND mt.Clave IN ('POS.CC', 'POS.CPC', 'POS.AC','POS.ACM','POS.CCM','POS.CPCM','POS.IC','POS.EC','POS.AP') 
						WHERE p.Host = @Host AND (CtaDinero = @Caja OR CtaDineroDestino = @Caja) AND p.Estatus = 'SINAFECTAR' ) AND @Ok IS NULL
						BEGIN
							SELECT TOP 1 @ID = p.ID FROM POSL p INNER JOIN MovTipo mt ON p.Mov = mt.Mov AND mt.Modulo = 'POS' 
							AND mt.Clave IN ('POS.CC', 'POS.CPC', 'POS.AC','POS.ACM','POS.CCM','POS.CPCM','POS.AP') 
							WHERE p.Host = @Host AND (CtaDinero = @Caja OR CtaDineroDestino = @Caja) AND p.Estatus = 'SINAFECTAR' 
          
							SELECT @Ok = 61010, @OkRef = 'No puede insertar movimientos nuevos mientras tenga Aperturas o Cortes sin afectar'          
						END
					ELSE
						BEGIN
							SELECT @ID = NULL
							EXEC spPOSMovNuevo @Empresa, @Modulo, @Sucursal, @Usuario, @Estacion, @ID OUTPUT, @Imagen OUTPUT          
						END
				END
    
			DELETE FROM POSLAccion WHERE Host = @Host AND Accion = @CodigoAccion AND Caja = @Caja
		END         
         
	--COPÍAR DE UN MOVIMIENTO DEL MODULO DE VENTAS
	IF @CodigoAccion = 'COPIAR OTRO MOV VENTAS' AND @Ok IS NULL
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE EL CODIGO DEL MOVIMIENTO'
		END
END
GO


/********************************** spPOSPoliticaPreciosCalc ************************************/
IF EXISTS (SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSPoliticaPreciosCalc') AND type = 'P') DROP PROCEDURE dbo.spPOSPoliticaPreciosCalc
GO             
CREATE PROCEDURE spPOSPoliticaPreciosCalc
	@FechaEmision		dateTime,
	@Agente				varchar(10),
	@Moneda				varchar(10), 
	@TipoCambio			float,
	@Condicion			varchar(50),
	@Almacen			varchar(10),
	@Proyecto			varchar(50),
	@FormaEnvio			varchar(50),
	@Mov				varchar(20),
	@ServicioTipo		varchar(50),
	@ContratoTipo		varchar(50),
	@Empresa			varchar(50),
	@Region				varchar(50),
	@Sucursal			int,
	@ListaPreciosEsp	varchar(20),
	@Cliente			varchar(10),	
	@Articulo			varchar(20),
	@Subcuenta			varchar(50),
	@Cantidad			float,
	@UnidadVenta		varchar(50),
	@Precio				float				OUTPUT,
	@Descuento			float				OUTPUT,
	@Politica			varchar(MAX) = NULL	OUTPUT,
	@DescuentoMonto		float = NULL		OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@ArtCat							varchar(50),
	@ArtGrupo						varchar(50),
	@ArtFam							varchar(50),
	@ArtAbc							varchar(1),
	@Fabricante						varchar(50),
	@ArtLinea						varchar(50),
	@ArtRama						varchar(20),  	
	@CteGrupo						varchar(50),
	@CteCat							varchar(50),
	@CteFam							varchar(50),
	@CteZona						varchar(30),	
	@Tipo							varchar(50),
	@Nivel							varchar(50),
	@NivelPolitica					varchar(50),
	@Costo							money,
	@TipoCosteo						varchar(20),
	@PrecioLista					money, 
	@Precio2						money,
	@Precio3						money,
	@Precio4						money,
	@Precio5						money,
	@Precio6						money,
	@Precio7						money,
	@Precio8						money,
	@Precio9						money,
	@Precio10						money,
  	@DescuentoAcum					float,
    @Ponderado						float,
    @CalcDescuento					float,
    @PrecioAcum						float,
    @PrecioTemp						float,
  	@Descripcion					varchar(50),
  	@ConVigencia					bit,
  	@FechaD							datetime,
  	@FechaA							datetime,
  	@PromocionExclusiva				bit,     
    @CalcDescuentoExclusivo			float,  
    @DescuentoExclusivo				float,  
    @PonderadoExclusivo				float,  
  	@PromocionPromocion				bit,    
    @CalcDescuentoPromocion			float,  
    @DescuentoPromocion				float,  
    @PonderadoPromocion				float,  
  	@PromocionParticular			bit,    
    @CalcDescuentoParticular		float,  
    @DescuentoParticular			float,  
    @PonderadoParticular			float,  
    @PromocionExclusivaAplicada		bit,    
    @PromocionPromocionAplicada		bit,    
    @PromocionParticularAplicada	bit     
      

	SET @PromocionExclusiva  = 0  
	SET @PromocionPromocion  = 0  
	SET @PromocionParticular = 0  

	SET @PromocionExclusivaAplicada = 0   
	SET @PromocionPromocionAplicada = 0   
	SET @PromocionParticularAplicada = 0  
          	  
	SELECT 
		@ArtCat  = a.Categoria,
		@ArtGrupo = a.Grupo,
		@ArtFam = a.Familia,
		@ArtAbc = a.ABC,
		@Fabricante = a.Fabricante,
		@ArtLinea = a.Linea,
		@ArtRama = a.Rama,
		@PrecioLista = a.PrecioLista,
		@Precio2 = a.Precio2,
		@Precio3 = a.Precio3,
		@Precio4 = a.Precio4,
		@Precio5 = a.Precio5,
		@Precio6 = a.Precio6,
		@Precio7 = a.Precio7,
		@Precio8 = a.Precio8,
		@Precio9 = a.Precio9,
		@Precio10 = a.Precio10
    FROM Art a 
	WHERE a.Articulo = @Articulo
   
	SELECT 
		@CteGrupo = c.Grupo,
		@CteCat   = c.Categoria,
		@CteFam   = c.Familia,
		@CteZona  = c.Zona
    FROM Cte c
	WHERE c.Cliente = @Cliente
    
	SELECT @TipoCosteo = TipoCosteo 
    FROM EmpresaCfg ec 
    WHERE ec.Empresa = @Empresa
   
	EXEC spPCGet @Sucursal, @Empresa, @Articulo, @SubCuenta, @UnidadVenta, @Moneda, @TipoCambio, @ListaPreciosEsp, @PrecioTemp OUTPUT
  
    SELECT @DescuentoMonto = SUM(pd.Monto)
    FROM Precio p
    INNER JOIN PrecioD pd ON p.ID = pd.ID AND @Cantidad >= pd.Cantidad                                                    
    WHERE ((ISNULL(p.ConVigencia,0) = 0) OR (@FechaEmision BETWEEN p.FechaD AND p.FechaA))
    AND ((ISNULL(p.NivelArticulo,0) = 0) OR (p.Articulo = @Articulo)) 
    AND ((ISNULL(p.NivelSubCuenta,0) = 0) OR (p.SubCuenta = @Subcuenta)) 
    AND ((ISNULL(p.NivelUnidadVenta,0) = 0) OR (p.UnidadVenta = @UnidadVenta)) 
    AND ((ISNULL(p.NivelArtCat,0) = 0) OR (p.ArtCat = @ArtCat)) 
    AND ((ISNULL(p.NivelArtGrupo,0) = 0) OR (p.ArtGrupo = @ArtGrupo)) 
    AND ((ISNULL(p.NivelArtFam,0) = 0) OR (p.ArtFam = @ArtFam)) 
    AND ((ISNULL(p.NivelArtABC,0) = 0) OR (p.ArtAbc = @ArtAbc)) 
    AND ((ISNULL(p.NivelFabricante,0) = 0) OR (p.Fabricante = @Fabricante)) 
    AND ((ISNULL(p.NivelArtLinea,0) = 0) OR (p.ArtLinea = @ArtLinea))  
    AND ((ISNULL(p.NivelArtRama,0) = 0) OR (p.ArtRama = @ArtRama)) 
    AND ((ISNULL(p.NivelCliente,0) = 0) OR (p.Cliente = @Cliente))  
    AND ((ISNULL(p.NivelCteGrupo,0) = 0) OR (p.CteGrupo = @CteGrupo))   
    AND ((ISNULL(p.NivelCteCat,0) = 0) OR (p.CteCat = @CteCat)) 
    AND ((ISNULL(p.NivelCteFam,0) = 0) OR (p.CteFam = @CteFam)) 
    AND ((ISNULL(p.NivelCteZona,0) = 0) OR (p.CteZona = @CteZona)) 
    AND ((ISNULL(p.NivelAgente,0) = 0) OR (p.Agente = @Agente)) 
    AND ((ISNULL(p.NivelMoneda,0) = 0) OR (p.Moneda = @Moneda)) 
    AND ((ISNULL(p.NivelCondicion,0) = 0) OR (p.Condicion = @Condicion)) 
    AND ((ISNULL(p.NivelAlmacen,0) = 0) OR (p.Almacen = @Almacen)) 
    AND ((ISNULL(p.NivelProyecto,0) = 0) OR (p.Proyecto = @Proyecto)) 
    AND ((ISNULL(p.NivelFormaEnvio,0) = 0) OR (p.FormaEnvio = @FormaEnvio)) 
    AND ((ISNULL(p.NivelMov,0) = 0) OR (p.Mov = @Mov)) 
    AND ((ISNULL(p.NivelServicioTipo,0) = 0) OR (p.ServicioTipo = @ServicioTipo)) 
    AND ((ISNULL(p.NivelContratoTipo,0) = 0) OR (p.ContratoTipo = @ContratoTipo)) 
    AND ((ISNULL(p.NivelEmpresa,0) = 0) OR (p.Empresa = @Empresa)) 
    AND ((ISNULL(p.NivelRegion,0) = 0) OR (p.Region = @Region)) 
    AND ((ISNULL(p.NivelSucursal,0) = 0) OR (p.Sucursal = @Sucursal))      
    AND ((ISNULL(p.ListaPrecios,'Todas') = 'Todas') OR (p.ListaPrecios = @ListaPreciosEsp)) 
    AND p.Tipo LIKE '$ Descuento%' 
    AND p.Estatus = 'ACTIVA' 
    AND pd.Cantidad = (SELECT MAX(Cantidad) 
                       FROM PrecioD pd2 
                       WHERE p.ID = pd2.ID
                       AND @Cantidad >= pd2.Cantidad) 

	DECLARE crDescto CURSOR LOCAL FOR    
    SELECT pd.Monto,
	   p.Nivel,
	   p.Descripcion,
	   p.FechaD,
	   p.FechaA,
	   p.ConVigencia
	FROM Precio p
    INNER JOIN PrecioD pd ON p.ID = pd.ID AND @Cantidad >= pd.Cantidad                          
    WHERE ((ISNULL(p.ConVigencia,0) = 0) OR (@FechaEmision BETWEEN p.FechaD AND p.FechaA))
    AND ((ISNULL(p.NivelArticulo,0) = 0) OR (p.Articulo = @Articulo)) 
    AND ((ISNULL(p.NivelSubCuenta,0) = 0) OR (p.SubCuenta = @Subcuenta)) 
    AND ((ISNULL(p.NivelUnidadVenta,0) = 0) OR (p.UnidadVenta = @UnidadVenta)) 
    AND ((ISNULL(p.NivelArtCat,0) = 0) OR (p.ArtCat = @ArtCat))
    AND ((ISNULL(p.NivelArtGrupo,0) = 0) OR (p.ArtGrupo = @ArtGrupo)) 
    AND ((ISNULL(p.NivelArtFam,0) = 0) OR (p.ArtFam = @ArtFam))
    AND ((ISNULL(p.NivelArtABC,0) = 0) OR (p.ArtAbc = @ArtAbc))  
    AND ((ISNULL(p.NivelFabricante,0) = 0) OR (p.Fabricante = @Fabricante))
    AND ((ISNULL(p.NivelArtLinea,0) = 0) OR (p.ArtLinea = @ArtLinea)) 
    AND ((ISNULL(p.NivelArtRama,0) = 0) OR (p.ArtRama = @ArtRama))
    AND ((ISNULL(p.NivelCliente,0) = 0) OR (p.Cliente = @Cliente))
    AND ((ISNULL(p.NivelCteGrupo,0) = 0) OR (p.CteGrupo = @CteGrupo))
    AND ((ISNULL(p.NivelCteCat,0) = 0) OR (p.CteCat = @CteCat))
    AND ((ISNULL(p.NivelCteFam,0) = 0) OR (p.CteFam = @CteFam))
    AND ((ISNULL(p.NivelCteZona,0) = 0) OR (p.CteZona = @CteZona))
    AND ((ISNULL(p.NivelAgente,0) = 0) OR (p.Agente = @Agente))
    AND ((ISNULL(p.NivelMoneda,0) = 0) OR (p.Moneda = @Moneda))
    AND ((ISNULL(p.NivelCondicion,0) = 0) OR (p.Condicion = @Condicion))
    AND ((ISNULL(p.NivelAlmacen,0) = 0) OR (p.Almacen = @Almacen))
    AND ((ISNULL(p.NivelProyecto,0) = 0) OR (p.Proyecto = @Proyecto))
    AND ((ISNULL(p.NivelFormaEnvio,0) = 0) OR (p.FormaEnvio = @FormaEnvio))
    AND ((ISNULL(p.NivelMov,0) = 0) OR (p.Mov = @Mov))
    AND ((ISNULL(p.NivelServicioTipo,0) = 0) OR (p.ServicioTipo = @ServicioTipo))
    AND ((ISNULL(p.NivelContratoTipo,0) = 0) OR (p.ContratoTipo = @ContratoTipo))
    AND ((ISNULL(p.NivelEmpresa,0) = 0) OR (p.Empresa = @Empresa)) 
    AND ((ISNULL(p.NivelRegion,0) = 0) OR (p.Region = @Region))
    AND ((ISNULL(p.NivelSucursal,0) = 0) OR (p.Sucursal = @Sucursal))          
    AND ((ISNULL(p.ListaPrecios,'Todas') = 'Todas') OR (p.ListaPrecios = @ListaPreciosEsp))
    AND p.Tipo = '% Descuento'
    AND p.Estatus = 'ACTIVA'
    AND pd.Cantidad = (SELECT MAX(Cantidad) 
                       FROM PrecioD pd2 
                       WHERE p.ID = pd2.ID
                       AND @Cantidad >= pd2.Cantidad)
  
	OPEN crDescto
	FETCH NEXT FROM CrDescto INTO @DescuentoAcum, @Nivel, @Descripcion, @FechaD, @FechaA, @ConVigencia	      
      
    IF @Nivel IN ('Exclusiva') 
		BEGIN
			SET @PromocionExclusivaAplicada = 1
			SET @PromocionExclusiva = 1 
		END 
	ELSE
		IF @Nivel IN ('Promocion') 
			BEGIN
				SET @PromocionPromocionAplicada = 1
				SET @PromocionPromocion = 1 
			END 
		ELSE
			IF @Nivel IN ('Particular') 
				BEGIN
					SET @PromocionParticularAplicada = 1
					SET @PromocionParticular = 1 
				END  
       
	SELECT @Ponderado = 100
    SELECT @CalcDescuento = (@DescuentoAcum /100) * @Ponderado
    SELECT @Descuento = @CalcDescuento
    SELECT @Ponderado = @Ponderado - @CalcDescuento
    SELECT @PonderadoExclusivo = 100 
    SELECT @CalcDescuentoExclusivo = (@DescuentoAcum /100) * @PonderadoExclusivo 
    SELECT @DescuentoExclusivo = @CalcDescuentoExclusivo 
    SELECT @PonderadoExclusivo = @PonderadoExclusivo - @CalcDescuentoExclusivo 

    SELECT @PonderadoPromocion = 100 
    SELECT @CalcDescuentoPromocion = (@DescuentoAcum /100) * @PonderadoPromocion 
    SELECT @DescuentoPromocion = @CalcDescuentoPromocion 
    SELECT @PonderadoPromocion = @PonderadoPromocion - @CalcDescuentoPromocion 

    SELECT @PonderadoParticular = 100 
    SELECT @CalcDescuentoParticular = (@DescuentoAcum /100) * @PonderadoParticular 
    SELECT @DescuentoParticular = @CalcDescuentoParticular 
    SELECT @PonderadoParticular = @PonderadoParticular - @CalcDescuentoParticular 

	WHILE @@FETCH_STATUS = 0 
		BEGIN
			FETCH NEXT FROM CrDescto INTO @DescuentoAcum, @Nivel, @Descripcion, @FechaD, @FechaA, @ConVigencia
		  
			IF @@FETCH_STATUS = 0
				BEGIN
					IF @Nivel IN ('Exclusiva') 
						BEGIN
							SET @PromocionExclusiva = 1 
						END 
					ELSE IF @Nivel IN ('Promocion') 
						BEGIN
							SET @PromocionPromocion = 1 
						END 
					ELSE IF @Nivel IN ('Particular') 
						BEGIN
							SET @PromocionParticular = 1 
						END  

					SELECT @CalcDescuento = (@DescuentoAcum /100) * @Ponderado    
					SELECT @Descuento = @Descuento + @CalcDescuento
					SELECT @Ponderado = @Ponderado - @CalcDescuento

					IF (@Nivel IN ('Siempre')) OR (@Nivel IN ('Exclusiva') AND @PromocionExclusivaAplicada = 0) 
						BEGIN
							SELECT @CalcDescuentoExclusivo = (@DescuentoAcum /100) * @PonderadoExclusivo  
							SELECT @DescuentoExclusivo = @DescuentoExclusivo + @CalcDescuentoExclusivo 
							SELECT @PonderadoExclusivo = @PonderadoExclusivo - @CalcDescuentoExclusivo 
				
							IF @Nivel IN ('Exclusiva') SET @PromocionExclusivaAplicada = 1
						END 
					ELSE IF (@Nivel IN ('Siempre')) OR (@Nivel IN ('Promocion') AND @PromocionPromocionAplicada = 0) 
						BEGIN
							SELECT @CalcDescuentoPromocion = (@DescuentoAcum /100) * @PonderadoPromocion  
							SELECT @DescuentoPromocion = @DescuentoPromocion + @CalcDescuentoPromocion 
							SELECT @PonderadoPromocion = @PonderadoPromocion - @CalcDescuentoPromocion 
				
							IF @Nivel IN ('Promocion') SET @PromocionPromocionAplicada = 1
						END 
					ELSE IF (@Nivel IN ('Siempre')) OR (@Nivel IN ('Particular') AND @PromocionParticularAplicada = 0)  
						BEGIN
							SELECT @CalcDescuentoParticular = (@DescuentoAcum /100) * @PonderadoParticular 
							SELECT @DescuentoParticular = @DescuentoParticular + @CalcDescuentoParticular 
							SELECT @PonderadoParticular = @PonderadoParticular - @CalcDescuentoParticular 
				
							IF @Nivel IN ('Particular') SET @PromocionParticularAplicada = 1            
						END          
				END
	  END         
	CLOSE crDescto
	DEALLOCATE crDescto

	IF @PromocionPromocion = 1                                                          
		SET @Descuento = @DescuentoPromocion  
	ELSE IF @PromocionPromocion = 0 AND @PromocionParticular = 1
		SET @Descuento = @DescuentoParticular 
	ELSE IF @PromocionPromocion = 0 AND @PromocionParticular = 0 AND @PromocionExclusiva = 1 
		SET @Descuento = @DescuentoExclusivo
  
	EXEC spVerCosto @Sucursal, @Empresa, NULL, @Articulo, @Subcuenta, @UnidadVenta, @TipoCosteo, @Moneda, @TipoCambio, @MovCosto = @Costo OUTPUT, @ConReturn = 0

    SELECT Precio = CASE WHEN p.Tipo = 'Precio' THEN MIN(ISNULL(pd.Monto,0))
			 WHEN p.Tipo = 'Precio=Costo+[%]' THEN MIN(@Costo + (@Costo * (ISNULL(pd.Monto,0) / 100.00)))
			 WHEN p.Tipo = 'Precio=Costo+[$]' THEN MIN(@Costo + ISNULL(pd.Monto,0))
			 WHEN p.Tipo = 'Precio=Costo+[% margen]' THEN MIN(@Costo / (1 - (ISNULL(pd.Monto,0) / 100.00)))
			 WHEN p.Tipo = 'Precio=Costo*[Factor]' THEN MIN(@Costo * pd.Monto)
			 WHEN p.Tipo = 'Precio=Precio+[%]' THEN MIN(@PrecioTemp + (@PrecioTemp * (ISNULL(pd.Monto,0) / 100.00)))
			 WHEN p.Tipo = 'Precio=Precio Lista+[%]' THEN MIN(@PrecioLista + (@PrecioLista * (ISNULL(pd.Monto,0) / 100.00)))
			 WHEN p.Tipo = 'Precio=Precio 2+[%]' THEN MIN(@Precio2 + (@Precio2 * (ISNULL(pd.Monto,0) / 100.00)))
			 WHEN p.Tipo = 'Precio=Precio 3+[%]' THEN MIN(@Precio3 + (@Precio3 * (ISNULL(pd.Monto,0) / 100.00)))
			 WHEN p.Tipo = 'Precio=Precio 4+[%]' THEN MIN(@Precio4 + (@Precio4 * (ISNULL(pd.Monto,0) / 100.00)))
			 WHEN p.Tipo = 'Precio=Precio 5+[%]' THEN MIN(@Precio5 + (@Precio5 * (ISNULL(pd.Monto,0) / 100.00)))
			 WHEN p.Tipo = 'Precio=Precio 6+[%]' THEN MIN(@Precio6 + (@Precio6 * (ISNULL(pd.Monto,0) / 100.00)))
			 WHEN p.Tipo = 'Precio=Precio 7+[%]' THEN MIN(@Precio7 + (@Precio7 * (ISNULL(pd.Monto,0) / 100.00)))
			 WHEN p.Tipo = 'Precio=Precio 8+[%]' THEN MIN(@Precio8 + (@Precio8 * (ISNULL(pd.Monto,0) / 100.00)))
			 WHEN p.Tipo = 'Precio=Precio 9+[%]' THEN MIN(@Precio9 + (@Precio9 * (ISNULL(pd.Monto,0) / 100.00)))
			 WHEN p.Tipo = 'Precio=Precio 10+[%]' THEN MIN(@Precio10 + (@Precio10 * (ISNULL(pd.Monto,0) / 100.00)))
	            END,
		  Orden = CASE WHEN p.Tipo = 'Precio' THEN 1
			WHEN p.Tipo = 'Precio=Costo+[%]' THEN 2
			WHEN p.Tipo = 'Precio=Costo+[$]' THEN 3
			WHEN p.Tipo = 'Precio=Costo+[% margen]' THEN 4
			WHEN p.Tipo = 'Precio=Costo*[Factor]' THEN 5
			WHEN p.Tipo = 'Precio=Precio+[%]' THEN 6
			WHEN p.Tipo = 'Precio=Precio Lista+[%]' THEN 7
			WHEN p.Tipo = 'Precio=Precio 2+[%]' THEN 8
			WHEN p.Tipo = 'Precio=Precio 3+[%]' THEN 9
			WHEN p.Tipo = 'Precio=Precio 4+[%]' THEN 10
			WHEN p.Tipo = 'Precio=Precio 5+[%]' THEN 11
			WHEN p.Tipo = 'Precio=Precio 6+[%]' THEN 12
			WHEN p.Tipo = 'Precio=Precio 7+[%]' THEN 13
			WHEN p.Tipo = 'Precio=Precio 8+[%]' THEN 14
			WHEN p.Tipo = 'Precio=Precio 9+[%]' THEN 15
			WHEN p.Tipo = 'Precio=Precio 10+[%]' THEN 16
		    ELSE 99999999
		    END,
		    p.Tipo,
		    p.Nivel
	INTO #PrecioTemp
    FROM Precio p
    INNER JOIN PrecioD pd ON p.ID = pd.ID AND @Cantidad >= pd.Cantidad                          
    WHERE ((ISNULL(p.ConVigencia,0) = 0) OR (@FechaEmision BETWEEN p.FechaD AND p.FechaA))
    AND ((ISNULL(p.NivelArticulo,0) = 0) OR (p.Articulo = @Articulo)) 
    AND ((ISNULL(p.NivelSubCuenta,0) = 0) OR (p.SubCuenta = @Subcuenta)) 
    AND ((ISNULL(p.NivelUnidadVenta,0) = 0) OR (p.UnidadVenta = @UnidadVenta)) 
    AND ((ISNULL(p.NivelArtCat,0) = 0) OR (p.ArtCat = @ArtCat))
    AND ((ISNULL(p.NivelArtGrupo,0) = 0) OR (p.ArtGrupo = @ArtGrupo)) 
    AND ((ISNULL(p.NivelArtFam,0) = 0) OR (p.ArtFam = @ArtFam))
    AND ((ISNULL(p.NivelArtABC,0) = 0) OR (p.ArtAbc = @ArtAbc))  
    AND ((ISNULL(p.NivelFabricante,0) = 0) OR (p.Fabricante = @Fabricante))
    AND ((ISNULL(p.NivelArtLinea,0) = 0) OR (p.ArtLinea = @ArtLinea)) 
    AND ((ISNULL(p.NivelArtRama,0) = 0) OR (p.ArtRama = @ArtRama))
    AND ((ISNULL(p.NivelCliente,0) = 0) OR (p.Cliente = @Cliente))
    AND ((ISNULL(p.NivelCteGrupo,0) = 0) OR (p.CteGrupo = @CteGrupo))
    AND ((ISNULL(p.NivelCteCat,0) = 0) OR (p.CteCat = @CteCat))
    AND ((ISNULL(p.NivelCteFam,0) = 0) OR (p.CteFam = @CteFam))
    AND ((ISNULL(p.NivelCteZona,0) = 0) OR (p.CteZona = @CteZona))
    AND ((ISNULL(p.NivelAgente,0) = 0) OR (p.Agente = @Agente))
    AND ((ISNULL(p.NivelMoneda,0) = 0) OR (p.Moneda = @Moneda))
    AND ((ISNULL(p.NivelCondicion,0) = 0) OR (p.Condicion = @Condicion))
    AND ((ISNULL(p.NivelAlmacen,0) = 0) OR (p.Almacen = @Almacen))
    AND ((ISNULL(p.NivelProyecto,0) = 0) OR (p.Proyecto = @Proyecto))
    AND ((ISNULL(p.NivelFormaEnvio,0) = 0) OR (p.FormaEnvio = @FormaEnvio))
    AND ((ISNULL(p.NivelMov,0) = 0) OR (p.Mov = @Mov))
    AND ((ISNULL(p.NivelServicioTipo,0) = 0) OR (p.ServicioTipo = @ServicioTipo))
    AND ((ISNULL(p.NivelContratoTipo,0) = 0) OR (p.ContratoTipo = @ContratoTipo))
    AND ((ISNULL(p.NivelEmpresa,0) = 0) OR (p.Empresa = @Empresa)) 
    AND ((ISNULL(p.NivelRegion,0) = 0) OR (p.Region = @Region))
    AND ((ISNULL(p.NivelSucursal,0) = 0) OR (p.Sucursal = @Sucursal))          
    AND ((ISNULL(p.ListaPrecios,'Todas') = 'Todas') OR (p.ListaPrecios = @ListaPreciosEsp))
    AND p.Tipo LIKE ('Precio%')
    AND p.Estatus = 'ACTIVA'
    AND pd.Cantidad = (SELECT MAX(Cantidad) 
                       FROM PrecioD pd2 
                       WHERE p.ID = pd2.ID
                       AND @Cantidad >= pd2.Cantidad)
	GROUP BY p.Tipo, p.Nivel
	ORDER BY Orden

	SELECT TOP 1 
		@Precio = Precio,
		@NivelPolitica = Nivel
    FROM #PrecioTemp
	ORDER BY Orden
   
	IF @NivelPolitica = 'Exclusiva'
		SELECT @Descuento = 0   
END    
GO


/********************************** spPOSPoliticaPrecios ************************************/
IF EXISTS (SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSPoliticaPrecios') AND type = 'P') DROP PROCEDURE dbo.spPOSPoliticaPrecios
GO             
CREATE PROCEDURE spPOSPoliticaPrecios
	@ID					varchar(36),
	@Articulo			varchar(20),
	@Subcuenta			varchar(50),
	@Cantidad			float,
	@UnidadVenta		varchar(50),
	@Precio				float		OUTPUT,
	@Descuento			float		OUTPUT,
	@DescuentoMonto		float		OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@FechaEmision		DateTime,
	@Cliente			varchar(10),
	@Agente				varchar(10),
	@Moneda				varchar(10),
	@TipoCambio			float,
	@Condicion			varchar(50),
	@Almacen			varchar(10),
	@Proyecto			varchar(50),
	@FormaEnvio			varchar(50),
	@Mov				varchar(20),
	@ServicioTipo		varchar(50),
	@ContratoTipo		varchar(50),
	@Empresa			varchar(50),
	@Region				varchar(50),
	@Sucursal			int,
	@ListaPreciosEsp	varchar(20),
	@Politica			varchar(MAX)

	SELECT 
	@FechaEmision = v.FechaEmision,
 	@Cliente = v.Cliente,
	@Agente = v.Agente,
	@Moneda = v.Moneda,
	@TipoCambio = v.TipoCambio,
	@Condicion = v.Condicion,
	@Almacen = v.Almacen,
	@Proyecto = v.Proyecto,
	@FormaEnvio = v.FormaEnvio,
	@Mov = v.Mov,
	@Empresa = v.Empresa,
	@Region = s.Region,
	@Sucursal = v.Sucursal,
	@ListaPreciosEsp = v.ListaPreciosEsp
    FROM POSL v
	INNER JOIN Sucursal s ON v.Sucursal = s.Sucursal
	WHERE v.ID = @ID
    
    EXEC spPOSPoliticaPreciosCalc @FechaEmision, @Agente, @Moneda, @TipoCambio, @Condicion, @Almacen, @Proyecto, @FormaEnvio, @Mov, @ServicioTipo, 
		@ContratoTipo, @Empresa, @Region, @Sucursal, @ListaPreciosEsp, @Cliente, @Articulo, @Subcuenta, @Cantidad, @UnidadVenta, 
		@Precio OUTPUT, @Descuento OUTPUT, @Politica OUTPUT, @DescuentoMonto OUTPUT
END
GO


/********************************** spPOSArtPrecio ************************************/
IF EXISTS (SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSArtPrecio') AND type = 'P') DROP PROCEDURE dbo.spPOSArtPrecio
GO             
CREATE PROCEDURE spPOSArtPrecio
	@Articulo					varchar(20),
    @Cantidad					float,
    @UnidadVenta				varchar(50),
    @Precio						float				OUTPUT,
    @Descuento					float				OUTPUT,
    @VentaID					varchar(36) = NULL,
    @SubCuenta					varchar(50) = NULL,
    @FechaEmision				Datetime = NULL,
    @Agente						varchar(10) = NULL,
    @Moneda						varchar(10) = NULL, 
    @TipoCambio					float = NULL,
    @Condicion					varchar(50) = NULL,
    @Almacen					varchar(10) = NULL,
    @Proyecto					varchar(50) = NULL,
    @FormaEnvio					varchar(50) = NULL,
    @Mov						varchar(20) = NULL,
    @ServicioTipo				varchar(50) = NULL,
    @ContratoTipo				varchar(50) = NULL,
    @Empresa					varchar(50) = NULL,
    @Region						varchar(50) = NULL,
    @Sucursal					int = NULL,
    @ListaPreciosEsp			varchar(20) = NULL,
    @Cliente					varchar(10) = NULL,                
    @PrecioConDescuento			bit = 0,
    @GetListaPreciosCliente		bit = 0
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@EnviarA					int,
  	@Politica					varchar(MAX),
	@DescuentoMonto				float,
	@DescuentoMontoPorcentaje	float,
    @OFER                 		bit 	  
	  
    SELECT @OFER = ISNULL(OFER,0)
    FROM EmpresaGral
    WHERE Empresa = @Empresa
  
	IF @GetListaPreciosCliente = 1
		BEGIN
			SELECT @Cliente = Cliente
			FROM POSL 
			WHERE ID = @VentaID
     
			SELECT @ListaPreciosEsp = ISNULL(ISNULL(cea.ListaPreciosEsp, c.ListaPreciosEsp), '(Precio Lista)')
			FROM Cte c
			INNER JOIN CteEnviarA cea ON c.Cliente = cea.Cliente
			AND cea.ID = @EnviarA 
		END
  
	IF @OFER = 0
		BEGIN    
			IF @VentaID IS NOT NULL
				EXEC spPOSPoliticaPrecios @VentaID, @Articulo, @Subcuenta, @Cantidad, @UnidadVenta, @Precio OUTPUT, @Descuento OUTPUT, @DescuentoMonto OUTPUT
			ELSE    
				EXEC spPOSPoliticaPreciosCalc @FechaEmision, @Agente, @Moneda, @TipoCambio, @Condicion, @Almacen, @Proyecto, @FormaEnvio, @Mov, @ServicioTipo, 
				@ContratoTipo, @Empresa, @Region, @Sucursal, @ListaPreciosEsp, @Cliente, @Articulo, @Subcuenta, @Cantidad, @UnidadVenta, 
				@Precio OUTPUT, @Descuento OUTPUT, @Politica OUTPUT, @DescuentoMonto OUTPUT        
		END  

	IF NULLIF(@Precio,0) IS NULL
		EXEC spPCGet @Sucursal, @Empresa,@Articulo, @SubCuenta, @UnidadVenta, @Moneda, @TipoCambio, @ListaPreciosEsp, @Precio OUTPUT 
	
	IF ISNULL(@DescuentoMonto,0) > 0 AND ISNULL(@Precio,0) > 0
		BEGIN
			SELECT @DescuentoMontoPorcentaje = (@DescuentoMonto / (@Precio * @Cantidad)) * 100
			SELECT @Descuento = ISNULL(@Descuento,0) + ISNULL(@DescuentoMontoPorcentaje,0)
		END
  
	IF ISNULL(@PrecioConDescuento, 0) = 1
		BEGIN
			SELECT @Precio = @Precio - (@Precio * (ISNULL(@Descuento,0)/100))
			SELECT @Descuento = NULL
		END
END
GO


/************************ spPOSVentaInsertaArticulo *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSVentaInsertaArticulo') AND type = 'P') DROP PROCEDURE dbo.spPOSVentaInsertaArticulo
GO             
CREATE PROCEDURE spPOSVentaInsertaArticulo
	@Modulo					varchar(5),
    @Usuario				varchar(10),
    @Codigo					varchar(36),
    @CodigoAccion			varchar(50),    	         	     
    @ID						varchar(50),
    @FechaEmision			datetime,
    @Agente					varchar(10),
    @Moneda					varchar(10),
    @TipoCambio				float,
    @Condicion				varchar(50),
    @Almacen				varchar(10),
    @Proyecto				varchar(50),
    @FormaEnvio				varchar(50),
    @Mov					varchar(20),
    @Empresa				varchar(5),
    @Sucursal				int,
    @ListaPreciosEsp		varchar(20),	
    @Cliente				varchar(10),
    @CtaDinero				varchar(10),
    @Accion					varchar(50),
    @Estacion				int,
    @Mensaje				varchar(255) OUTPUT,
    @ArtDescripcion			varchar(100) OUTPUT,
    @Imagen					varchar(255) OUTPUT,
    @Ok						int	     OUTPUT,
    @OkRef					varchar(255) OUTPUT,
    @Expresion				varchar(255) = NULL OUTPUT,
    @Cantidad				float	= NULL,
    @Juego					bit	= 0,
    @EliminarSerieLote		bit	= 0,
    @SerieLote				varchar(50) = NULL,
    @TorretaMensaje1		varchar(20)= NULL OUTPUT,
	@TorretaMensaje2		varchar(20)= NULL OUTPUT,
	@TorretaPosicion1		varchar(20)= NULL OUTPUT,
	@TorretaPosicion2		varchar(20)= NULL OUTPUT,
	@NoAfectarSerieLote		bit = 0
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@Renglon						float,
    @RenglonSub						int,
    @RenglonID						float,
    @RenglonTipo					varchar(1),    
    @Estatus						varchar(20),
    @Cobrado						bit,
    @Amortizado						bit,    
    @Articulo						varchar(20),
	@Unidad							varchar(50),
	@Factor							float,
	@ArtTipo						varchar(20),
	@SubCuenta						varchar(50),
	@Impuesto1						float,
	@Impuesto2						float,
	@Impuesto3						float,
	@Precio							float,
	@PrecioCImp						float,
	@DescuentoLinea					float,	  
	@ImagenNombreAnexo				varchar(255),
	@AgruparArticulos				bit,
	@OFER							bit,
	@CantidadArticuloTotal			float,
	@Componente						varchar(20),
	@ComponenteSubCuenta			varchar(50),
	@ComponenteCodigo				varchar(50),
	@ComponenteCantidad				float,	  
	@BasculaPesar					bit,
	@Servicio						varchar(20),
	@Caja							varchar(10),	  
	@Host							varchar(20),
	@Cluster						varchar(20),
	@EsDevolucion					bit,
	@IDL							varchar(50),
	@MovTipo						varchar(20),
	@ZonaImpuestoUsuario			varchar(50),
	@ZonaImpuestoCliente			varchar(50),
	@ZonaImpuesto					varchar(50),
	@Contacto						varchar(10),
    @EnviarA						int,
	@RedondeoMonetarios				int,
	@JuegoComponentes				bit,
	@JuegoComponentesCB				bit,
	@Monedero						varchar(20),
	@TipoOpcion						varchar(20),
	@CodigoArt						varchar(30),
	@MatrizOpciones					bit,
	@CfgMultiUnidades				bit,
	@CfgVentaFactorDinamico			bit,
	@UnidadFactor					float,
	@LDIForma						varchar(50),
	@ArticuloOfertaFP				varchar(20),
	@MovClave						varchar(20),
	@MovSubClave					varchar(20),
	@ContMoneda						varchar(10),
    @ContMonedaTC					float,
    @WebService						bit,
    @NoExiste						bit,
    @OfertaID						int,
    @ArticuloRedondeo				varchar(20),
    @CodigoRedondeo					varchar(50),
    @POSDefMovServ					varchar(20),
    @POSDefMovDev					varchar(20),
    @IDDevolucionP					varchar(36),
	@CantidadD						float,
	@CantidadInvD					float,
	@PrecioD						float,
	@DescuentoLineaD				float,
	@Impuesto1D						float,
	@Impuesto2D						float,
	@Impuesto3D						float,
	@PrecioImpuestoIncD				float,
	@CantidadObsequioD				float,
	@PrecioSugeridoD				float,
	@BanderaDP						bit,
	@CantidadR						float,
	@CantidadRBis					float,
	@ArticuloD						varchar(20),
	@RenglonD						int,
    @POSAgenteDetalle				bit,
	@POSAgenteDetMaestro			varchar(15),
    @POSValidaAgente				bit = 0,
    @POSValidaAgenteR				varchar(20),
    @ArtRama						varchar(20),
    @ArtGrupo						varchar(50),
    @ArtCategoria					varchar(50),
    @ArtFamilia						varchar(50),
    @ArtLinea						varchar(50),
    @ArtFabricante					varchar(50),
    @ArtObservaciones				varchar (255),
    @ArtPOSAgenteDetalle			varchar (255),
	@ArtPOSAgenteDetalleInfo		varchar (255),
    @PuntosD						money,
    @SerieLoteDevP					varchar(50),
	@OrdenDevP						int,
    @CantidadAd						float, 
	@Cantidad2						float,
    @SeVende						bit,
    @EstatusArt						varchar(15),
	@CfgPrecioNivelUnidad			bit, 
	@CfgNivelFactorMultiUnidad		varchar(20),
	@SeriesLotesAutoOrden			varchar(20),
	@ExpresionBis					varchar(255),
	@ValidaComponente				bit,
	@PrecioSugerido					float,
	@CfgVentaPreciosImpuestoIncluido bit,
	@CfgVentaMonederoA				bit

    
	SELECT @POSDefMovServ = NULLIF(RTRIM(POSDefMovServ),''), @POSDefMovDev = NULLIF(POSDefMovDev,''),  @POSAgenteDetalle = ISNULL(POSAgenteDetalle,0), @POSAgenteDetMaestro = NULLIF(POSAgenteDetMaestro,'')
	  FROM POSCfg 
	 WHERE Empresa = @Empresa

	 SELECT @SeriesLotesAutoOrden = ISNULL(NULLIF(SeriesLotesAutoOrden,''), 'NO')
	   FROM EmpresaCfg 
	  WHERE Empresa = @Empresa

    IF ISNULL(@Accion,'') ='DEVOLUCION PARCIAL'
	BEGIN
		IF @POSDefMovDev IS NOT NULL 
			UPDATE POSL SET MOV = @POSDefMovDev WHERE ID = @ID
          
		UPDATE POSL SET IDDevolucionP =  @Codigo WHERE ID = @ID
        
		SELECT @Mensaje = 'INGRESE LOS ARTICULOS A DEVOLVER'
		SET @Mov = @POSDefMovDev
			
		RETURN
	END
          
	SELECT @BanderaDP = 0, @IDDevolucionP = NULL, @CantidadD = NULL, @PrecioD = NULL, @DescuentoLineaD = NULL, @Impuesto1D = NULL, @Impuesto2D = NULL, 
		   @Impuesto3D = NULL, @PrecioImpuestoIncD = NULL, @CantidadObsequioD = NULL, @PrecioSugeridoD = NULL, @CantidadInvD = NULL
  
	SELECT @IDDevolucionP = NULLIF(IDDevolucionP,'') 
	  FROM POSL 
	 WHERE ID = @ID 
  
	IF @IDDevolucionP IS NOT NULL
		SELECT @Accion = 'CANCELAR PARTIDA', @BanderaDP = 1
          
	SET @NoExiste = 0          
          
	IF NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID) AND (SELECT FechaInicio FROM POSL WHERE ID = @ID) IS NULL
	BEGIN
		UPDATE POSL SET FechaInicio = GETDATE() WHERE ID = @ID
	END          

	SELECT @POSDefMovServ = NULLIF(POSDefMovServ,'') FROM POSCfg WHERE Empresa = @Empresa          
	
	--DETERMINA EL ARTICULO REDONDEO
	SELECT @CodigoRedondeo = pc.RedondeoVentaCodigo
      FROM POSCfg pc
     WHERE pc.Empresa = @Empresa

	SELECT @ArticuloRedondeo = Cuenta
      FROM CB
     WHERE Codigo = @CodigoRedondeo
       AND TipoCuenta = 'Articulos'
                
	SELECT @ContMoneda = ec.ContMoneda, 
		   @CfgVentaPreciosImpuestoIncluido = isnull(ec.VentaPreciosImpuestoIncluido,0)
      FROM EmpresaCfg ec	  
	 WHERE ec.Empresa = @Empresa
   
	SELECT @ContMonedaTC = TipoCambio FROM POSLTipoCambioRef WHERE Sucursal = @Sucursal AND Moneda = @ContMoneda    
  
	SELECT @TipoCambio = CASE WHEN @Moneda <> @ContMoneda THEN  (ISNULL(@TipoCambio,1)/@ContMonedaTC) ELSE ISNULL(@TipoCambio,1) END 
 
	SELECT @MovClave = Clave, @MovSubClave = NULLIF(SubClave,'') FROM MovTipo WHERE Mov = @Mov AND Modulo = 'POS'

	IF (SELECT POSDutyFree FROM POSCfg WHERE Empresa = @Empresa) = 1 AND @MovClave IN ('POS.N', 'POS.F', 'POS.P')
	    AND ISNULL(@Accion,'') NOT IN('DEVOLUCION TOTAL','REFERENCIAR VENTA', 'DEVOLUCION PARCIAL', 'PESAR')
	BEGIN
		SET @ExpresionBis = NULL
		EXEC spPOSDatosVueloVerificar @ID, 1, @ExpresionBis OUTPUT

		IF @ExpresionBis IS NOT NULL
		BEGIN
			SELECT @Expresion = @ExpresionBis
			RETURN
		END
	END


  
	IF @MovClave IN('POS.TCAC', 'POS.AC', 'POS.ACM', 'POS.AP', 'POS.CTCAC', 'POS.CACM', 'POS.CCCM', 'POS.CTCRC', 'POS.CTCM', 'POS.CTRM', 'POS.CAC', 'POS.CCC', 
		'POS.CXCC', 'POS.CC', 'POS.CCM', 'POS.CPCM', 'POS.CPC', 'POS.CXCD', 'POS.EC', 'POS.FTE', 'POS.IC', 'POS.TCM', 'POS.TCRC', 'POS.STE', 'POS.TCM', 'POS.TRM', 
		'POS.INVA', 'POS.INVD')
		OR (@MovClave ='POS.FA' AND	@MovSubClave = 'POS.ANTREF')OR(@MovClave = 'POS.N' AND @MovSubClave =  'POS.DREF')
		SELECT @Ok = 25460,@OkRef ='('+@Mov+')'
	  
	EXEC spPOSVentaInsertaRedondeo @ID, 'ELIMINAR', NULL
  
	SELECT @ArticuloOfertaFP = pc.ArtOfertaFP, @WebService = ISNULL(WebService,0)
      FROM POSCfg pc
	 WHERE Empresa = @Empresa
   
	IF EXISTS(SELECT * FROM POSLVenta WHERE Articulo = @ArticuloOfertaFP AND ID = @ID) 
		DELETE POSLVenta WHERE Articulo = @ArticuloOfertaFP AND ID = @ID
	  
	SELECT @Monedero =  Monedero	  FROM POSL WHERE ID = @ID
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)          	  

	SELECT @Amortizado = 0, @EsDevolucion = 0, @Cobrado = 0

	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT	  
	  
	SELECT @OFER = eg.OFER
      FROM EmpresaGral eg
     WHERE Empresa = @Empresa
    
	SELECT 
		@CfgMultiUnidades = ISNULL(MultiUnidades,0),
		@CfgVentaFactorDinamico = ISNULL(VentaFactorDinamico,0),
		@CfgPrecioNivelUnidad = ISNULL(PrecioNivelUnidad,0),
		@CfgNivelFactorMultiUnidad = ISNULL(NivelFactorMultiUnidad,0),
		@CfgVentaMonederoA	= ISNULL(VentaMonederoA,0)
      FROM EmpresaCfg2
	 WHERE Empresa = @Empresa    
    
	SELECT @JuegoComponentes = ISNULL(JuegoComponentes,1), @JuegoComponentesCB = ISNULL(JuegoComponentesCB,0), @MatrizOpciones = ISNULL(MatrizOpciones,0)
      FROM POSCfg
     WHERE Empresa = @Empresa    
     
	SELECT @MovTipo = mt.Clave
      FROM MovTipo mt
     WHERE mt.Modulo = 'POS'
       AND mt.Mov = @Mov
   
	SELECT @Estatus = p.Estatus,@Contacto = p.Cliente, @EnviarA = p.EnviarA, @ZonaImpuestoCliente = c.ZonaImpuesto
      FROM POSL p JOIN Cte c ON p.Cliente = c.Cliente
     WHERE p.ID = @ID
   
	SELECT @Caja = u.DefCtaDinero,@ZonaImpuestoUsuario = u.DefZonaImpuesto 
      FROM Usuario u
     WHERE u.Usuario = @Usuario
    
	SELECT @ZonaImpuesto = ISNULL(NULLIF(@ZonaImpuestoCliente,''),@ZonaImpuestoUsuario) 
       
	IF EXISTS(SELECT * FROM POSLAmortizacionPagos WHERE ID = @ID)
		SELECT @Amortizado = 1
   
	IF ISNULL((SELECT SUM(Importe) FROM POSLCobro WHERE ID = @ID),0) <> 0
		SELECT @Cobrado = 1
   
	IF (@Amortizado = 1 AND @Cobrado = 1) OR (isnull(nullif(@Estatus,''),'SINAFECTAR') <>  'SINAFECTAR')
		SELECT @Ok = 10015, @okRef = 'El movimiento no puede tener amortizaciones y tener cobros aplicados para poder añadir articulos'
   
	IF @Cantidad IS NULL            	
		SELECT 
			@Articulo = c.Cuenta,
            @CodigoArt = c.Codigo,
            @ArtDescripcion = a.Descripcion1,
            @ArtTipo = a.Tipo,
            @TipoOpcion = a.TipoOpcion,
            @SubCuenta = NULLIF(c.SubCuenta, ''),
            @Cantidad = CASE WHEN a.BasculaPesar = 1 THEN 0 ELSE ISNULL(NULLIF(c.Cantidad,''), 1) END,
            @Unidad = ISNULL(NULLIF(c.Unidad,''),a.Unidad),
            @Impuesto1 = a.Impuesto1,
            @Impuesto2 = a.Impuesto2,
            @Impuesto3 = a.Impuesto3,
            @BasculaPesar = a.BasculaPesar,
            @ArtRama = a.Rama,
            @ArtGrupo = a.Grupo,
            @ArtCategoria = a.Categoria,
            @ArtFamilia = a.Familia,
            @ArtLinea = a.Linea,
            @ArtFabricante = a.Fabricante,
            @ArtPOSAgenteDetalle = CASE WHEN @POSAgenteDetalle = 1 THEN @POSAgenteDetMaestro ELSE NULL END, 
            @SeVende    = ISNULL(a.SeVende,0),
            @EstatusArt = Estatus
		FROM CB c
		INNER JOIN Art a ON c.Cuenta = a.Articulo
		WHERE c.Codigo = @Codigo

	IF @Cantidad IS NOT NULL            	
		SELECT 
			@Articulo = c.Cuenta,
            @CodigoArt = c.Codigo,
            @ArtDescripcion = a.Descripcion1,
            @ArtTipo = a.Tipo,
            @SubCuenta = NULLIF(c.SubCuenta, ''),
            @Unidad = ISNULL(NULLIF(c.Unidad,''),a.Unidad),
            @Impuesto1 = a.Impuesto1,
            @Impuesto2 = a.Impuesto2,
            @Impuesto3 = a.Impuesto3,
            @BasculaPesar = a.BasculaPesar,
            @ArtRama = a.Rama,
            @ArtGrupo = a.Grupo,
            @ArtCategoria = a.Categoria,
            @ArtFamilia = a.Familia,
            @ArtLinea = a.Linea,
            @ArtFabricante = a.Fabricante,
            @ArtPOSAgenteDetalle = CASE WHEN @POSAgenteDetalle = 1 THEN @POSAgenteDetMaestro ELSE NULL END,
            @SeVende    = ISNULL(a.SeVende,0),
            @EstatusArt = Estatus            
		FROM CB c
		INNER JOIN Art a ON c.Cuenta = a.Articulo
		WHERE c.Codigo = @Codigo

	IF @POSAgenteDetalle = 1 AND @ArtPOSAgenteDetalle IS NOT NULL
	BEGIN
		IF @ArtPOSAgenteDetalle = 'Categoría'
		BEGIN
			IF EXISTS (SELECT * FROM ArtCat WHERE Categoria = @ArtCategoria AND POSAgenteDetalle = 1)
				SELECT @ArtPOSAgenteDetalle = 'Categoria', @ArtPOSAgenteDetalleInfo = @ArtCategoria
			ELSE
				SELECT @ArtPOSAgenteDetalle = NULL, @ArtCategoria = NULL, @ArtPOSAgenteDetalleInfo = NULL
		END
		IF @ArtPOSAgenteDetalle = 'Grupo'
		BEGIN
			IF EXISTS (SELECT * FROM ArtGrupo WHERE Grupo = @ArtGrupo AND POSAgenteDetalle = 1)
				SELECT @ArtPOSAgenteDetalle = 'Grupo', @ArtPOSAgenteDetalleInfo = @ArtGrupo
			ELSE
				SELECT @ArtPOSAgenteDetalle = NULL, @ArtGrupo = NULL, @ArtPOSAgenteDetalleInfo = NULL
		END
		IF @ArtPOSAgenteDetalle = 'Familia'
		BEGIN
			IF EXISTS (SELECT * FROM ArtFam WHERE Familia = @ArtFamilia AND POSAgenteDetalle = 1)
				SELECT @ArtPOSAgenteDetalle = 'Familia', @ArtPOSAgenteDetalleInfo = @ArtFamilia
			ELSE
				SELECT @ArtPOSAgenteDetalle = NULL, @ArtFamilia = NULL, @ArtPOSAgenteDetalleInfo = NULL
		END
		IF @ArtPOSAgenteDetalle = 'Línea'
		BEGIN
			IF EXISTS (SELECT * FROM ArtLinea WHERE Linea = @ArtLinea AND POSAgenteDetalle = 1)
				SELECT @ArtPOSAgenteDetalle = 'Linea', @ArtPOSAgenteDetalleInfo =@ArtLinea
			ELSE
				SELECT @ArtPOSAgenteDetalle = NULL, @ArtLinea = NULL, @ArtPOSAgenteDetalleInfo = NULL
		END
		IF @ArtPOSAgenteDetalle = 'Fabricante'
		BEGIN
			IF EXISTS (SELECT * FROM Fabricante WHERE Fabricante = @ArtFabricante AND POSAgenteDetalle = 1)
				SELECT @ArtPOSAgenteDetalle = 'Fabricante', @ArtPOSAgenteDetalleInfo = @ArtFabricante
			ELSE
				SELECT @ArtPOSAgenteDetalle = NULL, @ArtFabricante = NULL, @ArtPOSAgenteDetalleInfo = NULL
		END

	END
      
	EXEC spZonaImp @ZonaImpuesto, @Impuesto1 OUTPUT
	EXEC spZonaImp @ZonaImpuesto, @Impuesto2 OUTPUT
	EXEC spZonaImp @ZonaImpuesto, @Impuesto3 OUTPUT
	EXEC spTipoImpuesto @Modulo, 0, @Mov, @FechaEmision, @Empresa, @Sucursal, @Contacto, @EnviarA, @Articulo = @Articulo, @EnSilencio = 1, 
			@Impuesto1 = @Impuesto1 OUTPUT, @Impuesto2 = @Impuesto2 OUTPUT, @Impuesto3 = @Impuesto3 OUTPUT      
      
	IF @SeVende = 0
	BEGIN
		SELECT @Ok = 10530, @OkRef = 'La Configuración del Artículo no Permite su Venta'
		RETURN
	END
	
	IF @EstatusArt = 'Baja'
	BEGIN
		SELECT @Ok = 10530, @OkRef = 'El Estatus del Artículo no Permite su Venta'
		RETURN
	END    

	IF @CfgMultiUnidades = 1 OR @CfgVentaFactorDinamico = 1
	BEGIN      
		EXEC spUnidadFactor @Empresa, @Articulo, NULL, @Unidad, @UnidadFactor OUTPUT      
	END 

	IF @ArtTipo IN ('Juego')
	BEGIN
		IF EXISTS(SELECT cb.Codigo FROM ArtJuegoD ajd LEFT OUTER JOIN CB cb ON cb.Cuenta = ajd.Opcion AND ISNULL(cb.SubCuenta, '') = ISNULL(ajd.SubCuenta,'') 
			WHERE cb.Codigo IS NULL AND ajd.Articulo = @Articulo )
			SELECT @Ok = '72040', @OkRef = 'Falta indicar codigo a alguno de los componentes'           
	END

	IF @ArtTipo IN ('Juego') AND @Ok IS NULL
	BEGIN
		IF EXISTS (SELECT * FROM Art WHERE Articulo IN (SELECT DISTINCT Opcion FROM ArtJuegoD WHERE Articulo = @Articulo) AND Tipo IN ('Lote', 'Serie'))
			IF @Mov <> @POSDefMovDev
				SELECT @Mensaje = @Mensaje + 'EL JUEGO CONTIENE ARTICULOS SERIE O LOTE, DEBE DE ENTRAR A EDITAR DETALLE PARA ASIGNAR LA SERIE O LOTE'
	END

    IF @ArtTipo IN  ('Serie', 'Lote') AND (@MovTipo IN('POS.N','POS.F','POS.NPC')AND @MovSubClave <> 'POS.PEDCONT' )
	BEGIN
		IF @TipoOpcion = 'Si' AND @SubCuenta IS NULL AND @MatrizOpciones = 1 AND EXISTS(SELECT * FROM ArtOpcion  WHERE Articulo = @Articulo)
		BEGIN
			SELECT @Mensaje = NULL
			DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja
		END 
	END

    IF @ArtTipo IN  ('Serie', 'Lote') AND (@MovTipo = 'POS.P'  AND @MovSubClave IN('POS.FACCRED','POS.DEVCRED'))
	BEGIN
		SELECT @Mensaje = 'POR FAVOR INGRESE EL NO. DE SERIE/LOTE'
		
		INSERT POSLAccion (Host, Caja, Accion, Referencia) VALUES (@Host, @Caja, 'SERIE/LOTE', @Accion)
      
		IF @TipoOpcion = 'Si' AND @SubCuenta IS NULL AND @MatrizOpciones = 1 AND EXISTS(SELECT * FROM ArtOpcion  WHERE Articulo = @Articulo)
		BEGIN
			SELECT @Mensaje = NULL
			DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja
		END 
	END    

	IF @TipoOpcion = 'Si' AND @SubCuenta IS NULL AND @MatrizOpciones = 0 AND EXISTS(SELECT * FROM ArtOpcion  WHERE Articulo = @Articulo AND Requerido = 1)
		SELECT @Ok = 20046

	IF @TipoOpcion = 'Si' AND @SubCuenta IS NULL AND @MatrizOpciones = 1 AND EXISTS(SELECT * FROM ArtOpcion  WHERE Articulo = @Articulo AND Requerido = 1) 
	   AND @ArtTipo IN  ('Serie', 'Lote')
	BEGIN
		SELECT @Ok = 20046, @OkRef = 'LA MATRIZ DE OPCIONES NO PUEDE SER MOSTRADA EN ARTÍCULOS TIPO/SERIE DEBIDO A QUE NO SE PUEDE ASIGNAR MÁS DE UNA SERIE/LOTE A LA VEZ.'
		RETURN
	END

    IF ISNULL(@BasculaPesar,0) = 1 AND ISNULL(@Accion,'') NOT IN ('CANCELAR PARTIDA', 'PESAR') AND NULLIF(@Cantidad,0) IS NULL
	BEGIN
		SELECT @CodigoAccion = 'PESAR'
		EXEC spPOSAccionDisparar @Empresa, @Sucursal, @Modulo, @Usuario, @Caja, @Estacion, @ID OUTPUT, @Codigo OUTPUT, @CodigoAccion OUTPUT, @Accion OUTPUT, 
			 @FormaPago = NULL, @Importe= NULL, @CantidadNotasEnProceso = NULL, @Imagen = @Imagen OUTPUT, @Mensaje = @Mensaje  OUTPUT, @Ok = @Ok OUTPUT, 
			 @OkRef = @OkRef OUTPUT, @Expresion = @Expresion OUTPUT
	END
    
    IF ISNULL(@Accion,'') NOT IN('DEVOLUCION TOTAL','REFERENCIAR VENTA', 'DEVOLUCION PARCIAL')
	BEGIN
		IF @Articulo IS NOT NULL AND @Ok IS NULL
		BEGIN
			EXEC xpPOSVentaInsertaArticuloVerificar @Codigo, @Articulo, @ID, @FechaEmision, @Agente, @Moneda, @TipoCambio, @Condicion, @Almacen, @Proyecto, @FormaEnvio, 
													@Mov, @Empresa, @Sucursal, @ListaPreciosEsp, @Cliente, @Accion, @ArtDescripcion OUTPUT, @Imagen OUTPUT, @Ok OUTPUT, 
													@OkRef OUTPUT
      
			SELECT @ImagenNombreAnexo = pc.ImagenNombreAnexo,
				   @AgruparArticulos = ISNULL(pc.AgruparArticulos,0)
			  FROM POSCfg pc
			 WHERE pc.Empresa = @Empresa
         
			IF @Juego = 0
				SELECT @Imagen = MAX(ac.Direccion)
				  FROM AnexoCta ac
				 WHERE ac.Nombre = @ImagenNombreAnexo
				   AND Rama = 'INV'
				   AND ac.Cuenta = @Articulo
				   AND ac.Tipo = 'Imagen'
        
			SET @Servicio = NULL
			
			SELECT @Servicio = plart.Servicio
			  FROM POSLDIArtRecargaTel plart
			 WHERE plart.Articulo = @Articulo
			
			IF @Servicio IS NOT NULL
			BEGIN
				IF (SELECT SUM(Cantidad) FROM POSLVenta WHERE ID = @ID) <> 0
					SELECT @Ok = 10530, @OkRef = UPPER('Un Servicio no se puede Combinar con otros productos y/o Servicios')
			END
			
			IF EXISTS(SELECT 1 FROM POSLVenta WHERE ID = @ID AND NULLIF(LDIServicio, '') IS NOT NULL )            
				SELECT @Ok = 10530, @OkRef = 'Un Servicio no se puede Combinar con otros productos y/o Servicios'
			
			IF @POSDefMovServ IS NOT NULL AND @Ok IS NULL AND @Servicio IS NOT NULL
				UPDATE POSL SET Mov = @POSDefMovServ WHERE ID = @ID
			
			SELECT @Renglon = ISNULL(MAX(plv.Renglon),0) + 2048,
				   @RenglonSub = 0,
				   @RenglonID = ISNULL(MAX(plv.RenglonID),0) + 1,
				   @RenglonTipo = dbo.fnRenglonTipo(@ArtTipo)
			  FROM POSLVenta plv
			 INNER JOIN POSL p ON p.ID = plv.ID
			 WHERE plv.ID = @ID	         	
        
			IF @Juego = 1
				SELECT @RenglonTipo = 'C'

			SELECT @CantidadArticuloTotal = SUM(Cantidad)
			  FROM POSLVenta plv
			 INNER JOIN POSL p ON p.ID = plv.ID
			 WHERE plv.ID = @ID
			   AND plv.Articulo = @Articulo
			   AND ISNULL(plv.SubCuenta,'') = ISNULL(@SubCuenta,'')
			   AND plv.Unidad = @Unidad 

			IF @Accion = 'CANCELAR PARTIDA' AND @Ok IS NULL
			BEGIN
				IF @BanderaDP = 1 AND NOT EXISTS (SELECT * FROM POSLVenta WHERE ID = @IDDevolucionP AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND RenglonTipo <> 'C' )
				BEGIN
					SELECT @Ok = 50000
					RETURN
				END

				IF @BanderaDP = 1 AND ISNULL(@BasculaPesar,0) = 1 AND NULLIF(@Cantidad,0) IS NULL    
				BEGIN    
					SELECT @Cantidad = Cantidad FROM POSLVenta WHERE ID = @IDDevolucionP AND Articulo = @Articulo    
				END    
				
				IF @BanderaDP = 1 AND EXISTS (SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo = @Articulo) AND ISNULL(@BasculaPesar,0) = 1    
				BEGIN    
					SELECT @Ok = 50002    
					RETURN    
				END    
				
				IF @BanderaDP = 1 AND EXISTS (SELECT * FROM POSLVenta WHERE ID = @IDDevolucionP AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND RenglonTipo <> 'C' )
				BEGIN
					IF @BasculaPesar = 0
						SELECT @CantidadAd = 1
					ELSE
						SELECT @CantidadAd = 0.001
				
					SELECT @CantidadR = SUM(ISNULL(CantidadSaldo,0)) 
					  FROM POSLVenta 
					 WHERE ID = @IDDevolucionP 
					   AND Articulo = @Articulo
					   AND RenglonTipo <> 'C' 
									
					SELECT @CantidadRBis = SUM(ISNULL(Cantidad,0)*-1) + @Cantidad 
					  FROM POSLVenta 
					 WHERE ID = @ID 
					   AND Articulo = @Articulo 
					   AND RenglonTipo <> 'C' 
					
					IF @CantidadR < ISNULL(@CantidadRBis,@CantidadAd)    
					BEGIN
						SELECT @Ok = 50002
						RETURN
					END
				END

				IF @BanderaDP = 1 AND EXISTS (SELECT * FROM POSLVenta WHERE ID = @IDDevolucionP AND Articulo = @Articulo AND OfertaID IS NOT NULL)
					SELECT @MENSAJE = 'Articulo con Ofertas en su Venta Original'
					
					IF (SELECT TOP 1 EliminaRenglon FROM POSCancelarPartida WHERE ID = @ID) = 1 AND @BanderaDP = 0
						SELECT @Cantidad = @CantidadArticuloTotal
					
					SET @OfertaID = 0 
					
					SELECT @OfertaID = OfertaID  
					  FROM POSLVenta 
					 WHERE ID = @ID AND Articulo = @Articulo
					
					DELETE FROM POSCancelarPartida WHERE ID = @ID
					
					IF ISNULL((SELECT SUM(Cantidad) 
								 FROM POSLVenta plv
								WHERE plv.ID = @ID
								  AND plv.Articulo = @Articulo AND plv.Unidad = @Unidad
								  AND plv.RenglonTipo <> 'C' AND ISNULL(plv.SubCuenta,'') = ISNULL(@SubCuenta,'')),0) <= 0
								  AND ISNULL((SELECT SUM(Cantidad)
												FROM POSLVenta plv
											   WHERE plv.ID = @ID),0) > 0 
						SELECT @Ok = 10530, @OkRef = @Articulo
            
					IF(SELECT plv.RenglonTipo 
					     FROM POSLVenta plv 
						WHERE plv.ID = @ID AND plv.Articulo = @Articulo AND ISNULL(plv.SubCuenta,'') = ISNULL(@SubCuenta,'') 
						  AND plv.Unidad = @Unidad AND Renglon = @Renglon ) ='C'  
						SELECT @Ok = 10531, @OkRef = @Articulo 

					SELECT @Precio = ISNULL(Precio,0) 
					  FROM POSLVenta 
					 WHERE ID = @ID AND Articulo = @Articulo AND Unidad = @Unidad 
					   AND RenglonTipo <> 'C' 
					   AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')            
          
					IF @ArtTipo IN ('Serie', 'Lote') AND @Ok IS NULL
					BEGIN 
						IF ISNULL((SELECT SUM(Cantidad) 
								     FROM POSLVenta plv
									WHERE plv.ID = @ID
									  AND plv.Articulo = @Articulo
									  AND plv.Unidad = @Unidad 
									  AND ISNULL(plv.SubCuenta,'') = ISNULL(@SubCuenta,'')),0) < 0 
							SELECT @EsDevolucion = 1
					END 

					IF @Ok IS NULL
					BEGIN
						IF @ArtTipo IN ('Serie', 'Lote') 
						BEGIN 
							IF @EliminarSerieLote = 1
							BEGIN 
								IF @EsDevolucion = 0 
									SELECT @Cantidad = @Cantidad * (-1)
													
								IF @EsDevolucion = 1 
									SELECT @Cantidad = @Cantidad
							END
										  
							IF @EliminarSerieLote = 0
							BEGIN
								SELECT @Cantidad = @Cantidad * (-1)
							END
						END
						ELSE
						BEGIN
							IF ISNULL(@BasculaPesar,0) = 1
								SELECT @Cantidad = @CantidadArticuloTotal * (-1)
							ELSE 
							IF @ArtTipo IN ('Juego')
							BEGIN
								SELECT @Cantidad = @Cantidad * (-1)
										
								DELETE POSArtJuegoComponente WHERE Estacion = @Estacion
								EXEC spInsertarJuegoOmision @Empresa, @Sucursal, 0, @Articulo, @Cantidad, @Almacen, @FechaEmision, @Moneda, @TipoCambio, 
														    @Renglon, @RenglonID, NULL, 'POS', @ID, @Estacion	
                
								IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID 
																    AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') 
																	AND Unidad = @Unidad  AND RenglonTipo = 'J')
									SELECT @Renglon = MAX(Renglon) , 
										   @RenglonID = MAX(RenglonID)                  
									  FROM POSLVenta 
									 WHERE ID = @ID AND Articulo = @Articulo
									  AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')
									  AND Unidad = @Unidad 
									  AND RenglonTipo = 'J'               
                 
								UPDATE POSArtJuegoComponente SET EsDevolucion = 1 WHERE RID = @ID AND RenglonID = @RenglonID AND  Estacion = @Estacion  
        
								IF @JuegoComponentes = 0 AND EXISTS(SELECT * FROM ArtJuego WHERE Articulo = @Articulo AND Opcional = 1)
								BEGIN
									IF @JuegoComponentesCB = 1
									BEGIN
										UPDATE POSArtJuegoComponente SET ArtSubCuenta = null, Opcion = NULL, SubCuenta = NULL 
																   WHERE Opcional =1 
																     AND RID = @ID 
																	 AND RenglonID = @RenglonID 
																	 AND Estacion = @Estacion
											
										IF @@ERROR <> 0 SET @Ok = 1
										
										IF @Ok IS NULL
											SELECT @Expresion = 'FormaModal('+CHAR(39)+'POSArtJuegoComponente2'+CHAR(39)+')'
									END
									ELSE  
										SELECT @Expresion = 'FormaModal('+CHAR(39)+'POSArtJuegoComponente'+CHAR(39)+')'
								END
								ELSE
								BEGIN
									IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo = @Articulo)
									BEGIN
										SELECT @RenglonID = RenglonID 
										  FROM POSLVenta 
										 WHERE ID = @ID 
										   AND Articulo = @Articulo 
										   AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')
										   AND Unidad = @Unidad                  
									END 
									IF @BanderaDP = 0
										EXEC spPOSInsertarArtComponentes @Estacion, @ID, @Empresa, @Sucursal, @RenglonID, @Articulo, @Cantidad
								END  
							END
							ELSE
								SELECT @Cantidad = @Cantidad * (-1)
						END
					END

				IF @Ok IS NULL AND @BanderaDP = 0
					INSERT POSCancelacionArticulos(	ID,	 Empresa,  Sucursal,  Cajero,   Caja,  Articulo,  Precio, Fecha,		Cantidad)
					SELECT							@ID, @Empresa, @Sucursal, @Usuario, @Caja, @Articulo, @Precio, GETDATE(),	@Cantidad  
          
				IF ISNULL(@BasculaPesar,0) = 1 AND NULLIF(@Cantidad,0) IS NULL
					SELECT @Ok = 10100, @OkRef = 'Para hacer una devolución de un articulo que se pese deberá hacerse a través de Editar Detalle'
			END
  
			IF @CodigoAccion <> 'PESAR' --BUG 14248
			BEGIN 
				SELECT @CantidadArticuloTotal = ISNULL(@CantidadArticuloTotal,0) + ISNULL(@Cantidad,0)
				SELECT @Cantidad2 = @Cantidad / @Cantidad       
       	    END     
       	         
			IF ISNULL(@Juego,0) = 0
				EXEC spPOSArtPrecio @Articulo = @Articulo, @Cantidad = @CantidadArticuloTotal, @UnidadVenta = @Unidad, @Precio = @Precio OUTPUT, @Descuento = @DescuentoLinea OUTPUT, 
									@SubCuenta = @SubCuenta, @FechaEmision = @FechaEmision, @Agente = @Agente, @Moneda = @Moneda, @TipoCambio = @TipoCambio, @Condicion = @Condicion, 
									@Almacen = @Almacen, @Proyecto = @Proyecto, @FormaEnvio = @FormaEnvio, @Mov = @Mov, @Empresa = @Empresa, @Sucursal = @Sucursal, 
									@ListaPreciosEsp = @ListaPreciosEsp, @Cliente = @Cliente, @VentaID = @ID
			ELSE
				SELECT @Precio = 0
			
			SELECT @Precio = dbo.fnPOSPrecio(@Empresa, @Precio, @Impuesto1, @Impuesto2, @Impuesto3)        
			SELECT @PrecioCImp = dbo.fnPOSPrecioConImpuestos(@Precio, @Impuesto1, @Impuesto2, @Impuesto3, @Empresa)              
			SELECT @Precio = ROUND(@Precio,@RedondeoMonetarios), @PrecioCImp = ROUND(@PrecioCImp,@RedondeoMonetarios)	  
			SELECT @PrecioSugerido = CASE WHEN @CfgVentaPreciosImpuestoIncluido = 0 THEN @Precio ELSE @PrecioCImp END
        		 
			IF ISNULL(@Precio,0.00) = 0.00 AND ISNULL(@ArtTipo, '') != 'SERVICIO'
			BEGIN
				SELECT @Ok = 20305, @OkRef = 'ESTE ARTICULO NO SE PUEDE VENDER'
				RETURN
			END
        
			SELECT @DescuentoLinea = ROUND(@DescuentoLinea,@RedondeoMonetarios)	  
			SELECT @TipoCambio = ROUND(@TipoCambio,@RedondeoMonetarios)	  

			IF @TipoOpcion = 'Si' AND @SubCuenta IS NULL AND @MatrizOpciones = 1 AND EXISTS(SELECT * FROM ArtOpcion  WHERE Articulo = @Articulo) AND @Accion IS NULL  
			BEGIN
				SELECT @CodigoAccion = 'MATRIZ OPCIONES'  
				--IF @ArtPOSAgenteDetalleInfo IS NOT NULL
				--	IF NOT EXISTS (SELECT * FROM POSLVenta WITH (NOLOCK) WHERE ID = @ID AND ArtObservaciones = @ArtPOSAgenteDetalleInfo)
				--		INSERT POSLAccion (Host, Caja, Accion, Referencia) VALUES (@Host, @Caja, 'INSERTA AGENTE', @Accion)
			END
          
			IF @TipoOpcion = 'Si' AND @SubCuenta IS NULL AND @MatrizOpciones = 1 AND EXISTS(SELECT * FROM ArtOpcion  WHERE Articulo = @Articulo) AND @Accion = 'CANCELAR PARTIDA' 
				SELECT @CodigoAccion = 'MATRIZ OPCIONES NEGATIVA'                      

			IF @Ok IS NULL AND ISNULL(@CodigoAccion,'') NOT IN ('PESAR','MATRIZ OPCIONES','MATRIZ OPCIONES NEGATIVA'  )
			BEGIN
				IF EXISTS(SELECT * FROM POSLVenta plv 
								  WHERE plv.ID = @ID 
								    AND plv.Articulo = @Articulo AND ISNULL(plv.SubCuenta,'') = ISNULL(@SubCuenta,'')
									AND plv.RenglonTipo = @RenglonTipo 
									AND RenglonTipo <> 'C' 
									AND  Unidad = @Unidad 
									AND ISNULL(Aplicado,0) = 0)
									AND @AgruparArticulos = 1
				BEGIN
					UPDATE POSLVenta SET Cantidad = Cantidad + @Cantidad,
										 CantidadInventario = CantidadInventario + (@Cantidad*ISNULL(@UnidadFactor,1)),
										 Precio = CASE WHEN @CfgPrecioNivelUnidad = 0 THEN @Precio* (ABS(@Cantidad2)*ISNULL(@UnidadFactor,1))
										               ELSE @Precio* @Cantidad2 END,
										 PrecioSugerido = CASE WHEN @CfgPrecioNivelUnidad = 0 THEN @PrecioSugerido * (ABS(@Cantidad2)*ISNULL(@UnidadFactor,1))
										               ELSE @PrecioSugerido * @Cantidad2 END,
										 Impuesto1 =@Impuesto1,
										 Impuesto2 =@Impuesto2, 
										 Impuesto3 =@Impuesto3,
										 PrecioImpuestoInc = CASE WHEN @CfgPrecioNivelUnidad = 0 THEN @PrecioCImp * (ABS(@Cantidad2)*ISNULL(@UnidadFactor,1))
																  ELSE @PrecioCImp * @Cantidad2 END,
										 DescuentoLinea = ISNULL(NULLIF(@DescuentoLinea,0.0),DescuentoLinea),
										 ArtObservaciones = @ArtPOSAgenteDetalleInfo
					 WHERE ID = @ID 
					  AND Articulo = @Articulo 
					  AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')
					  AND RenglonTipo = @RenglonTipo 
					  AND Unidad = @Unidad AND RenglonTipo <> 'C' 
					  AND ISNULL(Aplicado,0)=0
				END
				ELSE
				BEGIN
					IF (@TipoOpcion = 'Si' AND ISNULL(@SubCuenta,'') <> '') OR @TipoOpcion <> 'Si'
						INSERT POSLVenta (ID,	Renglon,	RenglonID,	RenglonTipo,	Cantidad,	Articulo,	SubCuenta,	DescuentoLinea,		Impuesto1,	Impuesto2,	Impuesto3, 
										  Unidad,	Factor,			CantidadInventario,					LDIServicio,	Codigo,		Almacen,	ArtObservaciones, 
											Precio,
											PrecioSugerido, 
											PrecioImpuestoInc)
						VALUES			 (@ID,	@Renglon,	@RenglonID, @RenglonTipo,	@Cantidad,	@Articulo,	@SubCuenta, @DescuentoLinea,	@Impuesto1, @Impuesto2,	@Impuesto3,
										  @Unidad,	@UnidadFactor,	@Cantidad*ISNULL(@UnidadFactor,1),	@Servicio,		@CodigoArt, @Almacen,	@ArtPOSAgenteDetalleInfo,
											CASE WHEN @CfgPrecioNivelUnidad = 0 THEN @Precio*(ABS(@Cantidad2)*ISNULL(@UnidadFactor,1))
												 ELSE @Precio * @Cantidad2 END,
											CASE WHEN @CfgPrecioNivelUnidad = 0 THEN @PrecioSugerido *(ABS(@Cantidad2)*ISNULL(@UnidadFactor,1))
												 ELSE @PrecioSugerido * @Cantidad2 END,
											CASE WHEN @CfgPrecioNivelUnidad = 0 THEN @PrecioCImp*(ABS(@Cantidad2)*ISNULL(@UnidadFactor,1))
												 ELSE @PrecioCImp * @Cantidad2 END)

				END
			END
        
			IF @Ok IS NULL AND ISNULL(@CodigoAccion,'') IN ('MATRIZ OPCIONES')
			BEGIN
				SELECT @Expresion = 'POSMatrizOpciones( '+CHAR(39)+@ID+CHAR(39)+','+ CHAR(39)+@Articulo+CHAR(39)+','+CHAR(39)+@Codigo+CHAR(39)+','+' '+')'  
			END
			
			IF @Ok IS NULL AND ISNULL(@CodigoAccion,'') IN ('MATRIZ OPCIONES NEGATIVA' )
			BEGIN
				SELECT @Expresion = 'POSMatrizOpcionesCancelar( '+CHAR(39)+@ID+CHAR(39)+','+ CHAR(39)+@Articulo+CHAR(39)+','+ CHAR(39)+@Codigo+CHAR(39)+','+' '+')'  
			END        
			
			IF @Ok IS NULL AND @Accion NOT IN('DEVOLUCION TOTAL','REFERENCIAR VENTA', 'DEVOLUCION PARCIAL')AND @RenglonTipo NOT IN('C')
			BEGIN
				SELECT @TorretaMensaje1   = NombreCorto
				  FROM Art
				 WHERE Articulo = @Articulo  
							
				SELECT @TorretaMensaje2 ='PRECIO ' + dbo.fnFormatoMoneda(@Precio,@Empresa), @TorretaPosicion1 = 'Izquierda', @TorretaPosicion2 = 'Derecha'
			END
                    
			IF @AgruparArticulos = 0
			BEGIN
				UPDATE POSLVenta SET DescuentoLinea = ISNULL(@DescuentoLinea,DescuentoLinea) 
				 WHERE ID = @ID 
				   AND Articulo = @Articulo 
				   AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')
				   AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') 
				   AND Unidad = @Unidad 
			END
			
			IF @OFER = 1 AND @Ok IS NULL
			BEGIN
				EXEC spPOSOfertaAplicar	@ID
				EXEC spPOSOfertaPuntosInsertarTemp @ID, NULL, 1, @Estacion
			END
			ELSE
			IF @OFER = 0 AND @Monedero IS NOT NULL AND @CfgVentaMonederoA = 0
				EXEC spPOSVentaMonedero @Empresa, @ID, 'AFECTAR', @FechaEmision, @Usuario, @Sucursal, @Moneda, @TipoCambio, @Monedero, @Ok OUTPUT, @OkRef OUTPUT
			
			IF @ArtTipo IN ('Juego') AND @Accion NOT IN ('CANCELAR PARTIDA')
			BEGIN
				DELETE POSArtJuegoComponente WHERE Estacion = @Estacion
				EXEC spInsertarJuegoOmision @Empresa, @Sucursal, 0, @Articulo, @Cantidad, @Almacen, @FechaEmision, @Moneda, @TipoCambio, @Renglon, @RenglonID, NULL, 'POS', @ID, @Estacion	
          
				IF EXISTS (SELECT * FROM POSLVenta WHERE  ID = @ID AND Articulo = @Articulo  AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND Unidad = @Unidad  AND RenglonTipo = 'J')
					SELECT @Renglon = MAX(Renglon) , @RenglonID = MAX(RenglonID)
					  FROM POSLVenta 
					 WHERE ID = @ID AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND Unidad = @Unidad AND RenglonTipo = 'J'
             
				IF @JuegoComponentes = 0 AND EXISTS(SELECT * FROM ArtJuego WHERE Articulo = @Articulo AND Opcional = 1)
				BEGIN
					IF @JuegoComponentesCB = 1
					BEGIN
						UPDATE POSArtJuegoComponente SET ArtSubCuenta = null, Opcion = NULL, SubCuenta = NULL 
						 WHERE Opcional =1 
						   AND RID = @ID 
						   AND RenglonID = @RenglonID 
						   AND Estacion = @Estacion
					
						IF @@ERROR <> 0 SET @Ok = 1
											
						IF @Ok IS NULL
							SELECT @Expresion = 'FormaModal('+CHAR(39)+'POSArtJuegoComponente2'+CHAR(39)+')'
					END
					ELSE  
						SELECT @Expresion = 'FormaModal('+CHAR(39)+'POSArtJuegoComponente2'+CHAR(39)+')'
				END
				ELSE
				BEGIN
					IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND Unidad = @Unidad)
					BEGIN
						SELECT @RenglonID = RenglonID FROM POSLVenta WHERE ID = @ID AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND Unidad = @Unidad
					END  
					
					EXEC spPOSInsertarArtComponentes @Estacion, @ID, @Empresa, @Sucursal, @RenglonID, @Articulo, @Cantidad
				END  
			END  
		END	   
	END

	IF @BanderaDP = 1
	BEGIN
		IF @RenglonTipo = 'J'
			EXEC spPOSInsertarArtComponentes @Estacion, @ID, @Empresa, @Sucursal, @RenglonID, @Articulo, @Cantidad

		DECLARE crTST CURSOR LOCAL FOR			
		 SELECT Articulo, Renglon
		   FROM POSLventa 
		  WHERE ID = @ID
		    AND RenglonTipo <> 'C'
		   OPEN crTST
		FETCH NEXT FROM crTST INTO @ArticuloD, @RenglonD
		WHILE @@FETCH_STATUS <> -1 
		BEGIN
			IF @@FETCH_STATUS <> -2 
			BEGIN

				SELECT @CantidadD = SUM(Cantidad), 
					   @PrecioD = Precio,
					   @DescuentoLineaD = SUM(ISNULL(DescuentoLinea,0)), 
					   @Impuesto1D = Impuesto1, 
					   @Impuesto2D = Impuesto2, 
					   @Impuesto3D = Impuesto3, 
					   @PrecioImpuestoIncD = PrecioImpuestoInc, 
					   @CantidadObsequioD = SUM(ISNULL(CantidadObsequio,0)), 
					   @PrecioSugeridoD = PrecioSugerido, 
					   @PuntosD = SUM(ISNULL(Puntos,0)),
					   @CantidadInvD = SUM(ISNULL(CantidadInventario,0)) 
				  FROM POSLVenta 
				 WHERE ID = @IDDevolucionP 
				   AND Articulo = @ArticuloD
				   AND RenglonTipo <> 'C'
				 GROUP BY Precio, Impuesto1, Impuesto2, Impuesto3, PrecioImpuestoInc, PrecioSugerido

			IF @CantidadInvD = 0 
				SELECT @CantidadInvD = NULL
			
			SELECT @CantidadD = @CantidadD / @CantidadD
			SELECT @DescuentoLineaD = @DescuentoLineaD / @CantidadD, @PuntosD = @PuntosD  / @CantidadD,  @CantidadInvD = @CantidadInvD / @CantidadD  
			
			SELECT TOP 1 @Agente = Agente
			  FROM POSLVenta 
			 WHERE ID = @IDDevolucionP 
			   AND Articulo = @ArticuloD		
			
			UPDATE POSLVenta 
			   SET Precio = (((ISNULL(@PrecioD,0)*(1-(ISNULL(@DescuentoLineaD,0)/100))) * (ISNULL(@CantidadD,0) - ISNULL(@CantidadObsequioD,0)))/ISNULL(@CantidadD,0)),
			       DescuentoLinea = 0,
				   PrecioImpuestoInc = (((ISNULL(@PrecioImpuestoIncD,0)*(1-(ISNULL(@DescuentoLineaD,0)/100)))*(ISNULL(@CantidadD,0)-ISNULL(@CantidadObsequioD,0)))/ISNULL(@CantidadD,0)),
				   PrecioSugerido = (((ISNULL(@PrecioSugeridoD,0)*(1-(ISNULL(@DescuentoLineaD,0)/100)))*(ISNULL(@CantidadD,0) - ISNULL(@CantidadObsequioD,0)))/ISNULL(@CantidadD,0)),
				   OfertaID = @OfertaID,
				   @CantidadInvD = @CantidadInvD,
				   CantidadObsequio = NULL,
				   Puntos = @PuntosD,
				   OfertaIDG1 = NULL,
				   OfertaIDG2 = NULL,
				   OfertaIDG3 = NULL,
				   OfertaIDP1 = NULL,
				   OfertaIDP2 = NULL,
				   OfertaIDP3 = NULL,
				   DescuentoG1 = NULL,
				   DescuentoG2 = NULL,
				   DescuentoG3 = NULL,
				   DescuentoP1 = NULL,
				   DescuentoP2 = NULL,
				   DescuentoP3 = NULL,
				   Agente = @Agente
			 WHERE ID = @ID
			   AND Articulo = @ArticuloD
			   AND Renglon = @RenglonD
			   AND RenglonTipo <> 'C'
			END
		FETCH NEXT FROM crTST INTO @ArticuloD, @RenglonD
		END	 
		CLOSE crTST
		DEALLOCATE crTST

	END

	IF ISNULL(@Accion,'') ='DEVOLUCION TOTAL'
	BEGIN
		IF @POSDefMovDev IS NOT NULL 
			UPDATE POSL SET Mov = @POSDefMovDev WHERE ID = @ID
			
			UPDATE POSL SET IDDevolucion =  @Codigo WHERE ID = @ID
  
			UPDATE POSL 
			   SET Descuento = (SELECT Descuento FROM POSL WHERE ID = @Codigo), DescuentoGlobal = (SELECT DescuentoGlobal FROM POSL WHERE ID = @Codigo) 
			 WHERE ID = @ID
            
		IF (SELECT Ofertados FROM POSDevolucionTotal WHERE ID = @ID) = 1     
			INSERT POSLVenta (ID,	Renglon, RenglonID, RenglonTipo, Cantidad,											Articulo, SubCuenta, 
							Precio,																														
							DescuentoLinea,	Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, CantidadInventario, LDIServicio, 
							PrecioImpuestoInc,																														
							Codigo, Almacen, CantidadObsequio, OfertaID,	
							PrecioSugerido,																															
							Puntos, Agente)
			SELECT            @ID,	Renglon, RenglonID, RenglonTipo, ((ISNULL(Cantidad,0) + ISNULL(CantidadM,0))*-1),	Articulo, SubCuenta, 
							(((ISNULL(Precio,0)*(1-(ISNULL(DescuentoLinea,0)/100)))*(ISNULL(Cantidad,0)-ISNULL(CantidadObsequio,0)))/ISNULL(Cantidad,0)),	
							0,				Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, CantidadInventario, LDIServicio, 
							(((ISNULL(PrecioImpuestoInc,0)*(1-(ISNULL(DescuentoLinea,0)/100)))*(ISNULL(Cantidad,0)-ISNULL(CantidadObsequio,0)))/ISNULL(Cantidad,0)),	
							Codigo, Almacen, 0,				   NULL,		
							(((ISNULL(PrecioSugerido,0)*(1-(ISNULL(DescuentoLinea,0)/100)))*(ISNULL(Cantidad,0)-ISNULL(CantidadObsequio,0)))/ISNULL(Cantidad,0)),	
							Puntos, Agente
			  FROM POSLVenta 
			 WHERE ID = @Codigo  
			   AND Articulo NOT IN(@ArticuloRedondeo, NULL) 
			ELSE 
				INSERT POSLVenta (ID, Renglon, RenglonID, RenglonTipo, Cantidad,										Articulo, SubCuenta, Precio, 
								DescuentoLinea,	Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, CantidadInventario, LDIServicio, PrecioImpuestoInc, 
								Codigo, Almacen, CantidadObsequio, OfertaID, 
								PrecioSugerido, 
								Puntos, Agente)
				SELECT			 @ID, Renglon, RenglonID, RenglonTipo, ((ISNULL(Cantidad,0) + ISNULL(CantidadM,0))*-1),	Articulo, SubCuenta, (((ISNULL(Precio,0)*(1-(ISNULL(DescuentoLinea,0)/100)))*(ISNULL(Cantidad,0)-ISNULL(CantidadObsequio,0)))/ISNULL(Cantidad,0)),	
								0,				Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, CantidadInventario, LDIServicio, (((ISNULL(PrecioImpuestoInc,0)*(1-(ISNULL(DescuentoLinea,0)/100)))*(ISNULL(Cantidad,0)-ISNULL(CantidadObsequio,0)))/ISNULL(Cantidad,0)),	
								Codigo, Almacen, 0,					NULL, 
								(((ISNULL(PrecioSugerido,0)*(1-(ISNULL(DescuentoLinea,0)/100)))*(ISNULL(Cantidad,0)-ISNULL(CantidadObsequio,0)))/ISNULL(Cantidad,0)), 
								Puntos, Agente
			  FROM POSLVenta 
			 WHERE ID = @Codigo  
			   AND Articulo NOT IN(@ArticuloRedondeo, NULL) AND (DescuentoLinea IS NULL OR OfertaID IS NULL) 
     
		IF EXISTS(SELECT * FROM POSLSerieLote WHERE ID = @Codigo)
			INSERT POSLSerieLote(ID,  RenglonID, Articulo, SubCuenta,			 SerieLote)
			SELECT				 @ID, RenglonID, Articulo, ISNULL(SubCuenta,''), SerieLote
			  FROM POSLSerieLote 
			 WHERE ID = @Codigo
			 ORDER BY Orden              
     
		DELETE FROM POSDevolucionTotal WHERE ID = @ID      
	END
    
	IF ISNULL((SELECT SUM(Cantidad) FROM POSLVenta WHERE ID = @ID),0) < 0 AND @MovTipo NOT IN ('POS.N','POS.NPC','POS.INVD','POS.INVA')
		SELECT @ok = 10180, @okRef = 'Solamente las Notas se pueden utilizar como Devolución'
        	    
	IF @Ok IS NULL      
		EXEC xpPOSVentaInsertaArticulo @Codigo, @ID, @FechaEmision, @Agente, @Moneda, @TipoCambio, @Condicion, @Almacen, @Proyecto, @FormaEnvio, @Mov, @Empresa, @Sucursal, 
									   @ListaPreciosEsp, @Cliente, @CtaDinero, @Accion, @ArtDescripcion OUTPUT, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
  
	IF @Ok IS NULL
		EXEC spPOSLArtSeleccionado @ID, @Articulo, @SubCuenta, @Unidad, @CodigoArt
      
	IF @Ok IS NULL AND ISNULL(@Accion,'') NOT IN('DEVOLUCION TOTAL', 'DEVOLUCION PARCIAL') AND @BanderaDP = 0
		DELETE POSLValidarDevolucion WHERE ID = @ID
    
	IF @Ok IS NULL AND EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Cantidad = 0)
		DELETE POSLVenta WHERE ID = @ID AND Cantidad = 0   
    
	IF @Ok IS NULL   AND @Articulo IN(SELECT Articulo FROM POSLDIArtRecargaTel WHERE Servicio NOT IN ('IUSACELL','MOVISTAR','NEXTEL','TELCEL','UNEFON'))
	BEGIN
		SELECT @LDIForma = Forma FROM POSLDIArtRecargaTel WHERE Articulo = @Articulo
    
		IF @LDIForma IS NOT NULL
			SELECT @Expresion = 'FormaModal('+CHAR(39)+@LDIForma+CHAR(39)+')'
	END

	IF @POSAgenteDetalle = 1 AND @Accion NOT IN ('CANCELAR PARTIDA')
	BEGIN
		SET @POSValidaAgente =  0

		IF NULLIF(@ArtPOSAgenteDetalle,'') IS NOT NULL
			SET @POSValidaAgente =  1

		IF @POSAgenteDetalle = 1 AND @CodigoAccion = NULL 
		BEGIN
			IF (SELECT COUNT(ID) FROM POSLVenta WHERE ID = @ID AND ArtObservaciones = @ArtPOSAgenteDetalleInfo) > 1
					UPDATE POSLVenta SET Agente = (SELECT TOP 1 Agente FROM POSLVenta WHERE ID = @ID AND ArtObservaciones = @ArtPOSAgenteDetalleInfo)
					 WHERE ID = @ID AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') 
					   AND RenglonTipo = @RenglonTipo AND  Unidad = @Unidad AND RenglonTipo <> 'C' AND ISNULL(Aplicado,0)=0
		
			IF @POSValidaAgente = 1 AND (SELECT TOP 1 Agente FROM POSLVenta WHERE ID = @ID AND ArtObservaciones = @ArtPOSAgenteDetalleInfo) IS NULL
				SELECT @Expresion = 'Asigna(Info.Renglon,'+CONVERT(varchar, @Renglon)+') FormaModal('+CHAR(39)+'POSAgenteDetalle'+CHAR(39)+')'
		END

		IF EXISTS (SELECT * FROM POSLVenta WHERE ID = @ID AND ArtObservaciones = @ArtPOSAgenteDetalleInfo AND Articulo <> @Articulo) AND @CodigoAccion <> 'MATRIZ OPCIONES'
		BEGIN
			UPDATE POSLVenta SET Agente = (SELECT TOP 1 Agente FROM POSLVenta WHERE ID = @ID AND ArtObservaciones = @ArtPOSAgenteDetalleInfo AND Articulo <> @Articulo) WHERE ID = @ID AND Renglon = @Renglon
					
			SELECT @POSValidaAgente = 0

			IF @CodigoAccion = 'MATRIZ OPCIONES'
				DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja AND Accion = 'INSERTA AGENTE'
		END

		IF EXISTS (SELECT * FROM POSLVenta WHERE ID = @ID AND ArtObservaciones = @ArtPOSAgenteDetalleInfo) AND @CodigoAccion = 'MATRIZ OPCIONES'
		BEGIN
				UPDATE POSLVenta SET Agente = (SELECT TOP 1 Agente FROM POSLVenta WHERE ID = @ID AND ArtObservaciones = @ArtPOSAgenteDetalleInfo) WHERE ID = @ID AND Renglon = @Renglon
				
				SELECT @POSValidaAgente = 0

				IF @CodigoAccion = 'MATRIZ OPCIONES'
					DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja AND Accion = 'INSERTA AGENTE'

		END
	END


	IF @ArtTipo IN  ('Serie', 'Lote') AND (@MovTipo IN('POS.N','POS.F','POS.NPC')AND @MovSubClave <> 'POS.PEDCONT' ) 
	BEGIN
		IF @Accion NOT IN ('CANCELAR PARTIDA', 'DEVOLUCION TOTAL') AND @ArtTipo = 'Lote'
		BEGIN
			IF @SeriesLotesAutoOrden <> 'NO'
			BEGIN
				IF EXISTS (SELECT 1 FROM SerieLote WHERE Articulo = @Articulo AND ISNULL(Existencia,0) > 0 AND Sucursal = @Sucursal AND Almacen = @Almacen)
					INSERT POSLSerieLote(ID,  RenglonID,	Articulo,	SubCuenta,				SerieLote)
					SELECT TOP 1		@ID, p.RenglonID,	s.Articulo, NULLIF(s.SubCuenta,''), s.SerieLote
					  FROM SerieLote s JOIN POSLVenta p ON s.Articulo = p.Articulo AND ISNULL(s.SubCuenta,'') = ISNULL(p.SubCuenta,'')
					  JOIN CB ON cb.Cuenta = s.Articulo
					 WHERE cb.Codigo = @Codigo AND ISNULL(s.SubCuenta,'') = ISNULL(@SubCuenta,'')
					   AND s.Existencia > 0
					   AND p.ID = @ID
					   AND s.Sucursal = @Sucursal
					   AND s.Almacen = @Almacen
					 ORDER BY s.SerieLote
			END

			IF @SeriesLotesAutoOrden = 'NO' OR NOT EXISTS (SELECT 1 FROM SerieLote WHERE Articulo = @Articulo AND ISNULL(Existencia,0) > 0 AND Sucursal = @Sucursal AND Almacen = @Almacen)
			BEGIN
				IF @POSAgenteDetalle = 1
				BEGIN
					SELECT @Mensaje = 'POR FAVOR INGRESE EL NO. DE SERIE/LOTE, EL AGENTE LO DEBERÁ ASIGNAR EDITANDO EL DETALLE' --BUG 12742
					SET @Expresion = NULL
				END
				ELSE
					SELECT @Mensaje = 'POR FAVOR INGRESE EL NO. DE SERIE/LOTE'
				INSERT POSLAccion (Host, Caja, Accion, Referencia) VALUES (@Host, @Caja, 'SERIE/LOTE', @Accion)
			END
		END
	
		IF @Accion = 'CANCELAR PARTIDA'
		BEGIN
			IF @BanderaDP = 0
			BEGIN
				IF ABS(@Cantidad) = 1
				BEGIN
					IF @NoAfectarSerieLote = 0
						DELETE FROM POSLSerieLote 
						 WHERE Articulo = @Articulo 
						   AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') 
						   AND ID = @ID 
						   AND Orden = (SELECT MAX(Orden) FROM POSLSerieLote WHERE Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') )
				END
				IF ABS(@Cantidad) > 1
				BEGIN
					DELETE FROM POSLSerieLote WHERE Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND ID = @ID 
				END			
			END
			ELSE
			BEGIN
				IF @ArtTipo NOT IN ('Serie')
				BEGIN
				SELECT TOP 1 @SerieLoteDevP = SerieLote, @OrdenDevP = Orden 
				  FROM POSLSerieLote 
				 WHERE Articulo = @Articulo 
				   AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') 
				   AND ID = @IDDevolucionP
				   AND Orden NOT IN (SELECT OrdenDPRef FROM POSLSerieLote WITH (NOLOCK) WHERE ID = @ID) 
							
				INSERT POSLSerieLote(ID,  RenglonID, Articulo, SubCuenta,			 SerieLote,			OrdenDPRef)
				SELECT TOP 1		 @ID, RenglonID, Articulo, ISNULL(SubCuenta,''), @SerieLoteDevP,	@OrdenDevP  
				  FROM POSLVenta 
				 WHERE Articulo = @Articulo 
				   AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') 
				   AND ID = @ID 
			END
		END
	END
	END

	IF @ArtTipo IN  ('Serie') AND (@MovTipo IN('POS.N','POS.F','POS.NPC')AND @MovSubClave <> 'POS.PEDCONT' ) --AND (@MovTipo IN('POS.N','POS.F','POS.NPC')AND @MovSubClave <> 'POS.PEDCONT' ) 
	   AND @Accion NOT IN ('CANCELAR PARTIDA', 'DEVOLUCION TOTAL')
	BEGIN
		IF @POSAgenteDetalle = 1
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE EL NO. DE SERIE/LOTE, Ó BIEN LO DEBERÁ DE ASIGNAR EDITANDO EL DETALLE'
			SET @Expresion = NULL
		END
		ELSE
			SELECT @Mensaje = 'POR FAVOR INGRESE EL NO. DE SERIE/LOTE'

		INSERT POSLAccion (Host, Caja, Accion, Referencia) VALUES (@Host, @Caja, 'SERIE/LOTE', @Accion)
		
	END

	IF @ArtTipo IN  ('Serie') AND (@MovTipo IN('POS.N','POS.F','POS.NPC')AND @MovSubClave <> 'POS.PEDCONT' ) --AND (@MovTipo IN('POS.N','POS.F','POS.NPC')AND @MovSubClave <> 'POS.PEDCONT' ) 
	   AND @Accion IN ('CANCELAR PARTIDA') AND @BanderaDP = 1
	BEGIN
		IF @POSAgenteDetalle = 1
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE EL NO. DE SERIE/LOTE, Ó BIEN LO DEBERÁ DE ASIGNAR EDITANDO EL DETALLE'
			SET @Expresion = NULL
		END
		ELSE
			SELECT @Mensaje = 'POR FAVOR INGRESE EL NO. DE SERIE/LOTE'

		INSERT POSLAccion (Host, Caja, Accion, Referencia) VALUES (@Host, @Caja, 'SERIE/LOTE', @Accion)
		
	END

	IF @ArtTipo IN  ('Serie', 'Lote') AND (@MovTipo IN('POS.N','POS.F','POS.NPC')AND @MovSubClave <> 'POS.PEDCONT' ) AND EXISTS (SELECT 1 FROM ValeSerie WHERE Articulo = @Articulo)
	BEGIN
		IF @POSAgenteDetalle = 1
		BEGIN
			SELECT @Mensaje = 'POR FAVOR INGRESE EL NO. DE SERIE/LOTE, Ó BIEN LO DEBERÁ DE ASIGNAR EDITANDO EL DETALLE'
			SET @Expresion = NULL
		END
		ELSE
			SELECT @Mensaje = 'POR FAVOR INGRESE EL NO. DE SERIE/LOTE'

		INSERT POSLAccion (Host, Caja, Accion, Referencia) VALUES (@Host, @Caja, 'SERIE/LOTE', @Accion)

	END

	IF (SELECT ISNULL(DescuentoGlobal,0) FROM POSL WITH (NOLOCK) WHERE ID = @ID) > 0 
		UPDATE POSLVenta SET AplicaDescGlobal = 1 WHERE ID = @ID  
END  
GO


/************************ spPOSCancelarComponente *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSCancelarComponente') AND type = 'P') DROP PROCEDURE dbo.spPOSCancelarComponente
GO             
CREATE PROCEDURE spPOSCancelarComponente
	@RID			varchar(36), 
	@RenglonID		int,
	@Articulo       varchar(20),
	@Estacion       int
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@Cantidad   float
 
	SELECT @Cantidad = Cantidad 
	FROM POSArtJuegoComponente 
	WHERE Estacion = @Estacion AND RID = @RID AND RenglonID = @RenglonID AND Articulo = @Articulo
	
	DELETE POSArtJuegoComponente WHERE Estacion = @Estacion
 
	UPDATE POSLVenta SET Cantidad = Cantidad -ISNULL(@Cantidad,0.0) 
	WHERE ID = @RID AND Articulo = @Articulo AND RenglonID = @RenglonID AND RenglonTipo = 'J'
 
	DELETE POSLVenta WHERE ID = @RID AND Articulo = @Articulo AND RenglonID = @RenglonID AND RenglonTipo = 'J' AND ISNULL(Cantidad,0.0) = 0.0
END
GO


/************************ spPOSGeneraAbonoCaja *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSGeneraAbonoCaja') AND type = 'P') DROP PROCEDURE dbo.spPOSGeneraAbonoCaja
GO             
CREATE PROCEDURE spPOSGeneraAbonoCaja
	@Empresa		varchar(5), 
	@Sucursal		int, 
	@Usuario		varchar(10), 
	@ID				varchar(36), 
	@MovClave       varchar(20),
	@Ok				int				OUTPUT,
	@OkRef			varchar(255)    OUTPUT
--//WITH ENCRYPTION	  
AS 
BEGIN
	DECLARE
	@IDGenerar     varchar(36),
	@Mov           varchar(20),
	@Caja          varchar(20)
  
  IF @MovClave IN('POS.TCM','POS.CTCM')
	BEGIN
	    IF @MovClave = 'POS.TCM'
			SELECT TOP 1 @Mov = Mov FROM MovTipo WHERE Modulo = 'POS' AND Clave = 'POS.TCAC'
		
		IF @MovClave = 'POS.CTCM'
			SELECT TOP 1 @Mov = Mov FROM MovTipo WHERE Modulo = 'POS' AND Clave = 'POS.CTCAC'
      
		SELECT @Caja = CtaDineroDestino
		FROM POSL WHERE ID = @ID      
     
		SELECT @IDGenerar = NEWID()
		INSERT POSL(
			ID, Host, Empresa, Modulo, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, 
			Observaciones, Estatus, Cliente, Nombre, Direccion, DireccionNumero, DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, 
			Estado, Pais, Zona, CodigoPostal, RFC, CURP, EnviarA, Almacen, Agente, Cajero, FormaEnvio, Condicion, Vencimiento, CtaDinero, 
			CtaDineroDestino, Descuento, DescuentoGlobal, Importe, Impuestos, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, 
			Sucursal, OrigenTipo, Origen, OrigenID, Tasa, Prefijo, Consecutivo, noAprobacion, fechaAprobacion, CadenaOriginal, Sello, Certificado, 
			DocumentoXML, FechaCancelacion, FechaEntrega, FechaSello, UsuarioAutoriza, IDR, Monedero, Cluster, Caja, FechaNacimiento, EstadoCivil, 
			Conyuge, Sexo, Fuma, Profesion, Puesto, NumeroHijos, Religion)
		SELECT      
			@IDGenerar, Host, Empresa, Modulo, @Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, 
			Observaciones, 'CONCLUIDO', Cliente, Nombre, Direccion, DireccionNumero, DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, 
			Estado, Pais, Zona, CodigoPostal, RFC, CURP, EnviarA, Almacen, Agente, Cajero, FormaEnvio, Condicion, Vencimiento, CtaDineroDestino, 
			CtaDinero, Descuento, DescuentoGlobal, Importe, Impuestos, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, 
			Sucursal, OrigenTipo, Origen, OrigenID, Tasa, Prefijo, Consecutivo, noAprobacion, fechaAprobacion, CadenaOriginal, Sello, Certificado, 
			DocumentoXML, FechaCancelacion, FechaEntrega, FechaSello, UsuarioAutoriza, @ID, Monedero, Cluster, CtaDineroDestino, FechaNacimiento, EstadoCivil, 
			Conyuge, Sexo, Fuma, Profesion, Puesto, NumeroHijos, Religion
		FROM POSL 
		WHERE ID = @ID 
    
		IF @@ERROR <> 0 
			SET @Ok = 1  
    
		IF @Ok IS NULL
			INSERT POSLCobro(
				ID, FormaPago, Importe, Referencia, Monedero, CtaDinero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio, Voucher, Banco, 
				MonedaRef, CtaDineroDestino)
			SELECT
				@IDGenerar, FormaPago, Importe, Referencia, Monedero, CtaDineroDestino, Fecha, @Caja,  Cajero, Host, ImporteRef, TipoCambio, Voucher, Banco, 
				MonedaRef, CtaDinero
			FROM POSLCobro 
			WHERE ID = @ID 
     
		IF @@ERROR <> 0 
			SET @Ok = 1       
	END  
END
GO


/************************ spPOSGeneraRetiroCaja *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSGeneraRetiroCaja') AND type = 'P') DROP PROCEDURE dbo.spPOSGeneraRetiroCaja
GO             
CREATE PROCEDURE spPOSGeneraRetiroCaja
	@Empresa		varchar(5), 
	@Sucursal		int, 
	@Usuario		varchar(10), 
	@ID				varchar(36), 
	@MovClave       varchar(20),
	@Ok				int				OUTPUT,
	@OkRef			varchar(255)    OUTPUT
--//WITH ENCRYPTION	     	  
AS 
BEGIN
	DECLARE
	@IDGenerar     varchar(36),
	@Mov           varchar(20),
	@Caja          varchar(20)
  
	IF @MovClave IN('POS.TRM','POS.CTRM')
		BEGIN
			IF @MovClave = 'POS.TRM'
				SELECT TOP 1 @Mov = Mov FROM MovTipo WHERE Modulo = 'POS' AND Clave = 'POS.TCRC'
    
			IF @MovClave = 'POS.CTRM'
				SELECT TOP 1 @Mov = Mov FROM MovTipo WHERE Modulo = 'POS' AND Clave = 'POS.CTCRC'     
    
			SELECT @Caja = CtaDineroDestino 
			FROM POSL 
			WHERE ID = @ID 
			
			SELECT @IDGenerar = NEWID()
			INSERT POSL(
				ID, Host, Empresa, Modulo, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, 
				Observaciones, Estatus, Cliente, Nombre, Direccion, DireccionNumero, DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, 
				Estado, Pais, Zona, CodigoPostal, RFC, CURP, EnviarA, Almacen, Agente, Cajero, FormaEnvio, Condicion, Vencimiento, CtaDinero, 
				CtaDineroDestino, Descuento, DescuentoGlobal, Importe, Impuestos, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, 
				Sucursal, OrigenTipo, Origen, OrigenID, Tasa, Prefijo, Consecutivo, noAprobacion, fechaAprobacion, CadenaOriginal, Sello, Certificado, 
				DocumentoXML, FechaCancelacion, FechaEntrega, FechaSello, UsuarioAutoriza, IDR, Monedero, Cluster, Caja, FechaNacimiento, EstadoCivil, 
				Conyuge, Sexo, Fuma, Profesion, Puesto, NumeroHijos, Religion)
			SELECT      
				@IDGenerar, Host, Empresa, Modulo, @Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, 
				Observaciones, 'CONCLUIDO', Cliente, Nombre, Direccion, DireccionNumero, DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, 
				Estado, Pais, Zona, CodigoPostal, RFC, CURP, EnviarA, Almacen, Agente, Cajero, FormaEnvio, Condicion, Vencimiento, CtaDineroDestino, 
				CtaDinero, Descuento, DescuentoGlobal, Importe, Impuestos, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, 
				Sucursal, OrigenTipo, Origen, OrigenID, Tasa, Prefijo, Consecutivo, noAprobacion, fechaAprobacion, CadenaOriginal, Sello, Certificado, 
				DocumentoXML, FechaCancelacion, FechaEntrega, FechaSello, UsuarioAutoriza, @ID, Monedero, Cluster, CtaDineroDestino, FechaNacimiento, EstadoCivil, 
				Conyuge, Sexo, Fuma, Profesion, Puesto, NumeroHijos, Religion
			FROM POSL 
			WHERE ID = @ID 
			
			IF @@ERROR <> 0 
				SET @Ok = 1  
    
			IF @Ok IS NULL
				INSERT POSLCobro(
					ID, FormaPago, Importe, Referencia, Monedero, CtaDinero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio, Voucher, Banco, 
					MonedaRef, CtaDineroDestino)
				SELECT
					@IDGenerar, FormaPago, Importe, Referencia, Monedero, CtaDineroDestino, Fecha, @Caja, Cajero, Host, ImporteRef, TipoCambio, Voucher, Banco, 
					MonedaRef, CtaDinero
				FROM POSLCobro 
				WHERE ID = @ID 
     
			IF @@ERROR <> 0 
				SET @Ok = 1       
		END  
END
GO


/************************ spPOSTraspasarPorCobrar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSTraspasarPorCobrar') AND type = 'P') DROP PROCEDURE dbo.spPOSTraspasarPorCobrar
GO             
CREATE PROCEDURE spPOSTraspasarPorCobrar
	@Empresa		varchar(5), 
	@Modulo			varchar(5), 
	@Sucursal		int, 
	@Usuario		varchar(10), 
	@Saldo			float,
	@Estacion       int,
	@ID				varchar(50)		OUTPUT, 
	@Mensaje		varchar(255)	OUTPUT, 
	@Imagen			varchar(255)	OUTPUT,
	@Expresion		varchar(255)	OUTPUT, 
	@IDImprimir		varchar(36)     OUTPUT,
	@Ok				int				OUTPUT, 
	@OkRef			varchar(255)	OUTPUT
--//WITH ENCRYPTION	     
AS 
BEGIN	     
	DECLARE 
	@IDM					varchar(50),
	@ToleranciaRedondeo		float,	  
	@Mov					varchar(20),
	@MovID					varchar(20),
	@MovClave				varchar(20),
	@Caja					varchar(10),	  	  
	@ImporteMov				float,	  	  
	@CobradoMov				float,
	@ReporteImpresora		varchar(50),
	@Prefijo				varchar(5),
	@Consecutivo			int,
	@noAprobacion			int,
	@fechaAprobacion		datetime,
	@Host					varchar(20),
	@Cluster				varchar(20),
	@RedondeoMonetarios		int,
	@Checksum               bigint
	  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)		  
  
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
   
	SELECT 
		@Mov = p.Mov,
		@MovID = p.MovID,
		@MovClave = mt.Clave,
		@Caja = p.CtaDinero
    FROM POSL p
	INNER JOIN Sucursal s ON p.Sucursal = s.Sucursal
	INNER JOIN MovTipo mt ON p.Mov = mt.Mov
    AND mt.Modulo = 'POS'
	WHERE p.ID = @ID
  
	SELECT @IDImprimir = @ID
    
	SELECT @ImporteMov = SUM(dbo.fnPOSImporteMov(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * ((plv.Precio - 
	(plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * (
		CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 
				THEN ISNULL(p.DescuentoGlobal,0.0) 
			 ELSE 0 
			 END)/100))),plv.Impuesto1,plv.Impuesto2,plv.Impuesto3,plv.Cantidad))
    FROM POSLVenta plv 
	INNER JOIN POSL p ON p.ID = plv.ID
	WHERE plv.ID = @ID
  
	SELECT @CobradoMov = SUM(ISNULL(Importe,0))
    FROM POSLCobro plc 
	WHERE plc.ID = @ID
   
	SELECT @ImporteMov = ROUND(@ImporteMov,@RedondeoMonetarios)	   
	SELECT @CobradoMov = ROUND(@ImporteMov,@RedondeoMonetarios)	   
   
	IF @MovClave NOT IN ('POS.NPC') OR ISNULL(@ImporteMov,0) <= 0
		SELECT @Ok = 30100
  
	IF @Ok IS NULL
		BEGIN
			IF @MovID IS NULL
				BEGIN
					EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @Mov, 
						@MovID OUTPUT, @Prefijo OUTPUT, @Consecutivo OUTPUT, @noAprobacion OUTPUT, @FechaAprobacion OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
				END  
      
			UPDATE POSL SET 
				MovID = ISNULL(MovID, @MovID),
				Prefijo = ISNULL(Prefijo, @Prefijo),
				Consecutivo = ISNULL(Consecutivo, @Consecutivo),
				noAprobacion = ISNULL(noAprobacion, @noAprobacion),
				fechaAprobacion = ISNULL(fechaAprobacion, @fechaAprobacion),
				Estatus = 'PORCOBRAR'
			WHERE ID = @ID
     
			IF @@ERROR <> 0 
				SET @Ok = 1
      
			DELETE POSLValidarDevolucion WHERE ID = @ID
		END
     
	IF @Ok IS NULL
		BEGIN
			INSERT POSLPorCobrar(
				ID, Empresa, Modulo, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Referencia, 
				Observaciones, Estatus, Cliente, Nombre, Direccion, DireccionNumero, DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, 
				Estado, Pais, Zona, CodigoPostal, RFC, CURP, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CajaOrigen, CtaDinero, Descuento, 
				DescuentoGlobal, Importe, Impuestos, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, Origen, OrigenID, 
				Tasa, Prefijo, Consecutivo, IDR, Monedero, BeneficiarioNombre, IDCB, Directo)
			SELECT 
				ID, Empresa, Modulo, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Referencia, 
				Observaciones, Estatus, Cliente, Nombre, Direccion, DireccionNumero, DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, 
				Estado, Pais, Zona, CodigoPostal, RFC, CURP, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, CtaDinero, Descuento, 
				DescuentoGlobal, Importe, Impuestos, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, Origen, OrigenID, 
				Tasa, Prefijo, Consecutivo,  IDR, Monedero, BeneficiarioNombre,dbo.fnPOSCBGenerar(ID), ISNULL(Directo,1)
			FROM POSL 
			WHERE ID = @ID
    
			IF @@ERROR <> 0 
				SET @Ok = 1
    
			IF @Ok IS NULL
				INSERT POSLPorCobrarD(
					ID, Renglon, RenglonSub, RenglonID, RenglonTipo, Aplica, AplicaID, Cantidad, Articulo, SubCuenta, Precio, PrecioSugerido, 
					DescuentoLinea, DescuentoImporte, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, CantidadInventario, Puntos, Comision, CantidadObsequio, 
					OfertaID, SerieLote, LDIServicio, Juego, Aplicado, PrecioImpuestoInc, AplicaDescGlobal, Codigo, Almacen)
				SELECT
					ID, Renglon, RenglonSub, RenglonID, RenglonTipo, Aplica, AplicaID, Cantidad, Articulo, SubCuenta, Precio, PrecioSugerido, 
					DescuentoLinea, DescuentoImporte, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, CantidadInventario, Puntos, Comision, CantidadObsequio, 
					OfertaID, SerieLote, LDIServicio, Juego, Aplicado, PrecioImpuestoInc, AplicaDescGlobal, Codigo, Almacen
				FROM POSLVenta 
				WHERE ID = @ID
    
			IF @@ERROR <> 0 
				SET @Ok = 1    
    
			IF @Ok IS NULL AND EXISTS(SELECT * FROM POSLSerieLote WHERE ID = @ID)
				INSERT POSLPorCobrarSerieLote(
					ID, RenglonID, Articulo, SubCuenta, SerieLote)
				SELECT 
					ID, RenglonID, Articulo, ISNULL(SubCuenta,''), SerieLote
				FROM POSLSerieLote 
				WHERE ID = @ID
    
			IF @@ERROR <> 0 
				SET @Ok = 1       
        
			IF @Ok IS NULL
				UPDATE POSLPorCobrarD SET DCheckSum = dbo.fnPOSCheckSumDetalle(@ID, Renglon)
				WHERE ID = @ID
    
			IF @@ERROR <> 0 
				SET @Ok = 1
      
			SELECT @Checksum = ISNULL(SUM(CONVERT(bigint,DCheckSum)),0) 
			FROM POSLPorCobrarD 
			WHERE ID = @ID
    
			IF @Ok IS NULL  
				UPDATE POSLPorCobrar SET ECheckSum = dbo.fnPOSCheckSumEncabezado(@ID), DCheckSum = @Checksum
				WHERE ID = @ID
    
			IF @@ERROR <> 0 
				SET @Ok = 1  
    
			IF @Ok IS NULL AND EXISTS(SELECT * FROM POSLPorCobrarSerieLote WHERE ID = @ID)
				UPDATE POSLPorCobrarSerieLote SET SCheckSum = dbo.fnPOSCheckSumSerie(@ID,IDL)
				WHERE ID = @ID
    
			IF @@ERROR <> 0 SET @Ok = 1
		END

    IF @Ok IS NULL
		BEGIN    
			EXEC spPOSMovNuevo @Empresa, @Modulo, @Sucursal, @Usuario, @Estacion, @ID OUTPUT, @Imagen OUTPUT
			
			DELETE FROM POSLAccion 
			WHERE Host = @Host AND Caja = @Caja
			
			SELECT @Mensaje = 'EL MOVIMIENTO SE TRASPASO CORRECTAMENTE'
		END  
END  
GO


/************************ spPOSAmortizacionPagos *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAmortizacionPagos') AND type = 'P') DROP PROCEDURE dbo.spPOSAmortizacionPagos
GO             
CREATE PROCEDURE spPOSAmortizacionPagos
	@ID				varchar(36),
	@Condicion		varchar(50),
	@Ok				int				OUTPUT,
	@OkRef			varchar(255)	OUTPUT,
	@Refrescar		bit = 0
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE
	@AnticipadoNumero		int,
	@AnticipadoPeriodo		varchar(15),
	@Tasa					varchar(50),
	@Dias					int,
	@Porcentaje				float,
	@PorcentajePeriodo		float,
	@Estatus				varchar(15),
	@MovClave				varchar(20),
	@Mov					varchar(20),
	@ImporteTotal			float,
	@FechaEmision			datetime,
	@FechaAmortizada		datetime,
	@ImporteAmortizado		float,
	@NumeroAmortizacion		int,
	@DiasAmortizacion		int,
	@RedondeoMonetarios		int,
	@Empresa                varchar(5),
	@ControlAnticipos       varchar(20)	  	    
	 
	SELECT 
		@Estatus = ISNULL(pl.Estatus, 'SINAFECTAR'),
		@MovClave = mt.Clave,
		@Mov = pl.Mov,
		@FechaEmision = pl.FechaEmision,
		@Empresa = pl.Empresa
    FROM POSL pl 
	INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS'
	WHERE pl.ID = @ID
  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)	  

	IF @Condicion IS NULL AND @Refrescar = 1
		SELECT @Condicion = pl.Condicion
		FROM POSL pl
		WHERE pl.ID = @ID
  
	IF NULLIF(@Condicion,'') IS NOT NULL
		BEGIN
			IF (UPPER(@Condicion) NOT IN(SELECT UPPER(Condicion) FROM POSMovCondicion c WHERE c.Mov = @Mov) AND @Ok IS NULL)
				BEGIN
					SELECT @ok = 20700, @OkRef = @Condicion
				END
    
			SELECT 
				@AnticipadoNumero = c.AnticipadoNumero,
				@AnticipadoPeriodo = c.AnticipadoPeriodo,
				@Tasa = c.Tasa,
				@ControlAnticipos = ControlAnticipos
			FROM Condicion c
			WHERE c.Condicion = @Condicion
   
			IF @ControlAnticipos = 'Plazos'
				BEGIN
					IF (NULLIF(@AnticipadoNumero,0) IS NULL OR NULLIF(@AnticipadoPeriodo,'') IS NULL) AND @Ok IS NULL AND @Condicion IS NOT NULL
						SELECT @ok = 20700, @OkRef = @Condicion 
				END  
		END
  
	IF @Tasa IS NOT NULL
		BEGIN
			IF (SELECT Tasa FROM POSL pl WHERE pl.ID = @ID) IS NOT NULL
				SELECT @Tasa = p.Tasa
				FROM POSL p
				WHERE p.ID = @ID
      
			SELECT 
				@Dias = t.Dias,
				@Porcentaje = t.Porcentaje
			FROM Tasa t
			WHERE t.Tasa = @Tasa
		END
  
	IF ISNULL(@Estatus, '') <> 'SINAFECTAR' AND @Ok IS NULL AND @Condicion IS NOT NULL AND @Refrescar = 0
		SELECT @Ok = 10015, @OkRef = 'El movimiento no puede estar afectado'
  
	IF ISNULL((SELECT SUM(Importe) FROM POSLCobro plc WHERE plc.ID = @ID),0) <> 0 AND @Ok IS NULL AND @Condicion IS NOT NULL AND @Refrescar = 0
		SELECT @Ok = 20180, @OkRef = 'El movimiento no puede tener cobros aplicados'
  
	IF @Ok IS NULL AND @Condicion IS NOT NULL
		BEGIN
			UPDATE POSL 
			SET Condicion = @Condicion, Tasa = @Tasa
			WHERE ID = @ID
     
			--Eliminar cualquier amortización anterior
			DELETE POSLAmortizacionPagos 
			WHERE ID = @ID
    
			SELECT @ImporteTotal = SUM(((plv.Cantidad - ISNULL(plv.CantidadObsequio,0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0)/100))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0)/100))) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100)) * (1 + ((ISNULL(plv.Impuesto1,0)/100)+(ISNULL(plv.Impuesto2,0)/100))))   ) 
			FROM POSLVenta plv 
			INNER JOIN POSL p ON p.ID = plv.ID
			WHERE plv.ID = @ID
    
			SELECT @DiasAmortizacion = 
				CASE @AnticipadoPeriodo 
					WHEN 'Semanal' THEN 7
                    WHEN 'Quincenal' THEN 15
                    WHEN 'Mensual' THEN 30
                    WHEN 'Bimestral' THEN 60
                    WHEN 'Trimestral' THEN 90
                    WHEN 'Semestral' THEN 180
                    WHEN 'Anual' THEN 365
                    ELSE 1
					END
    
			SELECT @NumeroAmortizacion = 1,
				@FechaAmortizada = @FechaEmision + @DiasAmortizacion,
    			@ImporteAmortizado = @ImporteTotal / @AnticipadoNumero
    
			SELECT @ImporteAmortizado = ROUND(@ImporteAmortizado,@RedondeoMonetarios)	   

			IF @Porcentaje IS NOT NULL AND @Dias IS NOT NULL
				SELECT @PorcentajePeriodo = (@Porcentaje / @Dias) * @DiasAmortizacion
    	   
			WHILE @NumeroAmortizacion <= @AnticipadoNumero
				BEGIN
					INSERT POSLAmortizacionPagos (
						ID, Fecha, Importe,	Interes)
                    VALUES (
						@ID, @FechaAmortizada, @ImporteAmortizado, @PorcentajePeriodo)
      
					SELECT @FechaAmortizada = @FechaAmortizada + @DiasAmortizacion
					SELECT @NumeroAmortizacion = @NumeroAmortizacion + 1
				END
		END
END
GO


/************************ spPOSMovCobrar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSMovCobrar') AND type = 'P') DROP PROCEDURE dbo.spPOSMovCobrar
GO             
CREATE PROCEDURE spPOSMovCobrar
	@Empresa				varchar(5),
	@Sucursal				int,
	@Usuario				varchar(10),
	@ID						varchar(50),
	@Codigo					varchar(50),
	@Referencia				varchar(50),
	@CtaDinero				varchar(10),
	@ToleranciaRedondeo		float,
	@MovClave				varchar(20),
	@Monedero				varchar(20),
	@ImporteRef				float,
	@CodigoAccion			varchar(50)		OUTPUT,
	@Importe				float			OUTPUT, 
	@Saldo					float			OUTPUT,
	@Ok						int				OUTPUT,
	@OkRef					varchar(255)	OUTPUT,
	@Cambio					bit	= 0,
	@RIDCobro				int				OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@FormaPago						varchar(50),
	@RequiereReferencia				bit,
	@PermiteCambio					bit,
	@FormaPagoSaldoAFavor			varchar(50),  
	@FormaPagoMoneda				varchar(20),
	@FormaPagoTipoCambio			float,	
	@ImporteEnCaja					float,
	@ImporteEnMovimiento			float,
	@Mov							varchar(20),
	@MovID							varchar(20),
	@Prefijo						varchar(5),
	@Consecutivo					int,
	@noAprobacion					int,
	@fechaAprobacion				datetime,
	@Fecha							datetime,
	@Caja							varchar(10),
	@CtaDineroDestino				varchar(10),
	@Cajero							varchar(10),
	@Abierto						bit,
	@Voucher						varchar(MAX),
	@Banco							varchar(255),   
	@Host							varchar(20),
	@Cluster						varchar(20),
	@MonedaPrincipal				varchar(10),
	@MonedaMov    					varchar(10),
	@RedondeoMonetarios				int,
	@ArticuloOfertaFP				varchar(20),
	@ImporteMov						float,
	@Descuento						float,
	@ImporteOfer					float,
	@Renglon						float,
	@ArtTipo						varchar(50),
	@RenglonTipo					varchar(1),
	@RenglonID						int,
	@FormaPagoOfer					varchar(50),
	@PrecioOfer						float,
	@Unidad							varchar(50),
	@ArticuloRedondeo				varchar(20),
	@CodigoRedondeo					varchar(50),
	@Hora							int,
    @Minutos						int,
    @HoraMinutos					int,
    @MonederoMoneda					varchar(10),
    @MonederoTipoCambio				float,
    @ImporteMonedero				float,
    @SevicioLDI						varchar(20),
    @LDI							bit,
    @ImporteRedondeo				float,
    @DImporte						float,
    @ImporteDescuento				float,
    @DImpuesto1						float, 
    @DImpuesto2						float, 
    @DImpuesto3						float,
    @CfgAnticipoArticuloServicio	varchar(20),
    @POSMonedaAct					bit,
    @Comision3						float,
    @Comision3Porcentaje			float,
    @CImporte		                float
           
	SELECT @POSMonedaAct = POSMonedaAct 
	FROM POSCfg 
	WHERE Empresa = @Empresa          
	
	SELECT @CfgAnticipoArticuloServicio = NULLIF(CxcAnticipoArticuloServicio,'')    
	FROM EmpresaCfg2
    WHERE Empresa = @Empresa
	
	IF NULLIF(@MovClave,'') IS NULL
		SELECT @MovClave = mt.Clave 
		  FROM POSL p
		  JOIN Movtipo mt ON p.Mov = mt.Mov and mt.Modulo = 'POS'
		 WHERE p.ID = @ID 
	
	SELECT @Fecha = GETDATE()
	SELECT @Hora = DATEPART(HOUR,@Fecha)
	SELECT @Minutos= DATEPART(MINUTE,@Fecha)
	SELECT @HoraMinutos = (@Hora*60)+@Minutos

	IF @MovClave IN ('POS.ACM', 'POS.CCM', 'POS.CPCM', 'POS.TCM', 'POS.TRM') AND @Importe < 1.00
	BEGIN
		SELECT @Ok = 30100, @OkRef = 'EL IMPORTE NO PUEDE SER MENOR A 1 PARA LA FORMA DE PAGO SELECCIONADA'
		RETURN
	END
	
  
	IF @Monedero IS NOT NULL
		BEGIN
			SELECT @MonederoMoneda = Moneda 
			FROM POSValeSerie 
			WHERE Serie = @Monedero
			
			SELECT @MonederoTipoCambio = ISNULL(TipoCambio,1.0)  
			FROM POSLTipoCambioRef 
			WHERE Moneda = @MonederoMoneda AND Sucursal = @Sucursal
     
			IF NOT EXISTS(SELECT TipoCambio FROM POSLTipoCambioRef WHERE Moneda = @MonederoMoneda AND Sucursal = @Sucursal)
				SELECT @Ok =  20196, @OkRef = @MonederoMoneda
    
			IF NULLIF(@MonederoMoneda ,'') IS NULL
				SELECT @Ok = 30050 , @OkRef = @Monedero
	  
		END

	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)	
	    
	SELECT TOP 1 @MonedaPrincipal = Moneda 
    FROM POSLTipoCambioRef 
	WHERE TipoCambio = 1	  
	AND Sucursal = @Sucursal AND EsPrincipal = 1
  
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
  
	SELECT 
		@Caja = Caja,
		@Cajero = Cajero,
		@CtaDineroDestino=CtaDineroDestino
    FROM POSL
	WHERE ID = @ID
  
	IF @MovClave NOT IN ('POS.AC','POS.ACM','POS.CAC','POS.CACM','POS.IC','POS.EC','POS.AP')
		SELECT TOP 1 
			@Caja = pec.Caja,
  	        @Cajero = pec.Cajero
		FROM POSEstatusCaja  pec
		WHERE Usuario = @Usuario
		AND Abierto = 1
  
	SELECT @Fecha = dbo.fnFechaSinHora(GETDATE())
    	  
	SELECT 
		@FormaPago = cb.FormaPago,
		@RequiereReferencia = fp.RequiereReferencia,
		@PermiteCambio = fp.PermiteCambio
    FROM CB
	INNER JOIN FormaPago fp ON CB.FormaPago = fp.FormaPago
	WHERE Codigo = @Codigo

	IF @MovClave IN ('POS.N', 'POS.F')
	BEGIN
		IF (SELECT COUNT(DISTINCT FormaPago) FROM POSLCobro WITH (NOLOCK) WHERE ID = @ID ) >=5
		BEGIN
			IF @FormaPago NOT IN (SELECT DISTINCT FormaPago FROM POSLCobro with (NOLOCK) WHERE ID = @ID )
			BEGIN
				SELECT @Ok = 10060, @OkRef = 'NO PUEDE INGRESAR MAS DE 5 DIFERENTES FORMAS PAGO'
				RETURN
			END
		END
	END

	IF @MovClave IN ('POS.N', 'POS.F', 'POS.A','POS.P','POS.NPC','POS.INVD', 'POS.INVA','POS.FA','POS.CXCD', 'POS.CXCC')
		BEGIN
			EXEC spPOSEstatusCajaVerificar @ID, @Caja, @Cajero,'Abierto' , @Abierto OUTPUT
		
			IF @Abierto = 0
				SELECT @Ok = 30440, @okRef = @Caja
		END
  
	SELECT @FormaPagoSaldoAFavor = pc.FormaPagoSaldoAFavor, @ArticuloOfertaFP = pc.ArtOfertaFP, @CodigoRedondeo = pc.RedondeoVentaCodigo,@LDI = MonederoLDI
    FROM POSCfg pc
	WHERE Empresa = @Empresa
   
	IF (SELECT ISNULL(VentaMonederoA,0) FROM EmpresaCfg2 WHERE Empresa = @Empresa) = 1
		SET @LDI = 0

	IF @FormaPago IS NULL
		SELECT @Ok = 30530, @OkRef = @Codigo
  
	IF @RequiereReferencia = 1 
		AND @MovClave NOT IN ('POS.AC','POS.AP', 'POS.CC', 'POS.CPC','POS.ACM','POS.CCM','POS.CPCM','POS.TCM','POS.CTCM','POS.IC','POS.EC','POS.TRM','POS.CTRM')
		BEGIN 
			IF NULLIF(@Referencia,'') IS NULL
				SELECT @Ok = 20910, @OkRef = @FormaPago
		END
  
	IF ISNULL(@Importe,0) = 0 AND @Saldo <> 0
		SELECT @Ok = 40140, @OkRef = @Codigo   	
    
	EXEC xpPOSMovCobrarVerificar @ID, @Codigo, @Referencia, @FormaPago, @CtaDinero, @ToleranciaRedondeo, @CodigoAccion OUTPUT, @Importe OUTPUT, @Saldo OUTPUT, @Ok OUTPUT, @OkRef OUTPUT

	IF @MovClave IN ('POS.CC', 'POS.CPC','POS.CCM','POS.CPCM')
		BEGIN
			SELECT @ImporteEnCaja = SUM(plc.Importe * mt.Factor)
			FROM POSLCobro plc 
			INNER JOIN POSL p ON plc.ID = p.ID
			INNER JOIN MovTipo mt ON p.Mov = mt.Mov
   			AND mt.Modulo = 'POS'      			   
			WHERE p.Caja = @Caja
			AND plc.FormaPago = @FormaPago
    
			SELECT @ImporteEnMovimiento = SUM(Importe)
			FROM POSLCobro pc
			WHERE pc.ID = @ID
			AND pc.FormaPago = @FormaPago
    
			SELECT @ImporteEnCaja = ROUND(@ImporteEnCaja,@RedondeoMonetarios)	    
			SELECT @ImporteEnMovimiento = ROUND(@ImporteEnMovimiento,@RedondeoMonetarios)	    
    
			IF @Mov = 'CPC' AND (ISNULL(@Importe,0) + ISNULL(@ImporteEnMovimiento,0)) > ISNULL(@ImporteEnCaja,0) AND @Ok IS NULL
				SELECT @Ok = 30455, @OkRef = @FormaPago
		END
  
	IF @Ok IS NULL AND @PermiteCambio = 0 AND @MovClave IN ('POS.F', 'POS.N', 'POS.A','POS.NPC','POS.AF', 'POS.CXCD', 'POS.CXCC')
		BEGIN      
			SELECT @Comision3 = isnull(Comision3,0) FROM FormaPago WHERE FormaPago = @FormaPago
			
			IF @Comision3 IS NULL
				SELECT @Comision3 = 0
			
			SELECT @CImporte = (@Importe *ISNULL(@Comision3,0.0)/100)
	     
			IF ROUND(@Importe,@RedondeoMonetarios) > ROUND(@Saldo+@CImporte, @RedondeoMonetarios)
				SELECT @Ok = 30590, @OkRef = @FormaPago
		END
 
	IF @Ok IS NULL AND @PermiteCambio = 0 AND @MovClave IN ('POS.CXCC')
		BEGIN      
			IF (SELECT ISNULL(Comision3,0) FROM FormaPago WHERE FormaPago = @FormaPago) > 0 
				BEGIN
					SELECT @Comision3 = NULL, @CImporte = NULL
					SELECT @Comision3 = isnull(Comision3,0) FROM FormaPago WHERE FormaPago = @FormaPago
					SELECT @Comision3Porcentaje = (@Comision3 /100) + 1
					SELECT @CImporte = (@Importe /@Comision3Porcentaje) 
					SELECT @Importe = (@Importe /@Comision3Porcentaje)
					SELECT @CImporte = (@Importe *ISNULL(@Comision3,0.0)/100) 
      
					INSERT POSLCobro (
						ID, FormaPago, Importe, Referencia, CtaDinero, Monedero, Fecha, Caja, Cajero, Host, ImporteRef, 
						TipoCambio,	Voucher, Banco, MonedaRef,CtaDineroDestino)
					VALUES (
						@ID, @FormaPago, @CImporte, 'COMISION CREDITO', @CtaDinero, @Monedero, @Fecha, @CtaDinero, @Cajero, @Host, @CImporte, 
						ISNULL(@FormaPagoTipoCambio,1), @Voucher, @Banco,@FormaPagoMoneda,@CtaDineroDestino)
      
					IF @@ERROR<> 0 
						SET @Ok = 1
				END 
		END
    
	IF @Importe < 0 AND ISNULL(@Cambio,0) = 0 AND @MovClave NOT IN ('POS.N','POS.NPC','POS.CXCD', 'POS.CC')
		SELECT @Ok = 30351
  
	IF @Ok IS NULL
		BEGIN
			SELECT 
				@Mov = Mov,
				@MovID = MovID
			FROM POSL pl
			WHERE pl.ID = @ID
     
			IF @MovID IS NULL
				BEGIN
					EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @Mov, 
					@MovID OUTPUT, @Prefijo OUTPUT, @Consecutivo OUTPUT, @noAprobacion OUTPUT, @FechaAprobacion OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
      
					UPDATE POSL SET 
						MovID = @MovID,
						Prefijo = @Prefijo,
						Consecutivo = @Consecutivo,
						noAprobacion = @noAprobacion,
						fechaAprobacion = @fechaAprobacion
					WHERE ID = @ID
				END    
		END
   
	IF @Ok IS NULL
		BEGIN      				
			SELECT @FormaPagoMoneda = 
				CASE WHEN @POSMonedaAct = 0 
						THEN ISNULL(NULLIF(Moneda,''), @MonedaPrincipal) 
					 ELSE ISNULL(NULLIF(POSMoneda,''), @MonedaPrincipal) 
					 END
			FROM FormaPago
			WHERE FormaPago = @FormaPago
    
			IF ISNULL(@FormaPagoMoneda, @MonedaPrincipal) <> @MonedaPrincipal
				BEGIN
					IF NOT EXISTS(SELECT TOP 1 TipoCambio FROM POSLTipoCambioRef WHERE Sucursal = @Sucursal AND Moneda = @FormaPagoMoneda)
						SELECT @ok = 35040, @okRef = @FormaPago
				END
    
			IF ISNULL(@FormaPagoMoneda, @MonedaPrincipal) <> @MonedaPrincipal AND @MovClave IN( 'POS.FA', 'POS.CXCC','POS.CXCD' )
				SELECT @ok = 30045, @okRef = @okRef+@FormaPago

			IF @MovClave IN ('POS.AP','POS.IC','POS.EC') AND EXISTS(SELECT * FROM POSLCobro WHERE ID = @ID) 
				BEGIN
					IF EXISTS (SELECT * FROM POSLCobro WHERE ID = @ID AND MonedaRef <> @FormaPagoMoneda)
					SELECT @Ok = 30084    
				END  
    
			IF ISNULL(@FormaPagoMoneda, @MonedaPrincipal) <> @MonedaPrincipal
				SELECT TOP 1 @FormaPagoTipoCambio = ROUND(TipoCambio ,@RedondeoMonetarios)
				FROM POSLTipoCambioRef
				WHERE Sucursal = @Sucursal AND Moneda = @FormaPagoMoneda 
			ELSE
		
			SELECT @FormaPagoTipoCambio = 1   

			IF ISNULL(@FormaPagoMoneda, @MonedaPrincipal) <> @MonedaPrincipal 
				AND @MovClave IN ('POS.CC', 'POS.CPC', 'POS.AC', 'POS.AP','POS.ACM','POS.CCM','POS.CPCM','POS.TCM','POS.IC','POS.EC','POS.TRM') AND ISNULL(@Cambio,0) = 0
				BEGIN
					IF NOT EXISTS(SELECT TOP 1 TipoCambio FROM POSLTipoCambioRef WHERE Sucursal = @Sucursal AND Moneda = @FormaPagoMoneda)
						SELECT @ok = 35040, @okRef = @FormaPago

					SELECT @ImporteRef = ROUND(@Importe,@RedondeoMonetarios)
					SELECT @Importe = ROUND(ROUND(@Importe,@RedondeoMonetarios) * ISNULL(@FormaPagoTipoCambio,1.0),@RedondeoMonetarios)
				END
			ELSE    
				IF ISNULL(@FormaPagoMoneda, @MonedaPrincipal) <> @MonedaPrincipal 
				AND @MovClave IN ('POS.N','POS.F','POS.NPC','POS.FA','POS.CXCC','POS.CXCD' ) AND ISNULL(@Cambio,0) = 0
					BEGIN		
						IF NOT EXISTS(SELECT TOP 1 TipoCambio FROM POSLTipoCambioRef WHERE Sucursal = @Sucursal AND Moneda = @FormaPagoMoneda)
							SELECT @ok = 35040, @okRef = @FormaPago

						SELECT @ImporteRef = ROUND(ROUND(@Importe,@RedondeoMonetarios) / ISNULL(@FormaPagoTipoCambio,1),@RedondeoMonetarios)
					END  
				ELSE    
					SELECT @ImporteRef = ROUND(@Importe,@RedondeoMonetarios)

			IF EXISTS(SELECT * FROM POSLRefBancaria WHERE ID = @ID)
				BEGIN
					SELECT TOP 1 
						@Voucher = Voucher,
						@Banco = Banco
					FROM POSLRefBancaria
					WHERE ID = @ID
        
					DELETE FROM POSLRefBancaria WHERE ID = @ID
				END
      
			IF ISNULL(@Cambio,0) = 1
				BEGIN    
					SELECT @ImporteRef = ROUND(ROUND(@Importe,@RedondeoMonetarios)/ @FormaPagoTipoCambio,@RedondeoMonetarios)
				END 

			IF @Ok IS NULL AND @MovClave IN ('POS.F', 'POS.N', 'POS.A','POS.NPC','POS.P')
				BEGIN
					SELECT @ImporteMov = SUM(dbo.fnPOSImporteMov(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),plv.Impuesto1,plv.Impuesto2,plv.Impuesto3,plv.Cantidad))
					FROM POSLVenta plv 
					INNER JOIN POSL p ON p.ID = plv.ID
					WHERE plv.ID = @ID    
					AND plv.Articulo <> @ArticuloRedondeo
           
					IF EXISTS(SELECT * FROM POSRedondeoTemp WHERE ID = @ID)
						BEGIN   
							SELECT @ImporteRedondeo = ISNULL(Importe,0.0) FROM POSRedondeoTemp WHERE ID = @ID 
        
							IF  @ImporteRedondeo >0
								BEGIN  
									EXEC spPOSVentaInsertaRedondeo @ID, 'INSERTAR', @ImporteRedondeo           
									EXEC spPOSVentaInsertaRedondeo @ID, 'ELIMINAR COBRO', NULL           
								END  
						END       
     
					IF EXISTS(SELECT * FROM  POSOfertaFormaPago 
							  WHERE Estatus = 'ACTIVA' AND FormaPago = @FormaPago AND @Fecha BETWEEN ISNULL(FechaD,@Fecha) 
							  AND ISNULL(FechaA,@Fecha) AND @HoraMinutos BETWEEN ISNULL(dbo.fnHoraEnEntero(HoraD),0) 
							  AND ISNULL(dbo.fnHoraEnEntero(HoraA),1440) 
							  GROUP BY  Descuento,MontoMinimo 
							  HAVING @ImporteMov >=MAX(MontoMinimo))
							  AND NOT EXISTS(SELECT * FROM POSLCobro WHERE ID = @ID)
							  AND NOT EXISTS (SELECT * FROM POSLVenta WHERE Articulo = @CfgAnticipoArticuloServicio AND ID = @ID)
						BEGIN      
							SELECT @ArticuloRedondeo = Cuenta 
							FROM CB 
							WHERE Codigo = @CodigoRedondeo AND TipoCuenta = 'Articulos'	          
     
							SELECT @ImporteMov = ROUND(@ImporteMov,@RedondeoMonetarios)
      
							SELECT @Descuento = Descuento, @FormaPagoOfer = FormaPago 
							FROM POSOfertaFormaPago 
							WHERE Estatus = 'ACTIVA' AND FormaPago = @FormaPago AND @Fecha BETWEEN ISNULL(FechaD,@Fecha) 
							AND ISNULL(FechaA,@Fecha) AND  @HoraMinutos BETWEEN ISNULL(dbo.fnHoraEnEntero(HoraD),0) 
							AND ISNULL(dbo.fnHoraEnEntero(HoraA),1440) 
							GROUP BY Descuento,MontoMinimo,FormaPago 
							HAVING @ImporteMov >=MAX(MontoMinimo)
            
							SELECT @ImporteOfer = (@ImporteMov-(@ImporteMov*(@Descuento/100)))
							SELECT @ImporteOfer = ROUND(@ImporteOfer,@RedondeoMonetarios)
        
							SELECT @PrecioOfer = ((@ImporteMov*(ISNULL(@Descuento,0.0)/100)))*-1   
        
							IF @Importe >= @ImporteOfer AND @FormaPago = @FormaPagoOfer 
								AND NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo IN(SELECT Articulo FROM POSLDIArtRecargaTel))
								BEGIN
									SELECT @ArtTipo = Tipo, @Unidad = Unidad 
									FROM Art 
									WHERE Articulo = @ArticuloOfertaFP
							
									SELECT @Renglon = MAX(Renglon)+2048.0, @RenglonID = MAX(RenglonID)+1  
									FROM POSLVenta 
									WHERE ID = @ID
							
									SELECT @RenglonTipo = dbo.fnRenglonTipo(@ArtTipo)

									DECLARE crDescuentoFP CURSOR LOCAL FOR
									SELECT SUM(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100)))), ISNULL(plv.Impuesto1,0.0), ISNULL(plv.Impuesto2,0.0), ISNULL(plv.Impuesto3,0.0)
									FROM POSLVenta plv 
									JOIN POSL p ON p.ID = plv.ID
									WHERE  plv.ID = @ID   AND  plv.Articulo NOT IN( @ArticuloRedondeo,@ArticuloOfertaFP)
									GROUP BY  ISNULL(plv.Impuesto1,0.0), ISNULL(plv.Impuesto2,0.0), ISNULL(plv.Impuesto3,0.0)       
							
									OPEN crDescuentoFP
									FETCH NEXT FROM crDescuentoFP INTO @DImporte, @DImpuesto1, @DImpuesto2, @DImpuesto3
									WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
										BEGIN
											SELECT @ImporteDescuento = (@DImporte*(ISNULL(@Descuento,0.0)/100))  
											SELECT @ImporteDescuento = ROUND(@ImporteDescuento,@RedondeoMonetarios)
								
											INSERT POSLVenta(
												ID, Renglon, RenglonSub, RenglonID,  RenglonTipo, Cantidad, Articulo, Precio, PrecioSugerido, Impuesto1, Impuesto2, 
												Impuesto3, PrecioImpuestoInc, Unidad, Factor, AplicaDescGlobal)
											SELECT
												@ID, @Renglon, 0, @RenglonID ,@RenglonTipo, -1, @ArticuloOfertaFP, @ImporteDescuento, @ImporteDescuento,  @DImpuesto1, @DImpuesto2,
												@DImpuesto3, dbo.fnPOSPrecioConImpuestos(@ImporteDescuento, @DImpuesto1, @DImpuesto2, @DImpuesto3, @Empresa), @Unidad, 1, 0    
								
											SELECT  @Renglon = @Renglon +2048.0, @RenglonID = @RenglonID +1, @ImporteDescuento = 0.0     
                    
											FETCH NEXT FROM crDescuentoFP INTO @DImporte, @DImpuesto1, @DImpuesto2, @DImpuesto3
										END
									CLOSE crDescuentoFP
									DEALLOCATE crDescuentoFP 
								END      
						END
				END    

			IF ISNULL(@Monedero,'') IS NOT NULL
				SELECT @ImporteMonedero =  dbo.fnImporteMonTarjeta(@Importe, @FormaPagoMoneda, @FormaPagoTipoCambio, @MonederoMoneda, @MonederoTipoCambio, @Sucursal )
 
			IF @MovClave IN ('POS.TCM','POS.CTCM')
				BEGIN
					UPDATE POSL SET Caja = @CtaDinero WHERE ID = @ID
					
					INSERT POSLCobro (
						ID, FormaPago, Importe, Referencia, CtaDinero, Monedero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio,
						Voucher, Banco, MonedaRef, CtaDineroDestino)
					VALUES (
						@ID, @FormaPago, @Importe, @Referencia, @CtaDinero, @Monedero, @Fecha, @CtaDinero, @Cajero, @Host, @ImporteRef, @FormaPagoTipoCambio, 
						@Voucher, @Banco, @FormaPagoMoneda, @CtaDineroDestino)
					
					IF @@ERROR<> 0 
						SET @Ok = 1         
				END               
			ELSE IF @MovClave IN ('POS.TRM','POS.CTRM' )
				BEGIN
						INSERT POSLCobro (
							ID, FormaPago, Importe, Referencia, CtaDinero, Monedero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio, 
							Voucher, Banco, MonedaRef, CtaDineroDestino)
						VALUES (
							@ID, @FormaPago, @Importe, @Referencia, @CtaDinero, @Monedero, @Fecha, @CtaDinero, @Cajero, @Host, @ImporteRef, @FormaPagoTipoCambio, 
							@Voucher, @Banco, @FormaPagoMoneda, @CtaDineroDestino)
					  
					  IF @@ERROR<> 0 
						SET @Ok = 1       
				END     
			ELSE IF @MovClave IN ('POS.CXCC' ) 
				BEGIN
					INSERT POSLCobro (
						ID, FormaPago, Importe, Referencia, CtaDinero, Monedero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio, 
						Voucher, Banco, MonedaRef, CtaDineroDestino, MonederoMoneda, MonederoTipoCambio, MonederoImporte)
					VALUES (
						@ID, @FormaPago, @Importe, @Referencia, @CtaDinero, @Monedero, @Fecha, @Caja, @Cajero, @Host, @ImporteRef, @FormaPagoTipoCambio, 
						@Voucher, @Banco, @FormaPagoMoneda, @CtaDineroDestino, @MonederoMoneda, @MonederoTipoCambio, @ImporteMonedero)
      
					IF @@ERROR<> 0 
						SET @Ok = 1
				END 
			ELSE IF @MovClave NOT IN ('POS.CXCC','POS.TRM','POS.CTRM', 'POS.TCM','POS.CTCM')
				BEGIN
					INSERT POSLCobro (
						ID, FormaPago, Importe, Referencia, CtaDinero, Monedero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio,
						Voucher, Banco, MonedaRef, CtaDineroDestino, MonederoMoneda, MonederoTipoCambio, MonederoImporte)
					VALUES (
						@ID, @FormaPago, @Importe, @Referencia, @CtaDinero, @Monedero, @Fecha, @Caja, @Cajero, @Host, @ImporteRef, @FormaPagoTipoCambio, 
						@Voucher, @Banco, @FormaPagoMoneda, @CtaDineroDestino, @MonederoMoneda, @MonederoTipoCambio, @ImporteMonedero)
      
					IF @@ERROR<> 0 
						SET @Ok = 1
				END 
              
			SELECT @RIDCobro = SCOPE_IDENTITY()
    
			IF @MovClave IN ('POS.CC', 'POS.CPC', 'POS.AC','POS.AP','POS.ACM','POS.CCM','POS.CPCM','POS.IC','POS.EC')
				BEGIN    
					UPDATE POSL
					SET Importe = (SELECT ROUND(SUM(ImporteRef*TipoCambio),@RedondeoMonetarios) FROM POSLCobro WHERE ID = @ID)
					WHERE ID = @ID
				END                  
		END
  
	IF ISNULL(@Monedero,'') IS NOT NULL AND NULLIF(@ImporteMonedero,0.0) IS NOT NULL AND ISNULL(@ImporteMonedero,0.0) <> 0.0
		BEGIN
			SELECT @SevicioLDI = Servicio
			FROM POSLDIFormaPago plfp
			WHERE plfp.FormaPago = @FormaPago 
     
			IF @ImporteMonedero < 0.0
				BEGIN
					SELECT @SevicioLDI = ServicioInverso
					FROM POSLDIFormaPago plfp
					WHERE plfp.FormaPago = @FormaPago 
					
					SELECT @ImporteMonedero = (@ImporteMonedero*-1)
				END   
    
			IF @Monedero IS NOT NULL AND @SevicioLDI IS NOT NULL AND @Ok IS NULL AND ISNULL(@LDI,0) = 1
				BEGIN
					IF @SevicioLDI <> '9999'
						EXEC spPOSLDI @SevicioLDI , @ID, @Monedero,@Empresa,@Usuario,@Sucursal, NULL, @ImporteMonedero ,1,NULL,
						@Ok OUTPUT ,@OkRef OUTPUT  ,'POS',@RIDCobro = @RIDCobro
				END 
		END 
 
	IF @Ok IS NULL
		EXEC xpPOSMovCobrarDespues @ID, @Codigo, @Referencia, @FormaPago, @CtaDinero, @ToleranciaRedondeo, @CodigoAccion OUTPUT, @Importe OUTPUT, @Saldo OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
END
GO


/************************ spPOSVentaInsertaRedondeo *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSVentaInsertaRedondeo') AND type = 'P') DROP PROCEDURE dbo.spPOSVentaInsertaRedondeo
GO             
CREATE PROCEDURE spPOSVentaInsertaRedondeo
	@ID			varchar(50),
    @Tipo		varchar(20),
    @Importe	float = NULL
--//WITH ENCRYPTION    	     
AS
BEGIN
	DECLARE 
	@Empresa					varchar(5),
	@Codigo						varchar(50),
	@RedondeoVenta				bit,
	@RedondeoVentaModificar		bit,
	@Articulo					varchar(20),
	@Unidad						varchar(50),
	@Renglon					float,
	@RenglonID					int,
	@ImporteMov					float,
	@Saldo						float,
	@RedondeoSugerido			float,
	@RedondeoActual				float,
	@RedondeoMonetarios         int	  
	  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)		  
  
	SELECT @Empresa = Empresa
    FROM POSL pl
	WHERE pl.ID = @ID
  
	SELECT @RedondeoSugerido = 0

	SELECT 
		@Codigo = pc.RedondeoVentaCodigo,
		@RedondeoVenta = pc.RedondeoVenta,
		@RedondeoVentaModificar = pc.RedondeoVentaModificar
    FROM POSCfg pc
	WHERE pc.Empresa = @Empresa
  
	SELECT @Articulo = Cuenta
    FROM CB
	WHERE Codigo = @Codigo
    AND TipoCuenta = 'Articulos'
  
	SELECT @Unidad = a.Unidad
    FROM Art a
	WHERE a.Articulo = @Articulo
  
	IF @Tipo = 'SUGERIR'
		BEGIN  
			IF EXISTS(SELECT * FROM POSLVenta plv WHERE plv.ID = @ID AND plv.Articulo = @Articulo AND ISNULL(Precio,0) > 0)  
				DELETE FROM POSLVenta WHERE ID = @ID AND Articulo = @Articulo AND ISNULL(Precio,0) > 0
       
			SELECT @ImporteMov = SUM(dbo.fnPOSImporteMov(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),plv.Impuesto1,plv.Impuesto2,plv.Impuesto3,plv.Cantidad))
			FROM POSLVenta plv 
			INNER JOIN POSL p ON p.ID = plv.ID
			WHERE plv.ID = @ID
			AND plv.Articulo <> @Articulo
       
			SELECT @Saldo = SUM(ISNULL(Importe,0) * TipoCambio) 
			FROM POSLCobro 
			WHERE ID = @ID  
			
			SET @ImporteMov = @ImporteMov - ISNULL(@Saldo, 0)    
       
			SELECT @ImporteMov = ROUND(@ImporteMov,@RedondeoMonetarios)	

			SELECT @RedondeoActual = ROUND(Precio, @RedondeoMonetarios)
			FROM POSLVenta pl
			WHERE pl.ID = @ID
			AND pl.Articulo = @Articulo
        
			SELECT @RedondeoSugerido = ROUND(CEILING(ROUND(@ImporteMov,@RedondeoMonetarios)) - @ImporteMov, @RedondeoMonetarios)
     
			IF ISNULL(@RedondeoActual,0) > 0
				SELECT @RedondeoSugerido = 0       
     
			IF ISNULL(@RedondeoVenta,0) = 0
				SELECT @RedondeoSugerido = 0
       
			SELECT @RedondeoSugerido
		END
    
	IF @RedondeoVenta = 1 AND @Tipo = 'INSERTAR'
		BEGIN   
			IF EXISTS(SELECT * FROM POSLVenta plv WHERE plv.ID = @ID AND plv.Articulo = @Articulo)
				UPDATE POSLVenta SET Precio = @Importe, PrecioImpuestoInc = @Importe, AplicaDescGlobal = 0 WHERE ID = @ID AND Articulo = @Articulo
			ELSE
				BEGIN
					IF EXISTS (SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo = @Articulo)
						DELETE POSLVenta WHERE ID = @ID AND Articulo = @Articulo
      
					SELECT 
						@Renglon = MAX(Renglon),
						@RenglonID = MAX(RenglonID)
					FROM POSLVenta plv
					WHERE plv.ID = @ID
      
					SELECT 
						@Renglon = ISNULL(@Renglon, 0) + 2048,
						@RenglonID = ISNULL(@RenglonID, 0) + 1
	     	     	        
					INSERT POSLVenta (
						ID, Renglon, RenglonID, RenglonTipo, Cantidad, Articulo, Precio, Unidad, Factor, CantidadInventario, 
						PrecioImpuestoInc, AplicaDescGlobal, Codigo)
					VALUES (
						@ID, @Renglon, @RenglonID, 'N', 1, @Articulo, @Importe, @Unidad, 1, 1, 
						@Importe,0, @Codigo)
				END
		END
  
	IF @Tipo = 'ELIMINAR'
		DELETE POSLVenta WHERE ID = @ID AND Articulo = @Articulo
    
	IF @Tipo = 'ELIMINAR COBRO'
		DELETE POSRedondeoTemp WHERE ID = @ID    
    
	IF @Tipo = 'CONSULTAR'    
		BEGIN
			SELECT @RedondeoSugerido = ISNULL(SUM(Precio),0.0) FROM POSLVenta WHERE ID = @ID AND Articulo = @Articulo
			SELECT @RedondeoSugerido 
		END
  
	IF @Tipo = 'CONSULTAR COBRO'    
		BEGIN
			SELECT @RedondeoSugerido = ISNULL(SUM(Importe),0.0) FROM POSRedondeoTemp WHERE ID = @ID 
			SELECT @RedondeoSugerido 
		END  
  
	IF @Tipo = 'INSERTAR COBRO' AND ISNULL(@Importe,0.0)>0.0
		BEGIN
			INSERT POSRedondeoTemp(
				ID,Importe)
			SELECT
				@ID,@Importe
		END  
  
	IF @Tipo = 'SUGERIR COBRO'
		BEGIN
			SELECT @ImporteMov = @Importe
              
			SELECT @ImporteMov = ROUND(@ImporteMov,@RedondeoMonetarios)	

			SELECT @RedondeoActual = ROUND(Precio, @RedondeoMonetarios)
			FROM POSLVenta pl
			WHERE pl.ID = @ID
			AND pl.Articulo = @Articulo
        
			SELECT @RedondeoSugerido = ROUND(CEILING(ROUND(@ImporteMov,@RedondeoMonetarios)) - @ImporteMov, @RedondeoMonetarios)
     
			IF ISNULL(@RedondeoActual,0) > 0
				SELECT @RedondeoSugerido = 0       
     
			IF EXISTS(SELECT * FROM POSLVenta plv WHERE plv.ID = @ID AND plv.Articulo = @Articulo AND ISNULL(Precio,0) > 0)  
				SELECT @RedondeoSugerido = 0
     
			IF ISNULL(@RedondeoVenta,0) = 0
				SELECT @RedondeoSugerido = 0
       
			SELECT @RedondeoSugerido
		END  
END    	     
GO


/************************ spPOSConsecutivoAuto *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSConsecutivoAuto') AND type = 'P') DROP PROCEDURE dbo.spPOSConsecutivoAuto
GO             
CREATE PROCEDURE spPOSConsecutivoAuto
	@Empresa			varchar(20),
	@Sucursal			int,
	@Mov				varchar(20),
	@MovID				varchar(20)		OUTPUT,
	@Prefijo			varchar(5)		OUTPUT,
	@Consecutivo		int				OUTPUT,
	@noAprobacion		int				OUTPUT,
	@FechaAprobacion	datetime		OUTPUT,	
	@Ok					int				OUTPUT,
	@OkRef				varchar(255)	OUTPUT
--//WITH ENCRYPTION		
AS 
BEGIN
	DECLARE 
	@Host				varchar(20),
	@Cluster			varchar(20),
	@CFDAnterior		bit,
	@CFDFlex			bit,
	@CFD				bit,
	@PrefijoSucursal	varchar(5)
  
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
 
	SELECT 
		@CFDAnterior = ISNULL(CFD,0),
		@CFDFlex = ISNULL(CFDFlex,0)
    FROM MovTipo mt
	WHERE mt.Modulo = 'POS'
    AND mt.Mov = @Mov
  
	IF ISNULL(@CFDAnterior,0) = 1 OR ISNULL(@CFDFlex,0) = 1
		SELECT @CFD = 1
   
	IF NOT EXISTS(SELECT 1 FROM POSC pc WHERE pc.Empresa = @Empresa AND pc.Sucursal = @Sucursal AND pc.Host = @Host AND pc.Mov = @Mov) AND @Ok IS NULL
		BEGIN
			IF ISNULL(@CFD,0) = 1
				SELECT @Ok = 53040
			ELSE
				BEGIN
					SELECT @PrefijoSucursal = Prefijo 
					FROM Sucursal s
					WHERE s.Sucursal = @Sucursal
      
					IF @Mov IS NOT NULL 
						INSERT POSC (
							Empresa, Sucursal, Mov, Prefijo, Consecutivo, Host, FolioD, FolioA)
						VALUES (
							@Empresa, @Sucursal, @Mov, ISNULL(@Host,'POS')+'-', 0, @Host, 1, 999999999)
				END	   
		END
  
	IF @Ok IS NULL
		BEGIN
			SELECT TOP 1 
				@Consecutivo = pc.Consecutivo,
				@Prefijo = pc.Prefijo,
				@noAprobacion = pc.noAprobacion,
				@FechaAprobacion = pc.fechaAprobacion
			FROM POSC pc 
			WHERE pc.Empresa = @Empresa
			AND pc.Sucursal = @Sucursal
			AND pc.Host = @Host
			AND pc.Mov = @Mov
			AND ISNULL(pc.Consecutivo,0) < pc.FolioA
			ORDER BY FolioA
    
			SELECT @Consecutivo = @Consecutivo + 1
    
			UPDATE POSC SET Consecutivo = @Consecutivo
			WHERE Empresa = @Empresa
			AND Sucursal = @Sucursal
			AND Host = @Host
			AND Mov = @Mov
			AND ISNULL(@Consecutivo,0) < FolioA
			AND ISNULL(@Consecutivo,0) >= FolioD
            
			SELECT @MovID = ISNULL(@Prefijo, '') + CONVERT(varchar, @Consecutivo)
		END    
  
	RETURN
END
GO		


/************************ spPOSGeneraApertura *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSGeneraApertura') AND type = 'P') DROP PROCEDURE dbo.spPOSGeneraApertura
GO             
CREATE PROCEDURE spPOSGeneraApertura
	@Empresa			varchar(5), 
	@Sucursal			int, 
	@Usuario			varchar(10), 
	@ID					varchar(50), 
	@FechaRegitro		datetime,
	@Caja				varchar(10),
	@Ok					int		OUTPUT,
	@OkRef				varchar(255)    OUTPUT
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@FormaPago		        varchar(50),
 	@MovInsertar			varchar(20),
 	@MovIDInsertar			varchar(20),
 	@IDInsertar				varchar(36),
 	@FechaEmision			datetime,
 	@Host					varchar(20),
 	@Cluster				varchar(20),
 	@Moneda					varchar(20), 	  
 	@RedondeoMonetarios		int,
 	@TipoCambio             float,
 	@CtaDineroDestino       varchar(20),
 	@CtaDinero              varchar(20),
	@Fecha                  datetime,
	@SugerirFechaCierre     bit,
	@FechaCierre            datetime
	  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)
  
	SELECT TOP 1 @Moneda = MonedaRef, @TipoCambio = TipoCambio, @CtaDineroDestino = CtaDineroDestino , @CtaDinero = CtaDinero, @FormaPago = FormaPago
    FROM POSLCobro
	WHERE ID = @ID
   
	SELECT @Caja = Caja FROM POSL WHERE ID = @ID
  
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
  
	SELECT @SugerirFechaCierre = SugerirFechaCierre   
	FROM POSCfg 
	WHERE Empresa = @Empresa
  
	SELECT @FechaCierre = Fecha 
	FROM POSFechaCierre 
	WHERE Sucursal = @Sucursal
  
	SELECT @FechaCierre = dbo.fnPOSFechaCierre(@Empresa,@Sucursal,@FechaCierre,@Caja)
  
	SELECT @FechaEmision = CASE WHEN @SugerirFechaCierre = 1 THEN @FechaCierre ELSE dbo.fnFechaSinHora(GETDATE())END
  
	SELECT TOP 1 @MovInsertar = Mov
    FROM MovTipo mt
	WHERE mt.Modulo = 'POS'
    AND mt.Clave = 'POS.AC'	 
     
    SELECT @FormaPago = codigo
    FROM cb
    WHERE cb.FormaPago = @FormaPago
    AND cb.TipoCuenta = 'Forma Pago'      
        
	SELECT @IDInsertar = NEWID()
  
	SELECT @Fecha =   DATEADD(n, -1, @FechaRegitro)

	EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @MovInsertar, @MovIDInsertar OUTPUT, NULL, NULL, NULL, NULL, @Ok OUTPUT, @OkRef OUTPUT

	IF @MovInsertar IS NOT NULL      
		INSERT POSL (
			ID, Empresa, Modulo, Mov, MovID, FechaEmision, FechaRegistro, Moneda, TipoCambio, Usuario, Estatus, Cliente, Almacen, Agente, 
			Cajero, CtaDinero, Importe, CtaDineroDestino, Sucursal, Host, IDR, Cluster, Caja)
		SELECT       
			@IDInsertar, Empresa, 'DIN', @MovInsertar, @MovIDInsertar,  @FechaEmision, @Fecha,  @Moneda, @TipoCambio, Usuario, 'CONCLUIDO', Cliente, Almacen, Agente,
			Cajero, @CtaDineroDestino, 0.0, @CtaDinero, Sucursal, @Host, @ID, @Cluster, Caja
		FROM POSL 
		WHERE ID = @ID
  
	IF @@ERROR <> 0 
		SET @Ok = 1    
  
	IF @MovInsertar IS NOT NULL AND @Ok IS NULL               
	    INSERT POSLCobro (
			ID, FormaPago, Importe, CtaDinero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio,MonedaRef, CtaDineroDestino)
		SELECT TOP 1      
			@IDInsertar, @FormaPago, 0.0, CtaDineroDestino, dbo.fnFechaSinHora(GETDATE()), @Caja, Cajero, Host, 0.0, 1, @Moneda, CtaDinero
		FROM POSLCobro 
		WHERE ID = @ID
  
	IF @@ERROR <> 0 
		SET @Ok = 1      
  
	IF @Ok IS NULL
		BEGIN
			IF NOT EXISTS(SELECT * FROM POSEstatusCaja WHERE Caja = @Caja) 
				INSERT POSEstatusCaja (
					Caja, Host, Cajero, Usuario, Abierto,Bloqueado)
				VALUES (
					@Caja, @Host, @Usuario, @Usuario, 1,0)
			ELSE		       
				UPDATE POSEstatusCaja SET Host = @Host,
					Cajero = @Usuario,
					Usuario = @Usuario,
					Abierto = 1
				WHERE Caja = @Caja
		END
END
GO 


/************************ spPOSGeneraFaltante *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSGeneraFaltante') AND type = 'P') DROP PROCEDURE dbo.spPOSGeneraFaltante
GO   
CREATE PROCEDURE spPOSGeneraFaltante
	@Empresa		varchar(5), 
	@Sucursal		int, 
	@Usuario		varchar(10), 
	@ID				varchar(50), 
	@MovClave		varchar(20), 
	@Caja			varchar(10),
	@Ok				int				OUTPUT,
	@OkRef			varchar(255)    OUTPUT
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@CorteFormaPago			varchar(50),
 	@CorteImporte			float,
 	@Diferencia				float,
 	@SaldoCaja				float,
 	@MovInsertar			varchar(20),
 	@MovIDInsertar			varchar(20),
 	@IDInsertar				varchar(36),
 	@FechaEmision			datetime,
 	@Moneda					varchar(20),
 	@TipoCambio				float,
 	@Cliente				varchar(10),
 	@Agente					varchar(10),
 	@Almacen				varchar(10),
 	@Cajero					varchar(10),
 	@CtaDinero				varchar(10),
 	@CtaDineroDestino		varchar(10),
 	@Host					varchar(20),
 	@Cluster				varchar(20),
 	@Importe				float,
 	@ImporteRef				float,
 	@POSMoneda				varchar(20),
 	@TipoCambioRef			float,
 	@MonedaPrincipal		varchar(20),
 	@RedondeoMonetarios		int,
 	@POSMonedaAct			bit
	  
	SELECT @POSMonedaAct = POSMonedaAct FROM POSCfg WHERE Empresa = @Empresa	  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)
 	    
	SELECT TOP 1 @MonedaPrincipal = Moneda 
    FROM POSLTipoCambioRef 
	WHERE TipoCambio = 1	  AND Sucursal = @Sucursal AND EsPrincipal = 1

	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
  	  
	DECLARE crPOSLCobro CURSOR LOCAL FOR
	SELECT plc.FormaPago, Importe = ROUND(SUM(plc.Importe),@RedondeoMonetarios)
    FROM POSLCobro plc
    WHERE plc.ID = @ID
    GROUP BY plc.FormaPago
	UNION 
	SELECT plc.FormaPago, Importe = 0
    FROM POSLCobro plc
    INNER JOIN POSL p ON plc.ID = p.ID
    INNER JOIN MovTipo mt ON p.Mov = mt.Mov
    AND mt.Modulo = 'POS'      			   
    WHERE p.Caja = @Caja
    AND p.Estatus NOT IN ('CANCELADO', 'SINAFECTAR','PENDIENTE')
    AND p.Empresa = @Empresa
    AND plc.FormaPago NOT IN (SELECT plc.FormaPago
							  FROM POSLCobro plc
							  WHERE plc.ID = @ID )
	GROUP BY plc.FormaPago
   
	OPEN crPOSLCobro 
	FETCH NEXT FROM crPOSLCobro INTO @CorteFormaPago, @CorteImporte
	WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @@FETCH_STATUS <> -2
				BEGIN
					SELECT @Diferencia = 0.0, @POSMoneda = NULL, @ImporteRef = 0, @TipoCambioRef = NULL, @SaldoCaja = 0.0
        
					SELECT @SaldoCaja = ROUND(SUM(plc.Importe * mt.Factor),@RedondeoMonetarios)
					FROM POSLCobro plc
					INNER JOIN POSL p ON plc.ID = p.ID
					INNER JOIN MovTipo mt ON p.Mov = mt.Mov
   		       	    AND mt.Modulo = 'POS'      			   
					WHERE p.Caja = @Caja
					AND p.Estatus NOT IN ('CANCELADO', 'SINAFECTAR','PENDIENTE')
					AND p.Empresa = @Empresa
					AND plc.FormaPago = @CorteFormaPago	     
					GROUP BY plc.FormaPago
           
					SELECT @Diferencia = ISNULL(@SaldoCaja,0) - ROUND(ISNULL(@CorteImporte,0),@RedondeoMonetarios) 
       
					SELECT @MovInsertar = NULL
					IF ISNULL(@Diferencia,0) > 0
						BEGIN
							SELECT TOP 1 @MovInsertar = Mov
							FROM MovTipo mt
							WHERE mt.Modulo = 'POS'
							AND mt.Clave = 'POS.FTE'
							SELECT @Importe = @Diferencia
						END
					
					IF ISNULL(@Diferencia,0) < 0
						BEGIN
							SELECT TOP 1 @MovInsertar = Mov
							FROM MovTipo mt
							WHERE mt.Modulo = 'POS'
							AND mt.Clave = 'POS.STE'
         
							SELECT @Importe = @Diferencia * (-1)
						END
       
					IF @Ok IS NULL AND NULLIF(@MovInsertar,'') IS NOT NULL
						BEGIN
							SELECT 
								@FechaEmision = p.FechaEmision,
								@Moneda = p.Moneda,
								@TipoCambio = p.TipoCambio,
								@Cliente = p.Cliente,
								@Agente = p.Agente,
								@Cajero = p.Cajero,
								@Almacen = p.Almacen,
								@CtaDinero = p.CtaDinero,
								@CtaDineroDestino = p.CtaDineroDestino,
								@Sucursal = p.Sucursal,
								@Caja  = p.Caja
							FROM POSL p
							WHERE p.ID = @ID
         
							SELECT @POSMoneda = CASE WHEN @POSMonedaAct = 0 THEN NULLIF(Moneda,'') ELSE NULLIF(POSMoneda,'') END
							FROM FormaPago fp
							WHERE fp.FormaPago = @CorteFormaPago

							IF ISNULL(@POSMoneda, @MonedaPrincipal) <> @MonedaPrincipal
								BEGIN
									IF NOT EXISTS(SELECT TOP 1 TipoCambio FROM POSLTipoCambioRef WHERE Sucursal = @Sucursal AND Moneda = @POSMoneda)
										SELECT @ok = 35040, @okRef = @CorteFormaPago
								END
      
							IF ISNULL(@POSMoneda, @MonedaPrincipal) <> @MonedaPrincipal
								SELECT @TipoCambioRef = ISNULL(ROUND(TipoCambio,@RedondeoMonetarios),1.0)
								FROM POSLTipoCambioRef  
								WHERE Sucursal = @Sucursal  AND Moneda = @POSMoneda
         
							SELECT @ImporteRef = ISNULL(@ImporteRef,1.0)
							SELECT @ImporteRef = ROUND(@Importe / ISNULL(@TipoCambioRef,1.0),@RedondeoMonetarios)
         
							SELECT @IDInsertar = NEWID()
           
							EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @MovInsertar, @MovIDInsertar OUTPUT, NULL, NULL, NULL, NULL, @Ok OUTPUT, @OkRef OUTPUT

							IF @MovInsertar IS NOT NULL      
								INSERT POSL (
									ID, Empresa, Modulo, Mov, MovID, FechaEmision, FechaRegistro, Moneda, 
									TipoCambio, Usuario, Estatus, Cliente, Almacen, Agente, Cajero, CtaDinero, Importe, 
									CtaDineroDestino, Sucursal, Host, IDR, Cluster, Caja)              
								VALUES (
									@IDInsertar, @Empresa, 'DIN',  @MovInsertar, @MovIDInsertar, @FechaEmision, GETDATE(), ISNULL(@POSMoneda, @MonedaPrincipal), 
									ISNULL(@TipoCambioRef,1.0), @Usuario, 'CONCLUIDO', @Cliente, @Almacen, @Agente, @Cajero, @Caja, @Importe, 
									@CtaDineroDestino, @Sucursal, @Host, @ID, @Cluster, @Caja)         
	 
							IF @MovInsertar IS NOT NULL                 
								INSERT POSLCobro (
									ID, FormaPago, Importe, CtaDinero, Fecha, Caja, Cajero, Host, ImporteRef, 
									TipoCambio,MonedaRef,CtaDineroDestino)
								VALUES (
									@IDInsertar, @CorteFormaPago, @Importe, @Caja, dbo.fnFechaSinHora(GETDATE()), @Caja, @Cajero, @Host, @ImporteRef, 
									ISNULL(@TipoCambioRef,1.0),@POSMoneda,@CtaDineroDestino)
						END  
				END
        
			FETCH NEXT FROM crPOSLCobro INTO @CorteFormaPago, @CorteImporte
		END      
	CLOSE crPOSLCobro
	DEALLOCATE crPOSLCobro
END
GO


/**************** spPOSEmidaRecargaTelefonica ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSEmidaRecargaTelefonica') and type = 'P') DROP PROCEDURE dbo.spPOSEmidaRecargaTelefonica
GO
CREATE PROCEDURE spPOSEmidaRecargaTelefonica
	@ID		        varchar(50),
	@Ok			int          = NULL OUTPUT,
	@OkRef			varchar(255) = NULL OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE           
  	@Estacion					int,
	@Empresa					varchar(5),
	@Sucursal					int,
	@Usuario					varchar(10),
	@RecargaTelefono			varchar(10), 
    @Renglon					float,
	@RenglonAnt					float,
	@Articulo					varchar(20), 
	@URL						varchar(255),
	@version					varchar(2),
	@terminalId					varchar(20),
	@clerkId					varchar(20),
	@CarrierId					varchar(255),
	@ProductId					varchar(255),
	@Description				varchar(255),
	@ShortDescription			varchar(255),
	@amount						varchar(10),
	@invoiceNo					varchar(20),
	@languageOption				varchar(2),
	@Solicitud					varchar(max),
	@Contrasena					varchar(32),
	@Fecha						datetime,
	@Reintentos					int,
	@Resultado					varchar(max),
	@iResultado					int,
	@EmidaControlNo				varchar(20),
	@EmidaCarrierControlNo      varchar(20), 
	@EmidaTransactionId	        varchar(20),
	@EmidaResponseMessage	    varchar(500),
	@EmidaTransactionDateTime	datetime,
	@EmidaResponseCode	        varchar(2),
	@Agente                     varchar(10)
		  		  
	SELECT  @Estacion = Estacion, @Empresa = Empresa, @Sucursal = Sucursal, @Usuario = Usuario, @RecargaTelefono	= Telefono
    FROM  POSEmidaRecargaTemp
	WHERE ID = @ID   		  

	SELECT @Contrasena = Contrasena, @Agente = DefAgente
    FROM Usuario WHERE Usuario = @Usuario

	SELECT @version = Version, @Reintentos = Reintentos FROM EmidaCfg WHERE Empresa = @Empresa

    SELECT @ClerkID = a.ClerkID
    FROM Agente a
    WHERE a.Agente = @Agente
       
    SELECT TOP 1 @Articulo = Articulo FROM POSLVenta WHERE ID = @ID 
    
    SELECT @URL = URL, @CarrierId = CarrierId, @ProductId = ProductId, @Description = Description, @ShortDescription = ShortDescription, 
		@amount = amount, @languageOption = '02'
    FROM EmidaProductCfg
    WHERE Articulo = @Articulo

	SELECT @terminalId = dbo.fnEmidaSiteID(@Empresa, @URL, @Sucursal, @Usuario) 

    EXEC spEmidaInvoiceNo @Estacion, @Empresa, @URL, 'CONSECUTIVO', @Sucursal, @Usuario, @invoiceNo OUTPUT --REQ14335

    IF @Ok IS NULL
		BEGIN
			SELECT @Solicitud = '<Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Emida.RecargaTelefonica" SubReferencia="" Version="' + 
				ISNULL(@Version, '') + '">' + 
                          '  <Solicitud>' + 
                          '    <Emida Estacion="' + CONVERT(varchar, ISNULL(@Estacion, 0)) + '" Empresa="' + ISNULL(dbo.fneDocXmlAUTF8(@Empresa, 0, 1), '') + '" URL="' + ISNULL(@URL, '') + '" terminalId="' + ISNULL(@terminalId, '') + '" Version="' + ISNULL(@Version, '') + '" Sucursal="' + CONVERT(varchar, ISNULL(@Sucursal, 0)) +'" productId="' + ISNULL(@productId, '') + '" clerkId="' + ISNULL(@clerkId, '') + '" accountId="' + ISNULL(@RecargaTelefono, '') + '" amount="' + ISNULL(@amount, '') + '" invoiceNo="' + ISNULL(@invoiceNo, '') + '" languageOption="' + ISNULL(@languageOption, '') + '" Usuario="' + @Usuario +'" Contrasena="' + @Contrasena + '" />' +  -- REQ13848
                          '  </Solicitud>' + 
                          '</Intelisis>'
                      
			EXEC spIntelisisService @Usuario, @Contrasena, @Solicitud, @Resultado = @Resultado OUTPUT, @Procesar = 1, @EliminarProcesado = 0, 
				@Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT
		END

    IF @Ok IS NULL 
		BEGIN
			SELECT @OkRef = NULL
			
			EXEC sp_xml_preparedocument @iResultado OUTPUT, @Resultado

			SELECT @EmidaControlNo = ControlNo, @EmidaTransactionId = TransactionId, @EmidaResponseMessage = ResponseMessage,
			  @EmidaTransactionDateTime = TransactionDateTime, @EmidaResponseCode = ResponseCode,
			  @EmidaCarrierControlNo = CarrierControlNo 
			FROM OPENXML(@iResultado, '/Intelisis/Resultado/PinDistSaleResponse', 2) 
			WITH(CarrierControlNo varchar(20), ControlNo varchar(20), TransactionId varchar(20), ResponseMessage varchar(500), TransactionDateTime datetime, ResponseCode varchar(2))

			UPDATE POSL 
				SET RecargaTelefono = @RecargaTelefono, 
				EmidaResponseCode = @EmidaResponseCode,
				EmidaControlNo = @EmidaControlNo, 
				EmidaCarrierControlNo = @EmidaCarrierControlNo, 
				EmidaTransactionId = @EmidaTransactionId, 
				EmidaResponseMessage = @EmidaResponseMessage,
				EmidaTransactionDateTime = @EmidaTransactionDateTime,
				ResultadoIS = @Resultado
			WHERE ID = @ID

			EXEC sp_xml_removedocument @iResultado 

			EXEC spEmidaInvoiceNo @Estacion, @Empresa, @URL, 'AFECTAR', @Sucursal, @Usuario --REQ14335
		END    
  
	RETURN
END
GO


/**************** spPOSAfectarCFD ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSAfectarCFD') and type = 'P') DROP PROCEDURE dbo.spPOSAfectarCFD
GO             
CREATE PROCEDURE spPOSAfectarCFD
	@ID                     varchar(50),
	@Empresa				varchar(5),
	@Sucursal               int,
	@Usuario                varchar(10),
	@AfectadoEnLinea        bit,
	@Mensaje                varchar(255)  OUTPUT,
	@Ok                     int  OUTPUT,
	@OkRef                  varchar(255)  OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @MovCFD								varchar(20),
    @ContMoneda							varchar(10),
    @ToleranciaRedondeo					float,
    @ContMonedaTC						float,
    @IDNuevo							int,
    @CodigoRedondeo						varchar(30),
    @ArticuloRedondeo					varchar(20),
    @CxcLocal							bit,
    @ArticuloTarjeta					varchar(20),
    @AlmacenTarjeta						varchar(10),
    @MovIDCFD							varchar(20),
    @UUID								varchar(50),
    @FechaTimbrado						datetime,
    @SelloSat							varchar(255),
    @TFDVersion							varchar(10),
    @NoCertificadoSAT					varchar(20),
    @TFDCadenaOriginal					varchar(max),
    @CadenaOriginal						varchar(max),
    @Sello								varchar(255),
    @Certificado						varchar(20),
    @DocumentoXML						varchar(max), 
    @FechaSello							datetime,   
    @MovClave							varchar(20),
    @Modulo								varchar(10),     
    @VentaPreciosImpuestoIncluido       bit

	SELECT @MovCFD = MovFactura,  @CxcLocal = ISNULL(CxcLocal,0), @ToleranciaRedondeo = ISNULL(POSToleranciaVta,0.99)  
    FROM POSCfg
	WHERE Empresa = @Empresa
   
	SELECT @VentaPreciosImpuestoIncluido = ISNULL(VentaPreciosImpuestoIncluido,0), @ArticuloTarjeta= CxcArticuloTarjetasDef ,@AlmacenTarjeta= CxcAlmacenTarjetasDef
	FROM EmpresaCfg 
	WHERE Empresa = @Empresa  	     
     
	SELECT /*@ToleranciaRedondeo = ec.CxcAutoAjusteMov,*/ @ContMoneda = ec.ContMoneda
    FROM EmpresaCfg ec	  
	WHERE ec.Empresa = @Empresa   
  
	SELECT @ContMonedaTC = TipoCambio FROM POSLTipoCambioRef WHERE Sucursal = @Sucursal AND Moneda = @ContMoneda   
  
	SELECT @ArticuloRedondeo = cb.Cuenta
    FROM CB
	WHERE CB.Cuenta = @CodigoRedondeo
    AND CB.TipoCuenta = 'Articulos'   
     
	SELECT @MovClave = mt.Clave , @Modulo = mt.ConsecutivoModulo
    FROM MovTipo mt JOIN POSL p ON p.Mov = mt.Mov AND mt.Modulo = 'POS'
	WHERE p.ID = @ID    
       
    IF NULLIF(@MovCFD,'') IS NOT NULL AND @Ok IS NULL
		BEGIN
			INSERT Venta (
				Empresa, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, 
				Estatus, Observaciones, Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, 
				DescuentoGlobal, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, 
				Origen, OrigenID, ReferenciaOrdenCompra, GenerarDinero, SucursalOrigen)      
			SELECT        
				p.Empresa, @MovCFD, NULL, p.FechaEmision, p.FechaRegistro, p.Concepto, p.Proyecto, p.UEN, p.Moneda, 
					CASE WHEN p.Moneda <> @ContMoneda 
							THEN  (p.TipoCambio/@ContMonedaTC) 
						 ELSE p.TipoCambio 
						 END, p.Usuario, p.Referencia, 
				'SINAFECTAR', p.Observaciones, p.Cliente, p.EnviarA, p.Almacen, p.Agente, p.FormaEnvio, p.Condicion, p.Vencimiento, p.CtaDinero, p.Descuento, 
				0.0, p.Causa, p.Atencion, p.AtencionTelefono, p.ListaPreciosEsp, p.ZonaImpuesto, p.Sucursal, 'POS',
				p.Mov, p.MovID, @ID, 0, p.Sucursal
			FROM POSL p
			WHERE p.ID = @ID  		      
      
			IF @@ERROR <> 0 
				SET @Ok = 1
			
			SELECT @IDNuevo = SCOPE_IDENTITY()
      
			SELECT @CodigoRedondeo = pc.RedondeoVentaCodigo
			FROM POSCfg pc
			WHERE pc.Empresa = @Empresa 	                
  
			SELECT @ArticuloRedondeo = Cuenta
			FROM CB
			WHERE Codigo = @CodigoRedondeo    
			AND TipoCuenta = 'Articulos'
              
			INSERT VentaD (
				ID, Renglon, RenglonID, Aplica, AplicaID, RenglonTipo, Cantidad, CantidadObsequio, Almacen, EnviarA, Articulo, SubCuenta, Precio,
				DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, Sucursal, Puntos, POSDesGlobal, POSDesLinea, Codigo)
			SELECT         
				@IDNuevo, pmv.Renglon, pmv.RenglonID, pmv.Aplica, pmv.AplicaID, pmv.RenglonTipo, pmv.Cantidad, pmv.CantidadObsequio,
					CASE WHEN pmv.Articulo= @ArticuloTarjeta 
							THEN ISNULL(pmv.Almacen,@AlmacenTarjeta) 
						 ELSE p.Almacen 
						 END, p.EnviarA, pmv.Articulo, pmv.SubCuenta, 
					CASE WHEN @VentaPreciosImpuestoIncluido = 1 
							THEN pmv.PrecioImpuestoInc 
						 ELSE pmv.Precio 
						 END, 
				dbo.fnPOSCalcDescuentosVenta(CASE WHEN ISNULL(pmv.AplicaDescGlobal, 1) = 1 
													   THEN ISNULL(p.DescuentoGlobal,0.0) 
												  ELSE 0 
												  END,pmv.DescuentoLinea), pmv.Impuesto1, pmv.Impuesto2, pmv.Impuesto3, pmv.Unidad, 1, @Sucursal, pmv.Puntos, 
											 CASE WHEN ISNULL(pmv.AplicaDescGlobal, 1) = 1 
													   THEN ISNULL(p.DescuentoGlobal,0.0) 
												  ELSE 0 
												  END, ISNULL(pmv.DescuentoLinea,0.0), pmv.Codigo
			FROM POSLVenta pmv JOIN POSL p ON pmv.ID = p.ID
			WHERE pmv.ID = @ID
      
			IF @@ERROR <> 0 
				SET @Ok = 1   

			EXEC spPOSInsertarPOSVentaCobro @ID, @Empresa,@Sucursal, @Ok OUTPUT, @OkRef OUTPUT     

			IF EXISTS(SELECT 1 FROM POSLSerieLote pls WHERE pls.ID = @ID)
				INSERT SerieLoteMov (
					Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal)
				SELECT
					@Empresa, 'VTAS', @IDNuevo, pls.RenglonID, pls.Articulo, ISNULL(pls.SubCuenta, ''), pls.SerieLote, COUNT(*),  @Sucursal  
				FROM POSLSerieLote pls
				WHERE pls.ID = @ID
				GROUP BY Articulo, ISNULL(SubCuenta,''), SerieLote, RenglonID      
      
			IF @Ok IS NULL AND @IDNuevo IS NOT NULL
				EXEC spAfectar @Modulo, @IDNuevo, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 0, @Ok = @ok OUTPUT, @OkRef = @OkRef OUTPUT
    
			IF @Ok IS NULL AND EXISTS(SELECT * FROM CFD WHERE Modulo = 'VTAS' AND ModuloID = @IDNuevo)
				BEGIN
					SELECT 
						@CadenaOriginal = cfd.CadenaOriginal,
    					@Certificado = cfd.noCertificado,
						@Sello = cfd.Sello,
						@DocumentoXML = cfd.Documento,
						@MovIDCFD = cfd.MovID,
						@UUID = cfd.UUID,
						@FechaTimbrado = cfd.FechaTimbrado,
						@SelloSat = cfd.SelloSat,      
						@TFDVersion = cfd.TFDVersion,  
						@NoCertificadoSAT = cfd.NoCertificadoSAT,
						@TFDCadenaOriginal = cfd.TFDCadenaOriginal	     
					FROM CFD cfd
					WHERE cfd.Modulo = 'VTAS' AND cfd.ModuloID = @IDNuevo
				END

			IF @Ok IS NULL
				UPDATE POSL SET 
					CadenaOriginal = @CadenaOriginal, 
					Sello = @Sello, 
					Certificado = @Certificado, 
					DocumentoXML = @DocumentoXML, 
					FechaSello = @FechaSello, 
					Origen = @MovCFD, 
					OrigenID = @MovIDCFD, 
					UUID = @UUID, 
					FechaTimbrado = @FechaTimbrado, 
					SelloSat = @SelloSat, 
					TFDVersion = @TFDVersion, 
					NoCertificadoSAT = @NoCertificadoSAT, 
					TFDCadenaOriginal = @TFDCadenaOriginal
				WHERE ID = @ID
      
			IF @Ok IS NULL AND  @CxcLocal = 0 AND @MovClave IN('POS.F','POS.P')   AND @AfectadoEnLinea = 1
				UPDATE POSL Set Estatus = 'TRASPASADO' , AfectadoEnLinea = @AfectadoEnLinea WHERE ID = @ID
           
			IF @Ok IS NULL AND  @CxcLocal = 1 AND @MovClave IN('POS.F')
				UPDATE POSL Set AfectadoLocal = 1  WHERE ID = @ID             
         
		END  

    IF @Ok IS NOT NULL
		BEGIN
			SELECT  @MovIDCFD = MovID 
			FROM Venta 
			WHERE ID = @IDNuevo
			
			SELECT @Mensaje = @Mensaje+'<BR> ERROR AL GENERAR EL CFD '+ISNULL(@OkRef,'')+'<BR> '
			UPDATE POSL Set Estatus = 'FACTURADO' , AfectadoEnLinea = @AfectadoEnLinea,Origen = @MovCFD, OrigenID = @MovIDCFD WHERE ID = @ID   
		END  

    SELECT  @Ok = null,@OkRef = null 
END
GO  


/********************************** xpPOSConcluirCobroCredito ************************************/
IF EXISTS (SELECT * FROM SysObjects WHERE id = object_id('dbo.xpPOSConcluirCobroCredito') AND type = 'P') DROP PROCEDURE dbo.xpPOSConcluirCobroCredito
GO             
CREATE PROCEDURE xpPOSConcluirCobroCredito
	@ID				varchar(36),
	@Empresa		varchar(5)
AS
BEGIN
	DECLARE 
	@Aplica				varchar(20), 
	@AplicaID			varchar(20), 
	@ImporteAPagar		float

	DECLARE crSE1 CURSOR LOCAL FOR			
	SELECT Aplica, AplicaID, PrecioImpuestoInc
	FROM POSLVenta 
	WHERE ID = @ID
	
	OPEN crSE1
	FETCH NEXT FROM crSE1 INTO @Aplica, @AplicaID, @ImporteAPagar
	WHILE @@FETCH_STATUS <> -1 
		BEGIN
			IF @@FETCH_STATUS <> -2 
				BEGIN
					UPDATE Cxc SET Saldo = Saldo - @ImporteAPagar WHERE Mov = @Aplica AND MovID = @AplicaID AND Empresa = @Empresa			
				END
			
			FETCH NEXT FROM crSE1 INTO @Aplica, @AplicaID, @ImporteAPagar
		END	
	CLOSE crSE1
	DEALLOCATE crSE1
END
GO

/************************ spPOSGeneraEstadisticoEmbarque *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSGeneraEstadisticoEmbarque') AND type = 'P') DROP PROCEDURE dbo.spPOSGeneraEstadisticoEmbarque
GO             
CREATE PROCEDURE spPOSGeneraEstadisticoEmbarque
	@Empresa			                varchar(5), 
	@Modulo				                varchar(5), 
	@Sucursal			                int, 
	@Usuario			                varchar(10), 
	@Estacion			                int,
  @IDText       	              varchar(36),
  @ID					                  varchar(50)	OUTPUT, 
  @POSDefMovEmbarque            varchar(20),
  @ContMoneda					          varchar(10),
  @ContMonedaTC				          float,
  @ArticuloTarjeta              varchar(20),
  @AlmacenTarjeta               varchar(20),
  @VentaPreciosImpuestoIncluido bit,  
	@Ok					                  int		        OUTPUT, 
	@OkRef				                varchar(255)	OUTPUT
--//WITH ENCRYPTION	     
AS 
BEGIN	 
  DECLARE
    @IDNuevo                INT, 
    @ArticuloRedondeo				varchar(20),   
    @CodigoRedondeo					varchar(50),
    @Ubicacion              varchar(1000),
    @POSMovID               varchar(20),
    @Contador               int,
    @MapaLatitud            float,
    @MapaLongitud           float

  SELECT @POSMovID = MovID FROM POSL WHERE ID = @IDText   
  
  SET @Contador = 1
  DECLARE crDatos CURSOR LOCAL FOR
  SELECT Ubicacion, MapaLatitud, MapaLongitud
    FROM POSLVentaEmbarques
    WHERE ID = @IDText and TipoDireccion <> 'Se LLeva'
    GROUP BY Ubicacion, MapaLatitud, MapaLongitud    
  OPEN crDatos
  FETCH NEXT FROM crDatos INTO @Ubicacion, @MapaLatitud, @MapaLongitud
  WHILE @@FETCH_STATUS <> -1 
  BEGIN
  IF @@FETCH_STATUS <> -2 
  BEGIN

		INSERT Venta (
			Empresa, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, 
			Estatus, Observaciones, Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, 
			DescuentoGlobal, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, 
			Origen, OrigenID, ReferenciaOrdenCompra, GenerarDinero, SucursalOrigen, Ubicacion, MapaLatitud, MapaLongitud)      
		SELECT        
			p.Empresa, @POSDefMovEmbarque, @POSMovID+'-'+Convert(Varchar(10), @Contador ), p.FechaEmision, p.FechaRegistro, p.Concepto, p.Proyecto, p.UEN, p.Moneda, 
				CASE WHEN p.Moneda <> @ContMoneda 
						THEN  (p.TipoCambio/@ContMonedaTC) 
						ELSE p.TipoCambio 
						END, p.Usuario, p.Referencia, 
			'SINAFECTAR', p.Observaciones, p.Cliente, p.EnviarA, p.Almacen, p.Agente, p.FormaEnvio, p.Condicion, p.Vencimiento, p.CtaDinero, p.Descuento, 
			0.0, p.Causa, p.Atencion, p.AtencionTelefono, p.ListaPreciosEsp, p.ZonaImpuesto, p.Sucursal, 'POS',
			p.Mov, p.MovID, @ID, 0, p.Sucursal, @Ubicacion, @MapaLatitud, @MapaLongitud
		FROM POSL p
		WHERE p.ID = @IDText  		      
      
		IF @@ERROR <> 0 
			SET @Ok = 1
			
		SELECT @IDNuevo = SCOPE_IDENTITY()

--    SELECT ReferenciaOrdenCompra, * FROM Venta where ID = @IDNuevo

		SELECT @CodigoRedondeo = pc.RedondeoVentaCodigo
		FROM POSCfg pc
		WHERE pc.Empresa = @Empresa 	                
  
		SELECT @ArticuloRedondeo = Cuenta
		FROM CB
		WHERE Codigo = @CodigoRedondeo    
		AND TipoCuenta = 'Articulos'
              
		INSERT VentaD (
			ID, Renglon, RenglonID, Aplica, AplicaID, RenglonTipo, Cantidad, CantidadObsequio, Almacen, EnviarA, Articulo, SubCuenta, Precio,
			DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, Sucursal, Puntos, POSDesGlobal, POSDesLinea, Codigo )
		SELECT @IDNuevo, pmv.Renglon, pmv.RenglonID, pmv.Aplica, pmv.AplicaID, pmv.RenglonTipo, e.Cantidad, pmv.CantidadObsequio,
				CASE WHEN pmv.Articulo= @ArticuloTarjeta THEN ISNULL(pmv.Almacen,@AlmacenTarjeta) ELSE p.Almacen END, 
        p.EnviarA, 
        pmv.Articulo, 
        pmv.SubCuenta, 
				CASE WHEN @VentaPreciosImpuestoIncluido = 1 THEN pmv.PrecioImpuestoInc ELSE pmv.Precio END, 
			  dbo.fnPOSCalcDescuentosVenta(CASE WHEN ISNULL(pmv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END,pmv.DescuentoLinea), 
        pmv.Impuesto1, 
        pmv.Impuesto2, 
        pmv.Impuesto3, 
        pmv.Unidad, 
        1, 
        @Sucursal, 
        pmv.Puntos, 
				CASE WHEN ISNULL(pmv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END, 
        ISNULL(pmv.DescuentoLinea,0.0), 
        pmv.Codigo
		FROM POSLVenta pmv JOIN POSL p ON pmv.ID = p.ID
         JOIN POSLVentaEmbarques e ON e.ID = pmv.ID AND e.Renglon = pmv.Renglon AND e.RenglonID = pmv.RenglonID AND e.Articulo = pmv.Articulo
		WHERE pmv.ID = @IDText AND e.Ubicacion = @Ubicacion


    INSERT INTO VentaDEmbarques (ID,       Renglon, RenglonID, Articulo, Cantidad, TipoDireccion, Ubicacion, MapaLatitud, MapaLongitud)
    SELECT                       @IDNuevo, Renglon, RenglonID, Articulo, Cantidad, TipoDireccion, Ubicacion, MapaLatitud, MapaLongitud
      FROM POSLVentaEmbarques
     WHERE ID = @IDText AND Ubicacion = @Ubicacion

	  IF @Ok IS NULL AND @IDNuevo IS NOT NULL
		  EXEC spAfectar 'VTAS', @IDNuevo, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 0, @Ok = @ok OUTPUT, @OkRef = @OkRef OUTPUT

    SET @Contador = @Contador + 1
    FETCH NEXT FROM crDatos INTO @Ubicacion, @MapaLatitud, @MapaLongitud
  END
  END
  CLOSE crDatos
  DEALLOCATE crDatos

RETURN
END
GO

--declare 
--@OK int, 
--@Okref varchar(255)
--begin tran
--EXEC spPOSGeneraEstadisticoEmbarque 'Nitro', 'POS', 202, 'CAJ-02', 100, '9ABBD11D-60E6-4772-AE8D-2CC1F229B832', '9ABBD11D-60E6-4772-AE8D-2CC1F229B832', 'Estadistica POS', 'Pesos',	1, NULL, NULL, 1, @Ok OUTPUT, @OkRef OUTPUT   
--rollback tran

/************************ spPOSConcluir *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSConcluir') AND type = 'P') DROP PROCEDURE dbo.spPOSConcluir
GO             
CREATE PROCEDURE spPOSConcluir
	@Empresa			varchar(5), 
	@Modulo				varchar(5), 
	@Sucursal			int, 
	@Usuario			varchar(10), 
	@Saldo				float,
	@Estacion			int,
	@ID					varchar(50)	OUTPUT, 
	@Mensaje			varchar(255)	OUTPUT, 
	@Imagen				varchar(255)	OUTPUT, 
	@Expresion			varchar(255)	OUTPUT,
	@Expresion2			varchar(255)	OUTPUT,
	@Ok					int		OUTPUT, 
	@OkRef				varchar(255)	OUTPUT,
	@IDImpresion		varchar(36)     OUTPUT,
	@GenerarCFD			bit             OUTPUT,
	@AfectadoEnLinea	bit             OUTPUT
--//WITH ENCRYPTION	     
AS 
BEGIN	     
	DECLARE 
	@IDM							varchar(50),
  @IDR							varchar(50),
	@ToleranciaRedondeo				float,	  
	@Mov							  varchar(20),
	@MovID							varchar(20),
	@MovClave						varchar(20),
	@MovSubClave					varchar(20),
	@CtaDinero						varchar(10),
	@CtaDineroDestino				varchar(10),
	@Caja							varchar(10),
	@Cajero							varchar(10),
	@ImporteMov						float,
	@ImpuestosMov					float,
	@Estatus						varchar(20),
	@ValidarDevolucion				bit,
	@ImporteCobro					float,
	@ReporteImpresora				varchar(50),
	@Host							varchar(20),
	@Cluster						varchar(20),
	@Prefijo						varchar(5),
	@Consecutivo					int,
	@noAprobacion					int,
	@fechaAprobacion				datetime,
	@ImporteLDI						float,
	@MonederoLDI					varchar(20),
	@UsuarioAutoriza				varchar(10),
	@PuedeAutorizar					bit,	  
	@TotalImporte					float,
	@TotalImpuesto1					float,
	@TotalImpuesto2					float,
	@Fecha							datetime,
	@FechaRegistro					datetime,
	@RedondeoMonetarios				int,
	@EsConcentradora				bit,
	@MovCFD							varchar(20),
	@IDNuevo						int,
	@CodigoRedondeo					varchar(50),
	@VentaPreciosImpuestoIncluido	bit,  
	@ArticuloTarjeta				varchar(20),
	@AlmacenTarjeta					varchar(20),
	@ArticuloRedondeo				varchar(20),
	@CadenaOriginal					varchar(max),
    @Sello							varchar(255),
    @Certificado					varchar(20),
    @DocumentoXML					varchar(max), 
    @FechaSello						datetime,
    @ImporteEnCaja					float,
    @MensajeLimiteCaja				bit,
    @Alerta							bit,
    @LimiteCaja						float,
    @Superior						float,
    @LDI							bit,
    @UsuarioPerfil					varchar(10),
    @UsuarioAutorizaPerfil			varchar(10),
    @CantidadD						float, 
    @ArticuloD						varchar(20), 
    @SubCuentaD						varchar(50), 
    @RenglonIDD						int,
    @CantidadSerie					float,
    @MovIDCFD						varchar(20),
    @UUID							varchar(50),
    @FechaTimbrado					datetime,
    @SelloSat						varchar(255),
    @TFDVersion						varchar(10),
    @NoCertificadoSAT				varchar(20),
    @TFDCadenaOriginal				varchar(max),
    @CxcLocal						bit,
    @Condicion						varchar(50),
    @Aplica							varchar(20),
    @AplicaID						varchar(20),
    @ContMoneda						varchar(10),
    @ContMonedaTC					float,
    @SugerirFechaCierre				bit,
    @FechaCierre					datetime,
    @IDDevolucion					varchar(36),
    @IDDevolucionP					varchar(36),
    @Articulo						varchar (20), 
    @Cantidad						float,
    @iSyncNivel						varchar(20),  
    @SubCuenta						varchar(50),
    @ImporteVerificar				float,
    @MensajeLimiteCajaT				varchar(100),
    @GenerarEmbarques  				bit,
    @POSDefMovEmbarque 				varchar(20),
    @IDEst             				varchar(36),
    @MonederoIntelisis				bit,
	@CfgVentaMonederoA				bit

  SET @IDEst = @ID 
  SET @GenerarCFD = 0        
  SET @AfectadoEnLinea = 0

	SELECT @VentaPreciosImpuestoIncluido = ISNULL(VentaPreciosImpuestoIncluido,0), @ArticuloTarjeta= CxcArticuloTarjetasDef ,@AlmacenTarjeta= CxcAlmacenTarjetasDef  
	FROM EmpresaCfg 
	WHERE Empresa = @Empresa  	  
  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)		  

	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
   


  SELECT @FechaRegistro = GETDATE()
  SELECT  @iSyncNivel = ISNULL(NULLIF(CierreiSyncNivel,''),'Sucursal') , @MensajeLimiteCajaT = ISNULL(NULLIF(MensajeLimiteCajaT,''), '   ***  HA EXCEDIDO EL LIMITE PERMITIDO POR FAVOR HAGA UNA RECOLECCIÓN'),
          @ValidarDevolucion = pc.ValidarDevolucion, @LDI = ISNULL(MonederoLDI,0), @CxcLocal = ISNULL(CxcLocal,0), @SugerirFechaCierre = SugerirFechaCierre, @ToleranciaRedondeo = ISNULL(POSToleranciaVta,0.99),
          @GenerarEmbarques = GenerarEmbarques, @POSDefMovEmbarque = POSDefMovEmbarque
     FROM POSCfg pc
    WHERE pc.Empresa = @Empresa
   
  SELECT @MonederoIntelisis = ISNULL(VentaMonedero,0),
		 @CfgVentaMonederoA	= isnull(VentaMonederoA,0)
    FROM EmpresaCfg2
   WHERE Empresa = @Empresa

  IF @CfgVentaMonederoA = 1
	SET @LDI = 0
   
 SELECT @MensajeLimiteCaja = ISNULL(POSMensajeLimiteCaja,0), @LimiteCaja = ISNULL(POSLimiteCaja,0.0)
   FROM Sucursal
  WHERE Sucursal = @Sucursal
  
 SELECT @UsuarioPerfil = NULLIF(POSPerfil,'') FROM Usuario WHERE Usuario = @Usuario  
  
  SELECT @IDImpresion = @ID
  
  SELECT @Saldo = ROUND(@Saldo,@RedondeoMonetarios)	
   
	SELECT 
		@Mov = p.Mov,
	 @MovID = p.MovID,
	 @MovClave = mt.Clave,
	 @MovSubClave = mt.SubClave,
	 @CtaDinero = p.CtaDinero,
	 @CtaDineroDestino = p.CtaDineroDestino,
	 @Caja = p.Caja,
	 @Cajero = p.Cajero,
	 @Estatus = p.Estatus,
	 @UsuarioAutoriza = p.UsuarioAutoriza,
	 @IDR = p.IDR
    FROM POSL p
   INNER JOIN Sucursal s ON p.Sucursal = s.Sucursal
	INNER JOIN MovTipo mt ON mt.Mov = p.Mov AND mt.Modulo = 'POS'
   WHERE p.ID = @ID
   
	SELECT @FechaCierre = Fecha 
	FROM POSFechaCierre 
	WHERE Sucursal = @Sucursal
  
  SELECT @FechaCierre = dbo.fnPOSFechaCierre(@Empresa,@Sucursal,ISNULL(@FechaCierre,GETDATE()),@Caja)
  
  SELECT @Fecha = CASE WHEN @SugerirFechaCierre = 1 THEN @FechaCierre ELSE dbo.fnFechaSinHora(GETDATE())END   
  
	SELECT @UsuarioAutorizaPerfil = NULLIF(POSPerfil,'') 
	FROM Usuario 
	WHERE Usuario = @UsuarioAutoriza 
  
  IF @Cajero IS NULL
    SELECT @Ok = 30490
    
  SELECT @Alerta = Alerta, @Superior = ISNULL(AlertaLimiteSuperior,0.0)
    FROM CtaDinero
   WHERE CtaDinero = @CtaDinero AND Tipo = 'Caja' 
   
   IF ISNULL(@Alerta,0) = 1 AND @Superior > 0.0
     SELECT @LimiteCaja = @Superior
      
  SELECT @ImporteCobro = ROUND(SUM(Importe),@RedondeoMonetarios)
    FROM POSLCobro pc
   WHERE pc.ID = @ID
   
  SELECT /*@ToleranciaRedondeo = ec.CxcAutoAjusteMov, */@ContMoneda = ec.ContMoneda
    FROM EmpresaCfg ec	  
   WHERE ec.Empresa = @Empresa   
   
  SELECT @ContMonedaTC = TipoCambio FROM POSLTipoCambioRef WHERE Sucursal = @Sucursal AND Moneda = @ContMoneda   
    
  IF @MovClave IN ('POS.CPC', 'POS.CPCM', 'POS.CC', 'POS.CCM')
  BEGIN
	SELECT @ImporteVerificar = SUM(ISNULL(Importe,0)) FROM POSLCobro WHERE ID = @ID --AND FormaPago <> 'Monedero'
  
	IF ISNULL(@ImporteVerificar,0) = 0
	BEGIN	
		SELECT @Ok = 30100, @OkRef = 'NO SE PUEDE REALIZAR ESTA OPERACIÓN EN CEROS, DEBE AGREGAR CUANDO MENOS UN CENTAVO EN UNA FORMA PAGO'
		RETURN
	END		
  END
      
  IF @MovClave IN ('POS.N', 'POS.A', 'POS.F','POS.P','POS.NPC','POS.INVD', 'POS.INVA')
  BEGIN
			SELECT @ImporteMov = SUM((plv.Cantidad - ISNULL(plv.CantidadObsequio,0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0)/100))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0)/100))) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),
	   @ImpuestosMov = (SUM(dbo.fnPOSImporteMov(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),plv.Impuesto1,plv.Impuesto2,plv.Impuesto3,plv.Cantidad)) - @ImporteMov)
      FROM POSLVenta plv 
     INNER JOIN POSL p ON p.ID = plv.ID
     WHERE plv.ID = @ID
			
    SELECT @ImporteMov = ROUND(@ImporteMov,@RedondeoMonetarios)	
    SELECT @ImpuestosMov = ROUND(@ImpuestosMov,@RedondeoMonetarios)	

     
    IF (@MovClave IN('POS.N','POS.F','POS.NPC')OR(@MovClave = 'POS.P'  AND @MovSubClave IN('POS.FACCRED','POS.DEVCRED')))AND @MovSubClave NOT IN('POS.PEDCONT')
    BEGIN
      IF EXISTS(SELECT * FROM POSLVenta p JOIN Art a ON p.Articulo = a.Articulo 
                WHERE a.Tipo IN('SERIE','LOTE') AND p.ID = @ID AND a.Articulo <> @ArticuloTarjeta)
      BEGIN
        DECLARE crVentaD CURSOR FOR
         SELECT  ISNULL(p.Cantidad,0.0), p.Articulo, ISNULL(p.SubCuenta,''),p.RenglonID
           FROM POSLVenta p JOIN Art a ON a.Articulo = p.Articulo
          WHERE p.ID = @ID 
            AND a.Tipo IN('SERIE','LOTE')
            AND p.Cantidad >0.0
      
        OPEN crVentaD
        FETCH NEXT FROM crVentaD INTO @CantidadD, @ArticuloD, @SubCuentaD, @RenglonIDD 
        WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
        BEGIN 
									SELECT @CantidadSerie = COUNT(*) 
									FROM POSLSerieLote 
									WHERE Articulo = @ArticuloD AND ISNULL(SubCuenta,'') = ISNULL(@SubCuentaD,'') 
									AND RenglonID = @RenglonIDD AND ID = @ID		
          
          IF ISNULL(@CantidadSerie,0.0) <> ISNULL(@CantidadD,0.0)
            SELECT @Ok = 20320, @OkRef = @ArticuloD
									
          FETCH NEXT FROM crVentaD INTO @CantidadD, @ArticuloD, @SubCuentaD, @RenglonIDD  
        END 
        CLOSE crVentaD
        DEALLOCATE crVentaD       
      END
    END 
  
    IF(SELECT NULLIF(Monedero,'') FROM POSL WHERE ID = @ID) IS NULL
      UPDATE POSLVenta SET Puntos = NULL  WHERE ID = @ID 
  
    --Cuando se requiera validar que los articulos de una devolucion pertenezcan a un mov realizado previamente.
    IF @ValidarDevolucion = 1 AND @ImporteMov < 0 AND @MovClave IN ('POS.N','POS.NPC')
    BEGIN
      IF NOT EXISTS(SELECT * FROM POSLValidarDevolucion plv WHERE plv.ID = @ID) 
      BEGIN
        INSERT POSLAccion (Host, Caja, Accion) 
	           VALUES (@Host, @Caja, 'ORIGEN DEVOLUCION')
        SELECT @Ok = 46020, @OkRef = 'Favor de Ingresar el Folio de la Venta Original'
      END
    END
    
    --Cuando se requiera validar que los articulos de una devolucion pertenezcan a un mov realizado previamente.
    IF @ValidarDevolucion = 1 AND @MovClave IN ('POS.P')AND @MovSubClave = 'POS.DEVCRED'
    BEGIN
      IF NOT EXISTS(SELECT * FROM POSLValidarDevolucion plv WHERE plv.ID = @ID)
      BEGIN
        INSERT POSLAccion (Host, Caja, Accion) 
	           VALUES (@Host, @Caja, 'ORIGEN DEVOLUCION')
        SELECT @Ok = 46020, @OkRef = 'Favor de Ingresar el Folio de la Venta Original'
      END
    END    
    --Cuando es una devolucion o un anticipo se debe ir a un monedero
    IF @MovClave IN ('POS.A') /*OR (@ImporteMov < 0 AND @MovClave IN ('POS.N'))*/ AND @Ok IS NULL
    BEGIN
      SELECT @MonederoLDI = Monedero
        FROM POSLDIMonederoSaldoFavor
       WHERE ID = @ID
      
      IF @MonederoLDI IS NULL
        SELECT @Ok = 53020, @OkRef = 'Es necesario indicar con una acción el Monedero donde se abonará el Saldo a Favor'
        
      SELECT @ImporteLDI = (@ImporteMov + ISNULL(@ImpuestosMov,0)) * (-1)
      
      IF @Ok IS NULL AND @LDI = 1
        EXEC spPOSLDI 'MON ABONO', @ID, @MonederoLDI, @Empresa, @Usuario, @Sucursal, NULL, @ImporteLDI, 1, null, @Ok OUTPUT, @OkRef OUTPUT, 'POS'
        
    END
    
	  IF @Ok IS NULL AND @LDI = 1 AND (SELECT SUM(ISNULL(PUNTOS,0)) FROM POSLVenta WHERE ID = @ID) > 0
	    BEGIN
	      SELECT @MonederoLDI = Monedero  FROM POSL WHERE ID = @ID
	      SELECT @ImporteLDI = SUM(ISNULL(PUNTOS,0)) FROM POSLVenta WHERE ID = @ID
          EXEC spPOSLDI 'MON ABONO', @ID, @MonederoLDI, @Empresa, @Usuario, @Sucursal, NULL, @ImporteLDI, 1, null, @Ok OUTPUT, @OkRef OUTPUT, 'POS'
        END      
    
    --Validaciones que para que se pueda concluir no debe tener saldo.
    IF @Saldo < 0 AND @Ok IS NULL
    BEGIN
      SELECT @Saldo = 0  
    END
      
    IF ISNULL(@Saldo,0) NOT BETWEEN (@ToleranciaRedondeo * (-1)) AND (@ToleranciaRedondeo) AND @MovClave NOT IN ('POS.P','POS.INVD', 'POS.INVA')
      SELECT @Ok = 20370  
    
     --Aqui valida que tenga partidas para afectar, Cuando sea un mov de venta 
    IF NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID) AND @MovClave IN ('POS.N', 'POS.F', 'POS.A','POS.P','POS.NPC','POS.INVD', 'POS.INVA')
      SELECT @Ok = 60010
  END

	IF @MovClave IN ('POS.AC', 'POS.ACM', 'POS.AP', 'POS.CAC', 'POS.CACM', 'POS.CC', 'POS.CCC', 'POS.CCCM', 'POS.CCM', 'POS.CPC', 'POS.CPCM', 
		'POS.CTCAC', 'POS.CTCM', 'POS.CTCRC', 'POS.CTRM', 'POS.EC', 'POS.FTE', 'POS.IC', 'POS.STE', 'POS.TCAC', 'POS.TCM', 'POS.TCM', 'POS.TCRC', 
		'POS.TRM','POS.FA' ) AND @OK IS NULL
  BEGIN
    SELECT @PuedeAutorizar = 1
      FROM POSUsuarioMov pum
     WHERE Usuario = ISNULL(NULLIF(@UsuarioPerfil,''),@Usuario)
       AND Mov = @Mov
       
    IF ISNULL(@PuedeAutorizar,0) = 0
      SELECT @PuedeAutorizar = 1
        FROM POSUsuarioMov pum
       WHERE Usuario = ISNULL(NULLIF(@UsuarioAutorizaPerfil,''),@UsuarioAutoriza)
         AND Mov = @Mov
 
    IF ISNULL(@PuedeAutorizar,0) = 0
      SELECT @Ok = 3
    
    IF @CtaDinero IS NULL AND @Ok IS NULL
      SELECT @Ok = 40120
   
    IF @CtaDineroDestino IS NULL AND @Ok IS NULL AND @MovClave NOT IN ('POS.FA','POS.CXCC','POS.CXCD' )
      SELECT @Ok = 40040
  
    IF ISNULL(@ImporteCobro,0) < 0 AND @Ok IS NULL
      SELECT @OK = 30100
      
    IF @MovClave IN('POS.CXCC','POS.CXCD') AND @Ok IS NULL
    BEGIN
					SELECT TOP 1 @Aplica = Aplica, @AplicaID = AplicaID 
					FROM POSLVenta 
					WHERE ID = @ID
      
      IF NULLIF(@Aplica,'') IS NULL OR NULLIF(@AplicaID,'')IS NULL
        SELECT @Ok = 30210
    END
    
    IF NOT EXISTS(SELECT * FROM POSLCobro WHERE ID = @ID) AND @Ok IS NULL
      SELECT @OK = 30100 , @OkRef = @OkRef +'Es Necesario Capturar Un Importe'   
    
    IF @MovClave IN ('POS.AC','POS.ACM','POS.CCC','POS.CCCM')
    BEGIN
      EXEC spPOSEstatusCaja @CtaDineroDestino, @Host, @Cajero, @Usuario,  1, NULL, @ok OUTPUT, @OkRef OUTPUT
					
      IF @Ok IS NULL
        EXEC spPOSCambiarFechaEmision  @ID, @Empresa, @Sucursal, @Host, @Caja, @ok OUTPUT, @OkRef OUTPUT
    END
  
    IF @MovClave IN ('POS.CC','POS.CCM','POS.CAC','POS.CACM')
    BEGIN
      EXEC spPOSEstatusCaja @CtaDinero, @Host, @Cajero, @Usuario, 0, NULL,  @ok OUTPUT, @OkRef OUTPUT
					
      IF EXISTS(SELECT * FROM POSCFDFlexPendiente)
        SELECT @Ok = 35250, @OkRef = ' DE GENERAR CFD'
					
      IF @Ok IS NULL        
        EXEC spPOSValidarCierresCaja @ID, @Empresa, @Sucursal, @Host, @Caja, @ok OUTPUT, @OkRef OUTPUT  
    END
    
    IF @MovClave IN ('POS.CPC','POS.CPM','POS.FA','POS.AP','POS.CXCC','POS.CXCD' )
    BEGIN
      IF NOT EXISTS(SELECT * FROM POSEstatusCaja WHERE Caja = @Caja)
      SELECT @Ok = 30440, @OkRef = @Caja   
      
      IF (SELECT Abierto FROM POSEstatusCaja WHERE Caja = @Caja) = 0
      SELECT @Ok =30440, @OkRef = @Caja              
				END    
    
    IF @MovClave IN ('POS.TRM','POS.TCM' )
    BEGIN
      IF NOT EXISTS(SELECT * FROM POSEstatusCaja WHERE Caja = @CtaDineroDestino)
      SELECT @Ok = 30440, @OkRef = @CtaDineroDestino   
      
      IF (SELECT Abierto FROM POSEstatusCaja WHERE Caja = @Caja) = 0 AND @iSyncNivel = 'Sucursal'
      SELECT @Ok =30440, @OkRef = @Caja              
    END      

			--GENERA FALTANTE O SOBRANTE DE CAJA EN EL MOVIMIENTO CORTE 
    IF @MovClave IN ('POS.CC','POS.CCM','POS.CAC','POS.CACM') AND @Ok IS NULL
    BEGIN
      SELECT @EsConcentradora = ISNULL(EsConcentradora,0) FROM CtaDinero WHERE CtaDinero = @CtaDinero
      
      IF @MovClave IN ('POS.CC','POS.CCM') AND @Ok IS NULL				               
        EXEC spPOSGeneraFaltante @Empresa, @Sucursal, @Usuario, @ID, @MovClave, @Caja, @Ok OUTPUT, @OkRef OUTPUT
    END
  END
  
  IF @MovClave IN('POS.AC','POS.ACM','POS.AP')
    SELECT @Caja = Caja FROM POSL WHERE ID = @ID
    
	--RECARGAS TEL LDI  
  IF EXISTS (SELECT * FROM POSLDIRecargaTemp WHERE ID = @ID) AND @Ok IS NULL
  BEGIN
    EXEC spPOSLDIRecargaTelefonica @ID, @Ok OUTPUT, @OkRef OUTPUT  
   
    IF @OK IS NULL 
      SELECT @Mensaje = 'RECARGA EXITOSA  <BR>'
  END 

	--PAGO SERVICIOS LDI
  IF EXISTS (SELECT * FROM POSLDIPagoServicioTemp WHERE ID = @ID) AND @Ok IS NULL
  BEGIN
    EXEC spPOSLDIPagoServicio @ID, @Ok OUTPUT, @OkRef OUTPUT     
		
    IF @OK IS NULL 
      SELECT @Mensaje = 'PAGO EXITOSO  <BR>'
  END 
  
	--SE DEFINE EL FOLIO Y SE INSERTA Y SE CONCLUYE EL MOV
	IF @MovClave IN ('POS.N', 'POS.A', 'POS.F', 'POS.AC','POS.AP', 'POS.CC', 'POS.CPC','POS.P','POS.ACM','POS.CCM','POS.CPCM',
		'POS.TCM','POS.TCAC','POS.CTCAC', 'POS.CAC','POS.CACM','POS.CCC','POS.CCCM','POS.CTCM','POS.IC','POS.EC','POS.TRM', 
		'POS.CTRM','POS.CTCRC','POS.NPC','POS.FA','POS.INVD', 'POS.INVA','POS.CXCC','POS.CXCD' ) AND @OK IS NULL
  BEGIN
    IF @MovID IS NULL OR @Estatus IN ('PORCOBRAR', 'SINAFECTAR','PENDIENTE')
    BEGIN
      IF @MovID IS NULL
      BEGIN
							EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @Mov, 
							@MovID OUTPUT, @Prefijo OUTPUT, @Consecutivo OUTPUT, @noAprobacion OUTPUT, @FechaAprobacion OUTPUT, @Ok OUTPUT, @OkRef OUTPUT        
      END
      
					UPDATE POSL SET 
						MovID = ISNULL(MovID, @MovID),
 	        Prefijo = ISNULL(Prefijo, @Prefijo),
 	        Consecutivo = ISNULL(Consecutivo, @Consecutivo),
 	        noAprobacion = ISNULL(noAprobacion, @NoAprobacion),
 	        fechaAprobacion = ISNULL(fechaAprobacion, @fechaAprobacion),
 	        Estatus = 'CONCLUIDO',
 	        FechaEmision = @Fecha,
 	        FechaRegistro = @FechaRegistro
       WHERE ID = @ID 
    
					-- SI ES DEVOLUCION, SE MARCA LA NOTA ORIGEN PARA NO PERMITIR LA GENERACION DE OTRA DEVOLUCION PARA LA MISMA NOTA.
  	SELECT @IDDevolucion = NULLIF(IDDevolucion,''), @IDDevolucionP = NULLIF(IDDevolucionP,'') FROM POSL WHERE ID = @ID

	UPDATE POSLCobro SET Importe = ImporteRef WHERE ID = @ID AND ImporteRef <> 0 AND Importe = 0
		
	IF @IDDevolucion IS NOT NULL
	BEGIN
	UPDATE POSL SET Devolucion = 1 WHERE ID = @IDDevolucion	
	UPDATE POSLVenta SET CantidadSaldo = 0 WHERE ID = @IDDevolucion
	END
	
	IF @IDDevolucionP IS NOT NULL
	BEGIN
    DECLARE @Contador INT, @CantidadSaldoSum float
							UPDATE POSL SET DevolucionP = 1 WHERE ID = @IDDevolucionP
  
		DECLARE crSE1 CURSOR LOCAL FOR			
         SELECT Articulo, SUM(Cantidad), NULLIF(SubCuenta,'')  
		   FROM POSLVenta 
		  WHERE ID = @ID
          GROUP BY  Articulo, NULLIF(SubCuenta,'')
		   
		   OPEN crSE1
          FETCH NEXT FROM crSE1 INTO @Articulo, @Cantidad, @SubCuenta  
		  WHILE @@FETCH_STATUS <> -1 
		  BEGIN
			IF @@FETCH_STATUS <> -2 
			BEGIN
											SELECT @Contador = COUNT (1), @CantidadSaldoSum = sum(isnull(CantidadSaldo,0))  
											FROM POSLVenta 
											WHERE ID = @IDDevolucionP AND Articulo = @Articulo AND NULLIF(SubCuenta,'') = @SubCuenta
    
	          SELECT @CantidadSaldoSum = (@CantidadSaldoSum + @Cantidad) / @Contador    
     
											UPDATE POSLVenta SET CantidadSaldo = @CantidadSaldoSum 
											WHERE ID = @IDDevolucionP AND Articulo = @Articulo AND NULLIF(SubCuenta,'') = @SubCuenta   
			END
			
			FETCH NEXT FROM crSE1 INTO @Articulo, @Cantidad, @SubCuenta
		  END
		CLOSE crSE1
		DEALLOCATE crSE1
	END

	UPDATE POSLVenta SET CantidadSaldo = Cantidad WHERE ID = @ID
    END
      
    IF @MovClave IN('POS.INVD', 'POS.INVA')
    BEGIN
      INSERT POSLInv(
						ID, Renglon, RenglonSub, RenglonID, RenglonTipo, Aplica, AplicaID, Cantidad, Articulo, SubCuenta, 
						Unidad, Factor, CantidadInventario, Almacen, Codigo, Precio)
      SELECT         
						ID, Renglon, RenglonSub, RenglonID, RenglonTipo, Aplica, AplicaID, Cantidad, Articulo, SubCuenta, 
						Unidad, Factor, CantidadInventario, NULL, Codigo, Precio
        FROM POSLVenta
       WHERE ID = @ID 
      
      IF @@ERROR <> 0 SET @Ok = 1 
      
      IF @Ok IS NULL
        DELETE POSLVenta WHERE ID = @ID
    END 
      
    DELETE POSLValidarDevolucion WHERE ID = @ID
  END
  
	--AQUI SE ACTUALIZA EL IMPORTE Y LOS IMPUESTOS
  IF @Ok IS NULL AND @MovClave IN ('POS.N', 'POS.A', 'POS.F','POS.P','POS.NPC','POS.INVD', 'POS.INVA') AND @OK IS NULL
  BEGIN
			SELECT @TotalImporte = SUM(dbo.fnPOSImporte(plv.Cantidad, plv.CantidadObsequio, plv.Precio, plv.DescuentoLinea, 
				CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 
						THEN ISNULL(p.DescuentoGlobal,0.0) 
					 ELSE 0 
					 END, plv.Articulo, p.Empresa)),
				@TotalImpuesto2 = SUM(dbo.fnPOSImporteMov(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * (
				CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 
						THEN ISNULL(p.DescuentoGlobal,0.0) 
					 ELSE 0 
					 END)/100))),plv.Impuesto1,plv.Impuesto2,plv.Impuesto3,plv.Cantidad)),
           @TotalImpuesto1 = CONVERT(money,CONVERT(varchar, CONVERT(money, ISNULL(@TotalImpuesto2,0.0)), 104))-@TotalImporte
      FROM POSL p
     INNER JOIN POSLVenta plv ON p.ID = plv.ID
     WHERE plv.ID = @ID
     
			SELECT @Condicion = NULLIF(Condicion,'') 
			FROM POSL 
			WHERE ID = @ID
			
			UPDATE POSL Set Importe = ROUND(@TotalImporte,@RedondeoMonetarios), Impuestos = ROUND(@TotalImpuesto1,@RedondeoMonetarios)  
			WHERE ID = @ID
  END

  IF @Ok IS NULL AND @MovClave = 'POS.N' AND @MovSubClave = 'POS.PEDCONT'
    IF NULLIF(@Condicion,'') IS NULL OR @Condicion NOT IN (SELECT Condicion FROM Condicion WHERE ControlAnticipos = 'Cobrar Pedido')
      SELECT @Ok = 20880
  
    IF @Ok IS NULL AND @MovClave = 'POS.P' AND @MovSubClave = 'POS.DEVCRED'
    IF NULLIF(@Condicion,'') IS NULL OR @Condicion NOT IN (SELECT Condicion FROM Condicion WHERE TipoCondicion = 'Credito')
      SELECT @Ok = 20700

	--SI TIENE ANTICIPOS SE AFECTA EN LINEA
	IF @Ok IS NULL AND (@MovClave IN ('POS.F','POS.N') 
		AND (SELECT ISNULL(AnticipoFacturadoTipoServicio,0) FROM POSL WHERE ID = @ID)= 1)
  OR (@MovClave  = 'POS.P' AND @MovSubClave = 'POS.FACCRED')OR (@MovClave  = 'POS.P' AND @MovSubClave = 'POS.DEVCRED')
  BEGIN
    IF @Ok IS NULL AND  @CxcLocal = 0
      UPDATE POSL Set Estatus = 'CONFIRMAR'  WHERE ID = @ID
    
    IF @MovClave IN ('POS.F','POS.N', 'POS.P') AND EXISTS(SELECT * FROM POSLCobro WHERE ID = @ID) 
		IF NOT EXISTS(SELECT * FROM POSVentaCobro WHERE ID = @ID) 
      EXEC spPOSInsertarPOSVentaCobro @ID, @Empresa,@Sucursal, @Ok OUTPUT, @OkRef OUTPUT  
      
			IF @MovClave IN ('POS.P') AND @MovSubClave = 'POS.FACCRED' 
				AND NOT EXISTS(SELECT * FROM POSVentaCobro WHERE ID = @ID) AND EXISTS (SELECT * FROM POSLCobro WHERE ID = @ID)  
				EXEC spPOSInsertarPOSVentaCobro @ID, @Empresa,@Sucursal, @Ok OUTPUT, @OkRef OUTPUT    
    
    IF @MovClave  = 'POS.P' AND @MovSubClave = 'POS.FACCRED'
      DELETE POSCxcAnticipoTemp  WHERE Estacion = @Estacion    
  
    IF @OK IS NULL AND @CxcLocal = 0
      EXEC spPOSWSSolicitudAfectarVenta  @ID, @Empresa, @Estacion, @Sucursal, @Usuario, @Ok OUTPUT, @OkRef OUTPUT
      
    IF @OK IS NULL AND @CxcLocal = 1
      EXEC spPOSSolicitudAfectarVentaLocal  @ID, @Empresa, @Estacion, @Sucursal, @Usuario, @Ok OUTPUT, @OkRef OUTPUT      

    IF @Ok IS NULL AND  @CxcLocal = 0 AND (@MovClave IN('POS.N')OR (@MovClave  = 'POS.P' AND @MovSubClave = 'POS.DEVCRED'))
--      UPDATE POSL Set Estatus = 'TRASPASADO'  WHERE ID = @ID
      UPDATE POSL Set Estatus = 'CONCLUIDO'  WHERE ID = @ID

	IF @MovClave = 'POS.N' AND (SELECT ISNULL(AnticipoFacturadoTipoServicio,0) FROM POSL WHERE ID = @ID)= 1
    	UPDATE POSL Set Estatus = 'TRASPASADO' WHERE ID = @ID
      
    IF @Ok IS NULL AND  @CxcLocal = 1 AND @MovClave IN('POS.N')
      UPDATE POSL Set AfectadoLocal = 1  WHERE ID = @ID   
      
    IF @Ok IS NULL AND @MovClave IN('POS.F','POS.P')
    SET  @AfectadoEnLinea  = 1
  END

  IF (@MovClave = 'POS.F' OR (@MovClave  = 'POS.P' AND @MovSubClave = 'POS.FACCRED')) AND @OK IS NULL
  BEGIN 
    SELECT @GenerarCFD = 1
  END

	IF @Ok IS NULL AND @MovClave IN ('POS.AC', 'POS.ACM', 'POS.AP', 'POS.CAC', 'POS.CACM', 'POS.CC', 'POS.CCC', 'POS.CCCM', 'POS.CCM', 
		'POS.CPC', 'POS.CPCM', 'POS.CTCAC', 'POS.CTCM', 'POS.CTCRC', 'POS.CTRM', 'POS.EC', 'POS.FTE', 'POS.IC', 'POS.STE', 'POS.TCAC', 
		'POS.TCM', 'POS.TCM', 'POS.TCRC', 'POS.TRM') AND @OK IS NULL
  BEGIN
    SELECT @TotalImporte = SUM(c.Importe)
      FROM POSL p
     INNER JOIN POSLCobro c ON p.ID = c.ID
     WHERE c.ID = @ID

    IF @MovSubClave = 'POS.FACCRED' AND @CxcLocal = 0
    	UPDATE POSL Set Estatus = 'TRASPASADO' WHERE ID = @ID

    UPDATE POSL Set Importe = ROUND(@TotalImporte,@RedondeoMonetarios) WHERE ID = @ID
  END
  
  IF @MovClave IN ('POS.TCM','POS.CTCM') AND @Ok IS NULL
    EXEC spPOSGeneraAbonoCaja @Empresa, @Sucursal, @Usuario, @ID, @MovClave, @Ok OUTPUT, @OkRef OUTPUT  
    
  IF @Ok IS NULL AND @MovClave IN ('POS.TRM','POS.CTRM' )
    EXEC spPOSGeneraRetiroCaja @Empresa, @Sucursal, @Usuario, @ID, @MovClave, @Ok OUTPUT, @OkRef OUTPUT   

	--AQUI GENERA UN MOVIMIENTO NUEVO UNA VEZ CONCLUIDO EL ANTERIOR Y SE ELIMINA EL ANTERIOR
  IF @Ok IS NULL
  BEGIN
			INSERT POSLAuxiliar (
				IDL, ID, Rama, FormaPago, Importe, Referencia, EsCancelacion)
			SELECT 
				NEWID(), ID, 'CAJA', FormaPago, Importe, Referencia, 0
		    FROM POSLCobro
		   WHERE ID = @ID
    
    IF EXISTS(SELECT * FROM POSLPorCobrar WHERE ID = @IDR AND Estatus = 'PORCOBRAR')
      UPDATE 	POSLPorCobrar SET Estatus = 'TRASPASADO' WHERE ID = @IDR	
    
    IF @Ok IS NULL
    BEGIN
					IF EXISTS(SELECT * FROM POSL p JOIN MovTipo m ON m.Mov = p.Mov AND m.Modulo = 'POS' 
							  WHERE m.Clave = 'POS.NPC' AND p.Estatus = 'PORCOBRAR' AND p.ID IN (SELECT ID FROM POSLPorCobrar WHERE Estatus = 'TRASPASADO'))   
        UPDATE POSL SET Estatus = 'TRASPASADO'
          FROM POSL p JOIN MovTipo m ON m.Mov = p.Mov AND m.Modulo = 'POS'  
         WHERE m.Clave = 'POS.NPC' AND p.Estatus = 'PORCOBRAR' AND p.ID IN (SELECT ID FROM POSLPorCobrar WHERE Estatus = 'TRASPASADO') 
    END              

    DELETE FROM POSLArtSeleccionado WHERE ID = @ID
			
    EXEC spPOSMovNuevo @Empresa, @Modulo, @Sucursal, @Usuario, @Estacion, @ID OUTPUT, @Imagen OUTPUT, @IDImpresion
    
    DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
			
    SELECT @Mensaje = ISNULL(@Mensaje,'')+'MOVIMIENTO CONCLUIDO CON EXITO'
    
			--AQUI VALIDA QUE NO EXCEDA EL SALDO DE LA CAJA EN DICHA FORMA DE PAGO    
    IF @MovClave IN('POS.N','POS.F','POS.NPC')
    BEGIN
      SELECT @ImporteEnCaja = SUM((plc.Importe*plc.TipoCambio) * mt.Factor)
        FROM POSLCobro plc 
       INNER JOIN POSL p ON plc.ID = p.ID
       INNER JOIN MovTipo mt ON p.Mov = mt.Mov  AND mt.Modulo = 'POS'      			   
       JOIN FormaPago f ON plc.FormaPago = f.FormaPago
       WHERE f.Recoleccion = 1       
					AND (CASE WHEN mt.Clave IN('POS.AC','POS.AP','POS.ACM','POS.IC','POS.EC') 
								THEN p.CtaDineroDestino 
		ELSE plc.Caja
	    END) = @Caja
	    
      IF ISNULL(@ImporteEnCaja,0.0) >= @LimiteCaja AND @MensajeLimiteCaja = 1
        SELECT @Mensaje = @Mensaje +' , '+ UPPER(@MensajeLimiteCajaT)
    END
  END

  IF @MovClave IN ('POS.CXCC') AND @Ok IS NULL
	EXEC xpPOSConcluirCobroCredito @IDImpresion, @Empresa

  IF @MovClave IN ('POS.CC', 'POS.CCM')
	EXEC spPOSMovEliminarNoc @Usuario
               
	--AQUI SE MANDA UNA EXPRESION EN CASO QUE ESTE CONFIGURADO ALGUN MOVIMIENTO PARA LA IMPRESION
  IF @Ok IS NULL
  BEGIN
    DELETE FROM POSLArtSeleccionado WHERE ID = @ID


------------ M o v i m i e n t o   E s t a d i s t i c o   p a r a    E m b a r q u e s.---------
  IF @MovClave IN ('POS.N') AND @GenerarEmbarques = 1 AND NULLIF(@POSDefMovEmbarque,'') IS NOT NULL AND @Ok IS NULL 
	BEGIN
    EXEC spPOSGeneraEstadisticoEmbarque @Empresa, @Modulo, @Sucursal, @Usuario, @Estacion, @IDEst, @IDEst, @POSDefMovEmbarque, @ContMoneda, @ContMonedaTC, @ArticuloTarjeta, @AlmacenTarjeta, @VentaPreciosImpuestoIncluido, @Ok OUTPUT, @OkRef OUTPUT   
  END
--------------------------------------
			
    SELECT TOP 1 @ReporteImpresora = ecmi.ReporteImpresora
      FROM EmpresaCfgMovImp ecmi
     WHERE Modulo = 'POS'
       AND Mov = @Mov
       AND Empresa = @Empresa
    
			/***** SE ENVIA DOS VECES LA IMPRESION DE LOS CORTES Y APERTURAS DE CAJA*****/
			IF @MovClave IN ('POS.AC', 'POS.ACM', 'POS.AP', 'POS.CAC', 'POS.CACM', 'POS.CC', 'POS.CCC', 'POS.CCCM', 'POS.CCM', 'POS.CPC', 'POS.CPCM', 
				'POS.CTCAC', 'POS.CTCM', 'POS.CTCRC', 'POS.CTRM', 'POS.EC', 'POS.FTE', 'POS.IC', 'POS.STE', 'POS.TCAC', 'POS.TCM', 'POS.TCM', 'POS.TCRC', 
				'POS.TRM','POS.P') AND NULLIF(@ReporteImpresora,'') IS NOT NULL
				SELECT @Expresion = 'ReporteImpresora(''' +@ReporteImpresora +''', ''' + @IDImpresion + ''')'+'ReporteImpresora(''' + 
					@ReporteImpresora +''', ''' + @IDImpresion + ''')'

			IF @MovClave NOT IN ('POS.AC', 'POS.ACM', 'POS.AP', 'POS.CAC', 'POS.CACM', 'POS.CC', 'POS.CCC', 'POS.CCCM', 'POS.CCM', 'POS.CPC', 'POS.CPCM', 
				'POS.CTCAC', 'POS.CTCM', 'POS.CTCRC', 'POS.CTRM', 'POS.EC', 'POS.FTE', 'POS.IC', 'POS.STE', 'POS.TCAC', 'POS.TCM', 'POS.TCM', 'POS.TCRC', 
				'POS.TRM', 'POS.P') AND NULLIF(@ReporteImpresora,'') IS NOT NULL
      SELECT @Expresion = 'ReporteImpresora(''' +@ReporteImpresora +''', ''' + @IDImpresion + ''')'
  END
END
GO


/************************ spPOSLDIFormaPagoFormaAnexa *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDIFormaPagoFormaAnexa') AND type = 'P') DROP PROCEDURE dbo.spPOSLDIFormaPagoFormaAnexa
GO             
CREATE PROCEDURE spPOSLDIFormaPagoFormaAnexa
	@Codigo		varchar(50),
	@ID			varchar(36),
	@Empresa	varchar(5)
--//WITH ENCRYPTION	     
AS 
BEGIN	     
	DECLARE 
	@FormaPago	varchar(50),
	@Forma		varchar(50),
	@Caja	    varchar(10),
	@Ok			int
	  
	SELECT @Caja = CtaDinero
    FROM POSL
	WHERE ID = @ID
   
	IF ISNULL((SELECT Abierto FROM POSEstatusCaja WHERE Caja = @Caja),0) <> 1
		SELECT @Ok = 30440
    
	SELECT @FormaPago = FormaPago
    FROM CB
	WHERE CB.Codigo = @Codigo
 
	IF @Ok IS NULL   	  
		SELECT @Forma = plfp.Forma
		FROM POSLDIFormaPago plfp
		WHERE plfp.FormaPago = @FormaPago	  
    
	SELECT @Forma
END
GO


/************************ spPOSVFAFormaPago *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSVFAFormaPago') AND type = 'P') DROP PROCEDURE dbo.spPOSVFAFormaPago
GO             
CREATE PROCEDURE spPOSVFAFormaPago
	@Codigo		varchar(50),
	@ID			varchar(36)
--//WITH ENCRYPTION	     
AS 
BEGIN	     
	DECLARE 
	@FormaPago	varchar(50),
	@Forma		varchar(50),
	@Caja	    varchar(10),
	@Ok			int
	  
	SELECT @Caja = CtaDinero
    FROM POSL
	WHERE ID = @ID
  
	IF ISNULL((SELECT Abierto FROM POSEstatusCaja WHERE Caja = @Caja),0) <> 1
		SELECT @Ok = 30440
    
	SELECT @FormaPago = FormaPago
    FROM CB
	WHERE CB.Codigo = @Codigo
 
	IF @Ok IS NULL AND NULLIF(@FormaPago,'') IS NOT NULL AND EXISTS(SELECT * FROM POSVFAFormaPago WHERE FormaPago = @FormaPago)	  
		SELECT @Forma   = @FormaPago
    
	SELECT @Forma
END
GO


/************************ spPOSAccionEjecutar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAccionEjecutar') AND type = 'P') DROP PROCEDURE dbo.spPOSAccionEjecutar
GO             
CREATE PROCEDURE spPOSAccionEjecutar
	@Estacion				int,
    @Empresa				varchar(5),
    @Sucursal				int,
    @Modulo					varchar(5),
    @Usuario				varchar(10),
    @Caja					varchar(10),
    @ID						varchar(50)			OUTPUT,
    @Codigo					varchar(50)			OUTPUT,
    @Accion					varchar(50)			OUTPUT,
    @CodigoAccion			varchar(50)			OUTPUT,
    @Referencia				varchar(50)			OUTPUT,
    @Importe				float				OUTPUT,
    @MovClave				varchar(20)			OUTPUT,
    @CtaDinero				varchar(20)			OUTPUT,
    @Mensaje				varchar(255)		OUTPUT,
    @Cajero					varchar(20)			OUTPUT,
    @SerieLote				varchar(50)			OUTPUT,
    @Articulo				varchar(20)			OUTPUT,
    @SubCuenta				varchar(50)			OUTPUT,
    @Cantidad				float				OUTPUT,
    @CantidadOriginal		float				OUTPUT,
    @RenglonUbicado			float				OUTPUT,
    @ArtConsulta			varchar(20)			OUTPUT,
    @AgruparArticulos		bit,
    @Mov					varchar(20)			OUTPUT,
    @FechaEmision			dateTime			OUTPUT,
    @Concepto				varchar(50)			OUTPUT,
    @Agente					varchar(10)			OUTPUT,
    @UEN					int					OUTPUT,
    @Moneda					varchar(10)			OUTPUT,
    @TipoCambio				float				OUTPUT,
    @Proyecto				varchar(50)			OUTPUT,
    @Cliente				varchar(10)			OUTPUT,
    @Condicion				varchar(50)			OUTPUT,
    @Almacen				varchar(10)			OUTPUT,
    @FormaEnvio				varchar(50)			OUTPUT,
    @Vencimiento			dateTime			OUTPUT,
    @ListaPreciosEsp		varchar(20)			OUTPUT,
    @Descuento				varchar(30)			OUTPUT,
    @ArtDescripcion			varchar(100)		OUTPUT,
    @DescuentoGlobal		float				OUTPUT,
    @Imagen					varchar(255)		OUTPUT,
    @ZonaImpuesto			varchar(30)			OUTPUT,	
    @ImporteSaldoaFavor		float				OUTPUT,    	         	         	     
    @Ok						int					OUTPUT,
    @OkRef					varchar(255)		OUTPUT,
    @Expresion				varchar(255) = NULL OUTPUT,
    @TorretaMensaje1		varchar(20) = NULL	OUTPUT,
	@TorretaMensaje2		varchar(20) = NULL	OUTPUT,
	@TorretaPosicion1		varchar(20) = NULL	OUTPUT,
	@TorretaPosicion2		varchar(20) = NULL	OUTPUT,
	@MovSubClave			varchar(20)  = NULL	OUTPUT
--//WITH ENCRYPTION	     
AS BEGIN
	DECLARE 
	@CantidadContador			float,
	@Peso						float,
	@BasculaPesar				float,
	@FormaPago					varchar(50),
	@Unidad						varchar(50),
	@MovID						varchar(20),
	@Estatus					varchar(20),	  
	@Host						varchar(20),
	@Cluster					varchar(20),
	@EsDevolucion				bit,
	@SerieLoteCancelarPartida	bit,
	@IDL						varchar(50),
	@ArtTipo					varchar(20),
	@MonedaPrincipal			varchar(20),
	@RedondeoMonetarios			int,
	@RenglonID					int,
	@Beneficiario				varchar(100),
	@UsuarioPerfil				varchar(10),
	@MonedaFormaPago			varchar(10),
	@CheckSumEO					bigint,
	@CheckSumE					bigint,
	@CheckSumDO					bigint,
	@CheckSumD					bigint,
	@Orden						int,
	@AlmacenD					varchar(10),
	@CondicionPedidoContado		varchar(50),
	@WebService					bit,
	@NoExiste					bit,
	@CajeroActual				varchar(10),
	@SugerirFechaCierre			bit, 
	@FechaCierre				datetime,
	@POSMonedaAct				bit,
	@IDDevolucionP				varchar(36),
	@Renglon					float,
	@CantidadCodigo				float,
	@NoAfectarSerieLote			bit,
	@FormaEnvioV				varchar(50),
	@MovNC						varchar(20)
	  
	SELECT  @IDDevolucionP = NULLIF(IDDevolucionP,'') 
	FROM POSL 
	WHERE ID = @ID
	  
	SELECT @POSMonedaAct = POSMonedaAct 
	FROM POSCfg 
	WHERE Empresa = @Empresa	  
  
	SELECT @SugerirFechaCierre = SugerirFechaCierre   
	FROM POSCfg 
	WHERE Empresa = @Empresa
  
	SELECT @FechaCierre = Fecha 
	FROM POSFechaCierre 
	WHERE Sucursal = @Sucursal
  
	SELECT @FechaCierre = dbo.fnPOSFechaCierre(@Empresa,@Sucursal,@FechaCierre,@Caja)  
	  
	SELECT @NoExiste = 1	  
	  
	SELECT @WebService = WebService 
	FROM POSCfg 
	WHERE Empresa = @Empresa
	
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)	
	SELECT @UsuarioPerfil = NULLIF(POSPerfil,'') 
	FROM Usuario 
	WHERE Usuario = @Usuario
  
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT	  
  
	--INTRODUCIR REFERENCIA POR FORMA DE PAGO ESPECIFICADA EN LA ACCION ANTERIOR
	IF @Accion = 'MODIFICAR COMPONENTE' AND @Ok IS NULL
		BEGIN
			SELECT @RenglonID = RenglonID, @Articulo = Articulo
			FROM POSTempArtJuego
			WHERE RID = @ID AND Estacion = @Estacion AND ID = @Codigo 
  
			SELECT  @Cantidad = Cantidad FROM POSLVenta WHERE ID = @ID AND RenglonID = @RenglonID AND RenglonTipo = 'J'
    
			IF NOT EXISTS(SELECT * FROM ArtJuego WHERE Articulo = @Articulo AND Opcional = 1)
				SELECT @Ok = 20626
      
			IF NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND RenglonID = @RenglonID AND RenglonTipo = 'J')
				SELECT @Ok = 20336      
    
			IF @Ok IS NULL
				BEGIN
					DELETE POSArtJuegoComponente WHERE Estacion = @Estacion
      
					INSERT POSArtJuegoComponente(
						Estacion, RID, RenglonID, Articulo, ArtSubCuenta, Juego, Componente, Opcion, SubCuenta, 
						Opcional, Cantidad, Recalcular,CantidadComponente)
					SELECT
						@Estacion, @ID, @RenglonID, j.Articulo, 
							CASE WHEN NULLIF(j.SubCuenta,'') IS NOT NULL 
									THEN j.Opcion+' ('+j.SubCuenta+')' 
								 ELSE j.Opcion 
								 END, j.Juego, d.Descripcion, j.Opcion, j.SubCuenta, 
						ISNULL(d.Opcional,0), 1, 1, @Cantidad
					FROM ArtJuegoOmision j 
					JOIN ArtJuego d ON j.Articulo = d.Articulo AND j.Juego = d.Juego 
					WHERE j.Articulo = @Articulo 
					GROUP BY d.Descripcion, d.Opcional, j.Articulo,  j.Opcion, j.SubCuenta ,j.Juego  
         
					DELETE POSLVenta WHERE ID = @ID AND RenglonID = @RenglonID AND  RenglonTipo = 'C'
      
					IF @@ERROR <> 0 
						SET @Ok = 1
      
					IF @Ok IS NULL
						SELECT @Expresion = 'FormaModal('+CHAR(39)+'POSArtJuegoComponente'+CHAR(39)+')'
				END
		END

	-- INTRODUCIR EL PESO
	IF @Accion = 'PESAR'	
		BEGIN  
			IF (SELECT dbo.fnEsNumerico(@Codigo)) = 0 OR LEN(@Codigo)>=10
				SELECT @Ok = 20010, @OkRef = @Codigo +' FAVOR DE INTRODUCIR EL PESO'
			ELSE
				SELECT @Peso = @Codigo

			IF (SELECT dbo.fnEsNumerico(@Codigo)) = 1 AND (CONVERT(float,(ISNULL(NULLIF(@Codigo,''),'0.0'))) = 0 OR LEN(@Codigo)>=10)
				SELECT @Ok = 20010, @OkRef = @Codigo +' FAVOR DE INTRODUCIR EL PESO'
       
			EXEC spPOSLVerArtSeleccionado @ID, @Articulo OUTPUT, @SubCuenta OUTPUT, @CantidadOriginal OUTPUT, @Unidad OUTPUT, NULL
    
			SELECT 
				@Mov = p.Mov, 
				@MovID = p.MovID,
				@Estatus = p.Estatus,
				@FechaEmision = p.FechaEmision, 
				@Concepto = p.Concepto, 
				@UEN  = p.UEN, 
				@Proyecto = p.Proyecto, 
				@Moneda = p.Moneda,
				@TipoCambio = p.TipoCambio, 
				@Cliente = p.Cliente,
				@Almacen = p.Almacen, 
				@Agente = p.Agente, 
				@Cajero = p.Cajero, 
				@FormaEnvio = p.FormaEnvio, 
				@Condicion = p.Condicion,
				@Vencimiento = p.Vencimiento, 
				@CtaDinero = p.CtaDinero, 
				@Descuento = p.Descuento, 
				@DescuentoGlobal = p.DescuentoGlobal,
				@ListaPreciosEsp = p.ListaPreciosEsp, 
				@ZonaImpuesto = p.ZonaImpuesto, 
				@Sucursal = p.Sucursal
			FROM POSL p
			WHERE ID = @ID  

			SELECT @Codigo = MAX(Codigo)
			FROM CB
			WHERE TipoCuenta = 'Articulos' 
			AND Cuenta = @Articulo
			AND ISNULL(SubCuenta, '') = ISNULL(@SubCuenta, '')
			AND Unidad = ISNULL(@Unidad,Unidad)
    
			SELECT @BasculaPesar = a.BasculaPesar
			FROM Art a
			WHERE a.Articulo = @Articulo
    
			IF ISNULL(@BasculaPesar,0) = 0
				SELECT @Ok = 73040, @OkRef = 'El Articulo no esta configurado para pesarse'

			IF @Ok IS NULL 
				BEGIN
					EXEC spPOSVentaInsertaArticulo @Modulo, @Usuario, @Codigo, @CodigoAccion, @ID, @FechaEmision, @Agente, @Moneda, @TipoCambio, 
						@Condicion, @Almacen, @Proyecto, @FormaEnvio, @Mov, @Empresa, @Sucursal, @ListaPreciosEsp, @Cliente, @CtaDinero, @Accion, 
						@Estacion, @Mensaje OUTPUT, @ArtDescripcion OUTPUT, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT,@Expresion OUTPUT, @Cantidad = @Peso, 
						@Juego = 0,@TorretaMensaje1= @TorretaMensaje1 OUTPUT, @TorretaMensaje2 =@TorretaMensaje2  OUTPUT, 
						@TorretaPosicion1= @TorretaPosicion1   OUTPUT,  @TorretaPosicion2 = @TorretaPosicion2  OUTPUT
				END
    
			SELECT @Codigo = NULL
		END

	-- MODIFICAR AGENTE
	IF @Accion = 'MODIFICAR AGENTE'	
		BEGIN
			IF NOT EXISTS (SELECT * FROM Agente WHERE Agente = @Codigo)
				SELECT @Ok = 26090, @OkRef = @Codigo

			IF @Ok IS NULL
				UPDATE POSL SET Agente = @Codigo WHERE ID = @ID

			DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja
    
			SELECT @Codigo = NULL
		END

	--INTRODUCIR REFERENCIA POR FORMA DE PAGO ESPECIFICADA EN LA ACCION ANTERIOR
	IF @Accion = 'REFERENCIA FORMA PAGO'
		BEGIN
			IF @Ok IS NULL
				BEGIN
					SELECT @Referencia = @Codigo
      
					SELECT @Codigo = FormaPago
					FROM POSLAccion
					WHERE Host = @Host
					AND Caja = @Caja
				END
    
			DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja
		END

	--REVERSAR COBRO
	IF @Accion = 'REVERSAR COBRO'
		BEGIN
			IF @Ok IS NULL
				BEGIN
					SELECT @FormaPago = FormaPago
					FROM CB 
					WHERE Codigo = @Codigo
 
					EXEC spPOSLDIReverso @ID, @FormaPago, @Empresa , @Usuario, @Sucursal, @Ok OUTPUT, @OkRef OUTPUT 
				END
    
			DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja
			SELECT @Codigo = NULL
		END

	IF @Accion = 'INTRODUCIR CONCEPTODIN' AND @Ok IS NULL
		BEGIN
			IF NOT EXISTS (SELECT * FROM POSConceptoDINTemp WHERE Estacion = @Estacion and Orden = CONVERT(INT,@Codigo))
				SELECT @ok = 20702, @OkRef = @Codigo
      
			SELECT @Concepto = Concepto
			FROM POSConceptoDINTemp
			WHERE Estacion = @Estacion AND Orden = CONVERT(INT,@Codigo)       
            
			UPDATE POSL SET Concepto = @Concepto WHERE ID = @ID
    
			SELECT @Codigo = NULL
		END 
 
	----MODIFICAR CONDICION
	IF @Accion = 'MODIFICAR CONDICION' AND @Ok IS NULL
		BEGIN
			IF NOT EXISTS (SELECT * FROM Condicion WHERE Condicion = @Codigo)
				SELECT @ok = 20700, @OkRef = @Codigo
      
			UPDATE POSL SET Condicion = @Codigo WHERE ID = @ID
    
			SELECT @Codigo = NULL
		END

	--INTRODUCIR MONTO POR FORMA DE PAGO ESPECIFICADA EN LA ACCION ANTERIOR
	IF @Accion = 'MONTO FORMA PAGO'
		BEGIN
			IF dbo.fnEsNumerico(@Codigo) <> 1
				SELECT @Ok = 10060, @OkRef = @Codigo
    
			IF @Ok IS NULL
				BEGIN
					SELECT @Importe = @Codigo
					SELECT @Importe = ROUND(@Importe,@RedondeoMonetarios)	
					
					SELECT 
						@Codigo = FormaPago,
						@Referencia = Referencia
					FROM POSLAccion
					WHERE Host = @Host
					AND Caja = @Caja
				END

			DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja
		END

	--INTRODUCIR CUENTA DINERO
	IF @Accion = 'INTRODUCIR CUENTA DINERO'
		BEGIN
			SELECT TOP 1 @MonedaPrincipal = CASE WHEN @POSMonedaAct = 0 THEN ISNULL(NULLIF(fp.Moneda,''), @Moneda) ELSE ISNULL(NULLIF(fp.POSMoneda,''), @Moneda) END
			FROM CB cb INNER JOIN FormaPago fp ON cb.FormaPago = fp.FormaPago
			WHERE cb.Codigo = @Codigo AND cb.TipoCuenta = 'Forma Pago'
   
			IF @MovClave IN ('POS.CC', 'POS.CPC', 'POS.AC','POS.AP','POS.ACM','POS.CCM','POS.CPCM','POS.CAC','POS.CACM','POS.CCC','POS.CCCM')
				BEGIN   
					IF ISNULL(@Codigo,'') NOT IN (SELECT cd.CtaDinero FROM CtaDinero cd WHERE cd.Tipo = 'Banco') AND @Ok IS NULL
						SELECT @Ok = 10540, @OkRef = @Codigo
      
					IF (SELECT ISNULL(Moneda, @MonedaPrincipal) FROM CtaDinero cd WHERE cd.Tipo = 'Banco' AND CtaDinero = @Codigo) 
						NOT IN (SELECT Moneda FROM POSLTipoCambioRef WHERE Sucursal = @Sucursal) AND @Ok IS NULL
						SELECT @Ok = 30050, @okRef = @Codigo 
				END      

			IF @MovClave IN ('POS.TCM','POS.TRM' )
				BEGIN
					IF ISNULL(@Codigo,'') NOT IN (SELECT cd.CtaDinero FROM CtaDinero cd WHERE cd.Tipo = 'Caja' 
						AND cd.Sucursal = @Sucursal AND cd.EsConcentradora = 1 ) AND @Ok IS NULL
						SELECT @Ok = 10540, @OkRef = @Codigo
				END    
    
			IF @Ok IS NULL
				BEGIN
					IF @MovClave IN('POS.AC','POS.AP')
						BEGIN
							UPDATE POSL SET CtaDineroDestino = CtaDinero
							WHERE ID = @ID
         
							UPDATE POSL SET CtaDinero = @Codigo
							WHERE ID = @ID
						END
      
					IF @MovClave IN('POS.ACM')
						BEGIN 
							IF (SELECT NULLIF(CtaDineroDestino,'') FROM POSL WHERE ID = @ID)IS NULL 
								UPDATE POSL SET CtaDineroDestino = CtaDinero
								WHERE ID = @ID
       
							UPDATE POSL SET CtaDinero = @Codigo
							WHERE ID = @ID
						END      
      
					IF @MovClave IN ('POS.CC', 'POS.CPC','POS.CCM','POS.CPCM')
						UPDATE POSL SET CtaDineroDestino = @Codigo
						WHERE ID = @ID
      
					IF @MovClave IN ('POS.TRM','POS.TCM')      
						UPDATE POSL SET CtaDinero = @Codigo, CtaDineroDestino = @Caja, Caja = @Codigo
						WHERE ID = @ID        
      
					IF @MovClave IN ('POS.CC', 'POS.CPC', 'POS.AC','POS.AP','POS.ACM','POS.CCM','POS.CPCM','POS.TCM','POS.IC','POS.EC','POS.TRM')
						SELECT @Mensaje = 'POR FAVOR INTRODUZCA LA FORMA DE PAGO'  
				END
    
			SELECT @Codigo = NULL
		END 

	--MODIFICAR CAJA
	IF @Accion = 'MODIFICAR CAJA'
		BEGIN
			SELECT @CtaDinero = @Codigo
			
			IF @MovClave NOT IN ('POS.AC','POS.ACM')
				SELECT @Ok = 20180, @okRef = 'Solo se puede cambiar la Caja en la apertura de Caja'
      
			IF NOT EXISTS(SELECT * FROM CtaDinero WHERE CtaDinero = @CtaDinero AND Tipo = 'Caja') AND @Ok IS NULL
				SELECT @Ok = 10510, @OkRef = @CtaDinero
      
			IF @Sucursal <> (SELECT Sucursal FROM CtaDinero WHERE CtaDinero = @CtaDinero) AND @Ok IS NULL
				SELECT @Ok = 30270, @OkRef = 'La Caja pertenece a otra Sucursal'
        
			SELECT @CajeroActual  = Cajero FROM POSL WHERE ID  = @ID

			IF EXISTS(SELECT * FROM POSEstatusCaja  WHERE Host = @Host AND Caja = @Caja AND Abierto = 1)
				SELECT @Ok = 30435, @OkRef = @CajeroActual        
      
			IF @OK IS NULL
				BEGIN
					UPDATE POSL SET CtaDineroDestino = @CtaDinero, Caja = @CtaDinero 
					WHERE ID = @ID  
         
					UPDATE POSLCobro SET  CtaDineroDestino = @CtaDinero
					WHERE ID = @ID           
				END  
    
			DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
			SELECT @Codigo = NULL
		END

	IF @Accion = 'ASIGNAR CAJA'
		BEGIN
			SELECT @CtaDinero = @Codigo
    
			IF NOT EXISTS(SELECT * FROM CtaDinero WHERE CtaDinero = @CtaDinero AND Tipo = 'Caja') AND @Ok IS NULL
				SELECT @Ok = 10510, @OkRef = @CtaDinero
    
			IF @Sucursal <> (SELECT Sucursal FROM CtaDinero WHERE CtaDinero = @CtaDinero) AND @Ok IS NULL
				SELECT @Ok = 30270, @OkRef = 'La Caja pertenece a otra Sucursal'
    
			IF @OK IS NULL
				BEGIN
					UPDATE POSL SET CtaDineroDestino = @CtaDinero
					WHERE ID = @ID  
       
					UPDATE POSLCobro SET  CtaDinero = @CtaDinero, Caja = @CtaDinero, CtaDineroDestino = NULL
					WHERE ID = @ID  
       
					UPDATE Usuario SET DefCtaDinero =  @CtaDinero 
					WHERE Usuario = @Usuario
       
					SELECT @Caja =  @CtaDinero        
				END  
    
			DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
    
			SELECT @Codigo = NULL, @CodigoAccion = NULL
		END  
  
	IF @Accion = 'BENEFICIARIO' AND @MovClave IN('POS.EC')
		BEGIN
			SELECT @Beneficiario = @Codigo
    
			UPDATE POSL SET BeneficiarioNombre = @Beneficiario,CtaDineroDestino = CtaDinero
			WHERE ID = @ID

			DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
			SELECT @Codigo = NULL, @CodigoAccion = NULL, @Mensaje = 'POR FAVOR INTRODUZCA LA FORMA DE PAGO'  
		END  

	IF @Accion = 'INTRODUCIR CONCEPTOCXC' AND @MovClave IN('POS.FA') 
		BEGIN
			SELECT @Concepto = Concepto
			FROM POSConceptoCXCTemp
			WHERE Estacion = @Estacion AND Orden = @Codigo 
     
			IF NOT EXISTS (SELECT * FROM  POSConceptoCXCTemp WHERE Estacion = @Estacion AND Orden = @Codigo) 
				SELECT @Ok = 20336 , @OkRef = @OkRef+' POR FAVOR INTRODUZCA EL NUMERO DEL CONCEPTO'  
      
			IF @OK IS NULL
				BEGIN
					UPDATE POSL SET Concepto = @Concepto
					WHERE ID = @ID

					DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
					
					SELECT @Codigo = NULL, @CodigoAccion = NULL 
					INSERT POSLAccion (Host, Caja, Accion, FormaPago) VALUES (@Host, @Caja, 'IMPORTE ANTICIPO', @Codigo)
					SELECT @Mensaje = 'POR FAVOR INTRODUZCA EL IMPORTE'    
				END 
			ELSE
				BEGIN
					SELECT @CodigoAccion = 'INTRODUCIR CONCEPTOCXC'
					SELECT @Accion = NULL  
      
					IF  NULLIF(@Codigo,'') IS NULL  AND @Ok = 20336
						SELECT @Ok = NULL, @OKRef = NULL 
				END       
		END   
  
	IF @Accion = 'ALMACEN DESTINO' AND @MovClave IN('POS.INVD', 'POS.INVA')
		BEGIN
			SELECT @AlmacenD = Almacen
			FROM POSAlmTemp
			WHERE Estacion = @Estacion AND Orden = @Codigo 
     
			IF NOT EXISTS (SELECT * FROM  POSAlmTemp WHERE Estacion = @Estacion AND Orden = @Codigo)
				SELECT @Ok = 20336 , @OkRef = @OkRef + CASE WHEN @MovClave = 'POS.INVD' 
																THEN ' POR FAVOR INTRODUZCA EL ALMACEN DESTINO' 
															ELSE ' POR FAVOR INTRODUZCA EL ALMACEN ORIGEN'  END

			IF @OK IS NULL
				BEGIN
					IF @MovClave = 'POS.INVD'
						UPDATE POSL SET AlmacenDestino = @AlmacenD
						WHERE ID = @ID
       
					IF @MovClave = 'POS.INVA'
						BEGIN
							UPDATE POSL SET AlmacenDestino = Almacen
							WHERE ID = @ID   
        
							UPDATE POSL SET Almacen = @AlmacenD
							WHERE ID = @ID    
						END      

					DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
					SELECT @Codigo = NULL, @CodigoAccion = NULL 
				END 
			ELSE
				BEGIN
					SELECT @CodigoAccion = 'ALMACEN DESTINO'
					SELECT @Accion = NULL  
				END    
		END 
  
	--INTRODUCIR IMPORTE PARA ANTICIPOS FACTURADOS
	IF @Accion =   'IMPORTE ANTICIPO' AND @MovClave IN('POS.FA')
		BEGIN
			IF (SELECT dbo.fnEsNumerico(@Codigo)) = 0
				SELECT @Ok = 30447, @OkRef = @OkRef+' POR FAVOR INTRODUZCA EL IMPORTE' 
    
			IF @Ok IS NULL
				BEGIN
					EXEC spPOSGenerarAnticipo @Estacion,@ID,@Codigo, @Ok OUTPUT, @OkRef OUTPUT 
					
					DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja
					SELECT @Codigo = NULL, @Accion = NULL, @Mensaje = NULL      
				END
			ELSE
				BEGIN
					SELECT @CodigoAccion = 'IMPORTE ANTICIPO'
					SELECT @Accion = NULL 
				END   
		END    
  
	--INTRODUCIR IMPORTE PARA COBRO CXC
	IF @Accion =   'IMPORTE ANTICIPO' AND @MovClave IN('POS.CXCC')
		BEGIN
			IF @Ok IS NULL
				BEGIN
					DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja
					SELECT @Codigo = NULL, @Accion = NULL, @Mensaje = NULL      
				END
			ELSE
				BEGIN
					SELECT @CodigoAccion = 'IMPORTE ANTICIPO'
					SELECT @Accion = NULL 
				END   
    
			IF @Codigo IS NULL AND @Ok NOT IN (30170)
				SELECT @Ok = NULL, @Mensaje = @OkRef
      
			IF @Ok = 30170
				DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja  
		END   
   
	--MODIFICAR REFERENCIA
	IF @Accion = 'MODIFICAR REFERENCIA'
		BEGIN
			UPDATE POSL SET Referencia = @Codigo
			WHERE ID = @ID  
    
			DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
			SELECT @Codigo = NULL
		END
    
	--MODIFICAR CAJERO  
	IF @Accion = 'MODIFICAR CAJERO'
		BEGIN
			SELECT @Cajero = @Codigo
      
			IF @MovClave NOT iN('POS.AC','POS.ACM')
				SELECT @Ok = 20180, @okRef = 'Solo se puede cambiar el Cajero en la apertura de Caja'
        
			IF NOT EXISTS(SELECT * FROM Agente WHERE Agente = @Cajero AND Tipo = 'Cajero') AND @Ok IS NULL
				SELECT @Ok = 10515, @OkRef = @Cajero

			IF @Sucursal <> (SELECT SucursalEmpresa FROM Agente WHERE Agente = @Cajero) AND @Ok IS NULL
				SELECT @Ok = 10200, @OkRef = 'El Cajero pertenece a otra Sucursal'
      
			SELECT @CajeroActual  = Cajero FROM POSL WHERE ID  = @ID
    
			IF EXISTS(SELECT * FROM POSEstatusCaja  WHERE Host = @Host AND Caja = @Caja AND Abierto = 1)
				SELECT @Ok = 30435, @OkRef = @CajeroActual
                    
			IF @OK IS NULL
				UPDATE POSL SET Cajero = @Cajero
				WHERE ID = @ID  
    
			DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja

			SELECT @Codigo = NULL
		END
  
	IF @Accion = 'MATRIZ OPCIONES'
		BEGIN
			IF NOT EXISTS(SELECT * FROM ArtOpcion  a JOIN CB c ON a.Articulo = c.Cuenta WHERE c.Codigo = @Codigo ) 
				SELECT @Ok = 20740, @OkRef = @Codigo
    
			IF @Ok IS NULL
				SELECT @Articulo = Cuenta FROM CB WHERE Codigo = @Codigo 
      
			SELECT @Expresion = 'POSMatrizOpciones( '+CHAR(39)+@ID+CHAR(39)+','+ CHAR(39)+@Articulo+CHAR(39)+','+' '+')'  
			DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja
		END    

	-- CAMBIAR MOVIMIENTO
	IF @Accion = 'CAMBIAR MOVIMIENTO'
		BEGIN  
			IF @Codigo NOT IN (SELECT Mov FROM MovTipo WHERE Modulo = 'POS' 
				AND Clave NOT IN ('POS.CTCAC','POS.CTCRC','POS.STE','POS.FTE','POS.TCRC','POS.TCAC','POS.SALDOIN')) 
				AND @Codigo NOT IN (SELECT CONVERT(varchar,Orden) FROM MovTipo WHERE Modulo = 'POS')
				SELECT @Ok = 26080, @OkRef = @Codigo
    
			IF @Codigo IN (SELECT CONVERT(varchar, Orden) FROM MovTipo WHERE Modulo = 'POS')
				SELECT TOP 1 @Codigo = Mov
				FROM MovTipo mt
				WHERE mt.Orden = @Codigo
				AND mt.Modulo = 'POS'
				AND mt.Clave NOT IN ('POS.CTCAC','POS.CTCRC','POS.STE','POS.FTE','POS.TCRC','POS.TCAC','POS.SALDOIN')
    
			IF @Codigo NOT IN (SELECT Mov FROM POSUsuarioMov WHERE Usuario = ISNULL(NULLIF(@UsuarioPerfil,''),@Usuario))
				SELECT @ok = 3, @okRef = 'El usuario no tiene acceso a este movimiento'

			IF @Ok IS NULL  
				UPDATE POSL 
				SET Mov = mt.Mov,
					Modulo = mt.ConsecutivoModulo,
					FechaEmision = CASE WHEN @SugerirFechaCierre = 1 
											THEN CASE WHEN mt.Clave IN('POS.AC','POS.ACM') 
														  THEN dbo.fnPOSFechaCierre2(@Empresa,@Sucursal,@FechaCierre,@Caja)
													  ELSE dbo.fnPOSFechaCierre(@Empresa,@Sucursal,@FechaCierre,@Caja) 
													  END 
										ELSE dbo.fnFechaSinHora(GETDATE())
										END
				FROM POSL, MovTipo mt
				WHERE mt.Modulo = 'POS'
				AND mt.Mov = @Codigo
				AND ID = @ID
    
			SELECT @MovClave = Clave, @MovSubClave = SubClave
			FROM MovTipo mt
			INNER JOIN POSL pl ON mt.Mov = pl.Mov AND pl.ID = @ID
			WHERE mt.Modulo = 'POS'
     
			SELECT @Codigo = NULL
    
			IF @MovClave IN ('POS.AC', 'POS.CC','POS.AP', 'POS.CPC','POS.ACM','POS.CCM','POS.CPCM','POS.TCM','POS.TRM')
				BEGIN
					SELECT @CodigoAccion = 'INTRODUCIR CUENTA DINERO'
					SELECT @Accion = NULL     
					DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
				END

			IF @MovClave IN ('POS.FA') AND @MovSubClave IS NULL
				BEGIN
					SELECT @CodigoAccion = 'INTRODUCIR CONCEPTOCXC'
					SELECT @Accion = NULL   
					DELETE POSConceptoCXCTemp WHERE Estacion = @Estacion
      
					INSERT POSConceptoCXCTemp(
						Estacion, Concepto)
					SELECT
						@Estacion, Concepto
					FROM Concepto
					WHERE Modulo = 'CXC'
       
					SELECT @Orden = 0
					
					UPDATE POSConceptoCXCTemp
					SET @Orden = Orden = @Orden + 1
					FROM POSConceptoCXCTemp
					WHERE  Estacion = @Estacion    
     
					DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
				END  

			IF @MovClave IN ('POS.FA') AND @MovSubClave = 'POS.ANTREF'
				BEGIN
					SELECT @CodigoAccion = 'SELECCIONARCTE'
					SELECT @Accion = NULL
					DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
				END
    
			IF @MovClave IN ('POS.N') AND @MovSubClave = 'POS.DREF'
				BEGIN
					SELECT @CodigoAccion = 'REFERENCIAR VENTA'
					SELECT @Accion = NULL
					DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
				END    
    
			IF @MovClave IN ('POS.CXCC','POS.CXCD') 
				BEGIN
					SELECT @CodigoAccion = 'SELECCIONARCTE'      
					SELECT @Accion = NULL
					DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
				END    

			IF @MovClave IN ('POS.INVD', 'POS.INVA')
				BEGIN
					SELECT @CodigoAccion = 'ALMACEN DESTINO'
					SELECT @Accion = NULL   
					DELETE POSAlmTemp WHERE Estacion = @Estacion
      
					INSERT POSAlmTemp(
						Estacion, Almacen)
					SELECT
						@Estacion, Almacen
					FROM Alm
       
					SELECT @Orden = 0
					
					UPDATE POSAlmTemp
					SET @Orden = Orden = @Orden + 1
					FROM POSAlmTemp
					WHERE Estacion = @Estacion    
		
					DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
				END     
    
			IF @MovClave IN ('POS.CAC', 'POS.CCC', 'POS.CCPC','POS.CACM','POS.CCCM','POS.CCPCM','POS.CTCM','POS.CTRM')
				BEGIN
					SELECT @CodigoAccion = 'CANCELACION DINERO'
					SELECT @Accion = NULL     
					DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
				END    
    
			IF @MovClave IN ('POS.IC')
				BEGIN
					SELECT @Mensaje = 'POR FAVOR INTRODUZCA LA FORMA DE PAGO'  
				
					IF @Ok IS NULL
						UPDATE POSL SET CtaDineroDestino = CtaDinero
						WHERE ID = @ID        
				END    
    
			IF @MovClave IN('POS.EC')
				BEGIN
					SELECT @CodigoAccion = 'BENEFICIARIO'
					SELECT @Accion = NULL     
					DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
				END
    
			IF @MovClave ='POS.N' AND @MovSubClave = 'POS.PEDCONT'
				BEGIN
					SELECT @CondicionPedidoContado = NULLIF(CondicionPedidoContado,'') FROM POSCfg WHERE Empresa = @Empresa
					UPDATE POSL SET Condicion = @CondicionPedidoContado
					WHERE ID = @ID      
				END        
    
			IF @MovClave IN ('POS.TCAC','POS.AC','POS.ACM','POS.AP','POS.CTCAC','POS.CACM','POS.CCCM','POS.CTCRC','POS.CTCM',
				'POS.CTRM','POS.CAC','POS.CCC','POS.CC','POS.CCM','POS.CPCM','POS.CPC','POS.EC','POS.FTE','POS.IC','POS.TCM',
				'POS.TCRC','POS.STE','POS.TCM','POS.TRM')
				BEGIN
					UPDATE POSL 
					SET Estatus = 'PENDIENTE'
					WHERE ID = @ID
				END        
		END
    
	IF @Accion = 'REFERENCIAR PEDIDO'
	BEGIN
		SELECT @CodigoAccion = 'REFERENCIAR PEDIDO'
		SELECT @Accion = NULL
		DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja    
	END  
  
	IF @Accion = 'REFERENCIAR COBRO' 
	BEGIN
		SELECT @CodigoAccion = 'REFERENCIAR COBRO' 
		SELECT @Accion = NULL
		DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja    
	END    
  
	--SERIELOTE
	IF @Accion = 'SERIE/LOTE'
		BEGIN
			SELECT @SerieLoteCancelarPartida = CASE WHEN Referencia = 'CANCELAR PARTIDA' 
														THEN 1
													ELSE 0
													END
			FROM POSLAccion
			WHERE Host = @Host
			AND Caja = @Caja
      
			SELECT @SerieLote = @Codigo
    
			EXEC spPOSLVerArtSeleccionado @ID, @Articulo OUTPUT, @SubCuenta OUTPUT, @CantidadOriginal OUTPUT, @Unidad OUTPUT, NULL
    
			--DETERMINA SI ES DEVOLUCION
			IF ISNULL(@SerieLoteCancelarPartida,0) = 0
				BEGIN
					IF ISNULL((SELECT SUM(Cantidad) 
							   FROM POSLVenta plv
							   WHERE plv.ID = @ID
								AND plv.Articulo = @Articulo
								AND plv.Unidad = @Unidad
								AND ISNULL(plv.SubCuenta,'') = ISNULL(@SubCuenta,'')),0) <= 0 
                        
					SELECT @EsDevolucion = 1
				END
    
			--DETERMINA SI ES DEVOLUCION
			IF ISNULL(@SerieLoteCancelarPartida,0) = 1
				BEGIN
					IF ISNULL((SELECT SUM(Cantidad) 
							   FROM POSLVenta plv
								WHERE plv.ID = @ID
								AND plv.Articulo = @Articulo
								AND plv.Unidad = @Unidad
								AND ISNULL(plv.SubCuenta,'') = ISNULL(@SubCuenta,'')),0) < 0 
                        
					SELECT @EsDevolucion = 1
				END
            
			SELECT @RenglonUbicado = MAX(RenglonID)
			FROM POSLVenta plv 
			WHERE plv.ID = @ID
			AND plv.Articulo = @Articulo
			AND ISNULL(plv.SubCuenta,'') = ISNULL(@SubCuenta,'')
    
			SELECT @ArtTipo = Tipo
			FROM Art
			WHERE Articulo = @Articulo
        
			IF @ArtTipo = 'Serie'
				BEGIN
					IF ISNULL(@SerieLoteCancelarPartida,0) = 0 AND ISNULL(@EsDevolucion,0) = 0
						BEGIN
							IF EXISTS(SELECT * FROM POSLSerieLote WHERE ID = @ID AND SerieLote = @SerieLote 
								AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,''))
								SELECT @Mensaje = 'El Numero de Serie/Lote Esta Duplicado, ' + ISNULL(@SerieLote,'')    
						END
      
					IF ISNULL(@SerieLoteCancelarPartida,0) = 1 AND ISNULL(@EsDevolucion,0) = 1
						BEGIN
							IF EXISTS(SELECT * FROM POSLSerieLote WHERE ID = @ID AND SerieLote = @SerieLote 
								AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,''))
								SELECT @Mensaje = 'El Numero de Serie/Lote Esta Duplicado, ' + ISNULL(@SerieLote,'') 
						END
				END
     
			--AQUI SE VALIDA QUE LA SERIE/LOTE EXISTA
			IF @SerieLote NOT IN ('TEMP','1')-- Para Series/Lotes Fuera de Línea
				IF NOT EXISTS(SELECT 1 FROM SerieLote WHERE SerieLote = @SerieLote AND Articulo = @Articulo 
					AND ISNULL(Existencia,0) > 0)AND ISNULL(@EsDevolucion,0) =  0
					BEGIN
						SELECT @Mensaje = 'El Numero de Serie/Lote No Existe, ' + ISNULL(@SerieLote,'')
					END

			IF @Mensaje IN ('El Numero de Serie/Lote No Existe, ' + ISNULL(@SerieLote,''), 'El Numero de Serie/Lote Esta Duplicado, ' + ISNULL(@SerieLote,''))
				BEGIN  	
					IF @Mensaje IN ('El Numero de Serie/Lote No Existe, ' + ISNULL(@SerieLote,''))
						SELECT @NoAfectarSerieLote = 1
					ELSE
						SELECT @NoAfectarSerieLote = 0

					SELECT 
						@Mov = p.Mov, 
  						@MovID = p.MovID,
						@Estatus = p.Estatus,
						@FechaEmision = p.FechaEmision, 
						@Concepto = p.Concepto, 
						@UEN  = p.UEN, 
						@Proyecto = p.Proyecto, 
						@Moneda = p.Moneda,
						@TipoCambio = p.TipoCambio, 
						@Cliente = p.Cliente,
						@Almacen = p.Almacen, 
						@Agente = p.Agente, 
						@Cajero = p.Cajero, 
						@FormaEnvio = p.FormaEnvio, 
						@Condicion = p.Condicion,
						@Vencimiento = p.Vencimiento, 
						@CtaDinero = p.CtaDinero, 
						@Descuento = p.Descuento, 
						@DescuentoGlobal = p.DescuentoGlobal,
						@ListaPreciosEsp = p.ListaPreciosEsp, 
						@ZonaImpuesto = p.ZonaImpuesto, 
						@Sucursal = p.Sucursal
					FROM POSL p
					WHERE ID = @ID  
          
					DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja
      
					SELECT TOP 1 @Codigo = Codigo
					FROM CB
					WHERE Cuenta = @Articulo
					AND ISNULL(Subcuenta, '') = ISNULL(@SubCuenta,'')
    	  
					--AQUI SE CANCELA LA PARTIDA SI EL LOTE NO EXISTE
					IF ISNULL(@SerieLoteCancelarPartida,0) = 1
						EXEC spPOSVentaInsertaArticulo @Modulo, @Usuario, @Codigo, @CodigoAccion, @ID, @FechaEmision, @Agente, @Moneda, @TipoCambio, @Condicion, 
							@Almacen, @Proyecto, @FormaEnvio, @Mov, @Empresa, @Sucursal, @ListaPreciosEsp, @Cliente, @CtaDinero, NULL, @Estacion, @Mensaje, 
							@ArtDescripcion OUTPUT, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @Expresion OUTPUT, @EliminarSerieLote = 1, 
							@SerieLote = @SerieLote, @TorretaMensaje1= @TorretaMensaje1 OUTPUT, @TorretaMensaje2 =@TorretaMensaje2  OUTPUT, 
							@TorretaPosicion1= @TorretaPosicion1   OUTPUT,  @TorretaPosicion2 = @TorretaPosicion2  OUTPUT
					ELSE        
						EXEC spPOSVentaInsertaArticulo @Modulo, @Usuario, @Codigo, @CodigoAccion, @ID, @FechaEmision, @Agente, @Moneda, @TipoCambio, @Condicion, 
							@Almacen, @Proyecto, @FormaEnvio, @Mov, @Empresa, @Sucursal, @ListaPreciosEsp, @Cliente, @CtaDinero, 'CANCELAR PARTIDA', @Estacion, @Mensaje,
							@ArtDescripcion OUTPUT, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @Expresion OUTPUT, @EliminarSerieLote = 1, 
							@SerieLote = @SerieLote, @TorretaMensaje1= @TorretaMensaje1 OUTPUT, @TorretaMensaje2 =@TorretaMensaje2  OUTPUT, 
							@TorretaPosicion1= @TorretaPosicion1   OUTPUT,  @TorretaPosicion2 = @TorretaPosicion2  OUTPUT, @NoAfectarSerieLote = @NoAfectarSerieLote
				END
      
			--AQUI SE INSERTA A POSLSERIELOTE
			IF @RenglonUbicado IS NOT NULL AND @ok IS NULL 
				AND @Mensaje NOT IN ('El Numero de Serie/Lote No Existe, ' + ISNULL(@SerieLote,''), 'El Numero de Serie/Lote Esta Duplicado, ' + ISNULL(@SerieLote,'') )
				BEGIN
					--SI NO ES CANCELACION INSERTARA EL NO DE SERIE
					IF ISNULL(@SerieLoteCancelarPartida,0) = 0
						BEGIN
							IF ISNULL(@EsDevolucion,0) = 0
								BEGIN
									INSERT POSLSerieLote (ID,  RenglonID,       Articulo,  SubCuenta,  SerieLote)
	    							VALUES (@ID, @RenglonUbicado, @Articulo, ISNULL(@SubCuenta,''), @SerieLote)
								END

							IF ISNULL(@EsDevolucion,0) = 1
								BEGIN
									SELECT TOP 1 @IDL = IDL 
									FROM POSLSerieLote pl
									WHERE pl.ID = @ID
									AND pl.Articulo = @Articulo
									AND ISNULL(pl.SubCuenta, '') = ISNULL(@SubCuenta, '')
									AND pl.SerieLote = @SerieLote  
									ORDER BY Orden DESC
          
									IF @IDL IS NULL
										SELECT TOP 1 @IDL = IDL 
										FROM POSLSerieLote pl
										WHERE pl.ID = @ID
										AND pl.Articulo = @Articulo
										AND ISNULL(pl.SubCuenta, '') = ISNULL(@SubCuenta, '')
										ORDER BY Orden DESC
           
									DELETE FROM POSLSerieLote WHERE IDL = @IDL
								END
						END
      	  	    
					--SI SI ES CANCELACION DEPENDE
					IF ISNULL(@SerieLoteCancelarPartida,0) = 1
						BEGIN        
							IF @EsDevolucion = 1
								BEGIN
									INSERT POSLSerieLote (
										ID, RenglonID, Articulo, SubCuenta, SerieLote)
	    							VALUES (
										@ID, @RenglonUbicado, @Articulo, ISNULL(@SubCuenta,''), @SerieLote)
								END
        
							IF ISNULL(@EsDevolucion,0) = 0 
								BEGIN
									SELECT TOP 1 @IDL = IDL 
									FROM POSLSerieLote pl
									WHERE pl.ID = @ID
									AND pl.Articulo = @Articulo
									AND ISNULL(pl.SubCuenta, '') = ISNULL(@SubCuenta, '')
									AND pl.SerieLote = @SerieLote  
									ORDER BY Orden DESC
          
									IF @IDL IS NULL
										SELECT TOP 1 @IDL = IDL 
										FROM POSLSerieLote pl
										WHERE pl.ID = @ID
										AND pl.Articulo = @Articulo
										AND ISNULL(pl.SubCuenta, '') = ISNULL(@SubCuenta, '')
										ORDER BY Orden DESC
           
									DELETE FROM POSLSerieLote WHERE IDL = @IDL
								END
						END	  	    
				END

			SELECT @Codigo = NULL
    
			IF isnull(@SerieLoteCancelarPartida,0) = 0 AND isnull(@EsDevolucion,0) = 0 AND nullif(@Mensaje,'') IS NULL
				BEGIN
					SELECT @Renglon = Renglon FROM POSLVenta WHERE ID = @ID AND POSAgentePend = 1
					
					IF @Renglon IS NOT NULL 
						BEGIN
							SELECT @Expresion = 'Asigna(Info.Renglon,'+CONVERT(varchar, @Renglon)+') FormaModal('+CHAR(39)+'POSAgenteDetalle'+CHAR(39)+')'
							UPDATE POSLVenta SET POSAgentePend = 0 WHERE ID = @ID AND Renglon = @Renglon 
						END    
				END
		END
  
	IF @Accion = 'BUSCAR MOVIMIENTO' AND @Ok IS NULL
		BEGIN
			IF EXISTS(SELECT * FROM POSLPorCobrar pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave IN ('POS.F', 'POS.N','POS.NPC') 
					  WHERE  pl.Estatus = 'PORCOBRAR' AND LTRIM(RTRIM(pl.Mov)) + ' ' + LTRIM(RTRIM(pl.MovId)) = @Codigo)
				SELECT @Codigo = ID FROM POSLPorCobrar pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave IN ('POS.F', 'POS.N','POS.NPC') 
				WHERE pl.Estatus = 'PORCOBRAR' AND LTRIM(RTRIM(pl.Mov)) + ' ' + LTRIM(RTRIM(pl.MovId)) = @Codigo 
    
			IF EXISTS(SELECT * FROM POSLPorCobrar WHERE IDCB  = @Codigo AND Estatus = 'PORCOBRAR')
				SELECT @Codigo = ID FROM POSLPorCobrar WHERE IDCB  = @Codigo AND Estatus = 'PORCOBRAR'           

			IF EXISTS(SELECT 1 FROM POSLPorCobrar WHERE ID = @Codigo AND Estatus = 'PORCOBRAR')
				BEGIN    
					--SELECT @Mov = MovOmision FROM CtaDinero WHERE  CtaDinero = @CtaDinero  
					
					SELECT @Mov = cd.MovOmision 
					  FROM Usuario u
					  JOIN CtaDinero cd ON u.DefCtaDinero = cd.CtaDinero AND cd.Tipo = 'Caja'
					 WHERE u.Usuario = @Usuario 

					IF @Mov IS NULL
						SELECT TOP 1 @Mov = mt.Mov
						  FROM MovTipo mt 
						 WHERE mt.Modulo = 'POS' 
						   AND mt.Clave = 'POS.N' 
						   AND mt.Mov NOT IN ('Dev. Referenciada', 'Nota Devolucion', 'Nota Emida', 'Nota Por Facturar', 'Nota Servicios', 'Pedido Contado', 'Recarga Tel. LDI')
						 ORDER BY mt.Orden 
       
					SELECT 
						@CtaDinero = DefCtaDinero,	
						@Cajero = DefCajero
					FROM Usuario
					WHERE Usuario = @Usuario               
     
					SELECT @CheckSumDO = ISNULL(DCheckSum,0), @CheckSumEO = ISNULL(ECheckSum,0) FROM POSLPorCobrar WHERE ID = @Codigo
					SELECT @CheckSumE = dbo.fnPOSCheckSumEncabezado(@Codigo)
					SELECT @CheckSumD =  ISNULL(SUM(CONVERT(bigint,dbo.fnPOSCheckSumDetalle(@Codigo,Renglon))),0)
					FROM POSLPorCobrarD WHERE ID = @Codigo
  
					IF (@CheckSumD <> @CheckSumDO) OR (@CheckSumE <> @CheckSumEO)
						SELECT @Ok = 30442
      
					IF @Ok IS NULL  
						SELECT @ID = NEWID()
      
					IF @Ok IS NULL
						INSERT POSL(
							ID, Empresa, Modulo, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Referencia, 
							Observaciones, Estatus, Cliente, Nombre, Direccion, DireccionNumero, DireccionNumeroInt, EntreCalles, Delegacion, Colonia, 
							Poblacion, Estado, Pais, Zona, CodigoPostal, RFC, CURP, EnviarA, Almacen,  Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, 
							Descuento, DescuentoGlobal, Importe, Impuestos, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal,  
							OrigenTipo, Origen, OrigenID, Tasa, Prefijo, Consecutivo,  IDR, Monedero, BeneficiarioNombre, HOST, Cluster, Usuario, Cajero, Directo)
						SELECT      
							@ID, Empresa, Modulo, @Mov, NULL, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Referencia, 
							Observaciones, 'SINAFECTAR', Cliente, Nombre, Direccion, DireccionNumero, DireccionNumeroInt, EntreCalles, Delegacion, Colonia, 
							Poblacion, Estado, Pais, Zona, CodigoPostal, RFC, CURP, EnviarA, Almacen,  Agente, FormaEnvio, Condicion, Vencimiento,  @CtaDinero, 
							Descuento, DescuentoGlobal, Importe, Impuestos, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, @Sucursal, 
							OrigenTipo, Origen, OrigenID, Tasa, Prefijo, Consecutivo,  ID, Monedero, BeneficiarioNombre, @Host, @Cluster, @Usuario, @Cajero, Directo
						FROM POSLPorCobrar
						WHERE ID = @Codigo 
       
					IF @@ERROR <> 0 
						SET @Ok = 1
       
					IF @Ok IS NULL
						INSERT POSLVenta(
							ID, Renglon, RenglonSub, RenglonID, RenglonTipo, Aplica, AplicaID, Cantidad, Articulo, SubCuenta, Precio, PrecioSugerido, 
							DescuentoLinea, DescuentoImporte, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, CantidadInventario, Puntos, Comision, 
							CantidadObsequio, OfertaID, SerieLote, LDIServicio, Juego, Aplicado, PrecioImpuestoInc, AplicaDescGlobal, Codigo, Almacen)
						SELECT
							@ID, Renglon, RenglonSub, RenglonID, RenglonTipo, Aplica, AplicaID, Cantidad, Articulo, SubCuenta, Precio, PrecioSugerido, 
							DescuentoLinea, DescuentoImporte, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, CantidadInventario, Puntos, Comision, 
							CantidadObsequio, OfertaID, SerieLote, LDIServicio, Juego, Aplicado, PrecioImpuestoInc, AplicaDescGlobal, Codigo, Almacen
						FROM POSLPorCobrarD
						WHERE ID = @Codigo 
      
					IF @@ERROR <> 0 
						SET @Ok = 1    
      
					IF @Ok IS NULL AND EXISTS(SELECT * FROM POSLVenta p JOIN Art a ON p.Articulo = a.Articulo   WHERE a.Tipo IN ('Serie', 'Lote'))
						BEGIN
							INSERT POSLSerieLote(
								ID,  RenglonID, Articulo, SubCuenta, SerieLote)
							SELECT
								@ID, RenglonID, Articulo, ISNULL(SubCuenta,''), SerieLote
							FROM POSLPorCobrarSerieLote
							WHERE ID = @Codigo 
						END
				END
			ELSE  
				SELECT @Ok = 30120, @OkRef = @Codigo
       
			SELECT @Codigo = NULL
		END

	IF @Accion = 'ORIGEN DEVOLUCION' AND @Ok IS NULL
		BEGIN
			IF EXISTS(SELECT * FROM POSL pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave IN ('POS.F', 'POS.N','POS.NPC','POS.P') 
				WHERE LTRIM(RTRIM(pl.Mov)) + ' ' + LTRIM(RTRIM(pl.MovId)) = @Codigo AND pl.Importe >= 0)
				SELECT @Codigo = ID FROM POSL pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave IN ('POS.F', 'POS.N','POS.NPC', 'POS.P') 
				WHERE LTRIM(RTRIM(pl.Mov)) + ' ' + LTRIM(RTRIM(pl.MovId)) = @Codigo AND pl.Importe >= 0
    
			IF EXISTS(SELECT * FROM POSLCB cb JOIN POSL pl ON cb.ID = pl.ID WHERE cb.IDCB  = @Codigo AND pl.Importe >= 0)
				SELECT @Codigo = cb.ID FROM POSLCB cb JOIN POSL pl ON cb.ID = pl.ID WHERE cb.IDCB = @Codigo AND pl.Importe >= 0
                      
			IF NOT EXISTS(SELECT * FROM POSL pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave IN ('POS.F', 'POS.N','POS.NPC', 'POS.P') 
				WHERE pl.ID = @Codigo)
				SELECT @Ok = 35005
        
			--BUSCA PRIMERO EN POSL
			IF EXISTS(SELECT * FROM POSL WHERE ID = @Codigo)
				BEGIN
					SELECT 
						plv.Articulo,
  						plv.Cantidad,
						plv.SubCuenta,
						plv2.ID
					INTO #ArticulosSinDevolucion
					FROM POSLVenta plv
					LEFT OUTER JOIN POSLVenta plv2 ON plv2.ID = @Codigo
					AND plv.Articulo = plv2.Articulo
					AND ISNULL(plv.Subcuenta,'') = ISNULL(plv2.Subcuenta,'')
					AND plv.Cantidad <= plv2.Cantidad
					WHERE plv.ID = @ID
       
					IF EXISTS(SELECT TOP 1 * FROM #ArticulosSinDevolucion asd WHERE asd.ID IS NULL)
						SELECT @Ok = 20380, @OkRef = MAX(ID) 
						FROM #ArticulosSinDevolucion
				END
   
			IF @Ok IS NULL AND @ID IS NOT NULL
				BEGIN
					DELETE POSLValidarDevolucion WHERE ID = @ID
					INSERT POSLValidarDevolucion (ID, IDOrigen) VALUES (@ID, @Codigo)
				END
    
			SELECT @Codigo = NULL 
		END
  
	IF @Accion IN ('DEVOLUCION TOTAL', 'DEVOLUCION PARCIAL') AND @Ok IS NULL
		BEGIN
			SELECT 
			@Mov = p.Mov, 
			@MovID = p.MovID,
			@Estatus = p.Estatus,
			@FechaEmision = p.FechaEmision, 
			@Concepto = p.Concepto, 
			@UEN  = p.UEN, 
			@Proyecto = p.Proyecto, 
			@Moneda = p.Moneda,
			@TipoCambio = p.TipoCambio, 
			@Cliente = p.Cliente,
			@Almacen = p.Almacen, 
			@Agente = p.Agente, 
			@Cajero = p.Cajero, 
			@FormaEnvio = p.FormaEnvio, 
			@Condicion = p.Condicion,
			@Vencimiento = p.Vencimiento, 
			@CtaDinero = p.CtaDinero, 
			@Descuento = p.Descuento, 
			@DescuentoGlobal = p.DescuentoGlobal,
			@ListaPreciosEsp = p.ListaPreciosEsp, 
			@ZonaImpuesto = p.ZonaImpuesto, 
			@Sucursal = p.Sucursal
			FROM POSL p
			WHERE ID = @ID 
     
			--BUSCA SI HAY ALGUN MOVID QUE CORRESPONDA
			IF EXISTS(SELECT * FROM POSL pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave IN ('POS.F', 'POS.N','POS.NPC') 
				WHERE LTRIM(RTRIM(pl.Mov)) + ' ' + LTRIM(RTRIM(pl.MovId)) = @Codigo AND pl.Importe >= 0)
				SELECT @Codigo = ID FROM POSL pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave IN ('POS.F', 'POS.N','POS.NPC') 
				WHERE LTRIM(RTRIM(pl.Mov)) + ' ' + LTRIM(RTRIM(pl.MovId)) = @Codigo AND pl.Importe >= 0

			IF EXISTS(SELECT * FROM POSLCB cb JOIN POSL pl ON cb.ID = pl.ID WHERE cb.IDCB = @Codigo AND pl.Importe >= 0)
				SELECT @Codigo = cb.ID FROM  POSLCB cb JOIN POSL pl ON cb.ID = pl.ID WHERE cb.IDCB = @Codigo AND pl.Importe >= 0
              
			IF NOT EXISTS(SELECT * FROM POSL pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave IN ('POS.F', 'POS.N','POS.NPC', 'POS.P') 
				WHERE pl.ID = @Codigo)
				SELECT @Ok = '35005'
  
			IF (SELECT Devolucion FROM POSL pl WHERE pl.ID = @Codigo) = 1 
				SELECT @Ok = '20706'

			IF (SELECT DevolucionP FROM POSL pl WHERE pl.ID = @Codigo) = 1 AND @Accion = 'DEVOLUCION TOTAL'
				SELECT @Ok = '50001'
    
		    IF (SELECT ISNULL(NULLIF(POSDiasDev,''),0) FROM POSCfg WHERE Empresa = @Empresa) = 0 
				AND ((SELECT CONVERT (INT, dbo.fnFechaSinHora (GETDATE()) - (SELECT dbo.fnFechaSinHora(FechaRegistro) FROM POSL WHERE ID = @Codigo))) > 
				(SELECT ISNULL(POSDiasDev,365) FROM POSCfg WHERE Empresa = @Empresa)) 
				SELECT @Ok = '20707'      
  
			--BUSCA PRIMERO EN POSL
			IF EXISTS(SELECT * FROM POSL WHERE ID = @Codigo)
				BEGIN
					SELECT 
						plv.Articulo,
  						plv.Cantidad,
						plv.SubCuenta,
						plv2.ID
					INTO #ArticulosSinDevolucion2
					FROM POSLVenta plv
					LEFT OUTER JOIN POSLVenta plv2 ON plv2.ID = @Codigo
					AND plv.Articulo = plv2.Articulo
					AND ISNULL(plv.Subcuenta,'') = ISNULL(plv2.Subcuenta,'')
					AND plv.Cantidad <= plv2.Cantidad
					WHERE plv.ID = @ID
       
					IF EXISTS(SELECT TOP 1 * FROM #ArticulosSinDevolucion2 asd WHERE asd.ID IS NULL)
						SELECT @Ok = 20380, @OkRef = MAX(ID) 
						FROM #ArticulosSinDevolucion2
				END
    
			IF @Ok IS NULL AND @ID IS NOT NULL
				BEGIN
					DELETE POSLValidarDevolucion WHERE ID = @ID
					INSERT POSLValidarDevolucion (ID, IDOrigen) VALUES (@ID, @Codigo)
				END
    
			IF @Ok IS NULL AND @ID IS NOT NULL
					EXEC spPOSVentaInsertaArticulo @Modulo, @Usuario, @Codigo, @CodigoAccion, @ID, @FechaEmision, @Agente, @Moneda, @TipoCambio, 
					@Condicion, @Almacen, @Proyecto, @FormaEnvio, @Mov, @Empresa, @Sucursal, @ListaPreciosEsp, @Cliente, @CtaDinero, @Accion, @Estacion, 
					@Mensaje OUTPUT, @ArtDescripcion OUTPUT, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @Expresion OUTPUT, @Cantidad = @Peso, @Juego = 0,
					@TorretaMensaje1= @TorretaMensaje1 OUTPUT, @TorretaMensaje2 =@TorretaMensaje2  OUTPUT, @TorretaPosicion1= @TorretaPosicion1 OUTPUT, 
					@TorretaPosicion2 = @TorretaPosicion2  OUTPUT
				SELECT @Codigo = NULL 
		END

	IF @Accion = 'REFERENCIAR VENTA' AND @Ok IS NULL
		BEGIN
			SELECT @Mov = p.Mov, 
			@MovID = p.MovID,
			@Estatus = p.Estatus,
			@FechaEmision = p.FechaEmision, 
			@Concepto = p.Concepto, 
			@UEN  = p.UEN, 
			@Proyecto = p.Proyecto, 
			@Moneda = p.Moneda,
			@TipoCambio = p.TipoCambio, 
			@Cliente = p.Cliente,
			@Almacen = p.Almacen, 
			@Agente = p.Agente, 
			@Cajero = p.Cajero, 
			@FormaEnvio = p.FormaEnvio, 
			@Condicion = p.Condicion,
			@Vencimiento = p.Vencimiento, 
			@CtaDinero = p.CtaDinero, 
			@Descuento = p.Descuento, 
			@DescuentoGlobal = p.DescuentoGlobal,
			@ListaPreciosEsp = p.ListaPreciosEsp, 
			@ZonaImpuesto = p.ZonaImpuesto, 
			@Sucursal = p.Sucursal
			FROM POSL p
			WHERE ID = @ID 
   
			IF @Ok IS NULL AND @ID IS NOT NULL
				IF ISNULL(@Accion,'') ='REFERENCIAR VENTA'
					BEGIN
						--PRIMERO BUSCA LOCAL        
						IF EXISTS(SELECT * FROM POSL pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave IN ('POS.F', 'POS.N') 
							WHERE LTRIM(RTRIM(pl.Mov)) + ' ' + LTRIM(RTRIM(pl.MovId)) = @Codigo)
							SELECT @Codigo = ID 
							FROM POSL pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave IN ('POS.F', 'POS.N') 
							WHERE LTRIM(RTRIM(pl.Mov)) + ' ' + LTRIM(RTRIM(pl.MovId)) = @Codigo 
      
						--BUSCA SI HAY ALGUN CB QUE CORRESPONDA
						IF EXISTS(SELECT * FROM POSLCB cb JOIN POSL pl ON cb.ID = pl.ID WHERE cb.IDCB = @Codigo AND pl.Importe >= 0)
							SELECT @Codigo = cb.ID FROM  POSLCB cb JOIN POSL pl ON cb.ID = pl.ID WHERE cb.IDCB = @Codigo AND pl.Importe >= 0
            
						IF NOT EXISTS(SELECT * FROM POSL pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave IN ('POS.F', 'POS.N') 
							WHERE pl.ID = @Codigo)
							BEGIN
								IF @WebService = 1
									EXEC spPOSWSSolicitudDevRef  @ID, @Empresa, @Estacion, @Sucursal, @Usuario, @Codigo, @Ok OUTPUT, @OkRef OUTPUT
        
								IF @Ok IS NULL AND EXISTS(SELECT * FROM POSVentaPedidodTemp2 WHERE Estacion = @Estacion)
									BEGIN
										SELECT @NoExiste = 0
										SELECT @Expresion = 'FormaModal('+CHAR(39)+'POSVentaPedidoDTemp2'+CHAR(39)+')' 
									END
							END
						ELSE
							BEGIN
								EXEC spPOSImportarDevRefLocal @ID, @Codigo, @Estacion, @Sucursal,@Ok OUTPUT, @OkRef OUTPUT
      
								IF @Ok IS NULL AND EXISTS(SELECT * FROM POSVentaPedidodTemp2 WHERE Estacion = @Estacion)
									BEGIN
										SELECT @NoExiste = 0
										SELECT @Expresion = 'FormaModal('+CHAR(39)+'POSVentaPedidoDTemp2'+CHAR(39)+')' 
									END  
							END
    
						IF @NoExiste = 1 AND @Ok IS NULL
							BEGIN
								SELECT @CodigoAccion = 'REFERENCIAR VENTA'
								SELECT @Accion = NULL 
        
								SELECT @Ok = 14055, @OkRef = @OkRef+' ('+@Codigo+')<BR>POR FAVOR INGRESE EL ID DE LA VENTA ORIGINAL<BR>PARA SALIR PRECIONE CTRL+Q'
							END 
      
						IF @NoExiste = 1 AND @Ok = 30465
							BEGIN
								SELECT @CodigoAccion = 'REFERENCIAR VENTA'
								SELECT @Accion = NULL 

								SELECT @OkRef = @OkRef+'  POR FAVOR INGRESE EL ID DE LA VENTA ORIGINAL<BR>PARA SALIR PRECIONE CTRL+Q'
							END       
					END   
    
			SELECT @Codigo = NULL 
		END

	IF @Accion = 'REVERSAR MOV' AND @Ok IS NULL
		BEGIN
			IF EXISTS(SELECT * FROM POSL pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave = 
					   CASE WHEN @MovClave = 'POS.CAC' THEN 'POS.AC'    
							WHEN @MovClave = 'POS.CCC' THEN 'POS.CC'  
							WHEN @MovClave = 'POS.CPC' THEN 'POS.CP'  
							WHEN @MovClave = 'POS.CACM' THEN 'POS.ACM'  
							WHEN @MovClave = 'POS.CCCM' THEN 'POS.CCM'  
							WHEN @MovClave = 'POS.CCPCM' THEN 'POS.CPCM'  
							WHEN @MovClave = 'POS.CTRM' THEN 'POS.TRM'         
							WHEN @MovClave = 'POS.CTCM' THEN 'POS.TCM'  
							END   
        				WHERE LTRIM(RTRIM(pl.Mov)) + ' ' + LTRIM(RTRIM(pl.MovId)) = @Codigo AND pl.Estatus = 'CONCLUIDO')        
				SELECT @Codigo = ID FROM POSL pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave =
					CASE WHEN @MovClave = 'POS.CAC' THEN 'POS.AC'    
						 WHEN @MovClave = 'POS.CCC' THEN 'POS.CC'  
						 WHEN @MovClave = 'POS.CPC' THEN 'POS.CP'  
						 WHEN @MovClave = 'POS.CACM' THEN 'POS.ACM'  
						 WHEN @MovClave = 'POS.CCCM' THEN 'POS.CCM'  
						 WHEN @MovClave = 'POS.CCPCM' THEN 'POS.CPCM' 
						 WHEN @MovClave = 'POS.CTRM' THEN 'POS.TRM'   
						 WHEN @MovClave = 'POS.CTCM' THEN 'POS.TCM'  
						 END        
					WHERE LTRIM(RTRIM(pl.Mov)) + ' ' + LTRIM(RTRIM(pl.MovId)) = @Codigo AND pl.Estatus = 'CONCLUIDO'
     
			IF EXISTS(SELECT * FROM POSLCB cb JOIN POSL pl ON cb.ID = pl.ID WHERE cb.IDCB = @Codigo)
				SELECT @Codigo = cb.ID  FROM POSLCB cb JOIN POSL pl ON cb.ID = pl.ID WHERE cb.IDCB = @Codigo 
          
			IF NOT EXISTS(SELECT * FROM POSL pl INNER JOIN MovTipo mt ON pl.Mov = mt.Mov AND mt.Modulo = 'POS' AND mt.Clave =
					CASE WHEN @MovClave = 'POS.CAC' THEN 'POS.AC'    
						 WHEN @MovClave = 'POS.CCC' THEN 'POS.CC'  
						 WHEN @MovClave = 'POS.CPC' THEN 'POS.CP'  
						 WHEN @MovClave = 'POS.CACM' THEN 'POS.ACM'  
						 WHEN @MovClave = 'POS.CCCM' THEN 'POS.CCM'  
						 WHEN @MovClave = 'POS.CCPCM' THEN 'POS.CPCM'  
						 WHEN @MovClave = 'POS.CTRM' THEN 'POS.TRM'  
						 WHEN @MovClave = 'POS.CTCM' THEN 'POS.TCM'  
						 END   
					WHERE pl.ID = @Codigo AND pl.Estatus = 'CONCLUIDO')
				SELECT @Ok = 35005

			IF @Ok IS NULL  AND  @MovClave NOT IN ('POS.CTCM') AND EXISTS(SELECT * FROM POSL  p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS' 
				WHERE p.FechaRegistro > (SELECT FechaRegistro FROM POSL WHERE ID = @Codigo) AND p.Estatus IN('CONCLUIDO','TRASPASADO') 
				AND m.Clave NOT IN('POS.FTE','POS.STE'))
				SELECT @Ok = 30151
    
			IF @Ok IS NULL AND  @MovClave IN ('POS.CTCM') AND EXISTS(SELECT * FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS'   
				WHERE p.IDR = @Codigo AND p.Estatus IN('CONCLUIDO','TRASPASADO') AND m.Clave = 'POS.CTCM')
				SELECT @Ok = 60050
      
			IF @Ok IS NULL AND  @MovClave IN ('POS.CTRM') AND EXISTS(SELECT * FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS'   
				WHERE p.IDR = @Codigo AND p.Estatus IN('CONCLUIDO','TRASPASADO') AND m.Clave = 'POS.CTRM')
				SELECT @Ok = 60050      

			IF @Ok IS NULL
				DELETE POSLAccion 
				WHERE Host = @Host 
				AND Accion = @CodigoAccion
				AND Caja = @Caja
    
			SELECT @CodigoAccion = 'REVERSAR MOV'             
		END  

	--BUSCADOR DE ARTICULOS
	IF @Accion IN ('BUSCAR ARTICULOS', 'CONSULTAR INV') AND @Ok IS NULL
		BEGIN
			SELECT @ArtConsulta = @Codigo
			SELECT @Codigo = NULL
		END
  
	IF @Accion IN ('VERIFICAR PRECIOS') AND @Ok IS NULL
		BEGIN
			SELECT @ArtConsulta = @Codigo
			SELECT @Codigo = NULL
		END
  
	--MODIFICAR CANTIDAD  
	IF @Accion = 'MODIFICAR CANTIDAD' AND @Ok IS NULL
		BEGIN
			IF (SELECT dbo.fnEsNumerico(@Codigo)) = 0 OR LEN(@Codigo)>=10
				SELECT @Ok = 20010, @OkRef = @Codigo
			ELSE
				SELECT @Cantidad = @Codigo, @CantidadContador = 0

			IF  @Cantidad <= 0 
				SELECT @Ok = 20010, @OkRef = 'No se permiten candidas en Cero o Negativas'
    
			IF @AgruparArticulos = 0
				SELECT @Ok = 20500, @OkRef = 'Esta funcionalidad funciona con el POS configurado para Agrupar Articulos'      
    
			EXEC spPOSLVerArtSeleccionado @ID, @Articulo OUTPUT, @SubCuenta OUTPUT, @CantidadOriginal OUTPUT, @Unidad OUTPUT, @Codigo OUTPUT
    
			IF (SELECT Tipo FROM Art WHERE Articulo = @Articulo) IN ('Serie', 'Lote')
				SELECT @Ok = 73040, @OkRef = 'Esta funcionalidad no aplica para articulos tipo Serie/Lote'  
      
			IF (SELECT Tipo FROM Art WHERE Articulo = @Articulo) IN ('Juego')
				SELECT @Ok = 73040, @OkRef = 'Esta funcionalidad no aplica para articulos tipo Juego'   
      
			IF EXISTS(SELECT * FROM ArtOpcion  WHERE Articulo = @Articulo)  AND @SubCuenta IS NULL  
				SELECT @Ok = 73040, @OkRef = 'Esta funcionalidad no aplica para articulos con Opciones'         
      
			SELECT 
				@Mov = p.Mov, 
				@FechaEmision = p.FechaEmision, 
				@Concepto = p.Concepto, 
				@UEN  = p.UEN, 
				@Proyecto = p.Proyecto, 
				@Moneda = p.Moneda,
				@TipoCambio = p.TipoCambio, 
				@Cliente = p.Cliente,
				@Almacen = p.Almacen, 
				@Agente = p.Agente, 
				@Cajero = p.Cajero, 
				@FormaEnvio = p.FormaEnvio, 
				@Condicion = p.Condicion,
				@Vencimiento = p.Vencimiento, 
				@CtaDinero = p.CtaDinero, 
				@Descuento = p.Descuento, 
				@DescuentoGlobal = p.DescuentoGlobal,
				@ListaPreciosEsp = p.ListaPreciosEsp, 
				@ZonaImpuesto = p.ZonaImpuesto, 
				@Sucursal = p.Sucursal
			FROM POSL p
			WHERE ID = @ID  
   
			SELECT @BasculaPesar = BasculaPesar
			FROM Art a
			WHERE a.Articulo = @Articulo
    
			IF ISNULL(@BasculaPesar,0) = 1
				BEGIN
					SELECT @Ok = 73040, @OkRef = 'Debe Utilizar la Acción Pesar en articulos configurados para pesarse'
					DELETE POSLAccion WHERE Host = @Host AND Accion = ISNULL(@CodigoAccion, @Accion) AND Caja = @Caja
				END    

			SELECT @CantidadCodigo=Cantidad  FROM CB WHERE Codigo = @Codigo AND TipoCuenta = 'Articulos'
	   
			IF @Codigo IS NULL   
				SELECT @Codigo = MAX(Codigo)
				FROM CB 
				WHERE TipoCuenta = 'Articulos' 
				AND Cuenta = @Articulo
				AND ISNULL(SubCuenta, '') = ISNULL(@SubCuenta, '')
				AND Unidad = ISNULL(@Unidad,Unidad)       
         
			IF @Ok IS NULL AND @IDDevolucionP IS NULL 
				BEGIN
					SELECT @Cantidad = @Cantidad * ISNULL(@CantidadCodigo,1)
      
					EXEC spPOSVentaInsertaArticulo @Modulo, @Usuario, @Codigo, @CodigoAccion, @ID, @FechaEmision, @Agente, @Moneda, @TipoCambio, @Condicion, 
						@Almacen, @Proyecto, @FormaEnvio, @Mov, @Empresa, @Sucursal, @ListaPreciosEsp, @Cliente, @CtaDinero, @Accion, @Estacion, 
						@Mensaje OUTPUT, @ArtDescripcion OUTPUT, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @Expresion OUTPUT, @Juego = 0, 
						@TorretaMensaje1 = @TorretaMensaje1 OUTPUT, @TorretaMensaje2 = @TorretaMensaje2  OUTPUT, @TorretaPosicion1 = @TorretaPosicion1   OUTPUT,
						@TorretaPosicion2 = @TorretaPosicion2  OUTPUT, @Cantidad = @Cantidad
				END
			ELSE 
				EXEC spPOSVentaInsertaArticulo @Modulo, @Usuario, @Codigo, @CodigoAccion, @ID, @FechaEmision, @Agente, @Moneda, @TipoCambio, @Condicion, 
					@Almacen, @Proyecto, @FormaEnvio, @Mov, @Empresa, @Sucursal, @ListaPreciosEsp, @Cliente, @CtaDinero, @Accion, @Estacion, 
					@Mensaje OUTPUT, @ArtDescripcion OUTPUT, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @Expresion OUTPUT, @Cantidad = @Cantidad, @Juego = 0,
					@TorretaMensaje1= @TorretaMensaje1 OUTPUT, @TorretaMensaje2 =@TorretaMensaje2  OUTPUT, @TorretaPosicion1= @TorretaPosicion1   OUTPUT, 
					@TorretaPosicion2 = @TorretaPosicion2  OUTPUT
			
			SELECT @Codigo = NULL
		END
 
	--MODIFICAR CANTIDAD  
	IF @Accion = 'MULTIPLICAR CANTIDAD' AND @Ok IS NULL
		BEGIN
			IF @AgruparArticulos = 0
				SELECT @Ok = 20500, @OkRef = 'Esta funcionalidad funciona con el POS configurado para Agrupar Articulos'      
      
			IF (SELECT dbo.fnEsNumerico(@Codigo)) = 0 OR LEN(@Codigo)>=10
				SELECT @Ok = 20010, @OkRef = @Codigo
			ELSE
				SELECT @Cantidad = @Codigo, @CantidadContador = 0
    
			EXEC spPOSLVerArtSeleccionado @ID, @Articulo OUTPUT, @SubCuenta OUTPUT, @CantidadOriginal OUTPUT, @Unidad OUTPUT, NULL
    
			IF (SELECT Tipo FROM Art WHERE Articulo = @Articulo) IN ('Serie', 'Lote')
				SELECT @Ok = 73040, @OkRef = 'Esta funcionalidad no aplica para articulos tipo Serie/Lote'  
      
			IF (SELECT Tipo FROM Art WHERE Articulo = @Articulo) IN ('Juego')
				SELECT @Ok = 73040, @OkRef = 'Esta funcionalidad no aplica para articulos tipo Juego'   
      
			IF EXISTS(SELECT * FROM ArtOpcion  WHERE Articulo = @Articulo)  AND @SubCuenta IS NULL  
				SELECT @Ok = 73040, @OkRef = 'Esta funcionalidad no aplica para articulos con Opciones'         
      
			SELECT 
				@Mov = p.Mov, 
				@FechaEmision = p.FechaEmision, 
				@Concepto = p.Concepto, 
				@UEN  = p.UEN, 
				@Proyecto = p.Proyecto, 
				@Moneda = p.Moneda,
				@TipoCambio = p.TipoCambio, 
				@Cliente = p.Cliente,
				@Almacen = p.Almacen, 
				@Agente = p.Agente, 
				@Cajero = p.Cajero, 
				@FormaEnvio = p.FormaEnvio, 
				@Condicion = p.Condicion,
				@Vencimiento = p.Vencimiento, 
				@CtaDinero = p.CtaDinero, 
				@Descuento = p.Descuento, 
				@DescuentoGlobal = p.DescuentoGlobal,
				@ListaPreciosEsp = p.ListaPreciosEsp, 
				@ZonaImpuesto = p.ZonaImpuesto, 
				@Sucursal = p.Sucursal
			FROM POSL p
			WHERE ID = @ID  
   
			SELECT @BasculaPesar = BasculaPesar
			FROM Art a
			WHERE a.Articulo = @Articulo
    
			IF ISNULL(@BasculaPesar,0) = 1
				BEGIN
					SELECT @Ok = 73040, @OkRef = 'Debe Utilizar la Acción Pesar en articulos configurados para pesarse'
					DELETE POSLAccion WHERE Host = @Host AND Accion = ISNULL(@CodigoAccion, @Accion) AND Caja = @Caja
				END
    
			SELECT @Codigo = MAX(Codigo)
			FROM CB 
			WHERE TipoCuenta = 'Articulos' 
			AND Cuenta = @Articulo
			AND ISNULL(SubCuenta, '') = ISNULL(@SubCuenta, '')
			AND Unidad = ISNULL(@Unidad,Unidad)
         
			IF @Ok IS NULL
				BEGIN
					UPDATE POSLVenta SET Cantidad = Cantidad+(@Cantidad-1) 
					WHERE ID = @ID AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND Unidad = @Unidad
					
					SET @CantidadContador=0
				END
    
			SELECT @Codigo = NULL
		END
    
      IF @Accion = 'FORMA ENVIO' AND @Ok IS NULL
	  BEGIN
		IF NOT EXISTS (SELECT * FROM POSFormaEnvioTemp WHERE Estacion = @Estacion and Orden = CONVERT(INT,@Codigo))
		  SELECT @ok = 20702, @OkRef = @Codigo
      
		SELECT @FormaEnvioV = FormaEnvio
		  FROM POSFormaEnvioTemp
		 WHERE Estacion = @Estacion AND Orden = CONVERT(INT,@Codigo)       
      
      
		UPDATE POSL SET FormaEnvio = @FormaEnvioV WHERE ID = @ID
    
		SELECT @Codigo = NULL
		DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
	  END
    
	--AQUI SE MANDA A COPIAR EL OTRO MOVIMIENTO DE VENTAS CUANDO LA ACCION ANTERIOR SE INSERTO
	IF @Accion = 'COPIAR OTRO MOV VENTAS'
		BEGIN
			IF EXISTS(SELECT 1 FROM Venta v WHERE UPPER(LTRIM(RTRIM(v.Mov))+ ' ' + LTRIM(RTRIM(v.MovID))) = @Codigo OR CONVERT(varchar,v.ID) = @Codigo 
				AND v.Empresa = @Empresa)
				BEGIN
					EXEC spPOSMovNuevo @Empresa, @Modulo, @Sucursal, @Usuario, @Estacion, @ID OUTPUT, @Imagen OUTPUT
					EXEC spPOSMovCopiar @ID, @Codigo, 'VTAS', @Ok OUTPUT, @OkRef OUTPUT
				END
			ELSE      
				SELECT @Ok = 14055, @OkRef = @Codigo
    
			SELECT @Codigo = NULL
		END    
    
	IF @Accion = 'REFERENCIAR PEDIDOMANUAL'  
		BEGIN
			UPDATE POSL SET PedidoReferencia = @Codigo
			WHERE ID = @ID
			
			DELETE POSLAccion WHERE Host = @Host AND Accion = ISNULL(@CodigoAccion, @Accion) AND Caja = @Caja
			
			SELECT @CodigoAccion = 'INTRODUCIR CONCEPTOCXC'
			
			IF EXISTS(SELECT * FROM POSLAccion WHERE Host = @Host AND Caja = @Caja AND Accion = @CodigoAccion)
				DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
    
			SELECT @Codigo = NULL,@Accion = NULL
			SELECT @Mensaje = 'POR FAVOR INTRODUZCA EL NUMERO DEL CONCEPTO'        
			
			INSERT POSLAccion (
				Host,  Caja, Accion)
            VALUES (
				@Host, @Caja,@CodigoAccion ) 
		END      
  
	IF @Accion = 'INSERTA AGENTE' AND (SELECT POSAgenteDetalle  FROM POSCFG WHERE EMPRESA = @Empresa) = 1 
		BEGIN
			SELECT TOP 1 @Renglon = Renglon FROM POSLVenta WHERE ID = @ID AND NULLIF(Agente,'') IS NULL 
			
			IF @Renglon IS NOT NULL 
				BEGIN
					SELECT @Expresion = 'Asigna(Info.Renglon,'+CONVERT(varchar, @Renglon)+') FormaModal('+CHAR(39)+'POSAgenteDetalle'+CHAR(39)+')'
				END
			DELETE POSLAccion WHERE Host = @Host AND Caja = @Caja  
		END   
END
GO



/************************ spPOSReversarMovDinero *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSReversarMovDinero') AND type = 'P') DROP PROCEDURE dbo.spPOSReversarMovDinero
GO             
CREATE PROCEDURE spPOSReversarMovDinero
	@Empresa           varchar(5), 
	@Sucursal          int, 
	@Usuario           varchar(10), 
	@ID                varchar(36), 
	@MovClave          varchar(20),
	@Codigo            varchar(50), 
	@Ok                int OUTPUT, 
	@OkRef             varchar(255) OUTPUT
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE 
    @CtaDinero                  varchar(20),
    @Caja                       varchar(20),
    @CtaDineroDestino           varchar(20),
    @Importe                    float
  
	SELECT @CtaDinero = CtaDinero, @CtaDineroDestino = CtaDineroDestino, @Importe = Importe, @Caja = Caja
    FROM POSL WHERE ID = @Codigo
      
	IF @MovClave IN('POS.CAC', 'POS.CCC', 'POS.CACM', 'POS.CCCM','POS.CTCM','POS.CTRM' )
		BEGIN
			IF @MovClave IN('POS.CAC', 'POS.CCC', 'POS.CACM', 'POS.CCCM')
				UPDATE POSL 
				SET CtaDinero =  @CtaDineroDestino, CtaDineroDestino = @CtaDinero, Importe = @Importe
				WHERE ID = @ID
    
			IF @@ERROR <> 0 
				SET @Ok = 1
    
			IF @MovClave IN('POS.CTRM','POS.CTCM')
				UPDATE POSL
				SET CtaDinero =  @CtaDinero, CtaDineroDestino = @CtaDineroDestino , Importe = @Importe, Caja = @CtaDinero
				WHERE ID = @ID
    
			IF @@ERROR <> 0 
				SET @Ok = 1    
    
			IF EXISTS(SELECT * FROM POSLCobro WHERE ID = @ID)
				DELETE  POSLCobro WHERE ID = @ID
    
			IF @MovClave IN('POS.CAC', 'POS.CCC', 'POS.CACM', 'POS.CCCM')
				INSERT POSLCobro(
					ID, FormaPago, Importe, Referencia, Monedero, CtaDinero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio, 
					Voucher, Banco, MonedaRef, CtaDineroDestino)
				SELECT
					@ID, FormaPago, Importe, Referencia, Monedero, CtaDineroDestino, Fecha, @Caja, Cajero, Host, ImporteRef, TipoCambio, 
					Voucher, Banco, MonedaRef, CtaDinero
				FROM POSLCobro 
				WHERE ID = @Codigo
		
			IF @@ERROR <> 0 
				SET @Ok = 1     
    
			IF @MovClave IN('POS.CTRM','POS.CTCM')
				INSERT POSLCobro(
					ID, FormaPago, Importe, Referencia, Monedero, CtaDinero, Fecha, Caja,  Cajero, Host, ImporteRef, TipoCambio, 
					Voucher, Banco, MonedaRef, CtaDineroDestino)
				SELECT
					@ID, FormaPago, Importe, Referencia, Monedero, CtaDinero, Fecha, @Caja, Cajero, Host, ImporteRef, TipoCambio, 
					Voucher, Banco, MonedaRef, CtaDineroDestino
				FROM POSLCobro 
				WHERE ID = @Codigo
			
			IF @@ERROR <> 0 
				SET @Ok = 1       
		END    
END
GO 


/************************ spPOS *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOS') AND type = 'P') DROP PROCEDURE dbo.spPOS
GO             
CREATE PROCEDURE spPOS
	@Estacion 			int,
    @Codigo				varchar(50),
    @Empresa			varchar(5),
    @Modulo				varchar(5),
    @Sucursal			int,
    @Usuario			varchar(10),
    @Referencia			varchar(50),
    @ID					varchar(50) = NULL,
    @Importe			float = NULL,
    @CodigoCambio		varchar(30) = NULL,
    @ImporteCambio		float = NULL,
    @Cobro				bit = 0,
    @LecturaTarjeta		varchar(200) = NULL,
    @Cliente			varchar(10) = NULL,
    @Monedero			varchar(20) = NULL,
    @ImporteRef			float = NULL,
    @Ticket				varchar(MAX) =NULL	OUTPUT,
    @DesgloseC			bit = 0,
    @EsImpresion		bit = 0,
    @EnSilencio			bit = 0,
	@Ok					int = NULL			OUTPUT,
	@OkRef				varchar(255)= NULL  OUTPUT    	     	     
 --//WITH ENCRYPTION  	       
AS 
BEGIN
	BEGIN TRAN
  
	DECLARE 
	@RecalcularTodo						bit,
	@Accion								varchar(50),
	@CodigoAccion						varchar(50),
	@CodigoAccionSecundario				varchar(50),
	@TipoCuenta							varchar(20), 
  	@Totales							varchar(MAX),
	@Saldos								varchar(MAX),
	@Total								decimal(32,10),
	@Saldo								decimal(32,10),
	@ImporteMov							float,
	@ImporteCobrado						float,
	@SumaCobrado						float,
	@Imagen								varchar(255),
	@ImagenNombreAnexo					varchar(255),
	@CantidadNotasEnProceso				int,
	@IDM								varchar(50),
	@Mov								varchar(20),
	@MovClave							varchar(20),
	@FechaEmision						datetime,
	@FechaRegistro						datetime, 
	@Concepto							varchar(50),
	@Proyecto							varchar(50),
	@UEN								int,
	@Moneda								varchar(10),
	@MonedaSuc							varchar(10),
	@TipoCambio							float,
	@Almacen							varchar(10),
	@Agente								varchar(10),
	@Cajero								varchar(10),
	@FormaEnvio							varchar(50),
	@Condicion							varchar(50),
	@Vencimiento						varchar(50),
	@CtaDinero							varchar(10),
	@CtaDineroDestino					varchar(10),
	@Descuento							varchar(50),
	@DescuentoGlobal					varchar(50),
	@ListaPreciosEsp					varchar(20),
	@ZonaImpuesto						varchar(50),	  
	@FormaPago							varchar(50),
	@ArtDescripcion						varchar(100),
	@Articulo							varchar(20),
	@SubCuenta							varchar(50),
	@Cantidad							float,
	@CantidadContador					float,
	@ToleranciaRedondeo					float,
	@ImporteSaldoaFavor					float,
	@ValidarDevolucion					bit,
	@ArtConsulta						varchar(50),
	@SerieLote							varchar(50),
	@RenglonUbicado						float,
	@Expresion							varchar(255),
	@AfectarOtrasSucursalesenLinea		bit,
	@UsuarioSucursal					int,
	@CantidadOriginal					float,
	@AgruparArticulos					bit,	  
	@CodigoExtendido					bit,
	@CodigoExtendidoCodigo				varchar(50),
	@CodigoExtendidoLetraCodigo			varchar(1),
	@CodigoExtendidoLetraPeso			varchar(1),
	@CodigoExtendidoDecimalesPeso		int,
	@CodigoExtendidoMascara				varchar(50),
	@CodigoExtendidoPeso				varchar(50),
	@Peso								float,
	@BasculaPesar						bit,	  
	@RequiereReferencia					bit,
	@TarjetaBandaMagnetica				bit,
	@CajaActual							varchar(20),
	@CajeroActual						varchar(20),
	@Mensaje							varchar(255),
	@Caja								varchar(10),	  
	@Host								varchar(20),
	@Cluster							varchar(20),
	@Servicio							varchar(20),
	@FormaServicio						varchar(50),
	@CodigoRedondeo						varchar(50),
	@ArticuloRedondeo					varchar(20),
	@Redondeo							float,
	@DefMonedaNacional					varchar(20),
	@DefMonedaMov						varchar(20),
	@DefCliente							varchar(10),	  
	@RedondeoMonetarios					int,
	@SevicioLDI							varchar(20),
	@ArtTarjeta							varchar(20),
	@CfgVentaMonedero					bit,
	@Renglon							float, 
	@RenglonID							int,  
	@RenglonTipo						char(1),
	@MonederoLDI						varchar(20),
	@TipoMonedero						varchar(50),
	@ReporteImpresora					varchar(100),
	@IDImpresion						varchar(36),
	@CajaOmision						bit,
	@TorretaMensaje1					varchar(20),
	@TorretaMensaje2					varchar(20),
	@TorretaPosicion1					varchar(20),
	@TorretaPosicion2					varchar(20),
	@LDI								bit,
	@MonedaFormaPago					varchar(10),
	@Abierto							bit,
	@RIDCobro							int,
	@TarjetaMoneda						varchar(10),
    @ImporteTarjeta						float,
    @DesgloseCC							bit,
    @IDImprimir							varchar(36),
    @Expresion2							varchar(255),
    @Unidad								varchar(50),
    @MovSubClave						varchar(20),
    @Orden								int,
    @ContMoneda							varchar(10),
    @GenerarCFD							bit,
    @AfectadoEnLinea					bit,
    @CierreiSyncNivel					varchar(20),
    @POSMonedaAct						bit,
    @TotalPuntos						money,
	@CfgVentaMonederoA					bit,
	@FormaPagoRegistros					int,
	@FormaPagoRegRestante				int
          
	SELECT @POSMonedaAct = POSMonedaAct FROM POSCfg WHERE Empresa = @Empresa

	DECLARE @LDILog table(  	
        IDModulo                varchar(36),
  		Modulo                  varchar(5),
  		Servicio                varchar(50),
        Fecha                   varchar(20),
        TipoTransaccion         varchar(50), 
        TipoSubservicio         varchar(50),
        CodigoRespuesta         varchar(50), 
        DescripcionRespuesta    varchar(255), 
        OrigenRespuesta         varchar(50), 
        InfoAdicional           varchar(50), 
        IDTransaccion           varchar(50),
        CodigoAutorizacion      varchar(50),
        Importe                 float,
        Comprobante             varchar(Max),
        Cadena                  varchar(Max),
        CadenaRespuesta         varchar(Max),
        RIDCobro                int         
		)

	DELETE POSLDIIDTemp WHERE Estacion = @@SPID
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)
	SELECT TOP 1 @MonedaSuc = Moneda FROM POSLTipoCambioRef WHERE Sucursal = @Sucursal AND TipoCambio = 1
	EXEC spPOSHost @Host	OUTPUT, @Cluster OUTPUT
   
	--POR DEFAULT SE MARCA RECALCULE TODO EL TICKET.
	SELECT @RecalcularTodo = 1
  
	SELECT 
		@AgruparArticulos				= ISNULL(pc.AgruparArticulos,0),
		@CantidadNotasEnProceso			= ISNULL(pc.CantidadNotasEnProceso,0),
		@CodigoExtendido				= ISNULL(pc.CodigoExtendido,0),
		@CodigoExtendidoLetraCodigo		= pc.CodigoExtendidoLetraCodigo,
		@CodigoExtendidoLetraPeso		= pc.CodigoExtendidoLetraPeso,
		@CodigoExtendidoDecimalesPeso	= pc.CodigoExtendidoDecimalesPeso,
		@CodigoExtendidoMascara			= pc.CodigoExtendidoMascara,
		@CodigoRedondeo					= pc.RedondeoVentaCodigo,
		@TipoMonedero					= pc.TipoMonedero,
		@CajaOmision					= ISNULL(pc.CajaOmision,1),
		@LDI							= ISNULL(MonederoLDI,0),
		@DesgloseCC						= ISNULL(DesgloseCC,0),
		@CierreiSyncNivel				= ISNULL(CierreiSyncNivel,'Sucursal'),
		@ToleranciaRedondeo				= ISNULL(POSToleranciaVta,0.99)
    FROM POSCfg pc 
	WHERE pc.Empresa = @Empresa
  
	SELECT @ArticuloRedondeo = cb.Cuenta
    FROM CB
	WHERE CB.Cuenta = @CodigoRedondeo
    AND CB.TipoCuenta = 'Articulos'

	SELECT @Importe= CONVERT(decimal(20,6),@Importe), @ImporteRef= CONVERT(decimal(20,6),@ImporteRef) 
  
	SELECT @Importe = ROUND(@Importe,@RedondeoMonetarios)	          
	SELECT @ImporteRef = ROUND(@ImporteRef,@RedondeoMonetarios)	          
  
	--AQUI SE DETERMINA LA CONTRASENA QUE SE UTILIZARA PARA EL INTELISISSERVICE
	SELECT 
		@UsuarioSucursal = u.Sucursal,
		@AfectarOtrasSucursalesenLinea = u.AfectarOtrasSucursalesenLinea,
		@Caja = u.DefCtaDinero,
		@DefCliente= u.DefCliente
    FROM Usuario u
	WHERE u.Usuario = @Usuario
  
	IF NULLIF(@Caja,'') IS NULL AND @Ok IS NULL AND @CajaOmision = 1
		SELECT @ok = 10510, @OkRef = 'Es necesario indicar la caja en la configuración del usuario'
    
	IF NULLIF(@Caja,'') IS NULL AND @Ok IS NULL AND @CajaOmision = 0
		SELECT @CodigoAccion = 'ASIGNAR CAJA'

	IF NULLIF(@DefCliente,'') IS NULL AND @Ok IS NULL
		SELECT @ok = 10575, @OkRef = 'Es necesario indicar el Cliente  en la configuración del usuario' 
  
    IF (SELECT Sucursal FROM CtaDinero WHERE CtaDinero = @Caja)<> @Sucursal
		SELECT @Ok = 30468  ,@OkRef = ' ('+CONVERT(varchar,@Sucursal)+')' 
  
	IF @CierreiSyncNivel = 'Sucursal' 
		BEGIN 
			IF (SELECT ISNULL(NULLIF(HOST,''),@HOST) FROM Sucursal  WHERE Sucursal = @Sucursal)<> @HOST
				SELECT @Ok = 30466  ,@OkRef = ' ('+@HOST+')' 
		END    
      
	IF @CierreiSyncNivel = 'Caja' AND @CodigoAccion NOT IN('ASIGNAR CAJA', NULL)
		BEGIN
			IF (SELECT ISNULL(NULLIF(HOST,''),@HOST) FROM Ctadinero  WHERE CtaDinero = @Caja)<> @HOST
				SELECT @Ok = 304667  ,@OkRef = ' ('+@HOST+')'  
		END        
          
	SELECT /*@ToleranciaRedondeo = ec.CxcAutoAjusteMov,*/ @ArtTarjeta = ec.CxcArticuloTarjetasDef , @ContMoneda = ContMoneda 
    FROM EmpresaCfg ec	  
	WHERE ec.Empresa = @Empresa
  
	SELECT @CfgVentaMonedero = ISNULL(VentaMonedero, 0),
		   @CfgVentaMonederoA =  ISNULL(VentaMonederoA,0)
    FROM EmpresaCfg2	  
	WHERE Empresa = @Empresa
     
	IF EXISTS(SELECT * FROM POSL p JOIN MovTipo m ON m.Mov = p.Mov AND m.Modulo = 'POS'  
		WHERE m.Clave = 'POS.NPC' AND p.Estatus = 'PORCOBRAR' AND p.ID IN (SELECT ID FROM POSLPorCobrar WHERE Estatus = 'TRASPASADO'))   
		UPDATE POSL SET Estatus = 'TRASPASADO'
		FROM POSL p JOIN MovTipo m ON m.Mov = p.Mov AND m.Modulo = 'POS'  
		WHERE m.Clave = 'POS.NPC' AND p.Estatus = 'PORCOBRAR' AND p.ID IN (SELECT ID FROM POSLPorCobrar WHERE Estatus = 'TRASPASADO')  
 
    --DETERMINA LA CLAVE DE AFECTACION DEL MOVIMIENTO EN CUESTION
	SELECT @MovClave = Clave, @MovSubClave = SubClave
    FROM MovTipo mt
	INNER JOIN POSL pl ON mt.Mov = pl.Mov AND pl.ID = @ID
    WHERE mt.Modulo = 'POS'        

	IF @CodigoCambio IS NOT NULL 
		AND @MovClave IN ('POS.F', 'POS.N', 'POS.A','POS.NPC') 
		AND (SELECT ISNULL(fp.PermiteCambio,1) FROM CB INNER JOIN FormaPago fp ON CB.FormaPago = fp.FormaPago WHERE Codigo = @CodigoCambio)= 0
		SELECT @Ok = 30590
 
	--CUANDO EN EL SPPOS SE MANDE EL PARAMETRO CLIENTE, DIRECTAMENTE LO MODIFICARÁ AL CLIENTE SALTANDOSE CUALQUIER OTRA COSA
	IF @Cliente IS NOT NULL AND @Ok IS NULL
		BEGIN 
			EXEC spPOSInsertaCliente2 @Empresa, @ID, @Codigo, @CtaDinero, @Cliente, @Estacion, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
			SELECT @Codigo = NULL
		END	
     
	IF @MovClave IN ('POS.F','POS.N','POS.P','POS.NPC','POS.INVD', 'POS.INVA')AND EXISTS(SELECT * FROM CB WHERE Codigo = @Codigo AND TipoCuenta = 'Articulos')
		BEGIN  
			IF NOT EXISTS(SELECT * FROM POSEstatusCaja WHERE Caja = @Caja)
				SELECT @Ok = 30440, @OkRef = @Caja
     
			IF (SELECT Abierto FROM POSEstatusCaja WHERE Caja = @Caja) = 0
				SELECT @Ok =30440, @OkRef = @Caja
		END    

	--DETERMINAR SI EXISTE ALGUNA ACCION PENDIENTE
	SELECT @Accion = MAX(pa.Accion)
    FROM POSLAccion pa
	WHERE pa.Host = @Host
    AND Caja = @Caja

	--SI EXISTE ALGUNA ACCION PENDIENTE AQUI LLEVA A CABO LA ACCION
	IF @Accion IS NOT NULL
		BEGIN
			IF @Accion = 'ASIGNAR CAJA'
				SELECT @CajaActual = @Codigo
     
			EXEC spPOSAccionEjecutar @Estacion, @Empresa, @Sucursal, @Modulo, @Usuario, @Caja, @ID OUTPUT, @Codigo OUTPUT, @Accion OUTPUT, 
			    @CodigoAccion OUTPUT, @Referencia OUTPUT, @Importe OUTPUT, @MovClave OUTPUT, @CtaDinero OUTPUT, @Mensaje OUTPUT,
			    @Cajero OUTPUT, @SerieLote OUTPUT, @Articulo OUTPUT, @SubCuenta OUTPUT, @Cantidad OUTPUT, @CantidadOriginal OUTPUT,
			    @RenglonUbicado OUTPUT, @ArtConsulta OUTPUT, @AgruparArticulos, 
			    @Mov OUTPUT, @FechaEmision OUTPUT, @Concepto OUTPUT, @Agente OUTPUT, @UEN OUTPUT, @Moneda OUTPUT, @TipoCambio OUTPUT, 
			    @Proyecto OUTPUT, @Cliente OUTPUT, @Condicion OUTPUT, @Almacen OUTPUT, @FormaEnvio OUTPUT, @Vencimiento OUTPUT, 
			    @ListaPreciosEsp OUTPUT, @Descuento OUTPUT, @ArtDescripcion OUTPUT, @DescuentoGlobal OUTPUT, @Imagen OUTPUT, @ZonaImpuesto OUTPUT, 
			    @ImporteSaldoaFavor OUTPUT, @Ok = @OK OUTPUT, @OkRef = @OkRef OUTPUT, @Expresion = @Expresion OUTPUT,
			    @TorretaMensaje1= @TorretaMensaje1 OUTPUT, @TorretaMensaje2 =@TorretaMensaje2  OUTPUT, @TorretaPosicion1= @TorretaPosicion1   OUTPUT,  
				@TorretaPosicion2 = @TorretaPosicion2  OUTPUT, @MovSubClave = @MovSubClave OUTPUT
		END	

	--DETERMINA SI ES UN CODIGO EXTENDIDO
	IF @CodigoExtendido = 1 AND NOT EXISTS(SELECT * FROM CB WHERE Codigo = @Codigo) AND @Accion IS NULL AND @Codigo IS NOT NULL 
		AND NOT EXISTS(SELECT 1 FROM Art WHERE Articulo = @Codigo)
		AND @MovClave NOT IN ('POS.FA','POS.INVD', 'POS.INVA','POS.CXCC','POS.CXCD' ) AND @Ok IS NULL
		BEGIN
			--DETERMINA EL CODIGO
			SELECT @CodigoExtendidoCodigo = @Codigo
			EXEC spPOSSeparadorCodigoExtendido @CodigoExtendidoLetraCodigo, @CodigoExtendidoMascara, @CodigoExtendidoCodigo, 0, @Codigo OUTPUT
      
			IF NOT EXISTS(SELECT * FROM CB WHERE Codigo = @Codigo AND TipoCuenta = 'Articulos')
				BEGIN 
					SELECT @Ok = 72040, @OkRef = @Codigo
				END
			ELSE
				SELECT 
					@Articulo = cb.Cuenta,
					@Subcuenta = cb.SubCuenta,
					@BasculaPesar = a.BasculaPesar
				FROM CB
				INNER JOIN Art a ON cb.Cuenta = a.Articulo
				WHERE cb.Codigo = @Codigo
   
			--DETERMINA EL PESO
			EXEC spPOSSeparadorCodigoExtendido @CodigoExtendidoLetraPeso, @CodigoExtendidoMascara, @CodigoExtendidoCodigo, 
				@CodigoExtendidoDecimalesPeso, @CodigoExtendidoPeso OUTPUT
    
			IF @Ok IS NULL
				IF (SELECT dbo.fnEsNumerico(@CodigoExtendidoPeso)) = 0
					BEGIN
						SELECT @Ok = 20010, @OkRef = @CodigoExtendidoCodigo
					END
				ELSE
					SELECT @Peso = CONVERT(float,@CodigoExtendidoPeso)
 
			IF ISNULL(@BasculaPesar,0) = 0 AND @Ok IS NULL
				SELECT @Ok = 73040, @OkRef = 'El Articulo no esta configurado para pesarse'

			SELECT 
				@Mov = p.Mov, 
				@FechaEmision = p.FechaEmision, 
				@Concepto = p.Concepto, 
				@UEN  = p.UEN, 
				@Proyecto = p.Proyecto, 
				@Moneda = ISNULL(p.Moneda,@MonedaSuc),
				@TipoCambio = p.TipoCambio, 
				@Cliente = p.Cliente,
				@Almacen = p.Almacen, 
				@Agente = p.Agente, 
				@Cajero = p.Cajero, 
				@FormaEnvio = p.FormaEnvio, 
				@Condicion = p.Condicion,
				@Vencimiento = p.Vencimiento, 
				@CtaDinero = p.CtaDinero, 
				@CtaDineroDestino = p.CtaDineroDestino,
				@Descuento = p.Descuento, 
				@DescuentoGlobal = p.DescuentoGlobal,
				@ListaPreciosEsp = p.ListaPreciosEsp, 
				@ZonaImpuesto = p.ZonaImpuesto, 
				@Sucursal = p.Sucursal,
				@MonederoLDI = p.Monedero
			FROM POSL p
			WHERE ID = @ID  
   
			--HACE LA INSERCION
			IF @Ok IS NULL
				BEGIN               
					EXEC spPOSVentaInsertaArticulo @Modulo, @Usuario, @Codigo, @CodigoAccion, @ID, @FechaEmision, @Agente, @Moneda, @TipoCambio, @Condicion, 
						@Almacen, @Proyecto, @FormaEnvio, @Mov, @Empresa, @Sucursal, @ListaPreciosEsp, @Cliente, @CtaDinero, @Accion, @Estacion, 
						@Mensaje OUTPUT, @ArtDescripcion OUTPUT, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @Expresion OUTPUT, @Cantidad = @Peso, 
						@Juego = 0,@TorretaMensaje1= @TorretaMensaje1 OUTPUT, @TorretaMensaje2 =@TorretaMensaje2  OUTPUT, 
						@TorretaPosicion1= @TorretaPosicion1   OUTPUT,  @TorretaPosicion2 = @TorretaPosicion2  OUTPUT
				END
    
			SELECT @Codigo = NULL
		END 
  
	IF @CodigoAccion = 'REVERSAR MOV' AND @Ok IS NULL AND @ID IS NOT NULL AND @Codigo IS NOT NULL
		BEGIN
			EXEC spPOSReversarMovDinero @Empresa, @Sucursal, @Usuario, @ID, @MovClave, @Codigo, @Ok OUTPUT, @OkRef  OUTPUT
			
			DELETE POSLAccion 
			WHERE Host = @Host 
			AND Accion = @CodigoAccion
			AND Caja = @Caja
		END  
  
	--DESCIFRAR EL TIPO DE CUENTA DEL CODIGO PARA DETERMINAR QUE HACER
	SELECT @TipoCuenta = c.TipoCuenta
    FROM CB c	  
	WHERE c.Codigo = @Codigo

	-- VALIDA QUE LA FORMA DE PAGO EXISTA Y SEA EN MONEDA VALIDA
	IF ISNULL(@TipoCuenta,'') = 'Forma Pago' AND @Ok IS NULL
		BEGIN  
			IF (SELECT ISNULL(ISNULL(NULLIF(CASE WHEN @POSMonedaAct = 0 THEN fp.Moneda ELSE fp.POSMoneda END,''), @Moneda),@MonedaSuc) 
				FROM CB cb INNER JOIN FormaPago fp ON cb.FormaPago = fp.FormaPago 
				WHERE cb.Codigo = @Codigo AND cb.TipoCuenta = 'Forma Pago') NOT IN (SELECT Moneda FROM POSLTipoCambioRef WHERE  Sucursal = @Sucursal)
				SELECT @ok = 30600, @okRef = (SELECT cb.FormaPago FROM CB cb WHERE cb.Codigo = @Codigo AND cb.TipoCuenta = 'Forma Pago')
		END
  
	--CUANDO SEA COBRO, DEBERA SER UNA FORMA DE COBRO VALIDA
	IF @Cobro = 1 AND ISNULL(@TipoCuenta,'') <> 'Forma Pago'
		SELECT @Ok = 30530, @OkRef = @Codigo
    
	--AQUI VERIFICA QUE LA CJAA ESTE DESBLOQUEADA
    EXEC spPOSEstatusCajaVerificar @ID, @Caja, @Cajero,'Bloqueado' , @Abierto OUTPUT
    
	IF @Abierto = 1
        SELECT @Ok = 30441, @okRef = @Caja    
   
	-- CUANDO NO HAY NINGUNA ACCION PENDIENTE POR EJECUTAR EN POSLACCION, COMIENZA EL CODIGO NORMAL.
	IF @Accion IS NULL
		BEGIN    	
			IF @TipoCuenta = 'Expresion'
      			SELECT @Expresion = Expresion
      			FROM CB 
      			WHERE Codigo = @Codigo

			--AQUI SE LLEVA A CABO LA ACCION CUANDO EL TIPO CUENTA ES ACCION Y NO HAY UNA ACCION VIGENTE EN ESE MOMENTO.
			IF @TipoCuenta = 'Accion' AND @Ok IN(NULL,30441)
				BEGIN
   					SELECT @CodigoAccion = Accion
      				FROM CB 
      				WHERE Codigo = @Codigo
      	 
      				IF @CodigoAccion = 'DESBLOQUEAR CAJA' SET @Ok = NULL

      				INSERT POSLAccion (
						Host, Caja,  Accion)
      				VALUES (
						@Host, @Caja, @CodigoAccion)
				END
          
			--AQUI DISPARA LA ACCION, QUE NORMALMENTE CONSISTE EN ENVIAR UN MENSAJE PARA EJECUTAR UN CODIGO POSTERIOR.
			IF @CodigoAccion IS NOT NULL AND @Ok IS NULL
				BEGIN
					EXEC spPOSAccionDisparar @Empresa, @Sucursal, @Modulo, @Usuario, @Caja, @Estacion, @ID OUTPUT, @Codigo OUTPUT, @CodigoAccion OUTPUT, 
						@Accion OUTPUT, @FormaPago OUTPUT, @Importe OUTPUT, @CantidadNotasEnProceso, @Imagen OUTPUT, @Mensaje  OUTPUT, 
						@Ok OUTPUT, @OkRef OUTPUT,@Expresion = @Expresion OUTPUT
				END
		END
  
	--CUANDO NO HAYA UN ID, AQUI SE INICIALIZARÁ EL TICKET COMO MOVIMIENTO INICIAL CON TODOS LOS DATOS BASICOS Y POR DEFAULT
	IF ISNULL(@CodigoAccion,'') <> 'MOVIMIENTO NUEVO' AND (@ID IS NULL OR NOT EXISTS(SELECT * FROM POSL p WHERE ID = @ID))
		BEGIN 
			--VALIDA QUE LA MONEDA SEA MONEDA NACIONAL
			SELECT TOP 1 @DefMonedaNacional = Moneda
			FROM POSLTipoCambioRef m
			WHERE TipoCambio = 1 AND Sucursal = @Sucursal  AND EsPrincipal = 1

			SELECT @DefMonedaMov = DefMoneda
			FROM Usuario
			WHERE Usuario = @Usuario
   
			IF @DefMonedaMov <> @DefMonedaNacional
				SELECT @ok = 30040, @OkRef = 'Falta configurar la moneda Correcta en el usuario'
      
			IF NOT EXISTS(SELECT * FROM   POSLTipoCambioRef WHERE Sucursal = @Sucursal  AND Moneda = @ContMoneda) OR NULLIF(@ContMoneda,'') IS NULL
				SELECT @ok = 30040, @OkRef = 'Falta configurar el tipo de cambio de la moneda contable de la empresa ' 
    
			IF @Ok IS NULL	  	
				EXEC spPOSMovNuevo @Empresa, @Modulo, @Sucursal, @Usuario, @Estacion, @ID OUTPUT, @Imagen OUTPUT    
		END 
  
	SELECT 
		@Mov = p.Mov, 
        @FechaEmision = p.FechaEmision, 
        @Concepto = p.Concepto, 
        @UEN  = p.UEN, 
        @Proyecto = p.Proyecto, 
        @Moneda = p.Moneda,
        @TipoCambio = p.TipoCambio, 
        @Cliente = p.Cliente,
        @Almacen = p.Almacen, 
        @Agente = p.Agente, 
        @Cajero = p.Cajero, 
        @FormaEnvio = p.FormaEnvio, 
        @Condicion = p.Condicion,
        @Vencimiento = p.Vencimiento, 
        @CtaDinero = p.CtaDinero, 
        @CtaDineroDestino = p.CtaDineroDestino,
        @Descuento = p.Descuento, 
        @DescuentoGlobal = p.DescuentoGlobal,
        @ListaPreciosEsp = p.ListaPreciosEsp, 
        @ZonaImpuesto = p.ZonaImpuesto, 
        @Sucursal = p.Sucursal,
        @MonederoLDI = p.Monedero
    FROM POSL p
	WHERE ID = @ID  
  
	--CUANDO EL CODIGO INGRESADO NO EXISTA COMO CODIGO, PERO SI SEA LA CLAVE DE UN ARTICULO  
	IF EXISTS(SELECT 1 FROM Art WHERE Articulo = @Codigo) AND @TipoCuenta IS NULL
		BEGIN
			SELECT @Articulo = @Codigo
      
			SELECT 
				@Codigo = cb.Codigo,
				@TipoCuenta = cb.TipoCuenta
			FROM CB cb
			WHERE cb.Cuenta = @Articulo
			AND cb.TipoCuenta = 'Articulos'   
		END
    	  
	IF @TipoCuenta IS NULL AND @Codigo IS NOT NULL AND @CodigoAccion NOT IN('REVERSAR MOV') 
		AND @MovClave NOT IN ('POS.FA','POS.INVD', 'POS.INVA','POS.CXCC','POS.CXCD' ) 
		AND @Accion NOT IN ('MODIFICAR COMPONENTE', 'INTRODUCIR CONCEPTOCXC', 'ALMACEN DESTINO')
		BEGIN     
			IF @TipoCuenta IS NULL AND @Codigo IS NOT NULL --Cuando el codigo sea NULL solamente refescara todo  
				SELECT @RecalcularTodo = 1, @Ok = 72040, @OkRef = @Codigo
		END  
	--AQUI INSERTARÁ EN EL DETALLE CUANDO EL CODIGO SEA VALIDO
	ELSE
		BEGIN
		--AQUI SE INSERTAN TODOS LOS CODIGOS DE BARRAS QUE SON CLIENTES
			IF @TipoCuenta = 'Clientes' AND @Ok IS NULL
				BEGIN
      				EXEC spPOSInsertaCliente @Empresa, @ID, @Codigo, @CtaDinero, NULL, @Estacion, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
				END	
      
			--AQUI SE INSERTAN TODOS LOS CODIGOS DE BARRAS QUE SON ARTICULOS
			IF @TipoCuenta = 'Articulos' AND @Accion NOT IN ('MATRIZ OPCIONES')
				BEGIN
     				EXEC spPOSVentaInsertaArticulo @Modulo, @Usuario, @Codigo, @CodigoAccion, @ID, @FechaEmision, @Agente, @Moneda, @TipoCambio, @Condicion, 
						@Almacen, @Proyecto, @FormaEnvio, @Mov, @Empresa, @Sucursal, @ListaPreciosEsp, @Cliente, @CtaDinero, @Accion, @Estacion, 
						@Mensaje OUTPUT, @ArtDescripcion OUTPUT, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT,@Expresion OUTPUT,
						@TorretaMensaje1= @TorretaMensaje1 OUTPUT, @TorretaMensaje2 =@TorretaMensaje2  OUTPUT, @TorretaPosicion1= @TorretaPosicion1   OUTPUT,  
						@TorretaPosicion2 = @TorretaPosicion2  OUTPUT     	
				END
		END

	--AQUI SE DETERMINAN LOS IMPORTES YA CON IMPUESTOS Y LOS SALDOS DEL MOVIMIENTO
	SELECT @ImporteMov = SUM(dbo.fnPOSImporteMov(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),plv.Impuesto1,plv.Impuesto2,plv.Impuesto3,plv.Cantidad))	  
    FROM POSLVenta plv 
	INNER JOIN POSL p ON p.ID = plv.ID
	WHERE plv.ID = @ID
    AND plv.Articulo <> @ArticuloRedondeo 
  
	SELECT @ImporteMov = ROUND(@ImporteMov,@RedondeoMonetarios)	  
  
	SELECT @Redondeo = plv.Precio
    FROM POSLVenta plv 
	WHERE plv.ID = @ID
    AND plv.Articulo = @ArticuloRedondeo
     
	SELECT @ImporteCobrado = ROUND(SUM(Importe),@RedondeoMonetarios)
    FROM POSLCobro
	WHERE ID = @ID
    AND ISNULL(NULLIF(Referencia,''),'') <> 'COMISION CREDITO'
   
	SELECT @Saldo = (ISNULL(@ImporteMov,0) + ISNULL(@Redondeo,0)) - ISNULL(@ImporteCobrado,0)
    
	IF @Saldo < 0 AND @MovClave NOT IN ('POS.N','POS.NPC','POS.CXCD')
		SELECT @Saldo = 0  

	--CUANDO EL TIPO DE CUENTA ES FORMA DE PAGO
	IF @TipoCuenta = 'Forma Pago' AND @ID IS NOT NULL 
		AND ((@MovClave IN ('POS.A', 'POS.F', 'POS.N','POS.P','POS.NPC','POS.INVD', 'POS.INVA') 
		AND @Importe IS NOT NULL) OR (@MovClave NOT IN ('POS.A', 'POS.F', 'POS.N','POS.P','POS.INVD', 'POS.INVA')))
		BEGIN
			--CUANDO SE COBRE UNA NOTA, FACTURA O ANTICIPO, SE DEBERÁ HACER DESDE LA PANTALLA DE COBRO
			IF @MovClave IN ('POS.A', 'POS.F', 'POS.N','POS.NPC') AND ISNULL(@Cobro,0) = 0
				SELECT @ok = 35050, @Ok = 'Debe realizar el movimiento desde la acción Concluir Movimiento'
      
			IF @Importe IS NOT NULL AND @Ok IS NULL
				EXEC spPOSMovCobrar @Empresa, @Sucursal, @Usuario, @ID, @Codigo, @Referencia, @CtaDinero, @ToleranciaRedondeo, @MovClave, 
					@Monedero, @ImporteRef, @CodigoAccion OUTPUT, @Importe OUTPUT, @Saldo OUTPUT, @Ok OUTPUT, @OkRef OUTPUT,NULL,@RIDCobro OUTPUT
   
			--CUANDO NO HAY IMPORTE, SIGNIFICA QUE COBRO DIRECTO DEL POS, NO DE LA PANTALLA DE COBRO, POR ENDE SE DISPARA UNA ACCION QUE SOLICITA LA FORMA DE COBRO    
			--VERIFICA SI REQUIERE REFERENCIA	
			SELECT 
				@RequiereReferencia = RequiereReferencia,
				@TarjetaBandaMagnetica = TarjetaBandaMagnetica
			FROM CB cb
			INNER JOIN FormaPago fp ON cb.FormaPago = fp.FormaPago
			WHERE cb.Codigo = @Codigo
    
			--SI REQUIERE BANDA MAGNETICA, NO SE PERMITE HACER APERTURA DE CAJA CON ESTA FORMA
			IF @MovClave IN ('POS.AC','POS.AP','POS.ACM','POS.IC','POS.EC') AND @TarjetaBandaMagnetica = 1
				SELECT @Ok = 30600, @OkRef = @Codigo

			--AQUI SE DISPARA UNA ACCION PARA INTRODUCIR LA REFERENCIA EN LA FORMA DE COBRO CUANDO ESTA ES REQUERIDA
			IF @MovClave IN ('POS.AC','POS.AP', 'POS.CC', 'POS.CPC','POS.ACM','POS.CCM','POS.CPCM','POS.TCM','POS.TCAC','POS.IC','POS.EC','POS.TRM')
				SELECT @RequiereReferencia = 0
      
			IF @RequiereReferencia = 1 AND NULLIF(RTRIM(LTRIM(@Referencia)),'') IS NULL AND @Ok IS NULL
				BEGIN
					INSERT POSLAccion (Host, Caja, Accion, FormaPago) VALUES (@Host, @Caja, 'REFERENCIA FORMA PAGO', @Codigo)
					SELECT @Mensaje = 'POR FAVOR INTRODUZCA LA REFERENCIA'
				END
				    
			--AQUI SE DISPARA UNA ACCION PARA INTRODUCIR EL MONTO EN LA FORMA DE COBRO.
			IF @Importe IS NULL AND ((@RequiereReferencia = 1 AND NULLIF(RTRIM(LTRIM(@Referencia)),'') IS NOT NULL) 
				OR (ISNULL(@RequiereReferencia, 0) = 0)) AND @Ok IS NULL AND @TipoCuenta = 'Forma Pago'
				BEGIN     
					-- SE AGREGO AL MENSAJE EL CODIGO DE LA FORMA DE PAGO PARA MAYOR DESCRIPCION JLMR JULIO 2013     
					INSERT POSLAccion (Host, Caja, Accion, FormaPago, Referencia) VALUES (@Host, @Caja, 'MONTO FORMA PAGO', @Codigo, @Referencia)
					SELECT @Mensaje = 'POR FAVOR INTRODUZCA EL MONTO EN '+UPPER(@Codigo)
      
					SELECT @FormaPago = FormaPago
					FROM CB 
					WHERE Codigo = @Codigo        
       
					IF @Ok IS NULL AND @MovClave IN('POS.CC','POS.CPCM', 'POS.CPC','POS.CCM') 
						AND EXISTS(SELECT * FROM FormaPago WHERE  FormaPago = @FormaPago AND POSDenominacion = 1)
						BEGIN         
							IF NOT EXISTS(SELECT * FROM FormaPagoD WHERE  FormaPago = @FormaPago) 
								SELECT @Ok = 30085, @OkRef = @OkRef +ISNULL(@FormaPago,'')
					
							IF @Ok IS NULL
								BEGIN
									DELETE POSLDenominacionTemp WHERE Estacion = @Estacion
             
									INSERT POSLDenominacionTemp(
										ID, Estacion,   FormaPago, Denominacion,Nombre, Cantidad) 
									SELECT                     
										@ID, @Estacion,  @FormaPago,Denominacion,Nombre,0
									FROM FormaPagoD 
									WHERE FormaPago = @FormaPago
           
									IF @Ok IS NULL 
										SELECT @Expresion = 'Asigna(Info.FormaPago,'+CHAR(39)+@MonedaFormaPago+CHAR(39)+') FormaModal('+
											CHAR(39)+'POSLDenominacionTemp'+CHAR(39)+')' 
								END  
						END      
				END
  
			--AQUI SE INSERTA COMO UN RENGLON MAS EL CAMBIO
			IF ISNULL(@ImporteCambio,0) > 0
				BEGIN
					SELECT @ImporteCambio = ROUND(@ImporteCambio * (-1),@RedondeoMonetarios)
					EXEC spPOSMovCobrar @Empresa, @Sucursal, @Usuario, @ID, @CodigoCambio, @Referencia, @CtaDinero, @ToleranciaRedondeo, @MovClave, 
						@Monedero, @ImporteCambio, @CodigoAccion OUTPUT, @ImporteCambio OUTPUT, @Saldo OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, 
						@Cambio = 1, @RIDCobro = @RIDCobro  OUTPUT
				END
 
			--SI YA NO QUEDA SALDO SE CONCLUIRÁ EL MOVIMIENTO 
			SELECT @ImporteMov = SUM(dbo.fnPOSImporteMov(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),plv.Impuesto1,plv.Impuesto2,plv.Impuesto3,plv.Cantidad))
			FROM POSLVenta plv 
			INNER JOIN POSL p ON p.ID = plv.ID
			WHERE plv.ID = @ID    
			AND plv.Articulo <> @ArticuloRedondeo
    
			SELECT @ImporteMov = ROUND(@ImporteMov,@RedondeoMonetarios)	
    
			SELECT @Redondeo = plv.Precio
			FROM POSLVenta plv 
			WHERE plv.ID = @ID
			AND plv.Articulo = @ArticuloRedondeo
       
			SELECT @ImporteCobrado = ROUND(SUM(Importe),@RedondeoMonetarios)
			FROM POSLCobro
			WHERE ID = @ID
			AND ISNULL(NULLIF(Referencia,''),'') <> 'COMISION CREDITO'
     
			SELECT @Saldo = (ISNULL(@ImporteMov,0.0) +ISNULL(@Redondeo,0.0)) - ISNULL(@ImporteCobrado,0.0)
    
			SELECT @Saldo = ROUND(@Saldo,@RedondeoMonetarios)
      
			IF @Saldo < 0 AND @MovClave NOT IN ('POS.N','POS.NPC') 
				SELECT @Saldo = 0  

			--CUANDO SEA VENTA CONCLUIRA AL NO TENER SALDO
			IF @MovClave IN ('POS.N', 'POS.F', 'POS.A','POS.P','POS.NPC','POS.FA','POS.INVD', 'POS.INVA','POS.CXCC','POS.CXCD' ) AND @Ok IS NULL
				BEGIN
					IF ISNULL(@Saldo,0.0) BETWEEN (@ToleranciaRedondeo * (-1)) AND (@ToleranciaRedondeo)
						SELECT @Saldo = 0.0, @CodigoAccion = 'CONCLUIR MOVIMIENTO'
				END


			IF ISNULL(@Saldo,0.0) > 0.0 AND @CodigoAccion <> 'CONCLUIR MOVIMIENTO' AND @MovClave IN ('POS.N', 'POS.F') 
				AND @Mov <> (SELECT POSDefMovDev FROM POSCfg WHERE Empresa = @Empresa) AND @Ok IS NULL
			BEGIN
				SET @FormaPagoRegRestante = 5 

				SELECT @FormaPagoRegistros = COUNT(DISTINCT FormaPago) FROM POSLCobro WITH (NOLOCK) WHERE ID = @ID 

				SET @FormaPagoRegRestante = @FormaPagoRegRestante -  ISNULL(@FormaPagoRegistros,0)

				SELECT @Mensaje = ISNULL(@Mensaje,'') + '   ' + 'PUEDES INGRESAR HASTA ' + CONVERT(varchar,@FormaPagoRegRestante) + ' DIFERENTES FORMAS DE PAGO MAS'

			END


		END

	--VALIDACION DE SUCURSAL
	IF @Sucursal <> @UsuarioSucursal AND ISNULL(@AfectarOtrasSucursalesenLinea,0) = 0
		SELECT @Ok = 3, @OkRef = 'El Usuario no pertenece a esta Sucursal'

	IF @Ok IS NULL AND @MovClave IN ('POS.N','POS.F','POS.NPC') AND (@CfgVentaMonedero = 1  OR @CfgVentaMonederoA = 1)
		AND @CodigoAccion = 'CONCLUIR MOVIMIENTO' AND NOT EXISTS ( SELECT * FROM  POSValeSerie WHERE Serie = @MonederoLDI  ) 
		AND NULLIF(@MonederoLDI,'') IS NOT NULL
		INSERT POSValeSerie (Serie, Sucursal, Estatus, Moneda, Tipo, Cliente)
		SELECT               @MonederoLDI, @Sucursal, 'DISPONIBLE', @MonedaSuc, @TipoMonedero, @Cliente
    
	IF @Ok IS NULL AND  EXISTS (SELECT * FROM POSValeSerie WHERE Serie = @MonederoLDI AND Cliente IS NULL)
		UPDATE POSValeSerie SET Cliente = @Cliente WHERE Serie = @MonederoLDI   

	IF @Ok IS NULL AND @MovClave IN ('POS.N','POS.F','POS.NPC') AND @CfgVentaMonedero = 1  AND @CodigoAccion = 'CONCLUIR MOVIMIENTO' 
		AND EXISTS (SELECT * FROM  POSValeSerie WHERE Serie = @MonederoLDI AND Estatus  IN ('DISPONIBLE','CIRCULACION')) AND @CfgVentaMonederoA = 0
		BEGIN
			IF (SELECT Estatus FROM POSValeSerie WHERE Serie = @MonederoLDI)='DISPONIBLE'
				BEGIN
					SELECT @Unidad = Unidad FROM Art WHERE Articulo =  @ArtTarjeta
					
					SELECT @Renglon = MAX(Renglon)+ 2048.0, @RenglonID = MAX(RenglonID)+1
					FROM POSLVenta WHERE ID = @ID
        
					SELECT  @RenglonTipo = dbo.fnRenglonTipo('SERIE')
					
					INSERT POSLVenta(
						ID, Renglon, RenglonID, RenglonTipo, Cantidad, Articulo, Precio, CantidadInventario, Unidad, EsMonedero)
					SELECT           
						@ID, @Renglon, @RenglonID, @RenglonTipo, 1, @ArtTarjeta, 0.0, 1, @Unidad, 1
      
					IF @@ERROR <> 0 
						SET @Ok = 1

					IF @Ok IS NULL
						INSERT POSLSerieLote (
							ID,  RenglonID, Articulo, SubCuenta, SerieLote)
						VALUES (
							@ID, @RenglonID, @ArtTarjeta, '', @MonederoLDI)

					UPDATE POSValeSerie SET  Estatus = 'CIRCULACION' WHERE Serie = @MonederoLDI
               
					SELECT @RecalcularTodo = 1      
				END
   
			EXEC spPOSVentaMonedero @Empresa, @ID, 'AFECTAR', @FechaEmision, @Usuario, @Sucursal, @MonedaSuc, @TipoCambio, @MonederoLDI, @Ok OUTPUT, @OkRef OUTPUT
		END 
		 
	IF @Ok IS NULL AND @MovClave IN ('POS.N','POS.F','POS.NPC') AND @CodigoAccion = 'CONCLUIR MOVIMIENTO' 
		AND EXISTS (SELECT * FROM  POSValeSerie WHERE Serie = @MonederoLDI AND Estatus  IN ('DISPONIBLE','CIRCULACION')) AND @CfgVentaMonederoA = 0
		DELETE FROM  POSValeSerie WHERE Serie = @MonederoLDI

	IF @CodigoAccion = 'CONCLUIR MOVIMIENTO' AND @Ok IS NULL AND @ID IS NOT NULL AND @MovClave = 'POS.P' AND @MovSubClave NOT IN ('POS.FACCRED')
		BEGIN
			IF (SELECT ValidaFormaEnvio FROM POSCfg WHERE Empresa = @Empresa) = 1
				BEGIN
					IF (SELECT NULLIF(FormaEnvio,'') FROM POSL WHERE ID = @ID) IS NULL
						SELECT @ok = 20703, @OkRef = 'Ejecute Accion '+ (SELECT Codigo FROM CB WHERE TipoCuenta = 'Accion' AND Accion = 'FORMA ENVIO')  
				END  
		END

	IF @MovClave = 'POS.N' AND @MovSubClave = 'POS.PEDCONT'
		BEGIN
			IF (SELECT Condicion FROM POSL WHERE ID = @ID) NOT IN (SELECT Condicion FROM Condicion WHERE ControlAnticipos = 'Cobrar Pedido')
				SELECT @ok = 20705, @OkRef = 'Ejecute Accion '+ (SELECT Codigo FROM CB WHERE TipoCuenta = 'Accion' AND Accion = 'MODIFICAR CONDICION') 
		END
  
	IF @CodigoAccion = 'CONCLUIR MOVIMIENTO' AND @Ok IS NULL AND @ID IS NOT NULL AND @MovClave = 'POS.N' AND @MovSubClave = 'POS.PEDCONT'
		BEGIN
			IF (SELECT ValidaFormaEnvio FROM POSCfg WHERE Empresa = @Empresa) = 1
				BEGIN
					IF (SELECT NULLIF(FormaEnvio,'') FROM POSL WHERE ID = @ID) IS NULL
					SELECT @ok = 20703, @OkRef = 'Ejecute Accion '+ (SELECT Codigo FROM CB WHERE TipoCuenta = 'Accion' AND Accion = 'FORMA ENVIO') 
				END
		END

	IF @CodigoAccion = 'CONCLUIR MOVIMIENTO' AND @Ok IS NULL AND @ID IS NOT NULL 
		AND @MovClave IN ('POS.CC', 'POS.CPC', 'POS.AC','POS.AP','POS.ACM','POS.CCM','POS.CPCM','POS.CAC','POS.CACM','POS.CCC','POS.CCCM')
		BEGIN
			IF (SELECT RequiereConceptoDIN FROM POSCfg WHERE Empresa = @Empresa) = 1
				BEGIN
					IF (SELECT NULLIF(Concepto,'') FROM POSL WHERE ID = @ID) IS NULL
						SELECT @ok = 20704, @OkRef = 'Ejecute Accion '+ (SELECT Codigo FROM CB WHERE TipoCuenta = 'Accion' AND Accion = 'INTRODUCIR CONCEPTODIN') 
				END
		END

	--PARA CONCLUIR 
	IF @CodigoAccion = 'CONCLUIR MOVIMIENTO' AND @Ok IS NULL AND @ID IS NOT NULL AND @MovClave NOT IN ('POS.NPC')
		BEGIN
			EXEC spPOSConcluir @Empresa, @Modulo, @Sucursal, @Usuario, @Saldo, @Estacion, 
				@ID OUTPUT, @Mensaje OUTPUT, @Imagen OUTPUT, @Expresion OUTPUT, @Expresion2 OUTPUT, @Ok OUTPUT, @OkRef  OUTPUT,
				@IDImpresion OUTPUT, @GenerarCFD  OUTPUT, @AfectadoEnLinea OUTPUT
    
			DELETE FROM POSLAccion WHERE Host = @Host AND Accion = @CodigoAccion AND Caja = @Caja
		
			IF @Ok IS NULL AND @Expresion IS NULL
				BEGIN
					IF EXISTS(SELECT * FROM POSReporteTicket WHERE Estacion = @Estacion)
						DELETE POSReporteTicket WHERE Estacion = @Estacion
        
					IF @MovClave = 'POS.P' AND @MovSubClave = 'POS.PEDANT' AND @OK IS NULL
						BEGIN
							IF EXISTS(SELECT * FROM POSLAccion WHERE Host = @Host AND Caja = @Caja AND Accion = @CodigoAccion)
								DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja
       
							DELETE POSConceptoCXCTemp WHERE Estacion = @Estacion   
							
							INSERT POSConceptoCXCTemp(
								Estacion, Concepto)
							SELECT
								@Estacion, Concepto
							FROM Concepto
							WHERE Modulo = 'CXC'
            
							SELECT @Orden = 0
							UPDATE POSConceptoCXCTemp
							SET @Orden = Orden = @Orden + 1
							FROM POSConceptoCXCTemp
							WHERE  Estacion = @Estacion           
       
							SELECT @CodigoAccion = 'INTRODUCIR CONCEPTOCXC'
							SELECT @Mensaje = @Mensaje +'<BR>POR FAVOR INTRODUZCA EL NUMERO DEL CONCEPTO'        
							
							INSERT POSLAccion (
								Host,  Caja, Accion)
							VALUES (
								@Host, @Caja,@CodigoAccion)      
						END  

					--AQUI SE CONCATENA Y SE DEVUELVE EL TICKET Y LOS TOTALES
					EXEC xpPOSConcatenaTicket @CajaActual, @CajeroActual, @IDImpresion, @RecalcularTodo, @Accion, @Codigo, @ArtConsulta, @Sucursal, 
						@Ticket OUTPUT, @Totales, @Saldos, @Total, @Saldo, @CodigoAccion, @Estacion, @DesgloseCC, @EsImpresion = 1
     
					IF @Ok IS NULL
						INSERT POSReporteTicket(
							Estacion, RID, Campo, AbreCajon)
						SELECT                  
							@Estacion, @IDImpresion, Campo ,1
						FROM dbo.fnPOSGenerarTicket(@Ticket,'<BR>')
						ORDER BY ID 
      
					SELECT @ReporteImpresora = 'POSTicket'
					SELECT @Expresion = 'ReporteImpresora(''' +@ReporteImpresora +''', ''' + @IDImpresion + ''')'     
      
					IF EXISTS(SELECT * FROM POSLCobro c JOIN FormaPago f ON f.FormaPago = c.FormaPago WHERE   f.AbreCajon = 1 AND c.ID = @IDImpresion) 
						SELECT @Expresion = @Expresion+' ReporteImpresora('+CHAR(39)+'POSCajonDinero'+CHAR(39)+')'
      
					IF EXISTS(SELECT * FROM POSLCobro c JOIN FormaPago f ON f.FormaPago = c.FormaPago WHERE   f.AbreCajon = 1 AND c.ID = @IDImpresion) 
						SELECT @Expresion2 = 'ReporteImpresora('+CHAR(39)+'POSCajonDinero'+CHAR(39)+')'        
				END  
    
			SELECT @Ticket = NULL
		END
  
    --PARA TRASPASAR A LA SUCURSAL UNA NOTA EN ESTATUS POR COBRAR Y QUE SE PUEDA JALAR DESDE OTRO POSL
	IF @MovClave IN ('POS.NPC') AND @Ok IS NULL AND @ID IS NOT NULL AND @CodigoAccion = 'CONCLUIR MOVIMIENTO'
		BEGIN
			EXEC spPOSTraspasarPorCobrar @Empresa, @Modulo, @Sucursal, @Usuario, @Saldo, @Estacion, 
				@ID OUTPUT, @Mensaje OUTPUT, @Imagen OUTPUT, @Expresion OUTPUT, @IDImprimir OUTPUT, @Ok OUTPUT, @OkRef  OUTPUT
    
			--AQUI SE MANDA UNA EXPRESION EN CASO QUE ESTE CONFIGURADO ALGUN MOVIMIENTO PARA LA IMPRESION
			IF @Ok IS NULL
				BEGIN
					SELECT TOP 1 @ReporteImpresora = ecmi.ReporteImpresora
					FROM EmpresaCfgMovImp ecmi
					WHERE Modulo = 'POS'
					AND Mov = @Mov
					AND Empresa = @Empresa
    
					IF NULLIF(@ReporteImpresora,'') IS NOT NULL
						BEGIN
							SELECT @Expresion = 'ReporteImpresora(''' +@ReporteImpresora +''', ''' + @ID + ''')'
							
							IF EXISTS(SELECT * FROM POSLCobro c JOIN FormaPago f ON f.FormaPago = c.FormaPago WHERE   f.AbreCajon = 1 AND c.ID = @IDImpresion) 
								SELECT @Expresion2 = 'ReporteImpresora('+CHAR(39)+'POSCajonDinero'+CHAR(39)+')'
						END  
				END 
    
			IF @Ok IS NULL AND @Expresion IS NULL
				BEGIN
					IF EXISTS(SELECT * FROM POSReporteTicket WHERE Estacion = @Estacion)
						DELETE POSReporteTicket WHERE Estacion = @Estacion
       
					--AQUI SE CONCATENA Y SE DEVUELVE EL TICKET Y LOS TOTALES
					EXEC xpPOSConcatenaTicket @CajaActual, @CajeroActual, @IDImprimir, @RecalcularTodo, @Accion, @Codigo, @ArtConsulta, @Sucursal, 
						@Ticket OUTPUT , @Totales , @Saldos , @Total , @Saldo, @CodigoAccion, @Estacion,@DesgloseCC, @EsImpresion =1   
     
					IF @Ok IS NULL
						INSERT POSReporteTicket(
							Estacion, RID, Campo, AbreCajon)
						SELECT
							@Estacion, @IDImprimir, Campo , 1
						FROM dbo.fnPOSGenerarTicket(@Ticket,'<BR>')
						ORDER BY ID 

					SELECT @ReporteImpresora = 'POSTicket'
					SELECT @Expresion = 'ReporteImpresora(''' +@ReporteImpresora +''', ''' + @IDImprimir + ''')'  
      
					IF EXISTS(SELECT * FROM POSLCobro c JOIN FormaPago f ON f.FormaPago = c.FormaPago WHERE   f.AbreCajon = 1 AND c.ID = @IDImpresion) 
						SELECT @Expresion2 = 'ReporteImpresora('+CHAR(39)+'POSCajonDinero'+CHAR(39)+')'   
				END  
    
			SELECT @Ticket = NULL       

			IF @Ok IS NULL
				SELECT @Saldo = 0
		END
  
	--AQUI SE INSERTA A POSHOST
	IF @MovClave IN ('POS.N', 'POS.F', 'POS.A','POS.P','POS.NPC','POS.INVD', 'POS.INVA')
		BEGIN
			SELECT 
				@CajaActual = Caja,
  				@CajeroActual = Cajero
			FROM POSL pl
			WHERE pl.ID = @ID
    
			EXEC spPOSHostDatosCaja @Host, @CajaActual, @CajeroActual
		END
    
	IF @Ok IS NOT NULL AND EXISTS(SELECT * FROM POSLDIIDTemp WHERE Estacion = @@SPID)
		BEGIN
			INSERT @LDILog(
				IDModulo, Modulo, Servicio, Fecha, TipoTransaccion, TipoSubservicio, CodigoRespuesta, DescripcionRespuesta, OrigenRespuesta, 
				InfoAdicional, IDTransaccion, CodigoAutorizacion, Comprobante, Cadena, CadenaRespuesta, Importe, RIDCobro) 
			SELECT 
				IDModulo, Modulo, Servicio, Fecha, TipoTransaccion, TipoSubservicio, CodigoRespuesta, DescripcionRespuesta, OrigenRespuesta, 
				InfoAdicional, IDTransaccion, CodigoAutorizacion, Comprobante, Cadena, CadenaRespuesta, Importe, RIDCobro
			FROM POSLDILog 
			WHERE IDModulo = @ID AND ID IN(SELECT ID FROM POSLDIIDTemp WHERE Estacion = @@SPID)
		END

	DELETE POSLDIIDTemp WHERE Estacion = @@SPID
        
	IF @Ok IS NULL
		COMMIT TRAN
	ELSE
		BEGIN
			ROLLBACK TRAN  
    
			--AQUI APAGA LA CONEXION DE LA SUCURSAL
			IF CONVERT(varchar(50),CONTEXT_INFO()) LIKE '%Sucursal%'
				UPDATE POSCfgUbicacionRed 
				SET ConexionActiva = 0
				WHERE Tipo = 'Sucursal'			    
    
			--AQUI APAGA LA CONEXION DE LA MATRIZ   
			IF CONVERT(varchar(50),CONTEXT_INFO()) LIKE '%Matriz%'
				UPDATE POSCfgUbicacionRed 
				SET ConexionActiva = 0
				WHERE Tipo = 'Matriz'			           
       
			SET CONTEXT_INFO 0
		END
    
	IF @Ok IS NULL AND @GenerarCFD = 1  
		BEGIN
			EXEC spPOSAfectarCFD  @IDImpresion, @Empresa, @Sucursal, @Usuario, @AfectadoEnLinea,@Mensaje OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
      
			IF EXISTS(SELECT * FROM POSReporteTicket WHERE Estacion = @Estacion)
				DELETE POSReporteTicket WHERE Estacion = @Estacion

			--AQUI SE CONCATENA Y SE DEVUELVE EL TICKET Y LOS TOTALES
			EXEC xpPOSConcatenaTicket @CajaActual, @CajeroActual, @IDImpresion, @RecalcularTodo, @Accion, @Codigo, @ArtConsulta, @Sucursal, 
				@Ticket OUTPUT , @Totales , @Saldos , @Total , @Saldo	, @CodigoAccion, @Estacion, @DesgloseCC, @EsImpresion = 1
     
			IF @Ok IS NULL
				INSERT POSReporteTicket(
					Estacion, RID, Campo, AbreCajon)
				SELECT
					@Estacion, @IDImpresion, Campo ,1
				FROM dbo.fnPOSGenerarTicket(@Ticket,'<BR>')
				ORDER BY ID 
       
			SELECT  @Ticket = NULL     
		END 
     
	IF EXISTS(SELECT * FROM @LDILog)
		BEGIN
			INSERT POSLDILog(
				IDModulo, Modulo, Servicio, Fecha, TipoTransaccion, TipoSubservicio, CodigoRespuesta, DescripcionRespuesta, OrigenRespuesta, InfoAdicional, 
				IDTransaccion, CodigoAutorizacion, Comprobante, Cadena, CadenaRespuesta, Importe, RIDCobro) 
			SELECT 
				IDModulo, Modulo, Servicio, Fecha, TipoTransaccion, TipoSubservicio, CodigoRespuesta, DescripcionRespuesta, OrigenRespuesta, InfoAdicional, 
				IDTransaccion, CodigoAutorizacion, Comprobante, Cadena, CadenaRespuesta, Importe, RIDCobro    
			FROM @LDILog
		END   
  
	IF (@Accion IN( 'PESAR') AND NULLIF(CONVERT(float,@Codigo),0) IS NULL AND @Ok = 20010) 
		SET @Accion = NULL
  
	IF @Accion IS NOT NULL
		DELETE POSLAccion WHERE Host = @Host AND Accion = ISNULL(@CodigoAccion, @Accion) AND Caja = @Caja
  
	--DETERMINA SI HAY UN SERVICIO EN LA NOTA
	SELECT @Servicio = MAX(LDIServicio)
    FROM POSLVenta plv
	WHERE plv.ID = @ID 

	--DETERMINA LA FORMA DEL SERVICIO
	IF NULLIF(@Servicio, '') IS NOT NULL AND @Servicio IN('IUSACELL','MOVISTAR','NEXTEL','TELCEL','UNEFON')
		SELECT @FormaServicio = plart.Forma
		FROM POSLDIArtRecargaTel plart
		WHERE plart.Servicio = @Servicio
   
	--AQUI SE CONCATENA Y SE DEVUELVE EL TICKET Y LOS TOTALES
	EXEC xpPOSConcatenaTicket @CajaActual, @CajeroActual, @ID, @RecalcularTodo, @Accion, @Codigo, @ArtConsulta, @Sucursal, 
		@Ticket OUTPUT, @Totales OUTPUT, @Saldos OUTPUT, @Total OUTPUT, @Saldo	OUTPUT, @CodigoAccion, @Estacion,@DesgloseC,@EsImpresion
  	
	--AQUI SE DETERMINA LA IMAGEN EN CASO DE NO EXISTIR NINGUNA IMAGEN PREVIA
	IF @Imagen IS NULL
		BEGIN
			SELECT 
				@ImagenNombreAnexo = pc.ImagenNombreAnexo,
				@CantidadNotasEnProceso = pc.CantidadNotasEnProceso
			FROM POSCfg pc
			WHERE pc.Empresa = @Empresa

			SELECT @Imagen = MAX(ac.Direccion)
			FROM AnexoCta ac
			WHERE ac.Nombre = @ImagenNombreAnexo
			AND Rama = 'EMP'
			AND ac.Cuenta = @Empresa
			AND ac.Tipo = 'Imagen'
		END
  
	IF @Ok IS NOT NULL
		BEGIN
			SELECT @Mensaje = Descripcion + ', ' +ISNULL(RTRIM(@OkRef), '') 
			FROM MensajeLista 
			WHERE Mensaje = @Ok
    
			SELECT @ImporteMov = SUM(dbo.fnPOSImporteMov(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),plv.Impuesto1,plv.Impuesto2,plv.Impuesto3,plv.Cantidad))	   
			FROM POSLVenta plv 
			INNER JOIN POSL p ON p.ID = plv.ID
			WHERE plv.ID = @ID
			AND plv.Articulo <> @ArticuloRedondeo AND plv.RenglonTipo <>'C'
    
			SELECT @ImporteMov = ROUND(@ImporteMov,@RedondeoMonetarios)	  
			
			SELECT @Redondeo = plv.Precio
			FROM POSLVenta plv 
			WHERE plv.ID = @ID
			AND plv.Articulo = @ArticuloRedondeo
       
			SELECT @ImporteCobrado = ROUND(SUM(Importe),@RedondeoMonetarios)
			FROM POSLCobro
			WHERE ID = @ID
			AND ISNULL(NULLIF(Referencia,''),'') <> 'COMISION CREDITO'
     
			SELECT @Saldo = (ISNULL(@ImporteMov,0) + ISNULL(@Redondeo,0)) - ISNULL(@ImporteCobrado,0)
      
			IF @Saldo < 0 AND @MovClave NOT IN ('POS.N','POS.NPC','POS.CXCD')
				SELECT @Saldo = 0    
    
			IF @MovClave IN ('POS.N', 'POS.F', 'POS.A','POS.P','POS.NPC','POS.INVD', 'POS.INVA') 
				BEGIN
					IF ISNULL(@Saldo,0.0) BETWEEN (@ToleranciaRedondeo * (-1)) AND (@ToleranciaRedondeo)
					SELECT @Saldo = 0.0
				END
		END  
  
	IF @MovClave IN ('POS.INVD', 'POS.INVA')-- AND @CodigoAccion = 'CONCLUIR MOVIMIENTO'
		SELECT @Total = 0.0, @Saldo = 0.0  
  
	IF @MovClave IN ('POS.P','POS.INVD', 'POS.INVA') AND @CodigoAccion = 'CONCLUIR MOVIMIENTO'
		SELECT @Total = 0.0, @Saldo = 0.0
    
	IF @EnSilencio = 0
		--MUESTRA EL RESULTADO PARA QUE EL POS LO MUESTRE AL USUARIO    
		SELECT ID = @ID, Ticket = @Ticket, Totales = @Totales, RecalcularTodo = @RecalcularTodo, Mensaje = @Mensaje, ArtDescripcion = @ArtDescripcion, 
			Expresion = @Expresion, Total =dbo.fnFormatoMoneda(@Total,@Empresa), Saldo =dbo.fnFormatoMoneda(@Saldo,@Empresa), Saldos = @Saldos, 
			Imagen = @Imagen, Servicio = @Servicio, FormaServicio = @FormaServicio,TorretaMensaje1 = @TorretaMensaje1 ,TorretaMensaje2 = @TorretaMensaje2, 
			TorretaPosicion1 = @TorretaPosicion1, TorretaPosicion2 = @TorretaPosicion2 , Caja = @Caja, HOST = @Host, Exprecion2 = @Expresion2
END
GO


/************************ xpPOSAfectarVentaCobro *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.xpPOSAfectarVentaCobro') AND type = 'P') DROP PROCEDURE dbo.xpPOSAfectarVentaCobro
GO             
CREATE PROCEDURE xpPOSAfectarVentaCobro
	@IDAnterior		varchar(50),
    @IDNuevo		varchar(50),
    @Empresa        varchar(5),
    @Sucursal       int,    	     
    @Ok				int				OUTPUT,
    @OkRef			varchar(255)	OUTPUT  	     
AS 
BEGIN  
	DECLARE 
	@ContMoneda				varchar(10),
	@RedondeosMonetarios	int,
	@POSMoneda1				varchar(10),
	@POSMoneda2				varchar(10),
	@POSMoneda3				varchar(10),
	@POSMoneda4				varchar(10),
	@POSMoneda5				varchar(10)

	SELECT @RedondeosMonetarios = RedondeosMonetarios 
	FROM POSCfg 
	WHERE Empresa = @Empresa 
	
	SELECT @ContMoneda = RTRIM(ContMoneda) 
	FROM EmpresaCfg 
	WHERE Empresa = @Empresa

    IF (Select POSMonedaAct from POSCfg where Empresa = @Empresa) = 1
		BEGIN
			SELECT @POSMoneda1 = NULL, @POSMoneda2 = NULL, @POSMoneda3 = NULL, @POSMoneda4 = NULL, @POSMoneda5 = NULL
			SELECT @POSMoneda1 = RTRIM(NULLIF(POSMoneda,'')) FROM FormaPago WHERE FormaPago = (SELECT FormaCobro1 FROM VentaCobro WHERE ID = @IDNuevo)
			SELECT @POSMoneda2 = RTRIM(NULLIF(POSMoneda,'')) FROM FormaPago WHERE FormaPago = (SELECT FormaCobro2 FROM VentaCobro WHERE ID = @IDNuevo)
			SELECT @POSMoneda3 = RTRIM(NULLIF(POSMoneda,'')) FROM FormaPago WHERE FormaPago = (SELECT FormaCobro3 FROM VentaCobro WHERE ID = @IDNuevo)
			SELECT @POSMoneda4 = RTRIM(NULLIF(POSMoneda,'')) FROM FormaPago WHERE FormaPago = (SELECT FormaCobro4 FROM VentaCobro WHERE ID = @IDNuevo)
			SELECT @POSMoneda5 = RTRIM(NULLIF(POSMoneda,'')) FROM FormaPago WHERE FormaPago = (SELECT FormaCobro5 FROM VentaCobro WHERE ID = @IDNuevo)

			IF @POSMoneda1 IS NOT NULL AND @POSMoneda1 <>  @ContMoneda
				UPDATE VentaCobro SET Referencia1 = 'POS ' + CONVERT(VARCHAR,Importe1) +' TC. ' + 
				CONVERT(VARCHAR,POSTipoCambio1), Importe1 = ROUND((Importe1 * POSTipoCambio1),@RedondeosMonetarios), POSTipoCambio1 = 1 WHERE ID = @IDNuevo    
			IF @POSMoneda2 IS NOT NULL AND @POSMoneda2 <>  @ContMoneda
				UPDATE VentaCobro SET Referencia2 = 'POS ' + CONVERT(VARCHAR,Importe2) +' TC. ' + 
				CONVERT(VARCHAR,POSTipoCambio2), Importe2 = ROUND((Importe2 * POSTipoCambio2),@RedondeosMonetarios), POSTipoCambio2 = 1 WHERE ID = @IDNuevo
			IF @POSMoneda3 IS NOT NULL AND @POSMoneda3 <>  @ContMoneda
				UPDATE VentaCobro SET Referencia3 = 'POS ' + CONVERT(VARCHAR,Importe3) +' TC. ' + 
				CONVERT(VARCHAR,POSTipoCambio3), Importe3 = ROUND((Importe3 * POSTipoCambio3),@RedondeosMonetarios), POSTipoCambio3 = 1 WHERE ID = @IDNuevo
			IF @POSMoneda4 IS NOT NULL AND @POSMoneda4 <>  @ContMoneda
				UPDATE VentaCobro SET Referencia4 = 'POS ' + CONVERT(VARCHAR,Importe4) +' TC. ' + 
				CONVERT(VARCHAR,POSTipoCambio4), Importe4 = ROUND((Importe4 * POSTipoCambio4),@RedondeosMonetarios), POSTipoCambio4 = 1 WHERE ID = @IDNuevo
			IF @POSMoneda5 IS NOT NULL AND @POSMoneda5 <>  @ContMoneda
				UPDATE VentaCobro SET Referencia5 = 'POS ' + CONVERT(VARCHAR,Importe5) +' TC. ' + 
				CONVERT(VARCHAR,POSTipoCambio5), Importe5 = ROUND((Importe5 * POSTipoCambio5),@RedondeosMonetarios), POSTipoCambio5 = 1 WHERE ID = @IDNuevo
		END

	RETURN
END
GO


/************************ spPOSAfectarVentaCobro *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAfectarVentaCobro') AND type = 'P') DROP PROCEDURE dbo.spPOSAfectarVentaCobro
GO             
CREATE PROCEDURE spPOSAfectarVentaCobro
	@IDAnterior		varchar(50),
    @IDNuevo		varchar(50),
    @Empresa        varchar(5),
    @Sucursal       int,    	     
    @Ok				int				OUTPUT,
    @OkRef			varchar(255)	OUTPUT
--//WITH ENCRYPTION    	     
AS 
BEGIN   
	DECLARE 
	@Importe				float,
    @FormaCobro				varchar(50),
    @Referencia				varchar(50),          
  	@Importe1				float,
	@Importe2				float,
	@Importe3				float,
	@Importe4				float,
	@Importe5				float,
	@FormaCobro1			varchar(50),
	@FormaCobro2			varchar(50),
	@FormaCobro3			varchar(50),
	@FormaCobro4			varchar(50),
	@FormaCobro5			varchar(50),
	@Referencia1			varchar(50),
	@Referencia2			varchar(50),
	@Referencia3			varchar(50),
	@Referencia4			varchar(50),
	@Referencia5			varchar(50),
	@Caja					varchar(10),		
	@Cajero					varchar(10),
	@TipoCambio				float,
	@TipoCambio1			float,
	@TipoCambio2			float,
	@TipoCambio3			float,
	@TipoCambio4			float,
	@TipoCambio5			float,
	@Monedero				varchar(20),
	@FormaCobroMonedero		varchar(50),
	@MonederoTipoCambio		float,
    @MonederoImporte		float,
    @ContMoneda				varchar(10),
    @Moneda					varchar(10),
    @ContMonedaTC			float
	    
	SELECT @FormaCobroMonedero = CxcFormaCobroTarjetas, @ContMoneda = ContMoneda 
	FROM EmpresaCfg
	WHERE Empresa = @Empresa
   
	SELECT @Moneda = Moneda 
	FROM POSL 
	WHERE ID = @IDAnterior
	
	SELECT @ContMonedaTC = TipoCambio 
	FROM POSLTipoCambioRef 
	WHERE Sucursal = @Sucursal AND Moneda = @ContMoneda

	SELECT TOP 1 
		@Caja = Caja,
	    @Cajero = Cajero
    FROM POSLCobro plc
	WHERE plc.ID = @IDAnterior

	CREATE TABLE #POSCobro (
	ImporteRef				float,
    FormaPago				varchar(50),
    Referencia				varchar(50)	NULL,
    TipoCambio				float,
    Monedero				varchar(36)	NULL,
    MonederoTipoCambio		float		NULL,
    MonederoImporte			float		NULL)

	INSERT INTO #POSCobro (ImporteRef, FormaPago, Referencia, TipoCambio, Monedero, MonederoTipoCambio, MonederoImporte)
    SELECT SUM(ISNULL(p.ImporteRef,0)),
           p.FormaPago, 
           dbo.fnPOSVentaCobroReferencia(p.ID, p.FormaPago, p.TipoCambio, p.MonederoTipoCambio),
           p.TipoCambio,
           dbo.fnPOSVentaCobroMonedero(p.ID, p.FormaPago, p.MonederoTipoCambio),
           p.MonederoTipoCambio,
           dbo.fnPOSVentaCobroMonederoImporte(p.ID, p.FormaPago, p.MonederoTipoCambio)
    FROM POSLCobro p	
    WHERE ID = @IDAnterior
	GROUP BY p.ID, p.FormaPago, p.TipoCambio, p.MonederoTipoCambio
 	      
	DECLARE crPOSCobro CURSOR LOCAL FOR	  
    SELECT TOP 5 p.ImporteRef,
           p.FormaPago, 
           p.Referencia,
           p.TipoCambio,
           p.Monedero,
           p.MonederoTipoCambio,
           p.MonederoImporte
	FROM #POSCobro p	
     
	OPEN crPOSCobro
	FETCH NEXT FROM crPOSCobro INTO @Importe, @FormaCobro, @Referencia, @TipoCambio, @Monedero, @MonederoTipoCambio, @MonederoImporte      
	WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @@FETCH_STATUS <> -2
				BEGIN
					IF @Importe1 IS NULL
						BEGIN
      						SELECT @Importe1 = @Importe, @FormaCobro1 = @FormaCobro, @Referencia1 = @Referencia, @TipoCambio1 = @TipoCambio
						END
					ELSE IF @Importe2 IS NULL
							BEGIN
      							SELECT @Importe2 = @Importe, @FormaCobro2 = @FormaCobro, @Referencia2 = @Referencia, @TipoCambio2 = @TipoCambio
							END
						ELSE IF @Importe3 IS NULL
							BEGIN
      							SELECT @Importe3 = @Importe, @FormaCobro3 = @FormaCobro, @Referencia3 = @Referencia, @TipoCambio3 = @TipoCambio
							END
						ELSE IF @Importe4 IS NULL
							BEGIN
      							SELECT @Importe4 = @Importe, @FormaCobro4 = @FormaCobro, @Referencia4 = @Referencia, @TipoCambio4 = @TipoCambio
							END
						ELSE IF @Importe5 IS NULL
							BEGIN
      							SELECT @Importe5 = @Importe, @FormaCobro5 = @FormaCobro, @Referencia5 = @Referencia, @TipoCambio5 = @TipoCambio
							END
						
					IF @FormaCobro = @FormaCobroMonedero AND @Monedero IS NOT NULL
						BEGIN      
							IF NOT EXISTS (SELECT * FROM TarjetaSerieMov WHERE Empresa = @Empresa AND Modulo = 'VTAS' AND ID = @IDNuevo AND Serie = @Monedero)
       							INSERT TarjetaSerieMov(
									Empresa, ID, Modulo, Serie, Sucursal, Importe, TipoCambioTarjeta, ImporteTarjeta)
         						SELECT
									@Empresa, @IDNuevo, 'VTAS', @Monedero, @Sucursal, @MonederoImporte, @MonederoTipoCambio, @Importe    
       						ELSE
								UPDATE TarjetaSerieMov SET Importe = ISNULL(Importe,0.0)+@MonederoImporte, TipoCambioTarjeta = @MonederoTipoCambio,
								ImporteTarjeta = ISNULL(ImporteTarjeta,0.0)+ISNULL(@Importe,0.0)
								WHERE Empresa = @Empresa AND Modulo = 'VTAS' AND ID = @IDNuevo AND Serie = @Monedero  
          
							IF @@ERROR <> 0 
								SET @Ok = 1 
						END 	      
				END
    
			FETCH NEXT FROM crPOSCobro INTO @Importe, @FormaCobro, @Referencia, @TipoCambio, @Monedero, @MonederoTipoCambio, @MonederoImporte     
		END
	CLOSE crPOSCobro
	DEALLOCATE crPOSCobro 
  
	INSERT VentaCobro (
		ID, Importe1, Importe2, Importe3, Importe4, Importe5, FormaCobro1, FormaCobro2, FormaCobro3, FormaCobro4, FormaCobro5, 
		Referencia1, Referencia2, Referencia3, Referencia4, Referencia5, CtaDinero, Cajero,POSTipoCambio1, POSTipoCambio2, 
		POSTipoCambio3, POSTipoCambio4, POSTipoCambio5 )
	VALUES (
		@IDNuevo, @Importe1, @Importe2, @Importe3, @Importe4, @Importe5, @FormaCobro1, @FormaCobro2, @FormaCobro3, @FormaCobro4, @FormaCobro5,
		@Referencia1, @Referencia2, @Referencia3, @Referencia4, @Referencia5, @Caja, @Cajero, @TipoCambio1, @TipoCambio2, 
		@TipoCambio3, @TipoCambio4, @TipoCambio5)	
  
	IF @@ERROR <> 0 
		SET @Ok = 1 
                      
	IF @Ok IS NULL
		EXEC xpPOSAfectarVentaCobro @IDAnterior, @IDNuevo, @Empresa, @Sucursal, @Ok OUTPUT, @OkRef OUTPUT	                    
END
GO


/************************ spPOSInsertarPOSVentaCobro *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarPOSVentaCobro') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarPOSVentaCobro
GO
CREATE PROCEDURE spPOSInsertarPOSVentaCobro
	@ID         	varchar(50),
    @Empresa        varchar(5),
    @Sucursal       int,    	     
    @Ok				int		OUTPUT,
    @OkRef			varchar(255)	OUTPUT
--//WITH ENCRYPTION    	     
AS 
BEGIN   
	DECLARE 
	@Importe				float,
    @FormaCobro				varchar(50),
    @Referencia				varchar(50),          
  	@Importe1				float,
	@Importe2				float,
	@Importe3				float,
	@Importe4				float,
	@Importe5				float,
	@FormaCobro1			varchar(50),
	@FormaCobro2			varchar(50),
	@FormaCobro3			varchar(50),
	@FormaCobro4			varchar(50),
	@FormaCobro5			varchar(50),
	@Referencia1			varchar(50),
	@Referencia2			varchar(50),
	@Referencia3			varchar(50),
	@Referencia4			varchar(50),
	@Referencia5			varchar(50),
	@Caja					varchar(10),		
	@Cajero					varchar(10),
	@TipoCambio				float,
	@TipoCambio1			float,
	@TipoCambio2			float,
	@TipoCambio3			float,
	@TipoCambio4			float,
	@TipoCambio5			float,
	@Monedero				varchar(20),
	@FormaCobroMonedero		varchar(50),
	@MonederoTipoCambio		float,
    @MonederoImporte		float,
    @Condicion				varchar(50)  
	    
	SELECT @FormaCobroMonedero = CxcFormaCobroTarjetas 
	FROM EmpresaCfg
	WHERE Empresa = @Empresa
  
	IF EXISTS(SELECT * FROM POSVentaCobro WHERE ID = @ID)
		DELETE POSVentaCobro WHERE ID = @ID
    
	SELECT TOP 1 
		@Caja = Caja,
	    @Cajero = Cajero
    FROM POSLCobro plc
	WHERE plc.ID = @ID
 	      
	SELECT @Condicion =  Condicion 
    FROM POSL
    WHERE ID = @ID 

	CREATE TABLE #POSCobro (
	ImporteRef				float,
    FormaPago				varchar(50),
    Referencia				varchar(50)	NULL,
    TipoCambio				float,
    Monedero				varchar(36)	NULL,
    MonederoTipoCambio		float		NULL,
    MonederoImporte			float		NULL)

	INSERT INTO #POSCobro (ImporteRef, FormaPago, Referencia, TipoCambio, Monedero, MonederoTipoCambio, MonederoImporte)
    SELECT SUM(ISNULL(p.ImporteRef,0)),
           p.FormaPago, 
           dbo.fnPOSVentaCobroReferencia(p.ID, p.FormaPago, p.TipoCambio, p.MonederoTipoCambio),
           p.TipoCambio,
           dbo.fnPOSVentaCobroMonedero(p.ID, p.FormaPago, p.MonederoTipoCambio),
           p.MonederoTipoCambio,
           dbo.fnPOSVentaCobroMonederoImporte(p.ID, p.FormaPago, p.MonederoTipoCambio)
    FROM POSLCobro p	
    WHERE ID = @ID
	GROUP BY p.ID, p.FormaPago, p.TipoCambio, p.MonederoTipoCambio
 	      
	DECLARE crPOSCobro CURSOR LOCAL FOR	      
    SELECT TOP 5 p.ImporteRef,
           p.FormaPago, 
           p.Referencia,
           p.TipoCambio,
           p.Monedero,
           p.MonederoTipoCambio,
           p.MonederoImporte
	FROM #POSCobro p	
     
	OPEN crPOSCobro
	FETCH NEXT FROM crPOSCobro INTO @Importe, @FormaCobro, @Referencia, @TipoCambio, @Monedero, @MonederoTipoCambio, @MonederoImporte      
	WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @@FETCH_STATUS <> -2
				BEGIN
					IF @Importe1 IS NULL
						BEGIN
      						SELECT @Importe1 = @Importe, @FormaCobro1 = @FormaCobro, @Referencia1 = @Referencia, @TipoCambio1 = @TipoCambio
						END
					ELSE IF @Importe2 IS NULL
						BEGIN
      						SELECT @Importe2 = @Importe, @FormaCobro2 = @FormaCobro, @Referencia2 = @Referencia, @TipoCambio2 = @TipoCambio
						END
					ELSE IF @Importe3 IS NULL
						BEGIN
      						SELECT @Importe3 = @Importe, @FormaCobro3 = @FormaCobro, @Referencia3 = @Referencia, @TipoCambio3 = @TipoCambio
						END
					ELSE IF @Importe4 IS NULL
						BEGIN
      						SELECT @Importe4 = @Importe, @FormaCobro4 = @FormaCobro, @Referencia4 = @Referencia, @TipoCambio4 = @TipoCambio
						END
					ELSE IF @Importe5 IS NULL
						BEGIN
      						SELECT @Importe5 = @Importe, @FormaCobro5 = @FormaCobro, @Referencia5 = @Referencia, @TipoCambio5 = @TipoCambio
						END
      
					IF @FormaCobro = @FormaCobroMonedero AND @Monedero IS NOT NULL
						BEGIN      
       						INSERT POSTarjetaSerieMov(
								Empresa, ID, Modulo, Serie, Sucursal, Importe, TipoCambioTarjeta, ImporteTarjeta)
       						SELECT
								@Empresa, @ID, 'VTAS', @Monedero, @Sucursal, @MonederoImporte, @MonederoTipoCambio, @Importe       
       						
							IF @@ERROR <> 0 
								SET @Ok = 1 
						END 	
				END
    
			FETCH NEXT FROM crPOSCobro INTO @Importe, @FormaCobro, @Referencia, @TipoCambio, @Monedero, @MonederoTipoCambio, @MonederoImporte     
		END
	CLOSE crPOSCobro
	DEALLOCATE crPOSCobro 
  
	INSERT POSVentaCobro (
		ID, Importe1, Importe2, Importe3, Importe4, Importe5, FormaCobro1, FormaCobro2, FormaCobro3, FormaCobro4, FormaCobro5, 
		Referencia1, Referencia2, Referencia3, Referencia4, Referencia5, CtaDinero, Cajero,POSTipoCambio1, POSTipoCambio2, 
		POSTipoCambio3, POSTipoCambio4, POSTipoCambio5, Condicion )
	VALUES (
		@ID, @Importe1, @Importe2, @Importe3, @Importe4, @Importe5, @FormaCobro1, @FormaCobro2, @FormaCobro3, @FormaCobro4, @FormaCobro5,
		@Referencia1, @Referencia2, @Referencia3, @Referencia4, @Referencia5, @Caja, @Cajero, @TipoCambio1, @TipoCambio2, 
		@TipoCambio3, @TipoCambio4, @TipoCambio5, @Condicion)	
  
	IF @@ERROR <> 0 
		SET @Ok = 1                     
END
GO


/************************ xpPOSAfectarDineroD *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.xpPOSAfectarDineroD') AND type = 'P') DROP PROCEDURE dbo.xpPOSAfectarDineroD
GO             
CREATE PROCEDURE xpPOSAfectarDineroD
	@IDAnterior		varchar(50),
    @IDNuevo		varchar(50),
    @Sucursal		int,
    @MovClave       varchar(20),
    @Ok				int		OUTPUT,
    @OkRef			varchar(255)	OUTPUT 	     
AS 
BEGIN
	DECLARE 
	@Empresa				varchar(5),
	@RedondeosMonetarios	int,
	@Moneda					varchar(10),
	@TipoCambio				float,
	@Renglon				int,
	@ImporteD				money,
	@TipoCambioD			float,
	@ReferenciaD			varchar(50),
	@DecimalesCantidades	int,
	@Fondo					varchar(50)
	
	SELECT @Empresa = Empresa 
	FROM Dinero 
	WHERE ID = @IDNuevo
	
	SELECT @RedondeosMonetarios = RedondeosMonetarios 
	FROM POSCfg 
	WHERE Empresa = @Empresa
	
	SELECT @DecimalesCantidades = DecimalesCantidades 
	FROM EmpresaGral 
	WHERE Empresa = @Empresa
	
	SELECT TOP 1 @Moneda = Moneda, @TipoCambio = TipoCambio 
	FROM POSLTipoCambioRef 
	WHERE EsPrincipal = 1 AND Sucursal = @Sucursal 
	
	SELECT @Fondo = NULLIF(F8,'') 
	FROM POSCobroFormasPago 
	WHERE Empresa = @Empresa AND Sucursal = @Sucursal 
	 
	IF (SELECT POSMonedaAct FROM POSCfg WHERE Empresa = @Empresa) = 1 AND @MovClave IN ('POS.CPC','POS.CC')
		BEGIN
			IF EXISTS (SELECT dd.* FROM DineroD dd JOIN FormaPago fp ON dd.FormaPago = fp.FormaPago WHERE dd.ID = @IDNuevo AND fp.POSMoneda <> @Moneda)
				BEGIN
					DECLARE crST1 CURSOR LOCAL FOR			
					SELECT dd.Renglon, dd.Importe, dd.TipoCambio, dd.Referencia
					FROM DineroD dd
					JOIN FormaPago fp ON dd.FormaPago = fp.FormaPago
					WHERE dd.ID = @IDNuevo 
					AND fp.POSMoneda <> @Moneda
		   
					OPEN crST1
					FETCH NEXT FROM crST1 INTO @Renglon, @ImporteD, @TipoCambioD, @ReferenciaD
					WHILE @@FETCH_STATUS <> -1 
						BEGIN
							IF @@FETCH_STATUS <> -2 
								BEGIN			
									UPDATE DineroD SET 
										Importe = ROUND (@ImporteD * @TipoCambioD, @DecimalesCantidades), 
										Referencia = 'POS ' + CONVERT(VARCHAR,@ImporteD) + ' TC. ' + CONVERT(VARCHAR,@TipoCambioD),
										TipoCambio = @TipoCambio,
										Moneda = @Moneda
									WHERE ID = @IDNuevo 
									AND Renglon = @Renglon 									   
								END							
							FETCH NEXT FROM crST1 INTO @Renglon, @ImporteD, @TipoCambioD, @ReferenciaD
						END
					CLOSE crST1
					DEALLOCATE crST1
					
					UPDATE Dinero SET Importe = (SELECT SUM(ISNULL(Importe,0)) FROM DineroD WHERE ID = @IDNuevo) WHERE ID = @IDNuevo
				END	
		END

	IF (SELECT POSMonedaAct FROM POSCfg WHERE Empresa = @Empresa) = 1 AND @MovClave IN ('POS.FTE','POS.STE') AND (SELECT Moneda  FROM Dinero WHERE ID = @IDNuevo) <> @Moneda
		BEGIN
			DECLARE crST2 CURSOR LOCAL FOR			
			SELECT dd.Renglon, dd.Importe, dd.TipoCambio, dd.Referencia
			FROM DineroD dd
			JOIN FormaPago fp ON dd.FormaPago = fp.FormaPago
			WHERE dd.ID = @IDNuevo 
		    AND fp.POSMoneda <> @Moneda
		   
			OPEN crST2
			FETCH NEXT FROM crST2 INTO @Renglon, @ImporteD, @TipoCambioD, @ReferenciaD
			WHILE @@FETCH_STATUS <> -1 
				BEGIN
					IF @@FETCH_STATUS <> -2 
						BEGIN			
							UPDATE DineroD SET 
								Importe = ROUND (@ImporteD * @TipoCambioD, @DecimalesCantidades), 
								Referencia = 'POS ' + CONVERT(VARCHAR,@ImporteD) + ' TC. ' + CONVERT(VARCHAR,@TipoCambioD),
								TipoCambio = @TipoCambio,
								Moneda = @Moneda
							WHERE ID = @IDNuevo 
							AND Renglon = @Renglon 
						END
			
					FETCH NEXT FROM crST2 INTO @Renglon, @ImporteD, @TipoCambioD, @ReferenciaD
				END
			CLOSE crST2
			DEALLOCATE crST2
		
			UPDATE Dinero SET Importe = (SELECT SUM(ISNULL(Importe,0)) FROM DineroD WHERE ID = @IDNuevo), Moneda = @Moneda, TipoCambio = @TipoCambio WHERE ID = @IDNuevo
		END	

	IF (SELECT POSMonedaAct FROM POSCfg WHERE Empresa = @Empresa) = 1 AND @MovClave IN ('POS.TCM') 
		BEGIN
			DECLARE crST2 CURSOR LOCAL FOR			
			SELECT dd.Renglon, dd.Importe, dd.TipoCambio, dd.Referencia
			FROM DineroD dd
			JOIN FormaPago fp ON dd.FormaPago = fp.FormaPago
			WHERE dd.ID = @IDNuevo 
		    AND fp.POSMoneda <> @Moneda
		   
			OPEN crST2
			FETCH NEXT FROM crST2 INTO @Renglon, @ImporteD, @TipoCambioD, @ReferenciaD
			WHILE @@FETCH_STATUS <> -1 
				BEGIN
					IF @@FETCH_STATUS <> -2 
						BEGIN			
							UPDATE DineroD SET 
								Importe = ROUND (@ImporteD * @TipoCambioD, @DecimalesCantidades), 
								Referencia = 'POS ' + CONVERT(VARCHAR,@ImporteD) + ' TC. ' + CONVERT(VARCHAR,@TipoCambioD),
								TipoCambio = @TipoCambio,
								Moneda = @Moneda
							WHERE ID = @IDNuevo 
							AND Renglon = @Renglon 						   
						END
			
					FETCH NEXT FROM crST2 INTO @Renglon, @ImporteD, @TipoCambioD, @ReferenciaD
				END
			CLOSE crST2
			DEALLOCATE crST2
		
			UPDATE Dinero SET Importe = (SELECT SUM(ISNULL(Importe,0)) FROM DineroD WHERE ID = @IDNuevo), Moneda = @Moneda, TipoCambio = @TipoCambio WHERE ID = @IDNuevo
		END	

    IF @MovClave = 'POS.CC' --AND (SELECT TOP 1 Importe FROM DineroD WHERE ID = @IDNuevo) = 0
		BEGIN    
			DELETE FROM DineroD WHERE ID = @IDNuevo AND Importe = 0 AND FormaPago <> @Fondo
   
			IF EXISTS (SELECT * FROM DineroD WHERE ID = @IDNuevo AND FormaPago <> @Fondo) AND (SELECT Importe FROM DineroD WHERE ID = @IDNuevo AND FormaPago = @Fondo) = 0
				DELETE FROM DineroD WHERE ID = @IDNuevo AND FormaPago = @Fondo
		END

	RETURN
END
GO


/************************ spPOSAfectarDineroD *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAfectarDineroD') AND type = 'P') DROP PROCEDURE dbo.spPOSAfectarDineroD
GO             
CREATE PROCEDURE spPOSAfectarDineroD
	@IDAnterior		varchar(50),
    @IDNuevo		varchar(50),
    @Sucursal		int,
    @MovClave       varchar(20),
    @Ok				int		OUTPUT,
    @OkRef			varchar(255)	OUTPUT
--//WITH ENCRYPTION    	     
AS 
BEGIN   
	DECLARE 
	@Importe				float,
    @FormaCobro				varchar(50),
    @Referencia				varchar(50),
	@Renglon				float,
	@CtaDinero				varchar(10),
	@CtaDineroDestino		varchar(10),
	@Moneda					varchar(10),
	@MonedaMov				varchar(10),
	@TipoCambio				float,
	@ContMoneda				varchar(10),
	@Empresa				varchar(5),
    @ContMonedaTC	        float
            
	SELECT @MonedaMov = Moneda, @Empresa = Empresa 
	FROM POSL 
	WHERE ID = @IDAnterior	        
	
	SELECT @ContMoneda = ec.ContMoneda
    FROM EmpresaCfg ec	  
	WHERE ec.Empresa = @Empresa   
   
	SELECT @ContMonedaTC = TipoCambio 
	FROM POSLTipoCambioRef 
	WHERE Sucursal = @Sucursal AND Moneda = @ContMoneda            	  
    
	DECLARE crPOSCobro CURSOR LOCAL FOR	  
    SELECT p.ImporteRef,
           p.FormaPago, 
           Referencia = ISNULL(NULLIF(p.Referencia,''), 'MOVIMIENTO POS'),
           CtaDinero,
           CtaDineroDestino,
           MonedaRef,
           CASE WHEN @MonedaMov <> @ContMoneda THEN  (TipoCambio/@ContMonedaTC) ELSE TipoCambio END           
	FROM POSLCobro p	
    WHERE ID = @IDAnterior
    AND NULLIF(MonedaRef,'') IS NOT NULL
     
	OPEN crPOSCobro
	FETCH NEXT FROM crPOSCobro INTO @Importe, @FormaCobro, @Referencia,@CtaDinero,@CtaDineroDestino,@Moneda,@TipoCambio
	WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @@FETCH_STATUS <> -2
				BEGIN
					SELECT @Renglon = ISNULL(@Renglon,0) + 2048

					IF @MovClave IN('POS.ACM','POS.CCM','POS.CPCM','POS.TCM','POS.CACM','POS.CCCM','POS.CCPCM','POS.CTCM','POS.TRM','POS.CTRM')
						BEGIN
							IF @MovClave NOT IN('POS.TCM','POS.CTCM')
								BEGIN
									INSERT DineroD (
										ID, Renglon, Importe, FormaPago, Referencia, Sucursal,Moneda,TipoCambio,CtaDinero,CtaDineroDestino)
									VALUES (
										@IDNuevo, @Renglon, @Importe, @FormaCobro, @Referencia, @Sucursal,@Moneda,@TipoCambio,@CtaDinero,@CtaDineroDestino)             
								END        
        
							IF @MovClave  IN('POS.TCM','POS.CTCM')
								BEGIN
									INSERT DineroD (
										ID, Renglon, Importe, FormaPago, Referencia, Sucursal,Moneda,TipoCambio,CtaDinero,CtaDineroDestino)
									VALUES (
										@IDNuevo, @Renglon, @Importe, @FormaCobro, @Referencia, @Sucursal,@Moneda,@TipoCambio,@CtaDineroDestino,@CtaDinero)
								END            
						END          
                
					IF @MovClave NOT IN('POS.ACM','POS.CCM','POS.CPCM','POS.TCM','POS.CACM','POS.CCCM','POS.CCPCM','POS.CTCM','POS.TRM','POS.CTRM')
						BEGIN
							INSERT DineroD (
								ID, Renglon, Importe, FormaPago, Referencia, Sucursal,Moneda,TipoCambio,CtaDinero,CtaDineroDestino)
							VALUES (
								@IDNuevo, @Renglon, @Importe, @FormaCobro, @Referencia, @Sucursal,@Moneda,@TipoCambio,@CtaDinero,@CtaDineroDestino)              
						END          
				END

			FETCH NEXT FROM crPOSCobro INTO @Importe, @FormaCobro, @Referencia,@CtaDinero,@CtaDineroDestino,@Moneda,@TipoCambio
		END
	CLOSE crPOSCobro
	DEALLOCATE crPOSCobro 

	IF @MovClave IN('POS.ACM','POS.CCM','POS.CPCM','POS.TCM','POS.TRM','POS.AC','POS.CC','POS.CPC','POS.CAC')
		BEGIN
			SELECT TOP 1 @Moneda = Moneda 
			FROM POSLTipoCambioRef m
			WHERE TipoCambio = 1 AND Sucursal = @Sucursal 

			IF EXISTS (SELECT * FROM DineroD WHERE Moneda = @Moneda AND ID = @IDNuevo)
				BEGIN 
					SELECT TOP 1 @CtaDinero = CtaDinero,@CtaDineroDestino = CtaDineroDestino,@TipoCambio=TipoCambio
					FROM DineroD WHERE ID = @IDNuevo AND Moneda = @Moneda
				END
			ELSE
				BEGIN
					SELECT TOP 1 @Moneda = Moneda ,@CtaDinero = CtaDinero,@CtaDineroDestino = CtaDineroDestino,@TipoCambio=TipoCambio
					FROM DineroD WHERE ID = @IDNuevo
				END

			UPDATE Dinero SET Importe = (SELECT SUM(ImporteRef * TipoCambio) FROM POSLCobro WHERE ID = @IDAnterior),--Moneda =@Moneda ,TipoCambio = @TipoCambio,
				CtaDinero = @CtaDinero,CtaDineroDestino = @CtaDineroDestino,FormaPago = NULL
			WHERE ID = @IDNuevo
		END 

	IF @MovClave NOT IN('POS.ACM','POS.CCM','POS.CPCM','POS.TCM','POS.TRM','POS.AC','POS.CC','POS.CPC','POS.CACM','POS.CAC','POS.IC','POS.EC')
		BEGIN
			SELECT TOP 1 @Moneda = MonedaRef ,@TipoCambio = TipoCambio,@CtaDinero = CtaDinero,@CtaDineroDestino = CtaDineroDestino
			FROM POSLCobro
			WHERE ID = @IDAnterior
       
			SELECT @Importe =SUM(ImporteRef) FROM POSLCobro WHERE ID = @IDAnterior  
    
			IF @MovClave IN ('POS.FTE','POS.STE')
				SELECT @CtaDinero = NULL,@CtaDineroDestino  = NULL   
    
			UPDATE Dinero SET Importe = ISNULL(@Importe,ISNULL(Importe,0.0)),
				CtaDinero = ISNULL(@CtaDinero,CtaDinero),CtaDineroDestino = ISNULL(@CtaDineroDestino,CtaDineroDestino)
			WHERE ID = @IDNuevo    
		END  
  
	IF @MovClave IN('POS.IC','POS.EC')
		BEGIN
			SELECT TOP 1 @Moneda = MonedaRef ,@TipoCambio = TipoCambio,@CtaDinero = CtaDinero,@CtaDineroDestino = CtaDineroDestino
			FROM POSLCobro
			WHERE ID = @IDAnterior
       
			SELECT @Importe =SUM(ImporteRef) FROM POSLCobro WHERE ID = @IDAnterior  
    
			IF @MovClave IN ('POS.FTE','POS.STE')
				SELECT @CtaDinero = NULL,@CtaDineroDestino  = NULL   
    
			UPDATE Dinero SET Importe = ISNULL(@Importe,ISNULL(Importe,0.0)),
				CtaDinero = ISNULL(@CtaDinero,CtaDinero),CtaDineroDestino = ISNULL(@CtaDineroDestino,CtaDineroDestino), Moneda = @Moneda,TipoCambio = @TipoCambio
			WHERE ID = @IDNuevo    
		END
  
	IF @MovClave IN ('POS.CC', 'POS.CPC', 'POS.AC','POS.AP','POS.IC','POS.EC') 
		BEGIN
			SELECT @Importe =SUM(ImporteRef) FROM POSLCobro WHERE ID = @IDAnterior 
			UPDATE Dinero SET Moneda = @Moneda, TipoCambio = @TipoCambio, Importe = @Importe WHERE ID = @IDNuevo     
		END  
END
GO


/************************ spPOSInsertarCxcCobroDetalle *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarCxcCobroDetalle') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarCxcCobroDetalle
GO             
CREATE PROCEDURE spPOSInsertarCxcCobroDetalle
	@ID         	varchar(50),
    @IDGenerar		int,
    @Empresa        varchar(5),
    @Sucursal       int, 
    @Usuario        varchar(10),
    @Moneda			varchar(10),   	  
    @MovClave       varchar(20),   	     
    @Ok				int		OUTPUT,
    @OkRef			varchar(255)	OUTPUT
--//WITH ENCRYPTION    	     
AS 
BEGIN   
	DECLARE 
	@Importe				float,
    @ImporteTotal			float,
    @FormaCobro				varchar(50),
    @Referencia				varchar(50),          
  	@Importe1				float,
	@Importe2				float,
	@Importe3				float,
	@Importe4				float,
	@Importe5				float,
	@FormaCobro1			varchar(50),
	@FormaCobro2			varchar(50),
	@FormaCobro3			varchar(50),
	@FormaCobro4			varchar(50),
	@FormaCobro5			varchar(50),
	@Referencia1			varchar(50),
	@Referencia2			varchar(50),
	@Referencia3			varchar(50),
	@Referencia4			varchar(50),
	@Referencia5			varchar(50),
	@Caja					varchar(10),		
	@Cajero					varchar(10),
	@TipoCambio				float,
	@Monedero				varchar(20),
	@FormaCobroMonedero		varchar(50),
	@Mov					varchar(20),
	@MovID					varchar(20),
	@MonederoTipoCambio		float,
    @MonederoImporte		float,
	@Aplica					varchar(20),
	@AplicaID				varchar(20),
	@Saldo					float,
	@Cliente				varchar(10), 
	@ContMoneda				varchar(10),
    @ContMonedaTC			float,  
    @FechaEmision			datetime,  
    @Agente					varchar(10),  
	@CteEnviarA				int,      
	@CtaDinero				varchar(10),  
	@Condicion				varchar(50),  
	@Impuestos				float,  
	@IDNuevo				varchar(36),  
	@ImporteRef				float  
     
	SELECT @FormaCobroMonedero = CxcFormaCobroTarjetas, @ContMoneda = ContMoneda 
	FROM EmpresaCfg
	WHERE Empresa = @Empresa
	
	SELECT @ContMonedaTC = TipoCambio 
	FROM POSLTipoCambioRef 
	WHERE Sucursal = @Sucursal AND Moneda = @ContMoneda	  
	
	SELECT TOP 1 @Aplica = Aplica, @AplicaID = AplicaID 
	FROM POSLVenta 
	WHERE ID = @ID
    
	SELECT @ImporteTotal = SUM(ImporteRef) 
	FROM POSLCobro 
	WHERE ID = @ID
	
	SELECT @Cliente = Cliente 
	FROM Cxc 
	WHERE ID = @IDGenerar
  
	IF @MovClave = 'POS.CXCD'
		BEGIN
			SELECT TOP 1 @FormaCobro = FormaPago, @TipoCambio = TipoCambio FROM POSLCobro  WHERE ID = @ID
			SELECT @ImporteTotal = SUM(ImporteRef*-1) FROM POSLCobro  WHERE ID = @ID
		END
  
	-- ACTUALIZO EL IMPORTE PARA EL COBRO DE DOCUMENTOS EN BASE AL DETALLE  
	IF @MovClave = 'POS.CXCC'  
		BEGIN  
			SELECT @ImporteTotal = SUM(Precio*-1) FROM POSLVenta  WHERE ID = @ID  
		END  
      
	IF @Ok IS NULL AND @IDGenerar IS NOT NULL AND @MovClave IN('POS.CXCC')
		BEGIN
			DECLARE crPOSCobro CURSOR LOCAL FOR	  
			SELECT TOP 5 (p.ImporteRef), p.FormaPago, p.Referencia, p.TipoCambio, p.Monedero, p.MonederoTipoCambio, p.MonederoImporte
			FROM POSLCobro p	
			WHERE ID = @ID AND Referencia NOT IN('COMISION CREDITO')  
     
			OPEN crPOSCobro
			FETCH NEXT FROM crPOSCobro INTO @Importe, @FormaCobro, @Referencia, @TipoCambio, @Monedero, @MonederoTipoCambio, @MonederoImporte      
			WHILE @@FETCH_STATUS <> -1
				BEGIN
					IF @@FETCH_STATUS <> -2
						BEGIN
							IF @Importe1 IS NULL
								BEGIN
      								SELECT @Importe1 = @Importe, @FormaCobro1 = @FormaCobro, @Referencia1 = @Referencia
								END
							ELSE IF @Importe2 IS NULL
								BEGIN
      								SELECT @Importe2 = @Importe, @FormaCobro2 = @FormaCobro, @Referencia2 = @Referencia
								END
							ELSE IF @Importe3 IS NULL
								BEGIN
      								SELECT @Importe3 = @Importe, @FormaCobro3 = @FormaCobro, @Referencia3 = @Referencia
								END
							ELSE IF @Importe4 IS NULL
								BEGIN
      								SELECT @Importe4 = @Importe, @FormaCobro4 = @FormaCobro, @Referencia4 = @Referencia
								END
							ELSE IF @Importe5 IS NULL
								BEGIN
      								SELECT @Importe5 = @Importe, @FormaCobro5 = @FormaCobro, @Referencia5 = @Referencia
								END
							
							IF @FormaCobro = @FormaCobroMonedero AND @Monedero IS NOT NULL
								BEGIN      
       								INSERT TarjetaSerieMov(
										Empresa, ID, Modulo, Serie, Sucursal, Importe, TipoCambioTarjeta, ImporteTarjeta)
       								SELECT
										@Empresa, @IDGenerar, 'VTAS', @Monedero, @Sucursal, @MonederoImporte, @MonederoTipoCambio, @Importe       
       	
									IF @@ERROR <> 0 
										SET @Ok = 1 
								END 	      
						END
    
					FETCH NEXT FROM crPOSCobro INTO @Importe, @FormaCobro, @Referencia, @TipoCambio, @Monedero, @MonederoTipoCambio, @MonederoImporte     
				END
			CLOSE crPOSCobro
			DEALLOCATE crPOSCobro 
		END

	SELECT @ImporteRef = SUM(ISNULL(p.ImporteRef,0))  
    FROM POSLCobro p   
    WHERE ID = @ID AND Referencia IN('COMISION CREDITO')  
              
    UPDATE Cxc 
       SET ConDesglose= CASE WHEN @MovClave = 'POS.CXCC' THEN  1 ELSE  0 END, 
           Moneda = @Moneda,
           TipoCambio = CASE WHEN @Moneda <> @ContMoneda THEN  (@TipoCambio/@ContMonedaTC) ELSE @TipoCambio END,
           ClienteMoneda = @Moneda,
           ClienteTipoCambio = CASE WHEN @Moneda <> @ContMoneda THEN  (@TipoCambio/@ContMonedaTC) ELSE @TipoCambio END,
           FormaCobro1 = @FormaCobro1,
           FormaCobro2 = @FormaCobro2,
           FormaCobro3 = @FormaCobro3,
           FormaCobro4 = @FormaCobro4,
           FormaCobro5 = @FormaCobro5,
           Importe1 = @Importe1,
           Importe2 = @Importe2,
           Importe3 = @Importe3,
           Importe4 = @Importe4,
           Importe5 = @Importe5,
           Referencia1 = @Referencia1,
           Referencia2 = @Referencia2,
           Referencia3 = @Referencia3,
           Referencia4 = @Referencia4,
           Referencia5 = @Referencia5,
           Importe = (CASE WHEN @MovClave = 'POS.CXCC' 
								THEN ISNULL(@Importe1,0.0)+ISNULL(@Importe2,0.0)+ISNULL(@Importe3,0.0)+ISNULL(@Importe4,0.0)+ISNULL(@Importe5,0.0) 
						   ELSE @ImporteTotal 
						   END),
           OrigenTipo = 'POS',
           AplicaManual = 1,
           FormaCobro = CASE WHEN @MovClave = 'POS.CXCD' THEN  @FormaCobro ELSE  NULL END
	  WHERE ID = @IDGenerar    
    
	IF @@ERROR <> 0 
		SET @Ok = 1	 
    
	SELECT @Saldo = ISNULL(Saldo,0.0) 
	FROM Cxc 
	WHERE Empresa = @Empresa AND Mov = @Aplica AND MovID = @AplicaID AND Estatus IN ('PENDIENTE', 'CONCLUIDO')
    
    --LINEAS ORIGINALES  
	IF @MovClave = 'POS.CXCD'  
		BEGIN  
			INSERT CxcD (
				ID, Renglon, RenglonSub, Importe, Aplica,  AplicaID, SucursalOrigen)
			SELECT
				@IDGenerar, 2048.0, 0, CASE WHEN (@ImporteTotal > @Saldo) 
												THEN @Saldo 
											ELSE @ImporteTotal 
											END, @Aplica, @AplicaID, @Sucursal    
		END  
   
	INSERT POSHistMoratorios(
		FechaCobro, ID, POSMov, POSMovID, IDGenerado, CXCMov, CXCMovID, Saldo, Moratorios, TasaMoratorios, DiasMoratorios, Moneda, Sucursal, 
		Empresa, Aplica, AplicaID)  
	SELECT
		GETDATE(), a.ID, a.Mov, a.MovID, @IDGenerar, @Mov, @MovID, a.CXCSaldoTotal, b.Precio, b.TasaMoratorios, b.DiasMoratorios, a.Moneda, @Sucursal, 
		@Empresa, b.Aplica, b.AplicaID    
    FROM POSL a JOIN POSLVenta b on a.ID = b.ID  
    WHERE a.ID = @ID       
    AND b.Articulo = 'MORATORIO'  
              
    IF @@ERROR <> 0 
		SET @Ok = 1	 
    
    IF (@ImporteTotal > @Saldo)
		BEGIN
			INSERT CxcAplicaDif(
				ID, Mov, Concepto, Importe, Impuestos, Cliente, Sucursal, SucursalOrigen)
			SELECT
				@IDGenerar,'Saldo a Favor', NULL, (@ImporteTotal-@Saldo), 0.0, @Cliente, @Sucursal, @Sucursal 
			
			IF @@ERROR <> 0 
				SET @Ok = 1	
		END      
END
GO


/************************ spPOSAfectarCxcGenerarCobro *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAfectarCxcGenerarCobro') AND type = 'P') DROP PROCEDURE dbo.spPOSAfectarCxcGenerarCobro
GO             
CREATE PROCEDURE spPOSAfectarCxcGenerarCobro
	@IDAnterior		varchar(50),
    @IDNuevo		int,
    @Empresa        varchar(5),
    @Sucursal       int, 
    @Usuario        varchar(10),
    @Moneda			varchar(10),   	     	     
    @Ok				int		OUTPUT,
    @OkRef			varchar(255)	OUTPUT
--//WITH ENCRYPTION    	     
AS 
BEGIN   
	DECLARE 
	@Importe				float,
    @FormaCobro				varchar(50),
    @Referencia				varchar(50),          
  	@Importe1				float,
	@Importe2				float,
	@Importe3				float,
	@Importe4				float,
	@Importe5				float,
	@FormaCobro1			varchar(50),
	@FormaCobro2			varchar(50),
	@FormaCobro3			varchar(50),
	@FormaCobro4			varchar(50),
	@FormaCobro5			varchar(50),
	@Referencia1			varchar(50),
	@Referencia2			varchar(50),
	@Referencia3			varchar(50),
	@Referencia4			varchar(50),
	@Referencia5			varchar(50),
	@Caja					varchar(10),		
	@Cajero					varchar(10),
	@TipoCambio				float,
	@Monedero				varchar(20),
	@FormaCobroMonedero		varchar(50),
	@Mov					varchar(20),
	@MovID					varchar(20),
	@IDGenerar				int,
	@MonederoTipoCambio		float,
    @MonederoImporte		float,	  
    @ContMoneda				varchar(10),
    @ContMonedaTC			float

	SELECT @FormaCobroMonedero = CxcFormaCobroTarjetas, @ContMoneda = ContMoneda 
	FROM EmpresaCfg
	WHERE Empresa = @Empresa
   
	SELECT @ContMonedaTC = TipoCambio 
	FROM POSLTipoCambioRef 
	WHERE Sucursal = @Sucursal AND Moneda = @ContMoneda	    
   
	IF @OK IS NULL
		EXEC @IDGenerar = spAfectar 'CXC', @IDNuevo, 'GENERAR', 'Todo', 'Cobro', @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT

	IF @Ok IS NULL 
		SET @Ok = 1  
    
	IF @Ok BETWEEN 80030 AND 81000
		SET @Ok = NULL
       
	IF @Ok IS NULL AND @IDGenerar IS NOT NULL
		BEGIN
			DECLARE crPOSCobro CURSOR LOCAL FOR	  
			SELECT TOP 5 p.ImporteRef, p.FormaPago, p.Referencia, p.TipoCambio, p.Monedero, p.MonederoTipoCambio, p.MonederoImporte
			FROM POSLCobro p	
			WHERE ID = @IDAnterior
     
			OPEN crPOSCobro
			FETCH NEXT FROM crPOSCobro INTO @Importe, @FormaCobro, @Referencia, @TipoCambio, @Monedero, @MonederoTipoCambio, @MonederoImporte      
			WHILE @@FETCH_STATUS <> -1
				BEGIN
					IF @@FETCH_STATUS <> -2
						BEGIN
							IF @Importe1 IS NULL
								BEGIN
      								SELECT @Importe1 = @Importe, @FormaCobro1 = @FormaCobro, @Referencia1 = @Referencia
								END
							ELSE IF @Importe2 IS NULL
								BEGIN
      								SELECT @Importe2 = @Importe, @FormaCobro2 = @FormaCobro, @Referencia2 = @Referencia
								END
							ELSE IF @Importe3 IS NULL
								BEGIN
      								SELECT @Importe3 = @Importe, @FormaCobro3 = @FormaCobro, @Referencia3 = @Referencia
								END
							ELSE IF @Importe4 IS NULL
								BEGIN
      								SELECT @Importe4 = @Importe, @FormaCobro4 = @FormaCobro, @Referencia4 = @Referencia
								END
							ELSE IF @Importe5 IS NULL
								BEGIN
      								SELECT @Importe5 = @Importe, @FormaCobro5 = @FormaCobro, @Referencia5 = @Referencia
								END
      
							IF @FormaCobro = @FormaCobroMonedero AND @Monedero IS NOT NULL
								BEGIN      
       								INSERT TarjetaSerieMov(
										Empresa, ID, Modulo, Serie, Sucursal, Importe, TipoCambioTarjeta, ImporteTarjeta)
       								SELECT
										@Empresa, @IDNuevo, 'VTAS', @Monedero, @Sucursal, @MonederoImporte, @MonederoTipoCambio, @Importe       
       	
									IF @@ERROR <> 0 
										SET @Ok = 1 
								END 	
						END
    
					FETCH NEXT FROM crPOSCobro INTO @Importe, @FormaCobro, @Referencia, @TipoCambio, @Monedero, @MonederoTipoCambio, @MonederoImporte     
				END
			CLOSE crPOSCobro
			DEALLOCATE crPOSCobro 
		END

    UPDATE Cxc 
       SET ConDesglose = 1, 
           Moneda = @Moneda,
           TipoCambio = CASE WHEN @Moneda <> @ContMoneda THEN  (@TipoCambio/@ContMonedaTC) ELSE @TipoCambio END,
           ClienteMoneda = @Moneda,
           ClienteTipoCambio = CASE WHEN @Moneda <> @ContMoneda THEN  (@TipoCambio/@ContMonedaTC) ELSE @TipoCambio END,
           FormaCobro1 = @FormaCobro1,
           FormaCobro2 = @FormaCobro2,
           FormaCobro3 = @FormaCobro3,
           FormaCobro4 = @FormaCobro4,
           FormaCobro5 = @FormaCobro5,
           Importe1 = @Importe1,
           Importe2 = @Importe2,
           Importe3 = @Importe3,
           Importe4 = @Importe4,
           Importe5 = @Importe5,
           Referencia1 = @Referencia1,
           Referencia2 = @Referencia2,
           Referencia3 = @Referencia3,
           Referencia4 = @Referencia4,
           Referencia5 = @Referencia5,
           Importe = ISNULL(@Importe1,0.0)+ISNULL(@Importe2,0.0)+ISNULL(@Importe3,0.0)+ISNULL(@Importe4,0.0)+ISNULL(@Importe5,0.0),
           OrigenTipo = 'POS'
	WHERE ID = @IDGenerar    
    
	IF @@ERROR <> 0 
		SET @Ok = 1	  
  
	IF (@Ok IS NULL OR @Ok = 80030) AND @IDGenerar IS NOT NULL
		EXEC spAfectar 'CXC', @IDGenerar, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT
      
	IF @Ok BETWEEN 80030 AND 81000
		SET @Ok = NULL
END
GO


/************************ spPOSGeneraAjuste *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSGeneraAjuste') AND type = 'P') DROP PROCEDURE dbo.spPOSGeneraAjuste
GO 
CREATE PROCEDURE spPOSGeneraAjuste
	@Empresa		varchar(5),  
	@Sucursal		int,  
	@ID				int,  
	@Moneda			varchar(10),
	@FechaEmision	datetime,
	@TipoCambio		float,
	@Almacen		varchar(10),
	@Usuario		varchar(10),	
	@Ok				int = NULL			OUTPUT,
	@OkRef			varchar(255) = NULL	OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN  
	DECLARE 
	@AjusteMov				varchar(20),
	@AjusteID				int,
	@Estacion				int,
	@Renglon				float,
	@RenglonID				int,
	@UEN					int,
	@Lote					varchar(50),
	@Costo					float,
	@Factor					float,		
	@TipoCosteo				varchar(20),
	@SeriesLotesAutoOrden	varchar(20),
	@Articulo				varchar(20), 
	@SubCuenta				varchar(50),
	@Unidad					varchar(50),
	@Disponible				float, 
	@LotesFijos				bit,
	@Proveedor				varchar(10),
	@ArtTipo				varchar(20),
	@CantidadAjusteLote     float,
	@Observaciones			varchar(100),
	@Concepto				varchar(50)
			
	IF EXISTS (SELECT * FROM Venta WITH (NOLOCK) 
		WHERE ID = @ID AND Sucursal = @Sucursal AND Almacen = @Almacen AND Usuario = @Usuario AND Estatus = 'SINAFECTAR' AND UPPER(Mov) IN ('NOTA', 'FACTURA'))
		BEGIN    	
			SELECT @Usuario = AutoAjusteUsuario, @Concepto = AutoAjusteConcepto 
			FROM POSCfg 
			WHERE Empresa = @Empresa 
  
			SELECT @Proveedor = NULL, @Costo = NULL
			
			SELECT @UEN = UEN 
			FROM Usuario 
			WHERE Usuario = @Usuario
  
			SELECT @AjusteMov = InvAjuste 
			FROM EmpresaCfgMov 
			WHERE Empresa = @Empresa	
  
			SELECT @Observaciones = 'POS ' + Mov + ' ' + MovID + ' ID : ' + CONVERT(VARCHAR,ID) 
			FROM Venta 
			WHERE ID = @ID 

			SELECT 
				@TipoCosteo	= ISNULL(NULLIF(RTRIM(UPPER(TipoCosteo)), ''), 'PROMEDIO'),
				@SeriesLotesAutoOrden = UPPER(SeriesLotesAutoOrden)
			FROM EmpresaCfg
			WHERE Empresa = @Empresa
	
			SELECT @Estacion = @@SPID
			
			DELETE ListaID WHERE Estacion = @Estacion
			INSERT INTO ListaID (Estacion, ID) VALUES (@Estacion, @ID)
    
			-- AUTO AJUSTE
			CREATE TABLE #tmpAjuste1 (
				Id         int identity(1,1) NOT NULL,
				Estacion   int               NULL,
				Almacen    varchar(20)       COLLATE DATABASE_DEFAULT NULL,
				Articulo   varchar(20)       COLLATE DATABASE_DEFAULT NULL,
				Subcuenta  varchar(20)       COLLATE DATABASE_DEFAULT NULL,
				Disponible float             NULL,
				Unidad     varchar(50)       COLLATE DATABASE_DEFAULT NULL,
				Lotesfijos bit               NOT NULL DEFAULT 0)

			INSERT INTO #tmpAjuste1 (
				Estacion, Almacen, Articulo, Subcuenta, Disponible, Unidad, lotesFijos)
			SELECT
				@Estacion, d.Almacen,	d.Articulo, NULLIF(RTRIM(d.SubCuenta), ''), ROUND(d.Disponible-vd.Cantidad, 4), a.Unidad, ISNULL(a.LotesFijos, 0)
			FROM ArtSubDisponible d WITH (NOLOCK)
			JOIN Art a WITH (NOLOCK) ON d.Articulo = a.Articulo 
			JOIN Alm	WITH (NOLOCK) ON d.Almacen = Alm.Almacen 
			JOIN VentaD vd WITH (NOLOCK) ON d.Articulo = vd.Articulo 
			JOIN ListaID l ON l.ID = vd.ID AND l.Estacion = @Estacion 
			WHERE a.Articulo = d.Articulo AND (ROUND(d.Disponible, 4) - ROUND(vd.Cantidad,4)) < 0.0
			AND d.Almacen = @Almacen  AND alm.Sucursal = @Sucursal AND d.Empresa = @Empresa
       
			DELETE FROM #tmpAjuste1 WHERE Articulo NOT IN (SELECT Articulo FROM VentaD WHERE ID = @ID)

			SELECT @Renglon = 0, @RenglonID = 0
			
			DECLARE crRojo CURSOR FOR 
			SELECT t.Almacen, t.Articulo, t.Subcuenta, t.Disponible, t.Unidad, t.lotesFijos, a.Tipo
			FROM #tmpAjuste1 t
			JOIN Art a ON t.Articulo = a.Articulo
			WHERE Estacion = @Estacion
    
			OPEN crRojo
			FETCH NEXT FROM crRojo INTO @Almacen, @Articulo, @SubCuenta, @Disponible, @Unidad, @LotesFijos, @ArtTipo
			WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
				BEGIN
					IF @@FETCH_STATUS <> -2 
						BEGIN 
							IF @Renglon = 0
								BEGIN
									INSERT Inv (
										Sucursal, SucursalOrigen, Empresa, Mov, FechaEmision, Moneda, TipoCambio, Almacen, Concepto, Usuario, Estatus,
										OrigenTipo, UEN, Referencia, Observaciones)
									VALUES (
										@Sucursal, @Sucursal, @Empresa, @AjusteMov,  @FechaEmision, @Moneda, @TipoCambio, @Almacen, @Concepto, @Usuario, 'CONFIRMAR',
										NULL, @UEN,	'mercancia con existencia fisica POS', @Observaciones)
									
									SELECT @AjusteID = SCOPE_IDENTITY()
								END
        
							SELECT @Lote = NULL, @Costo = NULL
							SELECT @Factor = ISNULL(Factor, 1) FROM Unidad WHERE Unidad = @Unidad

							-- LEER INVERSO
							IF @LotesFijos = 1
								BEGIN
									IF @SeriesLotesAutoOrden = 'ASCENDENTE' 
										SELECT @Lote = (SELECT TOP 1 Lote FROM ArtLoteFijo WHERE Articulo = @Articulo ORDER BY Lote DESC) 
									ELSE
										SELECT @Lote = (SELECT TOP 1 Lote FROM ArtLoteFijo WHERE Articulo = @Articulo ORDER BY Lote)

									SELECT @Lote = NULLIF(RTRIM(@Lote), '')
									
									IF @Lote IS NOT NULL
										SELECT @Costo = MIN(CostoPromedio)*@Factor 
										FROM SerieLote 
										WHERE Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = ISNULL(@SubCuenta, '') 
										AND SerieLote = @Lote AND Almacen = @Almacen
								END

							IF @Costo IS NULL
								EXEC spVerCosto @Sucursal, @Empresa, @Proveedor, @Articulo, @SubCuenta, @Unidad, @TipoCosteo, @Moneda, @TipoCambio, @Costo OUTPUT, 0

							SELECT @Renglon = @Renglon + 2048, @RenglonID = @RenglonID + 1 
							
							INSERT InvD (
								Sucursal, SucursalOrigen, ID, Renglon, RenglonSub, RenglonID, Almacen, Articulo, SubCuenta, Unidad, Cantidad,
								CantidadInventario, Costo)
							VALUES (
								@Sucursal, @Sucursal, @AjusteID, @Renglon, 0, @RenglonID, @Almacen, @Articulo, @SubCuenta, @Unidad, -@Disponible/@Factor, 
								-@Disponible, @Costo)

							IF @LotesFijos = 1 AND @Lote IS NOT NULL
								INSERT SerieLoteMov (
									Empresa, Sucursal, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad) 
								VALUES (
									@Empresa, @Sucursal, 'INV', @AjusteID, @RenglonID, @Articulo, ISNULL(@SubCuenta, ''), @Lote, -@Disponible/@Factor)
							ELSE
								-- INICIO AJUSTES DE ARTICULOS TIPO LOTE VENDIDOS SIN EXISTENCIA
								IF (SELECT NotasBorrador FROM EmpresaCFG WHERE Empresa = @Empresa) = 1 AND @ArtTipo IN ('SERIE','LOTE')
									BEGIN
										INSERT SerieLoteMov (
											Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, ArtCostoInv, Cantidad, 
											CantidadAlterna, Sucursal,Propiedades)
										SELECT 
											@Empresa, 'INV', @AjusteID, @RenglonID, @Articulo, ISNULL(@SubCuenta, ''), s.SerieLote, s.ArtCostoInv, SUM(ABS(sl.Existencia)),
											SUM(ABS(sl.Existencia)), @Sucursal,ISNULL(s.Propiedades, '')
										FROM SerieLoteMov s
										JOIN ListaID l ON l.ID = s.ID AND l.Estacion = @Estacion 
										JOIN Serielote sl ON s.articulo = sl.Articulo AND s.SerieLote = sl.SerieLote AND s.Empresa = sl.Empresa AND s.Sucursal = sl.Sucursal 
										WHERE s.Empresa = @Empresa AND s.Modulo = 'VTAS' 
										AND s.Articulo = @Articulo AND s.Sucursal = @Sucursal AND sl.Existencia < 0
										GROUP BY s.SerieLote, s.ArtCostoInv, s.Propiedades

								IF EXISTS (SELECT s.ID FROM SerieLoteMov s
										   JOIN ListaID l ON l.ID = s.ID AND l.Estacion = @Estacion 
										   JOIN Serielote sl ON s.articulo = sl.Articulo AND s.SerieLote = sl.SerieLote 
										   AND s.Empresa = sl.Empresa AND s.Sucursal = sl.Sucursal 
										   WHERE s.Empresa = @Empresa AND s.Modulo = 'VTAS' AND s.Articulo = @Articulo 
										   AND s.Sucursal = @Sucursal AND sl.Existencia < 0)
									BEGIN
										SELECT @CantidadAjusteLote = NULL
										
										SELECT @CantidadAjusteLote = SUM(ABS(sl.Existencia)) 
										FROM SerieLoteMov s   
										JOIN Serielote sl ON s.articulo = sl.Articulo AND s.SerieLote = sl.SerieLote AND s.Empresa = sl.Empresa AND s.Sucursal = sl.Sucursal 
										WHERE s.Empresa = @Empresa AND s.Modulo = 'INV' AND s.ID = @AjusteID
										AND s.RenglonID = @RenglonID AND ISNULL(s.SubCuenta, '') = ISNULL(@SubCuenta, '') 
										AND s.Articulo = @Articulo
										AND s.Sucursal = @Sucursal
										AND sl.Existencia < 0
										GROUP BY s.SerieLote, s.ArtCostoInv, s.Propiedades

										IF @CantidadAjusteLote IS NOT NULL
											BEGIN 
												IF NULLIF(-@Disponible/@Factor,0.0) <> @CantidadAjusteLote 
													UPDATE InvD SET Cantidad = @CantidadAjusteLote 
													WHERE ID = @AjusteID AND Renglon = @Renglon AND RenglonID = @RenglonID AND Articulo = @Articulo
											END
									END
						END 

      END
      
					FETCH NEXT FROM crRojo INTO @Almacen, @Articulo, @SubCuenta, @Disponible, @Unidad, @LotesFijos, @ArtTipo
				END     
			CLOSE crRojo
			DEALLOCATE crRojo

			DELETE ListaID WHERE Estacion = @Estacion

			IF EXISTS (SELECT * FROM INV WHERE ID = @AjusteID)
				EXEC spAfectar 'INV', @AjusteID, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @ok OUTPUT, @OkRef = @OkRef OUTPUT
	
			IF @Ok IS NOT NULL
				BEGIN
					DELETE FROM Inv WHERE ID = @AjusteID
					DELETE FROM InvD WHERE ID = @AjusteID
				END	

			SELECT @Ok = NULL, @OkRef = NULL
		END

	RETURN  
END 
GO


/************************ spPOSSeriesLotesSurtidoAuto *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSSeriesLotesSurtidoAuto') AND type = 'P') DROP PROCEDURE dbo.spPOSSeriesLotesSurtidoAuto
GO             
CREATE PROCEDURE spPOSSeriesLotesSurtidoAuto
	@Sucursal					int,
	@Empresa					varchar(5),
	@Modulo						varchar(5),
	@EsSalida					bit,
	@EsTransferencia			bit,
	@ID  						int,
	@RenglonID					int,
	@Almacen					varchar(10),
	@Articulo					varchar(20),
	@SubCuenta					varchar(50),
	@CantidadMovimiento			float,
	@Factor						float,
	@CfgSeriesLotesAutoOrden	varchar(20),
	@Ok 						int				OUTPUT,
	@OkRef 						varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@SubCuentaNull		varchar(50),
	@SerieLote			varchar(50),
	@CantidadTomada		float,
	@Requiere	        float,
	@Existencia 		float,
	@Mov				varchar(20),
	@MovTipo			varchar(20)

	
	IF @Modulo = 'VTAS' SELECT @Mov = Mov FROM Venta WHERE ID = @ID
		SELECT @MovTipo = dbo.fnMovTipo(@Modulo, @Mov)
	  
	SELECT @SubCuenta       = ISNULL(RTRIM(@SubCuenta), ''),
		   @SubCuentaNull   = NULLIF(RTRIM(@SubCuenta), ''),
		   @Existencia      = 0.0
		   
	IF @EsSalida = 1 OR @EsTransferencia = 1 AND @CfgSeriesLotesAutoOrden <> 'NO'
		IF NOT EXISTS (SELECT * FROM SerieLoteMov WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID = @ID 
						AND RenglonID = @RenglonID AND Articulo  = @Articulo AND SubCuenta = @SubCuenta)
			BEGIN
				IF @CfgSeriesLotesAutoOrden = 'FECHA 1'
					DECLARE crSerieLoteMovAuto CURSOR FOR 
					SELECT s.SerieLote, ISNULL(s.Existencia, 0.0) 
					FROM SerieLote s LEFT OUTER JOIN SerieLoteProp p ON p.Propiedades = s.Propiedades 
					WHERE s.Empresa = @Empresa AND s.Articulo = @Articulo AND s.SubCuenta = @SubCuenta 
					AND s.Almacen = @Almacen AND s.Existencia > 0 ORDER BY p.Fecha1, s.SerieLote
				ELSE IF @CfgSeriesLotesAutoOrden = 'DESCENDENTE'
					DECLARE crSerieLoteMovAuto CURSOR FOR 
					SELECT SerieLote, ISNULL(Existencia, 0.0) 
					FROM SerieLote 
					WHERE Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta 
					AND Almacen = @Almacen AND Existencia > 0 ORDER BY SerieLote DESC
				ELSE
					DECLARE crSerieLoteMovAuto CURSOR FOR 
					SELECT SerieLote, ISNULL(Existencia, 0.0) 
					FROM SerieLote 
					WHERE Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta 
					AND Almacen = @Almacen AND Existencia > 0 ORDER BY SerieLote

				SELECT @Requiere = @CantidadMovimiento * @Factor
				
				OPEN crSerieLoteMovAuto
				FETCH NEXT FROM crSerieLoteMovAuto INTO @SerieLote, @Existencia
				IF @@ERROR <> 0 
					SELECT @Ok = 1
				WHILE @@FETCH_STATUS <> -1 AND @Requiere > 0 AND @Ok IS NULL
					BEGIN
						IF @@FETCH_STATUS <> -2 AND @Existencia > 0
							BEGIN
								IF @Existencia > @Requiere 
									SELECT @CantidadTomada = @Requiere 
								ELSE 
									SELECT @CantidadTomada = @Existencia
			
								INSERT SerieLoteMov (
									Sucursal, Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad)
								VALUES (
									@Sucursal, @Empresa, @Modulo, @ID, @RenglonID, @Articulo, @SubCuenta, @SerieLote, @CantidadTomada)
							
								SELECT @Requiere = @Requiere - @CantidadTomada
							END
		
						FETCH NEXT FROM crSerieLoteMovAuto INTO @SerieLote, @Existencia
						
						IF @@ERROR <> 0 
							SELECT @Ok = 1
					END
				CLOSE crSerieLoteMovAuto
				DEALLOCATE crSerieLoteMovAuto
			END
	
	RETURN
END
GO


/************************ spPOSSeriesLotesAutoOrden *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSSeriesLotesAutoOrden') AND type = 'P') DROP PROCEDURE dbo.spPOSSeriesLotesAutoOrden
GO             
CREATE PROCEDURE spPOSSeriesLotesAutoOrden 
	@ID							varchar(36),
	@Sucursal					int,
	@Empresa					varchar(5),
	@IDNuevo					int,
	@CfgSeriesLotesAutoOrden	varchar(20)
--//WITH ENCRYPTION
AS
BEGIN
	DECLARE 
	@Articulo		varchar(20), 
	@SubCuenta		varchar(50), 
	@Cantidad		float,
	@RenglonID		int,
	@Almacen		varchar(10),
	@Ok				int, 
	@OkRef			varchar(255)
     
	SELECT @Ok = NULL, @OkRef = NULL
	SELECT @Almacen = RTRIM(Almacen) 
	FROM POSL WITH (NOLOCK) 
	WHERE ID = @ID 
     
	DECLARE crST1 CURSOR LOCAL FOR       
    SELECT Articulo, NULLIF(SubCuenta,''), RenglonID, COUNT (1)  
    FROM POSLSerieLote 
    WHERE ID = @ID 
    GROUP BY Articulo, NULLIF(SubCuenta,''), RenglonID 
    
	OPEN crST1    
    FETCH NEXT FROM crST1 INTO @Articulo, @SubCuenta, @RenglonID, @Cantidad    
    WHILE @@FETCH_STATUS <> -1  AND @Ok IS NULL   
		BEGIN    
			IF @@FETCH_STATUS <> -2     
				BEGIN    
					EXEC spPOSSeriesLotesSurtidoAuto @Sucursal, @Empresa, 'VTAS', 1, 0, @IDNuevo, @RenglonID, @Almacen, @Articulo, 
						@SubCuenta, @Cantidad, 1, @CfgSeriesLotesAutoOrden, @Ok OUTPUT, @OkRef OUTPUT
				END    
      
			FETCH NEXT FROM crST1 INTO @Articulo, @SubCuenta, @RenglonID, @Cantidad    
       END    
	CLOSE crST1    
    DEALLOCATE crST1 
     
    IF @Ok IS NOT NULL 
		BEGIN
			DELETE FROM SerieLoteMov WHERE ID = @IDNuevo 
		
			INSERT SerieLoteMov (
				Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal)    
            SELECT 
				@Empresa, 'VTAS', @IDNuevo, pls.RenglonID, pls.Articulo, ISNULL(pls.SubCuenta,''), pls.SerieLote, COUNT(*), @Sucursal      
            FROM POSLSerieLote pls    
            WHERE pls.ID = @ID    
            GROUP BY Articulo, ISNULL(SubCuenta,''), SerieLote, RenglonID  		
		END
END  
GO


/************************ spGeneraCobroSugeridoPOS *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spGeneraCobroSugeridoPOS') AND type = 'P') DROP PROCEDURE dbo.spGeneraCobroSugeridoPOS
GO
CREATE PROCEDURE spGeneraCobroSugeridoPOS
	@Modulo			char(5),
	@ID				int,
	@Usuario		varchar(10),
	@Estacion		int,
	@Ok				int OUTPUT,
	@OkRef			varchar(255)OUTPUT	 
--//WITH ENCRYPTION
AS 
BEGIN  
	DECLARE
	@Empresa					char(5),
	@Sucursal					int,
	@Hoy						datetime,
	@Moneda						char(10),
	@TipoCambio					float,
	@Renglon					float,
	@Aplica						varchar(20),
	@AplicaID					varchar(20),
	@AplicaMovTipo				varchar(20),
	@Importe					money,
	@SumaImporte				money,
	@Impuestos					money,
	@DesglosarImpuestos			bit,
	@IDDetalle					int,
	@IDCxc						int,
	@ImporteReal				money,
	@ImporteAPagar				money,
	@ImporteMoratorio			money,
	@ImporteACondonar			money,
	@MovGenerar					varchar(20),
	@UEN						int,
	@ImporteTotal				money,
	@Mov						varchar(20),
	@MovID						varchar(20),
	@MovPadre					varchar(20),
	@Cliente					varchar(10),
	@CteMoneda					varchar(10),
	@CteTipoCambio				float,
	@FechaAplicacion			datetime,
	@ClienteEnviarA				int,
	@TotalMov					money,
	@CampoExtra					varchar(50),
	@Consecutivo				varchar(20),
	@ValorCampoExtra			varchar(255),
	@Concepto					varchar(50),
	@MoratorioAPagar			money,
	@MovIDGen					varchar(20),
	@MovCobro					varchar(20),
	@GeneraNC					char(1),
	@Origen						varchar(20),
	@OrigenID					varchar(20),
	@Impuesto					money,
	@DefImpuesto				float,
	@ImporteDoc					money,
	@Bonificacion				money,
	@MovIDGenerado				varchar(20),
	@TotalAPagar				money,
	@IDCargoMor					int,
	@InteresPorPolitica			money,
	@MovIDCgo					varchar(20),
	@IDPadre					int,
	@SaldoIniDia				money,
	@PorcAbonoCapital			float,
	@PorcMoratorioBonificar		float,
	@TotalMoratorio				money,
	@MoratorioBonificado		money,
	@MoratorioXPagar			money,
	@TotalCobrosDia				money,
	@PorcIntaBonificar			float,
	@PorcPAgoCapital			float,
	@Nota						varchar(100),
	@CobroxPolitica				int,
	@MoratoriosaBonificar		money,
	@VencimientoMasAntiguo		datetime,
	@IDCargoMorEst				int,
	@IdCargoMoratorio			int,
	@IdCargoMoratorioEst		int,
	@SaldoNCPend				money,
	@SaldoEstPend				money,
	@EstatusNCEst				varchar(15),
	@EstatusNC					varchar(15),
	@IDUltCobro					int,
	@TotalMoratUltCob			money,
	@EstatusCargoMor			varchar(15),
	@EstatusCargoMorEst			varchar(15),
	@TotalBonificacion			money


	SET @CobroxPolitica = 0

	SELECT @CteMoneda = ClienteMoneda, @CteTipoCambio = ClienteTipoCambio, @Cliente = Cliente, @FechaAplicacion = dbo.fnFechaSinHora(FechaEmision) 
	FROM CXC 
	WHERE ID = @ID

	SELECT @CobroxPolitica = ISNULL(TipoCobro,0) 
	FROM TipoCobroMAVI 
	WHERE IdCobro = @ID

	SELECT @DesglosarImpuestos = 0 , @Renglon = 0.0, @SumaImporte = 0.0, @ImporteTotal = NULLIF(@ImporteTotal, 0.0)
	SELECT @Renglon = 1024.0
	SELECT @GeneraNC = '1'

	IF not exists(SELECT * FROM NegociaMoratoriosMAVI WHERE IDCobro = @ID)
		BEGIN
			SELECT 'No hay sugerencia a cobrar..'
			RETURN
		END

	IF @Modulo = 'CXC'
		BEGIN  
			UPDATE CXC SET AplicaManual = 1 WHERE id = @ID
			SELECT @Empresa = Empresa, @Sucursal = Sucursal, @Hoy = FechaEmision, @Moneda = Moneda, @TipoCambio = TipoCambio, 
			@ClienteEnviarA = ClienteEnviarA, @MovCobro = Mov  
			FROM Cxc 
			WHERE ID = @ID

			DELETE CxcD WHERE ID = @ID
			DELETE DetalleAfectacionMAVI WHERE IDCobro = @ID

			EXEC spGeneraNCredPPMAVI @ID, @Usuario, @Ok OUTPUT, @OkRef OUTPUT

			IF @Ok IS NULL
				EXEC spGeneraNCredNAMAVI @ID, @Usuario, @Ok OUTPUT, @OkRef OUTPUT
			
			IF @Ok IS NULL
				EXEC spGeneraNCredAPMAVI @ID, @Usuario, @Ok OUTPUT, @OkRef OUTPUT

			IF @Ok IS NULL
				EXEC spGeneraNCredBonifMAVI @ID, @Usuario, @Ok OUTPUT, @OkRef OUTPUT

			IF @Ok IS NULL
				BEGIN  
					DECLARE crDetalle CURSOR FAST_FORWARD FOR					
					SELECT SUM(ISNULL(MoratorioAPagar,0) - ISNULL(ImporteACondonar,0)), Origen, OrigenID
					FROM NegociaMoratoriosMAVI
					WHERE IDCobro = @ID  
					AND Estacion = @Estacion AND MoratorioAPagar > 0
					GROUP BY Origen, OrigenID

					OPEN crDetalle
					FETCH NEXT FROM crDetalle INTO  @ImporteMoratorio, @Origen, @OrigenID
					WHILE @@FETCH_STATUS <> -1
						BEGIN  
							IF @@FETCH_STATUS <> -2 AND @OK IS NULL
								BEGIN    
									SELECT @UEN = UEN, @ClienteEnviarA = ClienteEnviarA FROM CXC WHERE Mov = @Origen AND MovId = @OrigenID
								
									IF @ImporteMoratorio > 0
										BEGIN  
											SELECT @MovGenerar = dbo.fnMaviObtieneMovSaldoMoratorios(@Origen,'Moratorios', @UEN)

											IF @MovGenerar Is NULL
												SELECT @MovGenerar = 'Nota Cargo'

											IF @MovGenerar = 'Endoso' 
												SELECT @MovGenerar = 'Nota Cargo'
										
											SELECT @DefImpuesto = 1 + ISNULL(DefImpuesto,15.0)/100 
											FROM EmpresaGral 
											WHERE Empresa = @Empresa

											SELECT @Importe = @ImporteMoratorio/@DefImpuesto   
											SELECT @Impuesto = @ImporteMoratorio - @Importe

											IF @MovGenerar in ( 'Nota Cargo', 'Nota Cargo VIU')  
												SELECT @Concepto = 'MORATORIOS MENUDEO'
	
											IF @MovGenerar = 'Nota Cargo Mayoreo'  
												SELECT @Concepto = 'MORATORIOS MAYOREO'

											IF @GeneraNC = '1'
												BEGIN  
													INSERT INTO Cxc(
														Empresa, Mov, MovID, FechaEmision, Concepto, UltimoCambio, Moneda, TipoCambio, 
														Usuario, Referencia, Estatus, Cliente, ClienteEnviarA, ClienteMoneda, ClienteTipoCambio, Vencimiento, 
														Importe, Impuestos, AplicaManual, ConDesglose, Saldo, ConTramites, VIN, Sucursal, SucursalOrigen, UEN, 
														PersonalCobrador, FechaOriginal, Nota, Comentarios, LineaCredito, TipoAmortizacion, TipoTasa, Amortizaciones, 
														Comisiones, ComisionesIVA, FechaRevision, ContUso, TieneTasaEsp, TasaEsp, Codigo)
													VALUES(
														@Empresa, @MovGenerar, NULL, dbo.fnFechaSinHora(@FechaAplicacion), @Concepto, @FechaAplicacion, @Moneda, @TipoCambio,
														@Usuario, null, 'SINAFECTAR',  @Cliente, @ClienteEnviarA, @Moneda, @TipoCambio, @FechaAplicacion, 
														@Importe, @Impuesto, 0, 0, ISNULL(@Importe,0) + ISNULL(@Impuesto,0), 0, NULL, @Sucursal, @Sucursal, @UEN, 
														NULL, NULL, NULL, '', NULL, NULL, NULL, NULL, NULL, 
														NULL, NULL, NULL, 0, NULL, NULL)

													SELECT @IDCxc = SCOPE_IDENTITY()
													EXEC spAfectar 'CXC', @IDCxc, 'AFECTAR', 'Todo', NULL, @Usuario,  NULL, 1, @Ok OUTPUT, @OkRef OUTPUT,NULL, @Conexion =  1 

													INSERT INTO DetalleAfectacionMAVI(
														IDCobro, ID, Mov, MovID, ValorOK, ValorOKRef) 
													VALUES(
														@ID, @IDCxc, @MovGenerar, @MovIDGen, @Ok, @OkRef)
					
													UPDATE NegociaMoratoriosMAVI
													SET NotaCargoMorId = @IDCxc
													WHERE IDCobro = @ID AND Estacion = @Estacion AND MoratorioAPagar > 0 
													AND Origen = @Origen AND OrigenID = @OrigenId

													SELECT @MovIDGen = MovId 
													FROM CXC 
													WHERE ID = @IDCxc

													INSERT CxcD (
														ID, Sucursal, Renglon, Aplica, AplicaID, Importe, InteresesOrdinarios, InteresesMoratorios, ImpuestoAdicional)
													VALUES (
														@ID, @Sucursal, @Renglon, @MovGenerar, @MovIDGen, NULLIF(@ImporteMoratorio, 0.0), 0.0, 0.0, 0.0)

													SELECT @Renglon = @Renglon + 1024.0

													IF @Ok = 80030
														SELECT @Ok = NULL

													IF @Ok IS NULL 
														BEGIN  
															IF NOT EXISTS(SELECT * FROM MovCampoExtra WHERE Modulo = @Modulo AND Mov = @MovGenerar AND ID = @IDCxc)
																BEGIN  
																	SELECT @AplicaId  = MovId 
																	FROM CXC 
																	WHERE ID = @IDCxc

																	IF @MovGenerar = 'Nota Cargo'  
																		SELECT @CampoExtra = 'NC_FACTURA'                         
																
																	IF @MovGenerar = 'Nota Cargo VIU'  
																		SELECT @CampoExtra = 'NCV_FACTURA'

																	IF @MovGenerar = 'Nota Cargo Mayoreo'  
																		SELECT @CampoExtra = 'NCM_FACTURA'

																	SELECT @ValorCampoExtra =  RTRIM(@Origen)+'_'+RTRIM(@OrigenId)

																	IF  @MovGenerar in ('Nota Cargo', 'Nota Cargo VIU', 'Nota Cargo Mayoreo')
																		INSERT INTO MovCampoExtra (
																			Modulo, Mov, ID, CampoExtra, Valor) 
																		VALUES(
																			'CXC', @MovGenerar, @IDCxc, @CampoExtra, @ValorCampoExtra)
																END   
														END  
												END  
										END 
								END 

							FETCH NEXT FROM crDetalle INTO  @ImporteMoratorio, @Origen, @OrigenID
						END 
					CLOSE crDetalle
					DEALLOCATE crDetalle

					DECLARE crDoc CURSOR FAST_FORWARD FOR
					SELECT Mov, MovID, ImporteReal, ImporteAPagar, ImporteMoratorio, ImporteACondonar, Bonificacion, TotalAPagar
					FROM NegociaMoratoriosMAVI
					WHERE IDCobro = @ID AND Estacion = @Estacion AND ImporteAPagar > 0

					OPEN crDoc
					FETCH NEXT FROM crDoc INTO @Mov, @MovID, @ImporteReal, @ImporteAPagar, @ImporteMoratorio, @ImporteACondonar, @Bonificacion, @TotalAPagar
					WHILE @@FETCH_STATUS <> -1
						BEGIN  
							IF @@FETCH_STATUS <> -2 AND @OK IS NULL
								BEGIN    
									SELECT  @ImporteDoc =  ISNULL(@ImporteAPagar,0) - ISNULL(@Bonificacion,0)
									
									IF @ImporteDoc > 0 
										BEGIN  
											INSERT CxcD (
												ID, Sucursal, Renglon, Aplica, AplicaID, Importe, InteresesOrdinarios, InteresesMoratorios, ImpuestoAdicional)
											VALUES (
												@ID, @Sucursal, @Renglon, @Mov, @MovID, NULLIF(@ImporteDoc, 0.0), 0.0, 0.0, 0.0)

											SELECT @Renglon = @Renglon + 1024.0
										END  
								END  

							FETCH NEXT FROM crDoc INTO @Mov, @MovID, @ImporteReal, @ImporteAPagar, @ImporteMoratorio, @ImporteACondonar, @Bonificacion, @TotalAPagar
						END  
					CLOSE crDoc
					DEALLOCATE crDoc

					IF @CobroxPolitica = 1
						BEGIN
							UPDATE CXC SET Concepto = 'POLITICA QUITA MORATORIOS' 
							WHERE ID = @ID
							
							SELECT @InteresPorPolitica = MIN(InteresPorPolitica)
							FROM NegociaMoratoriosMAVI
							WHERE IDCobro = @ID AND InteresPorPolitica > 0

							SELECT @Origen = Origen, @OrigenID = OrigenID
							FROM NegociaMoratoriosMAVI
							WHERE IDCobro = @ID
							GROUP BY Origen, OrigenID   

							SELECT @IDPadre = ID, @UEN = UEN, @ClienteEnviarA = ClienteEnviarA
							FROM CXC 
							WHERE  Mov = @Origen AND MovID = @OrigenID
							
							SELECT @ImporteTotal = SUM(ISNULL(ImporteAPagar,0)) 
							FROM NegociaMoratoriosMAVI
							WHERE IDCobro = @ID

							IF NOT EXISTS(SELECT * FROM  CobroXPoliticaHistMAVI WHERE Mov = @Origen AND MovID = @OrigenID 
										  AND CONVERT(varchar(8),FechaEmision,112) =  CONVERT(varchar(8),@FechaAplicacion,112) AND EstatusCobro = 'CONCLUIDO')
								BEGIN
									SET @TotalBonificacion = 0
									SELECT @TotalBonificacion = SUM(ISNULL(Bonificacion,0)) 
									FROM NegociaMoratoriosMAVI 
									WHERE IDCobro = @ID

									SELECT @SaldoIniDia = dbo.fnSaldoPMMAVI(@IDPadre) + ISNULL(@TotalBonificacion,0)
									SELECT @TotalCobrosDia = @ImporteTotal
								END
							ELSE
								BEGIN
									SELECT TOP 1 @SaldoIniDia = SaldoInicioDelDia
									FROM CobroXPoliticaHistMAVI
									WHERE Mov = @Origen AND MovID = @OrigenID 
									AND CONVERT(varchar(8),FechaEmision,112) = CONVERT(varchar(8),@FechaAplicacion,112) AND EstatusCobro = 'CONCLUIDO'
									ORDER BY IDCobro ASC

									SELECT @TotalCobrosDia = SUM(ImporteCobro) + ISNULL(@ImporteTotal,0) 
									FROM CobroXPoliticaHistMAVI 
									WHERE Mov = @Origen AND MovID = @OrigenID 
									AND CONVERT(varchar(8),FechaEmision,112) =  CONVERT(varchar(8),@FechaAplicacion,112) 
									AND EstatusCobro = 'CONCLUIDO' 
									
									SELECT @IdCargoMoratorioEst = 0
									
									SELECT TOP 1 @IDUltCobro = idCobro, @PorcMoratorioBonificar = PorcMoratorioBonificar, 
										@IdCargoMoratorioEst = IdCargoMoratorioEst, @TotalMoratUltCob = TotalMoratorio
									FROM CobroXPoliticaHistMAVI
									WHERE Mov = @Origen AND MovID = @OrigenID 
									AND CONVERT(varchar(8),FechaEmision,112) = CONVERT(varchar(8),@FechaAplicacion,112) AND EstatusCobro = 'CONCLUIDO'
									ORDER BY IDCobro DESC

									SELECT @InteresPorPolitica = @TotalMoratUltCob
									
									IF @PorcMoratorioBonificar <= 100
										BEGIN
											SELECT @SaldoEstPend = ISNULL(Importe,0) + ISNULL(Impuestos,0), @EstatusNCEst = Estatus  
											FROM CXC 
											WHERE ID = @IdCargoMoratorioEst

											IF @IdCargoMoratorioEst > 0
												BEGIN
													EXEC spAfectar 'CXC', @IdCargoMoratorioEst, 'CANCELAR', 'Todo', NULL, @Usuario,  NULL, 1, 
														@Ok OUTPUT, @OkRef OUTPUT,NULL, @Conexion =  1 

													UPDATE CobroxPoliticaHistMAVI
													SET EstatusCargoMorEst = 'CANCELADO'
													WHERE IdCargoMoratorioEst = @IdCargoMoratorioEst
												END
										END
								END

							IF @SaldoIniDia > 0
								SELECT @PorcAbonoCapital = (@TotalCobrosDia / @SaldoIniDia)*100.0

							SELECT @PorcIntaBonificar = 0
							SELECT TOP 1 @PorcIntaBonificar = ISNULL(Valor,0) 
							FROM TablaNumD 
							WHERE TablaNum = 'CFG QUITA MORATORIOS' AND @PorcAbonoCapital >= Numero  
							ORDER BY Valor DESC

							SELECT @Nota = NULL

							IF @PorcIntaBonificar > 0.0
								BEGIN
									SELECT @PorcMoratorioBonificar = ISNULL(@InteresPorPolitica,0) - (ISNULL(@InteresPorPolitica,0) * (ISNULL(@PorcIntaBonificar,0)/100.0))
									SELECT @MoratorioXPagar = @PorcMoratorioBonificar
									SELECT @MoratoriosaBonificar =  ISNULL(@InteresPorPolitica,0) - ISNULL(@PorcMoratorioBonificar,0)
									SELECT @Nota = 'IM Bonificado:' + CONVERT(Varchar(20), @MoratoriosaBonificar)
								END
							ELSE
								BEGIN
									UPDATE NegociaMoratoriosMAVI SET InteresAPAgarConPolitica = 0 WHERE IDCobro = @ID
									
									SELECT @Nota = 'IM Bonificado: 0'
									SELECT @MoratoriosaBonificar = 0
									SELECT @MoratorioXPagar =  ISNULL(@InteresPorPolitica,0) - ISNULL(@PorcMoratorioBonificar,0)
								END

							SELECT @EstatusCargoMorEst = NULL

							IF @InteresPorPolitica > 0 AND @PorcIntaBonificar > 0 AND @PorcIntaBonificar <= 100  
								BEGIN
									SELECT @EstatusCargoMorEst = 'CONCLUIDO'
									INSERT INTO Cxc(
										Empresa, Mov, MovID, FechaEmision, Concepto, UltimoCambio, Moneda, TipoCambio, 
										Usuario, Referencia, Estatus, Cliente, ClienteEnviarA, ClienteMoneda, ClienteTipoCambio, 
										Condicion, Vencimiento, Importe, Impuestos, AplicaManual, ConDesglose, Saldo, 
										ConTramites, VIN, Sucursal, SucursalOrigen, UEN, PersonalCobrador, FechaOriginal, Nota, Comentarios, 
										LineaCredito, TipoAmortizacion, TipoTasa, Amortizaciones, Comisiones, ComisionesIVA, 
										FechaRevision, ContUso, TieneTasaEsp, TasaEsp, Codigo, PadreMAVI, PadreIDMAVI, IDPadreMAVI)
									VALUES(
										@Empresa, 'Cargo Moratorio Est', NULL, @FechaAplicacion, @Concepto, @FechaAplicacion, @Moneda, @TipoCambio, 
										@Usuario, null, 'SINAFECTAR',  @Cliente, @ClienteEnviarA, @Moneda, @TipoCambio, 
										'(Fecha)', @FechaAplicacion, @MoratoriosaBonificar, @Impuesto, 0, 0, ISNULL(@MoratoriosaBonificar,0) + ISNULL(@Impuesto,0),
										0, NULL, @Sucursal, @Sucursal, @UEN, NULL, NULL, @Nota, '', 
										NULL, NULL, NULL, NULL, NULL, NULL,
										NULL, NULL, 0, NULL, NULL, 'Cargo Moratorio Est', NULL, @IDPadre)

									SELECT @IDCargoMorEst = @@IDENTITY
									EXEC spAfectar 'CXC', @IDCargoMorEst, 'AFECTAR', 'Todo', NULL, @Usuario,  NULL, 1, @Ok OUTPUT, @OkRef OUTPUT,NULL, @Conexion =  1 

									SELECT @MovIDCgo = MovId 
									FROM CXC 
									WHERE ID = @IDCargoMorEst

									UPDATE Cxc SET PadreIDMAVI = @MovIDCgo WHERE ID = @IDCargoMorEst

									INSERT INTO DetalleAfectacionMAVI(
										IDCobro, ID, Mov, MovID, ValorOK, ValorOKRef) 
									VALUES(
										@ID, @IDCargoMorEst, 'Cargo Moratorio Est', @MovIDGen, @Ok, @OkRef)

									IF NOT EXISTS(SELECT * FROM MovCampoExtra WHERE Modulo = @Modulo AND Mov = 'Cargo Moratorio Est' AND ID = @IDCargoMorEst)
										BEGIN  
											SELECT @CampoExtra = 'CM_FACTURA'
											SELECT @ValorCampoExtra =  RTRIM(@Origen)+'_'+RTRIM(@OrigenId)

											INSERT INTO MovCampoExtra (
												Modulo, Mov, ID, CampoExtra, Valor) 
											VALUES(
												'CXC', 'Cargo Moratorio Est', @IDCargoMorEst, @CampoExtra, @ValorCampoExtra)
										END   

									SELECT @VencimientoMasAntiguo = MIN(Vencimiento) 
									FROM Cxc 
									WHERE PadreMAVI = @Origen AND PadreIDMAVI = @OrigenID
									AND Estatus = 'PENDIENTE'

									IF @VencimientoMasAntiguo IS NULL
										SELECT @VencimientoMasAntiguo = @FechaAplicacion
								END

							INSERT INTO CobroXPoliticaHistMAVI (
								IdCobro, FechaEmision, EstatusCobro, ImporteCobro, Cliente, Mov, MovID,
								SaldoIniciodelDia, TotalCobrosdelDia, PorcAbonoCapital, PorcMoratorioBonificar, TotalMoratorio, 
								MoratorioBonificado, MoratorioXPagar, IdCargoMoratorioEst, EstatusCargoMorEst)
							VALUES(
								@ID, @FechaAplicacion, 'SINAFECTAR', @ImporteTotal, @Cliente, @Origen, @OrigenID,
								@SaldoIniDia, @TotalCobrosDia, @PorcAbonoCapital, @PorcIntaBonificar, @InteresPorPolitica, 
								ISNULL(@MoratoriosaBonificar,0), ISNULL(@MoratorioXPagar,0), ISNULL(@IDCargoMorEst,0), @EstatusCargoMorEst)
						END

					SELECT @Impuestos = SUM(d.importe*isnull(ca.IVAFiscal,0)) 
					FROM CXCD d
					JOIN CxcAplica ca ON d.Aplica = ca.Mov AND d.AplicaID = ca.MovID AND ca.Empresa = @Empresa
					WHERE d.ID = @ID
					
					SELECT @TotalMov = SUM(d.Importe-isnull(d.Importe*ca.IVAFiscal,0))
					FROM CXCD d
					JOIN CxcAplica ca ON d.Aplica = ca.Mov AND d.AplicaID = ca.MovID AND ca.Empresa = @Empresa
					WHERE d.ID = @ID

					UPDATE CXC SET Importe = isnull(ROUND(@TotalMov,2),0.00),
					Impuestos = isnull(ROUND(@Impuestos,2),0.00),
					Saldo = isnull(ROUND(@TotalMov,2),0.00) + isnull(ROUND(@impuestos,2),0.00)
					WHERE ID = @ID

					EXEC spAfectar 'CXC', @ID, 'AFECTAR', 'Todo', NULL, @Usuario,  NULL, 1, @Ok OUTPUT, @OkRef OUTPUT,NULL, @Conexion = 1  

					SELECT @MovIDGenerado = MovID FROM CXC WHERE ID = @ID
					
					UPDATE CXC SET Referencia = RTRIM(@MovCobro)+'_'+RTRIM(@MovIDGenerado)
					WHERE IDCobroBonifMAVI = @ID

					IF @IDCargoMorEst > 0
						UPDATE CXC SET Referencia = RTRIM(@MovCobro)+'_'+RTRIM(@MovIDGenerado)
						WHERE ID = @IDCargoMorEst
				END 

			IF @Ok IS NOT NULL AND @Ok NOT IN (80030)
				BEGIN 
					SELECT  @OkRef = Descripcion FROM MensajeLista WHERE Mensaje = @Ok
				END

			RETURN
		END
END
GO

/**************** spPOSCFDFlex ****************/
if exists (select * from sysobjects where id = object_id('dbo.spPOSCFDFlex') and type = 'P') drop procedure dbo.spPOSCFDFlex
GO             
CREATE PROCEDURE spPOSCFDFlex
		@Estacion				int,
		@Empresa				varchar(5),
		@Modulo					varchar(5),
		@ID						int,
		@IDPOS					varchar(36),
		@Estatus				varchar(15),
		@Ok						int				OUTPUT,
		@OkRef					varchar(255)	OUTPUT,
		@LlamadaExterna			bit = 0,
		@Mov					varchar(20)		= NULL,
		@MovID					varchar(20)		= NULL,
		@Contacto				varchar(10)		= NULL,
		@CrearArchivo			bit = 0,
		@Debug					bit = 0,
		@XMLFinal				varchar(max)	= NULL OUTPUT,
		@Encripcion				varchar(20)		= NULL,
		@EstatusAnterior		varchar(15)		= NULL
			
WITH ENCRYPTION
AS BEGIN

  DECLARE
	@XMLSAT						varchar(max),
	@XMLADENDA					varchar(max),
	@XML						varchar(max),
	@Temporal					varchar(255),
	@RutaTemporal				varchar(255),
	@Comprobante				varchar(50),
	@Adenda						varchar(50),
	@FechaRegistro				datetime,
	@OkError					int,
	@OkRefError					varchar(255),
	@RutaError					varchar(255),
	@DocumentoXML				varchar(max),
	@iDatos						int,
	@CFDFecha					datetime,
	@CFDSerie					varchar(10),
	@CFDFolio					int,
	@CFDRFC						varchar(15),
	@CFDAprobacion				varchar(15),
	@CFDImporte					money,
	@CFDImpuesto1				money,
	@CFDImpuesto2				money,
	@CFDRetencion1				money,
	@CFDRetencion2				money,	
	@CFDnoCertificado			varchar(20),
	@CFDSello					varchar(max),
	@CFDCadenaOriginal			varchar(max),
	@MovTipoCFDFlexEstatus		varchar(15),
	@Archivo					varchar(255),
	@Usuario					varchar(10),
	@EnviarAlAfectar			bit,
	@AlmacenarTipo				varchar(20),
	@TipoCambio					float,
	@CFDI						bit,
	@TipoCFDI					bit,
	@TimbrarEnTransaccion		bit,
	@RutaTimbrarCFDI			varchar(255),
	@Timbrado					bit,
	@PrefijoCFDI				varchar(255),
	@RutaCFDI					varchar(255),
	@CFDUUID					uniqueidentifier,
	@CFDFechaTimbrado			datetime,
	@TFDVersion					varchar(10),
	@SelloSAT					varchar(max),
	@noCertificadoSAT			varchar(20),
	@BloquearMovOtraFecha		bit,
	@FechaEmision				datetime,
	@FechaServidor				datetime,
	@Sucursal					int,
	@MovTipo					varchar(20),
	@OrigenModulo				varchar(5),
	@OrigenMovimiento			varchar(20),
	@MovOrigen					varchar(20),
	@CFDEsParcialidad			bit,
	@OrigenUUID					uniqueidentifier,
	@OrigenMovID				varchar(20),
	@OrigenSerie				varchar(10),
	@OrigenFolio				varchar(4),
	@Caracter					char(1),
	@ParcialidadNumero			int,
	@SerieFolioFiscalOrig		varchar(50),
	@NoValidarOrigenDocumento	bit,
	@FolioFiscalOrig			varchar(50),
	--REQ Q3069 CFDGT
	@Sellar						bit,
	--REQ 15739  
	@CFDFlexEstatus				varchar(15),
	@Continuar					bit,
	@Adenda2					varchar(50),
	@XMLADENDA2					varchar(max),
	@RutaFirmaSAT				varchar(255),
	@ExisteFirmaSAT				int,
	@Existe						int,
	@MovIDTemp					varchar(50)					
	


  SELECT @Comprobante = NULL, @Adenda = NULL, @Timbrado = 0, @FechaServidor = dbo.fnFechaSinHora(GETDATE())
  
  --SET @LlamadaExterna = 1
  --EXEC xpCFDFlexAntes @Estacion, @Empresa, @Modulo, @ID, @Estatus, @Ok OUTPUT, @OkRef OUTPUT, @LlamadaExterna, @Mov, @MovID, @Contacto, @CrearArchivo, @Debug, @XMLFinal OUTPUT, @Encripcion

  SELECT @FechaEmision = FechaEmision, @FechaRegistro = FechaRegistro, @Usuario = Usuario, @TipoCambio = TipoCambio, @Sucursal = Sucursal FROM Venta    WHERE ID = @ID 
  SELECT @Mov = MovFactura FROM POSCfg WHERE Empresa = @Empresa
  SELECT @Contacto = @Contacto FROM MovTipoCFDFlex WHERE Modulo = @Modulo AND Mov = @Mov
  SELECT @MovIDTemp = NombreArchivo, @XML = DocumentoXML FROM POSL WHERE ID = @IDPOS
  SELECT @MovIDTemp = REPLACE(@MovIDTemp, @Mov,'')
  SELECT @MovID = LTRIM(@MovIDTemp)
  
  IF @Ok IS NULL
  BEGIN
    SELECT @CFDI = ISNULL(CFDI,0)
      FROM EmpresaGral 
     WHERE Empresa = @Empresa

    SELECT @NoValidarOrigenDocumento = ISNULL(NoValidarOrigenDocumento,0)
      FROM EmpresaCFD
     WHERE Empresa = @Empresa  
  
    SELECT @MovTipo = Clave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov

    SELECT @Comprobante = Comprobante,
		   @Adenda = Adenda,
		   @MovTipoCFDFlexEstatus = NULLIF(Estatus,''),
		   @OrigenModulo = NULLIF(OrigenModulo,''),
		   @OrigenMovimiento = NULLIF(OrigenMov,'')
      FROM MovTipoCFDFlex
     WHERE Modulo = @Modulo
       AND Mov = @Mov
       AND Contacto = @Contacto


    IF @Comprobante IS NULL AND @Adenda IS NULL
      SELECT @Comprobante = Comprobante,
			 @Adenda = Adenda,
			 @MovTipoCFDFlexEstatus = NULLIF(Estatus,''),
			 @OrigenModulo = NULLIF(OrigenModulo,''),
			 @OrigenMovimiento = NULLIF(OrigenMov,'')
        FROM MovTipoCFDFlex
       WHERE Modulo = @Modulo
         AND Mov = @Mov
         AND ISNULL(NULLIF(ISNULL(NULLIF(Contacto,''),'(Todos)'),'(Todos)'),@Contacto) = @Contacto


    IF @MovOrigen IS NULL
      SELECT @MovOrigen = dbo.fnCFDFlexOrigenDetalle(@ID)

    IF @OK IS NULL
      EXEC spCFDFlexValidarPlantillaConfiguracion @Comprobante, @Modulo, @CFDI, @Ok OUTPUT, @OkRef OUTPUT

    SELECT @RutaTemporal = RutaTemporal, @EnviarAlAfectar = EnviarAlAfectar, @RutaTimbrarCFDI = RutaTimbrarCFDI FROM EmpresaCFD WHERE Empresa = @Empresa  
    SELECT @Temporal = @RutaTemporal + CASE WHEN SUBSTRING(REVERSE(@RutaTemporal),1,1) <> '\' THEN '\' ELSE '' END + 'Temporal' + CONVERT(varchar,@Estacion) + '.XML'  
    SET @RutaError = REPLACE(@Temporal,'Temporal' + CONVERT(varchar,@Estacion) + '.XML','Error' + CONVERT(varchar,@Estacion) + '.XML')  

    SELECT @TipoCFDI = ISNULL(TipoCFDI,0),
           @TimbrarEnTransaccion = ISNULL(TimbrarEnTransaccion,0),
           @Sellar = ISNULL(Sellar,0)
      FROM eDoc
     WHERE Modulo = @Modulo AND eDoc = @Comprobante
    
    EXEC spEliminarArchivo @RutaError, @Ok OUTPUT, @OkRef OUTPUT    
	      
    IF @Ok IS NULL 
    BEGIN
      SELECT @Archivo = @RutaTemporal + CASE WHEN SUBSTRING(REVERSE(@RutaTemporal),1,1) <> '\' THEN '\' ELSE '' END + @Modulo + '_' + CONVERT(varchar,@ID) + '.XML'    
      EXEC spCFDFlexRegenerarArchivo @Empresa, @Archivo, @XML, @Ok OUTPUT, @OkRef OUTPUT    
    END
      
    IF @Ok IS NULL 
    BEGIN
      SELECT @AlmacenarTipo = NULL
      SELECT @AlmacenarTipo = NULLIF(AlmacenarTipo,'') FROM CteCFD WHERE Cliente = @Contacto 
     
      EXEC spCFDFlexGenerarPDF @Empresa, @Modulo, @Mov, @ID, @Usuario, 0, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT
      
      IF @AlmacenarTipo = 'Adicional'
        EXEC spCFDFlexGenerarPDF @Empresa, @Modulo, @Mov, @ID, @Usuario, 1, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT  
      IF @Ok IS NULL
      BEGIN
        UPDATE CFD SET GenerarPDF = 1 WHERE Modulo = @Modulo AND ModuloID = @ID
        IF @@ERROR <> 0 SET @Ok = 1
      END  	    
    END
  END    
   
  IF EXISTS(SELECT * FROM CFDFlexTemp WHERE ID = @ID AND Modulo = @Modulo)    
    DELETE CFDFlexTemp WHERE ID = @ID AND Modulo = @Modulo    
  IF @Debug = 1 
    SELECT CONVERT(xml,@XML)

  SELECT @XMLFinal = @XML

  IF @Ok IS NULL
   EXEC spVerificarArchivo @Temporal, @Existe OUTPUT, @Ok OUTPUT, @OkRef OUTPUT	

  IF ISNULL(@Existe,0) = 1 AND @Ok IS NULL
   EXEC spEliminarArchivo @Temporal, @Ok OUTPUT, @OkRef OUTPUT  

END
GO

/**************** spPOSRegenerarCFDFlex ****************/
if exists (select * from sysobjects where id = object_id('dbo.spPOSRegenerarCFDFlex') and type = 'P') drop procedure dbo.spPOSRegenerarCFDFlex
GO             
CREATE PROC spPOSRegenerarCFDFlex
			@Estacion		int,
			@Empresa		varchar(5),
			@Modulo			varchar(5),
			@ID				int,
			@IDPOS			varchar(36),
			@Estatus		varchar(15),
			
			@Ok				int				= NULL OUTPUT,
			@OkRef			varchar(255)	= NULL OUTPUT
WITH ENCRYPTION
AS BEGIN  
  DECLARE
    @OkDesc           	varchar(255),
    @OkTipo           	varchar(50)

  EXEC spPOSCFDFlex @Estacion, @Empresa, @Modulo, @ID, @IDPOS, @Estatus, @Ok OUTPUT, @OkRef OUTPUT

  IF @Ok IS NULL 
    SELECT @OkRef = NULL
  ELSE

    SELECT @OkDesc = Descripcion, 
           @OkTipo = Tipo
      FROM MensajeLista
     WHERE Mensaje = @Ok  
  

  SELECT @Ok, @OkDesc, @OkTipo, @OkRef, NULL
 
  RETURN 
END
GO

/************************ spPOSAfectar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAfectar') AND type = 'P') DROP PROCEDURE dbo.spPOSAfectar
GO             
CREATE PROCEDURE spPOSAfectar
	@Empresa		varchar(5),
    @Modulo			varchar(5),
    @Sucursal		int,
    @Usuario		varchar(10),
    @ID				varchar(36),
    @Host 			varchar(20)	    = NULL,
    @Ok				int		OUTPUT,
    @OkRef			varchar(255)    OUTPUT
--//WITH ENCRYPTION    	       
AS 
BEGIN
	DECLARE 
	@IDAnterior						varchar(36),
	@Mov							varchar(20),
	@MovID							varchar(20),
	@FechaEmision					datetime,
	@FechaRegistro					datetime,
	@Concepto						varchar(50),
	@Proyecto						varchar(50),
	@UEN							int,
	@Moneda							varchar(10),
	@TipoCambio						float,
	@UsuarioMov						varchar(10),
	@Referencia						varchar(50),
	@Observaciones					varchar(255),
	@Cliente						varchar(10),
	@Nombre							varchar(100),
	@Direccion						varchar(100),
	@DireccionNumero				varchar(20),
	@DireccionNumeroInt				varchar(20),
	@EntreCalles					varchar(100),
 	@Delegacion						varchar(100),
	@Colonia						varchar(100),
	@Poblacion						varchar(100),
	@Estado							varchar(50),
	@Pais							varchar(50),
	@Zona							varchar(50),
	@CodigoPostal					varchar(15),
	@RFC							varchar(15),
	@CURP							varchar(50),
	@CteEnviarA						int,
	@Almacen						varchar(10),
	@Agente							varchar(10),
	@Cajero							varchar(10),
	@FormaEnvio						varchar(50),
	@Condicion						varchar(50),
	@Vencimiento					datetime,
	@CtaDinero						varchar(10),
	@CtaDineroDestino				varchar(10),
	@Descuento						varchar(50),
	@DescuentoGlobal				float,
	@Causa							varchar(50),
	@Atencion						varchar(50),
	@AtencionTelefono				varchar(50),
	@ListaPreciosEsp				varchar(20),
	@ZonaImpuesto					varchar(50),
	@SucursalMov					int,
	@OrigenTipo						varchar(10),
	@Origen							varchar(20),
	@OrigenID						varchar(20),
	@Importe						float,
	@MovClave						varchar(20),	
	@IDNuevo						varchar(36),
	@Serie							varchar(5),
	@Consecutivo					int,
	@noAprobacion					int,
	@FechaAprobacion				datetime,
	@CadenaOriginal					varchar(max),
	@Sello							varchar(255),
	@FechaCancelacion				dateTime,
	@Certificado					varchar(20),
	@DocumentoXML					varchar(max),
	@FechaSello						dateTime,
	@CFDImporte						float,
	@CFDImpuesto1					float,
	@CFDImpuesto2					float,
	@Estatus						varchar(20),
	@EstatusInsertar				varchar(20),
	@CodigoRedondeo					varchar(50),
	@ArticuloRedondeo				varchar(20),
	@VentaPreciosImpuestoIncluido	bit,
	@MovFactura   					varchar(20),
	@MovFactura2   					varchar(20),
	@IDGenerarPedido				int,
	@GenerarDinero					bit,
	@ArticuloTarjeta				varchar(20),
	@AlmacenTarjeta					varchar(10),
	@Monedero						varchar(20),
	@TipoMonedero					varchar(50),
	@Beneficiario					varchar(100),
	@Impuestos						float,
	@Directo						bit,
	@MovCFD							varchar(20),
	@NomArchivo						varchar(255),
	@XML							varchar(max),
	@UUID							varchar(50),
    @FechaTimbrado					datetime,
    @SelloSat						varchar(255),
    @TFDVersion						varchar(10),
    @NoCertificadoSAT				varchar(20),
    @TFDCadenaOriginal				varchar(max),
    @AfectadoEnLinea				bit,
    @PedidoReferencia				varchar(50), 
    @PedidoReferenciaID				int,
    @MovSubClave					varchar(20),
    @MonederoTipoCambio				float,
    @MonederoMoneda					varchar(10),
    @ContMoneda						varchar(10),
    @ContMonedaTC					float,
    @OkReporte						int,
    @OkRefReporte					varchar(255),
    @FechaNacimiento				datetime,
    @EstadoCivil					varchar(20),
    @Conyuge						varchar(100),	
    @Sexo							varchar(20),	
    @Fuma							bit,
    @Profesion						varchar(100),	
    @Puesto							varchar(100),
    @NumeroHijos					int,
    @Religion						varchar(50),
    @Facturado						bit,
    @CFDGenerado					bit,
    @TipoCosteo						varchar(20),
    @Articulo						varchar(20),   
    @SubCuenta						varchar(50),   
    @Unidad							varchar(50),  
    @Renglon						float,  
    @MovCosto						float,  
    @Costo							money,  
    @MultiUnidades					bit,   
    @VenderSinExistencia			bit,  
    @BloquearCantidadInventario		bit,  
    @NombreDF						varchar(30),  
    @ApellidosDF					varchar(60),  
    @PasaporteDF					varchar(30),  
    @NacionalidadDF					varchar(30),  
    @NoVueloDF						varchar(20),  
    @AerolineaDF					varchar(50),  
    @OrigenDF						varchar(100),  
    @DestinoDF						varchar(100),  
    @Comision2						float,  
    @Estacion						int,
    @AutoAjuste						bit,
    @CfgSeriesLotesAutoOrden		varchar(20),
    @FormaPagoOI					varchar(50),
	@POSSeriesLotesAutoOrden		bit,
	@MovDevolucion					varchar(20),
	@EsDevolucion					bit,
	@CfgVentaPrecioMoneda			bit

    SET @Estacion = @@SPID
	SELECT @MultiUnidades = MultiUnidades, @BloquearCantidadInventario = BloquearCantidadInventario 
	  FROM EmpresaCfg2 
	 WHERE Empresa = @Empresa      
     
	SELECT @TipoCosteo = TipoCosteo, @CfgSeriesLotesAutoOrden = SeriesLotesAutoOrden, @CfgVentaPrecioMoneda = ISNULL(VentaPrecioMoneda,0)
	  FROM EmpresaCfg 
	 WHERE Empresa = @Empresa  

	--DETERMINA EL ARTICULO REDONDEO
	SELECT @CodigoRedondeo = pc.RedondeoVentaCodigo,
		   @MovFactura = pc.MovFactura, 
		   @TipoMonedero = pc.TipoMonedero, 
		   @AutoAjuste = pc.AutoAjuste, 
		   @VenderSinExistencia = pc.VenderSinExistencia,
		   @POSSeriesLotesAutoOrden = ISNULL(POSSeriesLotesAutoOrden,0),
		   @MovDevolucion				= ISNULL(NULLIF(POSDefMovDev,''),'Nota Devolucion')
	  FROM POSCfg pc
     WHERE pc.Empresa = @Empresa
    
	SELECT @MovFactura2 = VentaFactura 
	FROM EmpresaCfgMov 
	WHERE Empresa = @Empresa
   
	SELECT @VentaPreciosImpuestoIncluido = VentaPreciosImpuestoIncluido, @ArticuloTarjeta= CxcArticuloTarjetasDef,
		   @AlmacenTarjeta= CxcAlmacenTarjetasDef , @ContMoneda = ContMoneda--, @VenderSinExistencia = NotasBorrador    
	  FROM EmpresaCfg 
     WHERE Empresa = @Empresa
   
	SELECT @ContMonedaTC = TipoCambio 
	  FROM POSLTipoCambioRef 
	 WHERE Sucursal = @Sucursal AND Moneda = @ContMoneda
	
	SELECT @ArticuloRedondeo = Cuenta
      FROM CB
     WHERE Codigo = @CodigoRedondeo
       AND TipoCuenta = 'Articulos'
  
	DECLARE crPOSL CURSOR LOCAL FOR		
	SELECT 
		pm.ID, 
		   pm.Mov,
		   pm.MovID,
		   pm.FechaEmision,
		   pm.FechaRegistro,
		   pm.Concepto, 
		   pm.Proyecto, 
		   pm.UEN, 
		   pm.Moneda,
		   pm.TipoCambio,
		   pm.Usuario, 
		   pm.Referencia, 
		   pm.Observaciones,
		   pm.Cliente, 
		   pm.Nombre,
		   pm.Direccion,
		   pm.DireccionNumero,
		   pm.DireccionNumeroInt,
		   pm.EntreCalles,
		   pm.Delegacion,
		   pm.Colonia,
		   pm.Poblacion,
		   pm.Estado,
		   pm.Pais,
		   pm.Zona,
		   pm.CodigoPostal,
		   pm.RFC,
		   pm.CURP,
		   pm.EnviarA, 
		   pm.Almacen, 
		   pm.Agente, 
		   pm.Cajero, 
		   pm.FormaEnvio,
		   pm.Condicion, 
		   pm.Vencimiento, 
		   pm.CtaDinero, 
		   pm.CtaDineroDestino,
		   pm.Descuento,
		   pm.DescuentoGlobal, 
		   pm.Causa, 
		   pm.Atencion,
		   pm.AtencionTelefono, 
		   pm.ListaPreciosEsp, 
		   pm.ZonaImpuesto, 
		   pm.Sucursal,
		   ISNULL(NULLIF(pm.OrigenTipo,''),'POS'),
		   pm.Origen,
		   pm.OrigenID,
		   pm.Importe,
		   mt.Clave,
		   pm.Prefijo,
		   pm.Consecutivo,
		   pm.noAprobacion,
		   pm.fechaAprobacion,
		   CadenaOriginal = CONVERT(varchar(MAX), pm.CadenaOriginal),
		   pm.Sello,
		   pm.FechaCancelacion,
		   pm.Certificado,
		   DocumentoXML = CONVERT(varchar(MAX), pm.DocumentoXML),
		   pm.FechaSello,
		   pm.Estatus,
		   pm.Monedero,
		   pm.BeneficiarioNombre,
		   pm.Impuestos,
		   ISNULL(pm.Directo,1),
		   pm.NombreArchivo,
		   pm.XmlJasper,
		   pm.UUID,              
		   pm.FechaTimbrado ,    
		   pm.SelloSat,          
		   pm.TFDVersion,        
		   pm.NoCertificadoSAT,  
		   pm.TFDCadenaOriginal,
		   ISNULL(pm.AfectadoEnLinea,0),
		   pm.PedidoReferencia, 
		   pm.PedidoReferenciaID,
		   mt.SubClave,
		   pm.FechaNacimiento, 
		   pm.EstadoCivil , 
		   pm.Conyuge ,  
		   pm.Sexo,  
		   pm.Fuma,  
		   pm.Profesion,  
		   pm.Puesto,  
		   pm.NumeroHijos,  
		   pm.Religion ,
		   pm.Facturado,
		   ISNULL(pm.CFDGenerado,0),
		   pm.NombreDF,  
		   pm.ApellidosDF,  
		   pm.PasaporteDF,  
		   pm.NacionalidadDF,  
		   pm.NoVueloDF,
		   pm.AerolineaDF,  
		   pm.OrigenDF,
		   pm.DestinoDF              
	  FROM POSL pm
    INNER JOIN MovTipo mt ON pm.Mov = mt.Mov
	AND mt.Modulo = 'POS'
	 WHERE pm.Modulo = @Modulo 
       AND pm.Empresa = @Empresa
       AND pm.ID = @ID     
	  OPEN crPOSL   
	FETCH NEXT FROM crPOSL INTO @IDAnterior, @Mov, @MovID, @FechaEmision, @FechaRegistro, @Concepto, @Proyecto, @UEN, @Moneda, @TipoCambio, @UsuarioMov, 
		@Referencia, @Observaciones, @Cliente, @Nombre, @Direccion, @DireccionNumero, @DireccionNumeroInt, @EntreCalles, @Delegacion, @Colonia, @Poblacion, 
		@Estado, @Pais, @Zona, @CodigoPostal, @RFC, @CURP, @CteEnviarA, @Almacen, @Agente, @Cajero, @FormaEnvio, @Condicion, @Vencimiento, @CtaDinero, 
		@CtaDineroDestino, @Descuento, @DescuentoGlobal, @Causa, @Atencion, @AtencionTelefono, @ListaPreciosEsp, @ZonaImpuesto, @SucursalMov, @OrigenTipo, 
		@Origen, @OrigenID, @Importe, @MovClave, @Serie, @Consecutivo, @noAprobacion, @fechaAprobacion, @CadenaOriginal, @Sello, @FechaCancelacion, 
		@Certificado, @DocumentoXML, @FechaSello, @Estatus, @Monedero,@Beneficiario, @Impuestos, @Directo, @NomArchivo, @XML, @UUID, @FechaTimbrado, 
		@SelloSat, @TFDVersion, @NoCertificadoSAT, @TFDCadenaOriginal, @AfectadoEnLinea, @PedidoReferencia, @PedidoReferenciaID, @MovSubClave,
		@FechaNacimiento, @EstadoCivil, @Conyuge, @Sexo, @Fuma, @Profesion, @Puesto, @NumeroHijos, @Religion, @Facturado, @CFDGenerado,
		@NombreDF, @ApellidosDF, @PasaporteDF, @NacionalidadDF, @NoVueloDF, @AerolineaDF, @OrigenDF, @DestinoDF  
	WHILE @@FETCH_STATUS <> -1
	BEGIN
		IF @@FETCH_STATUS <> -2
		BEGIN
			IF @Modulo = 'VTAS' AND @MovClave NOT IN ('POS.NPC')
			BEGIN
				SET @EsDevolucion = 0
				IF @MovDevolucion = @Mov
					SET @EsDevolucion = 1

				IF @MovClave IN( 'POS.P','POS.N') AND ISNULL(@MovSubClave,'') NOT IN( 'POS.PEDCONT')
					SELECT @Condicion = NULL
  
				IF EXISTS(SELECT 1 FROM Cte WHERE Cliente = @Cliente)
					UPDATE Cte Set  Nombre = @Nombre,
									Direccion = @Direccion,
									DireccionNumeroInt = @DireccionNumeroInt,
									EntreCalles = @EntreCalles,
									Delegacion = @Delegacion,
									Colonia = @Colonia,
									Poblacion = @Poblacion,
									Estado = @Estado,
									Pais = @Pais,
									Zona = @Zona,
									CodigoPostal = @CodigoPostal,
									RFC = @RFC,
									CURP = CURP,
         							FechaNacimiento = @FechaNacimiento,	
									EstadoCivil	= @EstadoCivil,
									Conyuge	= @Conyuge,	
									Sexo = @Sexo	,	
									Fuma	= @Fuma	,
									Profesion = @Profesion ,	
									Puesto = @Puesto,		
									NumeroHijos	= @NumeroHijos,
									Religion = @Religion      
							 WHERE  Cliente = @Cliente
				ELSE
					INSERT Cte (Cliente, Nombre, Direccion, DireccionNumero, DireccionNumeroInt, EntreCalles, Observaciones, Delegacion, Colonia, 
								Poblacion, Estado, Pais, Zona, CodigoPostal, RFC, CURP, Tipo, Estatus, FechaNacimiento, EstadoCivil, Conyuge, Sexo,
								Fuma, Profesion, Puesto, NumeroHijos, Religion)                      
					VALUES (@Cliente, @Nombre, @Direccion, @DireccionNumero, @DireccionNumeroInt, @EntreCalles, @Observaciones, @Delegacion, @Colonia, 
								@Poblacion, @Estado, @Pais, @Zona, @CodigoPostal, @RFC, @CURP, 'Cliente', 'ALTA', @FechaNacimiento, @EstadoCivil, @Conyuge, @Sexo, 
								@Fuma, @Profesion, @Puesto, @NumeroHijos, @Religion)  
        
				IF @Estatus = 'CONCLUIDO' 
					SELECT @EstatusInsertar = 'SINAFECTAR'
				ELSE 
				IF @Estatus = 'CANCELADO' 
					SELECT @EstatusInsertar = 'CANCELADO'
							
				SELECT @MovCFD = MovFactura 
				  FROM POSCfg 
				 WHERE Empresa = @Empresa
        
				IF @MovClave IN('POS.N') 
					SET @GenerarDinero = 1  
       
				IF NULLIF(@Origen,'') IS NOT NULL AND NULLIF(@OrigenID,'') IS NOT NULL AND @Origen NOT IN (@MovCFD)
					SELECT @Directo = 0    
      
				IF EXISTS(SELECT * FROM POSLVenta WHERE NULLIF(Aplica,'') IS NOT NULL AND NULLIF(AplicaID,'') IS NOT NULL AND ID = @ID)
					SELECT @Directo = 0               
        
				IF @AfectadoEnLinea = 0
				BEGIN
					INSERT Venta (Empresa, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, 
								  Usuario, Referencia, Estatus, Observaciones, Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, 
								  CtaDinero, POSDescuento, DescuentoGlobal, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo,
								  Origen, OrigenID, ReferenciaOrdenCompra, GenerarDinero, SucursalOrigen, Directo, PedidoReferencia, PedidoReferenciaID,
								  Monedero, Refacturado, SucursalVenta, NombreDF, ApellidosDF, PasaporteDF, NacionalidadDF, NoVueloDF,
								  AerolineaDF, OrigenDF, DestinoDF)                  
					VALUES		 (@Empresa, @Mov, @MovID, @FechaEmision, @FechaRegistro, @Concepto, @Proyecto, @UEN, @Moneda, CASE WHEN @Moneda <> @ContMoneda THEN (@TipoCambio/@ContMonedaTC) ELSE @TipoCambio END, 
								 @Usuario, @Referencia, @EstatusInsertar, dbo.fnPOSCBGenerar (@ID), @Cliente, @CteEnviarA, @Almacen, @Agente, @FormaEnvio, @Condicion, @Vencimiento,
								 @CtaDinero, @Descuento, 0.0, @Causa, @Atencion, @AtencionTelefono, @ListaPreciosEsp, @ZonaImpuesto, @SucursalMov, @OrigenTipo,
								 @Origen, @OrigenID, @ID, @GenerarDinero, @SucursalMov, @Directo, @PedidoReferencia, @PedidoReferenciaID,
								 @Monedero, @Facturado, @Sucursal, @NombreDF, @ApellidosDF, @PasaporteDF, @NacionalidadDF, @NoVueloDF, 
								 @AerolineaDF, @OrigenDF, @DestinoDF)  

					SELECT @IDNuevo = SCOPE_IDENTITY()
				
					INSERT VentaD (ID, Renglon, RenglonID, Aplica, AplicaID, RenglonTipo, 
								   Cantidad, 
								   CantidadObsequio, 
								   EnviarA, Articulo, SubCuenta,
								   Precio, 
								   DescuentoLinea, 
								   DescuentoImporte, 
								   Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, Sucursal, Puntos, 
								   POSDesGlobal, 
								   POSDesLinea, Codigo, Almacen, 
								   CantidadPendiente, 
								   OfertaID, OfertaIDG1, OfertaIDG2, OfertaIDG3,OfertaIDP1, OfertaIDP2, OfertaIDP3, 
								   DescuentoG1, DescuentoG2, DescuentoG3, DescuentoP1, DescuentoP2, DescuentoP3, 
								   CantidadInventario, 
								   Agente,
								   PrecioMoneda, 
								   PrecioTipoCambio)              
					SELECT		   @IDNuevo, pmv.Renglon, pmv.RenglonID, pmv.Aplica, pmv.AplicaID, pmv.RenglonTipo, 
								   CASE WHEN @MovClave = 'POS.N' AND ISNULL(@MovSubClave,'') = 'POS.DREF' THEN pmv.Cantidad *-1 ELSE pmv.Cantidad END, 
								   CASE WHEN @MovClave ='POS.N' AND ISNULL(@MovSubClave,'') = 'POS.DREF' THEN pmv.CantidadObsequio *-1 ELSE pmv.CantidadObsequio END, 
								   @CteEnviarA, pmv.Articulo, pmv.SubCuenta,
								   CASE WHEN @VentaPreciosImpuestoIncluido = 1 THEN pmv.PrecioImpuestoInc ELSE pmv.Precio END, 
								   dbo.fnPOSCalcDescuentosVenta(CASE WHEN ISNULL(pmv.AplicaDescGlobal, 1) = 1 THEN ISNULL(@DescuentoGlobal,0.0) ELSE 0 END, pmv.DescuentoLinea), 
								   (pmv.Cantidad*pmv.Precio)*(dbo.fnPOSCalcDescuentosVenta(CASE WHEN ISNULL(pmv.AplicaDescGlobal, 1) = 1 THEN ISNULL(@DescuentoGlobal,0.0) ELSE 0 END,pmv.DescuentoLinea)/100.0), 
								   pmv.Impuesto1, pmv.Impuesto2, pmv.Impuesto3, pmv.Unidad, 1, @SucursalMov, pmv.Puntos, 
								   CASE WHEN ISNULL(pmv.AplicaDescGlobal, 1) = 1 THEN ISNULL(@DescuentoGlobal,0.0) ELSE 0 END, 
								   ISNULL(pmv.DescuentoLinea,0.0), pmv.Codigo, ISNULL(pmv.Almacen,@Almacen), 
								   CASE WHEN @MovClave IN('POS.P') THEN pmv.Cantidad ELSE NULL END,
								   pmv.OfertaID, pmv.OfertaIDG1, pmv.OfertaIDG2, pmv.OfertaIDG3, pmv.OfertaIDP1, pmv.OfertaIDP2, pmv.OfertaIDP3, 
								   pmv.DescuentoG1, pmv.DescuentoG2, pmv.DescuentoG3, pmv.DescuentoP1, pmv.DescuentoP2, pmv.DescuentoP3,
								   CASE WHEN @MultiUnidades = 1 THEN pmv.CantidadInventario ELSE NULL END, Agente,
								   CASE WHEN @CfgVentaPrecioMoneda = 1 THEN @Moneda ELSE NULL END,
								   CASE WHEN @CfgVentaPrecioMoneda = 1 THEN @TipoCambio ELSE NULL END
					  FROM		   POSLVenta pmv
					 WHERE		   pmv.ID = @IDAnterior

					DECLARE crST1 CURSOR LOCAL FOR     
					 SELECT vd.Renglon, vd.Articulo, vd.SubCuenta, vd.Unidad   
					   FROM VentaD vd  
					  WHERE vd.ID = @IDNuevo  				
					   OPEN crST1  
					FETCH NEXT FROM crST1 INTO @Renglon, @Articulo, @SubCuenta, @Unidad  
					WHILE @@FETCH_STATUS <> -1
					BEGIN
						IF @@FETCH_STATUS <> -2   
						BEGIN          
							EXEC spVerCosto @Sucursal, @Empresa, NULL, @Articulo, @SubCuenta, @Unidad,  @TipoCosteo, @Moneda, @TipoCambio, @MovCosto OUTPUT, @ConReturn = 0  
					
							UPDATE VentaD SET Costo = @MovCosto WHERE ID=@IDNuevo AND Renglon = @Renglon                
						END
					FETCH NEXT FROM crST1 INTO @Renglon, @Articulo, @SubCuenta, @Unidad  
					END                    
					CLOSE crST1  
					DEALLOCATE crST1  
  
					IF @AutoAjuste = 1 AND @VenderSinExistencia = 1 AND @MovClave IN ('POS.F', 'POS.FA')  
					BEGIN  
						EXEC spPOSGeneraAjuste @Empresa, @Sucursal, @IDNuevo, @Moneda, @FechaEmision, @TipoCambio, @Almacen, @Usuario, @Ok OUTPUT, @OkRef OUTPUT            
					END
      
					IF  @AutoAjuste = 1 AND @VenderSinExistencia = 0 AND @MovClave IN ('POS.F', 'POS.FA', 'POS.N')
					BEGIN  
						EXEC spPOSGeneraAjuste @Empresa, @Sucursal, @IDNuevo, @Moneda, @FechaEmision, @TipoCambio, @Almacen, @Usuario, @Ok OUTPUT, @OkRef OUTPUT            
					END      
          
					IF EXISTS(SELECT 1 FROM POSLSerieLote pls WHERE pls.ID = @IDAnterior)
					BEGIN
						IF @POSSeriesLotesAutoOrden = 0
							SET @CfgSeriesLotesAutoOrden = 'NO'

						IF @CfgSeriesLotesAutoOrden <> 'NO' 
							EXEC spPOSSeriesLotesAutoOrden @IDAnterior, @SucursalMov, @Empresa, @IDNuevo, @CfgSeriesLotesAutoOrden
						ELSE              
						BEGIN
							IF @EsDevolucion = 0
							INSERT SerieLoteMov (Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal)
							SELECT				 @Empresa, 'VTAS', @IDNuevo, pls.RenglonID, pls.Articulo, ISNULL(pls.SubCuenta,''), pls.SerieLote, COUNT(*), @SucursalMov 
							  FROM POSLSerieLote pls
							 WHERE pls.ID = @IDAnterior
							 GROUP BY Articulo, ISNULL(SubCuenta,''), SerieLote, RenglonID
							ELSE
								INSERT SerieLoteMov (Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal)
								SELECT				 @Empresa, 'VTAS', @IDNuevo, pls.RenglonID, pls.Articulo, ISNULL(pls.SubCuenta,''), pls.SerieLote, (COUNT(*) * (-1)), @SucursalMov 
								  FROM POSLSerieLote pls
								 WHERE pls.ID = @IDAnterior
								 GROUP BY Articulo, ISNULL(SubCuenta,''), SerieLote, RenglonID
						END
					END
		                 
					SELECT @MonederoMoneda = Moneda FROM POSValeSerie WHERE Serie = @Monedero		                 

					SELECT @MonederoTipoCambio = ISNULL(TipoCambio,1.0)  
					  FROM POSLTipoCambioRef 
					 WHERE Moneda = @MonederoMoneda AND Sucursal = @Sucursal		                 
		                 
					IF EXISTS(SELECT * FROM POSValeSerie WHERE Serie = @Monedero)
						INSERT TarjetaSerieMov(Empresa, ID, Modulo, Serie, Sucursal, TipoCambioTarjeta)
						SELECT				   @Empresa, @IDNuevo, @Modulo, @Monedero, @Sucursal, ISNULL(@MonederoTipoCambio,1.0)             
		                 
					EXEC spPOSAfectarVentaCobro @IDAnterior, @IDNuevo, @Empresa,@SucursalMov, @Ok OUTPUT, @OkRef OUTPUT
          
					IF EXISTS(SELECT * FROM POSCxcAnticipo WHERE ID = @IDAnterior)AND @IDNuevo IS NOT NULL
					BEGIN          
						UPDATE Cxc SET AnticipoAplicaID = @IDNuevo ,AnticipoAplicaModulo = 'VTAS',AnticipoAplicar =a.AnticipoAplicar
						  FROM POSCxcAnticipo a JOIN Cxc c ON a.GUIDOrigen = c.POSGUID 
					END        
        
					IF @Ok IS NULL  
					BEGIN
						DELETE FROM VentaD WHERE Id = @IDNuevo AND ISNULL(Cantidad,0) = 0
							
						IF @Estatus = 'CONCLUIDO' 
						BEGIN
							EXEC spAfectar @Modulo, @IDNuevo, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 0, @Ok = @ok OUTPUT, @OkRef = @OkRef OUTPUT
							
							EXEC xpPOSAfectarVenta @IDAnterior, @IDNuevo, @Ok OUTPUT, @okRef OUTPUT
							IF NULLIF(@CadenaOriginal,'') IS NOT NULL
							BEGIN
								SELECT @FechaSello = ISNULL(@FechaSello,GETDATE())
												
								IF NOT EXISTS(SELECT * FROM CFD WHERE Modulo = @Modulo AND ModuloID = @IDNuevo)
								BEGIN
									INSERT CFD(Modulo, ModuloID, Fecha, Ejercicio, Periodo, Empresa, MovID, Serie, 
											   Folio, RFC, Aprobacion, Importe, Impuesto1, Impuesto2, FechaCancelacion, 
											   noCertificado, Sello, CadenaOriginal, Documento, UUID, FechaTimbrado, SelloSat, 
											   TFDVersion, NoCertificadoSAT, TFDCadenaOriginal, Timbrado)
									VALUES    (@Modulo, @IDNuevo, @FechaSello, YEAR(@FechaSello), MONTH(@FechaSello), @Empresa, @MovID, @Serie,
											   @Consecutivo, @RFC, @noAprobacion, @CFDImporte, @CFDImpuesto1,@CFDImpuesto2, @FechaCancelacion,
											   @Certificado, @Sello, @CadenaOriginal, @DocumentoXML, @UUID, @FechaTimbrado, @SelloSat,
											   @TFDVersion, @NoCertificadoSAT, @TFDCadenaOriginal, 1)
								END
								ELSE
									UPDATE CFD SET Fecha = @FechaSello, 
												   Ejercicio = YEAR(@FechaSello), 
												   Periodo = MONTH(@FechaSello),
												   Empresa = @Empresa,  
												   MovID = @MovID,  
												   Serie =@Serie,  
												   Folio = @Consecutivo,
												   RFC = @RFC, 
												   Aprobacion = @noAprobacion, 
												   Importe = @CFDImporte, 
												   Impuesto1 = @CFDImpuesto1,
												   Impuesto2 = @CFDImpuesto2, 
												   FechaCancelacion = @FechaCancelacion, 
												   noCertificado = @Certificado,
												   Sello = @Sello, 
												   CadenaOriginal = @CadenaOriginal, 
												   Documento = @DocumentoXML, 
												   UUID = @UUID, 
												   FechaTimbrado = @FechaTimbrado, 
												   SelloSat = @SelloSat, 
												   TFDVersion = @TFDVersion,
												   NoCertificadoSAT = @NoCertificadoSAT, 
												   TFDCadenaOriginal = @TFDCadenaOriginal, 
												   Timbrado = 1
									 WHERE Modulo = @Modulo
									   AND ModuloID = @IDNuevo	
								
								IF NULLIF(@NomArchivo,'') IS NOT NULL AND  NULLIF(@XML,'') IS NOT NULL
									EXEC spPOSRegenerarReporteJasper @Empresa, @Sucursal,@Cliente, 'VTAS', @IDNuevo, @MovCFD, @XML, @NomArchivo, @OkReporte  OUTPUT, @OkRefReporte  OUTPUT

								IF NULLIF(@NomArchivo,'') IS NOT NULL AND  NULLIF(@XML,'') IS NULL
									EXEC spPOSRegenerarCFDFlex @Estacion, @Empresa, 'VTAS', @IDNuevo, @ID,  @Estatus, @OkReporte OUTPUT, @OkRefReporte OUTPUT

								IF @OkReporte IS NULL
									UPDATE POSL SET CFDGenerado = 1 WHERE ID = @ID
							END	      
						END 
					END
				END
				ELSE 
				BEGIN
					IF NULLIF(@CadenaOriginal,'') IS NOT NULL AND @Estatus = 'TRASPASADO' AND @CFDGenerado = 0
					BEGIN
						SELECT @IDNuevo = ID FROM Venta WHERE ReferenciaOrdenCompra = @ID AND Mov = @Mov AND MovID = @MovID AND Empresa = @Empresa
						SELECT @FechaSello = ISNULL(@FechaSello,GETDATE())
						
						IF @IDNuevo IS NOT NULL AND @Ok IS NULL
						BEGIN
							IF NOT EXISTS(SELECT * FROM CFD WHERE Modulo = @Modulo AND ModuloID = @IDNuevo)
							BEGIN
								INSERT CFD (Modulo, ModuloID, Fecha, Ejercicio, Periodo, Empresa, MovID, Serie, 
											Folio, RFC, Aprobacion, Importe, Impuesto1, Impuesto2, FechaCancelacion, 
											noCertificado, Sello, CadenaOriginal, Documento, UUID, FechaTimbrado, SelloSat, TFDVersion, 
											NoCertificadoSAT, TFDCadenaOriginal, Timbrado)
								VALUES (	@Modulo, @IDNuevo, @FechaSello, YEAR(@FechaSello), MONTH(@FechaSello), @Empresa, @MovID, @Serie,
											@Consecutivo, @RFC, @noAprobacion, @CFDImporte, @CFDImpuesto1,@CFDImpuesto2, @FechaCancelacion, 
											@Certificado, @Sello, @CadenaOriginal, @DocumentoXML, @UUID, @FechaTimbrado, @SelloSat, @TFDVersion,
											@NoCertificadoSAT, @TFDCadenaOriginal, 1)
	        	        
								SELECT @MovCFD = MovFactura FROM POSCfg WHERE Empresa = @Empresa
	        
								IF NULLIF(@NomArchivo,'') IS NOT NULL AND  NULLIF(@XML,'') IS NOT NULL
									EXEC spPOSRegenerarReporteJasper @Empresa, @Sucursal,@Cliente, 'VTAS', @IDNuevo, @MovCFD, @XML, @NomArchivo, @OkReporte  OUTPUT, @OkRefReporte  OUTPUT

								IF NULLIF(@NomArchivo,'') IS NOT NULL AND  NULLIF(@XML,'') IS NULL
									EXEC spPOSRegenerarCFDFlex @Estacion, @Empresa, 'VTAS', @IDNuevo, @ID,  @Estatus, @OkReporte OUTPUT, @OkRefReporte OUTPUT
                
								IF @OkReporte IS NULL
									UPDATE POSL SET CFDGenerado = 1 WHERE ID = @ID  	       
							END      
						END    		      
					END         
				END
        
				IF @Estatus = 'CANCELAR'
				BEGIN
					SELECT @IDNuevo = ID FROM Venta WHERE ReferenciaOrdenCompra = @ID
					
					IF @IDNuevo IS NOT NULL
						EXEC spAfectar @Modulo, @IDNuevo, 'CANCELAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @ok OUTPUT, @OkRef = @OkRef OUTPUT
				END
			END
			
			IF @Modulo = 'DIN' AND @MovClave NOT IN('POS.TCAC','POS.CTCAC')
			BEGIN
				IF @MovClave IN('POS.IC','POS.EC')
					SELECT @CtaDineroDestino = NULL
          
				INSERT Dinero (Empresa, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, 
							   Usuario, Estatus, Importe, Observaciones, CtaDinero, CtaDineroDestino, ConDesglose, Cajero, 
							   Sucursal, SucursalOrigen, BeneficiarioNombre, OrigenTipo)
				VALUES		  (@Empresa, @Mov, @MovID, @FechaEmision, @FechaRegistro, @Concepto, @Proyecto, @UEN, @Moneda, 
							  CASE WHEN @Moneda <> @ContMoneda THEN  (@TipoCambio/@ContMonedaTC) ELSE @TipoCambio END, 
							  @Usuario, 'SINAFECTAR', @Importe, @Observaciones, @CtaDinero, @CtaDineroDestino, 1, @Cajero, 
							  @SucursalMov, @SucursalMov, @Beneficiario, 'POS')
  
				SELECT @IDNuevo = SCOPE_IDENTITY()
		
				EXEC spPOSAfectarDineroD @IDAnterior, @IDNuevo, @SucursalMov,@MovClave ,@Ok OUTPUT, @OkRef OUTPUT
				EXEC xpPOSAfectarDineroD @IDAnterior, @IDNuevo, @SucursalMov,@MovClave ,@Ok OUTPUT, @OkRef OUTPUT  
	
				IF EXISTS(SELECT * FROM POSLDenominacion WHERE ID = @IDAnterior)
				BEGIN	
					INSERT DineroDenominacion(ID, FormaPago, Denominacion,Nombre, Cantidad)
					SELECT					  @IDNuevo, FormaPago, Denominacion,Nombre, Cantidad
					  FROM POSLDenominacion
					 WHERE ID = @IDAnterior 
				END 	

				IF @OK IS NULL
					EXEC spAfectar @Modulo, @IDNuevo, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT
			END
      
			IF @Modulo = 'VALE'
			BEGIN

				INSERT Vale(Empresa, Mov, MovID, FechaEmision, Moneda,  TipoCambio, 
							Usuario,  Estatus,	  Sucursal, Tipo,          Precio,					Importe, 
							Cantidad,  CtaDinero, Articulo,            Almacen,                          FechaInicio,    OrigenTipo)
				SELECT      @Empresa,@Mov,@MovID,@FechaEmision,@Moneda, CASE WHEN @Moneda <> @ContMoneda THEN  (@TipoCambio/@ContMonedaTC) ELSE @TipoCambio END, 
							@Usuario,'SINAFECTAR',@Sucursal,@TipoMonedero, ISNULL(@Importe,0.0),    ISNULL(@Importe,0.0),     
							1,         @CtaDinero, @ArticuloTarjeta,  ISNULL(@AlmacenTarjeta, @Almacen), @FechaEmision , 'POS'  

        
				SELECT @IDNuevo = SCOPE_IDENTITY()
        
				INSERT ValeD(ID, Serie, Sucursal, SucursalOrigen,Importe)
				SELECT @IDNuevo, @Monedero, @SucursalMov, @SucursalMov, 0.0  
		
				IF @OK IS NULL
					EXEC spAfectar @Modulo, @IDNuevo, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT	  
			END 
      
			IF @Modulo = 'CXC'
			BEGIN
				IF @PedidoReferencia IS NOT NULL
				BEGIN
					IF EXISTS(SELECT * FROM VentaPedidoAnticipoPendiente WHERE MovConsecutivo = @PedidoReferencia)
						SELECT @PedidoReferencia = MovConsecutivo, @PedidoReferenciaID = ID 
						  FROM VentaPedidoAnticipoPendiente 
						 WHERE MovConsecutivo = @PedidoReferencia
					ELSE 
					IF  EXISTS(SELECT * FROM POSL WHERE ID = @PedidoReferencia AND Mov IN(SELECT Mov FROM MovTipo WHERE Modulo = 'POS' AND Clave = 'POS.P'))
						SELECT @PedidoReferencia = p.Mov+' '+p.MovID, 
							   @PedidoReferenciaID = (SELECT ID FROM VentaPedidoAnticipoPendiente WHERE MovConsecutivo = p.Mov+' '+p.MovID) 
						  FROM POSL p 
						 WHERE p.ID = @PedidoReferencia  
					ELSE 
					IF EXISTS(SELECT * FROM POSLCB cb JOIN POSL pl ON cb.ID = pl.ID WHERE cb.IDCB  = @PedidoReferencia AND pl.Mov IN(SELECT Mov FROM MovTipo WHERE Modulo = 'POS' AND Clave = 'POS.P'))
						SELECT @PedidoReferencia = p.Mov+' '+p.MovID, 
							   @PedidoReferenciaID = (SELECT ID FROM VentaPedidoAnticipoPendiente WHERE MovConsecutivo = p.Mov+' '+p.MovID) 
						  FROM POSLCB cb JOIN POSL p ON cb.ID = p.ID 
						 WHERE cb.IDCB  = @PedidoReferencia             
					ELSE  
						SELECT @PedidoReferencia = NULL, @PedidoReferenciaID = NULL           
				END
        
				IF @MovClave IN('POS.CXCC'/*,'POS.CXCD'*/)   
				BEGIN
					INSERT Cxc(Empresa, Mov, MovID, FechaEmision, Moneda, TipoCambio, 
							   Usuario, Estatus, Cliente, ClienteEnviarA, CtaDinero, Condicion, Importe, Impuestos, Agente, Sucursal, Cajero, Concepto, ClienteMoneda,
							   ClienteTipoCambio,
							   OrigenTipo, POSGUID, PedidoReferencia, PedidoReferenciaID, Referencia, SucursalOrigen)  
					SELECT     @Empresa, @Mov, @MovID, @FechaEmision, @Moneda, CASE WHEN @Moneda <> @ContMoneda THEN (@TipoCambio/@ContMonedaTC) ELSE @TipoCambio END, 
							   @Usuario, 'SINAFECTAR', @Cliente, @CteEnviarA, @CtaDinero, 
							   @Condicion, @Importe, @Impuestos, @Agente, @Sucursal, @Cajero, @Concepto, @Moneda, 
							   CASE WHEN @Moneda <> @ContMoneda THEN (@TipoCambio/@ContMonedaTC) ELSE @TipoCambio END,
							   'POS', @IDAnterior, @PedidoReferencia, @PedidoReferenciaID, @PedidoReferencia, @Sucursal  
        
					SELECT @IDNuevo = SCOPE_IDENTITY()
				END
        
				IF @MovClave IN('POS.CXCC'/*,'POS.CXCD'*/)   
				BEGIN
					EXEC spPOSInsertarCxcCobroDetalle @IDAnterior, @IDNuevo, @Empresa, @Sucursal, @Usuario, @Moneda, @MovClave, @Ok OUTPUT, @OkRef OUTPUT	
  
					IF @MovClave='POS.CXCC'  
					BEGIN
						INSERT NegociaMoratoriosMAVI(IDCobro, Estacion, Usuario, Mov, MovID, ImporteReal, ImporteAPagar, ImporteMoratorio, ImporteACondonar, 
													 MoratorioAPagar, Origen, OrigenID)        
						SELECT DISTINCT				 @IDNuevo, @@SPID, @Usuario, Aplica, AplicaID, ImporteReal, ImporteAPagar, ImporteMoratorio, 0, 
													 MoratorioAPagar, Origen, OrigenID    
						  FROM POSLVenta   
						 WHERE ID = @ID            
              
						EXEC spGeneraCobroSugeridoPOS 'CXC', @IDNuevo,  @Usuario, @@SPID, @Ok OUTPUT, @OkRef OUTPUT 
						
						IF @Ok = 80030 
							SELECT @Ok = NULL   
					END
				END  
      
				IF @OK IS NULL AND @MovClave = 'POS.CXCD'  
				BEGIN
					SELECT @IDNuevo = ID
					  FROM Cxc 
					 WHERE Mov = (SELECT TOP 1  Aplica FROM POSLVenta WHERE ID = @ID) AND MovID = (SELECT TOP 1 AplicaID FROM POSLVenta WHERE ID = @ID)
               
					EXEC spAfectar @Modulo, @IDNuevo, 'CANCELAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT  
					
					IF @Ok IS NULL AND @MovClave = 'POS.FA'
						EXEC spPOSAfectarCxcGenerarCobro @IDAnterior, @IDNuevo, @Empresa, @Sucursal, @Usuario, @Moneda, @Ok OUTPUT, @OkRef OUTPUT	  
				END  

				IF @OK IS NULL AND @MovClave = 'POS.CXCC' AND (SELECT TOP 1 1 FROM POSLCobro WHERE ID = @ID AND Referencia = 'COMISION CREDITO') = 1  
				BEGIN
					DECLARE crAA CURSOR FOR           
					 SELECT FormaPago
					   FROM POSLCobro
					  WHERE ID = @ID 
						AND Referencia = 'COMISION CREDITO'
					   OPEN crAA
					FETCH NEXT FROM crAA INTO @FormaPagoOI
					WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL        
					BEGIN
						SELECT @CtaDinero = DefCtaDinero FROM Usuario WHERE Usuario = @Usuario     
            
						INSERT Dinero (Empresa, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, 
									   TipoCambio, 
									   Usuario, Estatus, Importe, Observaciones, CtaDinero, CtaDineroDestino,
									   ConDesglose, Cajero, Sucursal, SucursalOrigen, BeneficiarioNombre, OrigenTipo, FormaPago,
									   Referencia)  
						SELECT			@Empresa, 'Otros Ingresos', null, @FechaEmision, @FechaRegistro, p.Referencia, @Proyecto, @UEN, @Moneda,
										CASE WHEN @Moneda <> @ContMoneda THEN (@TipoCambio/@ContMonedaTC) ELSE @TipoCambio END, 
										@Usuario, 'SINAFECTAR', (p.ImporteRef), @Observaciones, @CtaDinero, @CtaDineroDestino, 
										0, @Cajero, @Sucursal, @Sucursal, @Beneficiario, 'POS', p.FormaPago, 
										(SELECT Mov+'  '+MovID FROM POSL WHERE ID = @ID)  FROM POSLCobro p WHERE ID = @ID AND p.Referencia IN('COMISION CREDITO')  AND FormaPago = @FormaPagoOI
    
						IF @@ERROR <> 0  SET @Ok = 1     
   
						SELECT @IDNuevo = SCOPE_IDENTITY()
   
						IF @OK IS NULL  
							EXEC spAfectar 'DIN', @IDNuevo, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT          

					FETCH NEXT FROM crAA INTO @FormaPagoOI
					END  
					CLOSE crAA        
					DEALLOCATE crAA  
				END
								
				IF @MovClave IN('POS.FA') 
				BEGIN
					INSERT Cxc(Empresa,  Mov,  MovID,  FechaEmision,  Moneda,  TipoCambio,                                                                              Usuario,  Estatus,      Cliente,  ClienteEnviarA,  CtaDinero,  Condicion,  Importe,  Impuestos,  Agente,  Sucursal,  Cajero, Concepto, ClienteMoneda,ClienteTipoCambio,                                                                         OrigenTipo, POSGUID,      PedidoReferencia, PedidoReferenciaID,  Referencia)
					SELECT     @Empresa, @Mov, @MovID, @FechaEmision, @Moneda, CASE WHEN @Moneda <> @ContMoneda THEN  (@TipoCambio/@ContMonedaTC) ELSE @TipoCambio END, @Usuario, 'SINAFECTAR', @Cliente, @CteEnviarA,     @CtaDinero, @Condicion, @Importe, @Impuestos, @Agente, @Sucursal, @Cajero, @Concepto, @Moneda,    CASE WHEN @Moneda <> @ContMoneda THEN  (@TipoCambio/@ContMonedaTC) ELSE @TipoCambio END,       'POS',      @IDAnterior, @PedidoReferencia, @PedidoReferenciaID, @PedidoReferencia
					SELECT @IDNuevo = SCOPE_IDENTITY()

					IF @OK IS NULL
						EXEC spAfectar @Modulo, @IDNuevo, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT

					IF @Ok IS NULL
						EXEC spPOSAfectarCxcGenerarCobro @IDAnterior, @IDNuevo, @Empresa, @Sucursal, @Usuario, @Moneda, @Ok OUTPUT, @OkRef OUTPUT	 
				END
			END 
      
			EXEC xpPOSAfectar @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Ok OUTPUT, @OkRef OUTPUT
	END
	FETCH NEXT FROM crPOSL INTO @IDAnterior, @Mov, @MovID, @FechaEmision, @FechaRegistro, @Concepto, @Proyecto, @UEN, @Moneda, @TipoCambio, @UsuarioMov, 
		@Referencia, @Observaciones, @Cliente, @Nombre, @Direccion, @DireccionNumero, @DireccionNumeroInt, @EntreCalles, @Delegacion, @Colonia, @Poblacion, 
		@Estado, @Pais, @Zona, @CodigoPostal, @RFC, @CURP, @CteEnviarA, @Almacen, @Agente, @Cajero, @FormaEnvio, @Condicion, @Vencimiento, @CtaDinero, 
		@CtaDineroDestino, @Descuento, @DescuentoGlobal, @Causa, @Atencion, @AtencionTelefono, @ListaPreciosEsp, @ZonaImpuesto, @SucursalMov, @OrigenTipo, 
		@Origen, @OrigenID, @Importe, @MovClave, @Serie, @Consecutivo, @noAprobacion, @fechaAprobacion, @CadenaOriginal, @Sello, @FechaCancelacion, 
		@Certificado, @DocumentoXML, @FechaSello, @Estatus, @Monedero,@Beneficiario, @Impuestos, @Directo, @NomArchivo, @XML, @UUID, @FechaTimbrado, 
		@SelloSat, @TFDVersion, @NoCertificadoSAT, @TFDCadenaOriginal, @AfectadoEnLinea, @PedidoReferencia, @PedidoReferenciaID, @MovSubClave,
		@FechaNacimiento, @EstadoCivil, @Conyuge, @Sexo, @Fuma, @Profesion, @Puesto, @NumeroHijos, @Religion, @Facturado, @CFDGenerado,
		@NombreDF, @ApellidosDF, @PasaporteDF, @NacionalidadDF, @NoVueloDF, @AerolineaDF, @OrigenDF, @DestinoDF
		END
	CLOSE crPOSL
	DEALLOCATE crPOSL
END
GO


/************************ spPOSAfectarPOSL *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAfectarPOSL') AND type = 'P') DROP PROCEDURE dbo.spPOSAfectarPOSL
GO             
CREATE PROCEDURE spPOSAfectarPOSL
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@Empresa		varchar(5),
    @Modulo			varchar(5),
    @Sucursal		int,
    @Usuario		varchar(10),
    @Host			varchar(20),
    @ID				varchar(36),   
    @Empresa2		varchar(5),
    @Modulo2		varchar(5),
    @Sucursal2		int,
    @Usuario2		varchar(10),
    @Host2			varchar(20),
    @ID2			varchar(36), 	  
    @Ok				int,
    @OkRef			varchar(255),
    @Mov            varchar(20),
    @Mov2           varchar(20),
    @MovClave       varchar(20),
    @MovAfectar     varchar(20)
  
	BEGIN TRAN  	
	DECLARE crPOSL CURSOR LOCAL FOR  	    
	SELECT p.Empresa, p.Modulo, p.Sucursal, p.Usuario, p.ID, p.Host, p.Mov 
    FROM POSL p
	INNER JOIN MovTipo mt ON p.Mov = mt.Mov
	AND mt.Modulo = 'POS'	
	WHERE (p.Estatus IN ('CONCLUIDO','CANCELAR')) OR (mt.clave = 'POS.P' AND mt.SubClave='POS.FACCRED' AND p.Estatus ='TRASPASADO' 
	AND p.AfectadoEnLinea = 1 AND CFDGenerado = 0) OR (mt.clave = 'POS.F'  AND p.Estatus ='TRASPASADO' AND p.AfectadoEnLinea = 1 AND CFDGenerado = 0)
	ORDER BY p.FechaRegistro, p.Orden, p.IDR
  
	OPEN crPOSL
	FETCH NEXT FROM crPOSL INTO @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Mov
	WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
		BEGIN
			IF @@FETCH_STATUS <> -2 AND @Ok IS NULL
				BEGIN      
					SELECT @MovClave = Clave FROM MovTipo WHERE Mov = @Mov AND Modulo = 'POS'

					IF @MovClave NOT IN ('POS.FTE','POS.STE','POS.CC','POS.CCM','POS.TCAC','POS.CTCAC','POS.CTCRC','POS.TCRC') AND @Ok IS NULL
						BEGIN    
							EXEC spPOSAfectar @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Ok OUTPUT, @OkRef OUTPUT
        
							IF @Ok IS NOT NULL 
								SELECT @MovAfectar = @Mov
        
							IF @MovClave IN ('POS.TCM','POS.CTCM') AND @Ok IS NULL
								BEGIN
									IF EXISTS (SELECT * FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS' 
											   WHERE p.IDR = @ID AND p.Estatus IN('CONCLUIDO') AND m.Clave IN('POS.TCM','POS.CTCM'))
										UPDATE POSL SET Estatus = 'TRASPASADO' 
										WHERE ID IN (SELECT ID FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS' 
													 WHERE p.IDR = @ID AND p.Estatus IN('CONCLUIDO') AND m.Clave IN('POS.TCM','POS.CTCM'))
								END
        
							IF @MovClave IN ('POS.TRM','POS.CTRM' ) AND @Ok IS NULL
								BEGIN
									IF EXISTS (SELECT * FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS' 
											   WHERE p.IDR = @ID AND p.Estatus IN('CONCLUIDO') AND m.Clave IN('POS.TRM','POS.CTRM'))
										UPDATE POSL SET Estatus = 'TRASPASADO' 
										WHERE ID IN (SELECT ID FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS' 
													  WHERE p.IDR = @ID AND p.Estatus IN('CONCLUIDO') AND m.Clave IN('POS.CTCRC','POS.TCRC'))
								END          
						END
 
					IF @MovClave IN ('POS.CC','POS.CCM')AND @Ok IS NULL
						BEGIN
							IF EXISTS(SELECT * FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov  AND m.Modulo = 'POS' 
									  WHERE p.IDR = @ID AND m.Clave IN ('POS.FTE','POS.STE') AND p.Estatus = 'CONCLUIDO')
								BEGIN 
									DECLARE crFaltanteSobrante CURSOR FOR   
									SELECT p.Empresa, p.Modulo, p.Sucursal, p.Usuario, p.ID, p.Host, p.Mov
									FROM POSL p
									INNER JOIN MovTipo mt ON p.Mov = mt.Mov  AND mt.Modulo = 'POS'AND mt.Clave IN ('POS.FTE','POS.STE')
									WHERE p.Estatus IN ('CONCLUIDO') AND p.IDR = @ID
									ORDER BY FechaRegistro
			
									OPEN crFaltanteSobrante
									FETCH NEXT FROM crFaltanteSobrante INTO @Empresa2, @Modulo2, @Sucursal2, @Usuario2, @ID2, @Host2, @Mov2
									WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
										BEGIN  
											EXEC spPOSAfectar @Empresa2, @Modulo2, @Sucursal2, @Usuario2, @ID2, @Host2, @Ok OUTPUT, @OkRef OUTPUT
											
											IF @Ok IS NOT NULL 
												SELECT @MovAfectar = @Mov2,  @ID = @ID2
       
											IF @Ok IS NULL
												UPDATE POSL Set Estatus = 'TRASPASADO' WHERE ID = @ID2
           
											FETCH NEXT FROM crFaltanteSobrante INTO @Empresa2, @Modulo2, @Sucursal2, @Usuario2, @ID2, @Host2, @Mov2
										END
									CLOSE crFaltanteSobrante
									DEALLOCATE crFaltanteSobrante  
          
									IF @Ok IS NULL 
										EXEC spPOSAfectar @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Ok OUTPUT, @OkRef OUTPUT
          
									IF @Ok IS NOT NULL 
										SELECT @MovAfectar = @Mov
								END  
							ELSE
								BEGIN
									EXEC spPOSAfectar @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Ok OUTPUT, @OkRef OUTPUT
					
									IF @Ok IS NOT NULL 
										SELECT @MovAfectar = @Mov
								END   
						END
      
					IF @Ok BETWEEN 80030 AND 81000
						SET @Ok = NULL        
        
					IF @Ok IS NULL
						UPDATE POSL Set Estatus = 'TRASPASADO' WHERE ID = @ID
				END
    
			FETCH NEXT FROM crPOSL INTO @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Mov
		END
	CLOSE crPOSL
	DEALLOCATE crPOSL 
  
	IF @Ok IS NULL
		COMMIT TRAN
	ELSE 
		ROLLBACK TRAN  

	IF @Ok IS NOT NULL
		SELECT @OkRef = Descripcion +' '+ISNULL(@OkRef,'')
		FROM MensajeLista WHERE Mensaje = @Ok
    
	IF @Ok IS NOT NULL
		SELECT @Ok, @OkRef, @Modulo, @ID, @MovAfectar
END
GO


/************************ spPOSAfectarPOSLSuc *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAfectarPOSLSuc') AND type = 'P') DROP PROCEDURE dbo.spPOSAfectarPOSLSuc
GO 
CREATE PROCEDURE spPOSAfectarPOSLSuc
	@SucursalT		int,
    @Debugg			bit = 0      
--//WITH ENCRYPTION
AS 
BEGIN 
	DECLARE 
	@Empresa			varchar(5),
    @Modulo				varchar(5),
    @Sucursal			int,
    @Usuario			varchar(10),
    @Host               varchar(20),
    @ID					varchar(36),   
    @Empresa2			varchar(5),
    @Modulo2			varchar(5),
    @Sucursal2          int,
    @Usuario2			varchar(10),
    @Host2				varchar(20),
    @ID2                varchar(36),        
    @Ok					int,
    @OkRef				varchar(255),
    @Mov				varchar(20),
    @Mov2				varchar(20),
    @MovClave			varchar(20),
    @MovAfectar			varchar(20),
    @Cuerpo				varchar(200),  
    @Asunto				varchar(100),
    @EnviaCorreo		bit,
    @Remitente			varchar(255),
    @Perfil				varchar(20),
    @IDError            varchar(36),
    @Cajero				varchar(10),
    @FechaEmision		datetime, 
    @FechaRegistro		datetime,
    @Caja				varchar(10),
    @Ok2				int,
    @OkRef2				varchar(255),
    @Trans1				varchar(255),
    @Trans2				varchar(255),
    @Contador			int
    
	
	SELECT @Contador = 0             
             
	SET TRANSACTION ISOLATION LEVEL Read UnCommitted  
    
	SELECT @EnviaCorreo = EnviaCorreo, @Perfil = Perfil, @Remitente = NULLIF(Remitente,'') 
	FROM Sucursal 
	WHERE Sucursal = @SucursalT
    
	DECLARE @POSLM TABLE(RID			int	identity(1,1)	NOT NULL,
						 Empresa		char(5)		NULL,
						 Modulo			varchar(5)	NULL,
						 Sucursal		int			NULL,
						 Usuario		varchar(10)	NULL,
						 ID				varchar(36)	NULL,
						 Host			varchar(20)	NULL,
						 Mov			varchar(20)	NULL, 
						 Cajero			varchar(10) NULL, 
						 FechaEmision	datetime	NULL, 
						 FechaRegistro	datetime	NULL, 
						 Caja			varchar(10) NULL)  
    
	DELETE @POSLM  
    
	INSERT INTO @POSLM(
		Empresa, Modulo, Sucursal, Usuario, ID, Host, Mov, Cajero, FechaEmision, FechaRegistro, Caja)  
	SELECT 
		p.Empresa, p.Modulo, p.Sucursal, p.Usuario, p.ID, p.Host, p.Mov, p.Cajero, p.FechaEmision, p.FechaRegistro, p.Caja 
    FROM POSL p 
	INNER JOIN MovTipo mt ON p.Mov = mt.Mov
    AND mt.Modulo = 'POS'                  
	WHERE p.Estatus IN ('CONCLUIDO') AND p.Sucursal = @SucursalT
	ORDER BY p.FechaRegistro
  
	DECLARE crPOSL CURSOR LOCAL FOR               
	SELECT Empresa,Modulo,Sucursal,Usuario,ID,Host,Mov, Cajero, FechaEmision, FechaRegistro, Caja
      FROM @POSLM  
	
	OPEN crPOSL
	FETCH NEXT FROM crPOSL INTO @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Mov, @Cajero, @FechaEmision, @FechaRegistro, @Caja
	WHILE @@FETCH_STATUS <> -1 
		BEGIN 
			IF @@FETCH_STATUS <> -2 
				BEGIN 
					SELECT @IDError = @ID, @Ok = NULL, @OkRef = NULL, @Ok2 = NULL, @OkRef2 = NULL, @Contador = @Contador + 1

					SELECT @MovClave = Clave FROM MovTipo WHERE Mov = @Mov AND Modulo = 'POS'

					--INICIA SECCIÓN DE VALIDACIONES	  
					IF @MovClave IN ('POS.AC', 'POS.ACM') 
						BEGIN 
							IF EXISTS (	SELECT TOP 1 * 
										FROM POSL p WITH (NOLOCK)
										INNER JOIN MovTipo mt WITH (NOLOCK) ON p.Mov = mt.Mov AND mt.Modulo = 'POS'
										WHERE p.Usuario = @Usuario 
										AND p.Cajero = @Cajero
										AND p.Host = @Host
										AND p.Empresa = @Empresa
										AND p.Sucursal = @Sucursal 
										AND p.Estatus = 'CONCLUIDO'
										AND mt.Clave IN ('POS.CC', 'POS.CCM')
										AND p.FechaEmision <= @FechaEmision
										AND p.FechaRegistro <= @FechaRegistro
										ORDER BY FechaRegistro DESC )
      							SELECT @Ok2 = 10001, @OkRef2 = 'No se puede traspasar la Apertura existe un Corte Caja Pendiente'
						END
	  
					IF @MovClave NOT IN ('POS.FTE','POS.STE','POS.CC','POS.CCM','POS.TCAC','POS.CTCAC','POS.CTCRC','POS.TCRC', 'POS.AC', 'POS.ACM') AND @Ok2 IS NULL
						BEGIN 
							IF EXISTS (	SELECT TOP 1 * 
										FROM POSL p WITH (NOLOCK)
										INNER JOIN MovTipo mt WITH (NOLOCK) ON p.Mov = mt.Mov AND mt.Modulo = 'POS'
										WHERE p.Usuario = @Usuario 
										AND p.Cajero = @Cajero
										AND p.Host = @Host
										AND p.Empresa = @Empresa
										AND p.Sucursal = @Sucursal 
										AND p.Estatus = 'CONCLUIDO'
										AND mt.Clave IN ('POS.AC', 'POS.ACM')
										AND p.FechaEmision <= @FechaEmision
										AND p.FechaRegistro <= @FechaRegistro
										ORDER BY FechaRegistro DESC )
      							SELECT @Ok2 = 10001, @OkRef2 = 'No se puede traspasar las Ventas existe un Apertura Caja Pendiente'
						END 

					IF @MovClave IN ('POS.CC', 'POS.CCM') AND @Ok2 IS NULL
						BEGIN 
							IF EXISTS (	SELECT TOP 1 * 
										FROM POSL p WITH (NOLOCK)
										INNER JOIN MovTipo mt WITH (NOLOCK) ON p.Mov = mt.Mov AND mt.Modulo = 'POS'
										WHERE p.Usuario = @Usuario 
										AND p.Cajero = @Cajero
										AND p.Host = @Host
										AND p.Empresa = @Empresa
										AND p.Sucursal = @Sucursal 
										AND p.Estatus = 'CONCLUIDO'
										AND mt.Clave NOT IN ('POS.FTE','POS.STE','POS.CC','POS.CCM','POS.TCAC','POS.CTCAC','POS.CTCRC','POS.TCRC')
										AND p.FechaEmision <= @FechaEmision
										AND p.FechaRegistro <= @FechaRegistro
										ORDER BY FechaRegistro DESC )
      							SELECT @Ok2 = 10001, @OkRef2 = 'No se puede traspasar el Corte Caja existen Ventas Pendientes' 
      	  
							IF @Ok2 IS NULL AND (SELECT EsConcentradora FROM CtaDinero WHERE CtaDinero = @Caja) = 1
								BEGIN
									IF EXISTS (	SELECT TOP 1 * 
												FROM POSL p WITH (NOLOCK) 
												WHERE p.Empresa = @Empresa
												AND p.Sucursal = @SucursalT 
												AND p.Estatus = 'CONCLUIDO'  
												AND p.FechaEmision <= @FechaEmision
												AND p.FechaRegistro <= @FechaRegistro
												ORDER BY FechaRegistro DESC )
										SELECT @Ok2 = 10001, @OkRef2 = 'No se puede traspasar el Corte Caja Concetradora existen Operaciones Pendientes' 
								END
     
						END 

					IF @Ok2 IS NOT NULL
						BEGIN 
							SELECT @OkRef2 = Descripcion +', '+ @OkRef2 
							FROM MensajeLista 
							WHERE Mensaje = @Ok2 		
						
							IF @Debugg = 1  
								SELECT @Ok2, @OkRef2, @IDError, @Mov
	    
							IF @EnviaCorreo = 1 AND @Perfil IS NOT NULL AND @Remitente IS NOT NULL
								BEGIN 
									SELECT  @Asunto = 'ERROR ' + convert(varchar,@Ok2), @Cuerpo  = convert(varchar,@Ok2) + ', ' + @OkRef2 + ', ' + @IDError + ', ' + @Mov
	  
									EXEC  msdb.dbo.sp_send_dbmail  @profile_name     = @Perfil     
											   				      ,@recipients       = @Remitente
																  ,@body             =  @Cuerpo  
																  ,@subject          =  @Asunto          
								END 
	       
							IF @EnviaCorreo = 0 
								BEGIN 
									SELECT @Cuerpo  = convert(varchar,@Ok2) + ', ' + @OkRef2 + ', ' + @IDError + ', ' + @Mov
		
									IF NOT EXISTS (SELECT * FROM POSJobErrores WHERE Sucursal = @SucursalT AND IDPos = @IDError)
										INSERT INTO POSJobErrores (
											Sucursal, IDPos, Error, Atendido)
										VALUES (
											@SucursalT,	@IDError, @Cuerpo, 0)
									ELSE
										UPDATE POSJobErrores SET Error = @Cuerpo WHERE Sucursal = @SucursalT AND IDPos = @IDError
								END 
						END 
					ELSE 
						SELECT @Trans1 = 'POS1'+@ID , @Trans2 = 'POS2'+@ID 

					--TERMINA SECCIÓN DE VALIDACIONES
					IF @MovClave NOT IN ('POS.FTE','POS.STE','POS.CC','POS.CCM','POS.TCAC','POS.CTCAC','POS.CTCRC','POS.TCRC') AND @Ok2 IS NULL
						BEGIN 
							BEGIN TRAN @Trans1

							EXEC spPOSAfectar @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Ok OUTPUT, @OkRef OUTPUT
        
							IF @Ok IS NOT NULL 
								SELECT @MovAfectar = @Mov
        
							IF @MovClave IN ('POS.TCM','POS.CTCM') AND @Ok IS NULL
								BEGIN
									IF EXISTS (SELECT * FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS' 
											   WHERE p.IDR = @ID AND p.Estatus IN('CONCLUIDO') AND m.Clave IN('POS.TCM','POS.CTCM'))
										UPDATE POSL SET Estatus = 'TRASPASADO' 
										WHERE ID IN (SELECT ID FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS' 
													 WHERE p.IDR = @ID AND p.Estatus IN('CONCLUIDO') AND m.Clave IN('POS.TCM','POS.CTCM'))
								END
        
							IF @MovClave IN ('POS.TRM','POS.CTRM' ) AND @Ok IS NULL
								BEGIN
									IF EXISTS (SELECT * FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS'   
											   WHERE p.IDR = @ID AND p.Estatus IN('CONCLUIDO') AND m.Clave IN('POS.TRM','POS.CTRM'))
										UPDATE POSL SET Estatus = 'TRASPASADO' 
										WHERE ID IN (SELECT ID FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS'   
													 WHERE p.IDR = @ID AND p.Estatus IN('CONCLUIDO') AND m.Clave IN('POS.CTCRC','POS.TCRC'))
								END

							IF @Ok BETWEEN 80030 AND 81000 
								SET @Ok = NULL
		
							IF @Ok IS NULL
								BEGIN
									UPDATE POSL Set Estatus = 'TRASPASADO' WHERE ID = @ID
									COMMIT TRAN @Trans1
								END
							ELSE
								BEGIN
									ROLLBACK TRAN @Trans1
									
									SELECT @OkRef = Descripcion +' '+ISNULL(@OkRef,'') 
									FROM MensajeLista 
									WHERE Mensaje = @Ok
									
									IF @Debugg = 1 
										SELECT @Ok, @OkRef, @Modulo, @IDError, @MovAfectar
		
									SELECT @OkRef = Descripcion +' '+ISNULL(@OkRef,'') 
									FROM MensajeLista 
									WHERE Mensaje = @Ok
		
									IF @EnviaCorreo = 1 AND @Perfil IS NOT NULL AND @Remitente IS NOT NULL
										BEGIN
											SELECT @Asunto = 'ERROR ' + convert(varchar,@Ok), @Cuerpo  = convert(varchar,@Ok) + ', ' + 
												@OkRef + ', ' + @Modulo + ', ' + @IDError + ', ' + @MovAfectar
											EXEC  msdb.dbo.sp_send_dbmail @profile_name = @Perfil, @recipients = @Remitente, @body = @Cuerpo, 
												@subject =  @Asunto
										END
		
									IF @EnviaCorreo = 0
										BEGIN
											SELECT @Cuerpo  = convert(varchar,@Ok) + ', ' + @OkRef + ', ' + @Modulo + ', ' + @IDError + ', ' + @MovAfectar
						
											IF NOT EXISTS (SELECT * FROM POSJobErrores WHERE Sucursal = @SucursalT AND IDPos = @IDError)
												INSERT INTO POSJobErrores (
													Sucursal, IDPos, Error, Atendido)
												VALUES (
													@SucursalT,	@IDError, @Cuerpo, 0)
											ELSE
												UPDATE POSJobErrores SET Error = @Cuerpo WHERE Sucursal = @SucursalT AND IDPos = @IDError
										END
								END
						END

					IF @MovClave IN ('POS.CC','POS.CCM')AND @Ok2 IS NULL
						BEGIN 
							BEGIN TRAN @Trans2
							
							IF  EXISTS( SELECT * FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov  AND m.Modulo = 'POS' 
										WHERE p.IDR = @ID AND m.Clave IN ('POS.FTE','POS.STE') AND p.Estatus = 'CONCLUIDO')
								BEGIN 
									DECLARE crFaltanteSobrante CURSOR FOR   
									SELECT p.Empresa, p.Modulo, p.Sucursal, p.Usuario, p.ID, p.Host, p.Mov
									FROM POSL p
									INNER JOIN MovTipo mt ON p.Mov = mt.Mov  AND mt.Modulo = 'POS'AND mt.Clave IN ('POS.FTE','POS.STE')
									WHERE p.Estatus IN ('CONCLUIDO') AND p.IDR = @ID
									ORDER BY FechaRegistro
					
									OPEN crFaltanteSobrante
									FETCH NEXT FROM crFaltanteSobrante INTO @Empresa2, @Modulo2, @Sucursal2, @Usuario2, @ID2, @Host2, @Mov2
									WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
										BEGIN 
											IF @Ok IS NOT NULL 
												SELECT @MovAfectar = @Mov2,  @ID = @ID2
       
											SELECT @Ok = NULL, @OkRef = NULL
											
											IF @Ok IS NULL      
												UPDATE POSL Set Estatus = 'TRASPASADO' WHERE ID = @ID2
           
											FETCH NEXT FROM crFaltanteSobrante INTO @Empresa2, @Modulo2, @Sucursal2, @Usuario2, @ID2, @Host2, @Mov2
										END
									CLOSE crFaltanteSobrante
									DEALLOCATE crFaltanteSobrante  
          
									IF @Ok IS NULL 
										EXEC spPOSAfectar @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Ok OUTPUT, @OkRef OUTPUT
          
									IF @Ok IS NOT NULL 
										SELECT @MovAfectar = @Mov
								END
							ELSE
								BEGIN
									EXEC spPOSAfectar @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Ok OUTPUT, @OkRef OUTPUT
					
									IF @Ok IS NOT NULL 
										SELECT @MovAfectar = @Mov
								END
		
							IF @Ok BETWEEN 80030 AND 81000 
								SET @Ok = NULL
			
							IF @Ok IS NULL
								BEGIN
									UPDATE POSL Set Estatus = 'TRASPASADO' WHERE ID = @ID
									COMMIT TRAN @Trans2
								END
							ELSE
								BEGIN
									ROLLBACK TRAN @Trans2
									
									SELECT @OkRef = Descripcion +' '+ISNULL(@OkRef,'') 
									FROM MensajeLista 
									WHERE Mensaje = @Ok
		
									IF @Debugg = 1 
										SELECT @Ok, @OkRef, @Modulo, @IDError, @MovAfectar
		
									SELECT @OkRef = Descripcion +' '+ISNULL(@OkRef,'') 
									FROM MensajeLista 
									WHERE Mensaje = @Ok
		
									IF @EnviaCorreo = 1 AND @Perfil IS NOT NULL AND @Remitente IS NOT NULL
										BEGIN
											SELECT @Asunto = 'ERROR ' + convert(varchar,@Ok), @Cuerpo = convert(varchar,@Ok) + ', ' + 
												@OkRef + ', ' + @Modulo + ', ' + @IDError + ', ' + @MovAfectar
											EXEC msdb.dbo.sp_send_dbmail @profile_name = @Perfil, @recipients = @Remitente, 
												@body =  @Cuerpo, @subject = @Asunto
										END
		
									IF @EnviaCorreo = 0
										BEGIN
											SELECT @Cuerpo  = convert(varchar,@Ok) + ', ' + @OkRef + ', ' + @Modulo + ', ' + @IDError + ', ' + @MovAfectar
							
											IF NOT EXISTS (SELECT * FROM POSJobErrores WHERE Sucursal = @SucursalT AND IDPos = @IDError)
												INSERT INTO POSJobErrores (
													Sucursal, IDPos, Error,	Atendido)
												VALUES (
													@SucursalT,	@IDError, @Cuerpo, 0)
											ELSE
												UPDATE POSJobErrores SET Error = @Cuerpo WHERE Sucursal = @SucursalT AND IDPos = @IDError
										END
								END
						END
				END
    
			FETCH NEXT FROM crPOSL INTO @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Mov, @Cajero, @FechaEmision, @FechaRegistro, @Caja
		END 
	CLOSE crPOSL
	DEALLOCATE crPOSL
    
	SET TRANSACTION ISOLATION LEVEL READ COMMITTED     
END 
GO


/************************ spPOSSVerConcentradoFormaPago *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSSVerConcentradoFormaPago') AND type = 'P') DROP PROCEDURE dbo.spPOSSVerConcentradoFormaPago
GO             
CREATE PROCEDURE spPOSSVerConcentradoFormaPago
	@Empresa		varchar(5)
--//WITH ENCRYPTION    	     
AS 
BEGIN
	SELECT 
		p.CtaDinero,
		pc.FormaPago,
		Importe = SUM(pc.Importe),
		ComisionPorcentaje = MAX(fpd.Descuento),
		Comision = SUM(pc.Importe) - (SUM(pc.Importe) * (MAX(fpd.Descuento)/100)),
		IVA = SUM(pc.Importe) - (SUM(pc.Importe) * (MAX(fpd.Descuento)/100)) * (MAX(eg.DefImpuesto) / 100)
	FROM POSL p
	INNER JOIN POSLCobro pc ON p.ID = pc.ID
	LEFT OUTER JOIN FormaPagoDesc fpd ON fpd.FormaPago = pc.FormaPago
	LEFT OUTER JOIN EmpresaGral eg ON eg.Empresa = @Empresa
	WHERE p.Empresa = @Empresa
	GROUP BY p.CtaDinero, pc.FormaPago	
   ORDER BY p.CtaDinero, pc.FormaPago
END
GO


/************************ spPOSBorrarMovimientos *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSBorrarMovimientos') AND type = 'P') DROP PROCEDURE dbo.spPOSBorrarMovimientos
GO             
CREATE PROCEDURE spPOSBorrarMovimientos
--//WITH ENCRYPTION
AS
BEGIN
	DELETE FROM POSL
	DELETE FROM POSLCobro
	DELETE FROM POSLVenta
	DELETE FROM POSVentaCobro
	DELETE FROM POSLSerieLote
	DELETE FROM POSLValidarDevolucion
	DELETE FROM POSLAuxiliar
	DELETE FROM POSLArtSeleccionado
	DELETE FROM POSLAccion
	DELETE FROM POSEstatusCaja
	DELETE FROM POSLPorCobrar
	DELETE FROM POSLPorCobrarD  
	DELETE FROM POSOfertaFormaPago
	DELETE FROM POSLDenominacion
	DELETE FROM POSFechaCierre
	DELETE FROM POSEstatusCajasCierre
	DELETE FROM POSHistMoratorios
	DELETE FROM POSValeSerie
	DELETE FROM POSLDILog
	DELETE FROM POSLDIMonedero
	DELETE FROM POSLDIMonederoSaldoFavor
	DELETE FROM POSJobErrores
	DELETE FROM POSReporteTicket

	UPDATE POSC SET Consecutivo = 0
END
GO


/**************** spFormaPagoTCPOS ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spFormaPagoTCPOS') and type = 'P') DROP PROCEDURE dbo.spFormaPagoTCPOS
GO             
CREATE PROCEDURE spFormaPagoTCPOS
	@FormaPago		varchar(50),
	@Empresa		varchar(5),
	@Importe		money 	OUTPUT,
	@Moneda			char(10) 	= NULL,
	@TipoCambio		float 		= 1.0
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @FormaPagoMoneda		char(10),	  
    @RedondeoMonetarios		int,
    @POSMonedaAct			bit
	  
	SELECT @POSMonedaAct = POSMonedaAct 
	FROM POSCfg 
	WHERE Empresa = @Empresa	  
  
	SELECT @FormaPagoMoneda = CASE WHEN @POSMonedaAct = 0 
									  THEN Moneda 
								   ELSE POSMoneda 
								   END
    FROM FormaPago
	WHERE FormaPago = @FormaPago
	  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)	
	SELECT @TipoCambio = ROUND(@TipoCambio,@RedondeoMonetarios)
	SELECT @Importe = ROUND(ISNULL(@Importe, 0.0),@RedondeoMonetarios), @FormaPago = NULLIF(RTRIM(@FormaPago), '')
  
	IF @Importe = 0.0 OR @FormaPago IS NULL 
		RETURN

    SELECT @Importe = @Importe * @TipoCambio
    SELECT @Importe = ROUND(@Importe,@RedondeoMonetarios)	

	RETURN
END
GO


/**************** spVentaCobroTotalPOS ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spVentaCobroTotalPOS') and type = 'P') DROP PROCEDURE dbo.spVentaCobroTotalPOS
GO             
CREATE PROCEDURE spVentaCobroTotalPOS
	@Empresa            varchar(5),
	@FormaCobro1		varchar(50),
	@FormaCobro2 		varchar(50),
	@FormaCobro3 		varchar(50),   
	@FormaCobro4 		varchar(50),
	@FormaCobro5 		varchar(50),
	@Importe1			money,
	@Importe2			money,
	@Importe3			money,
	@Importe4			money,
	@Importe5			money,
	@Total				money	OUTPUT,
	@VerResultado		bit	 = 0,
	@Moneda				char(10) = NULL,
	@TipoCambio1		float    = 1.0,
	@TipoCambio2		float    = 1.0,
	@TipoCambio3		float    = 1.0,
	@TipoCambio4		float    = 1.0,
	@TipoCambio5		float    = 1.0
--//WITH ENCRYPTION
AS 
BEGIN
	EXEC spFormaPagoTCPOS @FormaCobro1, @Empresa, @Importe1 OUTPUT, @Moneda, @TipoCambio1
	EXEC spFormaPagoTCPOS @FormaCobro2, @Empresa, @Importe2 OUTPUT, @Moneda, @TipoCambio2
	EXEC spFormaPagoTCPOS @FormaCobro3, @Empresa, @Importe3 OUTPUT, @Moneda, @TipoCambio3
	EXEC spFormaPagoTCPOS @FormaCobro4, @Empresa, @Importe4 OUTPUT, @Moneda, @TipoCambio4
	EXEC spFormaPagoTCPOS @FormaCobro5, @Empresa, @Importe5 OUTPUT, @Moneda, @TipoCambio5

	SELECT @Total = ((@Importe1) + (@Importe2) + (@Importe3) + (@Importe4) + (@Importe5)) 
	
	IF @VerResultado = 1 
		SELECT "Total" = @Total
	
	RETURN
END
GO


/**************** spFormaPagoMonTCPOS ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spFormaPagoMonTCPOS') and type = 'P') DROP PROCEDURE dbo.spFormaPagoMonTCPOS
GO             
CREATE PROCEDURE spFormaPagoMonTCPOS
	@FormaPago			varchar(50),
	@Referencia			varchar(50),
	@Moneda				char(10),
	@TipoCambio			float,
	@Importe			money,
	@SumaEfectivo		money		OUTPUT,
	@FormaMoneda 		char(10)	OUTPUT,
	@FormaTipoCambio	float		OUTPUT,
	@Ok					int			OUTPUT,
	@FormaCobroVales	varchar(50)	= NULL,
	@Empresa			varchar(5) = NULL		
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @MonedaEsp				char(10),
    @RequiereReferencia		bit,
    @PermiteCambio			bit,
    @POSMonedaAct			bit,
    @ContMoneda				varchar(10)

	SELECT @POSMonedaAct = POSMonedaAct 
	FROM POSCfg 
	WHERE Empresa = @Empresa
	
	SELECT @ContMoneda = RTRIM(ContMoneda) 
	FROM EmpresaCfg 
	WHERE Empresa = @Empresa
	
	SELECT @FormaMoneda = @Moneda, @FormaTipoCambio = @TipoCambio
  
	IF @POSMonedaAct = 1 AND @FormaMoneda <> @ContMoneda 
		SELECT @FormaMoneda = @ContMoneda
  
	IF NULLIF(RTRIM(@FormaPago), '') IS NULL 
		RETURN

	SELECT @MonedaEsp = NULL
	SELECT	@MonedaEsp = CASE WHEN @POSMonedaAct = 0 
								THEN NULLIF(RTRIM(Moneda), '') 
							 ELSE NULLIF(RTRIM(POSMoneda), '') 
							 END,
			@RequiereReferencia = ISNULL(RequiereReferencia, 0),
			@PermiteCambio      = ISNULL(PermiteCambio, 0)
    FROM FormaPago 
	WHERE FormaPago = @FormaPago

	IF @RequiereReferencia = 1 AND NULLIF(RTRIM(@Referencia), '') IS NULL 
		SELECT @Ok = 20910
  
	IF @MonedaEsp IS NOT NULL
		BEGIN    
			SELECT @Importe = @Importe * @FormaTipoCambio
		END
  
	IF @PermiteCambio = 1 
		SELECT @SumaEfectivo = ISNULL(@SumaEfectivo, 0) + ISNULL(@Importe, 0)

	IF @FormaCobroVales IS NOT NULL AND @FormaPago = @FormaCobroVales AND @Importe < 0.0 
		SELECT @Ok = 36100

	EXEC xpValidarFormaPago @FormaPago, @Referencia, @Importe, @Ok OUTPUT
  
	RETURN
END
GO


/**************** spInvAfectarDineroPOS ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spInvAfectarDineroPOS') and type = 'P') DROP PROCEDURE dbo.spInvAfectarDineroPOS
GO             
CREATE PROCEDURE spInvAfectarDineroPOS
	@ID                	int,
	@Accion				char(20),
	@Base				char(20),	
    @Empresa	      	char(5),
    @Modulo	      		char(5),
    @Mov	  	      	char(20),
    @MovID             	varchar(20)		OUTPUT,
    @MovTipo     		char(20),
    @MovMoneda	      	char(10),
    @MovTipoCambio		float,
	@FechaEmision		datetime,
    @FechaAfectacion    datetime,
    @FechaConclusion	datetime,
    @Concepto	      	varchar(50),
    @Proyecto	      	varchar(50),
    @Usuario	      	char(10),
    @Autorizacion      	char(10),
    @Referencia	      	varchar(50),
    @DocFuente	      	int,
    @Observaciones     	varchar(255),
    @Estatus           	char(15),
	@EstatusNuevo		char(15),
    @FechaRegistro     	datetime,
    @Ejercicio	      	int,
    @Periodo	      	int,
	@ClienteProv		char(10),
	@EnviarA			int,
	@SucursalOrigen		int,       
    @Ok					int				OUTPUT,
    @OkRef				varchar(255)	OUTPUT,	
    @EsCargo        	bit				OUTPUT,
	@CtaDinero			char(10)		OUTPUT,
	@Cajero				char(10)		OUTPUT,
	@DineroMov			char(20)		OUTPUT,
	@DineroMovID		varchar(20)		OUTPUT,
	@FormaPagoCambio	varchar(50)		OUTPUT,
    @CobroCambio        money			OUTPUT, 
	@DineroImporte		money			OUTPUT,
    @CobroDelEfectivo	money			OUTPUT, 
	@CobroSumaEfectivo	money			OUTPUT,
	@Importe1			money			OUTPUT,
	@Importe2			money			OUTPUT,
	@Importe3			money			OUTPUT,
	@Importe4			money			OUTPUT,
	@Importe5			money			OUTPUT,
	@ImporteCambio		money			OUTPUT,
	@FormaCobro1		varchar(50)		OUTPUT,
	@FormaCobro2		varchar(50)		OUTPUT,
	@FormaCobro3		varchar(50)		OUTPUT,
	@FormaCobro4		varchar(50)		OUTPUT,
	@FormaCobro5		varchar(50)		OUTPUT,
	@Referencia1		varchar(50)		OUTPUT,
	@Referencia2		varchar(50)		OUTPUT,
	@Referencia3		varchar(50)		OUTPUT,
	@Referencia4		varchar(50)		OUTPUT,
	@Referencia5		varchar(50)		OUTPUT,
	@FormaMoneda		char(10)		OUTPUT,
	@FormaTipoCambio	float			OUTPUT,
	@FormaCobroVales	varchar(50)		OUTPUT,
	@TipoCambio1		float           OUTPUT,
	@TipoCambio2		float           OUTPUT,
	@TipoCambio3		float           OUTPUT,
	@TipoCambio4		float           OUTPUT,
	@TipoCambio5		float           OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@MovMonedaD	      	varchar(10),
	@POSMonedaAct		bit
  
	SELECT @POSMonedaAct = POSMonedaAct 
	FROM POSCfg 
	WHERE Empresa = @Empresa
  
	IF @CobroDelEfectivo <> 0.0 
		BEGIN
		    IF @MovTipo IN ('VTAS.VP', 'VTAS.SD') 
				SELECT @EsCargo = 0 
			ELSE 
				SELECT @EsCargo = 1
			
			IF @Accion = 'CANCELAR' SELECT @EsCargo = ~@EsCargo 
			EXEC spSaldo @SucursalOrigen, @Accion, @Empresa, @Usuario, 'CEFE', @MovMoneda, @MovTipoCambio, @ClienteProv, NULL, NULL, NULL,
                 @Modulo, @ID, @Mov, @MovID, @EsCargo, @CobroDelEfectivo, NULL, NULL,
                 @FechaAfectacion, @Ejercicio, @Periodo, 'Saldo a Favor', NULL, 0, 0, 0,
                 @Ok OUTPUT, @OkRef OUTPUT
		END

	IF @DineroImporte <> 0.0
		BEGIN
			SELECT @CobroSumaEfectivo = 0.0
			
			IF @Importe1 <> 0.0
				BEGIN     
					SELECT @MovMonedaD = CASE WHEN @POSMonedaAct = 0 
												THEN NULLIF(RTRIM(Moneda), '') 
											  ELSE NULLIF(RTRIM(POSMoneda), '') 
											  END 
					FROM FormaPago    
					WHERE FormaPago = @FormaCobro1

					SELECT @MovMonedaD = ISNULL(@MovMonedaD,@MovMoneda)
					EXEC spFormaPagoMonTCPOS @FormaCobro1, @Referencia1, @MovMonedaD, @TipoCambio1, @Importe1, 
						@CobroSumaEfectivo OUTPUT, @FormaMoneda OUTPUT, @FormaTipoCambio OUTPUT, @Ok OUTPUT, @FormaCobroVales, @Empresa
               
					EXEC spGenerarDinero @SucursalOrigen, @SucursalOrigen, @SucursalOrigen, @Accion, @Empresa, @Modulo, @ID, @Mov, @MovID, 
						@MovTipo, @FormaMoneda, @FormaTipoCambio, @FechaAfectacion, @Concepto, @Proyecto, @Usuario, @Autorizacion, @Referencia1, 
						@DocFuente, @Observaciones, 0, 0, @FechaRegistro, @Ejercicio, @Periodo, @FormaCobro1, NULL, NULL,
						@ClienteProv, @CtaDinero, @Cajero, @Importe1, NULL, NULL, NULL, NULL, @DineroMov OUTPUT, @DineroMovID OUTPUT,
						@Ok OUTPUT, @OkRef OUTPUT
				END
    
			IF @Importe2 <> 0.0
				BEGIN
					SELECT @MovMonedaD = CASE WHEN @POSMonedaAct = 0 
												THEN NULLIF(RTRIM(Moneda), '') 
											  ELSE NULLIF(RTRIM(POSMoneda), '') 
											  END 
					FROM FormaPago 
					WHERE FormaPago = @FormaCobro2
					
					EXEC spFormaPagoMonTCPOS @FormaCobro2, @Referencia2, @MovMonedaD, @TipoCambio2, @Importe2, 
						@CobroSumaEfectivo OUTPUT, @FormaMoneda OUTPUT, @FormaTipoCambio OUTPUT, @Ok OUTPUT, @FormaCobroVales, @Empresa

					EXEC spGenerarDinero @SucursalOrigen, @SucursalOrigen, @SucursalOrigen, @Accion, @Empresa, @Modulo, @ID, @Mov, @MovID, 
						@MovTipo, @FormaMoneda, @FormaTipoCambio, @FechaAfectacion, @Concepto, @Proyecto, @Usuario, @Autorizacion, @Referencia2, 
						@DocFuente, @Observaciones, 0, 0, @FechaRegistro, @Ejercicio, @Periodo, @FormaCobro2, NULL, NULL,
                        @ClienteProv, @CtaDinero, @Cajero, @Importe2, NULL, NULL, NULL, NULL, 
						@DineroMov OUTPUT, @DineroMovID OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
				END
    
			IF @Importe3 <> 0.0
				BEGIN
					SELECT @MovMonedaD = CASE WHEN @POSMonedaAct = 0 
												THEN NULLIF(RTRIM(Moneda), '') 
											  ELSE NULLIF(RTRIM(POSMoneda), '') 
											  END 
					FROM FormaPago 
					WHERE FormaPago = @FormaCobro3
      
					EXEC spFormaPagoMonTCPOS @FormaCobro3, @Referencia3, @MovMonedaD, @TipoCambio3, @Importe3, 
						@CobroSumaEfectivo OUTPUT, @FormaMoneda OUTPUT, @FormaTipoCambio OUTPUT, @Ok OUTPUT, @FormaCobroVales, @Empresa

					EXEC spGenerarDinero @SucursalOrigen, @SucursalOrigen, @SucursalOrigen, @Accion, @Empresa, @Modulo, @ID, @Mov, @MovID, @MovTipo, 
						@FormaMoneda, @FormaTipoCambio, @FechaAfectacion, @Concepto, @Proyecto, @Usuario, @Autorizacion, @Referencia3, @DocFuente, 
						@Observaciones, 0, 0, @FechaRegistro, @Ejercicio, @Periodo, @FormaCobro3, NULL, NULL,
                        @ClienteProv, @CtaDinero, @Cajero, @Importe3, NULL, NULL, NULL, NULL,
                        @DineroMov OUTPUT, @DineroMovID OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
				END

			IF @Importe4 <> 0.0
				BEGIN
					SELECT @MovMonedaD = CASE WHEN @POSMonedaAct = 0 
												THEN NULLIF(RTRIM(Moneda), '') 
											  ELSE NULLIF(RTRIM(POSMoneda), '') 
											  END 
					FROM FormaPago    
					WHERE FormaPago = @FormaCobro4

					EXEC spFormaPagoMonTCPOS @FormaCobro4, @Referencia4, @MovMonedaD, @TipoCambio4, @Importe4, 
						@CobroSumaEfectivo OUTPUT, @FormaMoneda OUTPUT, @FormaTipoCambio OUTPUT, @Ok OUTPUT, @FormaCobroVales, @Empresa

					EXEC spGenerarDinero @SucursalOrigen, @SucursalOrigen, @SucursalOrigen, @Accion, @Empresa, @Modulo, @ID, @Mov, @MovID, @MovTipo, 
						@FormaMoneda, @FormaTipoCambio, @FechaAfectacion, @Concepto, @Proyecto, @Usuario, @Autorizacion, @Referencia4, @DocFuente, 
						@Observaciones, 0, 0, @FechaRegistro, @Ejercicio, @Periodo, @FormaCobro4, NULL, NULL, 
						@ClienteProv, @CtaDinero, @Cajero, @Importe4, NULL, NULL, NULL, NULL, 
						@DineroMov OUTPUT, @DineroMovID OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
				END

			IF @Importe5 <> 0.0
				BEGIN    
					SELECT @MovMonedaD = CASE WHEN @POSMonedaAct = 0 
												THEN NULLIF(RTRIM(Moneda), '') 
											  ELSE NULLIF(RTRIM(POSMoneda), '') 
											  END 
					FROM FormaPago 
					WHERE FormaPago = @FormaCobro5
      
					EXEC spFormaPagoMonTCPOS @FormaCobro5, @Referencia5, @MovMonedaD, @TipoCambio5, @Importe5, 
						@CobroSumaEfectivo OUTPUT, @FormaMoneda OUTPUT, @FormaTipoCambio OUTPUT, @Ok OUTPUT, @FormaCobroVales, @Empresa

					EXEC spGenerarDinero @SucursalOrigen, @SucursalOrigen, @SucursalOrigen, @Accion, @Empresa, @Modulo, @ID, @Mov, @MovID, @MovTipo, 
						@FormaMoneda, @FormaTipoCambio, @FechaAfectacion, @Concepto, @Proyecto, @Usuario, @Autorizacion, @Referencia5, @DocFuente, 
						@Observaciones, 0, 0, @FechaRegistro, @Ejercicio, @Periodo, @FormaCobro5, NULL, NULL,
                        @ClienteProv, @CtaDinero, @Cajero, @Importe5, NULL, NULL, NULL, NULL,
                        @DineroMov OUTPUT, @DineroMovID OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
				END
		END
END
GO

  
/************************ spPOSMuestraVentaCobro *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSMuestraVentaCobro') AND type = 'P') DROP PROCEDURE dbo.spPOSMuestraVentaCobro
GO             
CREATE PROCEDURE spPOSMuestraVentaCobro
	@ID		varchar(36)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@String					varchar(max),
    @String2				varchar(max),
  	@VentaCobro				varchar(max),	  
	@Codigo					varchar(50),
	@FormaPago				char(50),
	@Importe				float,
	@ImporteRef				float,
	@LargoLinea				int,
	@PuntosUtilizados		float,
	@MonedaMonedero			varchar(10),
	@Monedero				varchar(20),
	@Empresa				varchar(5)
  
	SELECT @LargoLinea = 100
	SELECT @Monedero = Monedero 
	FROM POSL 
	WHERE ID = @ID
  
	IF EXISTS (SELECT * FROM POSLVenta WHERE ID = @ID HAVING SUM(Puntos)>0) AND NULLIF(@Monedero,'') IS NOT NULL
		BEGIN
			SELECT @PuntosUtilizados = ABS(SUM(Puntos)) 
			FROM POSLVenta 
			WHERE ID = @ID AND ISNULL(Puntos,0.0)> 0.0
			
			SELECT @MonedaMonedero =  Moneda 
			FROM POSValeSerie 
			WHERE Serie = @Monedero 
     
			SELECT @String2 = dbo.fnAlinearCampoValor(ISNULL(UPPER(REPLICATE(' ', 9)+' SE ABONARAN  '+CONVERT(varchar,@PuntosUtilizados)+' '+
				@MonedaMonedero+' AL MONEDERO : '), '')+ @Monedero, '<BR>', @LargoLinea)
			SELECT @String2 = @String2+ 
				'__________________________________________________________________'+'<BR>'+'__________________________________________________________________'+
				 '<BR><BR><BR>'
		END
  
	SELECT @VentaCobro = ISNULL(@String2,'')
  
	IF EXISTS(SELECT * FROM POSLCobro WHERE ID = @ID)
		SELECT @VentaCobro = ISNULL(@VentaCobro,'')+'FORMA PAGO' + SPACE(38)+RIGHT(dbo.fnAlinearDerecha('IMPORTE',12),10) + 
			SPACE(5)+RIGHT(dbo.fnAlinearDerecha('IMPORTE  M.N.',15),15) + '<BR>'+ REPLICATE('-',100)+'<BR>' 			      
	
	DECLARE crVentaCobro CURSOR LOCAL FOR
    SELECT FormaPago, SUM(ImporteRef), SUM(Importe)
    FROM POSLCobro
    WHERE ID = @ID
    GROUP BY  FormaPago
    
	OPEN crVentaCobro
	FETCH NEXT FROM crVentaCobro INTO  @FormaPago, @Importe, @ImporteRef
	WHILE @@FETCH_STATUS <> -1 
		BEGIN
			IF @@FETCH_STATUS <> -2 
				BEGIN          	  
					SELECT @String = @FormaPago + SPACE(5)+RIGHT(dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(@Importe,0.0),@Empresa),12),10) + 
						SPACE(5)+RIGHT(dbo.fnAlinearDerecha(dbo.fnFormatoMoneda(ISNULL(@ImporteRef,0.0),@Empresa),12),10) + '<BR>' 			      
					SELECT @VentaCobro = ISNULL(@VentaCobro,'') + ISNULL(@String,'')        
				END
  
			FETCH NEXT FROM crVentaCobro INTO @FormaPago, @Importe, @ImporteRef
		END
	CLOSE crVentaCobro
	DEALLOCATE crVentaCobro
  
	SELECT @VentaCobro
END
GO  


/**************** spPOSAltaMonedero ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSAltaMonedero') and type = 'P') DROP PROCEDURE dbo.spPOSAltaMonedero
GO             
CREATE PROCEDURE spPOSAltaMonedero
	@ID				varchar(36),
	@Usuario	    varchar(10),
	@Empresa        varchar(5),
	@Sucursal       int,
	@Cliente		varchar(10),
	@NoTarjeta		varchar(20),
	@Ok				int = NULL		OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@IDGenerar				varchar(36),
	@Mov					varchar(20),
	@MovID					varchar(20),
	@FechaEmision			datetime,
	@FechaRegistro			datetime, 
	@Concepto				varchar(50),
	@Proyecto				varchar(50),
	@UEN					int,
	@Moneda					varchar(10),
	@MonedaTarjeta			varchar(10),
	@TipoCambioTarjeta		float,
	@TipoCambio				float,
	@Almacen				varchar(10),
	@Agente					varchar(10),
	@Cajero					varchar(10),
	@FormaEnvio				varchar(50),
	@Condicion				varchar(50),
	@Vencimiento			varchar(50),
	@CtaDinero				varchar(10),
	@Descuento				varchar(50),
	@DescuentoGlobal		varchar(50),
	@ListaPreciosEsp		varchar(20),
	@ZonaImpuesto			varchar(50),	  
	@FormaPago				varchar(50),
	@ImagenNombreAnexo		varchar(255),
	@Host					varchar(20),
	@Cluster				varchar(20),
	@Prefijo				varchar(5),
	@Consecutivo			int,
	@noAprobacion			int,
	@fechaAprobacion		datetime,
	@OkRef					varchar(255),
	@RedondeoMonetarios		int,
	@TipoMonedero			varchar(50),
	@SugerirFechaCierre		bit,
	@FechaCierre			datetime,
	@Caja					varchar(10)
  
	SELECT @Caja = Caja 
	FROM POSL 
	WHERE ID = @ID 

	SELECT @TipoMonedero = TipoMonedero, @Mov = MovEmision
    FROM POSCfg
	WHERE Empresa = @Empresa 	  
  
	SELECT @MonedaTarjeta = Moneda 
	FROM ValeTipo 
	WHERE Tipo = @TipoMonedero
  
	SELECT @MonedaTarjeta = ISNULL(NULLIF(@MonedaTarjeta,''),@Moneda)
   
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)
  
	--DETERMINA EL HOST Y CLUSTER DE LA INSTANCIA
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT  
  
	IF @Mov IS NULL
		SELECT TOP 1  @Mov = Mov 
		FROM MovTipo 
		WHERE Modulo = 'POS' AND Clave = 'POS.ET'	
  
	SELECT 
		@CtaDinero = DefCtaDinero,	
		@Cajero = DefCajero
    FROM Usuario
	WHERE Usuario = @Usuario
   
	SELECT @SugerirFechaCierre = SugerirFechaCierre   
	FROM POSCfg 
	WHERE Empresa = @Empresa
  
	SELECT @FechaCierre = Fecha 
	FROM POSFechaCierre 
	WHERE Sucursal = @Sucursal
  
	SELECT @FechaCierre = dbo.fnPOSFechaCierre(@Empresa,@Sucursal,@FechaCierre,@Caja)

	SELECT 
		@FechaEmision = CASE WHEN @SugerirFechaCierre = 1 THEN @FechaCierre ELSE dbo.fnFechaSinHora(GETDATE())END,
		@FechaRegistro = GETDATE(),
		@Proyecto = u.DefProyecto,
		@UEN = u.UEN,
		@Almacen = ISNULL(u.DefAlmacen, c.AlmacenDef),
		@Cajero = u.DefCajero,
		@FormaEnvio = c.FormaEnvio,
		@Condicion = c.Condicion,
		@CtaDinero = u.DefCtaDinero
    FROM Usuario u
    LEFT OUTER JOIN Mon m ON u.DefMoneda = m.Moneda
    LEFT OUTER JOIN Cte c ON u.DefCliente = c.Cliente
    LEFT OUTER JOIN Sucursal s ON s.Sucursal = @Sucursal
	WHERE u.Usuario = @Usuario
   
	SELECT  @Moneda = Moneda 
	FROM POSLTipoCambioRef 
	WHERE TipoCambio = 1.0 AND Sucursal = @Sucursal  AND EsPrincipal = 1  
	
	SELECT @TipoCambio = TipoCambio 
	FROM POSLTipoCambioRef 
	WHERE Moneda = @MonedaTarjeta AND Sucursal = @Sucursal
   
	IF @TipoCambio IS NULL 
		SELECT @MonedaTarjeta = @Moneda
   
	SELECT @TipoCambio = ISNULL(@TipoCambio,1.0)
	SELECT @IDGenerar = NEWID()

	INSERT POSL (
		ID, Host, Empresa, Modulo, Sucursal, Usuario, Mov, FechaEmision, FechaRegistro, Proyecto, UEN, Moneda, TipoCambio, Cliente, 
		Almacen, Agente, Cajero, FormaEnvio, Condicion, CtaDinero, Estatus, Monedero, IDR, Cluster, Caja)
	VALUES (
		@IDGenerar, @Host, @Empresa, 'VALE', @Sucursal, @Usuario, @Mov, @FechaEmision, @FechaRegistro, @Proyecto, @UEN, @MonedaTarjeta, @TipoCambio, @Cliente, 
		@Almacen, @Agente, @Cajero, @FormaEnvio, @Condicion, @CtaDinero, 'SINAFECTAR', @NoTarjeta, @ID, @Cluster, @CtaDinero)
   
	IF @@ERROR <> 0 
		SET @Ok = 1  
   
	IF @Ok IS NULL
		EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @Mov, 
			@MovID OUTPUT, @Prefijo OUTPUT, @Consecutivo OUTPUT, @noAprobacion OUTPUT, @FechaAprobacion OUTPUT, @Ok OUTPUT, @OkRef OUTPUT

	IF @Ok IS NULL
		UPDATE POSL SET MovID = ISNULL(MovID, @MovID),
			Prefijo = ISNULL(Prefijo, @Prefijo),
			Consecutivo = ISNULL(Consecutivo, @Consecutivo),
			noAprobacion = ISNULL(noAprobacion, @NoAprobacion),
			fechaAprobacion = ISNULL(fechaAprobacion, @fechaAprobacion),
			Estatus = 'CONCLUIDO',
			FechaRegistro = @FechaRegistro         
		WHERE ID = @IDGenerar    
    
	IF @@ERROR <>0  
		SET @Ok = 1
    
	IF @Ok IS NULL AND NOT EXISTS (SELECT * FROM POSValeSerie WHERE Serie = @NoTarjeta)
		INSERT POSValeSerie (
			Serie, Sucursal, Estatus, Moneda, Tipo, Cliente)
		SELECT
			@NoTarjeta, @Sucursal, 'DISPONIBLE', @MonedaTarjeta, @TipoMonedero, @Cliente
    
	IF @Ok IS NULL AND  EXISTS (SELECT * FROM POSValeSerie WHERE Serie = @NoTarjeta AND Cliente IS NULL)
		UPDATE POSValeSerie SET Cliente = @Cliente WHERE Serie = @NoTarjeta 
        
	RETURN
END
GO


/**************** spPOSActivacionMonederoLDI ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSActivacionMonederoLDI') and type = 'P') DROP PROCEDURE dbo.spPOSActivacionMonederoLDI
GO             
CREATE PROCEDURE spPOSActivacionMonederoLDI
	@ID				varchar(36),
	@Usuario	    varchar(10),
	@Empresa        varchar(5),
	@Sucursal       int,
	@Cliente		varchar(10),
	@NoTarjeta		varchar(20),
	@Ok				int = NULL			OUTPUT,
	@OkRef			varchar(255) = NULL OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@IDGenerar				varchar(36),
	@Mov					varchar(20),
	@MovID					varchar(20),
	@FechaEmision			datetime,
	@FechaRegistro			datetime, 
	@Concepto				varchar(50),
	@Proyecto				varchar(50),
	@UEN					int,
	@Moneda					varchar(10),
	@MonedaTarjeta			varchar(10),
	@TipoCambio				float,
	@Almacen				varchar(10),
	@Agente					varchar(10),
	@Cajero					varchar(10),
	@FormaEnvio				varchar(50),
	@Condicion				varchar(50),
	@Vencimiento			varchar(50),
	@CtaDinero				varchar(10),
	@Descuento				varchar(50),
	@DescuentoGlobal		varchar(50),
	@ListaPreciosEsp		varchar(20),
	@ZonaImpuesto			varchar(50),	  
	@FormaPago				varchar(50),
	@ImagenNombreAnexo		varchar(255),
	@Host					varchar(20),
	@Cluster				varchar(20),
	@Prefijo				varchar(5),
	@Consecutivo			int,
	@noAprobacion			int,
	@fechaAprobacion		datetime,
	@RedondeoMonetarios		int,
	@TipoMonedero			varchar(50)

	SELECT @TipoMonedero = TipoMonedero, @Mov = MovActivacionLDI
    FROM POSCfg
	WHERE Empresa = @Empresa 	  
  
	SELECT @MonedaTarjeta = Moneda 
	FROM ValeTipo  
	WHERE Tipo = @TipoMonedero
  
	SELECT @MonedaTarjeta = ISNULL(NULLIF(@MonedaTarjeta,''),@Moneda)
   
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)
  
	--DETERMINA EL HOST Y CLUSTER DE LA INSTANCIA
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT  
  
	IF @Mov IS NULL
		SELECT  @Mov = Mov FROM MovTipo WHERE Modulo = 'POS' AND Clave = 'POS.ACTMLDI'	
  
	SELECT 
		@CtaDinero = DefCtaDinero,	
		@Cajero = DefCajero
    FROM Usuario
	WHERE Usuario = @Usuario
   
	SELECT 
		@FechaEmision = dbo.fnFechaSinHora(GETDATE()),
		@FechaRegistro = GETDATE(),
		@Proyecto = u.DefProyecto,
		@UEN = u.UEN,
		@Almacen = ISNULL(u.DefAlmacen, c.AlmacenDef),
		@Cajero = u.DefCajero,
		@FormaEnvio = c.FormaEnvio,
		@Condicion = c.Condicion,
		@CtaDinero = u.DefCtaDinero
	FROM Usuario u
    LEFT OUTER JOIN Mon m ON u.DefMoneda = m.Moneda
    LEFT OUTER JOIN Cte c ON u.DefCliente = c.Cliente
    LEFT OUTER JOIN Sucursal s ON s.Sucursal = @Sucursal
	WHERE u.Usuario = @Usuario
   
	SELECT  @Moneda = Moneda 
    FROM POSLTipoCambioRef 
    WHERE TipoCambio = 1.0 AND Sucursal = @Sucursal  AND EsPrincipal = 1  
   
	SELECT @TipoCambio = TipoCambio 
	FROM POSLTipoCambioRef 
	WHERE Moneda = @MonedaTarjeta AND Sucursal = @Sucursal
   
	SELECT @TipoCambio = ISNULL(@TipoCambio,1.0)
	SELECT @IDGenerar = NEWID()

	INSERT POSL (
		ID, Host, Empresa, Modulo, Sucursal, Usuario, Mov, FechaEmision, FechaRegistro, Proyecto, UEN, Moneda, TipoCambio, Cliente, Almacen, 
		Agente, Cajero, FormaEnvio, Condicion, CtaDinero, Estatus, Monedero, IDR, Cluster, Caja)
	VALUES (
		@IDGenerar, @Host, @Empresa, 'VALE', @Sucursal, @Usuario, @Mov, @FechaEmision, @FechaRegistro, @Proyecto, @UEN, @MonedaTarjeta, @TipoCambio, @Cliente, @Almacen,
		@Agente, @Cajero, @FormaEnvio, @Condicion, @CtaDinero, 'SINAFECTAR', @NoTarjeta, @ID, @Cluster, @CtaDinero)
   
	IF @@ERROR <> 0 
		SET @Ok = 1  
      
	IF @Ok IS NULL
		EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @Mov, @MovID OUTPUT, @Prefijo OUTPUT, @Consecutivo OUTPUT, 
			@noAprobacion OUTPUT, @FechaAprobacion OUTPUT, @Ok OUTPUT, @OkRef OUTPUT

	IF @Ok IS NULL
		UPDATE POSL SET MovID = ISNULL(MovID, @MovID),
			Prefijo = ISNULL(Prefijo, @Prefijo),
			Consecutivo = ISNULL(Consecutivo, @Consecutivo),
			noAprobacion = ISNULL(noAprobacion, @NoAprobacion),
			fechaAprobacion = ISNULL(fechaAprobacion, @fechaAprobacion),
			Estatus = 'CONCLUIDO',
			FechaRegistro = @FechaRegistro         
		WHERE ID = @IDGenerar    
    
	IF @@ERROR <>0  
		SET @Ok = 1
  
	RETURN
END
GO     


/**************** spPOSAbonoMonederoLDI ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSAbonoMonederoLDI') and type = 'P') DROP PROCEDURE dbo.spPOSAbonoMonederoLDI
GO             
CREATE PROCEDURE spPOSAbonoMonederoLDI
	@ID				varchar(36),
	@Usuario	    varchar(10),
	@Empresa        varchar(5),
	@Sucursal       int,
	@Cliente		varchar(10),
	@NoTarjeta		varchar(20),
	@Importe        float,
	@Ok				int = NULL			OUTPUT,
	@OkRef			varchar(255) = NULL	OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@IDGenerar				varchar(36),
	@Mov					varchar(20),
	@MovID					varchar(20),
	@FechaEmision			datetime,
	@FechaRegistro			datetime, 
	@Concepto				varchar(50),
	@Proyecto				varchar(50),
	@UEN					int,
	@Moneda					varchar(10),
	@MonedaTarjeta			varchar(10),
	@TipoCambio				float,
	@Almacen				varchar(10),
	@Agente					varchar(10),
	@Cajero					varchar(10),
	@FormaEnvio				varchar(50),
	@Condicion				varchar(50),
	@Vencimiento			varchar(50),
	@CtaDinero				varchar(10),
	@Descuento				varchar(50),
	@DescuentoGlobal		varchar(50),
	@ListaPreciosEsp		varchar(20),
	@ZonaImpuesto			varchar(50),	  
	@FormaPago				varchar(50),
	@ImagenNombreAnexo		varchar(255),
	@Host					varchar(20),
	@Cluster				varchar(20),
	@Prefijo				varchar(5),
	@Consecutivo			int,
	@noAprobacion			int,
	@fechaAprobacion		datetime,
	@RedondeoMonetarios		int,
	@TipoMonedero			varchar(50)

	SELECT @TipoMonedero = TipoMonedero, @Mov = MovAbonoLDI
    FROM POSCfg
	WHERE Empresa = @Empresa 	  
	
	SELECT @MonedaTarjeta = Moneda 
	FROM ValeTipo 
	WHERE Tipo = @TipoMonedero
  
	SELECT @MonedaTarjeta = ISNULL(NULLIF(@MonedaTarjeta,''),@Moneda)
   
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)
  
	--DETERMINA EL HOST Y CLUSTER DE LA INSTANCIA
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT  
  
	IF @Mov IS NULL
		SELECT  @Mov = Mov 
		FROM MovTipo 
		WHERE Modulo = 'POS' AND Clave = 'POS.AMLDI'	
  
	SELECT 
		@CtaDinero = DefCtaDinero,	
		@Cajero = DefCajero
    FROM Usuario
	WHERE Usuario = @Usuario
   
	SELECT 
		@FechaEmision = dbo.fnFechaSinHora(GETDATE()),
		@FechaRegistro = GETDATE(),
		@Proyecto = u.DefProyecto,
		@UEN = u.UEN,
		@Almacen = ISNULL(u.DefAlmacen, c.AlmacenDef),
		@Cajero = u.DefCajero,
		@FormaEnvio = c.FormaEnvio,
		@Condicion = c.Condicion,
		@CtaDinero = u.DefCtaDinero
	FROM Usuario u
    LEFT OUTER JOIN Mon m ON u.DefMoneda = m.Moneda
    LEFT OUTER JOIN Cte c ON u.DefCliente = c.Cliente
    LEFT OUTER JOIN Sucursal s ON s.Sucursal = @Sucursal
	WHERE u.Usuario = @Usuario
   
	SELECT @Moneda = Moneda 
    FROM POSLTipoCambioRef 
    WHERE TipoCambio = 1.0 AND Sucursal = @Sucursal  AND EsPrincipal = 1  
   
	SELECT @TipoCambio = TipoCambio 
	FROM POSLTipoCambioRef 
	WHERE Moneda = @MonedaTarjeta AND Sucursal = @Sucursal
	
	SELECT @TipoCambio = ISNULL(@TipoCambio,1.0)
	SELECT @IDGenerar = NEWID()

	INSERT POSL (
		ID, Host, Empresa, Modulo, Sucursal, Usuario, Mov, FechaEmision, FechaRegistro, Proyecto, UEN, Moneda, TipoCambio, Cliente, Almacen, Agente, 
		Cajero, FormaEnvio, Condicion, CtaDinero, Estatus, Monedero, IDR, Cluster, Caja, Importe)
	VALUES (
		@IDGenerar, @Host, @Empresa, 'VALE', @Sucursal, @Usuario, @Mov, @FechaEmision, @FechaRegistro, @Proyecto, @UEN, @MonedaTarjeta, @TipoCambio, @Cliente, @Almacen,
		@Agente, @Cajero, @FormaEnvio, @Condicion, @CtaDinero, 'SINAFECTAR', @NoTarjeta, @ID, @Cluster, @CtaDinero, @Importe)
   
	IF @@ERROR <> 0 
		SET @Ok = 1  
      
	IF @Ok IS NULL
		EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @Mov, @MovID OUTPUT, @Prefijo OUTPUT, @Consecutivo OUTPUT, @noAprobacion OUTPUT, 
			@FechaAprobacion OUTPUT, @Ok OUTPUT, @OkRef OUTPUT

	IF @Ok IS NULL
		UPDATE POSL SET MovID = ISNULL(MovID, @MovID),
			Prefijo = ISNULL(Prefijo, @Prefijo),
			Consecutivo = ISNULL(Consecutivo, @Consecutivo),
			noAprobacion = ISNULL(noAprobacion, @NoAprobacion),
			fechaAprobacion = ISNULL(fechaAprobacion, @fechaAprobacion),
			Estatus = 'CONCLUIDO',
			FechaRegistro = @FechaRegistro         
		WHERE ID = @IDGenerar    
    
	IF @@ERROR <>0  
		SET @Ok = 1
  
	RETURN
END
GO  


/**************** spPOSVentaMonedero ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSVentaMonedero') and type = 'P') DROP PROCEDURE dbo.spPOSVentaMonedero
GO
CREATE PROCEDURE spPOSVentaMonedero
	@Empresa			char(5),
	@ID					varchar(36),
	@Accion				char(20),
	@FechaEmision		datetime,
	@Usuario			char(10),
	@Sucursal			int,
	@MovMoneda			char(10),
	@MovTipoCambio		float,
	@Tarjeta			varchar(20),
	@Ok 				int 			OUTPUT,
	@OkRef 				varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
	DECLARE 
    @OFER							bit,
    @CfgVentaPuntosArtCat			bit,
	@Renglon						float,
	@RenglonTarjeta					float,
	@RenglonID						int,
	@RenglonTipo					varchar(1),
	@Articulo						varchar(20),
	@Categoria						varchar(50),
	@Precio							money,
	@Impuesto1						float,
	@DescuentoGlobal				float,
	@DescuentoLinea					float,
	@Porcentaje						float,
	@Continuar						bit,
	@VentaPreciosImpuestoIncluido 	bit,
	@Factor							int,
	@Cargo							money,
	@EsCancelacion					bit,
	@TarjetaMoneda					char(10),
	@TarjetaTipoCambio				float,
	@FactorMoneda					float,
	@Total							money,
	@TotalCargo						money,
	@CantidadVenta                  float,
	@Servicio                       varchar(20),
	@ArtTarjeta                     varchar(20),
	@Importe                        float,
	@OKRefLDI                       varchar(500),
	@MonederoLDI                    bit,
	@PrecioImpuestoInc              float,
	@MovClave                       varchar(20),
	@MovSubClave                    varchar(20)
	
	SELECT @MovClave = m.Clave, @MovSubClave = m.SubClave 
	FROM MovTipo m JOIN POSL p ON m.Mov = p.Mov AND m.Modulo = 'POS' 
	WHERE  p.ID = @ID
	
	SELECT @Total = 0, @Cargo = 0, @Porcentaje = 0

	SELECT @OFER = OFER 
    FROM EmpresaGral
	WHERE Empresa = @Empresa

	SELECT @MonederoLDI = ISNULL(MonederoLDI,0) 
	FROM POSCfg 
	WHERE Empresa = @Empresa
	
	SELECT @CfgVentaPuntosArtCat = ISNULL(VentaPuntosArtCat, 0) 	
    FROM EmpresaCfg2
	WHERE Empresa = @Empresa
   
	SELECT  @ArtTarjeta = ec.CxcArticuloTarjetasDef 
    FROM EmpresaCfg ec	  
	WHERE ec.Empresa = @Empresa

	IF NOT EXISTS(SELECT * FROM POSValeSerie WHERE Serie = @Tarjeta AND Estatus = 'CIRCULACION')
		SELECT @OK = 30097, @Continuar = 0
	ELSE
		SELECT @Continuar = 1

	IF @Accion = 'CANCELAR'
		SELECT @EsCancelacion = 1, @Factor = -1
	ELSE
		SELECT @EsCancelacion = 0, @Factor = 1

	SELECT @VentaPreciosImpuestoIncluido = ISNULL(VentaPreciosImpuestoIncluido,0)
    FROM EmpresaCfg 
	WHERE Empresa = @Empresa

	SELECT @TarjetaMoneda = Moneda 
	FROM POSValeSerie 
	WHERE Serie = @Tarjeta AND Estatus = 'CIRCULACION'

	IF @Continuar = 1 AND @Accion = 'AFECTAR' 
		BEGIN
			IF @Continuar = 1
				BEGIN
					DECLARE ctCteFrecuente CURSOR FOR
					SELECT d.Renglon, d.Articulo, d.Precio, ISNULL(d.Impuesto1,0), CASE WHEN ISNULL(d.AplicaDescGlobal, 1) = 1 
																							THEN ISNULL(v.DescuentoGlobal,0.0) 
																						ELSE 0 
																						END, ISNULL(d.DescuentoLinea,0), 
						   NULLIF(RTRIM(a.Categoria), ''), ISNULL(f.Porcentaje,0), d.PrecioImpuestoInc
					FROM POSL v, POSLVenta d, Art a, ArtCatTarjetaPuntos f
					WHERE v.ID = d.ID
					AND d.Articulo = a.Articulo
					AND a.Categoria = f.Categoria
					AND @FechaEmision BETWEEN f.FechaD AND f.FechaA
					AND v.ID = @ID
					AND ISNULL(f.Porcentaje,0) > 0

					OPEN ctCteFrecuente
					FETCH NEXT FROM ctCteFrecuente INTO @Renglon, @Articulo, @Precio, @Impuesto1, @DescuentoGlobal, @DescuentoLinea, 
						@Categoria, @Porcentaje, @PrecioImpuestoInc
					WHILE @@FETCH_STATUS = 0
						BEGIN        
							IF @CfgVentaPuntosArtCat = 1 AND @OFER = 0 AND @Ok IS NULL
								BEGIN
									IF @VentaPreciosImpuestoIncluido = 0
										SELECT @Cargo = ROUND(((@PrecioImpuestoInc)*(1-(@DescuentoLinea/100.0))*(1-(@DescuentoGlobal/100) ) ),2)
									ELSE 
										SELECT @Cargo = ROUND(((@Precio)*(1-(@DescuentoLinea/100.0))*(1-(@DescuentoGlobal/100) ) ),2)
      
									SELECT @Cargo = ISNULL(@Cargo,0)*(@Porcentaje/100)
    
									IF @Cargo > 0.0
										UPDATE POSLVenta SET Puntos = dbo.fnImporteMonTarjeta(@Cargo, @MovMoneda, @MovTipoCambio, @TarjetaMoneda,NULL, @Sucursal ) 
										WHERE ID = @ID AND Renglon = @Renglon
								END
        
							FETCH NEXT FROM ctCteFrecuente INTO @Renglon, @Articulo, @Precio, @Impuesto1, @DescuentoGlobal, @DescuentoLinea, 
								@Categoria, @Porcentaje, @PrecioImpuestoInc
						END
					CLOSE ctCteFrecuente
					DEALLOCATE ctCteFrecuente
				END

			SELECT @CantidadVenta = SUM(Cantidad) 
			FROM POSLVenta 
			WHERE ID = @ID    
			
			SELECT @Total = SUM(Puntos) 
			FROM POSLVenta 
			WHERE ID = @ID AND  Puntos > 0
			
			SELECT @TotalCargo = SUM(Puntos)*-1 
			FROM POSLVenta 
			WHERE ID = @ID AND  Puntos < 0
    
			--VERIFICAR SALDO LDI    
			IF @Tarjeta IS NOT NULL AND @Ok IS NULL AND @MonederoLDI = 1
				EXEC spPOSLDIValidarTarjeta  'MON CONSULTA',@ID, @Tarjeta,@Empresa,@Usuario,@Sucursal,@Importe OUTPUT, @Ok OUTPUT, @OkRef  OUTPUT, @OKRefLDI OUTPUT 

			--SI LA TARJETA NO EXISTE, LA DA DE ALTA
			IF @OKRefLDI = 'Tarjeta no registrada' AND @MonederoLDI = 1
				BEGIN 
					SELECT @Ok = NULL,@OkRef = NULL

					EXEC spPOSLDI 'MON ALTA NUEVO', @ID, @Tarjeta, @Empresa, @Usuario, @Sucursal, NULL, NULL, 1, NULL, @Ok OUTPUT, @OkRef  OUTPUT, 'POS'

					IF (SELECT Estatus FROM POSValeSerie WHERE Serie = @Tarjeta)='DISPONIBLE' AND @Ok IS NULL
						BEGIN
							SELECT @Renglon = MAX(Renglon)+ 2048.0, @RenglonID = MAX(RenglonID)+1
							FROM POSLVenta 
							WHERE ID = @ID        
							
							SELECT @RenglonTipo = dbo.fnRenglonTipo('SERIE')
       
							IF NOT EXISTS(SELECT Articulo FROM POSLVenta WHERE ID = @ID AND Articulo = @ArtTarjeta)AND @Ok IS NULL
								INSERT POSLVenta(
									ID,  Renglon, RenglonID, RenglonTipo, Cantidad, Articulo, Precio, CantidadInventario)
								SELECT 
									@ID, @Renglon, @RenglonID, @RenglonTipo, 1, @ArtTarjeta, 0.0, 1
        
							IF @@ERROR <> 0 
								SET @Ok = 1

							IF @Ok IS NULL AND NOT EXISTS(SELECT * FROM POSLSerieLote WHERE ID = @ID AND  SerieLote = @Tarjeta)AND @Ok IS NULL
								BEGIN
									INSERT POSLSerieLote (
										ID, RenglonID, Articulo, SubCuenta, SerieLote)
									VALUES (
										@ID, @RenglonID, @ArtTarjeta, '', @Tarjeta)
        
									IF @@ERROR <> 0 
										SET @Ok = 1
								END 
                   
							IF  @Ok IS NULL
								UPDATE POSValeSerie SET  Estatus = 'CIRCULACION' WHERE Serie = @Tarjeta
						END      
				END  

			IF ISNULL(@Importe,0.0)< ISNULL(@TotalCargo,0.0)
				SELECT @Ok = 30096, @OkRef = 'Tarjeta ' + @Tarjeta     
      
			IF @MovClave = 'POS.N' AND @MovSubClave= 'POS.DREF'  
				SELECT @CantidadVenta = ABS(@CantidadVenta)       
    
			--PRIMERO HACER LOS CARGOS       
			IF ISNULL(@TotalCargo, 0.0) > 0.0 AND @CantidadVenta >0.0 AND  @Ok IS NULL AND @MonederoLDI = 1
				EXEC spPOSLDI 'MON CARGO', @ID, @Tarjeta, @Empresa, @Usuario, @Sucursal, NULL, @TotalCargo, 1, null, @Ok OUTPUT, @OkRef OUTPUT, 'POS'

			IF ISNULL(@Total, 0.0) > 0.0 AND @CantidadVenta <0.0 AND  @Ok IS NULL AND @MonederoLDI = 1
				EXEC spPOSLDI 'MON CARGO', @ID, @Tarjeta, @Empresa, @Usuario, @Sucursal, NULL, @Total, 1, null, @Ok OUTPUT, @OkRef OUTPUT, 'POS'      
	
			--ABONOS     
			IF ISNULL(@TotalCargo, 0.0) > 0.0 AND @CantidadVenta <0.0 AND  @Ok IS NULL AND @MonederoLDI = 1
				EXEC spPOSLDI 'MON ABONO', @ID, @Tarjeta, @Empresa, @Usuario, @Sucursal, NULL, @TotalCargo, 1, null, @Ok OUTPUT, @OkRef OUTPUT, 'POS'    
		END

	IF  @Accion = 'CANCELAR'
		BEGIN
			SELECT @Total = SUM(Puntos) FROM POSLVenta WHERE ID = @ID

			IF ISNULL(@Total, 0) > 0    AND @MonederoLDI = 1
				EXEC spPOSLDI 'MON CARGO', @ID, @Tarjeta,  @Empresa, @Usuario, @Sucursal, NULL, @Total, 1, NULL, @Ok OUTPUT, @OkRef OUTPUT,'POS'
		END

	RETURN
END
GO


/************************ spPOSAsociarMonedero *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAsociarMonedero') AND type = 'P') DROP PROCEDURE dbo.spPOSAsociarMonedero
GO             
CREATE PROCEDURE spPOSAsociarMonedero
	@ID                 varchar(36),
    @Monedero           varchar(20),
    @Usuario            varchar(10),
    @Estacion           int
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@Cliente					varchar(10),
    @Proyecto					varchar(50),
	@Almacen					varchar(10),
	@Agente						varchar(10),
	@Cajero						varchar(10),
	@FormaEnvio					varchar(50),
	@Condicion					varchar(50),
	@Vencimiento				varchar(50),
	@Descuento					varchar(50),
	@DescuentoGlobal			varchar(50),
	@ListaPreciosEsp			varchar(20),
	@ZonaImpuesto				varchar(50),
	@ZonaImpuestoSucursal		varchar(50),
	@ImagenNombreAnexo			varchar(255),
	@Sucursal					int,	  
	@Nombre						varchar(100),
	@Direccion					varchar(100),
	@DireccionNumero			varchar(20),
	@DireccionNumeroInt			varchar(20),
	@EntreCalles				varchar(100),
	@Delegacion					varchar(100),
	@Colonia					varchar(100),
	@Poblacion					varchar(100),
	@Estado						varchar(50),
	@Pais						varchar(50),
	@Zona						varchar(50),
	@CodigoPostal				varchar(15),
	@RFC						varchar(15),
	@CURP						varchar(50),	
	@ListaPreciosSucursal		varchar(20),		
	@ListaPreciosUsuario		varchar(20),
	@Puntos						float,
	@Importe					float,
	@Empresa					varchar(5),
	@Ok							int,
	@OkRef						varchar(255),
	@OKRefLDI					varchar(500),
	@MonederoLDI				bit,
    @FechaNacimiento			datetime,
    @EstadoCivil				varchar(20),
    @Conyuge					varchar(100),	
    @Sexo						varchar(20),	
    @Fuma						bit,
    @Profesion					varchar(100),	
    @Puesto						varchar(100),
    @NumeroHijos				int,
    @Religion					varchar(50)	  
   
	BEGIN TRANSACTION
   
	IF EXISTS(SELECT * FROM POSValeSerie WHERE Serie = @Monedero)
		SELECT @Cliente = Cliente FROM POSValeSerie WHERE Serie = @Monedero
      
	SELECT @Empresa = Empresa, @Sucursal = Sucursal 
	FROM POSL 
	WHERE ID = @ID
   
	SELECT @ListaPreciosSucursal = ListaPreciosEsp, @ZonaImpuestoSucursal = ZonaImpuesto
    FROM Sucursal
    WHERE Sucursal = @Sucursal   
   
	SELECT @MonederoLDI = ISNULL(MonederoLDI,0) 
	FROM POSCfg 
	WHERE Empresa = @Empresa
   
	IF @Cliente IS NOT NULL
		BEGIN
			SELECT  
				@Proyecto = ct.Proyecto,
				@Agente = ct.Agente,
				@FormaEnvio = ct.FormaEnvio,
				@Condicion = ct.Condicion,
				@Descuento = ct.Descuento,
				@DescuentoGlobal = d.Porcentaje,
				@ListaPreciosEsp = ISNULL(ISNULL(ISNULL(NULLIF(u.DefListaPreciosEsp,''), NULLIF(ct.ListaPreciosEsp,'')), NULLIF(@ListaPreciosSucursal,'')),'(Precio Lista)'),
				@ZonaImpuesto = ISNULL(ISNULL(NULLIF(u.DefZonaImpuesto,''),NULLIF(ct.ZonaImpuesto,'')),NULLIF(@ZonaImpuestoSucursal,'')),				
				@Nombre	= ct.Nombre,
				@Direccion = ct.Direccion,
 				@DireccionNumero = ct.DireccionNumero,
 				@DireccionNumeroInt	= ct.DireccionNumeroInt,
				@EntreCalles = ct.EntreCalles,		
				@Delegacion = ct.Delegacion,	
				@Colonia = ct.Colonia,	
				@Poblacion = ct.Poblacion,
				@Estado = ct.Estado,		
				@Pais = ct.Pais,			
				@Zona = ct.Zona,			
				@CodigoPostal = ct.CodigoPostal,
				@RFC = ct.RFC,		
				@CURP = ct.CURP,
				@FechaNacimiento = ct.FechaNacimiento,
				@EstadoCivil = ct.EstadoCivil,	 
				@Conyuge = ct.Conyuge,
				@Sexo = ct.Sexo,     
				@Fuma = ct.Fuma,   
				@Profesion = ct.Profesion,
				@Puesto = ct.Puesto,
				@NumeroHijos = ct.NumeroHijos,
				@Religion = ct.Religion	     
			FROM Cte ct 
			LEFT OUTER JOIN Descuento d ON ct.Descuento = d.Descuento  
			JOIN Usuario u ON 1=1   
			WHERE ct.Cliente = @Cliente
			AND u.Usuario = @Usuario
        
			IF @Cliente IS NOT NULL  
				UPDATE POSL SET Cliente = @Cliente, 
					Proyecto = @Proyecto, 
					FormaEnvio = @FormaEnvio, 
					Condicion = ISNULL(NULLIF(@Condicion,''),Condicion), 
					Descuento = ISNULL(NULLIF(@Descuento,''),Descuento), 
					DescuentoGlobal = ISNULL(NULLIF(@DescuentoGlobal,''),DescuentoGlobal), 
					ListaPreciosEsp = @ListaPreciosEsp, 
					ZonaImpuesto = ISNULL(NULLIF(@ZonaImpuesto,''),ZonaImpuesto),
					Nombre	  = @Nombre,
					Direccion	  = @Direccion,
					DireccionNumero	= @DireccionNumero,
					DireccionNumeroInt	= @DireccionNumeroInt,
					EntreCalles	= @EntreCalles,
					Delegacion		= @Delegacion,	
					Colonia		= @Colonia,
					Poblacion		= @Poblacion,
					Estado		= @Estado,
					Pais		= @Pais,
					Zona		= @Zona,
					CodigoPostal	= @CodigoPostal,
					RFC		= @RFC,
					CURP		= @CURP,
					Monedero           = @Monedero,
         			FechaNacimiento = @FechaNacimiento,	
					EstadoCivil	= @EstadoCivil,
					Conyuge	= @Conyuge,	
					Sexo = @Sexo	,	
					Fuma	= @Fuma	,
					Profesion = @Profesion ,	
					Puesto = @Puesto,		
					NumeroHijos	= @NumeroHijos,
					Religion = @Religion		     	       
				WHERE ID = @ID                  
		END 
	ELSE        
		UPDATE POSL SET Monedero = @Monedero WHERE ID = @ID
     
	EXEC spPOSOfertaAplicar	@ID
	EXEC spPOSOfertaPuntosInsertarTemp @ID, NULL, 1, @Estacion     
   
	IF NULLIF(@Cliente,'') IS NULL     
		SELECT @Cliente = Cliente 
		FROM POSL 
		WHERE ID = @ID
   
	SELECT @Puntos = ISNULL(SUM(Puntos),0.0) 
	FROM POSLVenta 
	WHERE ID = @ID
   
	IF @Puntos >0.0 
		SET @Puntos = 0.0
   
	IF  @MonederoLDI = 1
		EXEC spPOSLDIValidarTarjeta 'MON CONSULTA', @ID, @Monedero, @Empresa, @Usuario, @Sucursal, 
			@Importe OUTPUT, @Ok OUTPUT, @OkRef  OUTPUT, @OKRefLDI OUTPUT  
     
	IF @Ok IS NULL AND NOT EXISTS (SELECT * FROM POSValeSerie WHERE Serie = @Monedero) AND @MonederoLDI = 0
		BEGIN
			EXEC spPOSAltaMonedero @ID, @Usuario, @Empresa ,@Sucursal, @Cliente, @Monedero, @Ok OUTPUT 
		END     

	IF ABS(@Puntos)>ISNULL(@Importe,0.0) OR @Ok IS NOT NULL
		ROLLBACK TRANSACTION
	ELSE
		COMMIT TRANSACTION   
   
	SELECT @OkRef
  
	RETURN
END
GO  


/************************ spPOSDesAsociarMonedero *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSDesAsociarMonedero') AND type = 'P') DROP PROCEDURE dbo.spPOSDesAsociarMonedero
GO             
CREATE PROCEDURE spPOSDesAsociarMonedero
	@ID                 varchar(36),
    @Monedero           varchar(20),
    @Usuario            varchar(10),
    @Estacion           int
--//WITH ENCRYPTION           
AS 
BEGIN
	DECLARE 
	@Cliente				varchar(10),
    @Proyecto				varchar(50),
	@Almacen				varchar(10),
	@Agente					varchar(10),
	@Cajero					varchar(10),
	@FormaEnvio				varchar(50),
	@Condicion				varchar(50),
	@Vencimiento			varchar(50),
	@Descuento				varchar(50),
	@DescuentoGlobal		varchar(50),
	@ListaPreciosEsp		varchar(20),
	@ZonaImpuesto			varchar(50),
	@ZonaImpuestoSucursal	varchar(50),
	@ImagenNombreAnexo		varchar(255),
	@Sucursal				int,	  
	@Nombre					varchar(100),
	@Direccion				varchar(100),
	@DireccionNumero		varchar(20),
	@DireccionNumeroInt		varchar(20),
	@EntreCalles			varchar(100),
	@Delegacion				varchar(100),
	@Colonia				varchar(100),
	@Poblacion				varchar(100),
	@Estado					varchar(50),
	@Pais					varchar(50),
	@Zona					varchar(50),
	@CodigoPostal			varchar(15),
	@RFC					varchar(15),
	@CURP					varchar(50),	
	@ListaPreciosSucursal	varchar(20),		
	@ListaPreciosUsuario	varchar(20),
	@Puntos					float,
	@Importe				float,
	@Empresa				varchar(5),
	@Ok						int,
	@OkRef					varchar(255),
	@OKRefLDI				varchar(500),
	@MonederoLDI			bit,
    @FechaNacimiento		datetime,
    @EstadoCivil	        varchar(20),
    @Conyuge				varchar(100),	
    @Sexo	                varchar(20),	
    @Fuma	                bit,
    @Profesion				varchar(100),	
    @Puesto					varchar(100),
    @NumeroHijos	        int,
    @Religion				varchar(50)		  

	SELECT @Empresa = Empresa, @Sucursal = Sucursal 
	FROM POSL WHERE ID = @ID
   
	SELECT @Cliente = DefCliente 
	FROM Usuario 
	WHERE Usuario = @Usuario
   
	SELECT @ListaPreciosSucursal = ListaPreciosEsp, @ZonaImpuestoSucursal = ZonaImpuesto
    FROM Sucursal
    WHERE Sucursal = @Sucursal   
   
	SELECT @MonederoLDI = ISNULL(MonederoLDI,0) 
	FROM POSCfg 
	WHERE Empresa = @Empresa
   
	IF @Cliente IS NOT NULL
		BEGIN
			SELECT 
				@Proyecto = ct.Proyecto,
				@Agente = ct.Agente,
				@FormaEnvio = ct.FormaEnvio,
				@Condicion = ct.Condicion,
				@Descuento = ct.Descuento,
				@DescuentoGlobal = d.Porcentaje,
				@ListaPreciosEsp = ISNULL(ISNULL(ISNULL(NULLIF(u.DefListaPreciosEsp,''), NULLIF(ct.ListaPreciosEsp,'')), NULLIF(@ListaPreciosSucursal,'')),'(Precio Lista)'),
				@ZonaImpuesto = ISNULL(ISNULL(NULLIF(u.DefZonaImpuesto,''),NULLIF(ct.ZonaImpuesto,'')),NULLIF(@ZonaImpuestoSucursal,'')),
				@Nombre = ct.Nombre,
				@Direccion = ct.Direccion,
 				@DireccionNumero = ct.DireccionNumero,
 				@DireccionNumeroInt	= ct.DireccionNumeroInt,
				@EntreCalles = ct.EntreCalles,		
				@Delegacion = ct.Delegacion,	
				@Colonia = ct.Colonia,	
				@Poblacion = ct.Poblacion,
				@Estado = ct.Estado,		
				@Pais = ct.Pais,			
				@Zona = ct.Zona,			
				@CodigoPostal = ct.CodigoPostal,
				@RFC = ct.RFC,		
				@CURP = ct.CURP,
				@FechaNacimiento = ct.FechaNacimiento,
				@EstadoCivil = ct.EstadoCivil,	 
				@Conyuge = ct.Conyuge,
				@Sexo = ct.Sexo,     
				@Fuma = ct.Fuma,
				@Profesion = ct.Profesion,
				@Puesto = ct.Puesto,
				@NumeroHijos = ct.NumeroHijos,
				@Religion = ct.Religion  	     	     
			FROM Cte ct 
			LEFT OUTER JOIN Descuento d ON ct.Descuento = d.Descuento  
			JOIN Usuario u ON 1=1   
			WHERE ct.Cliente = @Cliente
			AND u.Usuario = @Usuario
         
			IF @Cliente IS NOT NULL  
				UPDATE POSL SET Cliente = @Cliente, 
					Proyecto = @Proyecto, 
					FormaEnvio = @FormaEnvio, 
					Condicion = @Condicion, 
					Descuento = @Descuento, 
					DescuentoGlobal = @DescuentoGlobal, 
					ListaPreciosEsp = @ListaPreciosEsp, 
					ZonaImpuesto = @ZonaImpuesto,
					Nombre = @Nombre,
					Direccion = @Direccion,
					DireccionNumero	= @DireccionNumero,
					DireccionNumeroInt = @DireccionNumeroInt,
					EntreCalles	= @EntreCalles,
					Delegacion = @Delegacion,	
					Colonia = @Colonia,
					Poblacion = @Poblacion,
					Estado = @Estado,
					Pais = @Pais,
					Zona = @Zona,
					CodigoPostal = @CodigoPostal,
					RFC	= @RFC,
					CURP = @CURP,
					Monedero = @Monedero,
                    FechaNacimiento = @FechaNacimiento,	
                    EstadoCivil	= @EstadoCivil,
					Conyuge	= @Conyuge,	
					Sexo = @Sexo,	
					Fuma = @Fuma,
					Profesion = @Profesion ,	
					Puesto = @Puesto,		
					NumeroHijos	= @NumeroHijos,
                    Religion = @Religion		     	       
				WHERE ID = @ID         
		END 
   ELSE        
		UPDATE POSL SET Monedero = @Monedero WHERE ID = @ID
     
	EXEC spPOSOfertaAplicar	@ID
	EXEC spPOSOfertaPuntosInsertarTemp @ID, NULL, 0, @Estacion     
  
	RETURN
END
GO 


/**************** spAsociarMonedero ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spAsociarMonedero') and type = 'P') DROP PROCEDURE dbo.spAsociarMonedero
GO             
CREATE PROCEDURE spAsociarMonedero
	@Empresa        varchar(5),
	@Sucursal       int,
	@ID             int,
	@Monedero		varchar(20)
--//WITH ENCRYPTION
AS 
BEGIN
	IF NOT EXISTS(SELECT * FROM TarjetaSerieMov WHERE Empresa = @Empresa AND Modulo = 'VTAS' AND ID = @ID AND Serie = @Monedero AND Sucursal = @Sucursal)
		INSERT TarjetaSerieMov(
			Empresa,Modulo,ID,Serie,Sucursal)
		SELECT                 
			@Empresa,'VTAS',@ID,@Monedero,@Sucursal

	RETURN
END
GO


/**************** fnTipoCambio ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnTipoCambio') DROP FUNCTION fnTipoCambio
GO
CREATE FUNCTION fnTipoCambio (
	@Moneda				varchar(10)
)
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @TipoCambio	float

	SELECT @TipoCambio = TipoCambio FROM Mon WHERE Moneda = @Moneda
  
	RETURN (@TipoCambio)
END
GO


/************************ spPOSBorrarCteFrecuenteG  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSBorrarCteFrecuenteG') AND type = 'P') DROP PROCEDURE dbo.spPOSBorrarCteFrecuenteG
GO             
CREATE PROCEDURE spPOSBorrarCteFrecuenteG
	@Estacion   int
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DELETE POSHerrCteFrecuenteG WHERE Estacion = @Estacion
END
GO 


/************************ spPOSBorrarCteFrecuente *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSBorrarCteFrecuente') AND type = 'P') DROP PROCEDURE dbo.spPOSBorrarCteFrecuente
GO             
CREATE PROCEDURE spPOSBorrarCteFrecuente
	@Estacion   int
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DELETE POSHerrCteFrecuente WHERE Estacion = @Estacion	
	DELETE ListaST WHERE Estacion = @Estacion	
END
GO 
	     

/************************ spPOSHerrCteFrecuente *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSHerrCteFrecuente') AND type = 'P') DROP PROCEDURE dbo.spPOSHerrCteFrecuente
GO             
CREATE PROCEDURE spPOSHerrCteFrecuente
	@Estacion   int
--//WITH ENCRYPTION	      
AS 
BEGIN
	INSERT POSHerrCteFrecuente(
		Estacion, Cliente)
	SELECT  
		@Estacion, Cliente
    FROM Cte 
	WHERE Cliente IN (SELECT Clave FROM ListaST WHERE Estacion = @Estacion AND Clave NOT IN (SELECT Cliente FROM POSHerrCteFrecuente))
END
GO  


/************************ spPOSHerrCteFrecuenteQuitar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSHerrCteFrecuenteQuitar') AND type = 'P') DROP PROCEDURE dbo.spPOSHerrCteFrecuenteQuitar
GO             
CREATE PROCEDURE spPOSHerrCteFrecuenteQuitar
	@Estacion   int
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DELETE POSHerrCteFrecuente WHERE Cliente IN (SELECT Clave FROM ListaST WHERE Estacion = @Estacion) 
	DELETE ListaST WHERE Estacion = @Estacion  
END
GO 


/************************ spPOSPOSHerrCteGenerarMonedero *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSPOSHerrCteGenerarMonedero') AND type = 'P') DROP PROCEDURE dbo.spPOSPOSHerrCteGenerarMonedero
GO             
CREATE PROCEDURE spPOSPOSHerrCteGenerarMonedero
	@Estacion   int
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE 
	@Cliente      varchar(10),
	@ID           int,
	@Consecutivo  int,
	@Ok           int,
	@Monedero     varchar(20)
      
	DECLARE crArticulo CURSOR FOR
	SELECT ID, Cliente
    FROM POSHerrCteFrecuente
    WHERE ID IN (SELECT ID FROM ListaID  WHERE Estacion = @Estacion)
  
	OPEN crArticulo
	FETCH NEXT FROM crArticulo INTO @ID, @Cliente
	WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
		BEGIN 
			SELECT @Consecutivo = COUNT(*) 
			FROM POSValeSerie 
			WHERE Cliente = @Cliente
			
			SELECT @Consecutivo = ISNULL(NULLIF(@Consecutivo,0),1)
			SELECT @Monedero = @Cliente + '-'+CONVERT(varchar,@Consecutivo+1)
  
			WHILE EXISTS(SELECT * FROM POSValeSerie WHERE Serie = @Monedero)
				BEGIN
					SELECT @Consecutivo = @Consecutivo +1
					SELECT @Monedero = @Cliente + '-'+CONVERT(varchar,@Consecutivo)
				END

			UPDATE POSHerrCteFrecuente SET Monedero = @Monedero WHERE ID = @ID
    
			FETCH NEXT FROM crArticulo INTO @ID, @Cliente
		END 
	CLOSE crArticulo
	DEALLOCATE crArticulo 
END
GO 


/************************ spPOSPOSHerrCteGenerarVale *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSPOSHerrCteGenerarVale') AND type = 'P') DROP PROCEDURE dbo.spPOSPOSHerrCteGenerarVale
GO             
CREATE PROCEDURE spPOSPOSHerrCteGenerarVale
	@Estacion		int,
	@Empresa		varchar(5),
	@Usuario		varchar(10),
	@Sucursal		int,
	@Moneda			varchar(10),
	@Tipo			varchar(50),
	@Categoria		varchar(50),
	@Grupo			varchar(50),
	@Familia		varchar(50),
	@FechaD			datetime,
	@FechaA			datetime
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE 
	@Cliente             varchar(10),
	@ID                  int,
	@FechaEmision        datetime,
	@Ok                  int,
	@OkRef               varchar(255),
	@OKRefLDI            varchar(500),   
	@Monedero            varchar(20),
	@Mov                 varchar(20),
	@MovID               varchar(20),
	@TipoCambio          float,
	@IDNuevo             int,
	@ArticuloTarjeta     varchar(20),  
	@AlmacenTarjeta      varchar(10),
	@Importe             float,
	@MonederoLDI         bit,
	@SugerirFechaCierre  bit,
	@FechaCierre         datetime

  
	SELECT @FechaEmision = dbo.fnFechaSinHora(GETDATE())-- CASE WHEN @SugerirFechaCierre = 1 THEN @FechaCierre ELSE dbo.fnFechaSinHora(GETDATE())END  

	SELECT @MonederoLDI = ISNULL(MonederoLDI,0) 
	FROM POSCfg 
	WHERE Empresa = @Empresa
	
	SELECT @TipoCambio = TipoCambio 
	FROM Mon 
	WHERE Moneda = @Moneda
	
	SELECT @ArticuloTarjeta= CxcArticuloTarjetasDef ,@AlmacenTarjeta= CxcAlmacenTarjetasDef  
    FROM EmpresaCfg 
	WHERE Empresa = @Empresa
  
	SELECT @Mov = MovEmision
    FROM POSCfg 
	WHERE Empresa = @Empresa 
  
	IF @Mov IS NULL
		SELECT TOP 1 @Mov = Mov FROM MovTipo WHERE Modulo = 'VALE' AND Clave = 'VALE.ET' 
   
	IF EXISTS(SELECT Monedero FROM POSHerrCteFrecuente WHERE Monedero IN (SELECT Serie FROM ValeSerie))
		SELECT @Ok = 36011, @OkRef = @Monedero

	IF @Ok IS NULL
		BEGIN
			IF @Ok IS NULL
				BEGIN
					DECLARE crArticulo CURSOR FOR
					SELECT ID, Monedero, Cliente
					FROM POSHerrCteFrecuente
					WHERE ID IN (SELECT ID FROM ListaID  WHERE Estacion = @Estacion)AND Monedero IS NOT NULL
      
					OPEN crArticulo
					FETCH NEXT FROM crArticulo INTO @ID, @Monedero, @Cliente
					WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
						BEGIN 
							BEGIN TRANSACTION  
							
							SELECT @Ok = NULL ,@OkRef = NULL         
							INSERT Vale(
								Empresa, Mov, FechaEmision, Moneda, TipoCambio, Usuario, Estatus, Sucursal, Tipo, Precio, Importe, Cantidad, Articulo,
								Almacen, FechaInicio, FechaTermino, Cliente)
							SELECT      
								@Empresa,@Mov,@FechaEmision,@Moneda, @TipoCambio, @Usuario,'SINAFECTAR',@Sucursal, @Tipo, 0.0, 0.0, 1, @ArticuloTarjeta, 
								@AlmacenTarjeta, @FechaD, @FechaA, @Cliente 
        
							IF @@ERROR <> 0 
								SET @Ok = 1
        
							SELECT @IDNuevo = SCOPE_IDENTITY()     
        
							INSERT ValeD(
								ID, Serie, Sucursal, SucursalOrigen,Importe)
							SELECT
								@IDNuevo, @Monedero, @Sucursal, @Sucursal, 0.0

							IF @@ERROR <> 0 
								SET @Ok = 1
        
							IF @OK IS NULL
								EXEC spAfectar 'VALE', @IDNuevo, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, 
									@Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT    
          
							IF @Ok IS NULL AND @IDNuevo IS NOT NULL
								SELECT @MovID = MovID FROM Vale WHERE ID = @IDNuevo          
                     
							IF EXISTS(SELECT * FROM POSValeSerie WHERE Serie = @Monedero AND Cliente IS NULL)
								UPDATE POSValeSerie SET Cliente = @Cliente WHERE Serie = @Monedero
						
							IF @MonederoLDI = 1
								EXEC spPOSLDIValidarTarjeta  'MON CONSULTA',@IDNuevo, @Monedero,@Empresa,@Usuario,@Sucursal,@Importe OUTPUT, 
									@Ok OUTPUT, @OkRef  OUTPUT, @OKRefLDI OUTPUT ,0,'VALE' 

							--SI LA TARJETA NO EXISTE, LA DA DE ALTA
							IF @OKRefLDI = 'Tarjeta no registrada'  
								BEGIN 
									SELECT @Ok = NULL,@OkRef= NULL
          
									IF @MonederoLDI = 1
										EXEC spPOSLDI 'MON ALTA NUEVO', @IDNuevo, @Monedero, @Empresa, @Usuario, @Sucursal, NULL, NULL, 1, NULL, 
											@Ok OUTPUT, @OkRef  OUTPUT, 'VALE'
								END
                  
							IF @Ok IS NULL 
								BEGIN
									COMMIT TRANSACTION
								END  
							ELSE
								ROLLBACK TRANSACTION   
         
							IF @Ok IS NOT NULL   
								UPDATE POSHerrCteFrecuente SET Error = ISNULL(@OkrefLdi,'')+' '+ISNULL(@OkRef,'')  WHERE ID = @ID
							
							IF @Ok IS NULL 
								BEGIN
									INSERT POSHerrCteFrecuenteD(
										Cliente, Monedero, FechaEmision, Mov, MovID)
									SELECT
										@Cliente, @Monedero,@FechaEmision, @Mov, @MovID
          
									IF @@ERROR <> 0  
										SET @Ok = 1
                  
									IF @Ok IS NULL
										DELETE  POSHerrCteFrecuente   WHERE ID = @ID
          
									IF @Ok IS NULL
										UPDATE Cte SET Categoria = ISNULL(NULLIF(@Categoria ,''),Categoria), Grupo = ISNULL(NULLIF(@Grupo ,''),Grupo), 
											Familia = ISNULL(NULLIF(@Familia ,''),Familia)
										WHERE Cliente = @Cliente
								END  
          
							FETCH NEXT FROM crArticulo INTO @ID, @Monedero, @Cliente
						END 
					CLOSE crArticulo
					DEALLOCATE crArticulo 
				END
		END 
  
	IF @Ok IS NULL
		SELECT @OkRef = 'PROCESO CONCLUIDO'
   
	SELECT @OkRef  
END
GO  


/**************** spPOSOfertaPuntosInsertarTemp ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSOfertaPuntosInsertarTemp') and type = 'P') DROP PROCEDURE dbo.spPOSOfertaPuntosInsertarTemp
GO
CREATE PROCEDURE spPOSOfertaPuntosInsertarTemp
	@ID               	varchar(50),
	@OfertaFechaHora	varchar(20)	= NULL,
	@PuntosPrecio       bit = 1,
	@Estacion           int
--//WITH ENCRYPTION
AS 
BEGIN 
	DECLARE
    @Empresa						varchar(5),
    @Mov							varchar(20),
    @Sucursal						int,
    @Usuario						varchar(10),
    @ListaPrecios					varchar(50),
    @FechaHora						datetime,
    @Estatus						varchar(15),
    @FechaEmision					datetime,
    @FechaRequerida					datetime,
    @HoraRequerida					varchar(5),
    @Moneda							varchar(10),
    @TipoCambio						float,
    @DescuentoGlobal				float,
    @ImporteTotalMN					float,
    @Aplica							bit,
    @Monedero						varchar(20),
	@CodigoRedondeo					varchar(30),
    @ArticuloRedondeo				varchar(20),
    @ArtOfertaImporte				varchar(20),
    @ArtOfertaFP					varchar(20),
    @CfgAnticipoArticuloServicio	varchar(20)    	
   
	SELECT @CodigoRedondeo = RedondeoVentaCodigo , @ArtOfertaFP = ArtOfertaFP, @ArtOfertaImporte = ArtOfertaImporte
    FROM POSCfg 
	WHERE Empresa = @Empresa
    
	SELECT @ArticuloRedondeo = Cuenta
    FROM CB
    WHERE Codigo = @CodigoRedondeo
	AND TipoCuenta = 'Articulos'
   
	SELECT @ArticuloRedondeo = cb.Cuenta 
	FROM CB 
	WHERE CB.Cuenta = @CodigoRedondeo AND CB.TipoCuenta = 'Articulos'       
    
	SELECT @CfgAnticipoArticuloServicio = NULLIF(CxcAnticipoArticuloServicio,'') 
	FROM EmpresaCfg2
	WHERE Empresa = @Empresa     

	SELECT @Mov = Mov, @Empresa = Empresa, @Sucursal = Sucursal, @Usuario = Usuario, @Moneda = Moneda, @TipoCambio = TipoCambio, 
		@Estatus = Estatus, @ListaPrecios = ListaPreciosEsp, @FechaEmision = FechaEmision, @FechaRequerida = FechaEmision, 
		@HoraRequerida = '00:00', @DescuentoGlobal = DescuentoGlobal,@Monedero = Monedero
    FROM POSL 
	WHERE ID = @ID
   
	DELETE POSOfertaTemp WHERE Estacion = @Estacion
  
	IF NULLIF(@Monedero,'') IS NOT NULL AND @PuntosPrecio = 1
		SET @PuntosPrecio = 1 
	ELSE
		SET @PuntosPrecio = 0      

	SET @Aplica = 1
	EXEC xpPOSOfertaAplicar @ID, @Aplica OUTPUT 

	IF @Aplica = 1 
		BEGIN
			IF @OfertaFechaHora IS NULL
				SELECT @OfertaFechaHora = OfertaFechaHora 
				FROM EmpresaCfg2
				WHERE Empresa = @Empresa

			IF UPPER(@OfertaFechaHora) = 'FECHA SERVIDOR'  
				SELECT @FechaHora = GETDATE() ELSE
			IF UPPER(@OfertaFechaHora) = 'FECHA EMISION'   
				SELECT @FechaHora = @FechaEmision ELSE
			IF UPPER(@OfertaFechaHora) = 'FECHA REQUERIDA' 
				SELECT @FechaHora = dbo.FechaConHora(@FechaRequerida, @HoraRequerida)
    
			CREATE TABLE #OfertaLog (
			RID					    int NOT NULL IDENTITY(1,1) PRIMARY KEY,
			OfertaID				int NOT NULL,
			Mov						varchar(20)NULL,
			MovID					varchar(20)NULL,
			Prioridad				int NULL,
			PrioridadG			    int NULL,
			Tipo					varchar(50)NULL,
			Forma					varchar(50)NULL,
			Usar					varchar(50)NULL,
			Articulo				varchar(20) COLLATE Database_Default NOT NULL, 
			SubCuenta				varchar(50) COLLATE Database_Default NULL, 
			Unidad				    varchar(50) COLLATE Database_Default NULL, 
			Descuento				float NULL,
			DescuentoImporte		money NULL, 
			Puntos				    float NULL, 
			PuntosPorcentaje		float NULL, 
			Comision				float NULL, 
			ComisionPorcentaje		float NULL, 
			CantidadObsequio		float NULL,
			Costo					float NULL,
			PrecioBaseCosto			float NULL,
			PrecioBaseLista			float NULL,
			Precio				    float NULL,
			ArticuloObsequio		varchar(20)NULL,
			UnidadObsequio			varchar(5) NULL,
			SubCuentaObsequio		varchar(50) NULL,
			ArtTipo				    varchar(20)NULL,
			CantidadOferta			float NULL,
			DescuentoP1			    float NULL,
			DescuentoP2			    float NULL,
			DescuentoP3			    float NULL,
			DescuentoG1			    float NULL,
			DescuentoG2			    float NULL,
			DescuentoG3			    float NULL,
			SucursalDetalle			int	 NULL,
			OfertaIDP1			    int NULL,
			OfertaIDP2			    int NULL,
			OfertaIDP3			    int NULL,
			OfertaIDG1			    int NULL,
			OfertaIDG2			    int NULL,
			OfertaIDG3			    int NULL,
			Descripcion			    varchar(255) NULL)

			-- #Venta 
			CREATE TABLE #Venta (Campo varchar(50) COLLATE Database_Default NOT NULL, Valor varchar(100) COLLATE Database_Default NULL)
			
			EXEC spPOSOfertaVenta @ID
			CREATE INDEX Campo ON #Venta (Campo, Valor)

			-- #VentaD 
			CREATE TABLE #VentaD (
			RID						int NOT NULL IDENTITY(1,1) PRIMARY KEY,
			Renglon					float NOT NULL, 
			RenglonSub				int NOT NULL, 
			RenglonTipo             varchar(1) NOT NULL,
			Articulo				varchar(20) COLLATE Database_Default NOT NULL, 
			SubCuenta				varchar(50) COLLATE Database_Default NULL, 
			Rama					varchar(20) COLLATE Database_Default NULL, 
			Categoria				varchar(50) COLLATE Database_Default NULL, 
			Grupo					varchar(50) COLLATE Database_Default NULL, 
			Familia					varchar(50) COLLATE Database_Default NULL, 
			Linea					varchar(50) COLLATE Database_Default NULL, 
			Fabricante				varchar(50) COLLATE Database_Default NULL, 
			Proveedor				varchar(10) COLLATE Database_Default NULL, 
			ABC						varchar(50) COLLATE Database_Default NULL,
			Cantidad				float NULL, 
			Unidad					varchar(50) COLLATE Database_Default NULL, 
			CantidadInventario		float NULL, 
			PrecioSugerido			float NULL, 
			Precio					float NULL, 
			Impuesto1				float NULL,
			Descuento				float NULL, 
			DescuentoP1				float NULL,
			DescuentoP2				float NULL,
			DescuentoP3				float NULL,
			DescuentoG1				float NULL,
			DescuentoG2				float NULL,
			DescuentoG3				float NULL,
			DescuentoImporte		float NULL, 
			Puntos					float NULL, 
			PuntosPorcentaje		float NULL, 
			Comision				float NULL, 
			ComisionPorcentaje		float NULL, 
			CantidadObsequio		float NULL, 
			OfertaID				int NULL,
			OfertaIDP1				int NULL,
			OfertaIDP2				int NULL,
			OfertaIDP3				int NULL,
			OfertaIDG1				int NULL,
			OfertaIDG2				int NULL,
			OfertaIDG3				int NULL,
			DescuentoAd				float NULL)


			CREATE TABLE #ArtObsequio (Articulo varchar(20) COLLATE Database_Default NOT NULL, OfertaID INT NULL, Unidad varchar(50) NULL, SubCuenta varchar(50) NULL)

			INSERT #VentaD (
				Renglon, RenglonSub, RenglonTipo, Articulo, SubCuenta, Rama, Categoria, Grupo, Familia, Linea, Fabricante, Proveedor, Cantidad, 
				Unidad, PrecioSugerido, CantidadInventario, OfertaID, 
				OfertaIDP1, OfertaIDP2, OfertaIDP3, OfertaIDG1, OfertaIDG2, OfertaIDG3, DescuentoP1, DescuentoP2, DescuentoP3, 
				DescuentoG1, DescuentoG2, DescuentoG3, Descuento, DescuentoAd) 
			SELECT 
				d.Renglon, d.RenglonSub, d.RenglonTipo,d.Articulo, d.SubCuenta, a.Rama, a.Categoria, a.Grupo, a.Familia, a.Linea, a.Fabricante, a.Proveedor, d.Cantidad,
				d.Unidad, d.PrecioSugerido, ISNULL(ISNULL(d.CantidadInventario, d.Cantidad*dbo.fnArtUnidadFactor(@Empresa, d.Articulo, d.Unidad)), 0.0), d.OfertaID,
				d.OfertaIDP1, d.OfertaIDP2, d.OfertaIDP3, d.OfertaIDG1, d.OfertaIDG2, d.OfertaIDG3, d.DescuentoP1, d.DescuentoP2, d.DescuentoP3, 
				d.DescuentoG1, d.DescuentoG2, d.DescuentoG3, d.DescuentoLinea, d.DescuentoAd
			FROM POSLVenta d
			JOIN Art a ON a.Articulo = d.Articulo
			AND ISNULL(d.Aplicado,0) = 0
			WHERE d.ID = @ID 
			AND d.Articulo NOT IN(@ArticuloRedondeo,@CfgAnticipoArticuloServicio,@ArtOfertaFP,@ArtOfertaImporte)
			AND d.RenglonTipo <> 'K'

			CREATE INDEX Renglon    ON #VentaD (Renglon, RenglonSub)
			CREATE INDEX Articulo   ON #VentaD (Articulo)
			CREATE INDEX Rama       ON #VentaD (Rama)
			CREATE INDEX Categoria  ON #VentaD (Categoria)
			CREATE INDEX Grupo      ON #VentaD (Grupo)
			CREATE INDEX Familia    ON #VentaD (Familia)
			CREATE INDEX Linea      ON #VentaD (Linea)
			CREATE INDEX Fabricante ON #VentaD (Fabricante)

			-- #OfertaActiva
			--CREATE TABLE #OfertaActiva (ID int NOT NULL PRIMARY KEY, MovTipo varchar(20) COLLATE Database_Default NULL)
			CREATE TABLE #OfertaActiva (ID int NOT NULL PRIMARY KEY, Sucursal int NULL, MovTipo varchar(20) COLLATE Database_Default NULL)
			EXEC spOfertaPrecioSugerido @Empresa, @Sucursal, @Moneda, @TipoCambio, @ListaPrecios

			SELECT @ImporteTotalMN = SUM(Cantidad*PrecioSugerido)*@TipoCambio 
			FROM #VentaD
      
			EXEC spOfertaActiva @Empresa, @Sucursal, @FechaHora, @ImporteTotalMN

			EXEC spOfertaProcesar @Empresa, @Sucursal, @Moneda, @TipoCambio, @ListaPrecios, @ID = NULL, @PuntosPrecio=@PuntosPrecio

			UPDATE #VentaD
			SET Descuento = dbo.fnPorcentajeImporte(Cantidad*Precio, DescuentoImporte)
			WHERE NULLIF(DescuentoImporte, 0.0) IS NOT NULL

			UPDATE #VentaD
			SET Puntos = dbo.fnPorcentaje(dbo.fnDisminuyePorcentaje(Cantidad*Precio, Descuento), PuntosPorcentaje)
			WHERE NULLIF(PuntosPorcentaje, 0.0) IS NOT NULL
     
			UPDATE #VentaD
			SET Puntos = Puntos*Cantidad
			WHERE Puntos IS NOT NULL AND NULLIF(PuntosPorcentaje, 0.0) IS NULL

			UPDATE #VentaD
			SET Comision = dbo.fnPorcentaje(dbo.fnDisminuyePorcentaje(Cantidad*Precio, Descuento), ComisionPorcentaje)
			WHERE NULLIF(ComisionPorcentaje, 0.0) IS NOT NULL

			INSERT POSOfertaTemp(
				Estacion, IDR, Articulo, Renglon, PrecioSugerido, 
				Precio, 
				Puntos, Cantidad)
			SELECT
				@Estacion, @ID, t.Articulo, t.Renglon, ISNULL(d.PrecioSugerido, t.PrecioSugerido), 
				t.Precio, ABS(t.Puntos), t.Cantidad
			FROM POSLVenta d 
			JOIN #VentaD t ON t.Renglon = d.Renglon AND t.RenglonSub = d.RenglonSub AND t.RenglonTipo = d.RenglonTipo
			WHERE d.ID = @ID AND d.RenglonTipo <>'C'
			AND t.Puntos IS NOT NULL
			AND t.Puntos < 0
			AND ISNULL(d.Aplicado,0) = 0
		END
  
	RETURN
END
GO


/**************** spPOSOfertaPuntosAplicar ****************/
IF EXISTS (SELECT * FROM sysobjects where id = object_id('dbo.spPOSOfertaPuntosAplicar') and type = 'P') DROP PROCEDURE dbo.spPOSOfertaPuntosAplicar
GO
CREATE PROCEDURE spPOSOfertaPuntosAplicar
	@ID               	varchar(50),
	@OfertaFechaHora	varchar(20)	= NULL,
	@PuntosPrecio       bit = 1,
	@Estacion           int
--//WITH ENCRYPTION
AS 
BEGIN 
	DECLARE
    @Empresa						varchar(5),
    @Mov							varchar(20),
    @Sucursal						int,
    @Usuario						varchar(10),
    @ListaPrecios					varchar(50),
    @FechaHora						datetime,
    @Estatus						varchar(15),
    @FechaEmision					datetime,
    @FechaRequerida					datetime,
    @HoraRequerida					varchar(5),
    @Moneda							varchar(10),
    @TipoCambio						float,
    @DescuentoGlobal				float,
    @ImporteTotalMN					float,
    @Aplica							bit,
    @Monedero						varchar(20)	,
    @CodigoRedondeo					varchar(30),
    @ArticuloRedondeo				varchar(20),
    @ArtOfertaImporte				varchar(20),
    @ArtOfertaFP					varchar(20),
    @CfgAnticipoArticuloServicio	varchar(20)    	
    
	SELECT @CodigoRedondeo = RedondeoVentaCodigo , @ArtOfertaFP = ArtOfertaFP, @ArtOfertaImporte = ArtOfertaImporte
    FROM POSCfg 
	WHERE Empresa = @Empresa
    
	SELECT @ArticuloRedondeo = Cuenta
    FROM CB
    WHERE Codigo = @CodigoRedondeo
    AND TipoCuenta = 'Articulos'
  
	SELECT @ArticuloRedondeo = cb.Cuenta 
	FROM CB 
	WHERE CB.Cuenta = @CodigoRedondeo AND CB.TipoCuenta = 'Articulos'       
    
	SELECT @CfgAnticipoArticuloServicio = NULLIF(CxcAnticipoArticuloServicio,'')    
	FROM EmpresaCfg2
	WHERE Empresa = @Empresa      
    	  
	SELECT @Mov = Mov, @Empresa = Empresa, @Sucursal = Sucursal, @Usuario = Usuario, @Moneda = Moneda, @TipoCambio = TipoCambio, 
		@Estatus = Estatus, @ListaPrecios = ListaPreciosEsp, @FechaEmision = FechaEmision, @FechaRequerida = FechaEmision, @HoraRequerida = '00:00', 
		@DescuentoGlobal = DescuentoGlobal,@Monedero = Monedero
    FROM POSL 
	WHERE ID = @ID        
  
	IF NULLIF(@Monedero,'') IS NOT NULL AND @PuntosPrecio = 1
		SET @PuntosPrecio = 1 
	ELSE
		SET @PuntosPrecio = 0 
     
	SET @Aplica = 1
	EXEC xpPOSOfertaAplicar @ID, @Aplica OUTPUT 
  
	IF @Aplica = 1 
		BEGIN
			IF @OfertaFechaHora IS NULL
				SELECT @OfertaFechaHora = OfertaFechaHora 
				FROM EmpresaCfg2
				WHERE Empresa = @Empresa

			IF UPPER(@OfertaFechaHora) = 'FECHA SERVIDOR'  
				SELECT @FechaHora = GETDATE() 
			ELSE IF UPPER(@OfertaFechaHora) = 'FECHA EMISION'   
				SELECT @FechaHora = @FechaEmision 
			ELSE IF UPPER(@OfertaFechaHora) = 'FECHA REQUERIDA' 
				SELECT @FechaHora = dbo.FechaConHora(@FechaRequerida, @HoraRequerida)
    
			-- #VENTA 
			CREATE TABLE #Venta (Campo varchar(50) COLLATE Database_Default NOT NULL, Valor varchar(100) COLLATE Database_Default NULL)
			EXEC spPOSOfertaVenta @ID
			CREATE INDEX Campo ON #Venta (Campo, Valor)

			-- #VENTAD 
			CREATE TABLE #VentaD (
			RID			int NOT NULL IDENTITY(1,1) PRIMARY KEY,
			Renglon			float NOT NULL, 
			RenglonSub		int NOT NULL, 
			RenglonTipo             varchar(1) NOT NULL,
			Articulo		varchar(20) COLLATE Database_Default NOT NULL, 
			SubCuenta		varchar(50) COLLATE Database_Default NULL, 
			Rama			varchar(20) COLLATE Database_Default NULL, 
			Categoria		varchar(50) COLLATE Database_Default NULL, 
			Grupo			varchar(50) COLLATE Database_Default NULL, 
			Familia			varchar(50) COLLATE Database_Default NULL, 
			Linea			varchar(50) COLLATE Database_Default NULL, 
			Fabricante		varchar(50) COLLATE Database_Default NULL, 
			Proveedor		varchar(10) COLLATE Database_Default NULL, 
			ABC				varchar(50) COLLATE Database_Default NULL,
			Cantidad		float NULL, 
			Unidad		varchar(50) COLLATE Database_Default NULL, 
			CantidadInventario	float NULL, 
			PrecioSugerido	float NULL, 
			Precio		float NULL, 
			Impuesto1				float NULL,
			Descuento		float NULL, 
			DescuentoP1			float NULL,
			DescuentoP2			float NULL,
			DescuentoP3			float NULL,
			DescuentoG1			float NULL,
			DescuentoG2			float NULL,
			DescuentoG3			float NULL,
			DescuentoImporte	float NULL, 
			Puntos		float NULL, 
			PuntosPorcentaje	float NULL, 
			Comision		float NULL, 
			ComisionPorcentaje	float NULL, 
			CantidadObsequio	float NULL, 
			OfertaID				int NULL,
			OfertaIDP1			int NULL,
			OfertaIDP2			int NULL,
			OfertaIDP3			int NULL,
			OfertaIDG1			int NULL,
			OfertaIDG2			int NULL,
			OfertaIDG3			int NULL,
			DescuentoAd			float NULL)

			--SE AGREGA OFERTAID
			CREATE TABLE #ArtObsequio (Articulo varchar(20) COLLATE Database_Default NOT NULL, OfertaID INT NULL, Unidad varchar(50) NULL, SubCuenta varchar(50) NULL)    

			CREATE TABLE #OfertaLog (
			RID					    int NOT NULL IDENTITY(1,1) PRIMARY KEY,
			OfertaID				int NOT NULL,
			Mov						varchar(20)NULL,
			MovID					varchar(20)NULL,
			Prioridad				int NULL,
			PrioridadG			    int NULL,
			Tipo					varchar(50)NULL,
			Forma					varchar(50)NULL,
			Usar					varchar(50)NULL,
			Articulo				varchar(20) COLLATE Database_Default NOT NULL, 
			SubCuenta				varchar(50) COLLATE Database_Default NULL, 
			Unidad				    varchar(50) COLLATE Database_Default NULL, 
			Descuento				float NULL,
			DescuentoImporte		money NULL, 
			Puntos				    float NULL, 
			PuntosPorcentaje		float NULL, 
			Comision				float NULL, 
			ComisionPorcentaje		float NULL, 
			CantidadObsequio		float NULL,
			Costo					float NULL,
			PrecioBaseCosto			float NULL,
			PrecioBaseLista			float NULL,
			Precio				    float NULL,
			ArticuloObsequio		varchar(20)NULL,
			UnidadObsequio			varchar(5) NULL,
			SubCuentaObsequio		varchar(50) NULL,
			ArtTipo				    varchar(20)NULL,
			CantidadOferta			float NULL,
			DescuentoP1			    float NULL,
			DescuentoP2			    float NULL,
			DescuentoP3			    float NULL,
			DescuentoG1			    float NULL,
			DescuentoG2			    float NULL,
			DescuentoG3			    float NULL,
			SucursalDetalle			int	 NULL,
			OfertaIDP1			    int NULL,
			OfertaIDP2			    int NULL,
			OfertaIDP3			    int NULL,
			OfertaIDG1			    int NULL,
			OfertaIDG2			    int NULL,
			OfertaIDG3			    int NULL,
			Descripcion			    varchar(255) NULL)

    
			INSERT #VentaD (
				Renglon, RenglonSub, RenglonTipo, Articulo, SubCuenta, Rama, Categoria, Grupo, Familia, Linea, Fabricante, Proveedor, Cantidad, 
				Unidad, PrecioSugerido, CantidadInventario, OfertaID, 
				OfertaIDP1, OfertaIDP2, OfertaIDP3, OfertaIDG1, OfertaIDG2, OfertaIDG3, DescuentoP1, 
				DescuentoP2, DescuentoP3, DescuentoG1, DescuentoG2, DescuentoG3, Descuento, DescuentoAd) 
			SELECT 
				d.Renglon, d.RenglonSub, d.RenglonTipo,d.Articulo, d.SubCuenta, a.Rama, a.Categoria, a.Grupo, a.Familia, a.Linea, a.Fabricante, a.Proveedor, d.Cantidad,
				d.Unidad, d.PrecioSugerido, ISNULL(ISNULL(d.CantidadInventario, d.Cantidad*dbo.fnArtUnidadFactor(@Empresa, d.Articulo, d.Unidad)), 0.0), d.OfertaID,
				d.OfertaIDP1, d.OfertaIDP2, d.OfertaIDP3, d.OfertaIDG1, d.OfertaIDG2, d.OfertaIDG3, d.DescuentoP1, 
				d.DescuentoP2, d.DescuentoP3, d.DescuentoG1, d.DescuentoG2, d.DescuentoG3, d.DescuentoLinea, d.DescuentoAd
			FROM POSLVenta d
			JOIN Art a ON a.Articulo = d.Articulo
			JOIN POSOfertaTemp t ON d.Renglon = t.Renglon AND d.Articulo = d.Articulo AND d.ID = t.IDR AND t.Estacion = @Estacion
			WHERE d.ID = @ID 
			AND ISNULL(d.Aplicado,0) = 1
			AND t.ID IN(SELECT ID FROM ListaID  WHERE Estacion = @Estacion)
			AND d.Articulo NOT IN(@ArticuloRedondeo,@CfgAnticipoArticuloServicio,@ArtOfertaFP,@ArtOfertaImporte)
			AND d.RenglonTipo <> 'K'
    
			CREATE INDEX Renglon    ON #VentaD (Renglon, RenglonSub)
			CREATE INDEX Articulo   ON #VentaD (Articulo)
			CREATE INDEX Rama       ON #VentaD (Rama)
			CREATE INDEX Categoria  ON #VentaD (Categoria)
			CREATE INDEX Grupo      ON #VentaD (Grupo)
			CREATE INDEX Familia    ON #VentaD (Familia)
			CREATE INDEX Linea      ON #VentaD (Linea)
			CREATE INDEX Fabricante ON #VentaD (Fabricante)

			-- #OfertaActiva
			CREATE TABLE #OfertaActiva (ID int NOT NULL PRIMARY KEY, Sucursal int NULL, MovTipo varchar(20) COLLATE Database_Default NULL)
			EXEC spOfertaPrecioSugerido @Empresa, @Sucursal, @Moneda, @TipoCambio, @ListaPrecios

			SELECT @ImporteTotalMN = SUM(Cantidad*PrecioSugerido)*@TipoCambio FROM #VentaD
      
			EXEC spOfertaActiva @Empresa, @Sucursal, @FechaHora, @ImporteTotalMN

			EXEC spOfertaProcesar @Empresa, @Sucursal, @Moneda, @TipoCambio, @ListaPrecios, @ID = NULL, @PuntosPrecio=@PuntosPrecio

			UPDATE #VentaD
			SET Descuento = dbo.fnPorcentajeImporte(Cantidad*Precio, DescuentoImporte)
			WHERE NULLIF(DescuentoImporte, 0.0) IS NOT NULL

			UPDATE #VentaD
			SET Puntos = dbo.fnPorcentaje(dbo.fnDisminuyePorcentaje(Cantidad*Precio, Descuento), PuntosPorcentaje)
			WHERE NULLIF(PuntosPorcentaje, 0.0) IS NOT NULL
     
			UPDATE #VentaD
			SET Puntos = Puntos*Cantidad
			WHERE Puntos IS NOT NULL AND NULLIF(PuntosPorcentaje, 0.0) IS NULL

			UPDATE #VentaD
			SET Comision = dbo.fnPorcentaje(dbo.fnDisminuyePorcentaje(Cantidad*Precio, Descuento), ComisionPorcentaje)
			WHERE NULLIF(ComisionPorcentaje, 0.0) IS NOT NULL

			IF (SELECT SUM(ISNULL(CantidadObsequio,0)) FROM POSLVenta WHERE ID = @ID) > = 0
				BEGIN  
					UPDATE POSLVenta
					SET PrecioSugerido = ISNULL(d.PrecioSugerido, t.PrecioSugerido),
						Precio = dbo.fnPOSPrecio(@Empresa,ISNULL(t.Precio, t.PrecioSugerido),d.Impuesto1, d.Impuesto2, d.Impuesto3),
						DescuentoLinea = ISNULL(t.Descuento,DescuentoLinea),
						DescuentoP1 = ISNULL(t.DescuentoP1,d.DescuentoP1),
						DescuentoP2 = ISNULL(t.DescuentoP2,d.DescuentoP2),
						DescuentoP3 = ISNULL(t.DescuentoP3,d.DescuentoP3),
						DescuentoG1 = ISNULL(t.DescuentoG1,d.DescuentoG1),
						DescuentoG2 = ISNULL(t.DescuentoG2,d.DescuentoG2),
						DescuentoG3 = ISNULL(t.DescuentoG3,d.DescuentoG3),
						DescuentoImporte = NULL,
						Puntos = t.Puntos,
						Comision = t.Comision,
						CantidadObsequio = t.CantidadObsequio,
						OfertaID = t.OfertaID,
						OfertaIDP1 = t.OfertaIDP1,
						OfertaIDP2 = t.OfertaIDP2,
						OfertaIDP3 = t.OfertaIDP3,
						OfertaIDG1 = t.OfertaIDG1,
						OfertaIDG2 = t.OfertaIDG2,
						OfertaIDG3 = t.OfertaIDG3
					FROM POSLVenta d 
					JOIN #VentaD t ON t.Renglon = d.Renglon AND t.RenglonSub = d.RenglonSub AND t.RenglonTipo = d.RenglonTipo
					WHERE d.ID = @ID AND d.RenglonTipo <>'C' 
					AND ISNULL(d.Aplicado,0) = 1
       
					UPDATE POSLVenta SET PrecioImpuestoInc = dbo.fnPOSPrecioConImpuestos(Precio,Impuesto1, Impuesto2, Impuesto3, @Empresa)
					WHERE ID = @ID AND RenglonTipo <>'C'
					AND ISNULL(Aplicado,0) = 1  
				END         
		END
  
	RETURN
END
GO


/**************** fnPOSValidarImporteMonedero ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidarImporteMonedero') DROP FUNCTION fnPOSValidarImporteMonedero
GO
CREATE FUNCTION dbo.fnPOSValidarImporteMonedero (
	@ID				varchar(36),
	@Estacion		int,
	@Disponible		float
) 
RETURNS varchar(100)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado  varchar(100),
    @Puntos     float
    
	SELECT @Puntos = SUM(Puntos) 
	FROM POSOfertaTemp 
	WHERE IDR = @ID AND Estacion = @Estacion AND ID IN(SELECT ID FROM ListaID  WHERE Estacion = @Estacion)
   
	IF @Puntos > @Disponible
		SELECT @Resultado = 'La Cantidad  a Aplicar es Mayor Al Saldo Disponible '
	ELSE
		SELECT @Resultado = NULL  

	RETURN (@Resultado)
END
GO


/**************** fnPOSValidarImporteMonedero2 ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidarImporteMonedero2') DROP FUNCTION fnPOSValidarImporteMonedero2
GO
CREATE FUNCTION dbo.fnPOSValidarImporteMonedero2 (
	@ID				varchar(36),
	@Estacion		int,
	@Disponible		float
) 
RETURNS varchar(100)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado  varchar(100),
    @Puntos     float
    
	SELECT @Puntos = SUM(Puntos*ISNULL(CantidadM,0.0)) 
	FROM POSOfertaTempD 
	WHERE IDR = @ID AND Estacion = @Estacion AND ID IN(SELECT ID FROM ListaID  WHERE Estacion = @Estacion)
   
	IF @Puntos > @Disponible
		SELECT @Resultado = 'La Cantidad  a Aplicar es Mayor A la Disponible '
	ELSE
		SELECT @Resultado = NULL  
  
	RETURN (@Resultado)
END
GO


/************************ spPOSArtPrecioRecalcular *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSArtPrecioRecalcular') AND type = 'P') DROP PROCEDURE dbo.spPOSArtPrecioRecalcular
GO             
CREATE PROCEDURE spPOSArtPrecioRecalcular
	@ID			varchar(36),
    @Estacion	int
--//WITH ENCRYPTION            
AS 
BEGIN
	DECLARE @EnviarA				int,
  	@Politica						varchar(max),
	@DescuentoMonto					float,
	@DescuentoMontoPorcentaje		float,
	@Articulo						varchar(20),
    @Cantidad						float,
    @Unidad							varchar(50),
    @Precio							float,
    @DescuentoLinea					float,
    @VentaID						int,
    @SubCuenta						varchar(50),
    @FechaEmision					Datetime,
    @Agente							varchar(10),
    @Moneda							varchar(10), 
    @TipoCambio						float,
    @Renglon						float,
    @Condicion						varchar(50),
    @Almacen						varchar(10),
    @Proyecto						varchar(50),
    @FormaEnvio						varchar(50),
    @Mov							varchar(20),
    @ServicioTipo					varchar(50),
    @ContratoTipo					varchar(50),
    @Empresa						varchar(50),
    @Region							varchar(50),
    @Sucursal						int,
    @ListaPreciosEsp				varchar(20),
    @Cliente						varchar(10),                
    @PrecioConDescuento				bit,
    @GetListaPreciosCliente			bit,
    @Juego							varchar(10),
    @OFER							bit,
    @RenglonTipo					varchar(10),
    @RenglonID						int,
    @ArticuloPrincipal				varchar(20),
    @PrecioIndependiente			bit,
    @PrecioImpuestoInc				float,
    @Impuesto1						float,
    @Impuesto2						float,
    @Impuesto3						float,
    @CodigoRedondeo					varchar(30),
    @ArticuloRedondeo				varchar(20),
    @ArtOfertaImporte				varchar(20),
    @ArtOfertaFP					varchar(20),
    @CfgAnticipoArticuloServicio	varchar(20),
    @ZonaImpuesto					varchar(50),
    @DescuentoGlobal				float,
    @AplicaDescGlobal				bit
          
	SELECT	@FechaEmision = FechaEmision, 
			@Agente = Agente, 
			@Moneda = Moneda, 
			@TipoCambio = TipoCambio, 
			@Condicion = Condicion,           		     
			@Almacen = Almacen, 
			@Proyecto = Proyecto,
			@FormaEnvio = FormaEnvio, 
			@Mov = Mov, 
			@Empresa = Empresa, 
			@Sucursal = Sucursal, 
			@ListaPreciosEsp = ListaPreciosEsp, 
			@Cliente = Cliente  ,
			@ZonaImpuesto = ZonaImpuesto,
			@DescuentoGlobal = ISNULL(DescuentoGlobal,0)
	  FROM  POSL WITH (NOLOCK) 
	 WHERE  ID = @ID
    
    SET @AplicaDescGlobal = 0 
    
	IF @DescuentoGlobal > 0 
		SELECT @AplicaDescGlobal = 1
            
	SELECT @OFER = ISNULL(OFER,1)
      FROM EmpresaGral
     WHERE Empresa = @Empresa   
     
	SELECT @CodigoRedondeo = pc.RedondeoVentaCodigo
      FROM POSCfg pc
     WHERE pc.Empresa = @Empresa
    
	SELECT @CodigoRedondeo = RedondeoVentaCodigo , @ArtOfertaFP = ArtOfertaFP, @ArtOfertaImporte = ArtOfertaImporte
    FROM POSCfg 
	WHERE Empresa = @Empresa
    
	SELECT @ArticuloRedondeo = Cuenta
    FROM CB
    WHERE Codigo = @CodigoRedondeo
    AND TipoCuenta = 'Articulos'
  
	SELECT @ArticuloRedondeo = cb.Cuenta 
	FROM CB 
	WHERE CB.Cuenta = @CodigoRedondeo AND CB.TipoCuenta = 'Articulos'       
    
	SELECT @CfgAnticipoArticuloServicio = NULLIF(CxcAnticipoArticuloServicio,'')    
	FROM EmpresaCfg2
	WHERE Empresa = @Empresa         
   
	IF @OFER = 1
	BEGIN
			DECLARE crArticulo CURSOR FOR
			SELECT v.Renglon, v.Articulo, v.Cantidad, v.Unidad, v.DescuentoLinea, v.SubCuenta, v.RenglonTipo, v.RenglonID, v.Juego, 
				a.Impuesto1, a.Impuesto2, a.Impuesto3
			FROM POSLVenta v JOIN Art a ON a.Articulo = v.Articulo
			WHERE v.ID = @ID 
			AND v.Articulo NOT IN(@ArticuloRedondeo,@CfgAnticipoArticuloServicio,@ArtOfertaFP)

			OPEN crArticulo
			FETCH NEXT FROM crArticulo INTO @Renglon, @Articulo, @Cantidad, @Unidad, @DescuentoLinea, @SubCuenta, @RenglonTipo, @RenglonID, @Juego,
				@Impuesto1, @Impuesto2, @Impuesto3
			WHILE @@FETCH_STATUS <> -1 
				BEGIN 
					IF @RenglonTipo <> 'C'       	
						EXEC spPOSArtPrecio @Articulo = @Articulo, @Cantidad = @Cantidad, @UnidadVenta = @Unidad, @Precio = @Precio OUTPUT, 
							@Descuento = @DescuentoLinea OUTPUT, @SubCuenta = @SubCuenta, @FechaEmision = @FechaEmision, @Agente = @Agente, 
							@Moneda = @Moneda, @TipoCambio = @TipoCambio, @Condicion = @Condicion, @Almacen = @Almacen, @Proyecto = @Proyecto, 
							@FormaEnvio = @FormaEnvio, @Mov = @Mov, @Empresa = @Empresa, @Sucursal = @Sucursal, @ListaPreciosEsp = @ListaPreciosEsp, 
							@Cliente = @Cliente, @VentaID = @ID
					ELSE
						SELECT @Precio = 0.0
	
					SELECT @Precio = dbo.fnPOSPrecio(@Empresa,@Precio,@Impuesto1,@Impuesto2,@Impuesto3)
					SELECT @PrecioImpuestoInc = dbo.fnPOSPrecioConImpuestos(@Precio,@Impuesto1,@Impuesto2,@Impuesto3, @Empresa)

					EXEC spZonaImp @ZonaImpuesto, @Impuesto1 OUTPUT
					EXEC spZonaImp @ZonaImpuesto, @Impuesto2 OUTPUT
					EXEC spZonaImp @ZonaImpuesto, @Impuesto3 OUTPUT
					EXEC spTipoImpuesto 'POS', 0, @Mov, @FechaEmision, @Empresa, @Sucursal, NULL, NULL, @Articulo = @Articulo, @EnSilencio = 1, 
						@Impuesto1 = @Impuesto1 OUTPUT, @Impuesto2 = @Impuesto2 OUTPUT, @Impuesto3 = @Impuesto3 OUTPUT      

					UPDATE POSLVenta 
					SET  Impuesto1 = @Impuesto1, Impuesto2 = @Impuesto2, Impuesto3 = @Impuesto3, 
					Precio = @Precio, PrecioSugerido = NULL, PrecioImpuestoInc = @PrecioImpuestoInc  
					WHERE ID = @ID  AND Renglon = @Renglon AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')
         
					SELECT @Precio = NULL, @DescuentoLinea = NULL, @PrecioImpuestoInc = NULL
      
					FETCH NEXT FROM crArticulo INTO @Renglon, @Articulo, @Cantidad, @Unidad, @DescuentoLinea, @SubCuenta, @RenglonTipo, @RenglonID, @Juego,
						@Impuesto1, @Impuesto2, @Impuesto3
				END 
			CLOSE crArticulo
			DEALLOCATE crArticulo 

			UPDATE POSLVenta SET CantidadObsequio = NULL,
				DescuentoLinea = NULL,
				OfertaID = NULL,
				Puntos = NULL,
				OfertaIDG1 = NULL,
				OfertaIDG2 = NULL,
				OfertaIDG3 = NULL,
				OfertaIDP1 = NULL,
				OfertaIDP2 = NULL,
				OfertaIDP3 = NULL,
				DescuentoG1 = NULL,
				DescuentoG2 = NULL,
				DescuentoG3 = NULL,
				DescuentoP1 = NULL,
				DescuentoP2 = NULL,
				DescuentoP3 = NULL,
				AplicaDescGlobal = @AplicaDescGlobal
			WHERE ID = @ID 

			EXEC spPOSOfertaAplicar	@ID
			EXEC spPOSOfertaPuntosInsertarTemp @ID, NULL, 1, @Estacion
	END     
	ELSE
	BEGIN       
			DECLARE crArticulo CURSOR FOR
			SELECT v.Renglon, v.Articulo, v.Cantidad, v.Unidad, v.DescuentoLinea, v.SubCuenta, v.RenglonTipo, v.RenglonID, v.Juego, a.Impuesto1, a.Impuesto2, a.Impuesto3
			FROM POSLVenta v JOIN Art a ON a.Articulo = v.Articulo
			WHERE v.ID = @ID 
			AND v.Articulo NOT IN(@ArticuloRedondeo,@CfgAnticipoArticuloServicio,@ArtOfertaFP)

			OPEN crArticulo
			FETCH NEXT FROM crArticulo INTO @Renglon, @Articulo, @Cantidad, @Unidad, @DescuentoLinea, @SubCuenta, @RenglonTipo, @RenglonID, @Juego,
				@Impuesto1, @Impuesto2, @Impuesto3
			WHILE @@FETCH_STATUS <> -1 
				BEGIN     
					EXEC spZonaImp @ZonaImpuesto, @Impuesto1 OUTPUT
					EXEC spZonaImp @ZonaImpuesto, @Impuesto2 OUTPUT
					EXEC spZonaImp @ZonaImpuesto, @Impuesto3 OUTPUT

					EXEC spTipoImpuesto 'POS', 0, @Mov, @FechaEmision, @Empresa, @Sucursal, NULL, NULL, @Articulo = @Articulo, @EnSilencio = 1, 
						@Impuesto1 = @Impuesto1 OUTPUT, @Impuesto2 = @Impuesto2 OUTPUT, @Impuesto3 = @Impuesto3 OUTPUT      
    
					SELECT @Precio = 0.0
				
					IF @RenglonTipo = 'C'
						BEGIN
							SELECT @ArticuloPrincipal = MAX(Articulo) 
							FROM POSLVenta 
							WHERE ID = @ID AND RenglonID = @RenglonID AND RenglonTipo = 'J'
							
							SELECT @PrecioIndependiente = ISNULL(PrecioIndependiente,0)
							FROM ArtJuego 
							WHERE Articulo = @ArticuloPrincipal AND Juego = @Juego        
						END

					IF ISNULL(@PrecioIndependiente,0) = 1 OR @RenglonTipo <> 'C'
						EXEC spPOSArtPrecio @Articulo = @Articulo, @Cantidad = @Cantidad, @UnidadVenta = @Unidad, @Precio = @Precio OUTPUT, 
							@Descuento = @DescuentoLinea OUTPUT, @SubCuenta = @SubCuenta, @FechaEmision = @FechaEmision, @Agente = @Agente, @Moneda = @Moneda, 
							@TipoCambio = @TipoCambio, @Condicion = @Condicion, @Almacen = @Almacen, @Proyecto = @Proyecto, @FormaEnvio = @FormaEnvio, @Mov = @Mov, 
							@Empresa = @Empresa, @Sucursal = @Sucursal, @ListaPreciosEsp = @ListaPreciosEsp, @Cliente = @Cliente, @VentaID = @ID
					ELSE
						SELECT @Precio = 0.0

					SELECT @Precio = dbo.fnPOSPrecio(@Empresa,@Precio,@Impuesto1,@Impuesto2,@Impuesto3)
					SELECT @PrecioImpuestoInc = dbo.fnPOSPrecioConImpuestos(@Precio,@Impuesto1,@Impuesto2,@Impuesto3, @Empresa)

					UPDATE POSLVenta 
					SET Precio = @Precio, DescuentoLinea = ISNULL(@DescuentoLinea,DescuentoLinea), PrecioImpuestoInc = @PrecioImpuestoInc, 
					Impuesto1 = @Impuesto1, Impuesto2 = @Impuesto2, Impuesto3 = @Impuesto3, AplicaDescGlobal = @AplicaDescGlobal
					WHERE ID = @ID AND Renglon = @Renglon AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')
            
					FETCH NEXT FROM crArticulo INTO @Renglon, @Articulo, @Cantidad, @Unidad, @DescuentoLinea, @SubCuenta, @RenglonTipo, @RenglonID, @Juego,
						@Impuesto1, @Impuesto2, @Impuesto3
				END 
			CLOSE crArticulo
			DEALLOCATE crArticulo 
	END  
END
GO  


/************************ spPOSInsertarArtComponentes *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarArtComponentes') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarArtComponentes
GO             
CREATE PROCEDURE spPOSInsertarArtComponentes
	@Estacion		int,
	@ID				varchar(36),
	@Empresa		char(5),
	@Sucursal		int,
	@RenglonId		int,
    @Articulo		char(20), 
	@Cantidad		float,
	@CantidadJ		float = 1	     	     
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @Almacen					char(10), 
    @FechaRequerida				datetime, 
    @MovMoneda					char(10), 
    @MovTipoCambio				float,
    @Renglon					float,
    @AutoLocalidad				char(5) ,  
    @Opcion						varchar(20),
    @CantidadD					float,
    @CantidadInventario         float,
    @PrecioIndependiente		bit, 
    @ListaPreciosEsp 			varchar(50),
    @Unidad						varchar(50),
    @Precio						float,
    @CfgMultiUnidades	        bit,
    @CfgMultiUnidadesNivel      char(20),
    @CfgInvRegistrarPrecios		bit,
    @ZonaImpuesto				varchar(50),
    @Impuesto1					float,
    @Impuesto2					float,
    @Impuesto3					money,
    @FechaEmision				datetime,
    @Contacto					varchar(10),
    @EnviarA					int,
    @Mov						varchar(20),
    @Juego                      varchar(10),
    @SubCuenta                  varchar(50),
    @CantidadTotal              float,
    @Recalcular                 bit,
    @EsDevolucion               bit,
    @PrecioImpuestoInc          float,
	@ArTipo						varchar(20),
	@IDDevolucionP				varchar(36),
	@Contador					int,
	@Orden						int

	CREATE TABLE #OrdenTemporal (IDPos varchar(36), Orden int) 

	SELECT @ZonaImpuesto = NULL
	SELECT @Mov = pl.Mov, @ZonaImpuesto = ISNULL(u.DefZonaImpuesto,c.ZonaImpuesto), @FechaEmision = pl.FechaEmision, @Contacto = pl.Cliente, @EnviarA = pl.EnviarA 
    FROM POSL pl JOIN Usuario u  ON pl.Usuario = u.Usuario JOIN Cte c ON pl.Cliente = c.Cliente
	WHERE pl.ID = @ID
   
	SELECT @Cantidad = Cantidad FROM POSLVenta WHERE ID = @ID AND Articulo = @Articulo AND RenglonID = @RenglonId AND RenglonTipo = 'J'   
	SELECT 
		@CfgMultiUnidades = MultiUnidades,
		@CfgMultiUnidadesNivel  = ISNULL(UPPER(NivelFactorMultiUnidad), 'UNIDAD'),
        @CfgInvRegistrarPrecios = ISNULL(InvRegistrarPrecios, 0) 
    FROM EmpresaCfg2 
	WHERE Empresa = @Empresa

	SELECT 
		@Almacen = Almacen,	
        @FechaRequerida = FechaEmision,	
        @MovMoneda = Moneda,
        @MovTipoCambio	= TipoCambio
    FROM POSL
	WHERE ID = @ID 	   

	DECLARE crJuegoOmision CURSOR FOR
	SELECT p.Opcion, ABS(p.CantidadComponente), CONVERT(bit, j.PrecioIndependiente), NULLIF(RTRIM(j.ListaPreciosEsp), ''), a.Unidad, 
	a.Impuesto1, a.Impuesto2, a.Impuesto3, p.Juego, p.SubCuenta, ISNULL(p.Recalcular,0), ISNULL(p.EsDevolucion,0), a.Tipo
    FROM Art a JOIN POSArtJuegoComponente p ON a.Articulo = p.Opcion
    JOIN ArtJuego j ON p.Articulo = j.Articulo AND p.Juego = j.Juego
    WHERE p.RID = @ID AND p.Estacion = @Estacion

	OPEN crJuegoOmision
	FETCH NEXT FROM crJuegoOmision INTO @Opcion, @CantidadD, @PrecioIndependiente, @ListaPreciosEsp, @Unidad, 
		@Impuesto1, @Impuesto2, @Impuesto3, @Juego, @SubCuenta, @Recalcular, @EsDevolucion, @ArTipo
	WHILE @@FETCH_STATUS <> -1 
		BEGIN
			IF @EsDevolucion = 1
				SET @CantidadD = (@CantidadD * -1)
     
			SELECT @Renglon = MAX(Renglon) 
			FROM POSLVenta 
			WHERE ID = @ID 
			
			SELECT @Renglon = @Renglon + 2048.0, @Precio = NULL
     
			IF @PrecioIndependiente = 1
				EXEC spPCGet @Sucursal, @Empresa, @Opcion, NULL, @Unidad, @MovMoneda, @MovTipoCambio, @ListaPreciosEsp, @Precio OUTPUT
			ELSE 
				SELECT @Precio = 0.0  
     
			EXEC spZonaImp @ZonaImpuesto, @Impuesto1 OUTPUT
			EXEC spZonaImp @ZonaImpuesto, @Impuesto2 OUTPUT
			EXEC spZonaImp @ZonaImpuesto, @Impuesto3 OUTPUT
     
			EXEC spTipoImpuesto 'POS', NULL, @Mov, @FechaEmision, @Empresa, @Sucursal, @Contacto, @EnviarA, @Articulo = @Articulo, @EnSilencio = 1, 
				@Impuesto1 = @Impuesto1 OUTPUT, @Impuesto2 = @Impuesto2 OUTPUT, @Impuesto3 = @Impuesto3 OUTPUT

			EXEC xpCantidadInventario @Articulo, NULL, @Unidad, @CfgMultiUnidades, @CfgMultiUnidadesNivel, @CantidadD, @CantidadInventario OUTPUT
     
			SELECT @Precio = dbo.fnPOSPrecio(@Empresa,@Precio,@Impuesto1,@Impuesto2,@Impuesto3)
			SELECT @PrecioImpuestoInc = dbo.fnPOSPrecioConImpuestos(@Precio,@Impuesto1,@Impuesto2,@Impuesto3, @Empresa)
     
			IF NOT EXISTS (SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo = @Opcion AND SubCuenta = @SubCuenta 
						   AND RenglonID = @RenglonId AND RenglonTipo = 'C' AND Juego = @Juego)
				INSERT POSLVenta (
					ID, Renglon, RenglonID, RenglonTipo, Articulo, Cantidad, CantidadInventario, Unidad, Impuesto1, Impuesto2, Impuesto3, Precio, Juego, 
					SubCuenta, PrecioImpuestoInc, Almacen) 
				SELECT
					@ID, @Renglon, @RenglonID, 'C', @Opcion, CASE WHEN @Recalcular = 1 
																	THEN (@Cantidad* @CantidadD)*@CantidadJ 
																  ELSE @CantidadD*@CantidadJ 
																  END, @CantidadInventario*@CantidadJ, @Unidad, @Impuesto1, @Impuesto2, @Impuesto3, @Precio, @Juego, 
					@SubCuenta, @PrecioImpuestoInc, @Almacen
			ELSE 
				UPDATE  POSLVenta SET Cantidad = Cantidad+@CantidadD, CantidadInventario = CantidadInventario +@CantidadD
				WHERE ID = @ID AND Articulo = @Opcion AND SubCuenta = @SubCuenta AND RenglonID = @RenglonId AND Juego = @Juego
			
			IF @EsDevolucion = 1 and @ArTipo in ('Serie', 'Lote')
			BEGIN
				SELECT @IDDevolucionP = NULLIF(IDDevolucionP,'') FROM POSL WHERE ID = @ID
				IF @IDDevolucionP IS NOT NULL
				BEGIN
					DELETE FROM #OrdenTemporal
					SET @Contador = 1
					WHILE (@Contador <= ABS(@CantidadD))
					BEGIN
						SET @Orden = NULL

						SELECT TOP 1 @Orden = Orden 
						  FROM POSLSerieLote 
						 WHERE ID = @IDDevolucionP 
						   AND Articulo = @Opcion 
						   AND SubCuenta = ISNULL(@SubCuenta,'')
						   AND Orden NOT IN (SELECT Orden FROM #OrdenTemporal WHERE IDPos = @IDDevolucionP )
						   AND Orden NOT IN (SELECT OrdenDPRef FROM POSLSerieLote WITH (NOLOCK) WHERE ID = @ID)

						IF @Orden IS NOT NULL
						BEGIN
							INSERT INTO #OrdenTemporal (IDPos, Orden) VALUES (@IDDevolucionP, @Orden)

							INSERT INTO POSLSerieLote(ID,  RenglonID, Articulo, SubCuenta,	SerieLote, OrdenDPRef)
							SELECT					  @ID, @RenglonId, Articulo, SubCuenta,	SerieLote, Orden
							  FROM POSLSerieLote 
							 WHERE ID = @IDDevolucionP
							   AND Orden = @Orden
						END
						
						SET @Contador = @Contador + 1
					END
				END
				
			END

			    
   
			FETCH NEXT FROM crJuegoOmision INTO @Opcion, @CantidadD, @PrecioIndependiente, @ListaPreciosEsp, @Unidad, @Impuesto1, @Impuesto2, @Impuesto3, @Juego,
				@SubCuenta, @Recalcular,  @EsDevolucion, @ArTipo
		END
	CLOSE crJuegoOmision
	DEALLOCATE crJuegoOmision

	--IF @CantidadJ IS NOT NULL
	--	UPDATE POSLVenta SET Cantidad = @CantidadJ WHERE ID = @ID AND Articulo = @Articulo AND RenglonID = @RenglonId AND RenglonTipo = 'J'
      		
	RETURN		
END
GO


/**************** fnPOSValidarComponenteCB ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidarComponenteCB') DROP FUNCTION fnPOSValidarComponenteCB
GO
CREATE FUNCTION dbo.fnPOSValidarComponenteCB (
	@ID				varchar(36), 
	@Estacion		int, 
	@RenglonID		int
) 
RETURNS int
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado  int
    
	SET @Resultado = 0
	IF EXISTS( SELECT * FROM POSArtJuegoComponente WHERE   RID = @ID  AND Estacion = @Estacion AND RenglonID = @RenglonID 
			   AND NULLIF(Opcion,'') IS  NULL AND Juego IS NOT  NULL)
		SELECT @Resultado = 1
  
	RETURN (@Resultado)
END
GO

       
/************************ spPOSGenerarComponenteCB *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSGenerarComponenteCB') AND type = 'P') DROP PROCEDURE dbo.spPOSGenerarComponenteCB
GO             
CREATE PROCEDURE spPOSGenerarComponenteCB
	@ID						varchar(36),
    @Codigo					varchar(50),
    @Estacion				int,
    @ArticuloPrincipal		varchar(20),
    @RenglonID				int
--//WITH ENCRYPTION                         
AS 
BEGIN
	DECLARE 
	@Ok         int,
	@Mensaje	varchar(255)

    EXEC spPOSInsertaComponenteCB @ID, @Codigo, @Estacion, @ArticuloPrincipal, @RenglonID , 0, @Mensaje OUTPUT
        
    IF @Mensaje IS NULL 
		SELECT @Mensaje = 'INGRESE EL NUEVO COMPONENTE'

    SELECT @Mensaje
END
GO            
      
            
/************************ spPOSVerificaComponenteCB *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSVerificaComponenteCB') AND type = 'P') DROP PROCEDURE dbo.spPOSVerificaComponenteCB
GO             
CREATE PROCEDURE spPOSVerificaComponenteCB
	@ID                 varchar(36),
    @Estacion           int,
    @Codigo             varchar(50),
    @ArticuloPrincipal  varchar(20),
    @RenglonID          int,
    @Articulo           varchar(20),
    @SubCuenta          varchar(50),
    @Numero             int,
    @Mensaje            varchar(255) OUTPUT
--//WITH ENCRYPTION            
AS 
BEGIN
	DECLARE 
	@Ok                 int,
	@Juego2             varchar(10),
	@Juego3             varchar(10),
	@Opcion2			varchar(20),
	@SubCuenta2		    varchar(50),
	@Inserto            bit

	DECLARE @Tabla table (
		Juego	varchar(20))
 
	DECLARE @TablaD table(
		ID             int,
		Juego          varchar(20),
		Opcion         varchar(20),
		SubCuenta      varchar(50))
 
	SET @Inserto = 0
  
	INSERT @Tabla(Juego)
	SELECT Juego
    FROM POSArtComponente 
	WHERE  ArticuloP = @ArticuloPrincipal AND Articulo = @Articulo AND SubCuenta = @SubCuenta
   
	IF @@ERROR <> 0 
		SET @Ok = 1
   
	INSERT @TablaD(
		ID, Juego, Opcion, SubCuenta)
	SELECT
		a.ID, a.Juego, a.Opcion, a.SubCuenta
    FROM POSArtJuegoComponente a
	WHERE  NULLIF(a.Opcion,'') IS NOT NULL AND a.Estacion = @Estacion AND a.RID = @ID AND Articulo = @ArticuloPrincipal 
	AND RenglonID = @RenglonID AND a.Opcional = 1 AND a.Juego IN(SELECT Juego FROM @Tabla)   
  
	IF @@ERROR <> 0 
		SET @Ok = 1     
  
	IF EXISTS(SELECT a.Opcion FROM POSArtJuegoComponente a WHERE NULLIF(a.Opcion,'') IS NOT NULL AND a.Estacion = @Estacion 
			  AND a.RID = @ID AND Articulo = @ArticuloPrincipal AND RenglonID = @RenglonID AND a.Opcional = 1 
              AND a.Juego IN(SELECT Juego FROM @Tabla) AND (SELECT COUNT(Juego) FROM POSArtComponente WHERE  ArticuloP = @ArticuloPrincipal 
															AND Articulo = a.Articulo AND SubCuenta = a.SubCuenta)>1)
		BEGIN
			DECLARE crJuegoComponente CURSOR FOR
			SELECT a.Juego, a.Opcion, a.SubCuenta
			FROM POSArtJuegoComponente a
			WHERE NULLIF(a.Opcion,'') IS NOT NULL AND a.Estacion = @Estacion AND a.RID = @ID AND Articulo = @ArticuloPrincipal 
			AND RenglonID = @RenglonID AND a.Opcional = 1 
			AND a.Juego IN(SELECT Juego FROM @Tabla)
    
			OPEN crJuegoComponente
			FETCH NEXT FROM crJuegoComponente INTO  @Juego2, @Opcion2, @SubCuenta2
			WHILE @@FETCH_STATUS <> -1 AND @Inserto = 0 AND @Ok IS NULL
				BEGIN    
					SELECT TOP 1 @Juego3 = a.Juego  
					FROM POSArtJuegoComponente a
					WHERE NULLIF(a.Opcion,'') IS NULL AND a.Estacion = @Estacion AND a.RID = @ID 
					AND Articulo = @ArticuloPrincipal AND RenglonID = @RenglonID
					AND @Opcion2 IN (SELECT Articulo FROM POSArtComponente WHERE  ArticuloP = @ArticuloPrincipal 
									 AND Juego = a.Juego AND SubCuenta = @SubCuenta2)
					AND a.Opcional = 1
					AND a.Juego <> @Juego2

					IF @Juego3 IS NOT NULL
						BEGIN
							UPDATE POSArtJuegoComponente 
							SET ArtSubCuenta = CASE WHEN NULLIF(@SubCuenta2,'') IS NOT NULL 
														THEN @Opcion2+' ('+@SubCuenta2+')' 
													ELSE @Opcion2 
													END, Opcion = @Opcion2, SubCuenta = @SubCuenta2
							WHERE RID = @ID AND Juego = @Juego3 AND Estacion = @Estacion
         
							IF @@ROWCOUNT > 1
								SET @Inserto = 1  
         
							IF @@ERROR <> 0 
								SET @Ok = 1  
         
							UPDATE POSArtJuegoComponente 
							SET ArtSubCuenta = NULL, Opcion = NULL, SubCuenta = NULL
							WHERE RID = @ID AND Juego = @Juego2 AND Estacion = @Estacion 
						END  
    
					FETCH NEXT FROM crJuegoComponente INTO @Juego2, @Opcion2, @SubCuenta2 
				END
			CLOSE crJuegoComponente
			DEALLOCATE crJuegoComponente  
		END 
  
	IF @Ok IS NULL AND @Numero < 10
		EXEC spPOSInsertaComponenteCB @ID, @Codigo, @Estacion, @ArticuloPrincipal, @RenglonID, @Numero, @Mensaje OUTPUT 
END
GO               
            

/************************ spPOSInsertaComponenteCB *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertaComponenteCB') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertaComponenteCB
GO             
CREATE PROCEDURE spPOSInsertaComponenteCB
	@ID						varchar(36),
    @Codigo					varchar(50),
    @Estacion				int,
    @ArticuloPrincipal		varchar(20),
    @RenglonID				int,
    @Numero					int = 0,
    @Mensaje				varchar(255) OUTPUT
--//WITH ENCRYPTION            
AS 
BEGIN
	DECLARE   
	@Articulo           varchar(20),
	@SubCuenta			varchar(50),
	@Ok                 int,
	@Juego              varchar(10),
	@JuegoC             varchar(10)
  
	SET @Numero = ISNULL(@Numero,0) + 1
  
	SELECT @Mensaje = NULL,@Ok = NULL
  
	IF NULLIF(@Codigo,'') IS NULL 
		RETURN
   
	SELECT @Articulo = Cuenta, @SubCuenta = NULLIF(SubCuenta,'')
    FROM CB
	WHERE Codigo = @Codigo
    AND TipoCuenta = 'Articulos'  
     
	SELECT @Juego = MAX(Juego) 
    FROM POSArtComponente      
	WHERE ArticuloP = @ArticuloPrincipal 
      
	IF NOT EXISTS(SELECT * FROM POSArtComponente WHERE ArticuloP = @ArticuloPrincipal AND Articulo = @Articulo AND SubCuenta = @SubCuenta )
		SELECT @Ok = 4, @Mensaje = 'EL ARTICULO NO CORRESPONDE AL JUEGO'

	IF @Ok IS NULL
		BEGIN
			SELECT TOP 1 @JuegoC = a.Juego  
			FROM POSArtJuegoComponente a
			WHERE NULLIF(a.Opcion,'') IS NULL AND a.Estacion = @Estacion AND a.RID = @ID AND Articulo = @ArticuloPrincipal AND RenglonID = @RenglonID
			AND @Articulo IN (SELECT Articulo FROM POSArtComponente WHERE  ArticuloP = @ArticuloPrincipal AND Juego = a.Juego AND SubCuenta = @SubCuenta)
			AND a.Opcional = 1
      
			IF @JuegoC IS NOT NULL
				UPDATE POSArtJuegoComponente SET ArtSubCuenta = CASE WHEN NULLIF(@SubCuenta,'') IS NOT NULL 
																		THEN @Articulo+' ('+@SubCuenta+')' 
																	 ELSE @Articulo 
																	 END, Opcion = @Articulo, SubCuenta = @SubCuenta
				WHERE RID = @ID AND Juego = @JuegoC AND Estacion = @Estacion
			ELSE 
				IF @JuegoC IS  NULL   
					EXEC spPOSVerificaComponenteCB @ID, @Estacion, @Codigo, @ArticuloPrincipal, @RenglonID ,@Articulo, @SubCuenta, @Numero, @Mensaje OUTPUT
		END
END
GO  


/**************** fnPOSSepararCadenaVFA ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSSepararCadenaVFA') DROP FUNCTION fnPOSSepararCadenaVFA
GO
CREATE FUNCTION fnPOSSepararCadenaVFA (
	@Expresion		varchar(max)
)
RETURNS @Tabla TABLE (Parametro varchar(max), Valor varchar(max),Cadena varchar(max))
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @Resultado				varchar(8000),
    @Longitud				bigint,
    @Contador				bigint,
    @Caracter				char(1),
    @Estado					int,
    @EstadoAnterior			int,
    @Variable				varchar(255),
    @Valor					varchar(8000),
    @Tipo					varchar(50),
    @Posicion               int,
    @IDOpcion               int,
    @Cadena                 varchar(max),
    @Lcadena                int,
    @PosicionCaracter		int
    
	SET @Resultado = ''
    
	IF NULLIF(@Expresion,'') IS NULL 
		RETURN 

	SET @Longitud = LEN(@Expresion)
	SET @Contador = 1
	SET @Estado = 0
	SET @Variable = ''
    
	WHILE @Contador <= @Longitud 
		BEGIN
			SET @EstadoAnterior = @Estado
			SET @Caracter = SUBSTRING(@Expresion,@Contador,1)
    
			IF @Estado = 0 AND @Caracter ='&'   
				SET @Estado =1
			IF @Estado = 0 AND @Contador = @Longitud 
				SET @Estado =3

			IF @Estado IN( 0,3) 
				SELECT @Variable = @Variable + @Caracter
    
			IF @Estado IN( 1,3)
				BEGIN
					INSERT @Tabla(
						Cadena)
					SELECT
						 @Variable

					SET @Estado = 0
					SELECT @Variable = ''
				END     
			
			SET @Contador = @Contador + 1
		END 
    
	UPDATE @Tabla SET Parametro = SUBSTRING(Cadena,1,CHARINDEX('=',Cadena)-1)     
    UPDATE @Tabla SET Valor = REPLACE(Cadena,Parametro+'=','')
     
	RETURN 
END
GO


/************************ spPOSVFAVerificar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSVFAVerificar') AND type = 'P') DROP PROCEDURE dbo.spPOSVFAVerificar
GO             
CREATE PROCEDURE spPOSVFAVerificar
	@IDPOS		varchar(36)
--//WITH ENCRYPTION	     
AS 
BEGIN	     
	DECLARE 
	@ID                      int,
    @Referencia              varchar(50), 
	@Accion                  varchar(20), 
	@CodigoAutorizacion      varchar(255),
	@EstatusTransaccion      varchar(255),
    @FechaTransaccion        datetime,    
	@IDTransaccion           varchar(255),
	@Monto                   float,       
	@Moneda                  varchar(20), 
    @NumeroTarjeta           varchar(255),
	@Tarjetahabiente         varchar(500),
	@Error                   varchar(20), 
	@Mensaje                 varchar(max),
    @TransaccionOriginal     varchar(255)
          
	SELECT  @ID = MAX(ID) 
	FROM POSVFALog 
	WHERE IDModulo = @IDPOS AND Modulo = 'POS'   
       
	SELECT  @Referencia = Referencia, @Accion = Accion, @CodigoAutorizacion = CodigoAutorizacion, @EstatusTransaccion = EstatusTransaccion, 
		@FechaTransaccion = FechaTransaccion, @IDTransaccion = IDTransaccion, @Monto = Monto, @NumeroTarjeta = @NumeroTarjeta, 
		@Tarjetahabiente = Tarjetahabiente, @Error = Error, @Mensaje = Mensaje, @TransaccionOriginal = @TransaccionOriginal
    FROM POSVFALog
	WHERE ID = @ID 
      
	SELECT NULLIF(@Error,'') Error, NULLIF(@Mensaje,'')Mensaje, ISNULL(@Monto ,0.0)Monto
END
GO


/************************ spPOSUsuarioMov *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSUsuarioMov') AND type = 'P') DROP PROCEDURE dbo.spPOSUsuarioMov
GO             
CREATE PROCEDURE spPOSUsuarioMov
	@Estacion     int,
	@Usuario      varchar(10),
	@Empresa      varchar(5)
--//WITH ENCRYPTION	     
AS 
BEGIN	
	DECLARE 
	@POSInv     bit
  
	SELECT @POSInv = ISNULL(POSInv,0) 
	FROM POSCfg 
	WHERE Empresa = @Empresa
       
	DELETE POSUsuarioMovTemp WHERE Estacion = @Estacion
	
	INSERT POSUsuarioMovTemp (
		Estacion,  Mov, Usuario)
	SELECT
		@Estacion, Mov, @Usuario
    FROM MovTipo 
	WHERE Modulo = 'POS'
    AND Mov NOT IN (SELECT Mov FROM POSUsuarioMov WHERE Usuario = @Usuario)
    AND Clave NOT IN('POS.CTCAC','POS.CTCRC','POS.STE','POS.FTE','POS.TCRC','POS.TCAC','POS.INVD','POS.INVA','POS.SALDOIN') 
    AND SubClave NOT IN('POS.NPF') 
	GROUP BY Mov    
   
	IF @POSInv = 1
		BEGIN
			INSERT POSUsuarioMovTemp (
				Estacion,  Mov, Usuario)
			SELECT
				@Estacion, Mov, @Usuario
			FROM MovTipo 
			WHERE Modulo = 'POS'
			AND Mov NOT IN (SELECT Mov FROM POSUsuarioMov WHERE Usuario = @Usuario)
			AND Clave IN('POS.INVD','POS.INVA')  
			GROUP BY Mov 
		END     
END
GO


/************************ spPOSUsuarioInsertarMov *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSUsuarioInsertarMov') AND type = 'P') DROP PROCEDURE dbo.spPOSUsuarioInsertarMov
GO             
CREATE PROCEDURE spPOSUsuarioInsertarMov
	@Estacion     int,
	@Usuario      varchar(10)
--//WITH ENCRYPTION	     
AS 
BEGIN	     
	INSERT POSUsuarioMov (Usuario, Mov, PuedeAutorizar)
	SELECT				  Usuario, Mov, 1 
    FROM POSUsuarioMovTemp 
	WHERE Estacion = @Estacion 
    AND ID IN(SELECT ID FROM ListaID  WHERE Estacion = @Estacion)       
END
GO


/************************ spPOSInsertarUsuarioAccion *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarUsuarioAccion') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarUsuarioAccion
GO             
CREATE PROCEDURE spPOSInsertarUsuarioAccion
	@Estacion     int,
	@Usuario      varchar(10)
--//WITH ENCRYPTION	     
AS 
BEGIN	     
	DELETE POSUsuarioAccionTemp WHERE Estacion = @Estacion
	
	INSERT POSUsuarioAccionTemp (
		Estacion,  Accion, Usuario)
	SELECT
		@Estacion, Accion, @Usuario
    FROM POSAccion
	WHERE Accion NOT IN (SELECT Accion FROM POSUsuarioAccion WHERE Usuario = @Usuario)
	GROUP BY Accion          
END
GO


/************************ spPOSUsuarioInsertarAccion *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSUsuarioInsertarAccion') AND type = 'P') DROP PROCEDURE dbo.spPOSUsuarioInsertarAccion
GO             
CREATE PROCEDURE spPOSUsuarioInsertarAccion
	@Estacion     int,
	@Usuario      varchar(10)
--//WITH ENCRYPTION	     
AS 
BEGIN	     
	INSERT POSUsuarioAccion (
		Usuario, Accion)
	SELECT 
		Usuario, Accion
    FROM POSUsuarioAccionTemp 
	WHERE Estacion = @Estacion 
    AND ID IN(SELECT ID FROM ListaID  WHERE Estacion = @Estacion)       
END
GO


/************************ spPOSInsertarPOSLDenominacion *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarPOSLDenominacion') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarPOSLDenominacion
GO             
CREATE PROCEDURE spPOSInsertarPOSLDenominacion
	@Estacion     int,
	@ID           varchar(36)
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
    @FormaPago          varchar(50), 
    @Denominacion       float, 
    @Nombre             varchar(50), 
    @Cantidad           int
  	     
	IF EXISTS(SELECT * FROM POSLDenominacionTemp WHERE ID = @ID AND Estacion = @Estacion)
		BEGIN
			DECLARE crDenominacion CURSOR FOR
			SELECT FormaPago, Denominacion,Nombre, ISNULL(Cantidad,0)
			FROM POSLDenominacionTemp
			WHERE ID = @ID AND Estacion = @Estacion     

			OPEN crDenominacion
			FETCH NEXT FROM crDenominacion INTO  @FormaPago, @Denominacion, @Nombre, @Cantidad
			WHILE @@FETCH_STATUS <> -1 
				BEGIN
					IF NOT EXISTS(SELECT * FROM POSLDenominacion WHERE ID = @ID AND FormaPago = @FormaPago AND Denominacion =@Denominacion)
						INSERT POSLDenominacion(
							ID, FormaPago, Denominacion, Nombre, Cantidad)
						SELECT
							@ID, @FormaPago, @Denominacion, @Nombre, @Cantidad
					ELSE
						UPDATE   POSLDenominacion 			
						SET Cantidad = Cantidad+@Cantidad
						WHERE ID = @ID AND FormaPago = @FormaPago AND Denominacion =@Denominacion
        
					FETCH NEXT FROM crDenominacion INTO @FormaPago, @Denominacion, @Nombre, @Cantidad
				END
			CLOSE crDenominacion
			DEALLOCATE crDenominacion  
		END   
END
GO


 /************************ spPOSModificarOfertaTemp  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSModificarOfertaTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSModificarOfertaTemp
GO             
CREATE PROCEDURE spPOSModificarOfertaTemp
	@Estacion       int,
    @ID				varchar(36)            
--//WITH ENCRYPTION             
AS 
BEGIN  
	DELETE POSOfertaTempD WHERE Estacion = @Estacion AND IDR = @ID
  
	INSERT POSOfertaTempD(
		Estacion, ID, IDR, Articulo, Renglon, PrecioSugerido, Precio, Puntos,            CantidadO, CantidadM)
	SELECT
		Estacion, ID, IDR, Articulo, Renglon, PrecioSugerido, Precio, (Puntos/Cantidad), Cantidad,  Cantidad
    FROM POSOfertaTemp 
	WHERE Estacion = @Estacion 
    AND IDR = @ID
    AND ID IN(SELECT ID FROM ListaID  WHERE Estacion = @Estacion)
END
GO  


/************************ spPOSAplicarOfertaTemp  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAplicarOfertaTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSAplicarOfertaTemp
GO             
CREATE PROCEDURE spPOSAplicarOfertaTemp
	@Estacion           int,
    @ID                 varchar(36)            
--//WITH ENCRYPTION             
AS 
BEGIN
	UPDATE POSLVenta  SET Aplicado = 1
    FROM POSLVenta v JOIN POSOfertaTemp p ON v.Renglon = p.Renglon AND p.Articulo = v.Articulo AND v.ID = p.IDR AND p.Estacion = @Estacion
	WHERE v.ID = @ID
    AND p.ID IN(SELECT ID FROM ListaID  WHERE Estacion = @Estacion)  
END
GO 


/************************ spPOSReInsertarArtOfertaTemp  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSReInsertarArtOfertaTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSReInsertarArtOfertaTemp
GO             
CREATE PROCEDURE spPOSReInsertarArtOfertaTemp
	@Estacion           int,
    @ID                 varchar(36)            
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE  
    @Renglon            float, 
    @Renglon2           float, 
    @RenglonID2         int,
    @Articulo           varchar(20), 
    @IDR                varchar(36), 
    @CantidadO          float, 
    @CantidadM          float,
    @Cantidad           float,
    @Ok                 int

	IF EXISTS(SELECT * FROM POSOfertaTempD WHERE CantidadM <> CantidadO AND Estacion = @Estacion 
			  AND IDR = @ID AND ID IN (SELECT ID FROM ListaID  WHERE Estacion = @Estacion))
		BEGIN
			DECLARE crVenta CURSOR FOR
			SELECT Renglon, Articulo, IDR , CantidadO,ISNULL(CantidadM,0.0)
			FROM POSOfertaTempD 
			WHERE CantidadM <> CantidadO 
			AND Estacion = @Estacion 
			AND IDR = @ID 
			AND ID IN (SELECT ID FROM ListaID  WHERE Estacion = @Estacion)
    
			OPEN crVenta
			FETCH NEXT FROM crVenta INTO  @Renglon, @Articulo, @IDR, @CantidadO, @CantidadM 
			WHILE @@FETCH_STATUS <> -1 
				BEGIN
					SELECT @Cantidad = (ISNULL(@CantidadO,0.0)-ISNULL(@CantidadM,0.0))
					
					IF ISNULL(@Cantidad,0.0) > 0
						BEGIN
							SELECT @Renglon2 = MAX(Renglon), @RenglonID2 = MAX(RenglonID) 
							FROM POSLVenta 
							WHERE ID = @ID
							
							SELECT @Renglon2 = @Renglon2 + 2048.0
							SELECT @RenglonID2 = @RenglonID2 + 1
            
							INSERT POSLVenta (
								ID, Renglon, RenglonID, RenglonTipo, Cantidad, Articulo, SubCuenta, Precio, DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, 
								Unidad, Factor, CantidadInventario, LDIServicio, PrecioImpuestoInc, Codigo)
							SELECT
								ID, @Renglon2, @RenglonID2, RenglonTipo, @Cantidad, Articulo, SubCuenta, Precio, DescuentoLinea, Impuesto1, Impuesto2, Impuesto3,
								Unidad, Factor, @Cantidad, LDIServicio, PrecioImpuestoInc, Codigo
							FROM POSLVenta 
							WHERE ID = @ID AND Articulo = @Articulo AND Renglon = @Renglon
        
							IF @@ERROR <> 0 
								SET @OK = 1
        
							UPDATE POSLVenta 
							SET Cantidad = @CantidadM, CantidadInventario = @CantidadM
							WHERE ID = @ID AND Articulo = @Articulo AND Renglon = @Renglon
        
							IF @@ERROR <> 0 
								SET @OK = 1         
						END  
      
					SELECT @Cantidad = NULL,@Renglon2 = NULL,@RenglonID2 = NULL
					
					FETCH NEXT FROM crVenta INTO @Renglon, @Articulo, @IDR, @CantidadO, @CantidadM 
				END
			CLOSE crVenta
			DEALLOCATE crVenta      
		END
  
	EXEC spPOSAplicarOfertaTemp @Estacion, @ID    
	EXEC spPOSOfertaPuntosAplicar @ID, NULL, 1, @Estacion
	EXEC spPOSOfertaPuntosInsertarTemp @ID, NULL, 1, @Estacion
END
GO 


/************************ spPOSInsertarOfertaTempCancelacion *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarOfertaTempCancelacion') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarOfertaTempCancelacion
GO             
CREATE PROCEDURE spPOSInsertarOfertaTempCancelacion
	@Estacion		int,
    @ID             varchar(36)            
 --//WITH ENCRYPTION            
AS 
BEGIN
	DELETE POSOfertaTempCancelacion WHERE Estacion = @Estacion
  
	INSERT POSOfertaTempCancelacion(
		Estacion,  IDR, Articulo, Renglon, PrecioSugerido, Precio, Puntos, Cantidad)
	SELECT
		@Estacion, ID,  Articulo, Renglon, PrecioSugerido, Precio, Puntos, Cantidad
    FROM POSLVenta
	WHERE ID = @ID
    AND  Aplicado = 1
END
GO 


/************************ spPOSReAgruparPOSLVenta *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSReAgruparPOSLVenta') AND type = 'P') DROP PROCEDURE dbo.spPOSReAgruparPOSLVenta
GO             
CREATE PROCEDURE spPOSReAgruparPOSLVenta
	@Estacion		int,
    @ID             varchar(36)            
 --//WITH ENCRYPTION            
AS 
BEGIN	
	DECLARE 
	@Renglon   float,
	@RenglonID int,
	@Ok        int

	DECLARE  @Tabla table(
		Renglon				float,  
        RenglonID			int,
        RenglonTipo			varchar(1), 
        RenglonSub			int, 
        Cantidad			float,  
        Articulo			varchar(20),  
        SubCuenta			varchar(50),  
        Precio				float,  
        DescuentoLinea		money,  
        Impuesto1			float,  
        Impuesto2			float,  
        Impuesto3			float,  
        Unidad				varchar(50),  
        Factor				float,  
        CantidadInventario	float, 
        LDIServicio			varchar(20),
        PrecioImpuestoInc	float,
        Almacen				varchar(10))
                       
	DECLARE  @Tabla2 table(
		Renglon				float,  
        RenglonID			int,
        RenglonTipo			varchar(1), 
        RenglonSub			int, 
        Cantidad			float,  
        Articulo			varchar(20),  
        SubCuenta			varchar(50),  
        Precio				float,  
        DescuentoLinea		money,  
        Impuesto1			float,  
        Impuesto2			float,  
        Impuesto3			float,  
        Unidad				varchar(50),  
        Factor				float,  
        CantidadInventario	float, 
        LDIServicio			varchar(20),
        PrecioImpuestoInc	float,
        Almacen				varchar(10))                       
                            
	INSERT @Tabla(
		RenglonTipo, RenglonSub, Cantidad, Articulo, SubCuenta, Precio, DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, 
		CantidadInventario, LDIServicio, Almacen)
	SELECT
		RenglonTipo, RenglonSub, Cantidad, Articulo, SubCuenta, NULL, DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, 
		CantidadInventario, LDIServicio, Almacen
    FROM POSLVenta
	WHERE ID = @ID
    AND Aplicado = 0
  
	IF @@ERROR <>0 
		SET @Ok = 1
  
	IF @Ok IS NULL
		BEGIN
			DELETE POSLVenta WHERE ID = @ID AND Aplicado = 0
    
			INSERT @Tabla2(
				Renglon, RenglonID, RenglonTipo, RenglonSub, Cantidad, Articulo, SubCuenta, Precio, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor,
				CantidadInventario, LDIServicio, PrecioImpuestoInc, Almacen)
			SELECT
				Renglon, RenglonID, RenglonTipo, RenglonSub, SUM(Cantidad), Articulo, SubCuenta, Precio, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor,
				SUM(CantidadInventario), LDIServicio, PrecioImpuestoInc, Almacen
			FROM @Tabla
			GROUP BY Renglon, RenglonID, RenglonTipo, RenglonSub, Articulo, SubCuenta, Precio, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor,
				LDIServicio, PrecioImpuestoInc, Almacen
    
			SELECT @Renglon = MAX(Renglon),@RenglonID = MAX(RenglonID)
			FROM POSLVenta 
			WHERE ID = @ID     
      
			SELECT @Renglon = ISNULL(@Renglon,0.0)+ 2048.0, @RenglonID = ISNULL(@RenglonID,0)+1
  
			UPDATE @Tabla2
			SET @Renglon = Renglon = @Renglon + 2048.0, @RenglonID = RenglonID = @RenglonID + 1
			FROM @Tabla            
    
			INSERT POSLVenta(
				ID, Renglon, RenglonID, RenglonTipo, RenglonSub, Cantidad, Articulo, SubCuenta, Precio, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor,
				CantidadInventario, LDIServicio, PrecioImpuestoInc, Almacen)
			SELECT
				@ID, Renglon, RenglonID, RenglonTipo, RenglonSub, Cantidad, Articulo, SubCuenta, Precio, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, 
				CantidadInventario, LDIServicio, PrecioImpuestoInc, Almacen
			FROM @Tabla2
    
			IF @@ERROR <>0 
				SET @Ok = 1   
    
			SELECT @Renglon = 0.0,@RenglonID = 0
			UPDATE POSLVenta
			SET @Renglon = Renglon = @Renglon + 2048.0, @RenglonID = RenglonID = @RenglonID + 1
			FROM POSLVenta
			WHERE ID = @ID    
		END
END
GO 


/************************ spPOSCancelarOfertaPuntos  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSCancelarOfertaPuntos') AND type = 'P') DROP PROCEDURE dbo.spPOSCancelarOfertaPuntos
GO             
CREATE PROCEDURE spPOSCancelarOfertaPuntos
	@Estacion		int,
    @ID             varchar(36)            
 --//WITH ENCRYPTION            
AS 
BEGIN
	UPDATE POSLVenta
    SET PrecioSugerido = NULL,
		Precio = NULL,
        DescuentoLinea = NULL,
        DescuentoImporte = NULL,
        Puntos = NULL,
        Comision = NULL,
		CantidadObsequio = NULL,
        OfertaID = NULL,
        Aplicado = 0,
        PrecioImpuestoInc = NULL
	FROM POSLVenta v JOIN POSOfertaTempCancelacion p ON v.Renglon = p.Renglon AND p.Articulo = v.Articulo AND v.ID = p.IDR AND p.Estacion = @Estacion
    WHERE v.ID = @ID AND p.ID IN(SELECT ID FROM ListaID  WHERE Estacion = @Estacion)
   
	EXEC spPOSReAgruparPOSLVenta @Estacion, @ID
	EXEC spPOSOfertaAplicar  @ID
	EXEC spPOSOfertaPuntosInsertarTemp @ID, NULL, 1, @Estacion
END
GO 


/**************** fnPOSValidarMonedero ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidarMonedero') DROP FUNCTION fnPOSValidarMonedero
GO
CREATE FUNCTION dbo.fnPOSValidarMonedero(
	@Monedero  varchar(20)
) 
RETURNS varchar(100)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  varchar(100)
    
	IF EXISTS(SELECT * FROM POSValeSerie WHERE Serie = @Monedero AND Estatus = 'CANCELADO')
		SELECT @Resultado = 'Monedero Cancelado '
	ELSE
		SELECT @Resultado = NULL  
  
	RETURN (@Resultado)
END
GO


/************************ spPOSHerrCancelarVale *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSHerrCancelarVale') AND type = 'P') DROP PROCEDURE dbo.spPOSHerrCancelarVale
GO             
CREATE PROCEDURE spPOSHerrCancelarVale
	@Estacion   int,
	@Empresa    varchar(5),
	@Usuario    varchar(10),
	@Sucursal   int
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@Cliente             varchar(10),
	@ID                  int,
	@FechaEmision        datetime,
	@Ok                  int,
	@OkRef               varchar(255),
	@OKRefLDI            varchar(500),   
	@Monedero            varchar(20),
	@Mov                 varchar(20),
	@MovID               varchar(20),
	@TipoCambio          float,
	@IDNuevo             int,
	@ArticuloTarjeta     varchar(20),  
	@AlmacenTarjeta      varchar(10),
	@Importe             float,
	@MonederoLDI         bit,
	@Moneda              varchar(10),
	@Saldo               float,
	@SugerirFechaCierre  bit,
	@FechaCierre         datetime
   
	SELECT @FechaEmision = dbo.fnFechaSinHora(GETDATE())--CASE WHEN @SugerirFechaCierre = 1 THEN @FechaCierre ELSE dbo.fnFechaSinHora(GETDATE())END  
	
	SELECT @Moneda =  DefMoneda 
	FROM Usuario 
	WHERE Usuario = @Usuario
	
	SELECT @MonederoLDI = ISNULL(MonederoLDI,0) 
	FROM POSCfg 
	WHERE Empresa = @Empresa
	
	SELECT @TipoCambio = TipoCambio 
	FROM Mon 
	WHERE Moneda = @Moneda
	
	SELECT @ArticuloTarjeta= CxcArticuloTarjetasDef ,@AlmacenTarjeta= CxcAlmacenTarjetasDef  
    FROM EmpresaCfg 
	WHERE Empresa = @Empresa
   
	SELECT @Mov = MovCancelacion
    FROM POSCfg 
	WHERE Empresa = @Empresa 
  
	IF @Mov IS NULL
		SELECT TOP 1 @Mov = Mov FROM MovTipo WHERE Modulo = 'VALE' AND Clave = 'VALE.CT'   

	IF @Ok IS NULL
		BEGIN
			IF @Ok IS NULL
				BEGIN
					DECLARE crArticulo CURSOR FOR
					SELECT ID, Monedero, Cliente
					FROM POSHerrCancelacionVale
					WHERE ID IN (SELECT ID FROM ListaID  WHERE Estacion = @Estacion)AND Monedero IS NOT NULL
      
					OPEN crArticulo
					FETCH NEXT FROM crArticulo INTO @ID, @Monedero, @Cliente
					WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
						BEGIN 
							BEGIN TRANSACTION  
							
							SELECT @Ok = NULL ,@OkRef = NULL 
        
							SET @Saldo = 0.0
							SELECT @Saldo = dbo.fnVerSaldoVale(@Monedero) 
        
							IF @Saldo > 0.0
								BEGIN        
									INSERT INTO Vale (
										Empresa, Mov, FechaEmision, Moneda, TipoCambio, Usuario, Estatus, Sucursal, Cliente, SucursalOrigen, 
										SucursalDestino, Articulo, Almacen)
									SELECT
										@Empresa, @Mov, @FechaEmision, @Moneda, @TipoCambio, @Usuario,'SINAFECTAR', @Sucursal, @Cliente, @Sucursal,
										@Sucursal, @ArticuloTarjeta, @AlmacenTarjeta 
          
									IF @@ERROR <> 0 
										SET @Ok = 1
          
									SELECT @IDNuevo = SCOPE_IDENTITY()     
          
									INSERT ValeD(
										ID, Serie, Sucursal, SucursalOrigen,Importe)
									SELECT
										@IDNuevo, @Monedero, @Sucursal, @Sucursal, ISNULL(@Saldo,0.0)
                  
									IF @@ERROR <> 0 
										SET @Ok = 1
          
									IF @OK IS NULL
										EXEC spAfectar 'VALE', @IDNuevo, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, 
											@Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT            
          
                 
									IF @MonederoLDI = 1
										EXEC spPOSLDIValidarTarjeta  'MON CONSULTA',@IDNuevo, @Monedero,@Empresa,@Usuario,@Sucursal,
											@Importe OUTPUT, @Ok OUTPUT, @OkRef  OUTPUT, @OKRefLDI OUTPUT ,0,'VALE' 

									--SI LA TARJETA NO EXISTE   LA DA DE ALTA
									IF @OKRefLDI = 'Tarjeta no registrada'  
										SELECT @Ok = 1 , @OkRef = @OKRefLDI
          
									IF @Ok IS NULL  
										IF @MonederoLDI = 1 AND ISNULL(@Importe,0.0) >0.0
											EXEC spPOSLDI 'MON CARGO', @IDNuevo, @Monedero, @Empresa, @Usuario, @Sucursal, NULL, @Importe, 1, NULL, 
												@Ok OUTPUT, @OkRef OUTPUT, 'VALE'
								END    

							IF @Ok IS NULL 
								BEGIN
									COMMIT TRANSACTION
								END  
							ELSE
								ROLLBACK TRANSACTION   
         
							IF @Ok IS NOT NULL   
								UPDATE POSHerrCancelacionVale SET Error = @OkRef  WHERE ID = @ID
					
							IF @Ok IS NULL 
								BEGIN
									DELETE  POSHerrCancelacionVale WHERE ID = @ID
								END  
          
							FETCH NEXT FROM crArticulo INTO @ID, @Monedero, @Cliente
						END 
					CLOSE crArticulo
					DEALLOCATE crArticulo 
				END
		END 
  
	IF @Ok IS NULL
		SELECT @OkRef = 'PROCESO CONCLUIDO'
   
	SELECT @OkRef  
END
GO


/************************ spPOSInsertaHerrCancelarVale *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertaHerrCancelarVale') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertaHerrCancelarVale
GO             
CREATE PROCEDURE spPOSInsertaHerrCancelarVale
	@Estacion   int,
	@Tipo       varchar(50),
	@FechaA     datetime
--//WITH ENCRYPTION	     
AS 
BEGIN
	DELETE POSHerrCancelacionVale WHERE Estacion = @Estacion
    
    INSERT POSHerrCancelacionVale(
		Estacion, Cliente, Monedero,FechaVigencia)
    SELECT
		@Estacion,ISNULL(Cliente,''), Serie, FechaTermino
	FROM ValeSerie
    WHERE Tipo = ISNULL(NULLIF(@Tipo,''),Tipo)
    AND Estatus NOT IN('CANCELADO')
    AND dbo.fnVerSaldoVale(Serie) >0.0
END
GO 


/**************** fnPOSEstatusCajaBloqueada ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSEstatusCajaBloqueada') DROP FUNCTION fnPOSEstatusCajaBloqueada
GO
CREATE FUNCTION dbo.fnPOSEstatusCajaBloqueada(
	@Caja		varchar(10)
) 
RETURNS varchar(100)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  bit
  
    SELECT @Resultado = pec.Bloqueado
    FROM POSEstatusCaja pec
    WHERE pec.Caja = @Caja
     
    SELECT @Resultado = ISNULL(@Resultado,0)

	RETURN (@Resultado)
END
GO


/**************** fnPOSEstatusCajaCerrada ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSEstatusCajaCerrada') DROP FUNCTION fnPOSEstatusCajaCerrada
GO
CREATE FUNCTION dbo.fnPOSEstatusCajaCerrada (
	@Caja		varchar(10)
) 
RETURNS varchar(100)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  bit
  
    SELECT @Resultado = pec.Abierto
    FROM POSEstatusCaja pec
    WHERE pec.Caja = @Caja
     
	SELECT @Resultado = ISNULL(@Resultado,0)

	RETURN (@Resultado)
END
GO


/**************** fnPOSCheckSumEncabezado ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSCheckSumEncabezado') DROP FUNCTION fnPOSCheckSumEncabezado
GO
CREATE FUNCTION dbo.fnPOSCheckSumEncabezado (
	@ID   varchar(36)
) 
RETURNS int
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  int

    SELECT @Resultado = CHECKSUM(ID, Empresa, Modulo, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Referencia, 
		Observaciones, Estatus, Cliente, Nombre, Direccion, DireccionNumero, DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, Estado, Pais, 
		Zona, CodigoPostal, RFC, CURP, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CajaOrigen, CtaDinero, Descuento, DescuentoGlobal, Importe, 
		Impuestos, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, Origen, OrigenID, Tasa, Prefijo, Consecutivo, IDR, 
		Monedero, BeneficiarioNombre)
	FROM POSLPorCobrar WHERE ID = @ID
  
	RETURN (@Resultado)
END
GO


/**************** fnPOSCheckSumDetalle ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSCheckSumDetalle') DROP FUNCTION fnPOSCheckSumDetalle
GO
CREATE FUNCTION dbo.fnPOSCheckSumDetalle (
	@ID			varchar(36),
    @Renglon	float
) 
RETURNS int
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  int

    SELECT @Resultado = CHECKSUM(ID, Renglon, RenglonSub, RenglonID, RenglonTipo, Aplica, AplicaID, Cantidad, Articulo, SubCuenta, Precio, PrecioSugerido, 
		DescuentoLinea, DescuentoImporte, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, CantidadInventario, Puntos, Comision, CantidadObsequio, OfertaID, 
		SerieLote, LDIServicio, Juego, Aplicado, PrecioImpuestoInc, AplicaDescGlobal, Codigo)
	FROM POSLPorCobrarD WHERE ID = @ID AND Renglon = @Renglon
  
	RETURN (@Resultado)
END
GO


/**************** fnPOSCheckSumSerie ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSCheckSumSerie') DROP FUNCTION fnPOSCheckSumSerie
GO
CREATE FUNCTION dbo.fnPOSCheckSumSerie (
	@ID		varchar(36),
	@IDL	varchar(36)
) 
RETURNS int
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  int

    SELECT @Resultado = CHECKSUM(IDL, ID, RenglonID, Articulo, SubCuenta, SerieLote)
    FROM POSLPorCobrarSerieLote WHERE ID = @ID AND IDL = @IDL
  
	RETURN (@Resultado)
END
GO


/**************** fnPOSMatrizOpciones ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSMatrizOpciones') DROP FUNCTION fnPOSMatrizOpciones
GO
CREATE FUNCTION fnPOSMatrizOpciones (
	@Expresion		varchar(max),
	@Tipo			int
)
RETURNS varchar(50)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @Resultado			varchar(max),
    @Posicion                   int,
    @Longitud                   int
    
	SELECT @Expresion =LTRIM(RTRIM(@Expresion))
    SELECT @Longitud = LEN(@Expresion)
    
	IF @Longitud <=4 AND (CHARINDEX(CHAR(9),@Expresion)= 0 AND CHARINDEX(CHAR(32),@Expresion)=0)
		SELECT @Expresion=@Expresion+CHAR(9)+'1'
    
	SELECT @Posicion = CHARINDEX(CHAR(9),@Expresion)
    
	IF @Posicion = 0
		SELECT @Posicion = CHARINDEX(CHAR(32),@Expresion)       
   
	IF @Tipo = 1 
		SELECT @Resultado =  SUBSTRING(@Expresion,1,(@Posicion-1))
    
	IF @Tipo = 2
		SELECT @Resultado =  SUBSTRING(@Expresion,(@Posicion+1),@Longitud)      
 
    SELECT @Resultado = LTRIM(RTRIM(@Resultado))
	
	RETURN (@Resultado )
END
GO


/************************ spPOSArtMatrizOpciones *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSArtMatrizOpciones') AND type = 'P') DROP PROCEDURE dbo.spPOSArtMatrizOpciones
GO             
CREATE PROCEDURE spPOSArtMatrizOpciones
	@ID                varchar(50),
	@Articulo          varchar(20),
	@Estacion          int,
	@Codigo            varchar(50)
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@Clave					varchar(50) ,
	@Renglon				float, 
	@RenglonID				int, 
	@RenglonTipo			varchar(1), 
	@Cantidad				float,
	@SubCuenta				varchar(50),
	@Unidad					varchar(50),
	@UnidadCodigo			varchar(50),
	@ArtTipo				varchar(20),
	@Empresa				varchar(5),
	@Cliente				varchar(10),
	@Sucursal				int,
	@EnviarA				int,
	@Mov					varchar(20),
	@ZonaImpuestoCliente	varchar(50),
	@ZonaImpuestoUsuario	varchar(50),
	@ZonaImpuesto			varchar(50),
	@Usuario				varchar(10),
	@Impuesto1				float,
	@Impuesto2				float,
	@Impuesto3				float,
	@FechaEmision			datetime,
	@Almacen				varchar(20),    
    @ArtGrupo				varchar(50),
    @ArtCategoria			varchar(50),
    @ArtFamilia				varchar(50),
    @ArtLinea				varchar(50),
    @ArtFabricante			varchar(50),
	@Agente					varchar(10),
	@POSAgenteDetalle		bit,
	@POSAgenteDetMaestro	varchar(15),
	@ArtPOSAgenteDetalle	varchar (255),
	@ArtPOSAgenteDetalleInfo varchar (255),
	@Host					varchar(20), 
	@Caja					varchar(10)
  
	DECLARE @Tabla table (
		Articulo   varchar(20), 
		SubCuenta  varchar(50), 
		Cantidad   float)

	SELECT @Empresa = p.Empresa,@Cliente = p.Cliente,@Sucursal = p.Sucursal, @EnviarA = p.EnviarA, @Mov=p.Mov, @ZonaImpuestoCliente = c.ZonaImpuesto, 
		   @Usuario = p.Usuario, @FechaEmision = p.FechaEmision, @Almacen = p.Almacen, @Host = p.Host, @Caja = p.Caja
	  FROM POSL p JOIN Cte c ON p.Cliente = c.Cliente
     WHERE p.ID = @ID   
   
	INSERT @Tabla( Articulo, SubCuenta, Cantidad)
    SELECT @Articulo,dbo.fnPOSMatrizOpciones(Clave,1),CONVERT(float,dbo.fnPOSMatrizOpciones(Clave,2),1)
      FROM ListaSt
     WHERE Estacion = @Estacion
     
	SELECT @UnidadCodigo = Unidad 
	  FROM CB 
	 WHERE Codigo = @Codigo
       
	SELECT @ArtTipo = Tipo, 
		   @Unidad = ISNULL(NULLIF(@UnidadCodigo,''),Unidad), 
		   @Impuesto1 = Impuesto1, 
		   @Impuesto2 = Impuesto2,  
		   @Impuesto3 = Impuesto3, 
		   @ArtGrupo =	Grupo,
		   @ArtCategoria = Categoria,
		   @ArtFamilia = Familia,
		   @ArtLinea = Linea,
		   @ArtFabricante = Fabricante
      FROM Art 
	 WHERE Articulo = @Articulo
    
	SELECT @POSAgenteDetalle = ISNULL(POSAgenteDetalle,0), @POSAgenteDetMaestro = NULLIF(POSAgenteDetMaestro,'')
	  FROM POSCfg 
	 WHERE Empresa = @Empresa

	
	IF @POSAgenteDetalle = 1
		SET @ArtPOSAgenteDetalle = @POSAgenteDetMaestro
   
	SELECT @ZonaImpuestoUsuario = u.DefZonaImpuesto 
      FROM Usuario u
     WHERE u.Usuario = @Usuario 
    
	SELECT @ZonaImpuesto = ISNULL(NULLIF(@ZonaImpuestoCliente,''),@ZonaImpuestoUsuario)    
   
    EXEC spZonaImp @ZonaImpuesto, @Impuesto1 OUTPUT
    EXEC spZonaImp @ZonaImpuesto, @Impuesto2 OUTPUT
    EXEC spZonaImp @ZonaImpuesto, @Impuesto3 OUTPUT
    EXEC spTipoImpuesto 'POS', 0, @Mov, @FechaEmision, @Empresa, @Sucursal, @Cliente, @EnviarA, @Articulo = @Articulo, @EnSilencio = 1, 
		@Impuesto1 = @Impuesto1 OUTPUT, @Impuesto2 = @Impuesto2 OUTPUT, @Impuesto3 = @Impuesto3 OUTPUT      
    
    SELECT @Agente = NULL, @ArtPOSAgenteDetalleInfo = NULL

	IF @POSAgenteDetalle = 1 AND @ArtPOSAgenteDetalle IS NOT NULL
	BEGIN
		IF @ArtPOSAgenteDetalle = 'Categoría'
		BEGIN
			IF EXISTS (SELECT * FROM ArtCat WHERE Categoria = @ArtCategoria AND POSAgenteDetalle = 1)
				SELECT @ArtPOSAgenteDetalle = 'Categoria', @ArtPOSAgenteDetalleInfo = @ArtCategoria
			ELSE
				SELECT @ArtPOSAgenteDetalle = NULL, @ArtCategoria = NULL, @ArtPOSAgenteDetalleInfo = NULL
		END
		IF @ArtPOSAgenteDetalle = 'Grupo'
		BEGIN
			IF EXISTS (SELECT * FROM ArtGrupo WHERE Grupo = @ArtGrupo AND POSAgenteDetalle = 1)
				SELECT @ArtPOSAgenteDetalle = 'Grupo', @ArtPOSAgenteDetalleInfo = @ArtGrupo
			ELSE
				SELECT @ArtPOSAgenteDetalle = NULL, @ArtGrupo = NULL, @ArtPOSAgenteDetalleInfo = NULL
		END
		IF @ArtPOSAgenteDetalle = 'Familia'
		BEGIN
			IF EXISTS (SELECT * FROM ArtFam WHERE Familia = @ArtFamilia AND POSAgenteDetalle = 1)
				SELECT @ArtPOSAgenteDetalle = 'Familia', @ArtPOSAgenteDetalleInfo = @ArtFamilia
			ELSE
				SELECT @ArtPOSAgenteDetalle = NULL, @ArtFamilia = NULL, @ArtPOSAgenteDetalleInfo = NULL
		END
		IF @ArtPOSAgenteDetalle = 'Línea'
		BEGIN
			IF EXISTS (SELECT * FROM ArtLinea WHERE Linea = @ArtLinea AND POSAgenteDetalle = 1)
				SELECT @ArtPOSAgenteDetalle = 'Linea', @ArtPOSAgenteDetalleInfo =@ArtLinea
			ELSE
				SELECT @ArtPOSAgenteDetalle = NULL, @ArtLinea = NULL, @ArtPOSAgenteDetalleInfo = NULL
		END
		IF @ArtPOSAgenteDetalle = 'Fabricante'
		BEGIN
			IF EXISTS (SELECT * FROM Fabricante WHERE Fabricante = @ArtFabricante AND POSAgenteDetalle = 1)
				SELECT @ArtPOSAgenteDetalle = 'Fabricante', @ArtPOSAgenteDetalleInfo = @ArtFabricante
			ELSE
				SELECT @ArtPOSAgenteDetalle = NULL, @ArtFabricante = NULL, @ArtPOSAgenteDetalleInfo = NULL
		END

	END



	IF @ArtPOSAgenteDetalleInfo IS NOT NULL
		IF EXISTS (SELECT TOP 1 * FROM POSLVenta WITH (NOLOCK) WHERE ID = @ID AND ArtObservaciones = @ArtPOSAgenteDetalleInfo)
			SELECT TOP 1 @Agente = Agente FROM POSLVenta  WITH (NOLOCK) WHERE ID = @ID AND ArtObservaciones = @ArtPOSAgenteDetalleInfo    
     
	IF @ArtPOSAgenteDetalleInfo IS NOT NULL AND NULLIF(@Agente,'') IS NULL
	BEGIN
		INSERT POSLAccion (Host, Caja, Accion, Referencia) VALUES (@Host, @Caja, 'INSERTA AGENTE', NULL)
	END
     
	DECLARE crLista CURSOR local FOR
	SELECT  SubCuenta, Cantidad
    FROM @Tabla     
  
	OPEN crLista
	FETCH NEXT FROM crLista INTO @SubCuenta, @Cantidad
	WHILE @@FETCH_STATUS = 0  
		BEGIN
			SELECT @Renglon = MAX(Renglon),@RenglonID = MAX(RenglonID) FROM POSLVenta WHERE ID = @ID
			SELECT @Renglon = ISNULL(@Renglon,0.0)+2048.0,@RenglonID = ISNULL(@RenglonID,0)+1
			SELECT @RenglonTipo = dbo.fnRenglonTipo(@ArtTipo)
    
			IF EXISTS(SELECT * FROM POSLVenta plv WHERE plv.ID = @ID AND plv.Articulo = @Articulo AND ISNULL(plv.SubCuenta,'') = ISNULL(@SubCuenta,'') 
					  AND plv.RenglonTipo = @RenglonTipo AND plv.Unidad = @Unidad AND RenglonTipo <> 'C' AND ISNULL(Aplicado,0)=0)
				UPDATE POSLVenta SET 
					Cantidad = Cantidad + @Cantidad,
					CantidadInventario = Cantidad + @Cantidad,
					Agente = @Agente
				WHERE ID = @ID AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND RenglonTipo = @RenglonTipo 
				AND RenglonTipo <> 'C' AND ISNULL(Aplicado,0)=0
			ELSE
				INSERT POSLVenta (
					ID, Renglon, RenglonID, RenglonTipo, Cantidad, Articulo, SubCuenta, Unidad, Factor, CantidadInventario, Impuesto1, Impuesto2, Impuesto3, 
					Almacen, ArtObservaciones, Agente)
				SELECT
					@ID, @Renglon, @RenglonID, @RenglonTipo, @Cantidad, @Articulo, @SubCuenta,@Unidad, 1, @Cantidad, @Impuesto1, @Impuesto2, @Impuesto3, 
					@Almacen, @ArtPOSAgenteDetalleInfo, @Agente
  
			FETCH NEXT FROM crLista INTO @SubCuenta, @Cantidad
		END
	CLOSE crLista
	DEALLOCATE crLista     
     
	EXEC spPOSArtPrecioRecalcular @ID, @Estacion
END
GO

/************************ spPOSArtMatrizOpcionesCancelar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSArtMatrizOpcionesCancelar') AND type = 'P') DROP PROCEDURE dbo.spPOSArtMatrizOpcionesCancelar
GO             
CREATE PROCEDURE spPOSArtMatrizOpcionesCancelar
	@ID                varchar(50),
	@Articulo          varchar(20),
	@Estacion          int,
	@Codigo            varchar(50)
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@Clave					varchar(50),
	@Renglon				float, 
	@RenglonID				int, 
	@RenglonTipo			varchar(1), 
	@Cantidad				float,
	@SubCuenta				varchar(50),
	@Unidad					varchar(50),
	@UnidadCodigo			varchar(50),  
	@ArtTipo				varchar(20),
	@Empresa				varchar(5),
	@Cliente				varchar(10),
	@Sucursal				int,
	@EnviarA				int,
	@Mov					varchar(20),
	@ZonaImpuestoCliente	varchar(50),
	@ZonaImpuestoUsuario	varchar(50),
	@ZonaImpuesto			varchar(50),
	@Usuario				varchar(10),
	@Impuesto1				float,
	@Impuesto2				float,
	@Impuesto3				float,
	@FechaEmision			datetime,
	@Almacen				varchar(20),
	@Caja					varchar(10), 
	@Precio					float

	DECLARE @Tabla table (
		Articulo   varchar(20), 
		SubCuenta  varchar(50), 
		Cantidad   float,
		Precio     float)
   
    INSERT @Tabla( Articulo, SubCuenta, Cantidad)
    SELECT @Articulo,dbo.fnPOSMatrizOpciones(Clave,1),CONVERT(float,dbo.fnPOSMatrizOpciones(Clave,2))
    FROM ListaSt
    WHERE Estacion = @Estacion
     
	UPDATE @Tabla SET Precio = v.Precio   
    FROM @Tabla a JOIN POSLVenta v ON a.Articulo = v.Articulo AND ISNULL(a.Subcuenta,'') = ISNULL(v.Subcuenta,'')
	WHERE v.ID = @ID 
     
	SELECT @UnidadCodigo = Unidad 
	FROM CB 
	WHERE Codigo = @Codigo
       
	SELECT @ArtTipo = Tipo, @Unidad = ISNULL(NULLIF(@UnidadCodigo,''),Unidad)
    FROM Art 
	WHERE Articulo = @Articulo
    
	SELECT @Empresa = p.Empresa,@Cliente = p.Cliente,@Sucursal = p.Sucursal, @EnviarA = p.EnviarA, @Mov=p.Mov, @ZonaImpuestoCliente = c.ZonaImpuesto, 
	@Usuario = p.Usuario, @FechaEmision = p.FechaEmision, @Almacen = p.Almacen, @Caja = p.Caja
    FROM POSL p JOIN Cte c ON p.Cliente = c.Cliente
    WHERE p.ID = @ID   
   
	SELECT @ZonaImpuestoUsuario = u.DefZonaImpuesto 
    FROM Usuario u
    WHERE u.Usuario = @Usuario   
  
	SELECT @ZonaImpuesto = ISNULL(NULLIF(@ZonaImpuestoCliente,''),@ZonaImpuestoUsuario)    
   
    EXEC spZonaImp @ZonaImpuesto, @Impuesto1 OUTPUT
    EXEC spZonaImp @ZonaImpuesto, @Impuesto2 OUTPUT
    EXEC spZonaImp @ZonaImpuesto, @Impuesto3 OUTPUT
    EXEC spTipoImpuesto 'POS', 0, @Mov, @FechaEmision, @Empresa, @Sucursal, @Cliente, @EnviarA, @Articulo = @Articulo, @EnSilencio = 1, 
		@Impuesto1 = @Impuesto1 OUTPUT, @Impuesto2 = @Impuesto2 OUTPUT, @Impuesto3 = @Impuesto3 OUTPUT      
         
	DECLARE crLista CURSOR local FOR
	SELECT  SubCuenta, Cantidad, Precio
    FROM @Tabla     
  
	OPEN crLista
	FETCH NEXT FROM crLista INTO @SubCuenta, @Cantidad, @Precio
	WHILE @@FETCH_STATUS = 0  
		BEGIN
			SELECT @Renglon = MAX(Renglon),@RenglonID = MAX(RenglonID) 
			FROM POSLVenta 
			WHERE ID = @ID
			
			SELECT @Renglon = ISNULL(@Renglon,0.0)+2048.0,@RenglonID = ISNULL(@RenglonID,0)+1
			SELECT @RenglonTipo = dbo.fnRenglonTipo(@ArtTipo)
    
			IF EXISTS (SELECT * FROM POSLSerieLote WHERE ID = @ID AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND Articulo = @Articulo)
				DELETE  POSLSerieLote WHERE ID = @ID AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND Articulo = @Articulo
   
			IF EXISTS(SELECT * FROM POSLVenta plv WHERE plv.ID = @ID AND plv.Articulo = @Articulo AND ISNULL(plv.SubCuenta,'') = ISNULL(@SubCuenta,'') 
					  AND plv.RenglonTipo = @RenglonTipo AND plv.Unidad = @Unidad  AND RenglonTipo <> 'C' AND ISNULL(Aplicado,0)=0)
				UPDATE POSLVenta SET 
					Cantidad = Cantidad - @Cantidad,
					CantidadInventario = Cantidad - @Cantidad
				WHERE ID = @ID AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND RenglonTipo = @RenglonTipo 
				AND RenglonTipo <> 'C' AND ISNULL(Aplicado,0)=0
			ELSE
				INSERT POSLVenta (
					ID, Renglon, RenglonID, RenglonTipo, Cantidad, Articulo, SubCuenta, Unidad, Factor, CantidadInventario, Impuesto1, Impuesto2, Impuesto3, Almacen)
				SELECT
					@ID, @Renglon, @RenglonID, @RenglonTipo, (@Cantidad*-1), @Articulo, @SubCuenta,@Unidad, 1, @Cantidad, @Impuesto1, @Impuesto2, @Impuesto3, @Almacen
    
			INSERT POSCancelacionArticulos(
				ID, Empresa, Sucursal, Cajero, Caja, Articulo, Precio, Fecha, Cantidad)
			SELECT
				@ID, @Empresa, @Sucursal, @Usuario, @Caja, @Articulo, @Precio, GETDATE(),(@Cantidad*-1)  
  
			FETCH NEXT FROM crLista INTO @SubCuenta, @Cantidad, @Precio
		END
	CLOSE crLista
	DEALLOCATE crLista     

	IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Cantidad = 0)
		DELETE POSLVenta WHERE ID = @ID AND Cantidad = 0  
     
	EXEC spPOSArtPrecioRecalcular @ID, @Estacion
END
GO 


/************************ spPOSCancelarVFA  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSCancelarVFA') AND type = 'P') DROP PROCEDURE dbo.spPOSCancelarVFA
GO             
CREATE PROCEDURE spPOSCancelarVFA            
	@ID                 varchar(36),
    @RID                int,
    @Estacion           int,
    @Ok                 int           OUTPUT,
    @OkRef              varchar(255)  OUTPUT    
 --//WITH ENCRYPTION            
AS 
BEGIN
	SELECT @ok =1,@OkRef='No es Posible Cancelar el Cobro'

	RETURN
END
GO 


 /************************ spPOSCancelarCobroLDI  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSCancelarCobroLDI') AND type = 'P') DROP PROCEDURE dbo.spPOSCancelarCobroLDI
GO             
CREATE PROCEDURE spPOSCancelarCobroLDI            
	@ID                 varchar(36),
    @RID                int,
    @Estacion           int,
    @Ok                 int           OUTPUT,
    @OkRef              varchar(255)  OUTPUT                    
--//WITH ENCRYPTION             
AS 
BEGIN
	SELECT @ok =1,@OkRef='No es Posible Cancelar el Cobro'

	RETURN
END
GO 


/************************ spPOSCancelarPartidaCobro  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSCancelarPartidaCobro') AND type = 'P') DROP PROCEDURE dbo.spPOSCancelarPartidaCobro
GO             
CREATE PROCEDURE spPOSCancelarPartidaCobro
	@Estacion           int,
    @ID                 varchar(36)        
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE
	@RID          int,
	@FormaPago    varchar(50),
	@EsLDI        bit,
	@EsVFA        bit,
	@Ok           int,
	@OkRef        varchar(255)
  
	SELECT @RID = MAX(RID) 
	FROM POSLCobro 
	WHERE ID = @ID
  
	SELECT @FormaPago = FormaPago 
	FROM POSLCobro 
	WHERE ID = @ID AND RID = @RID
  
	IF EXISTS(SELECT * FROM POSLDIFormaPago WHERE FormaPago = @FormaPago)
		SELECT @EsLDI = 1
  
	IF EXISTS(SELECT * FROM POSVFAFormaPago WHERE FormaPago = @FormaPago)
		SELECT @EsVFA = 1
  
	IF ISNULL(@EsLDI,0) = 1
		EXEC spPOSCancelarCobroLDI  @ID, @RID, @Estacion, @Ok OUTPUT, @OkRef  OUTPUT
 
	IF ISNULL(@EsVFA,0) = 1
		EXEC spPOSCancelarVFA @ID, @RID, @Estacion, @Ok OUTPUT, @OkRef  OUTPUT   

	IF @Ok IS NULL
		DELETE POSLCobro WHERE ID = @ID AND RID = @RID
    
	SELECT @Ok,@OKref    
END
GO 


/************************ spPOSInicializar  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInicializar') AND type = 'P') DROP PROCEDURE dbo.spPOSInicializar
GO             
CREATE PROCEDURE spPOSInicializar
	@Empresa		varchar(5),
    @Sucursal		int,
    @Usuario		varchar(10),
    @Estacion          int,
    @ID		varchar(50),
    @DirectorioTrabajo      varchar(255) = NULL
--//WITH ENCRYPTION    	     
AS
BEGIN
	DECLARE 
	@FechaEmision			datetime,
	@FechaRegistro			datetime, 
	@Concepto				varchar(50),
	@Proyecto				varchar(50),
	@UEN					int,
	@Moneda					varchar(10),
	@TipoCambio				float,
	@Cliente				varchar(10),
	@Almacen				varchar(10),
	@Agente					varchar(10),
	@Cajero					varchar(10),
	@FormaEnvio				varchar(50),
	@Condicion				varchar(50),
	@Vencimiento			varchar(50),
	@CtaDinero				varchar(10),
	@Descuento				varchar(50),
	@DescuentoGlobal		varchar(50),
	@ListaPreciosEsp		varchar(20),
	@ZonaImpuesto			varchar(50),	  
	@FormaPago				varchar(50),	
	@ImagenNombreAnexo		varchar(255),	
	@Host					varchar(20),
	@Cluster				varchar(20),	
	@Ok						int,
	@OkRef					varchar(255),
	@RedondeoMonetarios		int,
	@MovClave				varchar(50),
	@SugerirFechaCierre		bit,
	@FechaCierre			datetime,
	@Caja					varchar(10)
	  	  
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)	  
	 
	SELECT @MovClave = m.Clave 
	FROM MovTipo m JOIN POSL p ON m.Mov = p.Mov AND m.Modulo = 'POS' 
	WHERE  p.ID = @ID
   
	--AQUI REFRESCA EN EL MOV NUEVO QUE TOME LA CAJA DEL USUARIO
	SELECT 
		@CtaDinero = DefCtaDinero,	
		@Cajero = DefCajero
    FROM Usuario
	WHERE Usuario = @Usuario
   
	SELECT @SugerirFechaCierre = SugerirFechaCierre   
	FROM POSCfg 
	WHERE Empresa = @Empresa
    
    IF ISNULL(@DirectorioTrabajo,'') <> ''
    BEGIN
       DELETE POSUsuarioEstacion
        WHERE Empresa  = @Empresa
          AND Sucursal = @Sucursal
          AND Estacion = @Estacion
          AND Usuario  = @Usuario

       INSERT POSUsuarioEstacion(Empresa, Sucursal, Estacion, Usuario, Directorio)
       VALUES (@Empresa, @Sucursal, @Estacion, @Usuario, @DirectorioTrabajo)
    END

	SELECT @FechaCierre = Fecha 
	FROM POSFechaCierre 
	WHERE Sucursal = @Sucursal
  
	SELECT @FechaCierre = dbo.fnPOSFechaCierre(@Empresa,@Sucursal,@FechaCierre,@CtaDinero)

	SELECT @FechaEmision = CASE WHEN @SugerirFechaCierre = 1 
									THEN @FechaCierre 
								ELSE dbo.fnFechaSinHora(GETDATE())
								END,
		@FechaRegistro = GETDATE(),
		@Proyecto = u.DefProyecto,
		@UEN = u.UEN,
		@TipoCambio = ROUND(m.TipoCambio,@RedondeoMonetarios),
		@Cliente = u.DefCliente,
		@Almacen = ISNULL(u.DefAlmacen, c.AlmacenDef),
		@Agente = ISNULL(u.DefAgente, c.Agente),
		@Cajero = u.DefCajero,
		@FormaEnvio = c.FormaEnvio,
		@Condicion = c.Condicion,
		@CtaDinero = u.DefCtaDinero,	
		@Descuento = c.Descuento,
		@DescuentoGlobal = d.Porcentaje,
		@ListaPreciosEsp = ISNULL(ISNULL(ISNULL(NULLIF(u.DefListaPreciosEsp,''), NULLIF(c.ListaPreciosEsp,'')), NULLIF(s.ListaPreciosEsp,'')),'(Precio Lista)'),
		@ZonaImpuesto = ISNULL(ISNULL(NULLIF(c.ZonaImpuesto,''),NULLIF(u.DefZonaImpuesto,'')),NULLIF(s.ZonaImpuesto,'')),	 
		@FormaPago = u.DefFormaPago
	FROM Usuario u
    LEFT OUTER JOIN Mon m ON u.DefMoneda = m.Moneda
    LEFT OUTER JOIN Cte c ON u.DefCliente = c.Cliente
    LEFT OUTER JOIN Descuento d ON c.Descuento = d.Descuento     
    LEFT OUTER JOIN Sucursal s ON s.Sucursal = @Sucursal
	WHERE u.Usuario = @Usuario
 
	SELECT TOP 1 @Moneda = Moneda 
    FROM POSLTipoCambioRef 
	WHERE TipoCambio = 1 AND Sucursal = @Sucursal AND EsPrincipal = 1
       
	IF @MovClave IN('POS,N','POS.F')
		BEGIN              
			UPDATE POSL SET 
				Usuario = @Usuario,   
				FechaEmision = @FechaEmision,  
                FechaRegistro = @FechaRegistro,  
                Proyecto = @Proyecto,  
                UEN = @UEN,  
                Moneda = @Moneda,  
                TipoCambio = @TipoCambio,  
                Cliente = @Cliente,  
                Almacen = @Almacen,  
                Agente = @Agente,  
                Cajero = @Cajero,  
                FormaEnvio = @FormaEnvio,  
                Condicion = @Condicion,  
                CtaDinero = @CtaDinero,  
                Descuento = @Descuento,  
                DescuentoGlobal = @DescuentoGlobal,  
                ListaPreciosEsp = @ListaPreciosEsp,  
                ZonaImpuesto = @ZonaImpuesto,
                Caja = @CtaDinero
			WHERE ID = @ID  
		END                   
END
GO


/************************ spPOSImportarVenta  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSImportarVenta') AND type = 'P') DROP PROCEDURE dbo.spPOSImportarVenta
GO             
CREATE PROCEDURE spPOSImportarVenta
	@ID                 int,
    @Estacion           int        
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE
	@IDNuevo              varchar(36),
	@MovGenerar           varchar(20),
	@Ok                   int,
	@Host                 varchar(20),
	@Cluster              varchar(20),
	@Empresa              varchar(5),
	@cfgImpuestoIncluido  bit,
	@Articulo             varchar(20), 
	@SubCuenta            varchar(50), 
	@SerieLote            varchar(50), 
	@Cantidad             float,
	@CantidadS            float,
	@RenglonID            int

	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT 
  
	SELECT @IDNuevo = NEWID()

	INSERT POSL (
		ID, Empresa, Modulo, Mov, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, Estatus, Observaciones, 
		Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Causa, Atencion, AtencionTelefono, 
		ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, Origen, OrigenID, Host, Cluster, Cajero, Importe, Impuestos, Caja)
	SELECT
		@IDNuevo, Empresa, 'VTAS', Origen, FechaEmision, GETDATE(), Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, 'SINAFECTAR', Observaciones, 
		Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Causa, Atencion, AtencionTelefono, 
		ListaPreciosEsp, ZonaImpuesto, SucursalOrigen, 'VTAS', Mov, MovID, @Host, @Cluster, ServicioAseguradora, Importe, Impuestos, CtaDinero
	FROM Venta
	WHERE ID = @ID 
  
	IF @@ERROR <> 0 
		SET @Ok = 1
  
	SELECT @Empresa = Empresa 
	FROM POSL 
	WHERE ID = @IDNuevo
	
	SELECT @cfgImpuestoIncluido = ISNULL(VentaPreciosImpuestoIncluido,0) 
	FROM EmpresaCfg 
	WHERE Empresa = @Empresa
  
	IF @Ok IS NULL
		INSERT POSLVenta(
			ID, Renglon, RenglonID, Aplica, AplicaID, RenglonTipo, Cantidad, CantidadObsequio, Articulo, SubCuenta, 
			Precio, PrecioSugerido, DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, Puntos,
			PrecioImpuestoInc, Codigo, Almacen)
		SELECT
			@IDNuevo, Renglon, RenglonID, Aplica, AplicaID, RenglonTipo, Cantidad, CantidadObsequio, Articulo, SubCuenta, 
			CASE WHEN @cfgImpuestoIncluido = 1 
					THEN  dbo.fnPOSPrecioSinImpuestos(Precio,Impuesto1, Impuesto2, Impuesto3) 
				 ELSE Precio 
				 END, PrecioSugerido, DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, Puntos,
			CASE WHEN @cfgImpuestoIncluido = 0 
					THEN dbo.fnPOSPrecioConImpuestos(Precio,Impuesto1, Impuesto2, Impuesto3, @Empresa) 
				 ELSE Precio 
				 END, Codigo, Almacen
		FROM VentaD 
		WHERE ID = @ID  
  
		IF @@ERROR <> 0 
			SET @Ok = 1  
  
		IF @OK IS NULL
			BEGIN
				DECLARE crArticulo CURSOR FOR
				SELECT  Articulo, SubCuenta, SerieLote, ISNULL(Cantidad,0.0), RenglonID
				FROM SerieLoteMov
				WHERE ID = @ID AND Modulo = 'VTAS' AND Empresa = @Empresa
    
				OPEN crArticulo
				FETCH NEXT FROM crArticulo INTO @Articulo, @SubCuenta, @SerieLote, @Cantidad, @RenglonID
				WHILE @@FETCH_STATUS = 0 
					BEGIN 
						SELECT @CantidadS = @Cantidad
						
						WHILE @CantidadS >0
							BEGIN
								INSERT POSLSerieLote (
									ID, RenglonID,  Articulo,  SubCuenta,  SerieLote)
								SELECT
									@IDNuevo, @RenglonID, @Articulo, @SubCuenta, @SerieLote
							
								SET @CantidadS = @CantidadS -1
							END
      
						FETCH NEXT FROM crArticulo INTO @Articulo, @SubCuenta, @SerieLote, @Cantidad, @RenglonID
					END 
				CLOSE crArticulo
				DEALLOCATE crArticulo     
			END 
  
		SELECT @IDNuevo
END
GO 


/************************ spPOSImportarPedidoFactura *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSImportarPedidoFactura') AND type = 'P') DROP PROCEDURE dbo.spPOSImportarPedidoFactura
GO             
CREATE PROCEDURE spPOSImportarPedidoFactura
	@ID                 int,
    @IDPOS              varchar(36),
    @Estacion           int        
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE
	@MovGenerar           varchar(20),
	@Host                 varchar(20),
	@Cluster              varchar(20),
	@Zona                 varchar(50),
	@Cajero               varchar(10),
	@CtaDinero            varchar(10),
	@CtaDineroDestino     varchar(10),
	@Sucursal             int,
	@Ok                   int,
	@Empresa              varchar(5),
	@cfgImpuestoIncluido   bit,
	@MovClavePedido       varchar(20),  
	@MovSubClavePedido    varchar(20),
	@MonedaPrincipal      varchar(10), 
	@MonedaOrigen         varchar(10),
	@TipoCambioOrigen     float ,
	@SugerirFechaCierre   bit,
	@FechaCierre          datetime,
	@FechaEmision         datetime,
	@Caja                 varchar(10)

	SELECT @MovGenerar = Mov, @Host = Host, @Cluster = Cluster, @Zona = Zona, @Cajero = Cajero, @CtaDinero = CtaDinero,	
		@Sucursal = Sucursal, @CtaDineroDestino = CtaDineroDestino, @Empresa = Empresa, @Caja = Caja
    FROM POSL 
	WHERE ID = @IDPOS
	
	SELECT @cfgImpuestoIncluido = ISNULL(VentaPreciosImpuestoIncluido,0) 
	FROM EmpresaCfg 
	WHERE Empresa = @Empresa   
  
	SELECT @SugerirFechaCierre = SugerirFechaCierre   
	FROM POSCfg 
	WHERE Empresa = @Empresa
  
	SELECT @FechaCierre = Fecha 
	FROM POSFechaCierre 
	WHERE Sucursal = @Sucursal
  
	SELECT @FechaCierre = dbo.fnPOSFechaCierre(@Empresa,@Sucursal,@FechaCierre,@Caja)
   
	SELECT @FechaEmision = CASE WHEN @SugerirFechaCierre = 1 THEN @FechaCierre ELSE dbo.fnFechaSinHora(GETDATE())END    
  
	SELECT  @MonedaPrincipal = Moneda 
    FROM POSLTipoCambioRef m
	WHERE TipoCambio = 1 AND Sucursal = @Sucursal AND EsPrincipal = 1
   
	SELECT @MonedaOrigen = Moneda 
	FROM POSVentaPedidoTemp 
	WHERE ID = @ID AND Estacion = @Estacion   
   
	SELECT @TipoCambioOrigen = TipoCambio 
	FROM POSLTipoCambioRef 
	WHERE Moneda =  @MonedaOrigen AND Sucursal = @Sucursal 
  
	DELETE POSL WHERE ID= @IDPOS 
	DELETE POSLVenta WHERE ID= @IDPOS 
  
	SELECT @MovClavePedido = m.Clave, @MovSubClavePedido = m.SubClave
    FROM MovTipo m JOIN POSVentaPedidoTemp p ON m.Mov = p.Mov AND m.Modulo = 'VTAS'
	WHERE p.ID = @ID

	INSERT POSL (
		ID, Empresa, Mov, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, Estatus, 
		Observaciones, Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Causa, 
		Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, Origen, OrigenID, Host, Cluster, Nombre, Direccion, DireccionNumero, 
		DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, Estado, Pais, Zona, CodigoPostal, RFC, CURP, Modulo, Cajero, 
		CtaDineroDestino, Directo, Caja, PedidoReferencia, PedidoReferenciaID)
	SELECT
		@IDPOS, p.Empresa, @MovGenerar, @FechaEmision, GETDATE(), p.Concepto, p.Proyecto, p.UEN, @MonedaPrincipal, 1.0, p.Usuario, p.Referencia, 'SINAFECTAR',
		p.Observaciones, p.Cliente, p.EnviarA, p.Almacen, p.Agente, p.FormaEnvio, p.Condicion, p.Vencimiento, @CtaDinero, p.Descuento, p.DescuentoGlobal, p.Causa,
		p.Atencion, p.AtencionTelefono, p.ListaPreciosEsp, p.ZonaImpuesto, @Sucursal, 'VTAS', p.Mov, p.MovID, @Host, @Cluster, c.Nombre, c.Direccion, c.DireccionNumero,
		c.DireccionNumeroInt, c.EntreCalles, c.Delegacion, c.Colonia, c.Poblacion, c.Estado, c.Pais, @Zona, c.CodigoPostal, c.RFC, c.CURP,'VTAS', @Cajero, 
		@CtaDineroDestino, 0, @CtaDinero, CASE WHEN @MovClavePedido = 'VTAS.P' AND @MovSubClavePedido = 'VTAS.PEDANT' 
													THEN Mov+' '+MovID 
											   ELSE NULL 
											   END, CASE WHEN @MovClavePedido = 'VTAS.P' AND @MovSubClavePedido = 'VTAS.PEDANT' 
															THEN ID 
														 ELSE NULL 
														 END 
	FROM POSVentaPedidoTemp p JOIN Cte c ON p.Cliente = c.Cliente
	WHERE p.ID = @ID AND p.Estacion = @Estacion
  
	IF @@ERROR <> 0 
		SET @Ok = 1
 
	IF @Ok IS NULL
		INSERT POSLVenta(
			ID, Renglon, RenglonID, Aplica, AplicaID, RenglonTipo, Cantidad, CantidadObsequio, Articulo, SubCuenta, 
			Precio,	PrecioSugerido, 
			DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, Puntos,
			PrecioImpuestoInc,
			Almacen, Aplicado, Codigo)
		SELECT
			@IDPOS, Renglon, RenglonID, Aplica, AplicaID, RenglonTipo, Cantidad, CantidadObsequio, Articulo, SubCuenta, 
			CASE WHEN @cfgImpuestoIncluido = 1 
					THEN  dbo.fnPOSPrecioSinImpuestos(CASE WHEN @MonedaOrigen<> @MonedaPrincipal 
															   THEN Precio*ISNULL(@TipoCambioOrigen,1.0) 
														   ELSE Precio 
														   END, Impuesto1, Impuesto2, Impuesto3) 
					ELSE CASE WHEN @MonedaOrigen<> @MonedaPrincipal 
								 THEN Precio*ISNULL(@TipoCambioOrigen,1.0) 
							  ELSE Precio 
							  END 
					END, CASE WHEN @cfgImpuestoIncluido = 1 
								  THEN dbo.fnPOSPrecioSinImpuestos(CASE WHEN @MonedaOrigen<> @MonedaPrincipal 
																			THEN Precio*ISNULL(@TipoCambioOrigen,1.0) 
																		ELSE CASE WHEN @MonedaOrigen<> @MonedaPrincipal 
																					  THEN Precio*ISNULL(@TipoCambioOrigen,1.0) 
																				  ELSE Precio 
																				  END 
																		END, Impuesto1, Impuesto2, Impuesto3) 
							  ELSE CASE WHEN @MonedaOrigen<> @MonedaPrincipal 
											THEN Precio*ISNULL(@TipoCambioOrigen,1.0) 
										ELSE Precio 
										END 
							  END, 
			DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, Puntos,
			CASE WHEN @cfgImpuestoIncluido = 0 
					THEN dbo.fnPOSPrecioConImpuestos(CASE WHEN @MonedaOrigen<> @MonedaPrincipal 
															THEN Precio*ISNULL(@TipoCambioOrigen,1.0) 
														  ELSE CASE WHEN @MonedaOrigen<> @MonedaPrincipal 
																		THEN Precio*ISNULL(@TipoCambioOrigen,1.0) 
																	ELSE Precio 
																	END 
														  END,Impuesto1, Impuesto2, Impuesto3, @Empresa) 
				 ELSE CASE WHEN @MonedaOrigen<> @MonedaPrincipal 
								THEN Precio*ISNULL(@TipoCambioOrigen,1.0) 
						   ELSE Precio 
						   END 
				 END, Almacen, 1, Codigo
		FROM POSVentaPedidoDTemp 
		WHERE ID = @ID  AND Estacion = @Estacion
  
		IF @@ERROR <> 0 
			SET @Ok = 1  
  
		SELECT @IDPOS
END
GO 


/************************ spPOSSugerirMonedero *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSSugerirMonedero') AND type = 'P') DROP PROCEDURE dbo.spPOSSugerirMonedero
GO             
CREATE PROCEDURE spPOSSugerirMonedero
	@Estacion   int,
	@Empresa    varchar(5),
	@Sucursal   int
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE 
	@Tipo                 varchar(20),
	@Consecutivo          varchar(20)
  
    SELECT @Tipo = ConsecutivoMonedero 
	FROM POSCfg 
	WHERE Empresa = @Empresa

    EXEC spConsecutivo @Tipo, @Sucursal, @Consecutivo OUTPUT

	SELECT @Consecutivo
END
GO 


/**************** spPOSOfertaImportePuntosAplicar ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSOfertaImportePuntosAplicar') and type = 'P') DROP PROCEDURE dbo.spPOSOfertaImportePuntosAplicar
GO
CREATE PROCEDURE spPOSOfertaImportePuntosAplicar
	@ID               	varchar(50),
	@OfertaFechaHora	varchar(20)	= NULL,
    @PuntosPrecio       bit      =       1
--//WITH ENCRYPTION
AS 
BEGIN 
	DECLARE
    @Empresa						varchar(5),
    @Mov							varchar(20),
    @Sucursal						int,
    @Usuario						varchar(10),
    @ListaPrecios					varchar(50),
    @FechaHora						datetime,
    @Estatus						varchar(15),
    @FechaEmision					datetime,
    @FechaRequerida					datetime,
    @HoraRequerida					varchar(5),
    @Moneda							varchar(10),
    @TipoCambio						float,
    @DescuentoGlobal				float,
    @ImporteTotalMN					float,
    @Aplica							bit,
    @Monedero						varchar(20),
    @ArticuloOferta					varchar(20),
    @CodigoRedondeo					varchar(30),
    @ArticuloRedondeo				varchar(20),
    @ArtOfertaImporte				varchar(20),
    @ArtOfertaFP					varchar(20),
    @CfgAnticipoArticuloServicio	varchar(20)    	

	SELECT @CodigoRedondeo = RedondeoVentaCodigo , @ArtOfertaFP = ArtOfertaFP, @ArtOfertaImporte = ArtOfertaImporte
      FROM POSCfg 
	 WHERE Empresa = @Empresa
    
	SELECT @ArticuloRedondeo = Cuenta
      FROM CB
     WHERE Codigo = @CodigoRedondeo
       AND TipoCuenta = 'Articulos'

	SELECT @ArticuloRedondeo = cb.Cuenta 
	  FROM CB 
	 WHERE CB.Cuenta = @CodigoRedondeo AND CB.TipoCuenta = 'Articulos'       
    
	SELECT @CfgAnticipoArticuloServicio = NULLIF(CxcAnticipoArticuloServicio,'')    
	  FROM EmpresaCfg2
	 WHERE Empresa = @Empresa      	

	SELECT @Mov = Mov, @Empresa = Empresa, @Sucursal = Sucursal, @Usuario = Usuario, @Moneda = Moneda, @TipoCambio = TipoCambio, @Estatus = Estatus, 
		   @ListaPrecios = ListaPreciosEsp, @FechaEmision = FechaEmision, @FechaRequerida = FechaEmision, @HoraRequerida = '00:00', 
		   @DescuentoGlobal = DescuentoGlobal,@Monedero = Monedero
      FROM POSL 
	 WHERE ID = @ID
   
	SELECT @ArticuloOferta = ArtOfertaImporte 
	  FROM POSCfg 
	 WHERE Empresa = @Empresa    
  
	IF NULLIF(@Monedero,'') IS NOT NULL AND @PuntosPrecio = 1
		SET @PuntosPrecio = 1 
	ELSE
	    SET @PuntosPrecio = 0 
     
	SET @Aplica = 1

	EXEC xpPOSOfertaAplicar @ID, @Aplica OUTPUT 
  
	IF @Aplica = 1 
	BEGIN
		IF @OfertaFechaHora IS NULL
			SELECT @OfertaFechaHora = OfertaFechaHora FROM EmpresaCfg2 WHERE Empresa = @Empresa

		IF UPPER(@OfertaFechaHora) = 'FECHA SERVIDOR'  
			SELECT @FechaHora = GETDATE() 
		ELSE 
		IF UPPER(@OfertaFechaHora) = 'FECHA EMISION'   
			SELECT @FechaHora = @FechaEmision 
		ELSE 
		IF UPPER(@OfertaFechaHora) = 'FECHA REQUERIDA' 
			SELECT @FechaHora = dbo.FechaConHora(@FechaRequerida, @HoraRequerida)
    
		-- #VENTA 
		CREATE TABLE #Venta (Campo varchar(50) COLLATE Database_Default NOT NULL, Valor varchar(100) COLLATE Database_Default NULL)
    
		EXEC spPOSOfertaVenta @ID
		
		CREATE INDEX Campo ON #Venta (Campo, Valor)

		-- #VENTAD 
		CREATE TABLE #VentaD (
		RID						int NOT NULL IDENTITY(1,1) PRIMARY KEY,
		Renglon					float NOT NULL, 
		RenglonSub				int NOT NULL, 
		RenglonTipo             varchar(1) NOT NULL,
		Articulo				varchar(20) COLLATE Database_Default NOT NULL, 
		SubCuenta				varchar(50) COLLATE Database_Default NULL, 
		Rama					varchar(20) COLLATE Database_Default NULL, 
		Categoria				varchar(50) COLLATE Database_Default NULL, 
		Grupo					varchar(50) COLLATE Database_Default NULL, 
		Familia					varchar(50) COLLATE Database_Default NULL, 
		Linea					varchar(50) COLLATE Database_Default NULL, 
		Fabricante				varchar(50) COLLATE Database_Default NULL, 
		Proveedor				varchar(10) COLLATE Database_Default NULL, 
		ABC						varchar(50) COLLATE Database_Default NULL,
		Cantidad				float NULL, 
		Unidad					varchar(50) COLLATE Database_Default NULL, 
		CantidadInventario		float NULL, 
		PrecioSugerido			float NULL, 
		Precio					float NULL, 
		Impuesto1				float NULL,
		Descuento				float NULL, 
		DescuentoP1				float NULL,
		DescuentoP2				float NULL,
		DescuentoP3				float NULL,
		DescuentoG1				float NULL,
		DescuentoG2				float NULL,
		DescuentoG3				float NULL,
		DescuentoImporte		float NULL, 
		Puntos					float NULL, 
		PuntosPorcentaje		float NULL, 
		Comision				float NULL, 
		ComisionPorcentaje		float NULL, 
		CantidadObsequio		float NULL, 
		OfertaID				int NULL,
		OfertaIDP1				int NULL,
		OfertaIDP2				int NULL,
		OfertaIDP3				int NULL,
		OfertaIDG1				int NULL,
		OfertaIDG2				int NULL,
		OfertaIDG3				int NULL,
		DescuentoAd				int	NULL)

		CREATE TABLE #ArtObsequio (Articulo varchar(20) COLLATE Database_Default NOT NULL, OfertaID INT NULL, Unidad varchar(50) NULL, SubCuenta varchar(50) NULL)

		CREATE TABLE #OfertaLog (
		RID						int NOT NULL IDENTITY(1,1) PRIMARY KEY,
		OfertaID				int NOT NULL,
		Mov						varchar(20)NULL,
		MovID					varchar(20)NULL,
		Prioridad				int NULL,
		PrioridadG				int NULL,
		Tipo					varchar(50)NULL,
		Forma					varchar(50)NULL,
		Usar					varchar(50)NULL,
		Articulo				varchar(20) COLLATE Database_Default NOT NULL, 
		SubCuenta				varchar(50) COLLATE Database_Default NULL, 
		Unidad					varchar(50) COLLATE Database_Default NULL, 
		Descuento				float NULL,
		DescuentoImporte		money NULL, 
		Puntos					float NULL, 
		PuntosPorcentaje		float NULL, 
		Comision				float NULL, 
		ComisionPorcentaje		float NULL, 
		CantidadObsequio		float NULL,
		Costo					float NULL,
		PrecioBaseCosto			float NULL,
		PrecioBaseLista			float NULL,
		Precio					float NULL,
		ArticuloObsequio		varchar(20)NULL,
		UnidadObsequio			varchar(5) NULL,
		SubCuentaObsequio		varchar(50) NULL,
		ArtTipo					varchar(20)NULL,
		CantidadOferta			float NULL,
		DescuentoP1				float NULL,
		DescuentoP2				float NULL,
		DescuentoP3				float NULL,
		DescuentoG1				float NULL,
		DescuentoG2				float NULL,
		DescuentoG3				float NULL,
		SucursalDetalle			int	 NULL,
		OfertaIDP1				int NULL,
		OfertaIDP2				int NULL,
		OfertaIDP3				int NULL,
		OfertaIDG1				int NULL,
		OfertaIDG2				int NULL,
		OfertaIDG3				int NULL,
		Descripcion				varchar(255) NULL)

		INSERT #VentaD (
			Renglon, RenglonSub, RenglonTipo, Articulo, SubCuenta, Rama, Categoria, Grupo, Familia, Linea, Fabricante, Proveedor, 
			Cantidad, Unidad, PrecioSugerido, CantidadInventario, 
			OfertaID, OfertaIDP1, OfertaIDP2, OfertaIDP3, OfertaIDG1, OfertaIDG2, OfertaIDG3, DescuentoP1, DescuentoP2, 
			DescuentoP3, DescuentoG1, DescuentoG2, DescuentoG3, Descuento, DescuentoAd) 
		SELECT 
			d.Renglon, d.RenglonSub, d.RenglonTipo,d.Articulo, d.SubCuenta, a.Rama, a.Categoria, a.Grupo, a.Familia, a.Linea, a.Fabricante, a.Proveedor, 
			d.Cantidad, d.Unidad, d.PrecioSugerido, ISNULL(ISNULL(d.CantidadInventario, d.Cantidad*dbo.fnArtUnidadFactor(@Empresa, d.Articulo, d.Unidad)), 0.0),
			d.OfertaID, d.OfertaIDP1, d.OfertaIDP2, d.OfertaIDP3, d.OfertaIDG1, d.OfertaIDG2, d.OfertaIDG3, d.DescuentoP1, d.DescuentoP2, 
			d.DescuentoP3, d.DescuentoG1, d.DescuentoG2, d.DescuentoG3, d.DescuentoLinea, d.DescuentoAd
		FROM POSLVenta d
		JOIN Art a ON a.Articulo = d.Articulo
		WHERE d.ID = @ID 
		AND ISNULL(d.Aplicado,0) = 0
		AND d.Articulo NOT IN(@ArticuloRedondeo,@CfgAnticipoArticuloServicio,@ArtOfertaFP,@ArtOfertaImporte)
		AND d.RenglonTipo <> 'K'       

		CREATE INDEX Renglon    ON #VentaD (Renglon, RenglonSub)
		CREATE INDEX Articulo   ON #VentaD (Articulo)
		CREATE INDEX Rama       ON #VentaD (Rama)
		CREATE INDEX Categoria  ON #VentaD (Categoria)
		CREATE INDEX Grupo      ON #VentaD (Grupo)
		CREATE INDEX Familia    ON #VentaD (Familia)
		CREATE INDEX Linea      ON #VentaD (Linea)
		CREATE INDEX Fabricante ON #VentaD (Fabricante)

		-- #OFERTAACTIVA
		CREATE TABLE #OfertaActiva (ID int NOT NULL PRIMARY KEY, Sucursal int NULL, MovTipo varchar(20) COLLATE Database_Default NULL)
		
		EXEC spOfertaPrecioSugerido @Empresa, @Sucursal, @Moneda, @TipoCambio, @ListaPrecios

		IF (SELECT NULLIF(IDDevolucion,'') FROM POSL WHERE ID = @ID) IS NOT NULL
			RETURN

		IF (SELECT NULLIF(IDDevolucionP,'') FROM POSL WHERE ID = @ID) IS NOT NULL
			RETURN

		SELECT @ImporteTotalMN = SUM(Cantidad*PrecioSugerido)*@TipoCambio FROM #VentaD
	      
		EXEC spOfertaActiva @Empresa, @Sucursal, @FechaHora, @ImporteTotalMN

		EXEC spOfertaProcesar @Empresa, @Sucursal, @Moneda, @TipoCambio, @ListaPrecios, @ID = NULL, @PuntosPrecio=@PuntosPrecio

		UPDATE #VentaD
		   SET Descuento = dbo.fnPorcentajeImporte(t.Cantidad*d.PrecioImpuestoInc, t.DescuentoImporte)     
		  FROM POSLVenta d 
		  JOIN #VentaD t ON t.Renglon = d.Renglon AND t.RenglonSub = d.RenglonSub AND t.RenglonTipo = d.RenglonTipo
		 WHERE d.ID = @ID AND d.RenglonTipo <>'C' AND NULLIF(t.DescuentoImporte, 0.0) IS NOT NULL
		   AND ISNULL(d.Aplicado,0) = 0     

		UPDATE #VentaD
		   SET Puntos = dbo.fnPorcentaje(dbo.fnDisminuyePorcentaje(Cantidad*Precio, Descuento), PuntosPorcentaje)
		 WHERE NULLIF(PuntosPorcentaje, 0.0) IS NOT NULL

		UPDATE #VentaD
		   SET Puntos = Puntos--*Cantidad
		 WHERE Puntos IS NOT NULL AND NULLIF(PuntosPorcentaje, 0.0) IS NULL

		UPDATE #VentaD
		   SET Comision = dbo.fnPorcentaje(dbo.fnDisminuyePorcentaje(Cantidad*Precio, Descuento), ComisionPorcentaje)
		 WHERE NULLIF(ComisionPorcentaje, 0.0) IS NOT NULL

		IF (SELECT SUM(ISNULL(CantidadObsequio,0)) FROM POSLVenta WHERE ID = @ID) > = 0
		BEGIN
			UPDATE POSLVenta
			   SET PrecioSugerido		= ISNULL(d.PrecioSugerido, t.PrecioSugerido),
				   Precio				= dbo.fnPOSPrecio(@Empresa,ISNULL(t.Precio, t.PrecioSugerido),d.Impuesto1, d.Impuesto2, d.Impuesto3),
				   DescuentoImporte		= ISNULL(d.DescuentoImporte, t.DescuentoImporte),
				   Puntos				= t.Puntos, --dbo.fnImporteMonTarjeta2(t.Puntos,@Monedero,t.OfertaID,@Sucursal), -- BUG 12272
				   Comision				= t.Comision,
				   CantidadObsequio		= t.CantidadObsequio,
				   DescuentoLinea		= CASE WHEN 
													CASE WHEN ISNULL(t.DescuentoImporte, d.DescuentoImporte) = 0 THEN d.DescuentoImporte ELSE 0 END 
													> 0 THEN ISNULL(t.Descuento,DescuentoLinea) 
													ELSE ISNULL(DescuentoLinea, ISNULL(t.DescuentoG1, (ISNULL(t.DescuentoG2, t.DescuentoG3 )))) END,
				   DescuentoP1			= ISNULL(t.DescuentoP1,d.DescuentoP1),
				   DescuentoP2			= ISNULL(t.DescuentoP2,d.DescuentoP2),
				   DescuentoP3			= ISNULL(t.DescuentoP3,d.DescuentoP3),
				   DescuentoG1			= ISNULL(t.DescuentoG1,d.DescuentoG1),
				   DescuentoG2			= ISNULL(t.DescuentoG2,d.DescuentoG2),
				   DescuentoG3			= ISNULL(t.DescuentoG3,d.DescuentoG3),
				   OfertaID				= t.OfertaID,
				   OfertaIDP1			= t.OfertaIDP1,
				   OfertaIDP2			= t.OfertaIDP2,
				   OfertaIDP3			= t.OfertaIDP3,
				   OfertaIDG1			= t.OfertaIDG1,
				   OfertaIDG2			= t.OfertaIDG2,
				   OfertaIDG3			= t.OfertaIDG3
			  FROM POSLVenta d 
			  JOIN #VentaD t ON t.Renglon = d.Renglon AND t.RenglonSub = d.RenglonSub AND t.RenglonTipo = d.RenglonTipo
			 WHERE d.ID = @ID AND d.RenglonTipo <>'C'
			   AND ISNULL(d.Aplicado,0) = 0
			
			UPDATE POSLVenta
			   SET DescuentoLinea = dbo.fnPorcentajeImporte(t.Cantidad*d.PrecioImpuestoInc, d.DescuentoImporte)      
			  FROM POSLVenta d 
			  JOIN #VentaD t ON t.Renglon = d.Renglon AND t.RenglonSub = d.RenglonSub AND t.RenglonTipo = d.RenglonTipo
			 WHERE d.ID = @ID AND d.RenglonTipo <>'C'
			   AND ISNULL(d.Aplicado,0) = 0 AND d.DescuentoImporte > 0     
					
			UPDATE POSLVenta 
			   SET PrecioImpuestoInc = dbo.fnPOSPrecioConImpuestos(Precio,Impuesto1, Impuesto2, Impuesto3, @Empresa)
			 WHERE ID = @ID AND RenglonTipo <>'C'
			   AND ISNULL(Aplicado,0) = 0  

		END
	END

	RETURN
END
GO


/************************ spPOSOfertaPuntosImporte *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSOfertaPuntosImporte') AND type = 'P') DROP PROCEDURE dbo.spPOSOfertaPuntosImporte
GO             
CREATE PROCEDURE spPOSOfertaPuntosImporte	     
	@Empresa    varchar(5),
	@Estacion   int,
	@ID         varchar(36),
	@Ok         int = NULL OUTPUT ,
	@OkRef      varchar(255) = NULL OUTPUT 
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE 
	@ArticuloOferta			varchar(20),
	@ImporteTotal			float,
	@ImporteTotalMN			float,
	@ImporteOferta			float,
	@CantidadOferta			float,
	@PorcentajeOferta		float,
	@Renglon				float,
	@RenglonID				int,
	@Unidad					varchar(50),
	@CodigoRedondeo			varchar(50),
	@ArticuloRedondeo		varchar(20),
	@IDOferta				int,
	@Usar					varchar(50),
	@Forma					varchar(50),
	@Puntos					float,
	@Sucursal				int,
	@CantidadMoneda			varchar(10),
	@Moneda					varchar(10),
	@MonedaMov				varchar(10),
	@MonedaPrincipal		varchar(10),
	@TipoCambio				float,
	@TipoCambioMov			float,
	@Monedero				varchar(20),
	@MonedaTarjeta			varchar(10),
	@TipoCambioTarjeta		float,
	@TipoCambioCantidad		float,
	@LDI					int,
	@Usuario				varchar(10),
	@Movimeinto				varchar(20),
	@MovClave				varchar(20),	
	@MovSubClave			varchar(20)
  
	SELECT @Sucursal = Sucursal,@MonedaMov = Moneda, @Monedero = Monedero, @Usuario = Usuario, @Movimeinto = Mov 
	  FROM POSL 
	 WHERE ID = @ID
  
	SELECT @MovClave = Clave, @MovSubClave = Subclave 
	  FROM MovTipo 
	 WHERE Mov = @Movimeinto AND Modulo = 'POS'
  
	SELECT @MonedaTarjeta = Moneda 
	  FROM POSValeSerie 
	 WHERE Serie = @Monedero
  
	SELECT @TipoCambioTarjeta = TipoCambio 
	  FROM POSLTipoCambioRef 
	 WHERE Moneda = @MonedaTarjeta AND Sucursal = @Sucursal 
  
	SELECT @MonedaPrincipal = Moneda 
      FROM POSLTipoCambioRef m
	 WHERE TipoCambio = 1 AND Sucursal = @Sucursal AND EsPrincipal = 1
   
	IF @MonedaMov <> @MonedaPrincipal
		SELECT @TipoCambioMov = TipoCambio FROM POSLTipoCambioRef WHERE Moneda = @MonedaMov AND Sucursal = @Sucursal 
	ELSE 
		SELECT   @TipoCambioMov = 1.0
   
	SELECT @ArticuloOferta = ArtOfertaImporte, @CodigoRedondeo = RedondeoVentaCodigo, @LDI = MonederoLDI 
	  FROM POSCfg 
	 WHERE Empresa = @Empresa

	SELECT @ArticuloRedondeo = Cuenta 
	  FROM CB 
	 WHERE Codigo = @CodigoRedondeo AND TipoCuenta = 'Articulos'	    
    
	IF NULLIF(@ArticuloOferta,'') IS NOT NULL
	BEGIN
		SELECT @ImporteTotal = SUM(dbo.fnPOSImporteMov(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * (ISNULL(p.DescuentoGlobal,0.0)/100)))), plv.Impuesto1, plv.Impuesto2, plv.Impuesto3, plv.Cantidad))
		  FROM POSLVenta plv 
		  JOIN POSL p ON p.ID = plv.ID
		 WHERE plv.ID = @ID    
		   AND plv.Articulo <> @ArticuloRedondeo  
        
		SELECT @Unidad = Unidad 
		  FROM Art 
		 WHERE Articulo = @ArticuloOferta
			
		IF NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo = @ArticuloOferta AND RenglonTipo = 'O')
		BEGIN
			SELECT @Renglon = ISNULL(MAX(Renglon),0.0) +2048.0,
				   @RenglonID = ISNULL(MAX(RenglonID),0) + 1 
			  FROM POSLVenta 
			  WHERE ID = @ID
        
			INSERT POSLVenta(ID, Renglon, RenglonID,	RenglonTipo,	Articulo,			PrecioSugerido, Cantidad,	DescuentoImporte, DescuentoLinea, Unidad,  Aplicado,AplicaDescGlobal)
			SELECT			@ID, @Renglon, @RenglonID, 'O',				@ArticuloOferta,	@ImporteTotal,	1,			0.0,			  0.0,			  @Unidad, 0,		0
		
			IF @@ERROR <> 0 SET @Ok = 1    
		END
		ELSE
		BEGIN
			UPDATE POSLVenta SET Aplicado = 0, PrecioSugerido = @ImporteTotal WHERE ID = @ID AND Articulo = @ArticuloOferta AND RenglonTipo = 'O'
				
			IF @@ERROR <> 0 SET @Ok = 1
		END

		EXEC spPOSOfertaImportePuntosAplicar   @ID, NULL, 1    

	END

	IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo = @ArticuloOferta AND RenglonTipo = 'O' AND OfertaID IS NOT NULL)
	BEGIN
		SELECT @IDOferta = OfertaID 
		  FROM POSLVenta 
		 WHERE ID = @ID AND Articulo = @ArticuloOferta AND RenglonTipo = 'O' 
			
		SELECT @Forma = UPPER(Forma), @Usar = UPPER(Usar), @Moneda = Moneda
		  FROM Oferta 
		 WHERE ID = @IDOferta
      
		SELECT @ImporteOferta = Importe, @CantidadOferta = Cantidad, @PorcentajeOferta = Porcentaje, @CantidadMoneda=Moneda
		  FROM OfertaD 
		 WHERE ID = @IDOferta AND Articulo = @ArticuloOferta
     
		SELECT @TipoCambio = TipoCambio 
		  FROM POSLTipoCambioRef 
		 WHERE Moneda = @Moneda AND Sucursal = @Sucursal 
    
		SELECT @ImporteOferta =  ((@ImporteOferta/ISNULL(@TipoCambio,1.0))*(ISNULL(@TipoCambioMov,1.0)))
  
		IF @Forma = 'IMPORTE/PUNTOS'
		BEGIN
			IF @Usar = 'IMPORTE/CANTIDAD'
			BEGIN 
				SELECT @TipoCambioCantidad = TipoCambio FROM POSLTipoCambioRef WHERE Moneda = @CantidadMoneda AND Sucursal = @Sucursal 
        
				SELECT @Puntos = (FLOOR(ISNULL(@ImporteTotal,0.0)/ISNULL(@ImporteOferta,0.0))*ISNULL(@CantidadOferta,0.0))  
			END
      
			IF @Usar = 'IMPORTE/PORCENTAJE'
				SELECT @Puntos = (FLOOR(ISNULL(@ImporteTotal,0.0)/ISNULL(@ImporteOferta,0.0))*(ISNULL(@ImporteOferta,0.0)*(ISNULL(@PorcentajeOferta,0.0)/100)))

		END

		SELECT @Puntos= dbo.fnImporteMonTarjeta(@Puntos,@CantidadMoneda,@TipoCambioCantidad,@MonedaTarjeta,@TipoCambioTarjeta,@Sucursal)
		
		UPDATE POSLVenta SET Aplicado = 1, Precio = NULL, PrecioSugerido = NULL, PrecioImpuestoInc= NULL,Puntos = @Puntos
		 WHERE ID = @ID AND Articulo = @ArticuloOferta AND RenglonTipo = 'O'
  
		IF @@ERROR <> 0 SET @Ok = 1 
	END
	
	IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo = @ArticuloOferta AND RenglonTipo = 'O' AND (OfertaID IS NULL OR NULLIF(Puntos,0.0) IS NULL))    
		DELETE POSLVenta WHERE ID = @ID AND Articulo = @ArticuloOferta AND RenglonTipo = 'O'
  
	IF @@ERROR <> 0 SET @Ok = 1  
END
GO 

/************************ spPOSGenerarAnticipo  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSGenerarAnticipo') AND type = 'P') DROP PROCEDURE dbo.spPOSGenerarAnticipo
GO             
CREATE PROCEDURE spPOSGenerarAnticipo
	@Estacion           int,
    @ID                 varchar(36),
    @Codigo             varchar(50),
    @Ok                 int  OUTPUT,
    @OkRef              varchar(255) OUTPUT            
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE
	@ConceptoCxc       varchar(50),
	@ImpuestosPorc     float,
	@Impuestos         float,
	@ImporteSImp       float,
	@Importe           float
   
	SELECT @ConceptoCxc = Concepto 
	FROM POSL 
	WHERE ID = @ID
   
	SELECT @ImpuestosPorc = Impuestos 
	FROM Concepto 
	WHERE Concepto = @ConceptoCxc AND Modulo = 'CXC'
   
	SELECT @Importe = CONVERT(float,@Codigo)  
   
	SELECT @ImporteSImp = ISNULL(@Importe,0.0)/(1+(ISNULL(@ImpuestosPorc,0.0)/100))
   
	SELECT @Impuestos = ISNULL(@Importe,0.0) - ISNULL(@ImporteSImp,0.0)
   
	IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID)
		DELETE POSLVenta WHERE ID = @ID
   
	INSERT POSLVenta(
		ID, Renglon, RenglonID, RenglonTipo, Cantidad, Articulo, Precio, Impuesto1)
    SELECT
		@ID, 2048.0, 1, 'K', 1, 'ANTICIPO', ISNULL(@ImporteSImp,0.0), @ImpuestosPorc
    
	UPDATE POSLVenta SET PrecioImpuestoInc = @Importe
    WHERE ID = @ID   
     
	UPDATE POSL SET Importe = @ImporteSImp, Impuestos = @Impuestos
    WHERE ID = @ID       
END
GO 


 /************************ spPOSInsertarPOSLCBAccionTemp  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarPOSLCBAccionTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarPOSLCBAccionTemp
GO             
CREATE PROCEDURE spPOSInsertarPOSLCBAccionTemp
	@Estacion           int            
--//WITH ENCRYPTION             
AS 
BEGIN
	DELETE POSLCBAccionTemp WHERE Estacion = @Estacion
   
	INSERT POSLCBAccionTemp (
		Estacion, Codigo, Accion, CodigoAnterior)
	SELECT
		@Estacion,Codigo, Accion, Codigo
    FROM CB 
    WHERE  TipoCuenta = 'Accion'
    
	INSERT POSLCBAccionTemp (
		Estacion, Codigo, Accion, CodigoAnterior)
	SELECT
		@Estacion, NULL, Accion, NULL
    FROM POSAccion
	WHERE Accion NOT IN(SELECT Accion FROM  CB   WHERE  TipoCuenta = 'Accion')
END
GO 


/************************ spPOSActualizarCBAccion  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSActualizarCBAccion') AND type = 'P') DROP PROCEDURE dbo.spPOSActualizarCBAccion
GO             
CREATE PROCEDURE spPOSActualizarCBAccion
	@Estacion           int            
--//WITH ENCRYPTION             
AS 
BEGIN
	IF EXISTS(SELECT * FROM POSLCBAccionTemp WHERE CodigoAnterior IS NOT NULL AND Codigo <> CodigoAnterior AND NULLIF(Codigo,'') IS NOT NULL AND Estacion = @Estacion)
		BEGIN
			UPDATE CB  SET Codigo = a.Codigo
			FROM POSLCBAccionTemp a JOIN CB c ON  a.Accion = c.Accion AND c.Codigo = a.CodigoAnterior AND c.TipoCuenta = 'Accion'
			WHERE a.CodigoAnterior IS NOT NULL AND a.Codigo <> a.CodigoAnterior AND NULLIF(a.Codigo,'') IS NOT NULL AND  a.Estacion = @Estacion
		END
  
	IF EXISTS(SELECT * FROM POSLCBAccionTemp WHERE CodigoAnterior IS NOT NULL AND Codigo <> CodigoAnterior AND NULLIF(Codigo,'') IS  NULL AND Estacion = @Estacion)
		BEGIN
			DELETE CB  WHERE Codigo IN(SELECT CodigoAnterior FROM POSLCBAccionTemp 
									   WHERE CodigoAnterior IS NOT NULL AND Codigo <> CodigoAnterior AND NULLIF(Codigo,'') IS  NULL AND Estacion = @Estacion)
		END  
  
	IF EXISTS (SELECT * FROM POSLCBAccionTemp WHERE CodigoAnterior IS NULL AND NULLIF(Codigo,'') IS NOT NULL AND Estacion = @Estacion)
		BEGIN
			INSERT CB(
				Codigo, TipoCuenta, Accion)
			SELECT
				Codigo, 'Accion', Accion
			FROM POSLCBAccionTemp
			WHERE CodigoAnterior IS NULL AND Codigo IS NOT NULL AND Estacion = @Estacion
		END
END
GO


/**************** fnPOSValidarCB ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidarCB') DROP FUNCTION fnPOSValidarCB
GO
CREATE FUNCTION dbo.fnPOSValidarCB (
	@Codigo   varchar(30)
) 
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  bit
  
	SELECT @Resultado = 0  
  
	IF EXISTS (SELECT * FROM CB WHERE Codigo = @Codigo)
		SELECT @Resultado = 1
  
	RETURN (@Resultado)
END
GO


/**************** spPOSAplicarAnticiposTipoServicio ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSAplicarAnticiposTipoServicio') and type = 'P') DROP PROCEDURE dbo.spPOSAplicarAnticiposTipoServicio
GO             
CREATE PROCEDURE spPOSAplicarAnticiposTipoServicio
	@Estacion		int,
	@ID			Varchar(50)		
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @Transaccion					varchar(50),
    @Ok								int,
	@OkRef							varchar(255),
    @Empresa						varchar(5),
    @Cliente						varchar(10),
    @CfgAnticipoTipoServicio		bit,
    @CfgAnticipoArticuloServicio	varchar(20),
    @CfgMultiUnidades				bit,
    @CfgVentaFactorDinamico			bit,
    @MovMoneda						varchar(10),    
    @MovTipoCambio					float,    
    @Moneda							varchar(10), 
    @TipoCambio						float,
    @Importe						float,
    @Impuestos						float,
    @Retencion						float,
    @PorcentajeImpuesto				float,
    @PorcentajeRetencion			float,
    @AnticipoAplicar				float,
    @AnticipoSaldo					float,    
    @MovAnticipoAplicarSImp      	float,
    @MovAnticipoAplicarCimp			float,
    @Renglon						float,
    @RenglonID						int,    
    @Almacen						varchar(10),
    @Unidad							varchar(50),
    @Sucursal						int,
    @AsignoAnticipo					bit,
    @PreciosIVAIncluido				bit,
    @CantidadInventario				float,
    @UnidadFactor					float								    

	SELECT @Ok = NULL, @OkRef = NULL
  
	SELECT 
		@Empresa = Empresa,
		@Cliente = Cliente,
		@MovMoneda  = Moneda,
		@MovTipoCambio = TipoCambio,
		@Almacen = Almacen,
		@Sucursal = Sucursal  
    FROM POSL 
	WHERE ID = @ID

	SELECT @PreciosIVAIncluido = VentaPreciosImpuestoIncluido
    FROM EmpresaCfg
	WHERE Empresa = @Empresa 

	SELECT
		@CfgAnticipoTipoServicio     = ISNULL(CxcAnticipoTipoServicio,0),
		@CfgAnticipoArticuloServicio = NULLIF(CxcAnticipoArticuloServicio,''),
		@CfgMultiUnidades            = ISNULL(MultiUnidades,0),
		@CfgVentaFactorDinamico      = ISNULL(VentaFactorDinamico,0)
    FROM EmpresaCfg2
	WHERE Empresa = @Empresa 
   
	IF @CfgAnticipoArticuloServicio IS NULL 
		SELECT @Ok = 10490, @OkRef = @Empresa

	SELECT @Unidad = Unidad 
	FROM Art 
	WHERE Articulo = @CfgAnticipoArticuloServicio  
  
	IF @CfgAnticipoTipoServicio = 1 AND @Ok IS NULL 
		BEGIN  
			SELECT @Renglon = ISNULL(MAX(ISNULL(Renglon,0.0)),0.0) + 2048.0 
			FROM POSLVenta 
			WHERE ID = @ID
			
			SELECT @RenglonID = ISNULL(MAX(ISNULL(RenglonID,0)),0.0) + 1 
			FROM POSLVenta 
			WHERE ID = @ID    
    
			SET @AsignoAnticipo = 0
    
			DECLARE crAnticiposFacturados CURSOR FOR
			SELECT 
				Moneda, 
				ISNULL(TipoCambio,0.0), 
				SUM(ISNULL(Importe,0.0)), 
				SUM(ISNULL(Impuestos,0.0)), 
				SUM(ISNULL(Retencion,0.0)), 
				(ISNULL(Impuestos,0.0)/ISNULL(Importe,0.0))*100.0, 
				(ISNULL(Retencion,0.0)/ISNULL(Importe,0.0))*100.0, 
				SUM(ISNULL(AnticipoAplicar,0.0)), 
				SUM(ISNULL(AnticipoSaldo,0.0)) 
			FROM POSCxcAnticipoTemp
			WHERE AnticipoSaldo > 0.0
			AND Cliente = @Cliente
			AND ISNULL(AnticipoAplicar,0.0) > 0.0
			AND Estacion = @Estacion
			GROUP BY Moneda, ISNULL(TipoCambio,0.0), (ISNULL(Impuestos,0.0)/ISNULL(Importe,0.0))*100.0, (ISNULL(Retencion,0.0)/ISNULL(Importe,0.0))*100.0
      
			OPEN crAnticiposFacturados
			FETCH NEXT FROM crAnticiposFacturados INTO @Moneda, @TipoCambio, @Importe, @Impuestos, @Retencion, @PorcentajeImpuesto, @PorcentajeRetencion, 
				@AnticipoAplicar, @AnticipoSaldo
			WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
				BEGIN
					IF @PreciosIVAIncluido = 0
						BEGIN
							SET @MovAnticipoAplicarSImp = (((@AnticipoAplicar*@TipoCambio)/@MovTipoCambio)/(1+(@PorcentajeImpuesto/100.0)))*(1+(@PorcentajeRetencion/100.0))
							SET @Retencion = @MovAnticipoAplicarSImp*(@PorcentajeRetencion/100.0)          
						END        
					ELSE  
						BEGIN       
							SET @MovAnticipoAplicarCimp = (((@AnticipoAplicar*@TipoCambio)/@MovTipoCambio)*(1+(@PorcentajeRetencion/100.0)))            
							SET @Retencion = (((@AnticipoAplicar*@TipoCambio)/@MovTipoCambio)/(1+(@PorcentajeImpuesto/100.0)))*(1+(@PorcentajeRetencion/100.0)) 
								* (@PorcentajeRetencion/100.0)          
						END  
      
					SET @MovAnticipoAplicarSImp = (((@AnticipoAplicar*@TipoCambio)/@MovTipoCambio)/(1+(@PorcentajeImpuesto/100.0)))*(1+(@PorcentajeRetencion/100.0)) 
					SET @MovAnticipoAplicarSImp = (((@AnticipoAplicar*@TipoCambio)/@MovTipoCambio)/(1+(@PorcentajeImpuesto/100.0)))*(1+(@PorcentajeRetencion/100.0))
					SET @CantidadInventario = NULL
					SET @UnidadFactor = NULL
      
					IF @CfgMultiUnidades = 1 AND @CfgVentaFactorDinamico = 1
						BEGIN      
							EXEC spUnidadFactor @Empresa, @CfgAnticipoArticuloServicio, NULL, @Unidad, @UnidadFactor OUTPUT      
						END  
      
					INSERT POSLVenta (
						ID, Renglon, RenglonSub, RenglonID,  RenglonTipo, Articulo, Precio, Impuesto1, Impuesto2, Impuesto3, Cantidad, CantidadInventario, 
						Unidad, Factor, AnticipoFacturado, AnticipoRetencion, PrecioImpuestoInc, Aplicado,AplicaDescGlobal)
					VALUES (
						@ID, @Renglon, 0, @RenglonID, 'N', @CfgAnticipoArticuloServicio, @MovAnticipoAplicarSImp, ROUND(@PorcentajeImpuesto,2,2), 0.0, 0.0, -1,
						-1 * @UnidadFactor, @Unidad, 1, 1, @Retencion, @MovAnticipoAplicarCimp, 1, 0)
    
					SET @Renglon = @Renglon + 2048.0
					SET @RenglonID = @RenglonID + 1      
					SET @AsignoAnticipo = 1
      
					FETCH NEXT FROM crAnticiposFacturados INTO @Moneda, @TipoCambio, @Importe, @Impuestos, @Retencion, @PorcentajeImpuesto, @PorcentajeRetencion,
						@AnticipoAplicar, @AnticipoSaldo    
				END
			CLOSE crAnticiposFacturados
			DEALLOCATE crAnticiposFacturados
    
			IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND ISNULL(AnticipoFacturado,0) = 1)
				UPDATE POSL 
				SET AnticipoFacturadoTipoServicio = 1
				WHERE ID = @ID
		END
END
GO


/************************ spPOSInsertarPOSLSerieLoteTemp  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarPOSLSerieLoteTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarPOSLSerieLoteTemp
GO             
CREATE PROCEDURE spPOSInsertarPOSLSerieLoteTemp
	@Estacion           int,
    @ID                 varchar(50),
    @RenglonID          int
--//WITH ENCRYPTION             
AS 
BEGIN
	DELETE POSLSerieLoteTemp WHERE Estacion = @Estacion
   
	INSERT POSLSerieLoteTemp (Estacion, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad)
	SELECT @Estacion, @ID, @RenglonID, Articulo, ISNULL(SubCuenta,''), SerieLote, COUNT(*)
    FROM POSLSerieLote
    WHERE ID = @ID AND RenglonID = @RenglonID
	GROUP BY Articulo, ISNULL(SubCuenta,''), SerieLote, RenglonID     
END
GO 	  


/************************ spPOSInsertarPOSLSerieLote *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarPOSLSerieLote') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarPOSLSerieLote
GO             
CREATE PROCEDURE spPOSInsertarPOSLSerieLote
	@Estacion           int,
    @ID                 varchar(50),
    @RenglonID          int
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE
	@Cantidad     float,
	@CantidadS    float,
	@Articulo     varchar(20), 
	@SubCuenta    varchar(50), 
	@SerieLote    varchar(50)
  
	DELETE POSLSerieLote WHERE ID = @ID AND RenglonID = @RenglonID
	
	DECLARE crArticulo CURSOR FOR
	SELECT  Articulo, SubCuenta, SerieLote, ISNULL(Cantidad,0.0)
    FROM POSLSerieLoteTemp
    WHERE Estacion = @Estacion AND ID = @ID AND RenglonID = @RenglonID
  
	OPEN crArticulo
	FETCH NEXT FROM crArticulo INTO @Articulo, @SubCuenta, @SerieLote, @Cantidad
	WHILE @@FETCH_STATUS = 0 
		BEGIN 
			SELECT @CantidadS = @Cantidad
			
			WHILE @CantidadS >0
				BEGIN
					INSERT POSLSerieLote (
						ID, RenglonID,  Articulo,  SubCuenta,  SerieLote)
					SELECT
						@ID, @RenglonID, @Articulo, @SubCuenta, @SerieLote
					
					SET @CantidadS = @CantidadS -1
				END
			
			FETCH NEXT FROM crArticulo INTO @Articulo, @SubCuenta, @SerieLote, @Cantidad
		END 
	CLOSE crArticulo
	DEALLOCATE crArticulo   
END
GO 	


/************************ spPOSRepArtSinVentas *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSRepArtSinVentas') AND type = 'P') DROP PROCEDURE dbo.spPOSRepArtSinVentas
GO             
CREATE PROCEDURE spPOSRepArtSinVentas
	@Empresa            varchar(5),
    @Sucursal           int,
    @FechaD             datetime,
    @FechaA             datetime        
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE 
	@SucursalD int,
	@Moneda        varchar(10),
	@TipoCambio    float,
	@ListaPrecios  varchar(20)

	DECLARE @Tabla table (
		Empresa       varchar(5),
		NSucursal     int,
		SucNombre     varchar(100),
		Articulo      varchar(20),
		SubCuenta     varchar(50),
		ListaPrecios  varchar(20))

	DECLARE crArticulo CURSOR LOCAL FOR
	SELECT  Sucursal
    FROM Sucursal
    WHERE Sucursal = ISNULL(@Sucursal,Sucursal)
  
	OPEN crArticulo
	FETCH NEXT FROM crArticulo INTO @SucursalD
	WHILE @@FETCH_STATUS = 0 
		BEGIN 
			SELECT @ListaPrecios = ListaPreciosEsp 
			FROM Sucursal 
			WHERE Sucursal = @SucursalD
    
			SELECT @Moneda = Moneda 
			FROM ListaPrecios 
			WHERE Lista = ISNULL(@ListaPrecios,'(Precio Lista)')
    
			SELECT @TipoCambio = TipoCambio 
			FROM Mon 
			WHERE Moneda = @Moneda    
    
			INSERT @Tabla(
				Empresa, NSucursal, Articulo, SubCuenta, ListaPrecios)
			SELECT 
				i.Empresa, i.Sucursal, i.Articulo, i.SubCuenta, @ListaPrecios
			FROM ArtSubExistenciaInv i
			JOIN Sucursal s ON i.Sucursal = s.Sucursal
			JOIN Art a ON a.Articulo = i.Articulo
			WHERE  i.Inventario > 0.0 
			AND i.Sucursal = ISNULL(@SucursalD,i.Sucursal)
			GROUP BY i.Empresa, i.Sucursal, i.Articulo, i.SubCuenta       
			EXCEPT
			SELECT  a.Empresa, a.Sucursal , a.Cuenta, a.SubCuenta, @ListaPrecios
			FROM AuxiliarU a   
			JOIN Venta v ON a.ModuloID = v.ID AND a.Modulo = 'VTAS' 
			JOIN MovTipo mt ON v.Mov = mt.Mov AND  mt.Modulo = 'VTAS' 
			WHERE mt.Clave IN('VTAS.F','VTAS.N')
			AND a.Fecha BETWEEN @FechaD AND @FechaA
			AND a.Sucursal = ISNULL(@SucursalD,a.Sucursal)
			AND a.Modulo = 'VTAS'
			AND a.Rama = 'INV'
			GROUP BY a.Empresa, a.Sucursal , a.Cuenta,a.SubCuenta 

			FETCH NEXT FROM crArticulo INTO @SucursalD
		END 
	CLOSE crArticulo
	DEALLOCATE crArticulo   
   
	SELECT a.Empresa, a.NSucursal, a.Articulo, a.SubCuenta, art.Descripcion1, i.Almacen,SUM(i.Inventario)Inventario,s.Nombre SucNombre, @Moneda Moneda, 
	ISNULL(@TipoCambio,1) TipoCambio, art.Unidad, a.ListaPrecios
    FROM @Tabla a JOIN Sucursal s ON a.NSucursal = s.Sucursal
    JOIN Art art ON a.Articulo = art.Articulo
    JOIN ArtSubExistenciaInv i ON a.Articulo = i.Articulo AND a.SubCuenta = i.SubCuenta AND a.Empresa = i.Empresa AND a.NSucursal = i.Sucursal
    GROUP BY  a.Empresa, a.NSucursal, a.Articulo, a.SubCuenta, art.Descripcion1, i.Almacen,s.Nombre, art.Unidad, a.ListaPrecios
END
GO 	  


/**************** spPOSCrearJob ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSCrearJob') and type = 'P') DROP PROCEDURE dbo.spPOSCrearJob
GO             
CREATE PROCEDURE spPOSCrearJob
	@Nombre           varchar(100),
	@BaseDatos        varchar(30)  
--//WITH ENCRYPTION
AS
BEGIN
	DECLARE
	@TrabajoID               binary (16),
	@ReturnCode              int,
	@Activo                  bit,
	@Trabajo                 char(20),
	@Cadena                  nvarchar(100),
	@Servidor                varchar(30),   
	@FrecuenciaD             tinyint,
	@ValorD                  tinyint,
	@Valor                   tinyint,
	@Dia                     tinyint,
	@Fecha2                  int, 
	@Estatus                 bit,
	@Fecha                   datetime,
	@NombreOriginal          varchar(100),
	@Procesar                varchar(30)
 
	BEGIN TRANSACTION
    
	DECLARE @SQLServerAgent TABLE (
		Estatus		varchar(50))
    
	SELECT @Fecha = GETDATE()
    SELECT @NombreOriginal = ISNULL(@Nombre,'')
    SELECT @Nombre = ISNULL(@Nombre,'') + '.' + @@SERVERNAME + '.' + @BaseDatos
    SELECT @ReturnCode = 0    
    
	IF (SELECT COUNT(*) FROM msdb.dbo.syscategories WHERE name = '[Uncategorized (Local)]') < 1
		EXECUTE msdb.dbo.sp_add_category @name = '[Uncategorized (Local)]'
   
	SELECT @TrabajoID = job_id 
	FROM msdb.dbo.sysjobs 
	WHERE (name = @Nombre)
    
	IF (@TrabajoID IS NOT NULL)   
		BEGIN 
			IF (EXISTS (SELECT  * FROM    msdb.dbo.sysjobservers WHERE   (job_id = @TrabajoID) AND (server_id <> 0)))
				BEGIN
					RAISERROR ('Unable to import job ''POS '' since there is already a multi-server job with this name.', 16, 1)
					SELECT @ReturnCode = 1    
				END
			ELSE
				EXECUTE msdb.dbo.sp_delete_job @job_name = @Nombre
			SELECT @TrabajoID = NULL
		END
  
	IF (@@ERROR = 0 AND @ReturnCode = 0)
		BEGIN
			IF @ReturnCode = 0
				EXECUTE @ReturnCode = msdb.dbo.sp_add_job 
					@job_id = @TrabajoID OUTPUT , 
					@job_name = @Nombre, 
					@owner_login_name = N'sa', 
					@description =  @Nombre, 
					@category_name = '[Uncategorized (Local)]', 
					@enabled = 1, 
					@notify_level_email = 0, 
					@notify_level_page = 0, 
					@notify_level_netsend = 0, 
					@notify_level_eventlog = 2, 
					@delete_level= 0
 
			SELECT @Fecha2 =CONVERT(int, CONVERT(varchar,DATEPART(YEAR,@Fecha)) + 
				dbo.fnRellenarCerosIzquierda(CONVERT(varchar,DATEPART(MONTH,@Fecha)),2) + 
				dbo.fnRellenarCerosIzquierda(CONVERT(varchar,DATEPART(DAY,@Fecha)),2))
     
			SELECT 
				@Trabajo = Trabajo, 
				@FrecuenciaD= CASE Frecuencia WHEN 'Minutos' THEN 4 WHEN 'Horas' THEN 8 END , 
				@Valor = Valor, 
				@Activo =Activo 
			FROM POSTrabajo

			SET @cadena = N'spPOSAfectarPOSL'

			EXECUTE @ReturnCode = msdb.dbo.sp_add_jobstep 
				@job_id = @TrabajoID, 
				@step_id = 1, 
				@step_name = @Trabajo, 
				@command = @cadena, 
				@database_name = @BaseDatos, 
				@server = '', 
				@database_user_name = '', 
				@subsystem = 'TSQL', 
				@cmdexec_success_code = 0, 
				@flags = 0, 
				@retry_attempts = 0, 
				@retry_interval = 1, 
				@output_file_name = '', 
				@on_success_step_id = 0, 
				@on_success_action = 1, 
				@on_fail_step_id = 0, 
				@on_fail_action = 2

			IF @ReturnCode = 0
				EXECUTE @ReturnCode = msdb.dbo.sp_update_job 
					@job_id = @TrabajoID, 
					@start_step_id = 1, 
					@enabled  = @Activo
 
			IF @ReturnCode = 0
				EXECUTE @ReturnCode = msdb.dbo.sp_add_jobschedule 
					@job_id = @TrabajoID, 
					@name = @Nombre, 
					@enabled = @Activo, 
					@freq_type = 4, 
					@active_start_date = @Fecha2, 
					@active_start_time = 0, 
					@freq_interval = 1, 
					@freq_subday_type = @FrecuenciaD , 
					@freq_subday_interval = @Valor, 
					@freq_relative_interval = 0, 
					@freq_recurrence_factor = 0, 
					@active_end_date = 99991231, 
					@active_end_time = 235959
 
			IF @ReturnCode = 0
				EXECUTE @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @TrabajoID, @server_name = @@SERVERNAME
  
			INSERT @SQLServerAgent (Estatus)
			EXEC master.dbo.xp_ServiceControl 'QUERYSTATE', 'SQLServerAgent'
 
			IF (SELECT TOP 1 Estatus FROM @SQLServerAgent) = 'Running.' 
				SELECT @Estatus = 1 ELSE SELECT @Estatus = 0
 
			IF @ReturnCode = 0
				BEGIN
					IF @Estatus = 1 
						SELECT 'Proceso terminado.' 
					ELSE 
						SELECT 'Favor de verificar el servicio del Agente SQL Server para la ejecución del trabajo.'
					
					COMMIT TRANSACTION
				END
			ELSE
				BEGIN
					IF @Estatus = 1 
						SELECT 'Proceso terminado.' 
					ELSE 
						SELECT 'Favor de verificar el servicio del Agente SQL Server para la ejecución del trabajo.'
						
					ROLLBACK TRANSACTION
				END  
		END  
END
GO   


/************************ spPOSBorrarPOSArtSucursalTemp *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSBorrarPOSArtSucursalTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSBorrarPOSArtSucursalTemp
GO             
CREATE PROCEDURE spPOSBorrarPOSArtSucursalTemp
	@Estacion           int            
--//WITH ENCRYPTION             
AS 
BEGIN
	DELETE POSArtSucursalTemp WHERE Estacion = @Estacion  
END
GO 


/************************ spPOSeleccionarPOSArtSucursalTemp *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSeleccionarPOSArtSucursalTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSeleccionarPOSArtSucursalTemp
GO             
CREATE PROCEDURE spPOSeleccionarPOSArtSucursalTemp
	@Estacion           int            
--//WITH ENCRYPTION             
AS 
BEGIN
	DELETE POSArtSucursalTemp WHERE Estacion = @Estacion
  
	INSERT POSArtSucursalTemp(
		Estacion, Sucursal)
	SELECT 
		@Estacion, Sucursal
    FROM Sucursal
	WHERE 
	NULLIF(HOST,'') IS NOT NULL   
END
GO 


/**************** fnPOSvalidarPOSArtSucursalTemp ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSvalidarPOSArtSucursalTemp') DROP FUNCTION fnPOSvalidarPOSArtSucursalTemp
GO
CREATE FUNCTION dbo.fnPOSvalidarPOSArtSucursalTemp (
	@Estacion   int
) 
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  bit

	SET @Resultado = 0
	
	IF EXISTS(SELECT * FROM POSArtSucursalTemp WHERE Estacion = @Estacion)
		SELECT @Resultado = 1
  
	RETURN (@Resultado)
END
GO


/**************** fnPOSvalidarPOSArtSucursalTemp2 ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSvalidarPOSArtSucursalTemp2') DROP FUNCTION fnPOSvalidarPOSArtSucursalTemp2
GO
CREATE FUNCTION dbo.fnPOSvalidarPOSArtSucursalTemp2 (
	@Estacion   int
)
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  bit

	SET @Resultado = 1
  
	IF EXISTS(SELECT * FROM POSArtSucursalTemp p JOIN Sucursal s ON p.Sucursal = s.Sucursal  WHERE p.Estacion = 1 AND s.HOST IS NULL)
		SELECT @Resultado = 0
  
	RETURN (@Resultado)
END
GO

 
/************************ spPOSInsertarPOSArtSucursal *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarPOSArtSucursal') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarPOSArtSucursal
GO             
CREATE PROCEDURE spPOSInsertarPOSArtSucursal
@Estacion           int            
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE @Tabla table(
		Articulo  varchar(20),
		Sucursal  int,
		Host      varchar(20))
  
	INSERT @Tabla(
		Articulo, Sucursal, Host)  
	SELECT
		a.Clave, t.Sucursal, s.Host
    FROM ListaSt a JOIN  POSArtSucursalTemp t ON a.Estacion = t.Estacion
    JOIN Sucursal s ON s.Sucursal = t.Sucursal
	WHERE a.Estacion = @Estacion
	EXCEPT
	SELECT Articulo, Sucursal,Host
    FROM POSArtSucursal
    
	INSERT POSArtCodigoSucursal(
		Sucursal, Codigo, Articulo, SubCuenta, Host, Cantidad, Unidad)
	SELECT
		t.Sucursal, c.Codigo, a.Clave,   c.SubCuenta , s.Host, c.Cantidad, c.Unidad
    FROM ListaSt a JOIN  POSArtSucursalTemp t ON a.Estacion = t.Estacion
    JOIN Sucursal s ON s.Sucursal = t.Sucursal
    JOIN CB c ON c.Cuenta = a.Clave AND c.TipoCuenta = 'Articulos'
	WHERE a.Estacion = @Estacion
	EXCEPT
	SELECT Sucursal,   Codigo,   Articulo,  SubCuenta,    Host, Cantidad,   Unidad
    FROM POSArtCodigoSucursal   
    
	INSERT POSArtSucursal(
		Articulo, Sucursal, Host, Rama, Descripcion1, Descripcion2, NombreCorto, Grupo, Categoria, Familia, Linea, Fabricante, 
		Impuesto1, Impuesto2, Impuesto3, Factor, Unidad, UnidadCompra, UnidadTraspaso, Tipo, TipoOpcion, Accesorios, Sustitutos, 
		MonedaPrecio, PrecioLista, PrecioMinimo, Estatus, Alta, Precio2, Precio3, Precio4, Precio5, Precio6, Precio7, 
		Precio8, Precio9, Precio10, BasculaPesar, TieneMovimientos, Retencion1, Retencion2, Retencion3, MonedaCosto, TipoCosteo, 
		Calificacion, TipoImpuesto1, TipoImpuesto2, TipoImpuesto3, TipoImpuesto4, TipoImpuesto5, TipoRetencion1, TipoRetencion2, 
		TipoRetencion3)
	SELECT
		a.Articulo, a.Sucursal, a.Host, art.Rama, art.Descripcion1, art.Descripcion2, art.NombreCorto, art.Grupo, art.Categoria, art.Familia, art.Linea, art.Fabricante,
		art.Impuesto1, art.Impuesto2, art.Impuesto3, art.Factor, art.Unidad, art.UnidadCompra, art.UnidadTraspaso, art.Tipo, art.TipoOpcion, art.Accesorios, art.Sustitutos,
		art.MonedaPrecio, art.PrecioLista, art.PrecioMinimo, art.Estatus, art.Alta, art.Precio2, art.Precio3, art.Precio4, art.Precio5, art.Precio6, art.Precio7,
		art.Precio8, art.Precio9, art.Precio10, art.BasculaPesar, art.TieneMovimientos, art.Retencion1, art.Retencion2, art.Retencion3 , art.MonedaCosto, art.TipoCosteo,
		art.Calificacion, art.TipoImpuesto1, art.TipoImpuesto2, art.TipoImpuesto3, art.TipoImpuesto4, art.TipoImpuesto5, art.TipoRetencion1, art.TipoRetencion2, 
		art.TipoRetencion3
    FROM @Tabla a JOIN Art art ON a.Articulo = art.Articulo

	SELECT 'Operación Realizada Exitosamente'      
END
GO


/************************ spPOSGenerarEtiqueta *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSGenerarEtiqueta') AND type = 'P') DROP PROCEDURE dbo.spPOSGenerarEtiqueta
GO             
CREATE PROCEDURE spPOSGenerarEtiqueta
	@Estacion   int,
	@Articulo   varchar(5),
	@SubCuenta  varchar(50),
	@Unidad     varchar(50),
	@Nombre     varchar(50),
	@Moneda     varchar(10),
	@Empresa    varchar(5),
	@Sucursal   int,
	@Cantidad   int= NULL
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE 
	@Plantilla            varchar(max),
	@EspecificarCopias    bit,
	@Tipo                 varchar(20),
	@ListaPrecios         varchar(20),
	@Precio               float,
	@Codigo               varchar(50),
	@Descuento            float,
	@Descripcion1         varchar(100),
	@NombreCorto          varchar(20),
	@CantidadE            int,
	@Resultado            varchar(max),
	@ContMoneda		varchar(10),
	@ContMonedaTC	        float,
	@TipoCambio           float
  
	DECLARE @Tabla table(Columna varchar(max))
   
	SELECT @ContMoneda = ec.ContMoneda, @TipoCambio = 1
    FROM EmpresaCfg ec	  
	WHERE ec.Empresa = @Empresa   
   
	SELECT @ContMonedaTC = TipoCambio 
	FROM POSLTipoCambioRef 
	WHERE Sucursal = @Sucursal AND Moneda = @ContMoneda    

	SELECT @TipoCambio = CASE WHEN @Moneda <> @ContMoneda THEN  (ISNULL(@TipoCambio,1)/@ContMonedaTC) ELSE ISNULL(@TipoCambio,1) END 
  
	SELECT @Plantilla = Plantilla, @EspecificarCopias = EspecificarCopias, @Tipo = Tipo
    FROM POSFormatoEtiqueta
	WHERE Nombre = Nombre 
   
	SELECT @ListaPrecios = ListaPreciosEsp
    FROM Sucursal
	WHERE Sucursal = @Sucursal
   
	SELECT TOP 1 @Precio = Precio 
	FROM ListaPreciosD 
	WHERE Lista = @ListaPrecios AND Articulo = @Articulo 
  
	SELECT @Codigo = Codigo
    FROM CB
	WHERE Cuenta = @Articulo
    AND SubCuenta = @Subcuenta 
    AND TipoCuenta = 'Articulos'
     
	SELECT @Descripcion1 = Descripcion1 ,  @NombreCorto = NombreCorto
    FROM Art 
	WHERE Articulo = @Articulo 
     
	EXEC spArtPrecio @Articulo = @Articulo, @Cantidad = 1, @UnidadVenta = @Unidad, @Precio = @Precio OUTPUT, @Descuento = @Descuento OUTPUT,
		@SubCuenta = @SubCuenta, @Moneda = @Moneda, @TipoCambio = @TipoCambio, @Empresa = @Empresa, @Sucursal = @Sucursal
          	   
	SELECT @Plantilla = REPLACE(@Plantilla,'[PRECIO]',CONVERT(varchar,@Precio))          	   
	SELECT @Plantilla = REPLACE(@Plantilla,'[CANTIDAD]',CONVERT(varchar,@Cantidad))          	   
	SELECT @Plantilla = REPLACE(@Plantilla,'[ARTICULO]',@Articulo)          	   
	SELECT @Plantilla = REPLACE(@Plantilla,'[CODIGO]',@Codigo)          	   
	SELECT @Plantilla = REPLACE(@Plantilla,'[DESCRIPCION]',@Descripcion1)          	   
	SELECT @Plantilla = REPLACE(@Plantilla,'[NOMBRECORTO]',@NombreCorto)          	   

	INSERT @Tabla
	SELECT @Plantilla
          	   
	IF @Tipo = 'Existencias'
		SELECT @Cantidad = Inventario 
		FROM  ArtSubExistenciaInv 
		WHERE Articulo = @Articulo
		AND SubCuenta = ISNULL(@SubCuenta,'')
		AND Sucursal  = @Sucursal
		AND Empresa = @Empresa      	   
          	   
	IF @EspecificarCopias = 0
		BEGIN
			SET @CantidadE = 1
			
			WHILE @CantidadE < @Cantidad
				BEGIN
					INSERT @Tabla
					SELECT @Plantilla
      
					SET @CantidadE = @CantidadE +1
				END  
		END
  
	SELECT * FROM @Tabla     	   
END
GO 


/************************ spPOSHerrEtiquetasCB *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSHerrEtiquetasCB') AND type = 'P') DROP PROCEDURE dbo.spPOSHerrEtiquetasCB
GO             
CREATE PROCEDURE spPOSHerrEtiquetasCB
	     @Estacion   int
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE 
	@Codigo       varchar(30),
	@Articulo     varchar(20)

	DELETE POSArtCBTemp WHERE Estacion = @Estacion
  
	INSERT POSArtCBTemp(
		Estacion, Codigo, Articulo, SubCuenta, Cantidad)
	SELECT 
		@Estacion, Codigo, Cuenta, SubCuenta, 1
    FROM CB 
	WHERE Codigo IN(SELECT Clave FROM ListaSt WHERE Estacion = @Estacion)
END
GO 


/************************ spPOSReporteEtiquetasCB *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSReporteEtiquetasCB') AND type = 'P') DROP PROCEDURE dbo.spPOSReporteEtiquetasCB
GO             
CREATE PROCEDURE spPOSReporteEtiquetasCB
                   @Estacion     int,
                   @Empresa      varchar(5),
                   @Sucursal     int
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE 
	@Codigo               varchar(30),
	@Articulo             varchar(20),
	@ListaPrecios         varchar(20),
	@Precio               float,
	@Descuento            float,
	@Descripcion1         varchar(100),
	@NombreCorto          varchar(20),
	@CantidadE            int,   
	@Cantidad             int,   
	@SubCuenta            varchar(50),
	@Unidad               varchar(50),
	@Moneda               varchar(10),
	@Impuesto1            float,
	@Impuesto2            float,
	@Impuesto3            float,
	@Fecha                datetime,
	@cfgImpuestoIncluido  bit,
	@ImpuestoIncluido     bit
  
	DECLARE @Tabla table(
		ID        int identity,
		Articulo  varchar(20),
		Descripcion varchar(100),
		Precio     float,
		Codigo     varchar(30))
       
	SELECT @Fecha = GETDATE()
	SELECT @ListaPrecios = ListaPreciosEsp
    FROM Sucursal
	WHERE Sucursal = @Sucursal   
   
	SELECT @cfgImpuestoIncluido = ISNULL(VentaPreciosImpuestoIncluido,0) 
	FROM EmpresaCfg 
	WHERE Empresa = @Empresa   
	
	SELECT @ImpuestoIncluido = ISNULL(ImpuestoIncluido,0) 
	FROM POSCfg 
	WHERE Empresa = @Empresa
   
	SELECT @Moneda = Moneda 
    FROM POSLTipoCambioRef m
	WHERE TipoCambio = 1 AND Sucursal = @Sucursal AND EsPrincipal = 1   

	DECLARE crLista CURSOR local FOR
	SELECT p.Codigo, p.Articulo , p.SubCuenta, p.Cantidad, a.Descripcion1, ISNULL(c.Unidad,a.Unidad)
    FROM POSArtCBTemp p JOIN Art a ON p.Articulo = a.Articulo
    JOIN CB c ON c.Codigo = p.Codigo
    WHERE p.Estacion = @Estacion AND p.Cantidad >0
	OPEN crLista
   
	FETCH NEXT FROM crLista INTO @Codigo, @Articulo,  @SubCuenta, @Cantidad, @Descripcion1, @Unidad
	WHILE @@FETCH_STATUS = 0  
		BEGIN
			SELECT @Impuesto1 = a.Impuesto1, @Impuesto2 = a.Impuesto2, @Impuesto3 = a.Impuesto3 FROM Art a
   
			EXEC spTipoImpuesto 'VTAS', 0, NULL, @Fecha, @Empresa, @Sucursal, NULL, NULL, @Articulo = @Articulo, @EnSilencio = 1, 
				@Impuesto1 = @Impuesto1 OUTPUT, @Impuesto2 = @Impuesto2 OUTPUT, @Impuesto3 = @Impuesto3 OUTPUT      
            
			EXEC spArtPrecio @Articulo = @Articulo, @Cantidad = 1, @UnidadVenta = @Unidad, 
				@Precio = @Precio OUTPUT, @Descuento = @Descuento OUTPUT, @SubCuenta = @SubCuenta, @Moneda = @Moneda, @TipoCambio = 1,           		     
          		@Empresa = @Empresa, @Sucursal = @Sucursal,@ListaPreciosEsp = @ListaPrecios

			SELECT @Precio = CASE WHEN @cfgImpuestoIncluido = 0 AND @ImpuestoIncluido = 1 
										THEN  dbo.fnPOSPrecioConImpuestos(@Precio,@Impuesto1, @Impuesto2, @Impuesto3, @Empresa)
								  WHEN @cfgImpuestoIncluido = 1 AND @ImpuestoIncluido = 0 
										THEN dbo.fnPOSPrecioSinImpuestos(@Precio,@Impuesto1, @Impuesto2, @Impuesto3) 
								  ELSE @Precio 
								  END
       	   
			SET @CantidadE = 0
			
			WHILE @CantidadE < @Cantidad
				BEGIN
					INSERT @Tabla(
						Articulo,  Descripcion,   Precio,  Codigo)
					SELECT
						@Articulo, @Descripcion1, @Precio, @Codigo
      
					SET @CantidadE = @CantidadE +1
				END
    
			SET @Precio = NULL
    
			FETCH NEXT FROM crLista INTO @Codigo, @Articulo,  @SubCuenta, @Cantidad, @Descripcion1, @Unidad
		END
	CLOSE crLista
	DEALLOCATE crLista 

	SELECT * FROM @Tabla
END
GO 


/**************** fnPOSValidarSerieLote ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidarSerieLote') DROP FUNCTION fnPOSValidarSerieLote
GO
CREATE FUNCTION dbo.fnPOSValidarSerieLote (
	@Sucursal   int,
    @Articulo   varchar(20),
    @SubCuenta  varchar(50),
    @SerieLote  varchar(50),
    @Almacen    varchar(10)
)
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  bit

	SELECT @Resultado    = 1
  
	IF NOT EXISTS(SELECT * FROM SerieLote WHERE SerieLote = @SerieLote AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') 
				  AND Almacen = @Almacen AND ISNULL(Existencia,0.0)>=1.0)
		SELECT @Resultado = 0

	RETURN (@Resultado)
END
GO


/**************** fnPOSValidarSerieLoteCantidad ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidarSerieLoteCantidad') DROP FUNCTION fnPOSValidarSerieLoteCantidad
GO
CREATE FUNCTION dbo.fnPOSValidarSerieLoteCantidad (
	@Sucursal   int,
    @Articulo   varchar(20),
    @SubCuenta  varchar(50),
    @SerieLote  varchar(50),
    @Cantidad   float
)
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  bit

	SELECT @Resultado    = 1
  
	IF NOT EXISTS(SELECT * FROM SerieLote WHERE SerieLote = @SerieLote AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') 
				  AND Existencia >=@Cantidad)
		SELECT @Resultado = 0

	RETURN (@Resultado)
END
GO


/************************ spPOSInsertarPOSAuxiliarArtPrecioTemp  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarPOSAuxiliarArtPrecioTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarPOSAuxiliarArtPrecioTemp
GO             
CREATE PROCEDURE spPOSInsertarPOSAuxiliarArtPrecioTemp
	@Estacion           int,
    @FechaD             datetime,
    @FechaA             datetime,
    @Sucursal           int            
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE 
	@ListaPrecios         varchar(50)

	SELECT @ListaPrecios = ListaPreciosEsp
    FROM Sucursal
	WHERE Sucursal = @Sucursal 

	DECLARE @Tabla table (ID int, Articulo varchar(20), SubCuenta  varchar(50) , ListaPrecios varchar(50),Unidad varchar(50))
	DELETE POSAuxiliarArtPrecioTemp WHERE Estacion = @Estacion
   
	INSERT @Tabla(
		ID, Articulo, SubCuenta, ListaPrecios, Unidad)
	SELECT 
		MAX(ID), Articulo, ISNULL(SubCuenta,''), ListaPrecios, Unidad
    FROM POSAuxiliarArtPrecio    
    WHERE dbo.fnFechaSinHora(Fecha) BETWEEN @FechaD AND @FechaA AND ListaPrecios = @ListaPrecios
	GROUP BY Articulo, ISNULL(SubCuenta,''),  ListaPrecios, Unidad
 	
	INSERT POSAuxiliarArtPrecioTemp(
		Estacion, Articulo, SubCuenta, ListaPrecios, PrecioAnterior, Precio, Codigo, Unidad)
	SELECT
		@Estacion, t.Articulo, t.SubCuenta, t.ListaPrecios, MAX(p.PrecioAnterior), MAX(p.Precio), ISNULL(c.Codigo,''), ISNULL(ISNULL(c.Unidad,a.Unidad),'pza')					FROM @Tabla t JOIN POSAuxiliarArtPrecio p ON t.ID = p.ID AND t.Articulo = p.Articulo AND ISNULL(t.SubCuenta,'') = ISNULL(p.SubCuenta,'')
    JOIN Art a ON t.Articulo=a.Articulo
    LEFT JOIN CB  c ON a.Articulo=c.Cuenta AND ISNULL(p.SubCuenta,'')=ISNULL(c.SubCuenta,'')    AND c.TipoCuenta = 'Articulos' AND c.Unidad = ISNULL(t.Unidad,a.Unidad)
    GROUP BY t.Articulo,  t.SubCuenta, t.ListaPrecios,c.Codigo, c.Unidad,a.Unidad 
END
GO 


/************************ spPOSBorrarVentaPOS  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSBorrarVentaPOS') AND type = 'P') DROP PROCEDURE dbo.spPOSBorrarVentaPOS
GO             
CREATE PROCEDURE spPOSBorrarVentaPOS
	@ID		int
--//WITH ENCRYPTION             
AS 
BEGIN
	DELETE Venta WHERE ID = @ID
  
	DELETE VentaD WHERE ID = @ID 
END
GO 


/************************ spPOSGeneraTicket  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSGeneraTicket') AND type = 'P') DROP PROCEDURE dbo.spPOSGeneraTicket
GO             
CREATE PROCEDURE spPOSGeneraTicket
	@Estacion     int,
    @Empresa      varchar(5),
    @Sucursal     int,
    @Usuario      varchar(10),
    @ID           varchar(50)            
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE
	@Ticket   varchar(max)

	EXEC spPOS @Estacion,NULL, @Empresa,'VTAS', @Sucursal, @Usuario, NULL,@ID, @Ticket = @Ticket OUTPUT,@DesgloseC =1  ,@EsImpresion = 1 
	
	IF EXISTS(SELECT * FROM POSReporteTicket WHERE Estacion = @Estacion)
		DELETE POSReporteTicket WHERE Estacion = @Estacion
  
	INSERT POSReporteTicket(
		Estacion, RID, Campo, AbreCajon)
	SELECT
		@Estacion, @ID, Campo , 0
    FROM dbo.fnPOSGenerarTicket(@Ticket,'<BR>')
	ORDER BY ID  
END 
GO


 /************************ spPOSEliminarPOSArtSucursal *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSEliminarPOSArtSucursal') AND type = 'P') DROP PROCEDURE dbo.spPOSEliminarPOSArtSucursal
GO             
CREATE PROCEDURE spPOSEliminarPOSArtSucursal
	@Estacion           int,
    @Sucursal           int            
--//WITH ENCRYPTION             
AS 
BEGIN
	DELETE POSArtSucursal
	WHERE Articulo IN (SELECT Clave FROM ListaSt WHERE Estacion = @Estacion)
    AND Sucursal = @Sucursal
     
	DELETE POSArtCodigoSucursal
	WHERE Articulo IN (SELECT Clave FROM ListaSt WHERE Estacion = @Estacion)
    AND Sucursal = @Sucursal     
    
	SELECT 'Operación Realizada Exitosamente'      
END
GO 


/**************** fnPOSFPReferencia ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSFPReferencia') DROP FUNCTION fnPOSFPReferencia
GO
CREATE FUNCTION dbo.fnPOSFPReferencia (
	@Codigo			varchar(30),
	@Referencia		varchar(50)
)
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado            bit,
	@RequiereReferencia   bit,
	@FormaPago            varchar(50)

	SELECT @FormaPago = FormaPago
    FROM CB
	WHERE CB.Codigo = @Codigo
   
	SELECT @RequiereReferencia = ISNULL(RequiereReferencia,0)
    FROM FormaPago
    WHERE FormaPago = @FormaPago 

	SELECT @Resultado    = 0
	
	IF @RequiereReferencia = 1 AND NULLIF(@Referencia,'') IS NULL
		SELECT @Resultado = 1

	RETURN (@Resultado)
END
GO


/************************ spPOSLDIADOParametros *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDIADOParametros') AND type = 'P') DROP PROCEDURE dbo.spPOSLDIADOParametros
GO             
CREATE PROCEDURE spPOSLDIADOParametros
	@ID	                varchar(36),
	@Servicio	        varchar(20),
	@Empresa	        varchar(5),
	@Usuario	        varchar(10),
	@Sucursal	        int,
	@Importe			float,
	@Monedero           varchar(36),
	@Referencia         varchar(255)               
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE
	@Comision3		float,
	@FormaPago		varchar(50),
	@CImporte		float

	IF EXISTS (SELECT * FROM POSLDITemp WHERE ID = @ID)        
		DELETE POSLDITemp WHERE ID = @ID

	SELECT @FormaPago = POSLCobro.FormaPago 
    FROM POSLDIFormaPago JOIN POSLCobro ON POSLDIFormaPago.FormaPago = POSLCobro.FormaPago
    WHERE Servicio = @Servicio
        
	IF (SELECT Comision3 FROM FormaPago WHERE FormaPago = @FormaPago) > 0 
		SELECT @Comision3 = Comision3 
		FROM FormaPago 
		WHERE FormaPago = @FormaPago
    
	SELECT @CImporte = (@Importe *ISNULL(@Comision3,0.0)/100) 
  
	IF @Comision3 <> 0 AND @Servicio <> 'VALECARGO'    
		BEGIN
			INSERT POSLDITemp(
				ID, Servicio, Empresa, Usuario, Sucursal, Importe, Monedero, Referencia)
			SELECT
				@ID, @Servicio, @Empresa, @Usuario, @Sucursal, (@Importe+@CImporte), @Monedero, @Referencia
		END 
	ELSE
		INSERT POSLDITemp(
			ID, Servicio, Empresa, Usuario, Sucursal, Importe, Monedero, Referencia)
		SELECT
			@ID, @Servicio, @Empresa, @Usuario, @Sucursal, @Importe, @Monedero, @Referencia    
  
	IF @Servicio = 'VALECARGO'  
		BEGIN
			INSERT POSLDIValeTemp(
				ID, Servicio, Empresa, Usuario, Sucursal, Importe, Vale)  
			SELECT
				@ID, @Servicio, @Empresa, @Usuario, @Sucursal, @Importe, @Monedero  
		END
END
GO 


 /************************ spPOSLDIADO *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDIADO') AND type = 'P') DROP PROCEDURE dbo.spPOSLDIADO
GO             
CREATE PROCEDURE spPOSLDIADO
	@ID		varchar(36)
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE 
	@Servicio	    varchar(20),
	@Empresa	    varchar(5),
	@Usuario	    varchar(10),
	@Sucursal	    int,
	@Importe        float,
	@Monedero       varchar(36),
	@Modulo			varchar(5),
	@Cuenta         varchar(255),
	@Referencia		varchar(255), 
	@Ok				int,
	@OkRef			varchar(255)
  
	SELECT @Servicio = Servicio,  @Empresa = Empresa, @Usuario= Usuario, @Sucursal = Sucursal, @Importe = Importe, @Monedero = NULLIF(Monedero,''), @Referencia = Referencia
    FROM POSLDITemp
	WHERE ID =  @ID

	IF @Servicio IS NULL
		SELECT @Servicio = Servicio,  @Empresa = Empresa, @Usuario= Usuario, @Sucursal = Sucursal, @Importe = Importe, @Monedero = NULLIF(Vale,''), @Referencia = ''
		FROM POSLDIValeTemp
		WHERE ID =  @ID   
  
	IF @Servicio <> 'VALECARGO' 
		BEGIN
			IF EXISTS(SELECT * FROM POSLDIRespuestaTemp WHERE ID = @ID)
				DELETE POSLDIRespuestaTemp WHERE ID = @ID
			
			EXEC spPOSLDI @Servicio, @ID, @Monedero, @Empresa, @Usuario, @Sucursal, NULL, @Importe, 1, @ADO=1, @Ok = NULL, @OkRef = NULL, @Modulo = 'POS', 
				@Cuenta = NULL, @Referencia = @Referencia
		END

	IF @Servicio = 'VALECARGO' 
		BEGIN
			IF EXISTS(SELECT * FROM POSLDIRespuestaTemp WHERE ID = @ID)
				DELETE POSLDIRespuestaTemp WHERE ID = @ID
    
			EXEC spPOSLDI @Servicio,    @ID, @Monedero, @Empresa, @Usuario, @Sucursal, NULL, @Importe, 1, @ADO=1, @Ok = NULL , @OkRef = NULL , @Modulo = 'POS', 
				@Cuenta = NULL, @Referencia = @Referencia
		 END  
END
GO 

  
/************************ spPOSLDIADOResultado *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDIADOResultado') AND type = 'P') DROP PROCEDURE dbo.spPOSLDIADOResultado
GO             
CREATE PROCEDURE spPOSLDIADOResultado
	@ID		varchar(36)
--//WITH ENCRYPTION             
AS 
BEGIN
	SELECT NULLIF(Ok,0) Ok, OkRef, Mensaje, CadenaRespuesta, Cadena, IDLog
    FROM POSLDIRespuestaTemp 
	WHERE ID = @ID 
END
GO 

  
/**************** fnPOSADOResultadoExiste ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSADOResultadoExiste') DROP FUNCTION fnPOSADOResultadoExiste
GO
CREATE FUNCTION dbo.fnPOSADOResultadoExiste ( 
	@ID   varchar(36)
)
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  bit

	SELECT @Resultado    = 0
  
	IF EXISTS(SELECT * FROM POSLDIRespuestaTemp WHERE ID = @ID)
		SELECT @Resultado = 1

	RETURN (@Resultado)
END
GO


/**************** fnPOSValidaSerieLote ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidaSerieLote') DROP FUNCTION fnPOSValidaSerieLote
GO
CREATE FUNCTION dbo.fnPOSValidaSerieLote (
	@ID   varchar(36)
)
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado            bit,
	@MovClave             varchar(20),
	@SubMovClave          varchar(20)
  
	SELECT @MovClave = mt.Clave, @SubMovClave = mt.Subclave 
    FROM MovTipo mt JOIN POSL p ON mt.Mov = p.Mov AND mt.Modulo = 'POS'
	WHERE p.ID = @ID 

	SELECT @Resultado    = 0
  
	IF ((@MovClave <> 'POS.P')AND ( NULLIF(@SubMovClave,'') NOT IN ('POS.PEDCONT', 'POS.N')) OR 
		(@MovClave = 'POS.P' AND NULLIF(@SubMovClave,'') IN('POS.FACCRED','POS.DEVCRED')))
		IF EXISTS(SELECT * FROM POSSerieLoteTemp WHERE ID = @ID AND ISNULL(Cantidad,0.0) <> ISNULL(SerieLote,0.0))
			SELECT @Resultado = 1

	IF EXISTS(SELECT * FROM POSLSerieLote WHERE ID = @ID)  
		SELECT @Resultado = 0       
      
	RETURN (@Resultado)
END
GO


/************************ spPOSLDIPagoServicio *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDIPagoServicio') AND type = 'P') DROP PROCEDURE dbo.spPOSLDIPagoServicio
GO             
CREATE PROCEDURE spPOSLDIPagoServicio
		@ID			varchar(36),
		@Ok			int = NULL           OUTPUT,
		@OkRef		varchar(255) = NULL  OUTPUT
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE 
	@Servicio	    varchar(20),	   
	@Empresa	    varchar(5),	 
	@Usuario	    varchar(10),
	@Sucursal		int,
	@Importe        float,
	@Codigo         varchar(50)

	SELECT @Servicio = Servicio, @Empresa = Empresa, @Usuario = Usuario, @Sucursal = Sucursal, @Importe = Importe, @Codigo = Codigo
    FROM POSLDIPagoServicioTemp
	WHERE ID = @ID 
   
	IF @Ok IS NULL AND ISNULL(@Importe,0.0)>0.0 AND NULLIF(@Codigo,'') IS NOT NULL
		EXEC spPOSLDI    @Servicio, @ID, NULL, @Empresa, @Usuario, @Sucursal, NULL, @Importe, 1,NULL, 
			@Ok OUTPUT, @OkRef OUTPUT, 'POS', @Cuenta = @Codigo, @Referencia = @Codigo
END
GO 


/************************ spPOSInsertarLDIPagoServicioTemp *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarLDIPagoServicioTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarLDIPagoServicioTemp
GO             
CREATE PROCEDURE spPOSInsertarLDIPagoServicioTemp
	@ID             varchar(36),
	@Servicio	    varchar(20),	   
	@Empresa	    varchar(5),	 
	@Usuario	    varchar(10),
	@Sucursal		int,
	@Importe        float,
	@Codigo         varchar(50)            
--//WITH ENCRYPTION             
AS 
BEGIN
	IF EXISTS(SELECT * FROM POSLDIPagoServicioTemp WHERE ID = @ID)
		DELETE POSLDIPagoServicioTemp WHERE ID = @ID
    
	INSERT POSLDIPagoServicioTemp(
		ID, Servicio, Empresa, Usuario, Sucursal, Importe, Codigo)
	SELECT
		@ID, @Servicio, @Empresa, @Usuario, @Sucursal, @Importe, @Codigo
  
	UPDATE POSLVenta SET Precio = @Importe, PrecioSugerido = @Importe , PrecioImpuestoInc = @Importe
	WHERE ID = @ID
END
GO 


/************************ spPOSEliminarLDIPagoServicioTemp *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSEliminarLDIPagoServicioTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSEliminarLDIPagoServicioTemp
GO             
CREATE PROCEDURE spPOSEliminarLDIPagoServicioTemp
	@ID                 varchar(36),
	@Servicio	        varchar(20),	   
	@Empresa	        varchar(5),	 
	@Usuario	        varchar(10),
	@Sucursal	        int,
	@Importe            float,
	@Codigo             varchar(50)        
--//WITH ENCRYPTION             
AS 
BEGIN
	IF EXISTS(SELECT * FROM POSLDIPagoServicioTemp WHERE ID = @ID)
		DELETE POSLDIPagoServicioTemp WHERE ID = @ID

	IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID)
		DELETE POSLVenta WHERE ID = @ID
END
GO 


/************************ spPOSInsertarEmidaRecargaTemp *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarEmidaRecargaTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarEmidaRecargaTemp
GO             
CREATE PROCEDURE spPOSInsertarEmidaRecargaTemp
	@ID             varchar(36),
	@Servicio	    varchar(20),	   
	@Empresa	    varchar(5),	 
	@Usuario	    varchar(10),
	@Sucursal		int,
	@Importe        float,
	@Telefono       varchar(10),
	@Estacion       int
--//WITH ENCRYPTION             
AS 
BEGIN
	IF EXISTS(SELECT * FROM POSEmidaRecargaTemp WHERE ID = @ID)
		DELETE POSEmidaRecargaTemp WHERE ID = @ID
    
	INSERT POSEmidaRecargaTemp(
		ID, Empresa, Usuario, Sucursal, Telefono, Estacion)
	SELECT
		@ID, @Empresa, @Usuario, @Sucursal, @Telefono, @Estacion   
END
GO 


/************************ spPOSLDIRecargaTelefonica *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDIRecargaTelefonica') AND type = 'P') DROP PROCEDURE dbo.spPOSLDIRecargaTelefonica
GO             
CREATE PROCEDURE spPOSLDIRecargaTelefonica
	@ID	        varchar(36),
	@Ok         int = NULL           OUTPUT,
	@OkRef		varchar(255) = NULL  OUTPUT
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE 
	@Servicio	    varchar(20),	   
	@Empresa	    varchar(5),	 
	@Usuario	    varchar(10),
	@Sucursal	    int,
	@Importe        float,
	@Telefono		varchar(10)

	SELECT @Servicio = Servicio, @Empresa = Empresa, @Usuario = Usuario, @Sucursal = Sucursal, @Importe = Importe, @Telefono = Telefono
    FROM POSLDIRecargaTemp
	WHERE ID = @ID 

	IF LEN(ISNULL(@Telefono,'1')) <> 10
		SELECT @Ok = 30443    

	IF NULLIF(@Telefono,'') IS  NULL AND @Ok IS NULL
		SELECT @Ok = 30449
    
	IF NULLIF(@Servicio,'') IS NULL 
		SELECT @Ok = 30444    
   
	IF @Ok IS NULL AND ISNULL(@Importe,0.0)>0.0 AND NULLIF(@Telefono,'') IS NOT NULL
		EXEC spPOSLDI    @Servicio, @ID, NULL, @Empresa, @Usuario, @Sucursal, NULL, @Importe, 1,@Telefono, @Ok OUTPUT, @OkRef OUTPUT, 'POS'
END
GO 


/************************ spPOSInsertarLDIRecargaTemp *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarLDIRecargaTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarLDIRecargaTemp
GO             
CREATE PROCEDURE spPOSInsertarLDIRecargaTemp
	@ID             varchar(36),
	@Servicio	    varchar(20),	   
	@Empresa	    varchar(5),	 
	@Usuario	    varchar(10),
	@Sucursal		int,
	@Importe        float,
	@Telefono       varchar(10)
--//WITH ENCRYPTION             
AS 
BEGIN
	IF EXISTS(SELECT * FROM POSLDIRecargaTemp WHERE ID = @ID)
		DELETE POSLDIRecargaTemp WHERE ID = @ID
    
	INSERT POSLDIRecargaTemp(
		ID, Servicio, Empresa, Usuario, Sucursal, Importe, Telefono)
	SELECT
		@ID, @Servicio, @Empresa, @Usuario, @Sucursal, @Importe, @Telefono
END
GO 


/************************ spPOSRecargaTemp *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSRecargaTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSRecargaTemp
GO             
CREATE PROCEDURE spPOSRecargaTemp
	@ID             varchar(36),
	@Servicio	    varchar(20),	   
	@Empresa	    varchar(5),	 
	@Usuario	    varchar(10),
	@Sucursal		int,
	@Importe        float,
	@Telefono       varchar(10),
	@Estacion       int
--//WITH ENCRYPTION             
AS 
BEGIN
	IF EXISTS(SELECT * FROM POSLVenta p JOIN Art a ON p.Articulo = a.Articulo WHERE p.ID = @ID AND ISNULL(a.LDI,0)= 1 AND NULLIF(a.LDIServicio,'') IS NOT NULL)
		EXEC spPOSInsertarLDIRecargaTemp @ID, @Servicio, @Empresa, @Usuario, @Sucursal, @Importe, @Telefono
    
	IF EXISTS(SELECT * FROM POSLVenta p JOIN Art a ON p.Articulo = a.Articulo WHERE p.ID = @ID AND ISNULL(a.EmidaRecargaTelefonica,0) = 1)
		EXEC spPOSInsertarEmidaRecargaTemp @ID, @Servicio, @Empresa, @Usuario, @Sucursal, @Importe, @Telefono, @Estacion    
END
GO 


/**************** fnPOSAbrirCajon ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSAbrirCajon') DROP FUNCTION fnPOSAbrirCajon
GO
CREATE FUNCTION dbo.fnPOSAbrirCajon (
	@ID   varchar(36)
)
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado            bit

	SELECT @Resultado    = 0
  
	IF EXISTS(SELECT * FROM POSLCobro c JOIN FormaPago f ON f.FormaPago = c.FormaPago WHERE   f.AbreCajon = 1 AND c.ID = @ID)
			  AND EXISTS(SELECT * FROM POSReporteTicket WHERE RID = @ID AND AbreCajon = 1)
		SELECT @Resultado = 1

	RETURN (@Resultado)
END
GO


/**************** fnPOSLeerArchivo ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSLeerArchivo') DROP FUNCTION fnPOSLeerArchivo
GO
CREATE FUNCTION dbo.fnPOSLeerArchivo (
	@Path   varchar(255)
) 
RETURNS varchar(8000)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@Resultado				varchar(max),
	@ResultadoOLE			int,
	@ManejadorObjeto		int,
	@ManejadorTexto			int,
	@Ok						int,
	@OkRef					varchar(255),
	@Ruta					varchar(255),
	@Cadena					varchar(8000),
	@SiONo					int,
	@Origen					varchar(255),
	@Descripcion			varchar(255),
	@Archivo				varchar(255),
	@ID						int

	SELECT @Resultado=''
	SELECT @OkRef='opening the File System Object'
  
	EXEC @ResultadoOLE = sp_OACreate  'Scripting.FileSystemObject' , @ManejadorObjeto OUT
  
	IF @ResultadoOLE=0 
		SELECT @Ok=@ManejadorObjeto, @OkRef='Opening file "'+@Path+'"',@Ruta=@Path

	IF @ResultadoOLE=0 
		EXEC @ResultadoOLE = sp_OAMethod   @ManejadorObjeto  , 'OpenTextFile', @ManejadorTexto OUT, @Ruta,1,false,0--for reading, FormatASCII

	WHILE @ResultadoOLE=0
		BEGIN
			IF @ResultadoOLE=0 
				SELECT @Ok=@ManejadorTexto, @OkRef='finding out IF there is more to read in "'+@Path+'"'
    
			IF @ResultadoOLE=0 
				EXEC @ResultadoOLE = sp_OAGetProperty @ManejadorTexto, 'AtENDOfStream', @SiONo OUTPUT

			IF @SiONo<>0 
				BREAK

			IF @ResultadoOLE=0 
				SELECT @Ok=@ManejadorTexto, @OkRef='reading from the OUTPUT file "'+@Path+'"'
    
			IF @ResultadoOLE=0 
				EXEC @ResultadoOLE = sp_OAMethod  @ManejadorTexto, 'Read', @Cadena OUTPUT,4000
    
			SELECT @Resultado=@Resultado+@Cadena
		END
  
	IF @ResultadoOLE=0 SELECT @Ok=@ManejadorTexto, @OkRef='closing the OUTPUT file "'+@Path+'"'
	IF @ResultadoOLE=0 EXEC @ResultadoOLE = sp_OAMethod  @ManejadorTexto, 'Close'

	IF @ResultadoOLE<>0
		BEGIN
			EXEC sp_OAGetErrorInfo  @Ok, @Origen OUTPUT,@Descripcion OUTPUT,@Archivo OUTPUT,@ID OUTPUT
			
			SELECT @OkRef='Error while ' + COALESCE(@OkRef,'doing something')+ ', '+COALESCE(@Descripcion,'')
			SELECT @Resultado=@OkRef
		END
	
	EXEC  sp_OADestroy @ManejadorTexto-- Fill the table variable with the rows for your result set

	RETURN @Resultado
END
GO


 /************************ spPOSRegenerarReporteJasper *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSRegenerarReporteJasper') AND type = 'P') DROP PROCEDURE dbo.spPOSRegenerarReporteJasper
GO             
CREATE PROCEDURE spPOSRegenerarReporteJasper
	@Empresa	    varchar(5),
	@Sucursal		int,	
	@Cliente        varchar(10), 
	@Modulo	        varchar(20),
	@ID	            int,
	@MovCFD         varchar(20),
	@XML		    varchar(max),
	@NomArch        varchar(255),
	@Ok             int = NULL  OUTPUT,
	@OkRef          varchar(255) = NULL  OUTPUT   
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE 
	@RutaJasper			varchar(255),
	@RutaTemporal		varchar(255),
	@AlmacenarRuta		varchar(255),
	@Ruta				varchar(255),
	@RutaLogo			varchar(255),
	@ArchivoXML			varchar(255),
	@ArchivoBMP			varchar(255),
	@Archivo			varchar(255),
	@Jasper				bit,
	@Reporte			varchar(50),
	@Shell				varchar(8000),
	@EsCFDI				bit,
	@RutaDatosXML		varchar(255),
	@Nailgun			bit,
	@RutaNG				varchar(255)  
    
	DECLARE @Datos TABLE (
		Datos	varchar(255))  
  
	SET @EsCFDI = 0
  
	IF @XML LIKE '%<cfdi:Comprobante%' 
		SET @EsCFDI = 1
  
	SELECT 
		@RutaJasper = RTRIM(LTRIM(ISNULL(RutaJasper,''))),
        @Jasper = ISNULL(Jasper,0),
        @RutaTemporal = RTRIM(LTRIM(ISNULL(RutaTemporal,''))),
        @AlmacenarRuta = AlmacenarRuta,
		@Nailgun = ISNULL(Nailgun,0),
		@RutaNG = REPLACE(@RutaJasper,'IntelisisJReport.exe', 'ng com.intelisis.JReport.IntelisisJReport') --REQ 14790         
	FROM EmpresaCFD 
	WHERE Empresa = @Empresa
    
	SELECT @Reporte = NULLIF(ReporteJasper,'') 
	FROM EmpresaCFDReporte 
	WHERE Empresa = @Empresa AND Modulo = @Modulo AND Mov = @MovCFD    
    
	SELECT 
		@Ruta = RTRIM(LTRIM(ISNULL(Ruta,''))),
		@RutaLogo = RTRIM(LTRIM(ISNULL(RutaLogo,'')))
    FROM EmpresaCFDJasperReports 
	WHERE Empresa = @Empresa AND Reporte = @Reporte  

	SET @ArchivoXML = @AlmacenarRuta + '\' + @NomArch + 'Jasper.XML'    
	SET @ArchivoBMP = @RutaTemporal + '\' + @NomArch + '.BMP'    
	SET @Archivo = @AlmacenarRuta+ '\' + @NomArch +'.PDF'
  
	SELECT @ArchivoXML = REPLACE(@ArchivoXML, '<Cliente>', LTRIM(RTRIM(ISNULL(@Cliente,''))))
	SELECT @ArchivoXML = REPLACE(@ArchivoXML, '<Ejercicio>', LTRIM(RTRIM(ISNULL(CONVERT(varchar, YEAR(GETDATE())),''))))
	SELECT @ArchivoXML = REPLACE(@ArchivoXML, '<Periodo>', LTRIM(RTRIM(ISNULL(CONVERT(varchar, MONTH(GETDATE())),''))))
	SELECT @ArchivoXML = REPLACE(@ArchivoXML, '<Empresa>', LTRIM(RTRIM(ISNULL(@Empresa,''))))
	SELECT @ArchivoXML = REPLACE(@ArchivoXML, '<Sucursal>', LTRIM(RTRIM(ISNULL(CONVERT(varchar, @Sucursal),''))))  
	SELECT @ArchivoBMP = REPLACE(@ArchivoBMP, '<Cliente>', LTRIM(RTRIM(ISNULL(@Cliente,''))))
	SELECT @ArchivoBMP = REPLACE(@ArchivoBMP, '<Ejercicio>', LTRIM(RTRIM(ISNULL(CONVERT(varchar, YEAR(GETDATE())),''))))
	SELECT @ArchivoBMP = REPLACE(@ArchivoBMP, '<Periodo>', LTRIM(RTRIM(ISNULL(CONVERT(varchar, MONTH(GETDATE())),''))))
	SELECT @ArchivoBMP = REPLACE(@ArchivoBMP, '<Empresa>', LTRIM(RTRIM(ISNULL(@Empresa,''))))
	SELECT @ArchivoBMP = REPLACE(@ArchivoBMP, '<Sucursal>', LTRIM(RTRIM(ISNULL(CONVERT(varchar, @Sucursal),''))))    
	SELECT @Archivo = REPLACE(@Archivo, '<Cliente>', LTRIM(RTRIM(ISNULL(@Cliente,''))))
	SELECT @Archivo = REPLACE(@Archivo, '<Ejercicio>', LTRIM(RTRIM(ISNULL(CONVERT(varchar, YEAR(GETDATE())),''))))
	SELECT @Archivo = REPLACE(@Archivo, '<Periodo>', LTRIM(RTRIM(ISNULL(CONVERT(varchar, MONTH(GETDATE())),''))))
	SELECT @Archivo = REPLACE(@Archivo, '<Empresa>', LTRIM(RTRIM(ISNULL(@Empresa,''))))
	SELECT @Archivo = REPLACE(@Archivo, '<Sucursal>', LTRIM(RTRIM(ISNULL(CONVERT(varchar, @Sucursal),''))))      
  
	EXEC spCFDFlexRegenerarArchivo @Empresa, @ArchivoXML, @XML, @Ok OUTPUT, @OkRef OUTPUT
  
	IF @EsCFDI = 1
		EXEC spCFDFlexQRCode @Empresa, @Modulo, @ID, @ArchivoBMP 
    
	IF CHARINDEX('<FactDocGT xmlns' + CHAR(58) + 'xsi="http' + CHAR(58) + '//www.w3.org/2001/XMLSchema-instance" xmlns="http' + 
		CHAR(58) + '//www.fact.com.mx/schema/gt"', @XML) = 0
		SELECT @RutaDatosXML = '/Comprobante/Conceptos/Concepto'
	ELSE
		SELECT @RutaDatosXML = '/FactDocGT/Detalles/Detalle'    
  
	IF @Nailgun = 0
		SET @Shell = @RutaJasper + ' ' + CHAR(34) + @ArchivoXML + CHAR(34) + ' ' + CHAR(34) + @Ruta + CHAR(34) + ' ' + CHAR(34) + @RutaLogo + CHAR(34) + ' ' + 
			CHAR(34) + @ArchivoBMP + CHAR(34) + ' " " ' + CHAR(34) + @RutaDatosXML + CHAR(34) + ' ' + CHAR(34) + @Archivo + CHAR(34)+ ' ' + 
			CHAR(34) + @RutaJasper + CHAR(34)
	ELSE
		SET @Shell = @RutaNG + ' ' + CHAR(34) + @ArchivoXML + CHAR(34) + ' ' + CHAR(34) + @Ruta + CHAR(34) + ' ' + CHAR(34) + @RutaLogo + CHAR(34) + ' ' + 
			CHAR(34) + @ArchivoBMP + CHAR(34) + ' " " ' + CHAR(34) + @RutaDatosXML + CHAR(34) + ' ' + CHAR(34) + @Archivo + CHAR(34) + ' ' + 
			CHAR(34) + @RutaJasper + CHAR(34)
     
	INSERT @Datos
	EXEC xp_cmdshell @Shell   
    
	IF NOT EXISTS(SELECT * FROM AnexoMov WHERE Rama = @Modulo AND ID = @ID AND CFD = 1 AND Nombre LIKE '%.pdf')   
		INSERT AnexoMov (
			Sucursal, Rama, ID, Nombre, Direccion, Tipo, Icono, CFD) 
        VALUES (
			@Sucursal, @Modulo, @ID, @NomArch+'.pdf', @Archivo, 'Archivo', 745,   1)     
                     
                     
	IF NOT EXISTS(SELECT * FROM AnexoMov WHERE Rama = @Modulo AND ID = @ID AND CFD = 1 AND Nombre LIKE '%.xml')--AND Nombre = @NomArch)
		INSERT AnexoMov (
			Sucursal, Rama, ID, Nombre, Direccion, Tipo, Icono, CFD) 
        VALUES (
			@Sucursal, @Modulo, @ID, @NomArch+'.xml', REPLACE(@ArchivoXML,'Jasper',''), 'Archivo', 17, 1)
     
	RETURN
END
GO


/************************ spPOSReporteJasper *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSReporteJasper') AND type = 'P') DROP PROCEDURE dbo.spPOSReporteJasper
GO             
CREATE PROCEDURE spPOSReporteJasper 
	@Empresa	    varchar(5),	 
	@Modulo	        varchar(20),
	@ModuloID	    varchar(20),
	@ArchivoXML		varchar(255),
	@NomArch        varchar(255)       
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE 
    @MovCFD                     varchar(20),
    @ReferenciaOrdenCompra      varchar(50),
    @XmlJasper                  varchar(max)
   
    SELECT @MovCFD = MovFactura
    FROM POSCfg
    WHERE Empresa = @Empresa  
  
	IF @Modulo = 'VTAS'
		BEGIN
			IF EXISTS(SELECT * FROM Venta WHERE OrigenTipo = 'POS' AND ID = @ModuloID AND Mov = @MovCFD)
				BEGIN
					SELECT @ReferenciaOrdenCompra = ReferenciaOrdenCompra 
					FROM Venta 
					WHERE ID = @ModuloID
					
					SELECT @XmlJasper = dbo.fnPOSLeerArchivo(@ArchivoXML)
      
					IF EXISTS(SELECT * FROM POSL WHERE ID = @ReferenciaOrdenCompra)
						UPDATE POSL SET XmlJasper = @XmlJasper, NombreArchivo = @NomArch
						WHERE ID = @ReferenciaOrdenCompra    
				END
		END   
  
	RETURN
END
GO 
 


/**************** fnPOSUsuarioPerfilAccion ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSUsuarioPerfilAccion') DROP FUNCTION fnPOSUsuarioPerfilAccion
GO
CREATE FUNCTION dbo.fnPOSUsuarioPerfilAccion (
	@ID		varchar(36),
	@Accion	varchar(50))
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Usuario			varchar(10),
	@UsuarioAutoriza	varchar(10),
	@POSPerfil			varchar(10),
	@Resultado			bit

	SET @Resultado    = 0
   
	SELECT @Usuario =  Usuario, @UsuarioAutoriza = NULLIF(UsuarioAutoriza,'')
	FROM POSL 
	WHERE ID = @ID
  
	SELECT @POSPerfil = NULLIF(POSPerfil,'')
	FROM Usuario 
	WHERE Usuario = @Usuario
	
	IF @UsuarioAutoriza IS NOT NULL
		IF EXISTS(SELECT * FROM POSUsuarioAccion  WHERE Accion = @Accion AND Usuario = ISNULL(@POSPerfil,@Usuario))
			SET @Resultado = 1

	RETURN (@Resultado)
END
GO


/**************** fnPOSUsuarioPerfilAccion2 ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSUsuarioPerfilAccion2') DROP FUNCTION fnPOSUsuarioPerfilAccion2
GO
CREATE FUNCTION dbo.fnPOSUsuarioPerfilAccion2 (
	@ID      varchar(36),
	@Accion	varchar(50))
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Usuario			varchar(10),
	@POSPerfil			varchar(10),
	@Resultado			bit

	SET @Resultado    = 0
   
	SELECT @Usuario =  Usuario
	FROM POSL 
	WHERE ID = @ID
  
	SELECT @POSPerfil = NULLIF(POSPerfil,'')
	FROM Usuario 
	WHERE Usuario = @Usuario
	

	IF EXISTS(SELECT * FROM POSUsuarioAccion  WHERE Accion = @Accion AND Usuario = ISNULL(@POSPerfil,@Usuario))
		SET @Resultado = 1

	RETURN (@Resultado)
END
GO


/**************** fnPOSUsuarioPerfilMov ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSUsuarioPerfilMov') DROP FUNCTION fnPOSUsuarioPerfilMov
GO
CREATE FUNCTION dbo.fnPOSUsuarioPerfilMov (
	@ID		varchar(36),
	@Mov	varchar(20))
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Usuario			varchar(10),
	@UsuarioAutoriza	varchar(10),
	@POSPerfil			varchar(10),
	@Resultado			bit

	SET @Resultado    = 0
   
	SELECT @Usuario =  Usuario, @UsuarioAutoriza = NULLIF(UsuarioAutoriza,'')
	FROM POSL 
	WHERE ID = @ID
  
	SELECT @POSPerfil = NULLIF(POSPerfil,'')
	FROM Usuario 
	WHERE Usuario = @Usuario
	
	IF @UsuarioAutoriza IS NOT NULL
		IF EXISTS(SELECT * FROM POSUsuarioMov  WHERE Mov = @Mov AND Usuario = ISNULL(@POSPerfil,@Usuario))
			SET @Resultado = 1

	RETURN (@Resultado)
END
GO


/**************** fnPOSUsuarioPerfilMov2 ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSUsuarioPerfilMov2') DROP FUNCTION fnPOSUsuarioPerfilMov2
GO
CREATE FUNCTION dbo.fnPOSUsuarioPerfilMov2 (
	@ID		varchar(36),
	@Mov	varchar(20))
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Usuario			varchar(10),
	@POSPerfil			varchar(10),
	@Resultado			bit

	SET @Resultado    = 0
   
	SELECT @Usuario =  Usuario
	FROM POSL 
	WHERE ID = @ID
  
	SELECT @POSPerfil = NULLIF(POSPerfil,'')
	FROM Usuario 
	WHERE Usuario = @Usuario
	
	IF EXISTS(SELECT * FROM POSUsuarioMov  WHERE Mov = @Mov AND Usuario = ISNULL(@POSPerfil,@Usuario))
		SET @Resultado = 1

	RETURN (@Resultado)
END
GO


      
/**************** fnPOSCalcDescVenta   ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSCalcDescVenta') DROP FUNCTION fnPOSCalcDescVenta
GO
CREATE FUNCTION dbo.fnPOSCalcDescVenta (
	@ID       varchar(36)
) 
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  float

	SELECT @Resultado = -SUM(ISNULL(((Cantidad - ISNULL(CantidadObsequio,0)) * (Precio - (Precio * (ISNULL(DescuentoLinea,0)/100)))),0) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END) /100)
    FROM POSLVenta plv JOIN POSL p ON p.ID = plv.ID
	WHERE p.ID = @ID  

	RETURN (@Resultado)
END
GO      


/************************ spPOSLDITicket  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDITicket') AND type = 'P') DROP PROCEDURE dbo.spPOSLDITicket
GO             
CREATE PROCEDURE spPOSLDITicket
	@ID	            varchar(36),
	@IDLog          int,
	@Estacion       int,
	@Bandera2		bit = 0        
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE 
	@Comprobante	varchar(max),
	@Campo			varchar(255), 
	@IDt			int, 
	@Bandera		bit, 
	@Campo2			varchar(255), 
	@IDt2			int
	
	SELECT @Comprobante = Comprobante 
	FROM POSLDIlog 
	WHERE IDModulo = @ID

	IF @Comprobante IS NULL
		BEGIN
			SELECT @IDLog = MAX(ID)
			FROM POSLDILog
			WHERE IDModulo = @ID   
	    
			SELECT @Comprobante = Comprobante 
			FROM POSLDIlog 
			WHERE IDModulo = @ID AND ID = @IDLog
		END

	IF EXISTS (SELECT * FROM POSLDITicket WHERE RID = @ID)	
		DELETE POSLDITicket WHERE RID = @ID
		
	IF SUBSTRING(@Comprobante,465,12) = '@br@br@br@br'
		SELECT @Comprobante = substring(@Comprobante,1,464)
	
	IF SUBSTRING(@Comprobante,1,6)='@Logo1' 
		BEGIN		
			INSERT  POSLDITicket(
				Estacion, RID, Campo)
			SELECT
				@Estacion, @ID, Campo
			FROM dbo.fnPOSGenerarTicket(@Comprobante,'@')

			DECLARE crBC1 CURSOR LOCAL FOR			
			SELECT plt.ID, plt.Campo
			FROM POSLDITicket plt
			WHERE plt.RID = @ID
		
			OPEN crBC1
			FETCH NEXT FROM crBC1 INTO @IDt, @Campo
			WHILE @@FETCH_STATUS <> -1 
				BEGIN
					IF @@FETCH_STATUS <> -2 
						BEGIN	
							SET @Bandera = 0
					
							SELECT @Campo = REPLACE(@Campo,'Logo1', '' ), @Bandera = 1	
							SELECT @Campo = REPLACE(@Campo,'cnb ', '' ), @Bandera = 1

							IF @Campo LIKE '%cnn%' 
								SELECT @Campo = REPLACE(@Campo,'cnn ', '' ), @Bandera = 1		
											
							IF @Campo LIKE '%br%' 
								SELECT @Campo = REPLACE(@Campo,'br ', '' ), @Bandera = 1
								SELECT @Campo = REPLACE(@Campo,'br', '' ), @Bandera = 1
	
							IF @Campo LIKE '%lnn%'
								SELECT @Campo = REPLACE(@Campo,'lnn ', '' ), @Bandera = 1
					
							IF @Campo LIKE '% br br br br br br br br%'
								SELECT @Campo = REPLACE(@Campo,'br br br br br br br br', '' ), @Bandera = 1
	
							IF @Bandera = 1
								UPDATE POSLDITicket SET Campo = @Campo WHERE RID = @ID AND ID = @IDt

						END
				
					FETCH NEXT FROM crBC1 INTO @IDt, @Campo
				END
			CLOSE crBC1
			DEALLOCATE crBC1 

			IF @Bandera2 = 1 AND EXISTS (SELECT * FROM POSLDITicket WHERE RID = @ID AND Campo LIKE '%C-O-M-E-R-C-I-O%')
				BEGIN
					SELECT @IDt2 = ID, @Campo2 = Campo 
					FROM POSLDITicket 
					WHERE RID = @ID AND Campo LIKE '%C-O-M-E-R-C-I-O%'
					
					SELECT @Campo2 = REPLACE(@Campo2,'C-O-M-E-R-C-I-O', 'C-L-I-E-N-T-E')
					
					UPDATE POSLDITicket SET Campo = @Campo2 WHERE RID = @ID AND ID = @IDt2 	  
				END
		END
	ELSE IF substring(@Comprobante,6,1)='B' -- VOUCHER BANCOMER 
		BEGIN
			INSERT  POSLDITicket(
				Estacion, RID, Campo)
			SELECT
				@Estacion, @ID, Campo
			FROM dbo.fnPOSGenerarTicket(@Comprobante,'@')  

			DECLARE crBC1 CURSOR LOCAL FOR			
			SELECT plt.ID, plt.Campo
			FROM POSLDITicket plt
			WHERE plt.RID = @ID
		
			OPEN crBC1
			FETCH NEXT FROM crBC1 INTO @IDt, @Campo
			WHILE @@FETCH_STATUS <> -1 
				BEGIN
					IF @@FETCH_STATUS <> -2 
						BEGIN	
							SET @Bandera = 0
	
							IF @Campo LIKE '%cnb%' AND @Bandera = 0
								SELECT @Campo = REPLACE(@Campo,'cnb', '          ' ), @Bandera = 1

							IF @Campo LIKE '%cnn%' AND @Bandera = 0
								SELECT @Campo = REPLACE(@Campo,'cnn', '' ), @Bandera = 1		

							IF @Campo LIKE 'br%' AND @Bandera = 0
								SELECT @Campo = REPLACE(@Campo,'br', '' ), @Bandera = 1

							IF @Campo LIKE '%lnn%' AND @Bandera = 0
								SELECT @Campo = REPLACE(@Campo,'lnn', '' ), @Bandera = 1
	
							IF @Bandera = 1
								UPDATE POSLDITicket SET Campo = @Campo WHERE RID = @ID AND ID = @IDt
						END
				
					FETCH NEXT FROM crBC1 INTO @IDt, @Campo
				END
			CLOSE crBC1
			DEALLOCATE crBC1   
		END 
	ELSE
		BEGIN	-- OTROS SERVICIOS 
			INSERT  POSLDITicket(
				Estacion, RID, Campo)
			SELECT
				@Estacion, @ID, Campo
			FROM dbo.fnPOSGenerarTicket(@Comprobante,'<BR>')
		END
END
GO 


/**************** spPOSSerieLoteLimpiar ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSSerieLoteLimpiar') and type = 'P') DROP PROCEDURE dbo.spPOSSerieLoteLimpiar
GO              
CREATE PROCEDURE spPOSSerieLoteLimpiar
	@Estacion		int,
    @ID  			varchar(36), 
	@RenglonID		int, 
    @Articulo       varchar(20),
	@SubCuenta		varchar(50)
--//WITH ENCRYPTION
AS 
BEGIN
	DELETE POSLSerieLoteTemp  
    WHERE Estacion   = @Estacion
    AND ID        = @ID
    AND RenglonID = @RenglonID
    AND Articulo  = @Articulo
END
GO


/**************** spPOSValidarPOSC ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSValidarPOSC') and type = 'P') DROP PROCEDURE dbo.spPOSValidarPOSC
GO              
CREATE PROCEDURE spPOSValidarPOSC
	@Empresa   varchar(5)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@Host  varchar(20)
  
	SELECT TOP 1 @Host = Host FROM POSiSync 
  
	IF NOT EXISTS(SELECT Mov, Sucursal, Host FROM POSC WHERE Empresa = @Empresa AND Host = @Host  GROUP BY Mov, Sucursal, Host HAVING COUNT(*) > 1)
		BEGIN
			UPDATE POSCfg SET MovDuplicados = 0 WHERE Empresa = @Empresa
    
			IF NOT EXISTS (SELECT * FROM sysindexes, sysobjects WHERE sysobjects.name = 'POSC' AND sysindexes.name = 'POSCMovSucursal' AND sysobjects.id = sysindexes.id)
				CREATE  INDEX  POSCMovSucursal ON dbo.POSC (Mov, Sucursal, Host) ON [PRIMARY]
		END
	ELSE
		BEGIN
			UPDATE POSCfg SET MovDuplicados = 1 WHERE Empresa IN (SELECT Empresa FROM POSC GROUP BY Mov, Sucursal,Empresa HAVING COUNT(*) > 1)
		END
END
GO


/************************ spPOSAbrir *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAbrir') AND type = 'P') DROP PROCEDURE dbo.spPOSAbrir
GO             
CREATE PROCEDURE spPOSAbrir
	@Empresa   varchar(5),
	@Usuario   varchar(10)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Host				varchar(20),
	@ID					varchar(36),
	@DefCajero			varchar(10),
	@DefSucursal		int

	SELECT @DefCajero = DefCajero, @DefSucursal = Sucursal  
	FROM Usuario 
	WHERE Usuario = @Usuario
	
	SELECT TOP 1 @Host = Host 
	FROM POSiSync
	
	SELECT TOP 1 @ID = ID 
	FROM POSL 
	WHERE Estatus = 'PENDIENTE' AND Cajero = @DefCajero AND Sucursal = @DefSucursal 
	ORDER BY FechaRegistro DESC
	
	IF @ID IS NULL
		SELECT TOP 1 @ID = ID 
		FROM POSL 
		WHERE Estatus = 'SINAFECTAR' AND Cajero = @DefCajero AND Sucursal = @DefSucursal 
		ORDER BY FechaRegistro DESC
	
	SELECT @ID
END
GO


 /**************** spPOSSolicitudPedidoLocal  ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSSolicitudPedidoLocal') AND type = 'P') DROP PROCEDURE dbo.spPOSSolicitudPedidoLocal
GO 
CREATE PROC spPOSSolicitudPedidoLocal
	@ID      		varchar(50),
	@Empresa        varchar(5),
	@Estacion       int,
	@Sucursal       int,
	@Usuario        varchar(10),
	@Ok             int				OUTPUT,
	@OkRef          varchar(255)	OUTPUT
--//WITH ENCRYPTION  
AS
BEGIN
	DECLARE 
	@Cliente      varchar(10)
  
	DECLARE @Venta table(
		Estacion				int,
		ID						int,   
		Empresa					varchar(5) , 
		Mov						varchar(20), 
		MovID					varchar(20), 
		FechaEmision			datetime, 
		Concepto				varchar(50), 
		Proyecto				varchar(50), 
		UEN						int, 
		Moneda					varchar(10), 
		TipoCambio				float, 
		Usuario					varchar(10), 
		Referencia				varchar(50), 
		Observaciones			varchar(100), 
		Estatus					varchar(15), 
		Cliente					varchar(10), 
		EnviarA					int, 
		Almacen					varchar(10), 
		Agente					varchar(10), 
		AgenteServicio			varchar(10), 
		AgenteComision			float, 
		FormaEnvio				varchar(50), 
		Condicion				varchar(50), 
		Vencimiento				datetime   , 
		CtaDinero				varchar(10), 
		Descuento				varchar(30), 
		DescuentoGlobal			float, 
		Importe					money, 
		Impuestos				money, 
		Saldo					money, 
		DescuentoLineal			money, 
		OrigenTipo				varchar(10), 
		Origen					varchar(20), 
		OrigenID				varchar(20),
		FechaRegistro			datetime   , 
		Causa					varchar(50), 
		Atencion				varchar(50), 
		AtencionTelefono		varchar(50), 
		ListaPreciosEsp			varchar(20), 
		ZonaImpuesto			varchar(30), 
		Sucursal				int, 
		SucursalOrigen			int  
		)  
  
	DECLARE @VentaD table(
		Estacion				int,
		ID						int,   
		Renglon					float, 
		RenglonSub				int, 
		RenglonID				int, 
		RenglonTipo				char(1),
		Cantidad				float, 
		Almacen					varchar(10), 
		EnviarA					int, 
		Articulo				varchar(20), 
		SubCuenta				varchar(50), 
		Precio					float, 
		DescuentoLinea			money, 
		Impuesto1				float, 
		Impuesto2				float, 
		Impuesto3				float, 
		Aplica					varchar(20), 
		AplicaID				varchar(20), 
		CantidadPendiente		float, 
		CantidadReservada		float, 
		CantidadCancelada		float, 
		CantidadOrdenada		float, 
		CantidadA				float, 
		Unidad					varchar(50), 
		Factor					float, 
		Puntos					money, 
		CantidadObsequio		float, 
		OfertaID				int, 
		Sucursal				int,
		Codigo					varchar(30) 
		)  

	SELECT @Cliente = Cliente FROM POSL WHERE ID = @ID
 
	IF @Ok IS NULL
		BEGIN
			DELETE POSVentaPedidoTemp  WHERE Estacion = @Estacion  
			DELETE POSVentaPedidoDTemp  WHERE Estacion = @Estacion  

			INSERT @Venta(
				Estacion, ID, Empresa, Mov, MovID, FechaEmision, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, 
				Observaciones, Estatus, Cliente, EnviarA, Almacen, Agente, AgenteServicio, AgenteComision, FormaEnvio, Condicion, Vencimiento, 
				CtaDinero, Descuento, DescuentoGlobal, Importe, Impuestos, Saldo, DescuentoLineal, OrigenTipo, Origen, OrigenID, FechaRegistro, 
				Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, SucursalOrigen)  
			SELECT
				@Estacion, v.ID, v.Empresa, v.Mov, v.MovID, v.FechaEmision, v.Concepto, v.Proyecto, v.UEN, v.Moneda, v.TipoCambio, v.Usuario, v.Referencia, 
				v.Observaciones, v.Estatus, v.Cliente, v.EnviarA, v.Almacen, v.Agente, v.AgenteServicio, v.AgenteComision, v.FormaEnvio, v.Condicion, v.Vencimiento,
				v.CtaDinero, v.Descuento, v.DescuentoGlobal, v.Importe, v.Impuestos, v.Saldo, v.DescuentoLineal, v.OrigenTipo, v.Origen, v.OrigenID, v.FechaRegistro,
				v.Causa, v.Atencion, v.AtencionTelefono, v.ListaPreciosEsp, v.ZonaImpuesto, v.Sucursal, v.SucursalOrigen
			FROM Venta v JOIN MovTipo mt ON v.Mov = mt.Mov AND mt.Modulo = 'VTAS'
			WHERE v.Empresa = @Empresa 
			AND v.Estatus IN ('PENDIENTE')
			AND mt.Clave = 'VTAS.P'
			AND v.Cliente = @Cliente
    
			IF @@ERROR<>0 
				SET @Ok = 1
    
			IF @Ok IS NULL
				BEGIN
					INSERT @VentaD(
						Estacion,ID, Renglon, RenglonSub, RenglonID, RenglonTipo, Cantidad, Almacen, EnviarA, Articulo, SubCuenta, Precio, DescuentoLinea, 
						Impuesto1, Impuesto2, Impuesto3, Aplica, AplicaID, CantidadPendiente, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadA, 
						Unidad, Factor, Puntos, CantidadObsequio, OfertaID, Sucursal, Codigo) 
					SELECT
						@Estacion, ID, Renglon, RenglonSub, RenglonID, RenglonTipo, Cantidad, Almacen, EnviarA, Articulo, SubCuenta, Precio, DescuentoLinea, 
						Impuesto1, Impuesto2, Impuesto3, Aplica, AplicaID, CantidadPendiente, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadA, 
						Unidad, Factor, Puntos, CantidadObsequio, OfertaID, Sucursal,Codigo
					FROM VentaD
					WHERE ID IN (SELECT ID FROM @Venta) 
      
					IF @@ERROR<>0 
						SET @Ok = 1
				END
  
			IF @Ok IS NULL
				BEGIN
					INSERT POSVentaPedidoTemp(
						Estacion, ID, Empresa, Mov, MovID, FechaEmision, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, Observaciones, 
						Estatus, Cliente, EnviarA, Almacen, Agente, AgenteServicio, AgenteComision, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento,
						DescuentoGlobal, Importe, Impuestos, Saldo, DescuentoLineal, OrigenTipo, Origen, OrigenID, FechaRegistro, Causa, Atencion, 
						AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, SucursalOrigen)
					SELECT
						Estacion, ID, Empresa, Mov, MovID, FechaEmision, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, Observaciones, 
						Estatus, Cliente, EnviarA, Almacen, Agente, AgenteServicio, AgenteComision, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, 
						DescuentoGlobal, Importe, Impuestos, Saldo, DescuentoLineal, OrigenTipo, Origen, OrigenID, FechaRegistro, Causa, Atencion, 
						AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, SucursalOrigen
					FROM @Venta
					WHERE Estacion = @Estacion  
      
					IF @@ERROR<>0 
						SET @Ok = 1
      
					IF @Ok  IS NULL
						INSERT POSVentaPedidoDTemp(
							Estacion, ID, Renglon, RenglonSub, RenglonID, RenglonTipo, Cantidad, Almacen, EnviarA, Articulo, SubCuenta, Precio, 
							DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Aplica, AplicaID, CantidadPendiente, CantidadReservada, CantidadCancelada, 
							CantidadOrdenada, CantidadA, Unidad, Factor, Puntos, CantidadObsequio, OfertaID, Sucursal, Codigo)
						SELECT
							d.Estacion, d.ID, d.Renglon, d.RenglonSub, d.RenglonID, d.RenglonTipo, d.Cantidad, d.Almacen, d.EnviarA, d.Articulo, d.SubCuenta, d.Precio,
							d.DescuentoLinea, d.Impuesto1, d.Impuesto2, d.Impuesto3, v.Mov,  v.MovID,  d.CantidadPendiente, d.CantidadReservada, d.CantidadCancelada,
							d.CantidadOrdenada, d.CantidadA, d.Unidad, d.Factor, d.Puntos, d.CantidadObsequio, d.OfertaID, d.Sucursal, d.Codigo
						FROM @VentaD d JOIN @Venta v ON d.Estacion = v.Estacion AND d.ID = v.ID
						WHERE d.Estacion = @Estacion         
				END
		END

END
GO


/**************** spPOSSolicitudAnticiposCxcLocal  ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSSolicitudAnticiposCxcLocal')AND type = 'P') DROP PROCEDURE dbo.spPOSSolicitudAnticiposCxcLocal
GO 
CREATE PROC spPOSSolicitudAnticiposCxcLocal
	@ID      		varchar(50),
	@Empresa        varchar(5),
	@Estacion       int,
	@Sucursal       int,
	@Usuario        varchar(10),
	@Ok             int				OUTPUT,
	@OkRef          varchar(255)	OUTPUT
--//WITH ENCRYPTION  
AS
BEGIN
	DECLARE 
	@Cliente      varchar(10)  
  
	DECLARE @Tabla table(        
		RID                     int          NULL,
        Cliente                 varchar(10)  NULL,
        Mov                     varchar(20)  NULL,
        MovID                   varchar(20)  NULL,
        FechaEmision            datetime     NULL,
        Referencia              varchar(50)  NULL,
        Concepto                varchar(50)  NULL,
        AnticipoSaldo           float        NULL,
        Moneda                  varchar(10)  NULL,
        TipoCambio              float        NULL,
        Importe                 float        NULL,
        Impuestos               float        NULL,
        Retencion               float        NULL, 
        AnticipoAplicar         float        NULL,
        POSGUID                 varchar(50)  NULL) 
  
	SELECT @Cliente = Cliente FROM POSL WHERE ID = @ID
  
	IF @Ok IS NULL
		BEGIN
			DELETE POSCxcAnticipoTemp  WHERE Estacion = @Estacion  

			INSERT @Tabla(
				RID, Cliente, Mov, MovID, FechaEmision, Referencia, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, Impuestos, Retencion, AnticipoAplicar, POSGUID)  
			SELECT
				ID, Cliente, Mov, MovID, FechaEmision, Referencia, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, Impuestos, Retencion, AnticipoAplicar, POSGUID
			FROM Cxc
			WHERE Empresa = @Empresa 
			AND Estatus IN ('PENDIENTE', 'CONCLUIDO')
			AND AnticipoSaldo>0
			AND Cliente = @Cliente    
			
			IF @@ERROR<>0 
				SET @Ok = 1

			IF @Ok IS NULL
				BEGIN
					INSERT POSCxcAnticipoTemp(
						Estacion, RID, Cliente, Mov, MovID, FechaEmision, Referencia, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, Impuestos, 
						Retencion, AnticipoAplicar, GUIDOrigen)
					SELECT
						@Estacion, RID, Cliente, Mov, MovID, FechaEmision, Referencia, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, Impuestos, 
						Retencion, AnticipoAplicar, POSGUID
					FROM @Tabla
			
					IF @@ERROR<>0 
						SET @Ok = 1      
				END
		END
END
GO


/**************** spPOSSolicitudAfectarVentaLocal  ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSSolicitudAfectarVentaLocal')AND type = 'P') DROP PROCEDURE dbo.spPOSSolicitudAfectarVentaLocal
GO 
CREATE PROC spPOSSolicitudAfectarVentaLocal
	@ID      	varchar(50),
	@Empresa        varchar(5),
	@Estacion       int,
	@Sucursal       int,
	@Usuario        varchar(10),
	@Ok             int OUTPUT,
	@OkRef          varchar(255) OUTPUT
--//WITH ENCRYPTION  
AS
BEGIN
	DECLARE 
	@Cliente						varchar(10),
	@IDVenta						int,
	@Monedero						varchar(20),
	@CodigoRedondeo					varchar(50),
	@ArticuloRedondeo				varchar(20), 
	@VentaPreciosImpuestoIncluido	bit 
  
	DECLARE @Anticipos table(
		ID                   int, 
		AnticipoAplicar      float
	)    

	SELECT @CodigoRedondeo = pc.RedondeoVentaCodigo
    FROM POSCfg pc
    WHERE pc.Empresa = @Empresa
   
	SELECT @VentaPreciosImpuestoIncluido = ISNULL(VentaPreciosImpuestoIncluido,0)
    FROM EmpresaCfg 
    WHERE Empresa = @Empresa

	SELECT @ArticuloRedondeo = Cuenta
    FROM CB
    WHERE Codigo = @CodigoRedondeo
    AND TipoCuenta = 'Articulos'  

	SELECT @Monedero = Monedero 
	FROM POSL 
	WHERE ID = @ID
   
	IF @Ok IS NULL
		BEGIN
			INSERT Venta (
				Empresa, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, Estatus,      
				Observaciones, Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Causa, 
				Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, Origen, OrigenID, ReferenciaOrdenCompra, GenerarDinero, 
				SucursalOrigen, AnticipoFacturadoTipoServicio)
			SELECT
				Empresa, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, 'SINAFECTAR', Observaciones, 
				Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Causa, Atencion, AtencionTelefono,
				ListaPreciosEsp, ZonaImpuesto, Sucursal, 'POS', Origen, OrigenID, ID, 1, Sucursal, 1
			FROM POSL       
			WHERE ID = @ID 
			
			SELECT @IDVenta = SCOPE_IDENTITY()                  
		END
 
	IF @Ok IS NULL AND @IDVenta IS NOT NULL
		BEGIN
			INSERT VentaD (
				ID, Renglon, RenglonID, Aplica, AplicaID, RenglonTipo, Cantidad, CantidadObsequio, Almacen, EnviarA, Articulo, SubCuenta, Precio,
				DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, Sucursal, Puntos, AnticipoFacturado, AnticipoRetencion, AnticipoMoneda,
				AnticipoTipoCambio)
			SELECT
				@IDVenta, d.Renglon, d.RenglonID, v.Origen, v.OrigenID, d.RenglonTipo, d.Cantidad, d.CantidadObsequio, d.Almacen, NULL, d.Articulo, d.SubCuenta, 
				CASE WHEN d.Articulo = @ArticuloRedondeo 
						THEN d.Precio / (1-(ISNULL(v.DescuentoGlobal,0)/100)) 
					 ELSE CASE WHEN @VentaPreciosImpuestoIncluido = 1 
								  THEN d.PrecioImpuestoInc 
							   ELSE d.Precio 
							   END 
					 END, d.DescuentoLinea, d.Impuesto1, d.Impuesto2, d.Impuesto3, d.Unidad, 1, v.Sucursal, d.Puntos, d.AnticipoFacturado, d.AnticipoRetencion, v.Moneda,
			   v.TipoCambio
			FROM POSLVenta  d
			JOIN POSL  v ON v.ID = d.ID
			WHERE v.ID = @ID   
		END
   
	IF EXISTS(SELECT * FROM POSValeSerie WHERE Serie = @Monedero)AND @IDVenta IS NOT NULL
		INSERT TarjetaSerieMov(
			Empresa, ID, Modulo, Serie, Sucursal)
		SELECT
			@Empresa, @IDVenta, 'VTAS', @Monedero, @Sucursal    
     
	IF EXISTS(SELECT * FROM POSLSerieLote WHERE ID = @ID )AND @IDVenta IS NOT NULL
		INSERT SerieLoteMov (
			Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal)
		SELECT
			@Empresa, 'VTAS', @IDVenta, RenglonID, Articulo, ISNULL(SubCuenta, ''), SerieLote, COUNT(*), @Sucursal  
		FROM POSLSerieLote 
		WHERE ID = @ID
		GROUP BY Articulo, ISNULL(SubCuenta,''), SerieLote, RenglonID 
      
	IF EXISTS(SELECT * FROM POSVentaCobro WHERE ID = @ID)AND @IDVenta IS NOT NULL
		INSERT VentaCobro(
			ID, Importe1, Importe2, Importe3, Importe4, Importe5, FormaCobro1, FormaCobro2, FormaCobro3, FormaCobro4, FormaCobro5, Referencia1, Referencia2, 
			Referencia3, Referencia4, Referencia5, CtaDinero, Cajero,POSTipoCambio1, POSTipoCambio2, POSTipoCambio3, POSTipoCambio4, POSTipoCambio5)            
		SELECT
			@IDVenta, Importe1, Importe2, Importe3, Importe4, Importe5, FormaCobro1, FormaCobro2, FormaCobro3, FormaCobro4, FormaCobro5, Referencia1, Referencia2,
			Referencia3, Referencia4, Referencia5, CtaDinero, Cajero,POSTipoCambio1, POSTipoCambio2, POSTipoCambio3, POSTipoCambio4, POSTipoCambio5
		FROM POSVentaCobro
		WHERE ID = @ID
    
	IF EXISTS (SELECT * FROM POSTarjetaSerieMov WHERE ID = @ID)AND @IDVenta IS NOT NULL
		INSERT TarjetaSerieMov(
			Empresa, ID, Importe, ImporteTarjeta, Modulo, Serie, Sucursal, TipoCambioTarjeta)
		SELECT
			Empresa, @IDVenta, Importe, ImporteTarjeta, 'VTAS', Serie, Sucursal, TipoCambioTarjeta
		FROM POSTarjetaSerieMov 
		WHERE ID = @ID
     
	INSERT @Anticipos(
		ID, AnticipoAplicar) 
	SELECT
		RID, AnticipoAplicar      
	FROM POSCxcAnticipoTemp
	WHERE Estacion = @Estacion AND ISNULL(AnticipoAplicar,0.0)>0.0      

	IF EXISTS(SELECT * FROM @Anticipos)AND @IDVenta IS NOT NULL
		BEGIN
			INSERT POSCxcAnticipo(
				ID, RID, Cliente, Mov, MovID, FechaEmision, Referencia, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, Impuestos ,Retencion, 
				AnticipoAplicar, GUIDOrigen, PedidoReferencia, PedidoReferenciaID)
			SELECT
				@ID, RID, Cliente, Mov, MovID, FechaEmision, Referencia, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, Impuestos ,Retencion, 
				AnticipoAplicar, GUIDOrigen, PedidoReferencia, PedidoReferenciaID
			FROM POSCxcAnticipoTemp
			WHERE Estacion = @Estacion AND ISNULL(AnticipoAplicar,0.0)>0.0 
     
			UPDATE Cxc SET AnticipoAplicaID = @IDVenta ,AnticipoAplicaModulo = 'VTAS',AnticipoAplicar =a.AnticipoAplicar
			FROM @Anticipos a JOIN Cxc c ON a.ID = c.ID  
		END

	IF @Ok IS NULL AND @IDVenta IS NOT NULL AND @Usuario IS NOT NULL
		EXEC spAfectar 'VTAS', @IDVenta, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT
END   
GO 


/************************ spPOSAfectarPOSLLocal *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAfectarPOSLLocal') AND type = 'P') DROP PROCEDURE dbo.spPOSAfectarPOSLLocal
GO             
CREATE PROCEDURE spPOSAfectarPOSLLocal
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@Empresa		varchar(5),
    @Modulo			varchar(5),
    @Sucursal		int,
    @Usuario		varchar(10),
    @Host			varchar(20),
    @ID				varchar(36),   
    @Empresa2		varchar(5),
    @Modulo2		varchar(5),
    @Sucursal2		int,
    @Usuario2		varchar(10),
    @Host2			varchar(20),
    @ID2			varchar(36), 	  
    @Ok				int,
    @OkRef			varchar(255),
    @Mov            varchar(20),
    @Mov2           varchar(20),
    @MovClave       varchar(20),
    @MovAfectar     varchar(20)
  
	BEGIN TRAN  
	
	DECLARE crPOSL CURSOR LOCAL FOR  	  
  
	SELECT 
		p.Empresa,
		p.Modulo,
		p.Sucursal,
		p.Usuario,
		p.ID,
		p.Host,
		p.Mov
    FROM POSL p
	INNER JOIN MovTipo mt ON p.Mov = mt.Mov
	AND mt.Modulo = 'POS'
	WHERE p.Estatus IN ('CONCLUIDO','TRASPASADO') AND ISNULL(p.AfectadoLocal,0) = 0
	ORDER BY p.FechaRegistro, p.Orden, p.IDR
  
	OPEN crPOSL
	FETCH NEXT FROM crPOSL INTO @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Mov
	WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
		BEGIN
			IF @@FETCH_STATUS <> -2 AND @Ok IS NULL
				BEGIN      
					SELECT @MovClave = Clave FROM MovTipo WHERE Mov = @Mov AND Modulo = 'POS'
    
					IF @MovClave NOT IN ('POS.FTE','POS.STE','POS.CC','POS.CCM','POS.TCAC','POS.CTCAC','POS.CTCRC','POS.TCRC') AND @Ok IS NULL
						BEGIN    
							EXEC spPOSAfectar @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Ok OUTPUT, @OkRef OUTPUT
        
							IF @Ok IS NOT NULL 
								SELECT @MovAfectar = @Mov
        
							IF @MovClave IN ('POS.TCM','POS.CTCM') AND @Ok IS NULL
								BEGIN
									IF EXISTS (SELECT * FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS'   
											   WHERE p.IDR = @ID AND p.Estatus IN('CONCLUIDO') AND m.Clave IN('POS.TCM','POS.CTCM'))
										UPDATE POSL SET AfectadoLocal = 1 WHERE ID IN (SELECT ID FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS'   
																					   WHERE p.IDR = @ID AND p.Estatus IN('CONCLUIDO') AND m.Clave IN('POS.TCM','POS.CTCM'))
								END
        
							IF @MovClave IN ('POS.TRM','POS.CTRM' ) AND @Ok IS NULL
								BEGIN
									IF EXISTS (SELECT * FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS'   
											   WHERE p.IDR = @ID AND p.Estatus IN('CONCLUIDO') AND m.Clave IN('POS.TRM','POS.CTRM'))
										UPDATE POSL SET AfectadoLocal = 1 WHERE ID IN (SELECT ID FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS'   
																					   WHERE p.IDR = @ID AND p.Estatus IN('CONCLUIDO') 
																					   AND m.Clave IN('POS.CTCRC','POS.TCRC'))
								END           
						END 
      
					IF @MovClave IN ('POS.CC','POS.CCM')AND @Ok IS NULL
						BEGIN
							IF  EXISTS(SELECT * FROM POSL p JOIN MovTipo m ON p.Mov = m.Mov  AND m.Modulo = 'POS' 
									   WHERE p.IDR = @ID AND m.Clave IN ('POS.FTE','POS.STE') AND p.Estatus = 'CONCLUIDO')
								BEGIN 
									DECLARE crFaltanteSobrante CURSOR FOR   
									SELECT p.Empresa, p.Modulo, p.Sucursal, p.Usuario, p.ID, p.Host, p.Mov
									FROM POSL p
									INNER JOIN MovTipo mt ON p.Mov = mt.Mov  AND mt.Modulo = 'POS'AND mt.Clave IN ('POS.FTE','POS.STE')
									WHERE p.Estatus IN ('CONCLUIDO') AND p.IDR = @ID
									ORDER BY FechaRegistro
						
									OPEN crFaltanteSobrante
									FETCH NEXT FROM crFaltanteSobrante INTO @Empresa2, @Modulo2, @Sucursal2, @Usuario2, @ID2, @Host2, @Mov2
									WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
										BEGIN  
											EXEC spPOSAfectar @Empresa2, @Modulo2, @Sucursal2, @Usuario2, @ID2, @Host2, @Ok OUTPUT, @OkRef OUTPUT
							
											IF @Ok IS NOT NULL 
												SELECT @MovAfectar = @Mov2,  @ID = @ID2       
								
											IF @Ok IS NULL
												UPDATE POSL Set AfectadoLocal = 1 WHERE ID = @ID2
											
											FETCH NEXT FROM crFaltanteSobrante INTO @Empresa2, @Modulo2, @Sucursal2, @Usuario2, @ID2, @Host2, @Mov2
										END
									CLOSE crFaltanteSobrante
									DEALLOCATE crFaltanteSobrante  
          
									IF @Ok IS NULL 
										EXEC spPOSAfectar @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Ok OUTPUT, @OkRef OUTPUT
          
									IF @Ok IS NOT NULL 
										SELECT @MovAfectar = @Mov
								END  
							ELSE
								BEGIN
									EXEC spPOSAfectar @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Ok OUTPUT, @OkRef OUTPUT
						
									IF @Ok IS NOT NULL 
										SELECT @MovAfectar = @Mov
								END   
						END
		
					IF @Ok IS NULL
						UPDATE POSL Set AfectadoLocal = 1 WHERE ID = @ID
				END
    
			FETCH NEXT FROM crPOSL INTO @Empresa, @Modulo, @Sucursal, @Usuario, @ID, @Host, @Mov
		END
	CLOSE crPOSL
	DEALLOCATE crPOSL
  
	IF @Ok IS NULL
		COMMIT TRAN
	ELSE 
		ROLLBACK TRAN  
  
	IF @Ok IS NOT NULL
		SELECT @OkRef = Descripcion +' '+ISNULL(@OkRef,'')
		FROM MensajeLista WHERE Mensaje = @Ok  
	
	IF @Ok IS NOT NULL
		SELECT @Ok, @OkRef, @Modulo, @ID, @MovAfectar
END
GO 


/**************** spPOSInsertarCobroCondicionTemp    ****************/
IF EXISTS (SELECT * FROM sysobjects where id = object_id('dbo.spPOSInsertarCobroCondicionTemp')AND type = 'P') drop procedure dbo.spPOSInsertarCobroCondicionTemp
GO 
CREATE PROC spPOSInsertarCobroCondicionTemp
	@ID      		varchar(50),
	@Empresa        varchar(5),
	@Estacion       int,
	@Sucursal       int,
	@Usuario        varchar(10)
--//WITH ENCRYPTION  
AS
BEGIN
	DECLARE 
	@POSImpuestoIncluido		bit,
	@ArticuloRedondeo			varchar(20),
	@ArtOfertaFP				varchar(20),
	@ArtOfertaImporte			varchar(20),
	@CodigoRedondeo				varchar(30),
	@Mes						varchar(35),  
	@Categoria					varchar(35), 
	@Grupo						varchar(35),
	@Familia					varchar(35), 
	@Linea						varchar(35), 
	@Fabricante					varchar(35),
	@Articulo					varchar(35),
	@FormaPago					varchar(45),
	@FechaD						datetime,
	@FechaA						datetime,
	@HoraD						varchar(5),
	@HoraA						varchar(5),
	@Hoy						dateTime
    
	SELECT @Hoy = dbo.fnfechasinhora(GETDATE())   
	
	TRUNCATE TABLE FormaPagoPos
  
	SELECT @POSImpuestoIncluido = ISNULL(ImpuestoIncluido,0),@CodigoRedondeo = RedondeoVentaCodigo , @ArtOfertaFP = ArtOfertaFP, @ArtOfertaImporte = ArtOfertaImporte
    FROM POSCfg 
	WHERE Empresa = @Empresa
  
	SELECT @ArticuloRedondeo = cb.Cuenta 
	FROM CB 
	WHERE CB.Cuenta = @CodigoRedondeo AND CB.TipoCuenta = 'Articulos'    
  
	IF EXISTS(SELECT * FROM POSCobroCondicionTemp WHERE Estacion = @Estacion)
		DELETE POSCobroCondicionTemp WHERE Estacion = @Estacion
    
	INSERT POSCobroCondicionTemp(
		Estacion, ID, Renglon, Cantidad, Articulo, FormaPago, 
		Precio, PrecioTotal)
	SELECT
		@Estacion, @ID, p.Renglon, p.Cantidad, p.Articulo, '', 
		CASE WHEN @POSImpuestoIncluido =1 
				THEN p.PrecioImpuestoInc 
			 ELSE p.Precio 
			 END, (p.Cantidad - ISNULL(p.CantidadObsequio, 0.0)) * ISNULL((p.PrecioImpuestoInc - (p.PrecioImpuestoInc * (ISNULL(p.DescuentoLinea,0.0)/100))),0.0)
    FROM POSLVenta p
	LEFT OUTER JOIN OfertaD od ON  p.Articulo = od.Articulo
	LEFT OUTER JOIN Oferta o ON  od.ID = o.ID
	LEFT OUTER JOIN MovTipo mt ON  o.Mov  = mt.Mov AND mt.Modulo = 'OFER' AND mt.Clave = 'OFER.OF'
	WHERE p.ID = @ID 
    AND ISNULL((p.Cantidad - ISNULL(p.CantidadObsequio, 0.0)) * ISNULL((p.Precio - (p.Precio * (ISNULL(p.DescuentoLinea,0.0)/100))),0.0),0.0) >0.0
    AND p.Articulo NOT IN(@ArticuloRedondeo,@ArtOfertaFP,@ArtOfertaImporte )
    AND p.RenglonTipo <> 'K'
    AND o.Estatus = 'VIGENTE'
    AND o.Forma =  'Meses sin Intereses'
    AND od.Articulo = p.Articulo
    AND o.FechaD IS NULL AND o.FormaPago IS NOT NULL
	GROUP BY p.Renglon, p.Cantidad, p.Articulo, p.PrecioImpuestoInc, p.Precio , p.Cantidad ,p.CantidadObsequio, p.PrecioImpuestoInc, p.PrecioImpuestoInc, p.DescuentoLinea            
	DECLARE CrPOSInt CURSOR LOCAL FOR   
	SELECT Articulo
	FROM POSCobroCondicionTemp
	
	OPEN CrPOSInt  
    FETCH NEXT FROM CrPOSInt INTO @Articulo
    WHILE @@FETCH_STATUS <> -1  
		BEGIN  
			IF @@FETCH_STATUS <> -2   
				BEGIN
					INSERT INTO FormaPagoPos (
						ID, Articulo, FormaPago)
					SELECT 
						@ID, @Articulo, Oferta.FormaPago
					FROM Oferta
					LEFT OUTER JOIN OfertaD ON Oferta.ID = OfertaD.ID
					LEFT OUTER JOIN MovTipo ON MovTipo.Mov = Oferta.Mov AND MovTipo.Modulo = 'OFER' 
					WHERE Oferta.Estatus = 'VIGENTE' AND Oferta.Forma = 'Meses sin Intereses' AND Oferta.Mov ='Oferta Normal' 
			        AND OfertaD.Articulo = @Articulo AND Oferta.FechaD IS NULL AND Oferta.FormaPago IS NOT NULL     

					SELECT  @FormaPago = Oferta.FormaPago
					FROM Oferta
					LEFT OUTER JOIN OfertaD ON Oferta.ID = OfertaD.ID
					LEFT OUTER JOIN MovTipo ON MovTipo.Mov = Oferta.Mov AND MovTipo.Modulo = 'OFER' 
					WHERE Oferta.Estatus = 'VIGENTE' AND Oferta.Forma = 'Meses sin Intereses' AND Oferta.Mov ='Oferta Normal' 
					AND OfertaD.Articulo = @Articulo AND Oferta.FechaD IS NULL AND Oferta.FormaPago IS NOT NULL
			        			        
					IF @FormaPago IS NULL
						DELETE POSCobroCondicionTemp WHERE Estacion = @Estacion			  			
			    
					SELECT 
						@Categoria = Categoria, 
						@Grupo = Oferta.Grupo, 
						@Familia = Oferta.Familia, 
						@Linea = Oferta.Linea, 
						@Fabricante = Oferta.Fabricante, 
						@FormaPago = Oferta.FormaPago,  
						@FechaD = Oferta.FechaD, 
						@FechaA = Oferta.FechaA, 
						@HoraD = Oferta.HoraD, 
						@HoraA = Oferta.HoraA
					FROM Oferta
					LEFT OUTER JOIN OfertaD ON Oferta.ID = OfertaD.ID
					LEFT OUTER JOIN MovTipo ON MovTipo.Mov = Oferta.Mov AND MovTipo.Modulo = 'OFER'
					WHERE Oferta.Estatus = 'VIGENTE' AND Oferta.Forma = 'Meses sin Intereses' AND Oferta.Mov ='Oferta Grupal'
			   
					IF @Categoria IS NOT NULL
						BEGIN
							IF EXISTS (SELECT * FROM ART WHERE Categoria = @Categoria AND Articulo = @Articulo)
								BEGIN
									INSERT INTO FormaPagoPos (
										ID, Articulo, FormaPago)
									VALUES(
										@ID, @Articulo, @FormaPago)
								END
						END 
					
					IF @Grupo IS NOT NULL
						BEGIN
							IF EXISTS (SELECT * FROM ART WHERE Grupo = @Grupo AND Articulo = @Articulo)
								BEGIN
									INSERT INTO FormaPagoPos (
										ID, Articulo, FormaPago)
									VALUES(
										@ID, @Articulo, @FormaPago)
								END
						END
			   
					IF @Familia IS NOT NULL
						BEGIN
							IF EXISTS (SELECT * FROM ART WHERE Familia = @Familia AND Articulo = @Articulo)
								BEGIN
									INSERT INTO FormaPagoPos (
										ID, Articulo, FormaPago)
									VALUES(
										@ID, @Articulo, @FormaPago)
								END
						END
					
					IF @Linea IS NOT NULL
						BEGIN
							IF EXISTS (SELECT * FROM ART WHERE Linea = @Linea AND Articulo = @Articulo)
								BEGIN
									INSERT INTO FormaPagoPos (
										ID, Articulo, FormaPago)
									VALUES(
										@ID, @Articulo, @FormaPago)
								END
						END
			   
					IF @Fabricante IS NOT NULL
						BEGIN
							IF EXISTS (SELECT * FROM ART WHERE Fabricante = @Fabricante AND Articulo = @Articulo)
								BEGIN
									INSERT INTO FormaPagoPos (
										ID, Articulo, FormaPago)
									VALUES(
										@ID, @Articulo, @FormaPago)
								END
						END 
				END
			FETCH NEXT FROM CrPOSInt INTO @Articulo
		END	    
	CLOSE CrPOSInt 
	DEALLOCATE CrPOSInt
	  
	IF EXISTS (SELECT * FROM POSCobroCondicionTemp WHERE ID = @ID)  	
		SELECT  1
	ELSE
	    SELECT 0	
END
GO


/**************** sxActivarPOSArtSucursal    ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.sxActivarPOSArtSucursal') and type = 'P') DROP PROCEDURE dbo.sxActivarPOSArtSucursal
GO             
CREATE PROCEDURE sxActivarPOSArtSucursal
	@Activar bit
--//WITH ENCRYPTION
AS
BEGIN
	DECLARE
	@table_group_Art				varchar(20),
	@table_group_POSArtSucursal		varchar(20),
	@trigger_id						varchar(50),
	@router_id						varchar(50),
	@from							varchar(50),
	@to								varchar(50)
	
END
GO


/**************** spInsertarCxcAnticipoAplicarTemp  ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spInsertarCxcAnticipoAplicarTemp') AND type = 'P') DROP PROCEDURE dbo.spInsertarCxcAnticipoAplicarTemp
GO 
CREATE PROC spInsertarCxcAnticipoAplicarTemp
	@Empresa		varchar(5),
    @Cliente		varchar(10),
    @PedidoID		int,
    @Estacion		int
--//WITH ENCRYPTION  
AS
BEGIN
	DELETE CxcAnticipoPendienteTemp WHERE Estacion = @Estacion
  
	INSERT CxcAnticipoPendienteTemp(
		Estacion, ID, Empresa, Mov, MovID, FechaEmision, Referencia, Cliente, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, 
		Impuestos, Retencion, AnticipoAplicar) 
	SELECT
		@Estacion, ID, Empresa, Mov, MovID, FechaEmision,  Referencia, Cliente, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, 
		Impuestos, Retencion, AnticipoAplicar
    FROM Cxc
	WHERE Empresa = @Empresa
    AND Estatus IN ('PENDIENTE', 'CONCLUIDO') 
    AND AnticipoSaldo > 0.0
    AND Cliente = @Cliente
    AND PedidoReferenciaID = @PedidoID
     
	DELETE CxcAnticipoPendienteTemp2 WHERE Estacion = @Estacion

	INSERT CxcAnticipoPendienteTemp2(
		Estacion, ID, Empresa, Mov, MovID, FechaEmision, Referencia, Cliente, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, 
		Impuestos, Retencion, AnticipoAplicar) 
	SELECT
		@Estacion, ID, Empresa, Mov, MovID, FechaEmision,  Referencia, Cliente, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, 
		Impuestos, Retencion, AnticipoAplicar
    FROM Cxc
	WHERE Empresa = @Empresa
    AND Estatus IN ('PENDIENTE', 'CONCLUIDO') 
    AND AnticipoSaldo > 0.0
    AND Cliente = @Cliente
    AND PedidoReferenciaID IS NULL
END
GO  


/**************** spActualizarCxcAnticipoAplicar ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spActualizarCxcAnticipoAplicar') AND type = 'P') DROP PROCEDURE dbo.spActualizarCxcAnticipoAplicar
GO 
CREATE PROC spActualizarCxcAnticipoAplicar
	@Empresa    varchar(5),
    @Cliente    varchar(10),
    @PedidoID   int,
    @Estacion   int,
    @ID         int
--//WITH ENCRYPTION  
AS
BEGIN
	UPDATE Cxc SET AnticipoAplicaID = @ID ,AnticipoAplicaModulo = 'VTAS',AnticipoAplicar = a.AnticipoAplicar
    FROM CxcAnticipoPendienteTemp a JOIN Cxc c ON a.ID = c.ID  
	WHERE a.Estacion = @Estacion AND ISNULL(a.AnticipoAplicar,0.0) > 0.0
   
	UPDATE Cxc SET AnticipoAplicaID = @ID ,AnticipoAplicaModulo = 'VTAS',AnticipoAplicar = a.AnticipoAplicar
    FROM CxcAnticipoPendienteTemp2 a JOIN Cxc c ON a.ID = c.ID  
	WHERE a.Estacion = @Estacion AND ISNULL(a.AnticipoAplicar,0.0) > 0.0   
END
GO  
              
               
/************************ spPOSInsertarReferenciaPedido *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarReferenciaPedido') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarReferenciaPedido
GO             
CREATE PROCEDURE spPOSInsertarReferenciaPedido
	@Empresa           varchar(5), 
	@Sucursal          int, 
	@Usuario           varchar(10),
	@Estacion          int, 
	@ID                int,
	@IDPOS             varchar(36),
    @SaldoTotal        float = NULL
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE
    @PedidoReferencia		varchar(50),
    @Host                   varchar(20),
    @Caja                   varchar(10),
    @Orden                  int    
    
	SELECT @PedidoReferencia = Mov + ' '+ MovID 
	FROM POSVentaPedidoTemp 
	WHERE Estacion = @Estacion AND ID = @ID
	
	SELECT @Host = Host , @Caja = Caja 
	FROM POSL 
	WHERE ID = @IDPOS

	UPDATE POSL SET PedidoReferencia = @PedidoReferencia, PedidoReferenciaID = @ID, CXCSaldoTotal = @SaldoTotal
	WHERE ID = @IDPOS

	DELETE POSConceptoCXCTemp WHERE Estacion = @Estacion   
	INSERT POSConceptoCXCTemp(
		Estacion, Concepto)
	SELECT
		@Estacion, Concepto
    FROM Concepto
	WHERE Modulo = 'CXC'
       
	SELECT @Orden = 0
	UPDATE POSConceptoCXCTemp
    SET @Orden = Orden = @Orden + 1
    FROM POSConceptoCXCTemp
	WHERE Estacion = @Estacion    
  
	DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja   
  
	INSERT POSLAccion (
		Host,  Caja, Accion)
	VALUES (
		@Host, @Caja,'INTRODUCIR CONCEPTOCXC' )       
END
GO 
               
  
/************************ spPOSAccionReferenciaPedido *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAccionReferenciaPedido') AND type = 'P') DROP PROCEDURE dbo.spPOSAccionReferenciaPedido
GO             
CREATE PROCEDURE spPOSAccionReferenciaPedido
	@Empresa           varchar(5), 
	@Sucursal          int, 
	@Usuario           varchar(10),
	@Estacion          int, 
	@IDPOS             varchar(36)
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE
    @Host           varchar(20),
    @Caja           varchar(10),
    @MovClave		varchar(20)
    
    
	SELECT @Host = p.Host , @Caja = p.Caja,  @MovClave = mt.Clave 
    FROM POSL p JOIN MovTipo mt ON p.Mov = mt.Mov AND mt.Modulo = 'POS'
	WHERE p.ID = @IDPOS
 
	DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja   
  
	IF @MovClave = 'POS.FA'
		BEGIN
			INSERT POSLAccion (
				Host,  Caja, Accion)
			VALUES (
				@Host, @Caja,'REFERENCIAR PEDIDO')     
		END  

	IF @MovClave IN('POS.CXCC','POS.CXCD' )
		BEGIN
			INSERT POSLAccion (
				Host,  Caja, Accion)
			VALUES (
				@Host, @Caja,'REFERENCIAR COBRO' )     
		END  
END
GO   


/**************** spPOSInsertarCxcAnticipoAplicarTemp  ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSInsertarCxcAnticipoAplicarTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarCxcAnticipoAplicarTemp
GO 
CREATE PROC spPOSInsertarCxcAnticipoAplicarTemp
	@Estacion       int,
    @IDPOS          varchar(50)
--//WITH ENCRYPTION  
AS
BEGIN
	DECLARE 
    @ID         int,
    @Empresa    varchar(5)
    
	SELECT @ID = PedidoReferenciaID, @Empresa = Empresa 
	FROM POSL 
	WHERE ID = @IDPOS 

	DELETE CxcAnticipoPendienteTemp WHERE Estacion = @Estacion
  
	INSERT CxcAnticipoPendienteTemp(
		Estacion, ID, Empresa, Mov, MovID, FechaEmision, Referencia, Cliente, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, 
		Impuestos, Retencion, AnticipoAplicar) 
	SELECT
		@Estacion, ID, @Empresa, Mov, MovID, FechaEmision,  Referencia, Cliente, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, 
		Impuestos, Retencion, NULL
    FROM POSCxcAnticipoTemp
	WHERE Estacion = @Estacion
    AND PedidoReferenciaID = @ID
     
	DELETE CxcAnticipoPendienteTemp2 WHERE Estacion = @Estacion

	INSERT CxcAnticipoPendienteTemp2(
		Estacion,  ID, Empresa, Mov, MovID, FechaEmision, Referencia, Cliente, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, 
		Impuestos, Retencion, AnticipoAplicar) 
	SELECT
		@Estacion, ID, @Empresa, Mov, MovID, FechaEmision,  Referencia, Cliente, Concepto, AnticipoSaldo, Moneda, TipoCambio, Importe, 
		Impuestos, Retencion, NULL
    FROM POSCxcAnticipoTemp
	WHERE Estacion = @Estacion
    AND PedidoReferenciaID IS NULL
END
GO 


/**************** spPOSActualizarCxcAnticipoAplicar ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSActualizarCxcAnticipoAplicar') AND type = 'P') DROP PROCEDURE dbo.spPOSActualizarCxcAnticipoAplicar
GO 
CREATE PROC spPOSActualizarCxcAnticipoAplicar
	@Estacion       int,
    @IDPOS          varchar(50)
--//WITH ENCRYPTION  
AS
BEGIN
	UPDATE POSCxcAnticipoTemp SET AnticipoAplicar = a.AnticipoAplicar
    FROM CxcAnticipoPendienteTemp a JOIN POSCxcAnticipoTemp c ON a.ID = c.ID  AND a.Estacion = c.Estacion
	WHERE a.Estacion = @Estacion AND ISNULL(a.AnticipoAplicar,0.0) > 0.0
   
	UPDATE POSCxcAnticipoTemp SET AnticipoAplicar = a.AnticipoAplicar
    FROM CxcAnticipoPendienteTemp2 a JOIN POSCxcAnticipoTemp c ON a.ID = c.ID  AND a.Estacion = c.Estacion 
	WHERE a.Estacion = @Estacion AND ISNULL(a.AnticipoAplicar,0.0) > 0.0   
   
	EXEC spPOSAplicarAnticiposTipoServicio @Estacion, @IDPOS   
END
GO  


/**************** spPOSBorrarPOSFacturarNotasTemp ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSBorrarPOSFacturarNotasTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSBorrarPOSFacturarNotasTemp
GO 
CREATE PROC spPOSBorrarPOSFacturarNotasTemp
	@Estacion       int
--//WITH ENCRYPTION  
AS
BEGIN
	DELETE POSFacturarNotasTemp WHERE Estacion = @Estacion
  
	RETURN  
END
GO  


/**************** spPOSFacturarNotas ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSFacturarNotas') AND type = 'P') DROP PROCEDURE dbo.spPOSFacturarNotas
GO 
CREATE PROC spPOSFacturarNotas
	@Estacion       int,
    @IDPOS          varchar(50),
    @Empresa        varchar(20),
    @Sucursal       int,
    @Usuario        varchar(10),
    @MovFact        varchar(20),  
    @Cliente        varchar(10),                                
    @Ok             int   = NULL         OUTPUT,
    @OkRef          varchar(255)  = NULL OUTPUT
--//WITH ENCRYPTION  
AS
BEGIN
	DECLARE 
    @IDDev							varchar(50),
    @IDFact							varchar(50),
    @MovCFD							varchar(20),
    @MovDev							varchar(20),
    @IDNuevo						int,
    @CodigoRedondeo					varchar(20),
    @ArticuloRedondeo				varchar(20),
    @UUID							varchar(50),
    @FechaTimbrado					datetime,
    @MovIDCFD						varchar(20),
    @SelloSat						varchar(255),
    @TFDVersion						varchar(10),
    @NoCertificadoSAT				varchar(20),
    @TFDCadenaOriginal				varchar(max),
    @CadenaOriginal					varchar(max),
    @Sello							varchar(255),
    @Certificado					varchar(20),
    @DocumentoXML					varchar(max), 
    @FechaSello						datetime,
    @Fecha 							datetime,
    @ArticuloTarjeta				varchar(20),
    @AlmacenTarjeta					varchar(20),
    @Prefijo						varchar(5),
    @Consecutivo					int,
    @noAprobacion					int,
    @fechaAprobacion				datetime,  
    @MovIDFact						varchar(20),
    @MovIDDev						varchar(20), 
    @VentaPreciosImpuestoIncluido	bit,
    @Host							varchar(20),
    @Cluster						varchar(20),
    @ContMoneda						varchar(10),
    @ContMonedaTC					float,
    @Expresion						varchar(255),
    @ArticuloTarjetaServico			varchar(20),
    @RenglonIDMonederoDev			int,   
    @RenglonIDMonederoFac			int,
    @Aplica							varchar(20),   
    @APlicaID						varchar(20),
    @SugerirFechaCierre				bit,
    @FechaCierre					datetime,
    @Caja							varchar(10)
    
    
	SELECT @Caja = Caja 
	FROM POSL 
	WHERE ID = @IDPOS
	
	SELECT @MovCFD = MovFactura, @CodigoRedondeo = RedondeoVentaCodigo 
	FROM POSCfg 
	WHERE Empresa = @Empresa    
	
	SELECT @ArticuloRedondeo = Cuenta 
	FROM CB 
	WHERE Codigo = @CodigoRedondeo    AND TipoCuenta = 'Articulos' 
	
	SELECT 
		@VentaPreciosImpuestoIncluido = ISNULL(VentaPreciosImpuestoIncluido,0), 
		@ArticuloTarjeta = CxcArticuloTarjetasDef,
		@AlmacenTarjeta = CxcAlmacenTarjetasDef,
		@ArticuloTarjetaServico = ArtTarjetaServicio 
	FROM EmpresaCfg 
	WHERE Empresa = @Empresa  
	
	SELECT @SugerirFechaCierre = SugerirFechaCierre   
	FROM POSCfg 
	WHERE Empresa = @Empresa
  
	SELECT @FechaCierre = Fecha 
	FROM POSFechaCierre 
	WHERE Sucursal = @Sucursal
  
	SELECT @FechaCierre = dbo.fnPOSFechaCierre(@Empresa,@Sucursal,@FechaCierre,@Caja)
   
	SELECT @Fecha = CASE WHEN @SugerirFechaCierre = 1 
							THEN @FechaCierre 
						 ELSE dbo.fnFechaSinHora(GETDATE())
						 END      

	SELECT @IDDev = NEWID()
	SELECT @IDFact = NEWID()
  
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
    
	SELECT @ContMoneda = ec.ContMoneda
    FROM EmpresaCfg ec	  
	WHERE ec.Empresa = @Empresa   
   
	SELECT @ContMonedaTC = TipoCambio 
	FROM POSLTipoCambioRef 
	WHERE Sucursal = @Sucursal AND Moneda = @ContMoneda    
  
	BEGIN TRANSACTION
	IF @Ok IS  NULL
		BEGIN
			INSERT POSL (
				ID, Empresa, Mov, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Importe, Impuestos, Usuario, Referencia, 
				Estatus, Observaciones, Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Causa, Atencion,
				AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, Origen, OrigenID, Host, Cluster, Nombre, Direccion, DireccionNumero,
				DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, Estado, Pais, Zona, CodigoPostal, RFC, CURP, Modulo, Cajero, CtaDineroDestino, 
				Directo, Caja, PedidoReferencia, PedidoReferenciaID, IDR, FechaNacimiento, EstadoCivil, Conyuge, Sexo, Fuma, Profesion, Puesto, NumeroHijos, Religion)
			SELECT
				@IDDev, Empresa, Mov, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, (Importe*-1), (Impuestos*-1), @Usuario, Referencia,
				Estatus, Observaciones, Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Causa, Atencion,
				AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, @Sucursal, OrigenTipo, NULL, NULL, @Host, @Cluster, Nombre, Direccion, DireccionNumero,
				DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, Estado, Pais, Zona, CodigoPostal, RFC, CURP, Modulo, Cajero, CtaDineroDestino, 
				Directo, Caja, PedidoReferencia, PedidoReferenciaID, @IDPOS, FechaNacimiento, EstadoCivil, Conyuge, Sexo, Fuma, Profesion, Puesto, NumeroHijos, Religion
			FROM POSL
			WHERE ID = @IDPOS 
    
			IF @@ERROR <> 0 
				SET @Ok = 1
    
			IF @Ok IS NULL
				INSERT POSLVenta(
					ID, Renglon, RenglonID, Aplica, AplicaID, RenglonTipo, Cantidad, CantidadObsequio, Articulo, SubCuenta, Precio, PrecioSugerido, 
					DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor,  Puntos,PrecioImpuestoInc, Almacen, Codigo, EsMonedero)
				SELECT
					@IDDev, Renglon, RenglonID, NULL, NULL, RenglonTipo, (Cantidad*-1), (CantidadObsequio*-1), Articulo, SubCuenta, Precio, PrecioSugerido, 
					DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor,  Puntos,PrecioImpuestoInc, Almacen, Codigo, EsMonedero
				FROM POSLVenta 
				WHERE ID = @IDPOS  
    
			IF @@ERROR <> 0 
					SET @Ok = 1  
    
			IF EXISTS(SELECT * FROM POSLSerieLote WHERE ID = @IDPOS)
				BEGIN
					INSERT POSLSerieLote(
						ID, RenglonID, Articulo, SubCuenta, SerieLote)
					SELECT
						@IDDev, RenglonID, Articulo, ISNULL(SubCuenta,''), SerieLote
					FROM POSLSerieLote 
					WHERE ID = @IDPOS
					ORDER BY Orden     
				END      
    
			IF EXISTS(SELECT * FROM POSLCobro WHERE ID = @IDPOS)
				BEGIN    
					INSERT POSLCobro(
						ID, FormaPago, Importe, Referencia, Monedero, CtaDinero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio, 
						Voucher, Banco, MonedaRef, CtaDineroDestino)
					SELECT
						@IDDev, FormaPago, (Importe*-1), Referencia, Monedero, CtaDinero, Fecha,  Caja,  Cajero, Host, (ImporteRef*-1), TipoCambio, 
						Voucher, Banco, MonedaRef, CtaDineroDestino
					FROM POSLCobro 
					WHERE ID = @IDPOS              
				END  
    
			IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @IDDev AND ISNULL(EsMonedero,0) = 1)
				BEGIN
					SELECT @RenglonIDMonederoDev = RenglonID 
					FROM POSLVenta  
					WHERE  ID = @IDDev AND ISNULL(EsMonedero,0) = 1
					
					UPDATE POSLVenta SET Articulo = @ArticuloTarjetaServico, RenglonTipo = 'N'
					WHERE  ID = @IDDev AND ISNULL(EsMonedero,0) = 1
       
					DELETE POSLSerieLote WHERE ID = @IDDev AND RenglonID = @RenglonIDMonederoDev
				END
    
			SELECT @MovDev = Mov FROM POSL WHERE ID = @IDDev
    
			IF @Ok IS NULL
				BEGIN
					EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @MovDev, @MovIDDev OUTPUT, @Prefijo OUTPUT, 
						@Consecutivo OUTPUT, @noAprobacion OUTPUT, @FechaAprobacion OUTPUT, @Ok OUTPUT, @OkRef OUTPUT

					UPDATE 
						POSL SET MovID =  @MovIDDev,
						Prefijo = ISNULL(Prefijo, @Prefijo),
						Consecutivo = ISNULL(Consecutivo, @Consecutivo),
						noAprobacion = ISNULL(noAprobacion, @NoAprobacion),
						fechaAprobacion = ISNULL(fechaAprobacion, @fechaAprobacion),
						Estatus = 'CONCLUIDO',
						FechaEmision = dbo.fnFechaSinHora(@Fecha),
						FechaRegistro = @Fecha
					WHERE ID = @IDDev 
				END            
		END  
  
	IF @MovFact IS NOT NULL AND @Ok IS NULL
		BEGIN  
			INSERT POSL (
				ID, Empresa, Mov, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, Importe, Impuestos, TipoCambio, Usuario, Referencia, Estatus,
				Observaciones, Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Causa, Atencion,
				AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, Origen, OrigenID, Host, Cluster, Nombre, Direccion, DireccionNumero,
				DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, Estado, Pais, Zona, CodigoPostal, RFC, CURP,Modulo, Cajero, CtaDineroDestino, 
				Directo, Caja, PedidoReferencia, PedidoReferenciaID, IDR, FechaNacimiento, EstadoCivil, Conyuge, Sexo, Fuma, Profesion, Puesto, NumeroHijos, Religion)
			SELECT
				@IDFact, Empresa, @MovFact, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, Importe, Impuestos, TipoCambio, @Usuario, Referencia, Estatus,
				Observaciones, @Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Causa, Atencion,
				AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, @Sucursal, OrigenTipo, NULL, NULL, @Host, @Cluster, Nombre, Direccion, DireccionNumero,
				DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, Estado, Pais, Zona, CodigoPostal, RFC, CURP, Modulo, Cajero, CtaDineroDestino, 
				Directo, Caja, PedidoReferencia, PedidoReferenciaID, @IDPOS, FechaNacimiento, EstadoCivil, Conyuge, Sexo, Fuma, Profesion, Puesto, NumeroHijos, Religion
			FROM POSL
			WHERE ID = @IDPOS 
			
			IF @@ERROR <> 0 
				SET @Ok = 1
    
			IF @Ok IS NULL
				INSERT POSLVenta(
					ID, Renglon, RenglonID, Aplica, AplicaID, RenglonTipo, Cantidad, CantidadObsequio, Articulo, SubCuenta, Precio, PrecioSugerido, DescuentoLinea,
					Impuesto1, Impuesto2, Impuesto3, Unidad, Factor,  Puntos,PrecioImpuestoInc, Almacen, Codigo, EsMonedero)
				SELECT
					@IDFact, Renglon, RenglonID, NULL  , NULL,     RenglonTipo, Cantidad, CantidadObsequio, Articulo, SubCuenta, Precio, PrecioSugerido, DescuentoLinea,
					Impuesto1, Impuesto2, Impuesto3, Unidad, Factor,  Puntos,PrecioImpuestoInc, Almacen, Codigo, EsMonedero
				FROM POSLVenta 
				WHERE ID = @IDPOS  
			
			IF @@ERROR <> 0 
				SET @Ok = 1  
    
			IF EXISTS(SELECT * FROM POSLSerieLote WHERE ID = @IDPOS)
				BEGIN
					INSERT POSLSerieLote(
						ID, RenglonID, Articulo, SubCuenta, SerieLote)
					SELECT
						@IDFact, RenglonID, Articulo, ISNULL(SubCuenta,''), SerieLote
					FROM POSLSerieLote 
					WHERE ID = @IDPOS
					ORDER BY Orden     
				END      
    
			IF EXISTS(SELECT * FROM POSLCobro WHERE ID = @IDPOS)
				BEGIN    
					INSERT POSLCobro(
						ID, FormaPago, Importe, Referencia, Monedero, CtaDinero, Fecha,  Caja,  Cajero, Host, ImporteRef, 
						TipoCambio, Voucher, Banco, MonedaRef, CtaDineroDestino)
					SELECT
						@IDFact, FormaPago, Importe, Referencia, Monedero, CtaDinero, Fecha,  Caja,  Cajero, Host, ImporteRef, 
						TipoCambio, Voucher, Banco, MonedaRef, CtaDineroDestino
					FROM POSLCobro 
					WHERE ID = @IDPOS      
				END     
    
			IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @IDFact AND ISNULL(EsMonedero,0) = 1)
				BEGIN
					SELECT @RenglonIDMonederoFac = RenglonID 
					FROM POSLVenta  
					WHERE  ID = @IDFact AND ISNULL(EsMonedero,0) = 1
					
					UPDATE POSLVenta SET Articulo = @ArticuloTarjetaServico, RenglonTipo = 'N'
					WHERE  ID = @IDFact AND ISNULL(EsMonedero,0) = 1
       
					DELETE POSLSerieLote WHERE ID = @IDFact AND RenglonID = @RenglonIDMonederoFac
				END    
    
			IF @Ok IS NULL
				EXEC spPOS @Estacion, NULL, @Empresa, 'VTAS', @Sucursal, @Usuario,  NULL, @IDFact, NULL, NULL, NULL, 0, NULL, @Cliente, @EnSilencio = 1
      
			IF @Ok IS NULL
				BEGIN
					EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @MovFact, @MovIDFact OUTPUT, @Prefijo OUTPUT, @Consecutivo OUTPUT, 
						@noAprobacion OUTPUT, @FechaAprobacion OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
                    
					UPDATE 
						POSL SET MovID =  @MovIDFact,
 						Prefijo = ISNULL(Prefijo, @Prefijo),
 						Consecutivo = ISNULL(Consecutivo, @Consecutivo),
 						noAprobacion = ISNULL(noAprobacion, @NoAprobacion),
 						fechaAprobacion = ISNULL(fechaAprobacion, @fechaAprobacion),
 						Estatus = 'CONCLUIDO',
 						FechaEmision = dbo.fnFechaSinHora(@Fecha),
 						FechaRegistro = @Fecha
					WHERE ID = @IDFact 
				END                   
		END 
  
	IF NULLIF(@MovCFD,'') IS NOT NULL AND @Ok IS NULL
		BEGIN
			INSERT Venta (
				Empresa, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, 
				TipoCambio, Usuario, Referencia, Estatus, Observaciones, Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, 
				CtaDinero, Descuento, DescuentoGlobal, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, Origen, OrigenID, 
				ReferenciaOrdenCompra, GenerarDinero, SucursalOrigen)
			SELECT
				p.Empresa, @MovCFD, NULL, p.FechaEmision, p.FechaRegistro, p.Concepto, p.Proyecto, p.UEN, p.Moneda, 
				CASE WHEN p.Moneda <> @ContMoneda 
						THEN  (p.TipoCambio/@ContMonedaTC) 
					 ELSE p.TipoCambio 
					 END, p.Usuario, p.Referencia, 'SINAFECTAR', p.Observaciones, p.Cliente, p.EnviarA, p.Almacen, p.Agente, p.FormaEnvio, p.Condicion, p.Vencimiento,
				p.CtaDinero, p.Descuento, 0.0, p.Causa, p.Atencion, p.AtencionTelefono, p.ListaPreciosEsp, p.ZonaImpuesto, p.Sucursal, 'POS', p.Mov, p.MovID, 
				@IDFact, 0, p.Sucursal
			FROM POSL p
			WHERE p.ID = @IDFact  		      
			
			IF @@ERROR <> 0 
				SET @Ok = 1
    
			SELECT @IDNuevo = SCOPE_IDENTITY()
            
			INSERT VentaD (
				ID, Renglon, RenglonID, Aplica, AplicaID, RenglonTipo, Cantidad, CantidadObsequio, 
				Almacen, EnviarA, Articulo, SubCuenta, Precio, DescuentoLinea, Impuesto1, 
				Impuesto2, Impuesto3, Unidad, Factor, Sucursal, Puntos, POSDesGlobal, POSDesLinea, Codigo)
			SELECT
				@IDNuevo, pmv.Renglon, pmv.RenglonID, pmv.Aplica, pmv.AplicaID, pmv.RenglonTipo, pmv.Cantidad, pmv.CantidadObsequio,
				CASE WHEN pmv.Articulo= @ArticuloTarjeta 
						THEN ISNULL(p.Almacen,@AlmacenTarjeta) 
					 ELSE ISNULL(pmv.Almacen,p.Almacen) 
					 END, p.EnviarA, pmv.Articulo, pmv.SubCuenta, CASE WHEN @VentaPreciosImpuestoIncluido = 1 
																		   THEN pmv.PrecioImpuestoInc 
																	   ELSE pmv.Precio 
																	   END, dbo.fnPOSCalcDescuentosVenta(CASE WHEN ISNULL(pmv.AplicaDescGlobal, 1) = 1 
																												 THEN ISNULL(p.DescuentoGlobal,0.0) 
																											  ELSE 0 
																											  END,pmv.DescuentoLinea), pmv.Impuesto1, 
					pmv.Impuesto2, pmv.Impuesto3, pmv.Unidad, 1, @Sucursal, pmv.Puntos, CASE WHEN ISNULL(pmv.AplicaDescGlobal, 1) = 1 
																								THEN ISNULL(p.DescuentoGlobal,0.0) 
																							 ELSE 0 
																							 END, ISNULL(pmv.DescuentoLinea,0.0), pmv.Codigo
			FROM POSLVenta pmv JOIN POSL p ON pmv.ID = p.ID
			WHERE pmv.ID = @IDFact
    
			IF @@ERROR <> 0 
				SET @Ok = 1   
		
		    --AQUI SE INSERTA A POSVENTACOBRO
			EXEC spPOSInsertarPOSVentaCobro @IDFact, @Empresa,@Sucursal, @Ok OUTPUT, @OkRef OUTPUT     
    
			IF EXISTS(SELECT 1 FROM POSLSerieLote pls WHERE pls.ID = @IDFact)
				INSERT SerieLoteMov (Empresa,  Modulo, ID,       RenglonID,     Articulo,     SubCuenta,                 SerieLote,     Cantidad,  Sucursal)
				SELECT               @Empresa, 'VTAS', @IDNuevo, pls.RenglonID, pls.Articulo, ISNULL(pls.SubCuenta, ''), pls.SerieLote, COUNT(*),  @Sucursal  
				FROM POSLSerieLote pls
				WHERE pls.ID = @IDFact
				GROUP BY Articulo, ISNULL(SubCuenta,''), SerieLote, RenglonID       
    
			IF @Ok IS NULL AND @IDNuevo IS NOT NULL
				EXEC spAfectar 'VTAS', @IDNuevo, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @ok OUTPUT, @OkRef = @OkRef OUTPUT
   
			IF @Ok IS NULL AND EXISTS(SELECT * FROM CFD WHERE Modulo = 'VTAS' AND ModuloID = @IDNuevo)
				BEGIN
					SELECT 
						@CadenaOriginal = cfd.CadenaOriginal, 
						@Certificado = cfd.noCertificado, 
						@Sello = cfd.Sello, 
						@DocumentoXML = cfd.Documento, 
						@MovIDCFD = cfd.MovID, 
						@UUID = cfd.UUID , 
						@FechaTimbrado = cfd.FechaTimbrado, 
						@SelloSat =  cfd.SelloSat, 
						@TFDVersion = cfd.TFDVersion  , 
						@NoCertificadoSAT = cfd.NoCertificadoSAT, 
						@TFDCadenaOriginal = cfd.TFDCadenaOriginal	     
					FROM CFD cfd
					WHERE cfd.Modulo = 'VTAS' AND cfd.ModuloID = @IDNuevo
       
					IF @Ok IS NULL
						UPDATE POSL 
						SET CadenaOriginal = @CadenaOriginal, 
							Sello = @Sello, 
							Certificado = @Certificado, 
							DocumentoXML = @DocumentoXML, 
							FechaSello = @FechaSello, 
							Origen = @MovCFD, 
							OrigenID = @MovIDCFD, 
							UUID = @UUID, 
							FechaTimbrado =  @FechaTimbrado, 
							SelloSat = @SelloSat, 
							TFDVersion = @TFDVersion, 
							NoCertificadoSAT = @NoCertificadoSAT, 
							TFDCadenaOriginal = @TFDCadenaOriginal
						WHERE ID = @IDFact         
				END

		END
  
	IF @Ok IS NULL
		UPDATE POSL SET Facturado = 1 WHERE ID = @IDPOS
    
	IF @Ok IS NULL
		BEGIN
			COMMIT TRANSACTION
			
			SELECT @Expresion = 'FormaModal('+CHAR(39)+'POSFacturarNotas'+CHAR(39)+')'   
			SELECT @OkRef = ' Se Genero '+@MovFact+' '+@MovIDFact    
		END 
	ELSE
		BEGIN
			ROLLBACK TRANSACTION

			SELECT @OkRef = Descripcion+' '+RTRIM(ISNULL(@OkRef,'')) 
			FROM MensajeLista
			WHERE Mensaje = @Ok  
			
			SELECT @Expresion= 'ERROR('+CHAR(39)+@OkRef+CHAR(39)+')'  
		END
  
	SELECT @OkRef,@Expresion, @IDFact, @IDNuevo,@MovCFD, @MovIDCFD
  
	RETURN 
END
GO  


/************************ spPOSInsertarReferenciaCobro *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarReferenciaCobro') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarReferenciaCobro
GO             
CREATE PROCEDURE spPOSInsertarReferenciaCobro
	@Empresa           varchar(5), 
	@Sucursal          int, 
	@Usuario           varchar(10),
	@Estacion          int, 
	@ID                int,
	@IDPOS             varchar(36)
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE
    @Aplica             varchar(20),
    @AplicaID           varchar(20),
    @Host               varchar(20),
    @Caja               varchar(10),
    @Orden              int,
    @CXCSaldoTotal      float,
    @Moratorios			float,
    @TasaMoratorios		float,
    @Renglon			float,
    @DiasMoratorios		int

	SELECT @TasaMoratorios = ISNULL(CxcMoratoriosTasa,0)/100 
	FROM EmpresaCfg 
	WHERE Empresa = @Empresa  
      
	SELECT @Host = Host , @Caja = Caja 
	FROM POSL 
	WHERE ID = @IDPOS
  
	IF EXISTS (SELECT * FROM POSLVenta WHERE ID = @IDPOS)
		DELETE POSLVenta WHERE ID = @IDPOS
               
	DECLARE crFormaPago CURSOR LOCAL FOR
    SELECT c.Mov , c.MovID, d.Importe, ROUND(ABS(ISNULL(c.SaldoInteresesMoratorios,0)- (d.InteresesMoratorios)),4), c.DiasMoratorios 
    FROM POSCxcAnticipoTemp c JOIN POSCxcAnticipoTempD d on c.Estacion = d.Estacion AND c.Mov = d.Aplica AND c.MovID = d.AplicaID
    SET @Renglon = 2048.0   
    
	OPEN crFormaPago   
    FETCH NEXT FROM crFormaPago INTO @Aplica, @AplicaID, @CXCSaldoTotal, @Moratorios, @DiasMoratorios
    WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @@FETCH_STATUS <> -2
				BEGIN
					INSERT POSLVenta(
						ID, Renglon, RenglonID, RenglonTipo, Articulo, Cantidad, Aplica, AplicaID, Precio)
					SELECT 
						@IDPOS, @Renglon, 1, 'K', 'COBRO', 1, @Aplica, @AplicaID, @CXCSaldoTotal

					SET @Renglon = @Renglon + 2048.0	
		
					IF @Moratorios > 0
						BEGIN
							INSERT POSLVenta(
								ID, Renglon, RenglonID, RenglonTipo, Articulo, Cantidad, Aplica, AplicaID, Precio, DiasMoratorios, TasaMoratorios)
							SELECT
								@IDPOS, @Renglon, 1, 'K', 'MORATORIO', 1, @Aplica, @AplicaID, @Moratorios, @DiasMoratorios, @TasaMoratorios 
						END

					SET @Renglon = @Renglon + 2048.0					  
				END
      
			FETCH NEXT FROM crFormaPago INTO @Aplica, @AplicaID, @CXCSaldoTotal, @Moratorios, @DiasMoratorios
		END
    CLOSE crFormaPago
    DEALLOCATE crFormaPago
          
	UPDATE POSL SET CXCSaldoTotal = (SELECT SUM(d.Importe+d.Importe*c.DiasMoratorios*@TasaMoratorios) 
    FROM POSCxcAnticipoTemp c JOIN POSCxcAnticipoTempD d on c.Estacion = d.Estacion AND c.Mov = d.Aplica AND c.MovID = d.AplicaID)
    WHERE ID = @IDPOS
	  
	INSERT POSLAccion (
		Host,  Caja, Accion)
	VALUES (
		@Host, @Caja,'IMPORTE ANTICIPO')       
END
GO 


/************************ spPOSInsertarReferenciaDevolucion *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarReferenciaDevolucion') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarReferenciaDevolucion
GO             
CREATE PROCEDURE spPOSInsertarReferenciaDevolucion
	@Empresa           varchar(5), 
	@Sucursal          int, 
	@Usuario           varchar(10),
	@Estacion          int, 
	@ID                int,
	@IDPOS             varchar(36)
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE
    @Aplica             varchar(20),
    @AplicaID           varchar(20),
    @Host               varchar(20),
    @Caja               varchar(10),
    @Orden              int,
    @CXCSaldoTotal		float,
    @CXCSaldo           float
    
    
	SELECT @Aplica = Mov , @AplicaID  = MovID, @CXCSaldoTotal = ImporteTotal, @CXCSaldo = ImporteTotal 
	FROM POSCxcAnticipoTemp 
	WHERE Estacion = @Estacion AND ID = @ID
  
	SELECT @Host = Host , @Caja = Caja 
	FROM POSL 
	WHERE ID = @IDPOS
  
	IF EXISTS (SELECT * FROM POSLVenta WHERE ID = @IDPOS)
		DELETE POSLVenta WHERE ID = @IDPOS
    
	INSERT POSLVenta(
		ID, Renglon, RenglonID, RenglonTipo, Articulo, Cantidad, Aplica, AplicaID, Precio, PrecioImpuestoInc)
	SELECT
		@IDPOS, 2048.0, 1, 'K', 'DEVOLUCION', 1, @Aplica, @AplicaID, -@CXCSaldo, -@CXCSaldo
  
	UPDATE POSL SET CXCSaldoTotal = @CXCSaldoTotal WHERE ID = @IDPOS  
END
GO 


/************************ spPOSInsertarImporteCobroCredito  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarImporteCobroCredito') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarImporteCobroCredito
GO             
CREATE PROCEDURE spPOSInsertarImporteCobroCredito
	@Estacion           int,
    @ID                 varchar(36),
    @Codigo             varchar(50),
    @Ok                 int  OUTPUT,
    @OkRef              varchar(255) OUTPUT            
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE
	@ConceptoCxc       varchar(50),
	@ImpuestosPorc     float,
	@Impuestos         float,
	@ImporteSImp       float,
	@Importe           float
      
	SELECT @Importe = CONVERT(float,@Codigo)  
   
	UPDATE POSLVenta SET Precio = ISNULL(@Importe,0.0), PrecioImpuestoInc = ISNULL(@Importe,0.0)
    WHERE ID = @ID  AND Renglon = 2048.0

    UPDATE POSL SET Importe = ISNULL(@Importe,0.0)
    WHERE ID = @ID       
END
GO 


/************************ spPOSEliminarMov *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSEliminarMov') AND type = 'P') DROP PROCEDURE dbo.spPOSEliminarMov
GO             
CREATE PROCEDURE spPOSEliminarMov
	@IDPOS		varchar(36)
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE
    @Host       varchar(20),
    @Caja		varchar(10)
        
	SELECT @Host = p.Host , @Caja = p.Caja 
    FROM POSL p 
	WHERE p.ID = @IDPOS
 
	DELETE FROM POSLAccion WHERE Host = @Host AND Caja = @Caja      
END
GO  


/************************ spPOSBorrarVentaRefacturarTemp *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSBorrarVentaRefacturarTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSBorrarVentaRefacturarTemp
GO             
CREATE PROCEDURE spPOSBorrarVentaRefacturarTemp
	@Estacion		int
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DELETE VentaRefacturarTemp WHERE  Estacion = @Estacion  
END
GO 


/**************** spVentasRefacturarNotas ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spVentasRefacturarNotas') AND type = 'P') DROP PROCEDURE dbo.spVentasRefacturarNotas
GO              
CREATE PROCEDURE spVentasRefacturarNotas
	@Empresa                varchar(5),       
    @Sucursal               int,
    @Estacion               int,
    @Usuario                varchar(10),
    @ClienteFact            varchar(10),
    @FacturaMostrador       varchar(20),
    @Ok                     int	=   NULL		OUTPUT,
    @OkRef                  varchar(255)= NULL	OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Moneda							varchar(10),
    @Cliente						varchar(10),
    @TipoCambio						float,  
    @Almacen						varchar(10),
    @NotaMov						varchar(20),
    @AlmacenD						varchar(10),
    @Fecha							datetime,
    @Condicion						varchar(50), 
    @Concepto						varchar(50),
    @Agente							varchar(10), 
    @UEN							int,
    @DevolucionID					int,
    @NotaID							int,
    @Renglon						float, 
    @RenglonID						int,
    @RenglonTipo					varchar(1),
    @Posicion						varchar(10),
    @ArtTipo						varchar(20),
    @Articulo						varchar(20),
    @SubCuenta						varchar(50),
    @Unidad							varchar(50),
    @Factor							float,
    @Cantidad						float,
    @CantidadInventario				float,
    @Disponible						float,
    @MonedaCosto					varchar(10),
    @Costo							float,
    @Precio        					float,
    @PrecioNeto        				float,
    @Proveedor						varchar(10),
    @DescuentoTipo					varchar(1),
    @DescuentoLinea					float,
    @DescuentoGlobal				float,
    @SobrePrecio					float,
    @Impuesto1						float,
    @Impuesto2						float,
    @Impuesto3						money,
    @CfgCosteoSeries				bit,
    @CfgCosteoLotes					bit,
    @TipoCosteo						varchar(20),
    @VentaMultiAlmacen				bit,
    @PrecioMonedaD					varchar(10),
    @PrecioTipoCambioD				float,   
    @CantidadObsequio				float,
    @OfertaID						int,
    @PrecioSugerido					float,
    @DescuentoImporte				money,
    @Puntos							float,
    @Comision						float,
    @CantidadAjusteLote				float ,    
    @ArtCostoIdentificado			bit,
    @SeriesLotesAutoOrden			varchar(20), 
    @CfgCosteoNivelSubCuenta		bit,
    @FacturaID						int,
    @IDFactura						int,    
    @CuantasFacturas				int,
    @FacturaMovID					varchar(20),
    @Cuantas						int,
    @ArtTarjetaServicio				varchar(20)
    
	DECLARE @Devolucion table(
		ID  int)  
	
	DECLARE @Nota table(
		ID        int)  
	
	DECLARE @Factura table(
		ID        int) 
	
	DECLARE @Tarjeta  table(
		Renglon		float,
		RenglonID	int, 
		Articulo	varchar(20)) 

	BEGIN TRANSACTION  
  
	SELECT @VentaMultiAlmacen = VentaMultiAlmacen
    FROM EmpresaCfg2
	WHERE Empresa = @Empresa    
   
	SELECT @ArtTarjetaServicio = NULLIF(ArtTarjetaServicio,'') 
	FROM EmpresaCfg 
	WHERE Empresa = @Empresa 

	SELECT @Fecha = dbo.fnFechaSinHora(GETDATE())   
  
	IF NULLIF(@ClienteFact,'') IS NULL
		SELECT @Ok = 10040 
    
	IF NULLIF(@FacturaMostrador,'') IS NULL
		SELECT @Ok = 10160 
 
	SELECT  @NotaMov = VentaNota 
	FROM EmpresaCfgMov 
	WHERE Empresa = @Empresa 
  
	DELETE VentaRefacturarTemp WHERE Estacion = @Estacion AND NULLIF(MovID,'') IS NULL
	SELECT 
		@CfgCosteoNivelSubCuenta = CosteoNivelSubCuenta,
        @TipoCosteo		  = ISNULL(NULLIF(RTRIM(UPPER(TipoCosteo)), ''), 'PROMEDIO'),
        @CfgCosteoSeries	  =1,-- ISNULL(CosteoSeries, 0),
        @CfgCosteoLotes	  = ISNULL(CosteoLotes, 0),
        @SeriesLotesAutoOrden    = UPPER(SeriesLotesAutoOrden)
    FROM EmpresaCfg
	WHERE Empresa = @Empresa  
  
	IF NOT EXISTS (SELECT * FROM VentaRefacturarTemp WHERE Estacion = @Estacion AND ID IS NOT NULL)
		SELECT @Ok = 60010

	IF @Ok IS NULL
		BEGIN 
			DECLARE crEncabezadoDev CURSOR LOCAL FOR
			SELECT  Moneda,  TipoCambio,  Almacen, Condicion, Concepto, Agente, UEN, Cliente
			FROM  Venta
			WHERE ID IN(SELECT ID FROM VentaRefacturarTemp WHERE Estacion = @Estacion)
			GROUP BY  Moneda,  TipoCambio,  Almacen, Condicion, Concepto, Agente, UEN, Cliente
    
			OPEN crEncabezadoDev
			FETCH NEXT FROM crEncabezadoDev INTO @Moneda,  @TipoCambio,  @Almacen, @Condicion, @Concepto,@Agente, @UEN, @Cliente
			WHILE @@FETCH_STATUS = 0  AND @Ok IS NULL
				BEGIN
					SET @DevolucionID = NULL
					
					INSERT Venta (
						Sucursal, SucursalOrigen, Empresa, Mov, FechaEmision, Moneda, TipoCambio, Almacen, Cliente, Condicion, Concepto, Usuario, Estatus,
						OrigenTipo, Agente, UEN, FormaPagoTipo)
					SELECT
						@Sucursal, @Sucursal, @Empresa, @NotaMov, @Fecha, @Moneda, @TipoCambio, @Almacen, @Cliente, @Condicion, @Concepto, @Usuario, 'SINAFECTAR',
						'VMOS', @Agente, @UEN, 'Varios'
      
					SELECT @DevolucionID = SCOPE_IDENTITY()       
					SELECT @Renglon = 0, @RenglonID = 0  
      
					INSERT   @Devolucion 
					SELECT   @DevolucionID
   
					DECLARE crDevDetalle CURSOR LOCAL  FOR
					SELECT d.Almacen, d.Posicion, d.Articulo, d.SubCuenta, d.RenglonTipo, d.Unidad, ISNULL(ROUND(d.Impuesto1, 4),0.0), ISNULL(ROUND(d.Impuesto2, 4),0.0),
					ISNULL(ROUND(d.Impuesto3, 4),0.0), SUM(d.Cantidad*-1), SUM(d.CantidadInventario*-1), ISNULL(d.DescuentoTipo,''), ISNULL(d.DescuentoLinea,0.0), 
					ISNULL(d.Precio,0.0), ISNULL(v.DescuentoGlobal,0.0), ISNULL(v.SobrePrecio,0.0), a.MonedaCosto, a.Tipo, a.CostoIdentificado, d.PrecioMoneda,
					d.PrecioTipoCambio, d.CantidadObsequio, d.OfertaID, d.PrecioSugerido, d.DescuentoImporte, d.Puntos, d.Comision
					FROM Venta v JOIN VentaD d ON v.ID = d.ID 
					JOIN Art a ON d.Articulo = a.Articulo
					WHERE v.ID IN (SELECT ID FROM VentaRefacturarTemp WHERE Estacion = @Estacion)
					AND v.Moneda = @Moneda
					AND v.TipoCambio = @TipoCambio
					AND v.Almacen = @Almacen
					AND ISNULL(v.Condicion,'') = ISNULL(@Condicion,'')
					AND ISNULL(v.Concepto,'') = ISNULL(@Concepto,'')   
					AND v.Agente = @Agente 
					AND v.UEN = @UEN
					AND v.Cliente = @Cliente
					GROUP BY d.Almacen, d.Posicion, d.Articulo, a.MonedaCosto, a.Tipo, a.CostoIdentificado, d.SubCuenta, d.RenglonTipo, d.Unidad, ROUND(d.Impuesto1, 4),
					ROUND(d.Impuesto2, 4), ROUND(d.Impuesto3, 4), d.DescuentoTipo, d.DescuentoLinea, d.Precio, v.DescuentoGlobal, v.SobrePrecio, d.PrecioMoneda,
					d.PrecioTipoCambio, d.CantidadObsequio, d.OfertaID, d.PrecioSugerido, d.DescuentoImporte, d.Puntos, d.Comision
					ORDER BY d.Almacen, d.Posicion, d.Articulo, a.MonedaCosto, a.Tipo, a.CostoIdentificado, d.SubCuenta, d.RenglonTipo, d.Unidad, ROUND(d.Impuesto1, 4),
					ROUND(d.Impuesto2, 4), ROUND(d.Impuesto3, 4), d.DescuentoTipo, d.DescuentoLinea, d.Precio, v.DescuentoGlobal, v.SobrePrecio, d.PrecioMoneda,
					d.PrecioTipoCambio, d.CantidadObsequio, d.OfertaID, d.PrecioSugerido, d.DescuentoImporte, d.Puntos, d.Comision              
					
					OPEN crDevDetalle
					FETCH NEXT FROM crDevDetalle INTO @AlmacenD, @Posicion, @Articulo, @SubCuenta, @RenglonTipo, @Unidad, @Impuesto1, @Impuesto2, @Impuesto3, @Cantidad,
					@CantidadInventario, @DescuentoTipo, @DescuentoLinea, @Precio, @DescuentoGlobal, @SobrePrecio, @MonedaCosto, @ArtTipo, @ArtCostoIdentificado,
					@PrecioMonedaD, @PrecioTipoCambioD, @CantidadObsequio, @OfertaID, @PrecioSugerido, @DescuentoImporte, @Puntos, @Comision
					WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
						BEGIN
							IF @@FETCH_STATUS <> -2 
								BEGIN
									SELECT @PrecioNeto = dbo.fnSubTotal(@Precio, @DescuentoGlobal, @SobrePrecio)
          
									IF @VentaMultiAlmacen = 0 AND @AlmacenD <> @Almacen 
										SELECT @Ok = 20860, @OkRef = @AlmacenD
									
									SELECT @Costo = NULL
									EXEC spVerCosto @Sucursal, @Empresa, @Proveedor, @Articulo, @SubCuenta, @Unidad, @TipoCosteo, @Moneda, @TipoCambio, 
										@Costo OUTPUT, 0, @Precio = @PrecioNeto
          
									SELECT @Renglon = @Renglon + 2048, @RenglonID = @RenglonID + 1
          
									INSERT VentaD (
										Sucursal, SucursalOrigen, ID, Renglon, RenglonSub, RenglonID, RenglonTipo, Almacen, Posicion, Articulo, SubCuenta, 
										Unidad, Impuesto1, Impuesto2, Impuesto3, Cantidad, CantidadInventario, DescuentoTipo, DescuentoLinea, Precio, 
										Costo, UEN, Agente, PrecioMoneda, PrecioTipoCambio, CantidadObsequio, OfertaID, PrecioSugerido, 
										DescuentoImporte, Puntos, Comision)
									SELECT
										@Sucursal, @Sucursal, @DevolucionID, @Renglon, 0, @RenglonID, @RenglonTipo, @Almacen, @Posicion, @Articulo, @SubCuenta, 
										@Unidad, @Impuesto1, @Impuesto2, @Impuesto3, @Cantidad, @CantidadInventario, @DescuentoTipo, @DescuentoLinea, @PrecioNeto, 
										@Costo, @UEN, @Agente, @PrecioMonedaD, @PrecioTipoCambioD, @CantidadObsequio, @OfertaID, @PrecioSugerido, 
										@DescuentoImporte, @Puntos, @Comision
   
									IF (@ArtTipo IN ('SERIE', 'VIN') AND (@CfgCosteoSeries = 1 OR @ArtCostoIdentificado = 1)) OR (@ArtTipo IN ('LOTE', 'PARTIDA') 
										AND (@CfgCosteoLotes = 1 OR @ArtCostoIdentificado = 1)) 
										BEGIN          
											INSERT SerieLoteMov (
												Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, ArtCostoInv, 
												Cantidad, CantidadAlterna, Sucursal, Propiedades)
											SELECT
												@Empresa, 'VTAS', @DevolucionID, @RenglonID, @Articulo, ISNULL(@SubCuenta, ''), s.SerieLote, s.ArtCostoInv, 
												SUM(s.Cantidad), SUM(s.CantidadAlterna), @Sucursal,ISNULL(s.Propiedades, '')
											FROM Venta v JOIN VentaD d ON v.ID = d.ID
											JOIN SerieLoteMov s  ON s.ID = v.ID AND  s.RenglonID = d.RenglonID AND s.Articulo = d.Articulo 
											AND ISNULL(s.SubCuenta, '') = ISNULL(d.SubCuenta, '') AND s.Empresa = v.Empresa AND s.Modulo = 'VTAS'
											JOIN Art a ON d.Articulo = a.Articulo
											WHERE v.ID IN (SELECT ID FROM VentaRefacturarTemp WHERE Estacion = @Estacion)
											AND v.Moneda = @Moneda
											AND v.TipoCambio = @TipoCambio
											AND v.Almacen = @Almacen
											AND v.Condicion = @Condicion
											AND v.Concepto = @Concepto  
											AND v.Agente = @Agente 
											AND v.UEN = @UEN
											AND v.Cliente = @Cliente
											AND d.Almacen = @AlmacenD AND ISNULL(d.Posicion, '') = ISNULL(@Posicion, '') AND d.Articulo = @Articulo 
											AND a.MonedaCosto = @MonedaCosto AND ISNULL(d.SubCuenta, '') = ISNULL(@SubCuenta, '') AND d.Unidad = @Unidad 
											AND ISNULL(ROUND(d.Impuesto1, 4),0.0) = @Impuesto1 AND ISNULL(ROUND(d.Impuesto2, 4),0.0) = @Impuesto2 
											AND ISNULL(ROUND(d.Impuesto3, 4),0.0) = @Impuesto3 AND ISNULL(d.DescuentoTipo,'') = @DescuentoTipo 
											AND ISNULL(d.DescuentoLinea,0.0) = @DescuentoLinea AND ISNULL(d.Precio,0.0) = @Precio 
											AND ISNULL(ROUND(v.DescuentoGlobal, 10),0.0) = ISNULL(ROUND(@DescuentoGlobal, 10),0.0) 
											AND ISNULL(ROUND(v.SobrePrecio, 10),0.0) = ISNULL(ROUND(@SobrePrecio, 10),0.0)
											GROUP BY s.SerieLote, s.ArtCostoInv, s.Propiedades
                                                
											SELECT @Costo = ISNULL(SUM(m.Cantidad*ISNULL(s.CostoPromedio*Mon.TipoCambio, 0.0))/NULLIF(SUM(m.Cantidad), 0.0), 0.0)/@TipoCambio
											FROM SerieLoteMov m, SerieLote s, Art a, Mon
											WHERE m.Empresa = @Empresa AND m.Modulo = 'VTAS' AND m.ID = @DevolucionID AND m.RenglonID = @RenglonID 
											AND m.Articulo = @Articulo AND m.SubCuenta = ISNULL(@SubCuenta, '')
											AND s.Empresa = @Empresa AND s.Articulo = @Articulo AND s.SubCuenta = ISNULL(@SubCuenta, '') 
											AND s.SerieLote = m.SerieLote AND s.Sucursal = @Sucursal AND s.Almacen = @Almacen 
											AND a.Articulo = @Articulo
											AND Mon.Moneda = a.MonedaCosto
      
											-- ESTO SIRVE PARA PONERLE COSTO A ARTCOSTOINV
											UPDATE SerieLoteMov 
											SET ArtCostoInv = s.CostoPromedio
											FROM SerieLoteMov m, SerieLote s
											WHERE m.Empresa = @Empresa AND m.Modulo = 'VTAS' AND m.ID = @DevolucionID AND m.RenglonID = @RenglonID 
											AND m.Articulo = @Articulo AND m.SubCuenta = ISNULL(@SubCuenta, '')
											AND s.Empresa = @Empresa AND s.Articulo = @Articulo AND s.SubCuenta = ISNULL(@SubCuenta, '') 
											AND s.SerieLote = m.SerieLote AND s.Sucursal = @Sucursal AND s.Almacen = @Almacen
      
											UPDATE VentaD SET Costo = @Costo WHERE ID = @DevolucionID AND Renglon = @Renglon AND RenglonSub = 0
										END
								END
        
							FETCH NEXT FROM crDevDetalle INTO @AlmacenD, @Posicion, @Articulo, @SubCuenta, @RenglonTipo, @Unidad, @Impuesto1, @Impuesto2, @Impuesto3,
							@Cantidad, @CantidadInventario, @DescuentoTipo, @DescuentoLinea, @Precio, @DescuentoGlobal, @SobrePrecio, @MonedaCosto, @ArtTipo,
							@ArtCostoIdentificado, @PrecioMonedaD, @PrecioTipoCambioD, @CantidadObsequio, @OfertaID, @PrecioSugerido, @DescuentoImporte, @Puntos, @Comision
						END
					CLOSE crDevDetalle
					DEALLOCATE crDevDetalle   
              
					INSERT @Tarjeta(
						Renglon, RenglonID, Articulo)  
					SELECT 
						d.Renglon, d.RenglonID, d.Articulo
					FROM Venta v JOIN VentaD d ON v.ID = d.ID JOIN SerieLoteMov s  ON s.ID = v.ID AND  s.RenglonID = d.RenglonID AND s.Articulo = d.Articulo 
					AND ISNULL(s.SubCuenta, '') = ISNULL(d.SubCuenta, '') AND s.Empresa = v.Empresa AND s.Modulo = 'VTAS' 
					JOIN ValeSerie vs ON  vs.Serie =  s.SerieLote AND s.Articulo = vs.Articulo
					WHERE v.ID = @DevolucionID

					IF NULLIF(@ArtTarjetaServicio,'') IS NOT NULL
						UPDATE VentaD SET Articulo = @ArtTarjetaServicio, RenglonTipo ='N'
						FROM VentaD d JOIN @Tarjeta t ON t.Renglon = d.Renglon AND t.RenglonID = d.RenglonID AND t.Articulo = d.Articulo
						WHERE d.ID = @DevolucionID 
       
					DELETE SerieLoteMov
					FROM SerieLoteMov s JOIN @Tarjeta t ON  t.RenglonID = s.RenglonID AND t.Articulo = s.Articulo
					WHERE s.ID = @DevolucionID    AND s.Modulo = 'VTAS' AND s.Empresa = @Empresa                
      
					IF @Ok IS NULL AND @DevolucionID IS NOT NULL
						EXEC spAfectar 'VTAS', @DevolucionID, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @ok OUTPUT, @OkRef = @OkRef OUTPUT
        
					FETCH NEXT FROM crEncabezadoDev INTO @Moneda,  @TipoCambio,  @Almacen, @Condicion, @Concepto,@Agente, @UEN, @Cliente
				END
			CLOSE crEncabezadoDev
			DEALLOCATE crEncabezadoDev  
    
			IF @Ok IS NULL
				BEGIN
					UPDATE Venta SET Refacturado = 1
					WHERE ID IN (SELECT ID FROM VentaRefacturarTemp WHERE Estacion = @Estacion)
				END 

			IF  @Ok IS NULL AND EXISTS(SELECT * FROM @Nota)
				BEGIN 
					DECLARE crNotaEncabezado CURSOR LOCAL FOR
					SELECT ID
					FROM  @Nota
		
					OPEN crNotaEncabezado      
					FETCH NEXT FROM crNotaEncabezado INTO @IDFactura
					WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
						BEGIN      
							SET @FacturaID = NULL
      
							INSERT Venta (
								Sucursal, SucursalOrigen, Empresa, Mov, FechaEmision, Moneda, TipoCambio, Almacen, Cliente, Condicion, Concepto, 
								Usuario, Estatus, OrigenTipo, Agente, UEN, FormaPagoTipo, SucursalDestino)
							SELECT
								Sucursal, SucursalOrigen, Empresa, @FacturaMostrador, FechaEmision, Moneda, TipoCambio, Almacen, @ClienteFact, Condicion, Concepto,
								Usuario, 'SINAFECTAR', NULL, Agente, UEN, FormaPagoTipo, Sucursal
							FROM Venta 
							WHERE ID = @IDFactura 
						
							SELECT @FacturaID = SCOPE_IDENTITY()        
							SELECT @Renglon = 0, @RenglonID = 0      
              
							DECLARE crNotaDetalle CURSOR LOCAL  FOR
							SELECT 
								d.Almacen, 
								d.Posicion, 
								d.Articulo, 
								d.SubCuenta, 
								d.RenglonTipo, 
								d.Unidad, 
								ISNULL(ROUND(d.Impuesto1, 4),0.0), 
								ISNULL(ROUND(d.Impuesto2, 4),0.0), 
								ISNULL(ROUND(d.Impuesto3, 4),0.0), 
								SUM(d.Cantidad), 
								SUM(d.CantidadInventario), 
								ISNULL(d.DescuentoTipo,''), 
								ISNULL(d.DescuentoLinea,0.0), 
								ISNULL(d.Precio,0.0), 
								ISNULL(v.DescuentoGlobal,0.0), 
								ISNULL(v.SobrePrecio,0.0),
								a.MonedaCosto, 
								a.Tipo, 
								a.CostoIdentificado, 
								d.PrecioMoneda, 
								d.PrecioTipoCambio, 
								d.CantidadObsequio, 
								d.OfertaID, 
								d.PrecioSugerido, 
								d.DescuentoImporte, 
								d.Puntos, 
								d.Comision
							FROM Venta v JOIN VentaD d ON v.ID = d.ID 
							JOIN Art a ON d.Articulo = a.Articulo
							WHERE v.ID = @IDFactura
							GROUP BY d.Almacen, d.Posicion, d.Articulo, a.MonedaCosto, a.Tipo, a.CostoIdentificado, d.SubCuenta, d.RenglonTipo, d.Unidad, 
							ROUND(d.Impuesto1, 4), ROUND(d.Impuesto2, 4), ROUND(d.Impuesto3, 4), d.DescuentoTipo, d.DescuentoLinea, d.Precio, v.DescuentoGlobal,
							v.SobrePrecio, d.PrecioMoneda, d.PrecioTipoCambio, d.CantidadObsequio, d.OfertaID, d.PrecioSugerido, d.DescuentoImporte, d.Puntos, d.Comision
							ORDER BY d.Almacen, d.Posicion, d.Articulo, a.MonedaCosto, a.Tipo, a.CostoIdentificado, d.SubCuenta, d.RenglonTipo, d.Unidad, 
							ROUND(d.Impuesto1, 4), ROUND(d.Impuesto2, 4), ROUND(d.Impuesto3, 4), d.DescuentoTipo, d.DescuentoLinea, d.Precio, v.DescuentoGlobal,
							v.SobrePrecio, d.PrecioMoneda, d.PrecioTipoCambio, d.CantidadObsequio, d.OfertaID, d.PrecioSugerido, d.DescuentoImporte, d.Puntos, d.Comision              
        
							OPEN crNotaDetalle
							FETCH NEXT FROM crNotaDetalle INTO @AlmacenD, @Posicion, @Articulo, @SubCuenta, @RenglonTipo, @Unidad, @Impuesto1, @Impuesto2, @Impuesto3,
							@Cantidad, @CantidadInventario, @DescuentoTipo, @DescuentoLinea, @Precio, @DescuentoGlobal, @SobrePrecio, @MonedaCosto, @ArtTipo,
							@ArtCostoIdentificado, @PrecioMonedaD, @PrecioTipoCambioD, @CantidadObsequio, @OfertaID, @PrecioSugerido, @DescuentoImporte, @Puntos, @Comision
							WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
								BEGIN
									IF @@FETCH_STATUS <> -2 
										BEGIN
											SELECT @PrecioNeto = dbo.fnSubTotal(@Precio, @DescuentoGlobal, @SobrePrecio)
            
											IF @VentaMultiAlmacen = 0 AND @AlmacenD <> @Almacen 
												SELECT @Ok = 20860, @OkRef = @AlmacenD
									
											SELECT @Costo = NULL
											EXEC spVerCosto @Sucursal, @Empresa, @Proveedor, @Articulo, @SubCuenta, @Unidad, @TipoCosteo, @Moneda, @TipoCambio, 
												@Costo OUTPUT, 0, @Precio = @PrecioNeto
            
											SELECT @Renglon = @Renglon + 2048, @RenglonID = @RenglonID + 1
											INSERT VentaD (
												Sucursal, SucursalOrigen, ID, Renglon, RenglonSub, RenglonID, RenglonTipo, Almacen, Posicion, Articulo, SubCuenta, 
												Unidad, Impuesto1, Impuesto2, Impuesto3, Cantidad, CantidadInventario, DescuentoTipo, DescuentoLinea, Precio, 
												Costo, UEN, Agente, PrecioMoneda, PrecioTipoCambio, CantidadObsequio, OfertaID, PrecioSugerido, 
												DescuentoImporte, Puntos, Comision)
											SELECT
												@Sucursal, @Sucursal, @FacturaID, @Renglon, 0, @RenglonID, @RenglonTipo, @Almacen, @Posicion, @Articulo, @SubCuenta, 
												@Unidad, @Impuesto1, @Impuesto2, @Impuesto3, @Cantidad, @CantidadInventario, @DescuentoTipo, @DescuentoLinea, @PrecioNeto,
												@Costo, @UEN, @Agente, @PrecioMonedaD, @PrecioTipoCambioD, @CantidadObsequio, @OfertaID, @PrecioSugerido, 
												@DescuentoImporte, @Puntos, @Comision
        
											IF (@ArtTipo IN ('SERIE', 'VIN') AND (@CfgCosteoSeries = 1 OR @ArtCostoIdentificado = 1)) OR (@ArtTipo IN ('LOTE', 'PARTIDA') 
												AND (@CfgCosteoLotes = 1 OR @ArtCostoIdentificado = 1)) 
												BEGIN
													INSERT SerieLoteMov (
														Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, ArtCostoInv, 
														Cantidad, CantidadAlterna, Sucursal, Propiedades)
													SELECT
														@Empresa, 'VTAS', @FacturaID, @RenglonID, @Articulo, ISNULL(@SubCuenta, ''), s.SerieLote, s.ArtCostoInv, 
														SUM(s.Cantidad), SUM(s.CantidadAlterna), @Sucursal,ISNULL(s.Propiedades, '')
													FROM Venta v JOIN VentaD d ON v.ID = d.ID
													JOIN SerieLoteMov s  ON s.ID = v.ID AND  s.RenglonID = d.RenglonID AND s.Articulo = d.Articulo 
													AND ISNULL(s.SubCuenta, '') = ISNULL(d.SubCuenta, '') AND s.Empresa = v.Empresa AND s.Modulo = 'VTAS'
													JOIN Art a ON d.Articulo = a.Articulo
													WHERE v.ID = @IDFactura
													AND d.Almacen = @AlmacenD AND ISNULL(d.Posicion, '') = ISNULL(@Posicion, '') AND d.Articulo = @Articulo 
													AND a.MonedaCosto = @MonedaCosto AND ISNULL(d.SubCuenta, '') = ISNULL(@SubCuenta, '') AND d.Unidad = @Unidad 
													AND ISNULL(ROUND(d.Impuesto1, 4),0.0) = @Impuesto1 AND ISNULL(ROUND(d.Impuesto2, 4),0.0) = @Impuesto2 
													AND ISNULL(ROUND(d.Impuesto3, 4),0.0) = @Impuesto3 AND ISNULL(d.DescuentoTipo,'') = @DescuentoTipo 
													AND ISNULL(d.DescuentoLinea,0.0) = @DescuentoLinea AND ISNULL(d.Precio,0.0) = @Precio 
													AND ISNULL(ROUND(v.DescuentoGlobal, 10),0.0) = ISNULL(ROUND(@DescuentoGlobal, 10),0.0) 
													AND ISNULL(ROUND(v.SobrePrecio, 10),0.0) = ISNULL(ROUND(@SobrePrecio, 10),0.0)
													GROUP BY s.SerieLote, s.ArtCostoInv, s.Propiedades                   
  
													SELECT @Costo = ISNULL(SUM(m.Cantidad * 
															ISNULL(s.CostoPromedio * Mon.TipoCambio, 0.0))/NULLIF(SUM(m.Cantidad), 0.0), 0.0)/@TipoCambio
													FROM SerieLoteMov m, SerieLote s, Art a, Mon
													WHERE m.Empresa = @Empresa AND m.Modulo = 'VTAS' AND m.ID = @FacturaID AND m.RenglonID = @RenglonID 
													AND m.Articulo = @Articulo AND m.SubCuenta = ISNULL(@SubCuenta, '')
													AND s.Empresa = @Empresa AND s.Articulo = @Articulo AND s.SubCuenta = ISNULL(@SubCuenta, '') 
													AND s.SerieLote = m.SerieLote AND s.Sucursal = @Sucursal AND s.Almacen = @Almacen 
													AND a.Articulo = @Articulo
													AND Mon.Moneda = a.MonedaCosto
        
													UPDATE SerieLoteMov 
													SET ArtCostoInv = s.CostoPromedio
													FROM SerieLoteMov m, SerieLote s
													WHERE m.Empresa = @Empresa AND m.Modulo = 'VTAS' AND m.ID = @FacturaID AND m.RenglonID = @RenglonID 
													AND m.Articulo = @Articulo AND m.SubCuenta = ISNULL(@SubCuenta, '')
													AND s.Empresa = @Empresa AND s.Articulo = @Articulo AND s.SubCuenta = ISNULL(@SubCuenta, '') 
													AND s.SerieLote = m.SerieLote AND s.Sucursal = @Sucursal AND s.Almacen = @Almacen
        
													UPDATE VentaD SET Costo = @Costo WHERE ID = @FacturaID AND Renglon = @Renglon AND RenglonSub = 0
												END
										END
          
									FETCH NEXT FROM crNotaDetalle INTO @AlmacenD, @Posicion, @Articulo, @SubCuenta, @RenglonTipo, @Unidad, @Impuesto1, @Impuesto2,
									@Impuesto3, @Cantidad, @CantidadInventario, @DescuentoTipo, @DescuentoLinea, @Precio, @DescuentoGlobal, @SobrePrecio, @MonedaCosto,
									@ArtTipo, @ArtCostoIdentificado, @PrecioMonedaD, @PrecioTipoCambioD, @CantidadObsequio, @OfertaID, @PrecioSugerido, 
									@DescuentoImporte, @Puntos, @Comision
								END
							CLOSE crNotaDetalle
							DEALLOCATE crNotaDetalle  

							DELETE SerieLoteMov
							FROM Venta v JOIN VentaD d ON v.ID = d.ID JOIN SerieLoteMov s  ON s.ID = v.ID AND  s.RenglonID = d.RenglonID AND s.Articulo = d.Articulo 
							AND ISNULL(s.SubCuenta, '') = ISNULL(d.SubCuenta, '') AND s.Empresa = v.Empresa AND s.Modulo = 'VTAS' 
							JOIN ValeSerie vs ON  vs.Serie =  s.SerieLote AND s.Articulo = vs.Articulo
							JOIN Art a ON d.Articulo = a.Articulo
							WHERE v.ID = @FacturaID  
         
							IF NULLIF(@ArtTarjetaServicio,'') IS NOT NULL
								UPDATE VentaD SET Articulo = @ArtTarjetaServicio, RenglonTipo ='N'
								FROM Venta v JOIN VentaD d ON v.ID = d.ID JOIN SerieLoteMov s  ON s.ID = v.ID AND  s.RenglonID = d.RenglonID AND s.Articulo = d.Articulo 
								AND ISNULL(s.SubCuenta, '') = ISNULL(d.SubCuenta, '') AND s.Empresa = v.Empresa AND s.Modulo = 'VTAS' 
								JOIN ValeSerie vs ON  vs.Serie =  s.SerieLote AND s.Articulo = vs.Articulo
								JOIN Art a ON d.Articulo = a.Articulo
								WHERE v.ID = @FacturaID           
          
							IF @Ok IS NULL  
								INSERT VentaOrigen (
									ID, OrigenID, Sucursal, SucursalOrigen)  
								SELECT 
									@FacturaID, @IDFactura, @Sucursal, @Sucursal   
          
							IF @Ok IS NULL 
								BEGIN  
									INSERT VentaProcesarNotas(
										IDOrigen, ID, Renglon, RenglonSub, Almacen, Posicion, Articulo, SubCuenta, RenglonTipo, Unidad, 
										Impuesto1, Impuesto2, Impuesto3, Cantidad, CantidadInventario, 
										DescuentoTipo, DescuentoLinea, Precio, DescuentoGlobal, 
										SobrePrecio, MonedaCosto, Tipo, CostoIdentificado, PrecioMoneda, PrecioTipoCambio, 
										CantidadObsequio, OfertaID, PrecioSugerido, DescuentoImporte, Puntos, Comision)
									SELECT
										v.ID, @FacturaID, d.Renglon, d.RenglonSub, d.Almacen, d.Posicion, d.Articulo, d.SubCuenta, d.RenglonTipo, d.Unidad, 
										ISNULL(d.Impuesto1,0.0), ISNULL(d.Impuesto2,0.0), ISNULL(d.Impuesto3,0.0), d.Cantidad, d.CantidadInventario, 
										ISNULL(d.DescuentoTipo,''), ISNULL(d.DescuentoLinea,0.0), ISNULL(d.Precio,0.0), ISNULL(v.DescuentoGlobal,0.0), 
										ISNULL(v.SobrePrecio,0.0), Art.MonedaCosto, Art.Tipo, Art.CostoIdentificado, d.PrecioMoneda, d.PrecioTipoCambio, 
										d.CantidadObsequio, d.OfertaID, d.PrecioSugerido, d.DescuentoImporte, d.Puntos, d.Comision 
									FROM Venta v, VentaD d,  Art
									WHERE v.ID = d.ID 
									AND v.ID = @IDFactura
									AND d.Cantidad > 0.0
									AND Art.Articulo = d.Articulo
									AND d.ProcesadoID IS NULL
									GROUP BY v.ID, d.Renglon, d.RenglonSub, d.Almacen, d.Posicion, d.Articulo, Art.MonedaCosto, Art.Tipo, Art.CostoIdentificado, 
									d.SubCuenta, d.RenglonTipo, d.Unidad, d.Impuesto1, d.Impuesto2, d.Impuesto3, d.DescuentoTipo, d.DescuentoLinea, d.Precio,
									v.DescuentoGlobal, v.SobrePrecio, d.PrecioMoneda, d.PrecioTipoCambio, d.CantidadObsequio, d.OfertaID, d.PrecioSugerido,
									d.DescuentoImporte, d.Puntos, d.Comision, d.Cantidad, d.CantidadInventario
									ORDER BY v.ID, d.Renglon, d.RenglonSub, d.Almacen, d.Posicion, d.Articulo, Art.MonedaCosto, Art.Tipo, Art.CostoIdentificado, 
									d.SubCuenta, d.RenglonTipo, d.Unidad, d.Impuesto1, d.Impuesto2, d.Impuesto3, d.DescuentoTipo, d.DescuentoLinea, d.Precio,
									v.DescuentoGlobal, v.SobrePrecio, d.PrecioMoneda, d.PrecioTipoCambio, d.CantidadObsequio, d.OfertaID, d.PrecioSugerido,
									d.DescuentoImporte, d.Puntos, d.Comision, d.Cantidad, d.CantidadInventario
								END  
      
							IF @Ok IS NULL AND @FacturaID IS NOT NULL
								BEGIN
									EXEC spAfectar 'VTAS', @FacturaID, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, 
										@Ok = @ok OUTPUT, @OkRef = @OkRef OUTPUT          
									
									IF @Ok IS NULL
										INSERT @Factura
										SELECT @FacturaID
								END  
        
							FETCH NEXT FROM crNotaEncabezado INTO @FacturaID
						END
					CLOSE crNotaEncabezado
					DEALLOCATE crNotaEncabezado 
				END
    
			IF @FacturaID IS NOT NULL
				BEGIN
					SELECT @CuantasFacturas = COUNT(*) FROM @Factura
					
					SELECT TOP 1 @FacturaMovID = MovID 
					FROM Venta 
					WHERE ID IN(SELECT ID FROM @Factura)
					
					SELECT @Cuantas = COUNT(ID) 
					FROM VentaRefacturarTemp 
					WHERE Estacion = @Estacion
				END  
  
		END
  
	IF @Ok IS NULL
		BEGIN
			COMMIT TRANSACTION    
				BEGIN 
					SELECT @OkRef = RTRIM(Convert(char, @Cuantas))+' Nota(s) procesadas.'  
					
					IF @CuantasFacturas = 1   
						SELECT @OkRef = RTRIM(@OkRef) + '<BR>Se Genero: '+RTRIM(@FacturaMostrador)+' '+ISNULL(RTRIM(@FacturaMovID), '')
					ELSE  
						SELECT @OkRef = RTRIM(@OkRef) + '<BR>Se Generaron: '+CONVERT(varchar, @CuantasFacturas)+' '+RTRIM(@FacturaMostrador)+'(s) '
					END          
    
					SELECT @OkRef
				END 
			ELSE
				BEGIN		
					ROLLBACK TRANSACTION

					SELECT Descripcion+' '+RTRIM(ISNULL(@OkRef,'')) 
					FROM MensajeLista
					WHERE Mensaje = @Ok  
		END
	
	RETURN
END
GO


/************************ spPOSInsertarVentaRefacturarTemp *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarVentaRefacturarTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarVentaRefacturarTemp
GO             
CREATE PROCEDURE spPOSInsertarVentaRefacturarTemp
	@Estacion   int
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	INSERT VentaRefacturarTemp(
		Estacion,  ID, Empresa, Mov, MovID)
	SELECT
		@Estacion, ID, Empresa, Mov, MovID
    FROM VentaRefacturar
	WHERE ID IN(SELECT ID FROM ListaID WHERE Estacion = @Estacion)
    AND ID NOT IN(SELECT ID FROM VentaRefacturarTemp WHERE Estacion = @Estacion)
END
GO 


/**************** fnPOSTieneServicioLDI ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSTieneServicioLDI') DROP FUNCTION fnPOSTieneServicioLDI
GO
CREATE FUNCTION dbo.fnPOSTieneServicioLDI (
	@ID		varchar(36), 
	@Bit	bit
) 
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado bit

	SELECT @Resultado = @Bit  
	
	IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo IN (SELECT Articulo FROM POSLDIArtRecargaTel)) AND @Bit = 1
		SELECT @Resultado = 0    

	RETURN (@Resultado)
END
GO


/**************** fnPOSValidarBloquearCaja ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidarBloquearCaja') DROP FUNCTION fnPOSValidarBloquearCaja
GO
CREATE FUNCTION dbo.fnPOSValidarBloquearCaja (
	@Codigo varchar(36)
) 
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado bit

	SELECT @Resultado = 0

	IF (SELECT Accion FROM CB WHERE Codigo = @Codigo) IN ('DESBLOQUEAR CAJA')
		SELECT @Resultado = 1    

	RETURN (@Resultado)
END
GO


/**************** spPOSVerLimiteCreditoMN ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSVerLimiteCreditoMN') AND type = 'P') DROP PROCEDURE dbo.spPOSVerLimiteCreditoMN
GO             
CREATE PROCEDURE spPOSVerLimiteCreditoMN
	@Cliente			char(10),
	@Empresa			char(5),
	@LimiteCredito		float		OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @Credito			varchar(50),
    @CreditoEspecial	bit,    
    @MonedaCredito		char(10)
 
	SELECT 
		@Credito 	    = Credito,
        @CreditoEspecial = CreditoEspecial,
        @LimiteCredito   = ISNULL(CreditoLimite, 0.0), 
        @MonedaCredito   = CreditoMoneda
    FROM Cte
	WHERE Cliente = @Cliente
  
	IF @CreditoEspecial = 0
		BEGIN
			SELECT @LimiteCredito = NULL
			SELECT 
				@LimiteCredito = ISNULL(LimiteCredito, 0.0),
				@MonedaCredito = MonedaCredito
			FROM CteCredito
			WHERE Empresa = @Empresa AND Credito = @Credito
		END

	SELECT @LimiteCredito = @LimiteCredito*TipoCambio FROM Mon WHERE Moneda = @MonedaCredito
END
GO


/**************** fnPOSEditarPOSLVenta ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSEditarPOSLVenta') DROP FUNCTION fnPOSEditarPOSLVenta
GO
CREATE FUNCTION dbo.fnPOSEditarPOSLVenta (
	@ID			varchar(36), 
	@Empresa	varchar(5), 
	@Articulo	varchar(20), 
	@Renglon	float
) 
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado                    bit,
    @CodigoRedondeo               varchar(30),
    @ArticuloRedondeo             varchar(20),
    @ArtOfertaImporte             varchar(20),
    @ArtOfertaFP                  varchar(20),
    @CfgAnticipoArticuloServicio  varchar(20),
    @AnticipoFacturado            bit  
         
	SELECT @AnticipoFacturado  = ISNULL(AnticipoFacturado,0) 
	FROM POSLVenta 
	WHERE ID = @ID AND Renglon = @Renglon
    
	SELECT @CodigoRedondeo = RedondeoVentaCodigo , @ArtOfertaFP = ArtOfertaFP, @ArtOfertaImporte = ArtOfertaImporte
    FROM POSCfg 
	WHERE Empresa = @Empresa
    
	SELECT @ArticuloRedondeo = Cuenta
    FROM CB
    WHERE Codigo = @CodigoRedondeo
    AND TipoCuenta = 'Articulos'
      
	SELECT @ArticuloRedondeo = cb.Cuenta 
	FROM CB 
	WHERE CB.Cuenta = @CodigoRedondeo AND CB.TipoCuenta = 'Articulos'       
    
	SELECT @CfgAnticipoArticuloServicio = NULLIF(CxcAnticipoArticuloServicio,'')    
	FROM EmpresaCfg2
	WHERE Empresa = @Empresa                  

	SELECT @Resultado = 1
  
	IF @Articulo IN (@ArticuloRedondeo, @ArtOfertaImporte, @ArtOfertaFP, @CfgAnticipoArticuloServicio)
		SELECT @Resultado = 0  
    
	IF @AnticipoFacturado = 1
		SELECT @Resultado = 0      

	RETURN (@Resultado)
END
GO   


/**************** fnImporteMonTarjetaOfertaPuntos  ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnImporteMonTarjetaOfertaPuntos') DROP FUNCTION fnImporteMonTarjetaOfertaPuntos
GO
CREATE FUNCTION fnImporteMonTarjetaOfertaPuntos (	
	@Importe		float,
	@Monedero       varchar(20),
	@OfertaID       int,
	@Sucursal       int,
	@Articulo       varchar(20),
	@SubCuenta		varchar(50)
)
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @ImporteDestino			float,
    @TipoCambioDestino		float,
    @ImporteTipoCambio      float,
    @MonedaTarjeta          varchar(10),
    @MonedaMov			    varchar(10),
    @MonedaDetalle		    varchar(10),
    @TipoCambioDetalle		float
    
	SELECT @MonedaTarjeta = Moneda 
	FROM POSValeSerie 
	WHERE Serie = @Monedero
  
	SELECT @MonedaMov = Moneda 
	FROM Oferta 
	WHERE ID =   @OfertaID
  
	SELECT @MonedaDetalle = Moneda 
	FROM OfertaD 
	WHERE ID = @OfertaID AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') 
 
	SELECT @ImporteTipoCambio = TipoCambio 
    FROM POSLTipoCambioRef m
	WHERE Moneda = @MonedaMov AND Sucursal = @Sucursal 
   
	SELECT @TipoCambioDestino = TipoCambio 
    FROM POSLTipoCambioRef m
	WHERE Moneda = @MonedaTarjeta AND Sucursal = @Sucursal    
   
	SELECT @TipoCambioDetalle = TipoCambio 
    FROM POSLTipoCambioRef m
	WHERE Moneda = @MonedaDetalle AND Sucursal = @Sucursal    
   
    SET @ImporteDestino = dbo.fnPOSImporteAMoneda (@Importe,@TipoCambioDetalle,@MonedaTarjeta,@Sucursal)
  
	RETURN (@ImporteDestino)
END
GO


/**************** fnPOSValidaPOSLVenta ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidaPOSLVenta') DROP FUNCTION fnPOSValidaPOSLVenta
GO
CREATE FUNCTION dbo.fnPOSValidaPOSLVenta (
	@ID varchar(36)
) 
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado                    bit,
    @MovClave                     varchar(20),
    @ConsecutivoModulo            varchar(5)
    
	SELECT   @MovClave = mt.Clave , @ConsecutivoModulo =  mt.ConsecutivoModulo
    FROM MovTipo mt JOIN POSL p ON p.Mov = mt.Mov AND mt.Modulo = 'POS'
	WHERE p.ID = @ID 
    
	SELECT @Resultado = 1

	IF @ConsecutivoModulo IN('VTAS','CXC')    
		IF NOT EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID)
			SELECT @Resultado = 0
      
	IF @ConsecutivoModulo = 'DIN'
		IF NOT EXISTS(SELECT * FROM POSLCobro WHERE ID = @ID)
			SELECT @Resultado = 0      

	RETURN (@Resultado)
END
GO 


/**************** spPOSFacturarNotasLote ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSFacturarNotasLote') AND type = 'P') DROP PROCEDURE dbo.spPOSFacturarNotasLote
GO 
CREATE PROC spPOSFacturarNotasLote
	@Estacion       int,
    @Empresa        varchar(20),
    @Sucursal       int,
    @Usuario        varchar(10),
    @MovFact        varchar(20),  
    @Cliente        varchar(10),                                
    @Ok             int   = NULL         OUTPUT,
    @OkRef          varchar(255)  = NULL OUTPUT
--//WITH ENCRYPTION  
AS
BEGIN
	DECLARE 
    @IDPOS							varchar(50),
    @IDDev							varchar(50),
    @IDFact							varchar(50),
    @MovCFD							varchar(20),
    @MovDev							varchar(20),
    @IDNuevo						int,
    @CodigoRedondeo					varchar(20),
    @ArticuloRedondeo				varchar(20),
    @UUID							varchar(50),
    @FechaTimbrado					datetime,
    @MovIDCFD						varchar(20),
    @SelloSat						varchar(255),
    @TFDVersion						varchar(10),
    @NoCertificadoSAT				varchar(20),
    @TFDCadenaOriginal				varchar(max),
    @CadenaOriginal					varchar(max),
    @Sello							varchar(255),
    @Certificado					varchar(20),
    @DocumentoXML					varchar(max), 
    @FechaSello						datetime,
    @Fecha 							datetime,
    @ArticuloTarjeta				varchar(20),
    @AlmacenTarjeta					varchar(20),
    @Prefijo						varchar(5),
    @Consecutivo					int,
    @noAprobacion					int,
    @fechaAprobacion				datetime,  
    @MovIDFact						varchar(20),
    @MovIDDev						varchar(20), 
    @VentaPreciosImpuestoIncluido	bit,
    @Host							varchar(20),
    @Cluster						varchar(20),
    @ContMoneda						varchar(10),
    @ContMonedaTC					float,
    @Expresion						varchar(255),
    @Renglon						float,
    @RenglonID						int,
    @RenglonD						float, 
    @RenglonIDD						int, 
    @RenglonTipo					varchar(1), 
    @Cantidad						float,      
    @CantidadObsequio				float,      
    @Articulo						varchar(20), 
    @SubCuenta						varchar(50), 
    @Precio							float, 
    @PrecioSugerido					float, 
    @DescuentoLinea					float, 
    @Impuesto1						float, 
    @Impuesto2						float, 
    @Impuesto3						float, 
    @Unidad							varchar(20),    
    @Factor							float,  
    @Puntos							float, 
    @PrecioImpuestoInc				float, 
    @Almacen						varchar(20),
    @AlmacenE						varchar(20),
    @Moneda							varchar(10), 
    @Importe						float, 
    @Impuestos						float,  
    @TipoCambio						float,
    @CtaDinero						varchar(10),
    @CtaDineroDestino				varchar(10),
    @Caja							varchar(10),
    @Cajero							varchar(10),
    @Agente							varchar(10),
    @Codigo							varchar(30),
    @EsMonedero						bit,
    @ArtTarjetaServicio				varchar(20),
    @RenglonIDMonederoDev			bit,
    @SugerirFechaCierre				bit,
    @FechaCierre					datetime,
	@EsError						bit,
	@Imagen							varchar(255)
    
    
	DECLARE @VentaDetalle table(
		Renglon				float, 
		RenglonID			int, 
		RenglonTipo			varchar(1), 
		Cantidad			float,      
		CantidadObsequio    float,      
		Articulo			varchar(20), 
		SubCuenta			varchar(50), 
		Precio				float, 
		PrecioSugerido		float,  
		DescuentoLinea		float, 
		Impuesto1			float, 
		Impuesto2			float, 
		Impuesto3			float, 
		Unidad				varchar(20), 
		Factor				float,  
		Puntos				float, 
		PrecioImpuestoInc	float, 
		Almacen				varchar(20), 
		Codigo				varchar(30), 
		EsMonedero			bit)

	DECLARE @Cobro table(
		FormaPago			varchar(50), 
		Importe				float,      
		Referencia			varchar(50), 
		Monedero			varchar(50), 
		CtaDinero			varchar(10), 
		Fecha				datetime,  
		Caja				varchar(10),  
		Cajero				varchar(10), 
		Host				varchar(20), 
		ImporteRef			float,      
		TipoCambio			float, 
		Voucher				varchar(max), 
		Banco				varchar(255), 
		MonedaRef			varchar(10), 
		CtaDineroDestino	varchar(10),
		MonederoMoneda		varchar(10),
		MonederoTipoCambio	float,
		MonederoImporte		float)

	DECLARE @SerieLote table(
		RenglonID		int, 
		Articulo		varchar(20), 
		SubCuenta		varchar(50), 
		SerieLote		varchar(50)) 
  
	SELECT @MovCFD = MovFactura, @CodigoRedondeo = RedondeoVentaCodigo 
	  FROM POSCfg 
	 WHERE Empresa = @Empresa    
  
	SELECT @ArticuloRedondeo = Cuenta 
	  FROM CB 
	 WHERE Codigo = @CodigoRedondeo AND TipoCuenta = 'Articulos' 
  
	SELECT @VentaPreciosImpuestoIncluido = ISNULL(VentaPreciosImpuestoIncluido,0), 
		   @ArticuloTarjeta= CxcArticuloTarjetasDef, 
		   @AlmacenTarjeta= CxcAlmacenTarjetasDef, 
		   @ArtTarjetaServicio = ArtTarjetaServicio  
	  FROM EmpresaCfg 
	 WHERE Empresa = @Empresa  
  
	SELECT @SugerirFechaCierre = SugerirFechaCierre   
	  FROM POSCfg 
	 WHERE Empresa = @Empresa

	SELECT @IDFact = NEWID(), @IDNuevo = NULL, @EsError = 0
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
  
	IF NOT EXISTS(SELECT * FROM ListaSt l JOIN POSL p ON p.Mov+' '+p.MovID = l.Clave AND p.Empresa = @Empresa AND p.Facturado = 0 WHERE l.Estacion = @Estacion )
		SELECT @Ok = -1 , @OkRef = 'No Hay Nada Que Afectar'
  
	SELECT @Agente = Agente 
	  FROM Cte 
	 WHERE Cliente = @Cliente            
	
	SELECT TOP 1 @Moneda = Moneda, @AlmacenE = Almacen  ,@TipoCambio = TipoCambio 
	  FROM POSL 
	 WHERE Empresa = @Empresa AND Mov+' '+MovID IN(SELECT Clave FROM ListaSt WHERE Estacion = @Estacion) ORDER BY FechaRegistro
  
	SELECT @Importe = SUM(Importe), @Impuestos = SUM(Impuestos) 
	  FROM POSL 
	 WHERE Empresa = @Empresa AND Mov+' '+MovID IN(SELECT Clave FROM ListaSt WHERE Estacion = @Estacion)  
  
	SELECT @CtaDinero = DefCtaDinero,
		   @Caja = DefCtaDinero,
		   @Cajero = DefCajero,
		   @CtaDineroDestino = DefCtaDineroTrans --EAS
      FROM Usuario
	 WHERE Usuario = @Usuario  
	
	SELECT @FechaCierre = dbo.fnPOSFechaCierre(@Empresa,@Sucursal,@FechaCierre,@Caja)  
  
	SELECT @ContMoneda = ec.ContMoneda
      FROM EmpresaCfg ec	  
	 WHERE ec.Empresa = @Empresa   
   
	SELECT @ContMonedaTC = TipoCambio 
	  FROM POSLTipoCambioRef 
	 WHERE Sucursal = @Sucursal AND Moneda = @ContMoneda   
  
	SELECT @Fecha = CASE WHEN @SugerirFechaCierre = 1 THEN ISNULL(@FechaCierre,GETDATE()) ELSE dbo.fnFechaSinHora(GETDATE()) END     
  
	BEGIN TRANSACTION
	
	SELECT @Renglon = 2048.0, @RenglonID = 1
	DECLARE crPOS CURSOR local FOR
	 SELECT p.ID 
       FROM ListaSt l JOIN POSL p ON p.Mov+' '+p.MovID = l.Clave AND p.Empresa = @Empresa
      WHERE l.Estacion = @Estacion 
	    AND p.Facturado = 0
	   OPEN crPOS  
	FETCH NEXT FROM crPOS INTO @IDPOS
	WHILE @@FETCH_STATUS = 0  AND @Ok IS NULL
	BEGIN
		SELECT @IDDev = NEWID()
		IF @Ok IS  NULL
		BEGIn
			INSERT POSL (
				ID, Empresa, Mov, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Importe, Impuestos, Usuario, Referencia,
				Estatus, Observaciones, Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal,
				Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, Origen, OrigenID, Host, Cluster, Nombre, 
				Direccion, DireccionNumero, DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, Estado, Pais, Zona, CodigoPostal,
				RFC, CURP, Modulo, Cajero, CtaDineroDestino, Directo, Caja, PedidoReferencia, PedidoReferenciaID, IDR, FechaNacimiento, EstadoCivil,
				Conyuge, Sexo, Fuma, Profesion, Puesto, NumeroHijos, Religion)
			SELECT
				@IDDev, Empresa, Mov, @Fecha, GETDATE(), Concepto, Proyecto, UEN, Moneda, TipoCambio, (Importe*-1), (Impuestos*-1), @Usuario, Referencia,
				Estatus, Observaciones, Cliente, EnviarA, Almacen, @Agente, FormaEnvio, Condicion, Vencimiento, @CtaDinero, Descuento, DescuentoGlobal,
				Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, @Sucursal, OrigenTipo, Origen, OrigenID, @Host, @Cluster, Nombre, 
				Direccion, DireccionNumero, DireccionNumeroInt, EntreCalles, Delegacion, Colonia, Poblacion, Estado, Pais, Zona, CodigoPostal, 
				RFC, CURP, Modulo, @Cajero, @CtaDineroDestino, Directo, @Caja, PedidoReferencia, PedidoReferenciaID, @IDPOS, FechaNacimiento, EstadoCivil,
				Conyuge, Sexo, Fuma, Profesion, Puesto, NumeroHijos, Religion
			FROM POSL
			WHERE ID = @IDPOS 
      
			IF @@ERROR <> 0 SET @Ok = 1
            
			IF @Ok IS NULL
				INSERT POSLVenta(
					ID, Renglon, RenglonID, Aplica, AplicaID, RenglonTipo, Cantidad, CantidadObsequio, Articulo, SubCuenta, Precio, 
					PrecioSugerido, DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, Puntos,PrecioImpuestoInc, Almacen, 
					Aplicado, Codigo, EsMonedero)
				SELECT
					@IDDev, Renglon, RenglonID, Aplica, AplicaID, RenglonTipo, (Cantidad*-1), (CantidadObsequio*-1), Articulo, SubCuenta, Precio, 
					PrecioSugerido, DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor,  Puntos,PrecioImpuestoInc, Almacen, 
					1, Codigo, EsMonedero
				FROM POSLVenta 
				WHERE ID = @IDPOS  
      
			IF @@ERROR <> 0 SET @Ok = 1  
            
			IF EXISTS(SELECT * FROM POSLSerieLote WHERE ID = @IDPOS)
			BEGIN
				INSERT POSLSerieLote(ID, RenglonID, Articulo, SubCuenta, SerieLote)
				SELECT @IDDev, RenglonID, Articulo, ISNULL(SubCuenta,''), SerieLote
				  FROM POSLSerieLote 
				 WHERE ID = @IDPOS
				 ORDER BY Orden       
			END      
		
			IF EXISTS(SELECT * FROM POSLCobro WHERE ID = @IDPOS)
			BEGIN    
				INSERT POSLCobro(ID, FormaPago, Importe, Referencia, Monedero, CtaDinero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio, 
								 Voucher, Banco, MonedaRef, CtaDineroDestino, MonederoMoneda, MonederoTipoCambio, MonederoImporte)
				SELECT @IDDev, FormaPago, (Importe*-1), Referencia, Monedero, @CtaDinero, Fecha,  @Caja,  @Cajero, Host, (ImporteRef*-1), TipoCambio, 
								 Voucher, Banco, MonedaRef, @CtaDineroDestino, MonederoMoneda, MonederoTipoCambio, (MonederoImporte*-1)
				  FROM POSLCobro 
				 WHERE ID = @IDPOS                
			END  
      
			IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @IDPOS AND ISNULL(EsMonedero,0) = 1)
			BEGIN
				SELECT @RenglonIDMonederoDev = RenglonID 
				  FROM POSLVenta  
				 WHERE  ID = @IDPOS AND ISNULL(EsMonedero,0) = 1
								
				UPDATE POSLVenta SET Articulo = @ArtTarjetaServicio, RenglonTipo = 'N'
				 WHERE  ID = @IDDev AND ISNULL(EsMonedero,0) = 1       
				DELETE POSLSerieLote WHERE ID = @IDDev AND RenglonID = @RenglonIDMonederoDev
			END      
      
			SELECT @MovDev = Mov 
			  FROM POSL 
			 WHERE ID = @IDDev
						
			SELECT @MovDev = ISNULL(NULLIF(POSDefMovDev,''),@MovDev) 
			  FROM POSCfg 
			 WHERE Empresa = @Empresa
      
			IF @Ok IS NULL
			BEGIN
				EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @MovDev, @MovIDDev OUTPUT, @Prefijo OUTPUT, 
										  @Consecutivo OUTPUT, @noAprobacion OUTPUT, @FechaAprobacion OUTPUT, 
										  @Ok OUTPUT, @OkRef OUTPUT

				UPDATE POSL SET Mov =  @MovDev,
								MovID =  @MovIDDev,
								Prefijo = ISNULL(Prefijo, @Prefijo),
								Consecutivo = ISNULL(Consecutivo, @Consecutivo),
								noAprobacion = ISNULL(noAprobacion, @NoAprobacion),
								fechaAprobacion = ISNULL(fechaAprobacion, @fechaAprobacion),
								Estatus = 'CONCLUIDO',
								FechaEmision = dbo.fnFechaSinHora(@Fecha),
								FechaRegistro = GETDATE()
				 WHERE ID = @IDDev 
			END                
		END    
    
		IF @Ok IS NULL
		BEGIN
			DECLARE crDetalle CURSOR LOCAL FOR   
			 SELECT pv.Renglon, 
					pv.RenglonID, 
					pv.RenglonTipo, 
					pv.Cantidad, 
					pv.CantidadObsequio, 
			        CASE WHEN ISNULL(pv.EsMonedero,0) = 1  THEN @ArtTarjetaServicio ELSE pv.Articulo END, 
					pv.SubCuenta, 
					pv.Precio, 
					pv.PrecioSugerido, 
					CASE WHEN ISNULL(p.DescuentoGlobal,0) <> 0 THEN 1 - ((1-ISNULL(pv.DescuentoLinea,0)) *(1-ISNULL(p.DescuentoGlobal,0))) ELSE  pv.DescuentoLinea END, 
					pv.Impuesto1, 
					pv.Impuesto2, 
					pv.Impuesto3, 
					pv.Unidad, 
					pv.Factor, 
					pv.Puntos,
					pv.PrecioImpuestoInc, 
					pv.Almacen, 
					pv.Codigo, 
					ISNULL(pv.EsMonedero,0)
			   FROM POSLVenta pv
			   JOIN POSL p ON pv.ID = p.ID
			  WHERE p.ID = @IDPOS
			   OPEN crDetalle
			FETCH NEXT FROM crDetalle INTO @RenglonD, @RenglonIDD, @RenglonTipo, @Cantidad, @CantidadObsequio, @Articulo, @SubCuenta, @Precio, 
											@PrecioSugerido, @DescuentoLinea, @Impuesto1, @Impuesto2, @Impuesto3, @Unidad, @Factor,  @Puntos, 
											@PrecioImpuestoInc, @Almacen, @Codigo, @EsMonedero
			WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
			BEGIN
				INSERT @VentaDetalle(Renglon, RenglonID, RenglonTipo, Cantidad, CantidadObsequio, Articulo, SubCuenta, Precio, PrecioSugerido, 
									DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, Puntos, PrecioImpuestoInc, Almacen, Codigo, 
									EsMonedero)
				SELECT				@Renglon, @RenglonID, @RenglonTipo, @Cantidad, @CantidadObsequio, @Articulo, @SubCuenta, @Precio, @PrecioSugerido, @DescuentoLinea,
									@Impuesto1, @Impuesto2, @Impuesto3, @Unidad, @Factor,  @Puntos, @PrecioImpuestoInc, @Almacen,@Codigo, 
									@EsMonedero
        
				IF @@ERROR <> 0 SET @Ok = 1 
        
				IF @Ok IS NULL AND EXISTS(SELECT * FROM POSLSerieLote WHERE ID = @IDPOS AND RenglonID = @RenglonIDD)
				BEGIN
					INSERT @SerieLote(RenglonID,  Articulo, SubCuenta, SerieLote)
					SELECT			  @RenglonID, Articulo, SubCuenta, SerieLote
					  FROM POSLSerieLote 
					 WHERE ID = @IDPOS AND RenglonID = @RenglonIDD 
          
					IF @@ERROR <> 0 SET @Ok = 1  
				END 
        
				IF ISNULL(@EsMonedero,0)=1
					DELETE @SerieLote WHERE RenglonID = @RenglonID
        
				SELECT  @Renglon = @Renglon +2048.0, @RenglonID = @RenglonID +1      
        
			FETCH NEXT FROM crDetalle INTO  @RenglonD, @RenglonIDD, @RenglonTipo, @Cantidad, @CantidadObsequio, @Articulo, @SubCuenta, @Precio, 
											@PrecioSugerido, @DescuentoLinea, @Impuesto1, @Impuesto2, @Impuesto3, @Unidad, @Factor,  @Puntos, 
											@PrecioImpuestoInc, @Almacen, @Codigo, @EsMonedero
			END
			CLOSE crDetalle
			DEALLOCATE crDetalle        
		END
    
		IF @Ok IS NULL
		BEGIN
			INSERT @Cobro (FormaPago, Importe, Referencia, Monedero, CtaDinero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio, Voucher, Banco, 
							MonedaRef, CtaDineroDestino, MonederoMoneda, MonederoTipoCambio, MonederoImporte)
			SELECT		   FormaPago, Importe, Referencia, Monedero, @CtaDinero, Fecha, @Caja, @Cajero, Host, ImporteRef, TipoCambio, Voucher, Banco, 
							MonedaRef, @CtaDineroDestino, MonederoMoneda, MonederoTipoCambio, MonederoImporte
			  FROM  POSLCobro
			 WHERE ID = @IDPOS 
		END

	FETCH NEXT FROM crPOS INTO @IDPOS
	END
	CLOSE crPOS
	DEALLOCATE crPOS    
  
	IF @MovFact IS NOT NULL AND @Ok IS NULL
	BEGIN
		INSERT POSL (
				ID, Empresa, Mov, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, Importe, Impuestos, TipoCambio, Usuario, Referencia, Estatus,
				Observaciones, Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Causa, Atencion,
				AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, OrigenTipo, Origen, OrigenID, Host, Cluster, Modulo, Cajero, CtaDineroDestino, 
				Directo, Caja, PedidoReferencia, PedidoReferenciaID, IDR)
		SELECT
				@IDFact, @Empresa, @MovFact, @Fecha, GETDATE(), NULL, NULL, NULL, @Moneda, @Importe, @Impuestos, @TipoCambio, @Usuario, NULL, 'CONCLUIDO', 
				NULL, @Cliente, NULL, @AlmacenE, @Agente, NULL, NULL, NULL, @CtaDinero, NULL, NULL, NULL, NULL, 
				NULL, NULL, NULL, @Sucursal, NULL, NULL, NULL, @Host, @Cluster, 'VTAS', @Cajero, NULL, 
				1, @Caja, NULL, NULL, NULL

		IF @@ERROR <> 0 SET @Ok = 1
    
		IF @Ok IS NULL
			INSERT POSLVenta(ID, Renglon, RenglonID, RenglonTipo, Cantidad, CantidadObsequio, Articulo, SubCuenta, Precio, PrecioSugerido, DescuentoLinea, 
							Impuesto1, Impuesto2, Impuesto3, Unidad, Factor,  Puntos,PrecioImpuestoInc, Almacen, Aplicado, Codigo)
			SELECT			@IDFact, Renglon, RenglonID, RenglonTipo, Cantidad, CantidadObsequio, Articulo, SubCuenta, Precio, PrecioSugerido, DescuentoLinea, 
							Impuesto1, Impuesto2, Impuesto3, Unidad, Factor,  Puntos,PrecioImpuestoInc, Almacen, 1, Codigo
			  FROM @VentaDetalle 
    
		IF @@ERROR <> 0 SET @Ok = 1  
    
		IF EXISTS(SELECT * FROM POSLSerieLote WHERE ID = @IDPOS)
			INSERT POSLSerieLote(ID, RenglonID, Articulo, SubCuenta, SerieLote)
			SELECT				 @IDFact, RenglonID, Articulo, ISNULL(SubCuenta,''), SerieLote
			  FROM @SerieLote    
			
		IF EXISTS(SELECT * FROM POSLCobro WHERE ID = @IDPOS)
			INSERT POSLCobro( ID, FormaPago, Importe, Referencia, Monedero, CtaDinero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio, 
							Voucher, Banco, MonedaRef, CtaDineroDestino, MonederoMoneda, MonederoTipoCambio, MonederoImporte)
			SELECT			@IDFact, FormaPago, SUM(Importe), Referencia, Monedero, @CtaDinero, Fecha,  @Caja,  @Cajero, @Host, SUM(ImporteRef), TipoCambio, 
							NULL, Banco, MonedaRef, CtaDineroDestino, MonederoMoneda, MonederoTipoCambio, sum(isnull(MonederoImporte,0))
			  FROM @Cobro   
			 GROUP BY FormaPago, Referencia, Monedero, CtaDinero, Fecha, TipoCambio, Banco, MonedaRef, CtaDineroDestino, MonederoMoneda, MonederoTipoCambio

		IF @Ok IS NULL
			EXEC spPOSInsertaCliente2 @Empresa, @IDFact, NULL, @CtaDinero, @Cliente, @Estacion, @Imagen OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @EsFactura = 1 
    
		IF @Ok IS NULL
			EXEC spPOS @Estacion, NULL, @Empresa, 'VTAS', @Sucursal, @Usuario,  NULL, @IDFact, NULL, NULL, NULL, 0, NULL, NULL, @EnSilencio = 1
      
		IF @Ok IS NULL
		BEGIN
			EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @MovFact, @MovIDFact OUTPUT, @Prefijo OUTPUT, @Consecutivo OUTPUT, 
									  @noAprobacion OUTPUT, @FechaAprobacion OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
                   
			UPDATE POSL SET MovID =  @MovIDFact,
							Prefijo = ISNULL(Prefijo, @Prefijo),
							Consecutivo = ISNULL(Consecutivo, @Consecutivo),
							noAprobacion = ISNULL(noAprobacion, @NoAprobacion),
							fechaAprobacion = ISNULL(fechaAprobacion, @fechaAprobacion),
							Estatus = 'CONCLUIDO',
							FechaEmision = dbo.fnFechaSinHora(@Fecha),
							FechaRegistro = GETDATE()
			 WHERE ID = @IDFact 
		END       
	END 
  
	IF NULLIF(@MovCFD,'') IS NOT NULL AND @Ok IS NULL AND @IDFact IS NOT NULL
	BEGIN
		INSERT Venta (
				Empresa, Mov, MovID, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, 
				Usuario, Referencia, Estatus, Observaciones, Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, 
				Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, 
				Sucursal, OrigenTipo, Origen, OrigenID, ReferenciaOrdenCompra, GenerarDinero, SucursalOrigen, Directo, Ejercicio, Periodo)
		SELECT
				p.Empresa, @MovCFD, NULL, @Fecha, GETDATE(), p.Concepto, p.Proyecto, p.UEN, p.Moneda, CASE WHEN p.Moneda <> @ContMoneda THEN  (p.TipoCambio/@ContMonedaTC) ELSE p.TipoCambio END, 
				p.Usuario, p.Referencia, 'SINAFECTAR', p.Observaciones, p.Cliente, p.EnviarA, p.Almacen, p.Agente, p.FormaEnvio, p.Condicion, 
				p.Vencimiento, p.CtaDinero, p.Descuento, 0.0, p.Causa, p.Atencion, p.AtencionTelefono, p.ListaPreciosEsp, p.ZonaImpuesto, 
				p.Sucursal, 'POS', p.Mov, p.MovID, @IDFact, 0, p.Sucursal, 1, DATEPART(YEAR,p.FechaEmision), DATEPART(MONTH,p.FechaEmision)
		  FROM POSL p
		 WHERE p.ID = @IDFact  		      
    
		IF @@ERROR <> 0 SET @Ok = 1
    
		SELECT @IDNuevo = SCOPE_IDENTITY()	
      
		INSERT VentaD ( ID,		  Renglon,		RenglonID,		Aplica,		AplicaID,	RenglonTipo,	 Cantidad,		CantidadObsequio,		
						Almacen, 
						EnviarA,	Articulo,		SubCuenta,		Precio,	
						DescuentoLinea,	
						Impuesto1,		Impuesto2,		Impuesto3,		Unidad,		Factor,		Sucursal,	Puntos, 
						POSDesGlobal,																					POSDesLinea, Codigo)

		SELECT			@IDNuevo, pmv.Renglon,	pmv.RenglonID,	NULL,		NULL,		pmv.RenglonTipo, pmv.Cantidad,	pmv.CantidadObsequio,	
						CASE WHEN pmv.Articulo= @ArticuloTarjeta THEN ISNULL(p.Almacen,@AlmacenTarjeta) ELSE ISNULL(pmv.Almacen,p.Almacen) END, 
						p.EnviarA,	pmv.Articulo,	pmv.SubCuenta,	CASE WHEN @VentaPreciosImpuestoIncluido = 1 THEN pmv.PrecioImpuestoInc ELSE pmv.Precio END,	
						dbo.fnPOSCalcDescuentosVenta(CASE WHEN ISNULL(pmv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END, pmv.DescuentoLinea), 
						pmv.Impuesto1,	pmv.Impuesto2,	pmv.Impuesto3,	pmv.Unidad, pmv.Factor,	@Sucursal,	pmv.Puntos, 
						CASE WHEN ISNULL(pmv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END,	ISNULL(pmv.DescuentoLinea,0.0), pmv.Codigo
		  FROM POSLVenta pmv 
		  JOIN POSL p ON pmv.ID = p.ID
		 WHERE pmv.ID = @IDFact
		   AND ISNULL(pmv.precio,0.0) <> 0.0
    
		IF @@ERROR <> 0 SET @Ok = 1   

		EXEC spPOSInsertarPOSVentaCobro @IDFact, @Empresa,@Sucursal, @Ok OUTPUT, @OkRef OUTPUT     
    
		IF EXISTS(SELECT 1 FROM POSLSerieLote pls WHERE pls.ID = @IDFact)
			INSERT SerieLoteMov (Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal)
			SELECT @Empresa, 'VTAS', @IDNuevo, pls.RenglonID, pls.Articulo, ISNULL(pls.SubCuenta, ''), pls.SerieLote, COUNT(*),  @Sucursal  
			  FROM POSLSerieLote pls
			 WHERE pls.ID = @IDFact
			 GROUP BY Articulo, ISNULL(SubCuenta,''), SerieLote, RenglonID       
  
		IF @Ok IS NULL AND @IDNuevo IS NOT NULL
			EXEC spAfectar 'VTAS', @IDNuevo, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @ok OUTPUT, @OkRef = @OkRef OUTPUT
   
		IF @Ok IS NULL AND EXISTS(SELECT * FROM CFD WHERE Modulo = 'VTAS' AND ModuloID = @IDNuevo)
		BEGIN
			SELECT @CadenaOriginal = cfd.CadenaOriginal, 
				   @Certificado = cfd.noCertificado, 
				   @Sello = cfd.Sello, 
				   @DocumentoXML = cfd.Documento, 
				   @MovIDCFD = cfd.MovID, 
				   @UUID = cfd.UUID, 
				   @FechaTimbrado = cfd.FechaTimbrado, 
				   @SelloSat = cfd.SelloSat, 
				   @TFDVersion = cfd.TFDVersion  , 
				   @NoCertificadoSAT = cfd.NoCertificadoSAT, 
				   @TFDCadenaOriginal = cfd.TFDCadenaOriginal	     
			  FROM CFD cfd
			 WHERE cfd.Modulo = 'VTAS' 
			   AND cfd.ModuloID = @IDNuevo
       
			IF @Ok IS NULL
				UPDATE POSL SET CadenaOriginal = @CadenaOriginal, 
								Sello = @Sello, 
								Certificado = @Certificado, 
								DocumentoXML = @DocumentoXML, 
								FechaSello = @FechaSello, 
								Origen = @MovCFD, 
								OrigenID = @MovIDCFD, 
								UUID = @UUID, 
								FechaTimbrado = @FechaTimbrado, 
								SelloSat = @SelloSat, 
								TFDVersion = @TFDVersion, 
								NoCertificadoSAT = @NoCertificadoSAT, 
								TFDCadenaOriginal = @TFDCadenaOriginal
				 WHERE ID = @IDFact         
		END
	END
  
	IF @Ok IS NULL
		UPDATE POSL SET Facturado = 1 WHERE Empresa = @Empresa AND Mov+' '+MovID IN(SELECT Clave FROM ListaSt WHERE Estacion = @Estacion)
    
	IF @Ok IS NULL
	BEGIN
		COMMIT TRANSACTION
			
		SELECT @Expresion = 'FormaModal('+CHAR(39)+'POSFacturarNotas'+CHAR(39)+')'   
		SELECT @OkRef = ' Se Genero '+@MovFact+' '+@MovIDFact    
	END 
	ELSE
	BEGIN
		ROLLBACK TRANSACTION

		SELECT @OkRef = Descripcion+' '+RTRIM(ISNULL(@OkRef,'')) 
		  FROM MensajeLista
		 WHERE Mensaje = @Ok  
		--SELECT @Expresion= 'ERROR('+CHAR(39)+@OkRef+CHAR(39)+')' 
		SELECT @Expresion = @OkRef
		SET @EsError = 1 
	END
  
	SELECT @OkRef, @Expresion, @IDFact, @IDNuevo, @MovCFD, @MovIDCFD, @EsError
  
	RETURN 
END
GO


/**************** spPOSGenerarCFDFlexLote ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSGenerarCFDFlexLote') AND type = 'P') DROP PROCEDURE dbo.spPOSGenerarCFDFlexLote
GO             
CREATE PROCEDURE spPOSGenerarCFDFlexLote
	@Estacion           int,
	@Empresa            varchar(5)	  
--//WITH ENCRYPTION  
AS 
BEGIN
	DECLARE
    @Modulo					varchar(5), 
    @ID						int, 
    @Estatus				varchar(15) ,
    @Ok						int,
    @OkRef					varchar(255),
    @MovIDCFD				varchar(20),
    @UUID					varchar(50),
    @FechaTimbrado			datetime,
    @SelloSat				varchar(255),
    @TFDVersion				varchar(10),
    @NoCertificadoSAT		varchar(20),
    @TFDCadenaOriginal		varchar(max),
    @CadenaOriginal			varchar(max),
    @Sello					varchar(255),
    @Certificado			varchar(20),
    @DocumentoXML			varchar(max), 
    @FechaSello				datetime,   
    @IDPOS					varchar(50)
  
	DECLARE crCFDTemp CURSOR LOCAL FOR
    SELECT Empresa, Modulo, ID, Estatus, IDPOS 
    FROM POSCFDFlexPendiente
    WHERE ID IN(SELECT ID FROM LISTAID WHERE Estacion = @Estacion) 
    
	OPEN crCFDTemp
	FETCH NEXT FROM crCFDTemp INTO @Empresa, @Modulo, @ID, @Estatus,@IDPOS 
	WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
		BEGIN
			EXEC spCFDFlex @Estacion, @Empresa, @Modulo, @ID, @Estatus, @Ok OUTPUT, @OkRef OUTPUT
    
			IF @Ok IS NULL
				BEGIN
					SELECT 
						@CadenaOriginal = cfd.CadenaOriginal,
    					@Certificado = cfd.noCertificado,
						@Sello = cfd.Sello,
						@DocumentoXML = cfd.Documento,
						@MovIDCFD = cfd.MovID,
						@UUID = cfd.UUID ,       
						@FechaTimbrado = cfd.FechaTimbrado,
						@SelloSat = cfd.SelloSat,      
						@TFDVersion = cfd.TFDVersion  ,  
						@NoCertificadoSAT = cfd.NoCertificadoSAT,
						@TFDCadenaOriginal = cfd.TFDCadenaOriginal	     
					FROM CFD cfd
					WHERE cfd.Modulo = 'VTAS' AND cfd.ModuloID = @ID  
         
					UPDATE POSL SET 
						Estatus = 'CONCLUIDO', 
						CadenaOriginal = @CadenaOriginal, 
						Sello = @Sello, 
						Certificado = @Certificado, 
						DocumentoXML = @DocumentoXML, 
						FechaSello = @FechaSello, 
						UUID = @UUID, 
						FechaTimbrado = @FechaTimbrado, 
						SelloSat = @SelloSat, 
						TFDVersion = @TFDVersion, 
						NoCertificadoSAT = @NoCertificadoSAT, 
						TFDCadenaOriginal = @TFDCadenaOriginal
					WHERE ID = @IDPOS           
				END
    
			FETCH NEXT FROM crCFDTemp INTO @Empresa, @Modulo, @ID, @Estatus, @IDPOS 
		END  
	CLOSE crCFDTemp
	DEALLOCATE crCFDTemp  
  
	IF @Ok IS NOT NULL
		SELECT @OkRef
	ELSE
		SELECT 'PROCESO CONCLUIDO EXISTOSAMENTE'  

	RETURN
END
GO


/**************** spPOSCobroCreditoSaldoMayor ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSCobroCreditoSaldoMayor') AND type = 'P') DROP PROCEDURE dbo.spPOSCobroCreditoSaldoMayor
GO             
CREATE PROCEDURE spPOSCobroCreditoSaldoMayor
	@ID	varchar(50)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @Host			varchar(20),
    @Caja	        varchar(20),
    @Cluster		varchar(20)
    
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
	SELECT @Caja = Caja 
	FROM POSL 
	WHERE ID = @ID
  
	UPDATE POSLVenta SET Precio = 0.0
	WHERE ID = @ID
  
	UPDATE POSL SET Importe = 0.0
	WHERE ID = @ID  
  
    INSERT POSLAccion (
		Host,  Caja, Accion)
    VALUES (
		@Host, @Caja,'IMPORTE ANTICIPO' )     
END
GO


/************************ spPOSImportarDevRef *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSImportarDevRef') AND type = 'P') DROP PROCEDURE dbo.spPOSImportarDevRef
GO             
CREATE PROCEDURE spPOSImportarDevRef
	@ID                 varchar(50),
    @Estacion           int,
    @Empresa            varchar(5),
    @Sucursal           int        
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE
	@IDNuevo              varchar(36),
	@MovGenerar           varchar(20),
	@Ok                   int,
	@Host                 varchar(20),
	@Cluster              varchar(20),
	@cfgImpuestoIncluido  bit,
	@Articulo             varchar(20), 
	@SubCuenta            varchar(50), 
	@SerieLote            varchar(50), 
	@Cantidad             float,
	@CantidadS            float,
	@RenglonID            int,
	@Mov                  varchar(20), 
	@FechaEmision         datetime,
	@Cajero               varchar(10),
	@Caja                 varchar(10),
	@CtaDinero            varchar(10),
	@ArtOfertaImporte     varchar(20),
	@TotalImporte         float,
	@TotalImpuesto2       float,
	@TotalImpuesto1       float,
	@RedondeoMonetarios   float,
	@TipoCambioMov        float,
	@IDOferta             int,
	@CantidadOferta       float,
	@CantidadMoneda       float,
	@PorcentajeOferta     float,
	@MonedaOferta         varchar(10),
	@ImporteOferta        float,
	@TipoCambio           float,
	@TotalImporteO        float
  
	SELECT  @ArtOfertaImporte = ArtOfertaImporte
    FROM POSCfg 
	WHERE Empresa = @Empresa 
    
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)	     

	SELECT @Mov = Mov, @FechaEmision = FechaEmision, @Cajero = Cajero, @Caja = Caja, @CtaDinero = CtaDinero
    FROM POSL 
	WHERE ID = @ID
    
	IF EXISTS(SELECT * FROM POSVentaPedidoDTemp2   WHERE Estacion = @Estacion  AND CantidadAplicar >0.0 )
		BEGIN
			DELETE POSL WHERE ID = @ID
			DELETE POSLVenta  WHERE ID = @ID
			DELETE POSLSerieLote  WHERE ID = @ID

			INSERT POSL (
				ID, Empresa, Modulo, Mov, FechaEmision, FechaRegistro, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, Estatus, Observaciones,
				Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Causa, Atencion, AtencionTelefono,
				ListaPreciosEsp,  ZonaImpuesto,  Sucursal,           OrigenTipo,  Origen,  OrigenID, Host,   Cluster, Cajero,   Importe, Impuestos, Caja, Monedero)
			SELECT
				@ID, Empresa, 'VTAS', @Mov, @FechaEmision, GETDATE(), Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, 'SINAFECTAR', Observaciones,
				Cliente, EnviarA, Almacen, Agente, FormaEnvio, Condicion, Vencimiento, @CtaDinero, Descuento, DescuentoGlobal, Causa, Atencion, AtencionTelefono,
				ListaPreciosEsp, ZonaImpuesto, SucursalOrigen, NULL, NULL, NULL, @Host, @Cluster, @Cajero, Importe, Impuestos, @Caja, Monedero
			FROM POSVentaPedidoTemp
			WHERE Estacion = @Estacion
    
			IF @@ERROR <> 0 
				SET @Ok = 1
    
			SELECT @Empresa = Empresa 
			FROM POSL 
			WHERE ID = @IDNuevo
			
			SELECT @cfgImpuestoIncluido = ISNULL(VentaPreciosImpuestoIncluido,0) 
			FROM EmpresaCfg 
			WHERE Empresa = @Empresa
    
			IF @Ok IS NULL
				INSERT POSLVenta(
					ID, Renglon, RenglonID, RenglonTipo, Cantidad, CantidadObsequio, Articulo, SubCuenta, 
					Precio, PrecioSugerido, DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, Puntos, 
					PrecioImpuestoInc, Codigo, Almacen, Aplicado)
				SELECT
					@ID, Renglon, RenglonID, RenglonTipo, (Cantidad*-1), (CantidadObsequio*-1), Articulo, SubCuenta, 
					CASE WHEN @cfgImpuestoIncluido = 1 
							THEN  dbo.fnPOSPrecioSinImpuestos(Precio,Impuesto1, Impuesto2, Impuesto3) 
						 ELSE Precio 
						 END, PrecioSugerido, DescuentoLinea, Impuesto1, Impuesto2, Impuesto3, Unidad, Factor, (Puntos*-1),
					CASE WHEN @cfgImpuestoIncluido = 0 
							THEN dbo.fnPOSPrecioConImpuestos(Precio,Impuesto1, Impuesto2, Impuesto3, @Empresa) 
						 ELSE Precio 
						 END, Codigo, Almacen, 1
				FROM POSVentaPedidoDTemp2 
				WHERE Estacion = @Estacion
				AND ((CantidadAplicar >0.0) OR Articulo = @ArtOfertaImporte)
		
			IF @@ERROR <> 0 
				SET @Ok = 1 
    
			IF @Ok IS NULL
				BEGIN
					SELECT @TotalImporte = SUM(dbo.fnPOSImporte(plv.Cantidad, plv.CantidadObsequio, plv.Precio, plv.DescuentoLinea, CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END, plv.Articulo, p.Empresa)),
             @TotalImpuesto2 = SUM(dbo.fnPOSImporteMov(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),plv.Impuesto1,plv.Impuesto2,plv.Impuesto3,plv.Cantidad)),
             @TotalImpuesto1 = CONVERT(money,CONVERT(varchar, CONVERT(money, ISNULL(@TotalImpuesto2,0.0)), 104))-@TotalImporte
					FROM POSL p
					INNER JOIN POSLVenta plv ON p.ID = plv.ID
					WHERE plv.ID = @ID
				
					UPDATE POSL Set Importe = ROUND(@TotalImporte,@RedondeoMonetarios), Impuestos = ROUND(@TotalImpuesto1,@RedondeoMonetarios)  WHERE ID = @ID 
				END 
    
			IF EXISTS(SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo = @ArtOfertaImporte AND RenglonTipo = 'O' AND OfertaID IS NOT NULL AND ISNULL(Puntos,0.0)<0.0)
				BEGIN
					SELECT @TotalImporteO = Importe
					FROM POSVentaPedidoTemp
					WHERE Estacion = @Estacion        
            
					SELECT @TipoCambioMov = TipoCambio 
					FROM POSL 
					WHERE ID = @ID
						
					SELECT @IDOferta = OfertaID 
					FROM POSLVenta 
					WHERE ID = @ID AND Articulo = @ArtOfertaImporte AND RenglonTipo = 'O' 
  
					SELECT @ImporteOferta = Importe, @CantidadOferta = Cantidad, @PorcentajeOferta = Porcentaje, @CantidadMoneda=Moneda
					FROM  OfertaD 
					WHERE ID = @IDOferta AND Articulo = @ArtOfertaImporte

					SELECT @TipoCambio = TipoCambio 
					FROM POSLTipoCambioRef 
					WHERE Moneda = @MonedaOferta AND Sucursal = @Sucursal 
    
					SELECT @ImporteOferta =  ((@ImporteOferta/ISNULL(@TipoCambio,1.0))*(ISNULL(@TipoCambioMov,1.0)))
    
					IF @ImporteOferta <= (ISNULL(@TotalImporteO,0.0)-ISNULL(@TotalImporte,0.0))
						DELETE POSLVenta WHERE ID = @ID AND Articulo = @ArtOfertaImporte AND RenglonTipo = 'O' AND OfertaID IS NOT NULL AND ISNULL(Puntos,0.0)<0.0    
				END        
    
			IF @OK IS NULL AND EXISTS(SELECT * FROM POSVentaPedidoSerieloteTemp WHERE Estacion = @Estacion)
				BEGIN
					DECLARE crArticulo CURSOR FOR
					SELECT Articulo, SubCuenta, SerieLote, ISNULL(Cantidad,0.0), RenglonID
					FROM POSVentaPedidoSerieloteTemp
					WHERE Estacion = @Estacion
      
					OPEN crArticulo
					FETCH NEXT FROM crArticulo INTO @Articulo, @SubCuenta, @SerieLote, @Cantidad, @RenglonID
					WHILE @@FETCH_STATUS = 0 
						BEGIN 
							SELECT @CantidadS = @Cantidad
							WHILE @CantidadS >0
								BEGIN
									INSERT POSLSerieLote (
										ID, RenglonID,  Articulo,  SubCuenta,  SerieLote)
									SELECT
										@ID, @RenglonID, @Articulo, @SubCuenta, @SerieLote
										
									SET @CantidadS = @CantidadS -1
								END
        
							FETCH NEXT FROM crArticulo INTO @Articulo, @SubCuenta, @SerieLote, @Cantidad, @RenglonID
						END 
					CLOSE crArticulo
					DEALLOCATE crArticulo   
				END 
		END  
END
GO


 /************************ spPOSImportarDevRefLocal *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSImportarDevRefLocal') AND type = 'P') DROP PROCEDURE dbo.spPOSImportarDevRefLocal
GO             
CREATE PROCEDURE spPOSImportarDevRefLocal
	@ID                 varchar(50),
    @IDOrigen           varchar(50),
    @Estacion           int,
    @Sucursal           int,
    @Ok                 int OUTPUT,
    @OkRef              varchar(255) OUTPUT            
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE
	@MovGenerar						varchar(20),
	@Host							varchar(20),
	@Cluster						varchar(20),
	@Empresa						varchar(5),
	@cfgImpuestoIncluido			bit,
	@Articulo						varchar(20), 
	@SubCuenta						varchar(50), 
	@SerieLote						varchar(50), 
	@Cantidad						float,
	@CantidadS						float,
	@RenglonID						int,
	@Mov							varchar(20), 
	@FechaEmision					datetime,
	@Cajero							varchar(10),
	@Caja							varchar(10),
	@CtaDinero						varchar(10),
	@ArtOfertaFP					varchar(20),
	@CodigoRedondeo					varchar(30),
	@ArticuloRedondeo				varchar(20),
	@CfgAnticipoArticuloServicio	varchar(20)
  
	SELECT @Mov = Mov, @FechaEmision = FechaEmision, @Cajero = Cajero, @Caja = Caja, @CtaDinero = CtaDinero, @Empresa = Empresa
    FROM POSL 
	WHERE ID = @ID
 
	SELECT @CodigoRedondeo = RedondeoVentaCodigo , @ArtOfertaFP = ArtOfertaFP
    FROM POSCfg 
	WHERE Empresa = @Empresa
    
	SELECT @ArticuloRedondeo = Cuenta
    FROM CB
	WHERE Codigo = @CodigoRedondeo
	AND TipoCuenta = 'Articulos'

	SELECT @ArticuloRedondeo = cb.Cuenta 
	FROM CB 
	WHERE CB.Cuenta = @CodigoRedondeo AND CB.TipoCuenta = 'Articulos'  
  
	SELECT @CfgAnticipoArticuloServicio = NULLIF(CxcAnticipoArticuloServicio,'')    
	FROM EmpresaCfg2
	WHERE Empresa = @Empresa    
  
	DELETE POSVentaPedidoTemp  WHERE Estacion = @Estacion  
	DELETE POSVentaPedidoDTemp2  WHERE Estacion = @Estacion  
	DELETE POSVentaPedidoSerieloteTemp WHERE Estacion = @Estacion
  
    IF EXISTS(SELECT *  FROM POSLVenta WHERE ID = @IDOrigen AND Articulo IN(@ArtOfertaFP)) 
		SELECT @Ok = 30465
    
	IF @Ok IS NULL
		INSERT POSVentaPedidoTemp(
			Estacion, ID, Empresa, Mov, MovID, FechaEmision, Concepto, Proyecto, UEN, Moneda, TipoCambio, Usuario, Referencia, Observaciones, Estatus, Cliente, 
			EnviarA, Almacen, Agente, AgenteServicio, AgenteComision, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Importe, Impuestos, 
			Saldo, DescuentoLineal, FechaRegistro, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, SucursalOrigen, Monedero)
		SELECT
			@Estacion, -1, Empresa, Mov, MovID, FechaEmision, Concepto, Proyecto, UEN, Moneda, 1, Usuario, Referencia, Observaciones, Estatus, Cliente, 
			EnviarA, Almacen, Agente, NULL, NULL, FormaEnvio, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, Importe, Impuestos, 
			NULL, NULL, FechaRegistro, Causa, Atencion, AtencionTelefono, ListaPreciosEsp, ZonaImpuesto, Sucursal, Sucursal, Monedero 
		FROM POSL
		WHERE ID = @IDOrigen
  
	IF @@ERROR <> 0 
		SET @Ok = 1
  

	IF @Ok IS NULL
		INSERT POSVentaPedidoDTemp2(
			Estacion, ID, Renglon, RenglonSub, RenglonID, RenglonTipo, Cantidad, Almacen, EnviarA, Articulo, SubCuenta, Precio, PrecioSugerido, DescuentoLinea,
			Impuesto1, Impuesto2, Impuesto3, Aplica, AplicaID, CantidadPendiente, CantidadReservada, CantidadCancelada, CantidadOrdenada, CantidadA, Unidad,
			Factor, Puntos, CantidadObsequio, OfertaID, Sucursal, 
			CantidadAplicar, Codigo, Importe)
		SELECT
			@Estacion, -1, Renglon, RenglonSub, RenglonID, RenglonTipo, Cantidad, Almacen, NULL, Articulo, SubCuenta, Precio, PrecioSugerido, DescuentoLinea,
			Impuesto1, Impuesto2, Impuesto3, Aplica, AplicaID, 0, 0, 0, 0, 0, Unidad, 
			Factor, Puntos, CantidadObsequio, OfertaID, @Sucursal, 
			0.0, Codigo, (Cantidad - ISNULL(CantidadObsequio, 0.0)) * ISNULL((Precio - (Precio * (ISNULL(DescuentoLinea,0.0)/100))),0.0)
		FROM POSLVenta 
		WHERE ID = @IDOrigen
		AND Articulo NOT IN(@CfgAnticipoArticuloServicio,@ArticuloRedondeo,@ArtOfertaFP)
  
	IF @@ERROR <> 0 
		SET @Ok = 1 
  
	IF @OK IS NULL AND EXISTS(SELECT * FROM POSLSerieLote WHERE ID = @IDOrigen)
		BEGIN
			INSERT POSVentaPedidoSerieloteTemp (
				Estacion,  ID, RenglonID,  Articulo,  SubCuenta,  SerieLote, Cantidad)
			SELECT
				@Estacion, -1, RenglonID,  Articulo,  SubCuenta,  SerieLote, 1
			FROM POSLSerieLote
			WHERE ID = @IDOrigen   
		END 
END
GO


/**************** spPOSCancelarCFDFlexLote ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSCancelarCFDFlexLote') AND type = 'P') DROP PROCEDURE dbo.spPOSCancelarCFDFlexLote
GO             
CREATE PROCEDURE spPOSCancelarCFDFlexLote
	@Estacion           int,
	@Empresa            varchar(5),
	@Sucursal           int,
	@Usuario            varchar(10)	    
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @Modulo					varchar(5), 
    @ID						int, 
    @Estatus				varchar(15),
    @Ok						int,
    @OkRef					varchar(255),
    @IDPOS					varchar(50),
    @MovNota				varchar(20), 
    @MovIDNota				varchar(20),
    @Prefijo				varchar(5),
    @Consecutivo			int,
    @noAprobacion			int,
    @fechaAprobacion		datetime    
    
	SELECT TOP 1 @MovNota = Mov 
	FROM MovTipo 
	WHERE Modulo = 'POS' AND Clave = 'POS.N' AND SubClave = 'POS.NPF'
	
	BEGIN TRANSACTION  
	
	DECLARE crCFDTemp CURSOR LOCAL FOR
    SELECT Empresa, Modulo, ID, Estatus, IDPOS 
    FROM POSCFDFlexPendiente
    WHERE ID IN(SELECT ID FROM LISTAID WHERE Estacion = @Estacion) 
    
	OPEN crCFDTemp
	FETCH NEXT FROM crCFDTemp INTO @Empresa, @Modulo, @ID, @Estatus,@IDPOS 
	WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
		BEGIN
			EXEC spAfectar @Modulo, @ID, 'CANCELAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @ok OUTPUT, @OkRef = @OkRef OUTPUT
         
			IF @Ok IS NULL
				BEGIN
					EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @MovNota, @MovIDNota OUTPUT, @Prefijo OUTPUT, @Consecutivo OUTPUT, 
						@noAprobacion OUTPUT, @FechaAprobacion OUTPUT, @Ok OUTPUT, @OkRef OUTPUT

					UPDATE POSL SET 
						Mov = @MovNota,
						MovID =  @MovIDNota,
						Prefijo = ISNULL(Prefijo, @Prefijo),
						Consecutivo = ISNULL(Consecutivo, @Consecutivo),
						noAprobacion = ISNULL(noAprobacion, @NoAprobacion),
						fechaAprobacion = ISNULL(fechaAprobacion, @fechaAprobacion),
						Estatus = 'CONCLUIDO'
					WHERE ID = @IDPOS 
				END        
    
			FETCH NEXT FROM crCFDTemp INTO @Empresa, @Modulo, @ID, @Estatus, @IDPOS 
		END
	CLOSE crCFDTemp
	DEALLOCATE crCFDTemp  
  
	IF @Ok IS NULL
		COMMIT TRAN
	ELSE 
		ROLLBACK TRAN    
  
	IF @Ok IS NOT NULL
		SELECT @OkRef
	ELSE
		SELECT 'PROCESO CONCLUIDO EXISTOSAMENTE'  

	RETURN
END
GO   


/************************ spPOSBorrarHerrTransferirVale *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSBorrarHerrTransferirVale') AND type = 'P') DROP PROCEDURE dbo.spPOSBorrarHerrTransferirVale
GO             
CREATE PROCEDURE spPOSBorrarHerrTransferirVale
	@Estacion   int
--//WITH ENCRYPTION	     
AS 
BEGIN
	DELETE POSHerrTraspasoVale WHERE Estacion = @Estacion
END
GO


/************************ spPOSHerrTransferirVale *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSHerrTransferirVale') AND type = 'P') DROP PROCEDURE dbo.spPOSHerrTransferirVale
GO             
CREATE PROCEDURE spPOSHerrTransferirVale
	@Estacion		int,
	@Empresa		varchar(5),
	@Usuario		varchar(10),
	@Sucursal		int
--//WITH ENCRYPTION	     
AS BEGIN
	DECLARE 
	@Cliente			varchar(10),
	@ID					int,
	@FechaEmision		datetime,
	@Ok					int,
	@OkRef				varchar(255),
	@OKRefLDI			varchar(500),   
	@MonederoD			varchar(20),
	@MonederoA			varchar(20),
	@Mov				varchar(20),
	@MovID				varchar(20),
	@MovCanc				varchar(20),
	@TipoCambio			float,
	@IDNuevo			int,
	@IDNuevoCanc			int,
	@ArticuloTarjeta	varchar(20),  
	@AlmacenTarjeta		varchar(10),
	@Importe			float,
	@MonederoLDI		bit,
	@Moneda				varchar(10),
	@Saldo				float,
	@MonedaMovOrig		varchar(10)
   
      
	DECLARE @LDILog table(  	
		IDModulo                varchar(36),
  		Modulo                  varchar(5),
  		Servicio                varchar(50),
        Fecha                   varchar(20),
        TipoTransaccion         varchar(50), 
        TipoSubservicio         varchar(50),
        CodigoRespuesta         varchar(50), 
        DescripcionRespuesta    varchar(255), 
        OrigenRespuesta         varchar(50), 
        InfoAdicional           varchar(50), 
        IDTransaccion           varchar(50),
        CodigoAutorizacion      varchar(50),
        Importe                 float,
        Comprobante             varchar(Max),
        Cadena                  varchar(Max),
        CadenaRespuesta         varchar(Max),
        RIDCobro                int)   
   

	SELECT  @FechaEmision = dbo.fnFechaSinHora(GETDATE())
	SELECT @MonederoLDI = ISNULL(MonederoLDI,0) FROM POSCfg WHERE Empresa = @Empresa
	SELECT @ArticuloTarjeta= CxcArticuloTarjetasDef ,@AlmacenTarjeta= CxcAlmacenTarjetasDef  
    FROM EmpresaCfg 
	WHERE Empresa = @Empresa
   
	SELECT @Mov = MovTraspasoVale FROM POSCfg WHERE Empresa = @Empresa 
  
	IF @Mov IS NULL
		SELECT TOP 1 @Mov = Mov FROM MovTipo WHERE Modulo = 'VALE' AND Clave = 'VALE.TT' 

	IF @Ok IS NULL
		BEGIN
			IF @Ok IS NULL
				BEGIN
					DECLARE crArticulo CURSOR FOR
					SELECT ID, MonederoD,MonederoA
					FROM POSHerrTraspasoVale
					WHERE Estacion = @Estacion AND NULLIF(MonederoD,'') IS NOT NULL AND NULLIF(MonederoA,'') IS NOT NULL
      
					OPEN crArticulo
					FETCH NEXT FROM crArticulo INTO @ID, @MonederoD, @MonederoA
					WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
						BEGIN 
							BEGIN TRANSACTION  
							SELECT @Ok = NULL ,@OkRef = NULL 
							IF NOT EXISTS(SELECT * FROM ValeSerie WHERE Serie = @MonederoD AND Estatus = 'CIRCULACION')
								SELECT @Ok = 36043, @OkRef = @MonederoD  
          
							IF NOT EXISTS(SELECT * FROM ValeSerie WHERE Serie = @MonederoA AND Estatus = 'DISPONIBLE')
								SELECT @Ok = 36031, @OkRef = @MonederoA 

							SET @Saldo = 0.0
        
							SELECT @Saldo = dbo.fnVerSaldoVale(@MonederoD)                     
       
							SELECT @Moneda = Moneda FROM ValeSerie WHERE Serie =@MonederoD     
							SELECT @TipoCambio = TipoCambio FROM Mon WHERE Moneda = @Moneda    
       
							IF @Ok IS NULL
								BEGIN
									INSERT INTO Vale (Empresa, Mov, FechaEmision, Moneda, TipoCambio, Usuario, Estatus, Sucursal, SucursalOrigen, SucursalDestino, TarjetaDestino)
									SELECT @Empresa, @Mov, @FechaEmision, @Moneda, @TipoCambio, @Usuario,'SINAFECTAR', @Sucursal, @Sucursal, @Sucursal, @MonederoA
          
									IF @@ERROR <> 0 SET @Ok = 1
          
									SELECT @IDNuevo = SCOPE_IDENTITY()     
          
									INSERT ValeD( ID, Serie, Sucursal, SucursalOrigen, Importe)
									SELECT @IDNuevo, @MonederoD, @Sucursal, @Sucursal, ISNULL(@Saldo,0.0)
          
									IF @MonederoLDI = 1
										EXEC spPOSLDIValidarTarjeta  'MON CONSULTA',@IDNuevo, @MonederoD, @Empresa, @Usuario, @Sucursal, @Importe OUTPUT, @Ok OUTPUT, @OkRef  OUTPUT, @OKRefLDI OUTPUT ,0,'VALE' 

									IF ROUND(@Saldo,4)<> ROUND(@Importe,4)
										SELECT @Ok = 25500, @OkRef = @OkRef+' ('+@MonederoD+')'          

									IF @@ERROR <> 0 SET @Ok = 1
          
									IF @OK IS NULL
										EXEC spAfectar 'VALE', @IDNuevo, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT            
          
									IF @Ok IS NULL  
										IF @MonederoLDI = 1 AND @Ok IS NULL
											EXEC spPOSLDI 'MON ALTA REEMPLAZO', @IDNuevo, @MonederoD, @Empresa, @Usuario, @Sucursal, @MonederoA, NULL, 1, NULL, @Ok OUTPUT, @OkRef OUTPUT, 'VALE'            

									IF @Ok IS NULL BEGIN
										SELECT TOP 1 @MovCanc = Mov FROM MovTipo WHERE Modulo = 'VALE' and Clave = 'VALE.CT'
            
									INSERT INTO Vale (Empresa, Mov, FechaEmision, Moneda, TipoCambio, Usuario, Estatus, Sucursal, SucursalOrigen, SucursalDestino, TarjetaDestino )
									SELECT            @Empresa, @MovCanc, @FechaEmision, @Moneda, @TipoCambio, @Usuario, 'SINAFECTAR', @Sucursal, @Sucursal, @Sucursal, @MonederoD
									IF @@ERROR <> 0 SET @Ok = 1
									SELECT @IDNuevoCanc = SCOPE_IDENTITY()     
          
									INSERT ValeD(ID, Serie, Sucursal, SucursalOrigen, Importe)
									SELECT       @IDNuevoCanc, @MonederoD, @Sucursal,  @Sucursal, 0.0

									EXEC spAfectar 'VALE', @IDNuevoCanc, 'AFECTAR', 'Todo', NULL, @Usuario, @EnSilencio = 1, @Conexion = 1, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT            
								END   
								END   

							IF @Ok IS NOT NULL AND EXISTS(SELECT * FROM POSLDIIDTemp WHERE Estacion = @@SPID)
								BEGIN
									INSERT @LDILog(IDModulo, Modulo, Servicio, Fecha, TipoTransaccion, TipoSubservicio, CodigoRespuesta, DescripcionRespuesta, OrigenRespuesta,InfoAdicional, IDTransaccion, CodigoAutorizacion, Comprobante, Cadena, CadenaRespuesta, Importe, RIDCobro) 
									SELECT IDModulo, Modulo, Servicio, Fecha, TipoTransaccion, TipoSubservicio, CodigoRespuesta, DescripcionRespuesta, OrigenRespuesta,InfoAdicional, IDTransaccion, CodigoAutorizacion, Comprobante, Cadena, CadenaRespuesta, Importe, RIDCobro
									FROM POSLDILog 
									WHERE IDModulo = @IDNuevo AND Modulo = 'VALE' AND ID IN(SELECT ID FROM POSLDIIDTemp WHERE Estacion = @@SPID)           
								END
        
							DELETE POSLDIIDTemp WHERE Estacion = @@SPID          
          
							IF @Ok IS NULL 
								BEGIN
									COMMIT TRANSACTION
								END  
							ELSE
								ROLLBACK TRANSACTION   
       
							IF EXISTS(SELECT * FROM @LDILog)
								BEGIN
									INSERT POSLDILog(IDModulo, Modulo, Servicio, Fecha, TipoTransaccion, TipoSubservicio, CodigoRespuesta, DescripcionRespuesta, OrigenRespuesta,InfoAdicional, IDTransaccion, CodigoAutorizacion, Comprobante, Cadena, CadenaRespuesta, Importe, RIDCobro) 
									SELECT IDModulo, Modulo, Servicio, Fecha, TipoTransaccion, TipoSubservicio, CodigoRespuesta, DescripcionRespuesta, OrigenRespuesta,InfoAdicional, IDTransaccion, CodigoAutorizacion, Comprobante, Cadena, CadenaRespuesta, Importe, RIDCobro    
									FROM @LDILog
								END          
         
							IF @Ok IS NOT NULL   
								UPDATE POSHerrTraspasoVale SET Error = @OkRef  WHERE ID = @ID
        
							IF @Ok IS NULL 
								BEGIN
									DELETE  POSHerrTraspasoVale   WHERE ID = @ID
								END  
          
							FETCH NEXT FROM crArticulo INTO @ID, @MonederoD, @MonederoA
						END 
					CLOSE crArticulo
					DEALLOCATE crArticulo 
				END
		END 
  
	IF @Ok IS NOT NULL
		SELECT @OkRef = ISNULL(Descripcion,'') + ' '+ISNULL(@OkRef,'')
		FROM MensajeLista WHERE Mensaje = @Ok
  
	IF @Ok IS NULL
		SELECT @OkRef = 'PROCESO CONCLUIDO'
   
	SELECT @OkRef 
END
GO


/************************ spPOSReporteCancelacionArt *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSReporteCancelacionArt') AND type = 'P') DROP PROCEDURE dbo.spPOSReporteCancelacionArt
GO             
CREATE PROCEDURE spPOSReporteCancelacionArt
	@Sucursal  int, 
	@Cajero    varchar(10), 
	@FechaD    datetime, 
	@FechaA    datetime
--//WITH ENCRYPTION	     
AS 
BEGIN
	SELECT @FechaD = dbo.fnFechaSinHora(@FechaD), @FechaA = dbo.fnFechaSinHora(@FechaA)
  
	SELECT @Cajero = NULLIF(@Cajero,'NULL')

	SELECT p.Cajero,g.Nombre, p.Articulo, a.Descripcion1, p.Sucursal Sucursal1, s.Nombre SucursalNombres, ABS(SUM(p.Cantidad))Cantidad, ISNULL(p.Precio,0.0)Precio  
    FROM POSCancelacionArticulos p JOIN Art a ON p.Articulo = a.Articulo
    JOIN Agente g ON p.Cajero = g.Agente
    JOIN Sucursal s ON p.Sucursal = s.Sucursal
	WHERE p.Sucursal = ISNULL(@Sucursal,p.Sucursal) AND p.Cajero = ISNULL(@Cajero,p.Cajero) 
	AND dbo.fnFechaSinHora(Fecha) Between ISNULL(@FechaD,dbo.fnFechaSinHora(Fecha)) AND ISNULL(@FechaA,dbo.fnFechaSinHora(Fecha))
	GROUP BY p.Cajero, p.Articulo, p.Sucursal, p.Precio,g.Nombre, a.Descripcion1,s.Nombre
	ORDER By p.Sucursal,p.Cajero
END
GO 


/**************** spPOSDepurarTablas ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSDepurarTablas') AND type = 'P') DROP PROCEDURE dbo.spPOSDepurarTablas
GO             
CREATE PROCEDURE spPOSDepurarTablas
	@EstacionTrabajo		int,
    @Empresa                varchar(5),
    @Sucursal				int,
    @Usuario				varchar(10),
    @FechaD					datetime
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Host                 varchar(10),
	@Cluster              varchar(10),
	@Ok                   int,
	@OkRef                varchar(255),
	@FormaPago            varchar(50), 
	@Importe              float , 
	@CtaDinero            varchar(10), 
	@Caja                 varchar(10), 
	@Cajero               varchar(10), 
	@ImporteRef           float, 
	@TipoCambio           float, 
	@MonedaRef            varchar(10), 
	@CtaDineroDestino     varchar(10),
	@MonedaPrincipal      varchar(10),
	@MovInsertar          varchar(20), 
	@MovIDInsertar        varchar(20),
	@IDInsertar           varchar(50)
  
	SELECT TOP 1 @MonedaPrincipal = Moneda 
    FROM POSLTipoCambioRef 
	WHERE TipoCambio = 1 AND Sucursal = @Sucursal AND EsPrincipal = 1   
  
	SELECT TOP 1 @MovInsertar = Mov 
	FROM MovTipo 
	WHERE Modulo = 'POS' AND Clave = 'POS.SALDOIN'

	DECLARE @Tabla table( 
		FormaPago			varchar(50), 
		Importe				float , 
		CtaDinero			varchar(10), 
		Caja				varchar(10), 
		Cajero				varchar(10), 
		Host				varchar(10), 
		ImporteRef			float, 
		TipoCambio			float, 
		MonedaRef			varchar(10), 
		CtaDineroDestino	varchar(10))
  
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
      
	IF @FechaD IS NULL
		SELECT @FechaD= GETDATE()
  
	SELECT @FechaD = dbo.fnFechaSinHora(@FechaD)
	
	BEGIN TRAN
    
	INSERT @Tabla(
		FormaPago, Importe, CtaDinero, Caja, Cajero, Host, ImporteRef, TipoCambio, MonedaRef, CtaDineroDestino)
	SELECT
		plc.FormaPago, SUM(plc.Importe* mt.Factor),  plc.Caja,  plc.Caja,  plc.Cajero, plc.Host, SUM(plc.ImporteRef* mt.Factor), plc.TipoCambio, plc.MonedaRef, plc.Caja
    FROM POSLCobro plc
    JOIN POSL p ON plc.ID = p.ID
    JOIN MovTipo mt ON p.Mov = mt.Mov AND mt.Modulo = 'POS'      			   
	WHERE p.Estatus IN('CONCLUIDO','TRASPASADO') 
    AND p.Host = @Host  
    AND dbo.fnFechaSinHora(p.FechaRegistro) <= @FechaD
	GROUP BY plc.FormaPago, plc.Caja,  plc.Cajero, plc.Host, plc.TipoCambio, plc.MonedaRef
	HAVING SUM(plc.Importe) <> 0.0
  
	IF @@ERROR <> 0 
		SET @Ok = 1

	IF @Ok IS NULL
		BEGIN
			DELETE POSLVenta
			FROM POSLVenta v JOIN POSL p ON p.ID = v.ID
			WHERE p.Host = @Host  
			AND dbo.fnFechaSinHora(p.FechaRegistro) <= @FechaD
    
			IF @@ERROR <> 0 
				SET @Ok = 1   
  
			IF @Ok IS NULL   
				DELETE POSLSerieLote
				FROM POSLSerieLote v JOIN POSL p ON p.ID = v.ID
				WHERE p.Host = @Host  
				AND dbo.fnFechaSinHora(p.FechaRegistro) <= @FechaD 
     
			IF @@ERROR <> 0 
				SET @Ok = 1
     
			IF @Ok IS NULL   
				DELETE POSVentaCobro
				FROM POSVentaCobro v JOIN POSL p ON p.ID = v.ID
				WHERE p.Host = @Host  
				AND dbo.fnFechaSinHora(p.FechaRegistro) <= @FechaD 
			
			IF @@ERROR <> 0 
				SET @Ok = 1     
     
			IF @Ok IS NULL   
				DELETE POSLDenominacion
				FROM POSLDenominacion v JOIN POSL p ON p.ID = v.ID
				WHERE p.Host = @Host  
				AND dbo.fnFechaSinHora(p.FechaRegistro) <= @FechaD 
     
			IF @@ERROR <> 0 
				SET @Ok = 1        
         
			IF @Ok IS NULL   
				DELETE POSLCobro
				FROM POSLCobro v JOIN POSL p ON p.ID = v.ID
				WHERE p.Host = @Host  
				AND dbo.fnFechaSinHora(p.FechaRegistro)   <= @FechaD
     
			IF @@ERROR <> 0 
				SET @Ok = 1  
     
			IF @Ok IS NULL   
				DELETE POSL WHERE  Host = @Host AND dbo.fnFechaSinHora(FechaRegistro) <= @FechaD 
			
			IF @@ERROR <> 0 
				SET @Ok = 1                  
		END
  
	IF @Ok IS NULL
		BEGIN
			DECLARE crCobro CURSOR LOCAL FOR
			SELECT FormaPago, Importe, CtaDinero, Caja, Cajero, Host, ImporteRef, TipoCambio, MonedaRef, CtaDineroDestino
			FROM @Tabla
    
			OPEN crCobro   
			FETCH NEXT FROM crCobro INTO @FormaPago, @Importe, @CtaDinero, @Caja, @Cajero, @Host, @ImporteRef, @TipoCambio, @MonedaRef, @CtaDineroDestino
			WHILE @@FETCH_STATUS <> -1
				BEGIN
					IF @@FETCH_STATUS <> -2
						BEGIN
							SELECT @IDInsertar = NEWID()
							
							EXEC spPOSConsecutivoAuto @Empresa, @Sucursal, @MovInsertar, @MovIDInsertar OUTPUT, NULL, NULL, NULL, NULL, @Ok OUTPUT, @OkRef OUTPUT

							IF @MovInsertar IS NOT NULL  AND @Ok IS NULL    
								INSERT POSL (
									ID, Empresa, Modulo, Mov, MovID, FechaEmision, FechaRegistro, Moneda, TipoCambio, 
									Usuario, Estatus, Cajero, CtaDinero,
									Importe, CtaDineroDestino, Sucursal, Host, Cluster, Caja)
								SELECT
									@IDInsertar, @Empresa, 'DIN', @MovInsertar, @MovIDInsertar, dbo.fnFechaSinHora(GETDATE()), GETDATE(), @MonedaPrincipal, 1,
									@Usuario, 'CONCLUIDO', @Cajero, ISNULL(NULLIF(@CtaDinero,''),@Caja), 
									@Importe, ISNULL(NULLIF(@CtaDineroDestino,''),@Caja), @Sucursal, @Host,  @Cluster, @Caja
          
							IF @@ERROR <> 0 
								SET @Ok = 1   
           
							IF @Ok IS NULL  
								INSERT POSLCobro (
									ID, FormaPago, Importe, CtaDinero, Caja, Cajero, Host, ImporteRef, TipoCambio, MonedaRef, CtaDineroDestino)
								SELECT
									@IDInsertar, @FormaPago, @Importe, @CtaDinero, @Caja, @Cajero, @Host, @ImporteRef, @TipoCambio, @MonedaRef, @CtaDineroDestino
          
							IF @@ERROR <> 0 
								SET @Ok = 1 
						END
      
					FETCH NEXT FROM crCobro INTO @FormaPago, @Importe, @CtaDinero, @Caja, @Cajero, @Host, @ImporteRef, @TipoCambio, @MonedaRef, @CtaDineroDestino
				END
			CLOSE crCobro
			DEALLOCATE crCobro
		END
  
	IF @Ok IS NULL
		COMMIT TRAN
	ELSE 
		ROLLBACK TRAN  

	IF @Ok IS NOT NULL
		SELECT @OkRef = Descripcion +' '+ISNULL(@OkRef,'')
		FROM MensajeLista 
		WHERE Mensaje = @Ok 
	ELSE
		SELECT @OkRef = 'PROCESO CONCLUIDO CON EXITO'
  
	SELECT @OkRef     
END
GO 


/**************** fnPOSLDIFormatearFecha ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSLDIFormatearFecha') DROP FUNCTION fnPOSLDIFormatearFecha
GO
CREATE FUNCTION dbo.fnPOSLDIFormatearFecha (
	@Fecha		varchar(25)
) 
RETURNS datetime
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado  datetime

	SELECT  @Resultado = CONVERT(datetime, SUBSTRING(@Fecha,1,8))
  
	SELECT @Resultado = DATEADD(hh,CONVERT(int,SUBSTRING(@Fecha, 9, 2)),@Resultado)
	SELECT @Resultado = DATEADD(n,CONVERT(int,SUBSTRING(@Fecha, 9, 2)),@Resultado)

	RETURN (@Resultado)
END
GO


/************************ spPOSReporteEdoCtaLDI *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSReporteEdoCtaLDI') AND type = 'P') DROP PROCEDURE dbo.spPOSReporteEdoCtaLDI
GO             
CREATE PROCEDURE spPOSReporteEdoCtaLDI
	@ID        int
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@Estacion  int

	SELECT @Estacion = @@SPID
  
	DELETE POSLDIEdoCtaTemp WHERE Estacion = @@SPID
	DECLARE @TablaFecha table(
		ID		int IDENTITY,
		Fecha	varchar(50))
	DECLARE @TablaMonto table(
		ID		int IDENTITY,
		Monto	float)
	DECLARE @TablaMov table(
		ID		int IDENTITY,
		Mov		varchar(50))
	DECLARE @TablaConcepto table(
		ID			int IDENTITY,
		Concepto	varchar(50))
	DECLARE @TablaReferencia table(
		ID			int IDENTITY,
		Referencia	varchar(50))

	INSERT @TablaFecha(Fecha)
	SELECT Campo from dbo.fnPOSGenerarTicket((SELECT ListaFechas FROM POSLDILog where ID = @ID),',')
  
	INSERT @TablaMonto(Monto)
	SELECT Campo from dbo.fnPOSGenerarTicket((SELECT ListaMontos FROM POSLDILog where ID = @ID),',')

	INSERT @TablaMov(Mov)
	SELECT Campo from dbo.fnPOSGenerarTicket((SELECT ListaMovimientos FROM POSLDILog where ID = @ID),',')
  
	INSERT @TablaConcepto(Concepto)
	SELECT Campo from dbo.fnPOSGenerarTicket((SELECT ListaConceptos FROM POSLDILog where ID = @ID),',')

	INSERT @TablaReferencia(Referencia)
	SELECT Campo from dbo.fnPOSGenerarTicket((SELECT ListaReferencias FROM POSLDILog where ID = @ID),',')
    
	INSERT POSLDIEdoCtaTemp(Estacion, Fecha, Monto, Mov, Concepto, Referencia)
	SELECT @@SPID,
		dbo.fnPOSLDIFormatearFecha(f.Fecha) Fecha,
        NULLIF(m.Monto,''),NULLIF(NULLIF(v.Mov,''),'null') Mov ,
        NULLIF(NULLIF(c.Concepto,''),'null')Concepto,
        NULLIF(NULLIF(r.Referencia,''),'null')Referencia 
	FROM @TablaFecha f JOIN @TablaMonto m ON f.ID = m.ID JOIN @TablaMov v ON v.ID = f.ID
	JOIN @TablaConcepto c ON f.ID = c.ID 
	JOIN @TablaReferencia r ON f.ID = r.ID   
END
GO 


/**************** fnPOSFechaCierre ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSFechaCierre') DROP FUNCTION fnPOSFechaCierre
GO
CREATE FUNCTION dbo.fnPOSFechaCierre (
	@Empresa        varchar(5),
	@Sucursal       int,
    @Fecha          varchar(25),
    @Caja           varchar(10)
) 
RETURNS datetime
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado		datetime,
	@FechaActual    datetime
  
	SELECT @FechaActual = GETDATE()
  
	SELECT @Resultado = Fecha 
	FROM POSEstatusCajasCierre 
	WHERE Sucursal = @Sucursal AND Caja = @Caja
  
	IF @Resultado IS NULL
		SELECT @Resultado = dbo.fnFechaSinHora(@FechaActual)

	SELECT @Resultado = dbo.fnFechaSinHora(@Resultado)

	RETURN (@Resultado)
END
GO


SET DATEFIRST 7  
 GO

 /**************** fnPOSFechaCierre2 ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSFechaCierre2') DROP FUNCTION fnPOSFechaCierre2
GO
CREATE FUNCTION dbo.fnPOSFechaCierre2 (
	@Empresa        varchar(5),
	@Sucursal       int,
    @Fecha          varchar(25),
    @Caja           varchar(10)
) 
RETURNS datetime
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Resultado            datetime,
	@FechaActual          datetime,
	@HoraCierreDia        varchar(10),
	@DiasHabiles          varchar(20),
	@Hora                 int,
	@Minutos              int,
	@HoraMinutos          int,
	@Dia                  int,
	@SumarDias            int
    
	SELECT @FechaActual = GETDATE()
	SELECT @Hora = DATEPART(HOUR,@FechaActual)
	SELECT @Minutos= DATEPART(MINUTE,@FechaActual)
	SELECT @HoraMinutos = (@Hora*60)+@Minutos  
	SELECT @SumarDias =1
  
	SELECT @HoraCierreDia = HoraCierreDia, @DiasHabiles = DiasHabiles
    FROM POSCfg 
	WHERE Empresa = @Empresa
    
	IF @Fecha IS NULL
		SELECT @Resultado = ISNULL(dbo.fnPOSFechaCierre(@Empresa,@Sucursal,@Fecha,@Caja),@FechaActual)    
  
	IF @HoraMinutos >=  dbo.fnHoraEnEntero(@HoraCierreDia) --AND dbo.fnFechaSinHora(@Fecha) <= dbo.fnFechaSinHora(@FechaActual)
		BEGIN
			SELECT @Resultado = Fecha 
			FROM POSEstatusCajasCierre 
			WHERE Sucursal = @Sucursal AND Caja = @Caja
			
			SELECT @Resultado = ISNULL(@Resultado,@FechaActual)
			SELECT @Dia = DATEPART(weekday,ISNULL(@Resultado,@FechaActual))
    
			IF @DiasHabiles = 'Lun-Vie'
				BEGIN
					IF @Dia = 6
						SELECT @SumarDias = 3
					IF @Dia = 7
						SELECT @SumarDias = 2           
				END
			ELSE
				IF @DiasHabiles = 'Lun-Sab'
					BEGIN
						IF @Dia = 7
							SELECT @SumarDias = 2        
					END
   
			SELECT @Resultado = DATEADD(day,@SumarDias,@FechaActual)
		END

	IF @Resultado IS NULL
		SELECT @Resultado = @FechaActual
	IF EXISTS(SELECT * FROM POSFechaCierre WHERE Sucursal = @Sucursal AND Fecha > dbo.fnFechaSinHora(@Resultado))
		SELECT @Resultado = Fecha  
		FROM POSFechaCierre 
		WHERE Sucursal = @Sucursal

	SELECT @Resultado = dbo.fnFechaSinHora(@Resultado)

	RETURN (@Resultado)
END
GO


/************************ spPOSCambiarFechaEmision *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSCambiarFechaEmision') AND type = 'P') DROP PROCEDURE dbo.spPOSCambiarFechaEmision
GO             
CREATE PROCEDURE spPOSCambiarFechaEmision
	@ID				varchar(50),
	@Empresa		varchar(5), 
	@Sucursal		int, 
	@Host			varchar(10), 
	@Caja			varchar(10), 
	@Ok				int OUTPUT, 
	@OkRef			varchar(255)	OUTPUT
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@EsConcentradora		bit,
	@Fecha                  datetime
  
	SELECT @EsConcentradora = ISNULL(EsConcentradora,0) 
	FROM CtaDinero 
	WHERE CtaDinero = @Caja
  
	IF @Ok IS NULL AND @EsConcentradora = 1
		BEGIN
			INSERT POSFechaCierre(
				Sucursal,  Fecha)
			SELECT
				@Sucursal, dbo.fnPOSFechaCierre2(@Empresa,@Sucursal,@Fecha,@Caja)
		
			IF @@ERROR <> 0 
				SET @Ok = 1
		END
  
	IF @Ok IS NULL
		BEGIN
			IF NOT EXISTS (SELECT * FROM POSEstatusCajasCierre WHERE Sucursal = @Sucursal AND Caja = @Caja 
						   AND Fecha = dbo.fnPOSFechaCierre2(@Empresa,@Sucursal,@Fecha,@Caja)) 
				INSERT POSEstatusCajasCierre(
					Sucursal,  Caja,  Fecha)
				SELECT
					@Sucursal, @Caja, dbo.fnPOSFechaCierre2(@Empresa,@Sucursal,@Fecha,@Caja)
    
			IF @@ERROR <> 0 
				SET @Ok = 1
		END  
  
	RETURN
END
GO 


/************************ spPOSValidarCierresCaja *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSValidarCierresCaja') AND type = 'P') DROP PROCEDURE dbo.spPOSValidarCierresCaja
GO             
CREATE PROCEDURE spPOSValidarCierresCaja
	@ID				varchar(50),
	@Empresa		varchar(5), 
	@Sucursal		int, 
	@Host			varchar(10), 
	@Caja			varchar(10), 
	@Ok				int OUTPUT, 
	@OkRef			varchar(255)	OUTPUT
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@EsConcentradora            bit,
	@Fecha                      datetime,
	@ValidarCajasCerradas		bit
  
	SELECT @ValidarCajasCerradas = ISNULL(ValidarCajasCerradas,0) 
	FROM POSCfg 
	WHERE Empresa = @Empresa
  
	SELECT @Fecha = dbo.fnFechaSinHora(Fecha) 
	FROM POSFechaCierre 
	WHERE Sucursal = @Sucursal
	
	SELECT @EsConcentradora = ISNULL(EsConcentradora,0) 
	FROM CtaDinero 
	WHERE CtaDinero = @Caja
  
	IF @EsConcentradora = 1 AND @ValidarCajasCerradas = 1
		BEGIN
			IF EXISTS(SELECT * FROM POSEstatusCajasCierre WHERE Sucursal = @Sucursal AND dbo.fnFechaSinHora(Fecha) = @Fecha AND Caja <> @Caja )
				SELECT @Ok = 30448, @OkRef = '('+(SELECT TOP 1 Caja FROM POSEstatusCajasCierre WHERE Sucursal = @Sucursal AND dbo.fnFechaSinHora(Fecha) = @Fecha AND Caja <> @Caja)+')'
		END
  
	IF @Ok IS NULL AND @EsConcentradora = 1
		BEGIN
			DELETE POSFechaCierre WHERE Sucursal = @Sucursal
    
			IF @@ERROR <> 0 
				SET @Ok = 1
		END
  
	IF @Ok IS NULL
		BEGIN
			DELETE POSEstatusCajasCierre WHERE Sucursal = @Sucursal AND Caja  = @Caja
			
			IF @@ERROR <> 0 
				SET @Ok = 1
		END  
  
	RETURN
END
GO 


/************************ spPOSGenerarCierreSucursalInicializar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSGenerarCierreSucursalInicializar') AND type = 'P') DROP PROCEDURE dbo.spPOSGenerarCierreSucursalInicializar
GO             
CREATE PROCEDURE spPOSGenerarCierreSucursalInicializar
	@Empresa        varchar(5), 
	@Sucursal       int, 
	@Estacion		int, 
	@Usuario        varchar(10)
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@CajaActual  varchar(10)
   
	SELECT @CajaActual = DefCtaDinero 
	FROM Usuario 
	WHERE Usuario = @Usuario

	DELETE POSCierreSucursalD WHERE Estacion = @Estacion    
   
	INSERT POSCierreSucursalD(
		Estacion, Sucursal, FormaPago)
	SELECT
		@Estacion, @Sucursal , plc.FormaPago
	FROM POSLCobro plc JOIN POSL p ON plc.ID = p.ID
    JOIN MovTipo mt ON p.Mov = mt.Mov AND mt.Modulo = 'POS'      			   
    WHERE p.caja  = @CajaActual
    AND p.Estatus IN('CONCLUIDO','TRASPASADO') 
	GROUP BY plc.FormaPago

	RETURN
END
GO 


 /************************ spPOSBorrarCierreSucursalTemp *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSBorrarCierreSucursalTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSBorrarCierreSucursalTemp
GO             
CREATE PROCEDURE spPOSBorrarCierreSucursalTemp
	@Estacion		int
--//WITH ENCRYPTION	     
AS 
BEGIN
	DELETE POSCierreSucursalTemp WHERE Estacion = @Estacion 

	RETURN
END
GO 


/************************ spPOSGenerarCierreSucursal *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSGenerarCierreSucursal') AND type = 'P') DROP PROCEDURE dbo.spPOSGenerarCierreSucursal
GO             
CREATE PROCEDURE spPOSGenerarCierreSucursal
	@Empresa				varchar(5), 
	@Sucursal				int, 
	@Estacion				int, 
	@Usuario				varchar(10),
	@Mov					varchar(20),
	@CtaDineroDestino		varchar(10),
    @Fecha					datetime
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE 
	@Ok						int,
	@OkRef					varchar(255),
	@FechaActual			datetime,
	@Caja					varchar(10),
	@ID						varchar(50),
	@Cajero					varchar(10),
	@Host					varchar(10),
	@Cluster				varchar(10),
	@RedondeoMonetarios		int,
	@Codigo					varchar(30),
	@Moneda					varchar(10),
	@FormaPago				varchar(50),
	@POSMonedaAct			bit
  
  
	SELECT @POSMonedaAct = POSMonedaAct 
	FROM POSCfg 
	WHERE Empresa = @Empresa

	SELECT @Caja = DefCtaDinero, @Cajero = DefCajero 
	FROM Usuario 
	WHERE Usuario = @Usuario
	
	SELECT @RedondeoMonetarios = dbo.fnPOSRedondeoMonetarios(@Empresa)
	
	SELECT @Fecha = dbo.fnFechaSinHora(@Fecha)
	
	SELECT @Moneda = Moneda 
	FROM POSLTipoCambioRef 
	WHERE Sucursal = @Sucursal AND EsPrincipal = 1 AND TipoCambio = 1.0
	
	SELECT TOP 1 @FormaPago = FormaPago 
	FROM FormaPago 
	WHERE Moneda = @Moneda
  
	EXEC spPOSHost @Host OUTPUT, @Cluster OUTPUT
  
	SELECT TOP 1 @Codigo = Codigo 
	FROM CB 
	WHERE TipoCuenta = 'Accion' AND Accion = 'CONCLUIR MOVIMIENTO'
  
	IF NOT EXISTS(SELECT * FROM POSFechaCierre WHERE Sucursal = @Sucursal)
		SELECT @Ok = 1 , @OkRef = ''
  
	SELECT @FechaActual = Fecha 
	FROM POSFechaCierre 
	WHERE Sucursal = @Sucursal
  
	IF EXISTS (SELECT * FROM POSEstatusCajasCierre WHERE Sucursal = @Sucursal AND Fecha = @FechaActual AND Caja <> @Caja)
		SELECT @Ok = 30448, @OkRef = '('+(SELECT TOP 1 Caja FROM POSEstatusCajasCierre WHERE Sucursal = @Sucursal AND dbo.fnFechaSinHora(Fecha) = @FechaActual AND Caja <> @Caja )+')'
    
	IF (SELECT Abierto FROM POSEstatusCaja WHERE Caja = @Caja) = 0
		SELECT @Ok =30440, @OkRef = @Caja   
      
	IF @Ok IS NOT NULL
		SELECT @OkRef = Descripcion +' '+ ISNULL(@OkRef,'')
		FROM MensajeLista 
		WHERE Mensaje = @Ok      
      
	IF @Ok IS NULL
		BEGIN
			EXEC spPOSMovNuevo @Empresa, 'DIN', @Sucursal, @Usuario, @Estacion, @ID OUTPUT, NULL
			
			UPDATE POSL SET Mov = @Mov, Modulo = 'DIN', CtaDineroDestino = @CtaDineroDestino WHERE ID = @ID
    
			IF @@ERROR <> 0 
				SET @Ok = 1
    
			IF @Ok IS NULL  
				BEGIN      
					IF EXISTS(SELECT * FROM   POSCierreSucursalD p     WHERE p.Estacion = @Estacion AND p.Sucursal = @Sucursal HAVING SUM(Importe) >0.0) 
						BEGIN
							INSERT POSLCobro (
								ID, FormaPago, Importe, Referencia, CtaDinero, Fecha, Caja, 
								Cajero, Host, ImporteRef, TipoCambio, MonedaRef, CtaDineroDestino)
							SELECT
								@ID, p.FormaPago,ROUND(ROUND(p.Importe,@RedondeoMonetarios)* t.TipoCambio,@RedondeoMonetarios), p.Referencia, @Caja, @Fecha, @Caja,
								@Cajero, @Host, p.Importe, t.TipoCambio,  CASE WHEN @POSMonedaAct = 0 THEN f.Moneda ELSE f.POSMoneda END, @CtaDineroDestino 
							FROM POSCierreSucursalD p JOIN FormaPago f ON p.FormaPago = f.FormaPago
							JOIN POSLTipoCambioRef t ON t.Moneda = CASE WHEN @POSMonedaAct = 0 THEN f.Moneda ELSE f.POSMoneda END AND t.Sucursal = p.Sucursal
							WHERE p.Estacion = @Estacion
							AND p.Sucursal = @Sucursal 
        
							IF @@ERROR <> 0 
								SET @Ok = 1             
						END
					ELSE 
						BEGIN
							INSERT POSLCobro (
								ID, FormaPago, Importe, Referencia, CtaDinero, Fecha, Caja, Cajero, Host, ImporteRef, TipoCambio, MonedaRef, CtaDineroDestino)
							SELECT
								@ID, @FormaPago, 0.0, NULL, @Caja, @Fecha, @Caja, @Cajero, @Host, 0.0, 1.0, @Moneda, @CtaDineroDestino

							IF @@ERROR <> 0 
								SET @Ok = 1       
						END
				END
    
			IF @Ok IS NULL
				EXEC spPOS @Estacion , @Codigo, @Empresa, 'VTAS', @Sucursal, @Usuario, NULL, @ID, 0, null, 0, 0, NULL, NULL, NULL, @EnSilencio = 1, 
					@Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT    
		END      
  
	IF @Ok IS NULL
		SELECT @OkRef = 'PROCEDIMIENTO CONCLUIDO CON EXITO'

	SELECT @OkRef 

	RETURN
END
GO 


/************************ spPOSGenerarCierreDia  *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSGenerarCierreDia') AND type = 'P') DROP PROCEDURE dbo.spPOSGenerarCierreDia
GO             
CREATE PROCEDURE spPOSGenerarCierreDia
	@Estacion			int,
    @Empresa			char(5),
    @FacturaMov			varchar(20),
    @Fecha				datetime,
	@Usuario			char(10),
	@Ok					int		OUTPUT,
	@OkRef				varchar(255)	OUTPUT,
	@DevolucionMov		varchar(20) = NULL
--//WITH ENCRYPTION             
AS 
BEGIN
	DECLARE 
	@OkRefNota		varchar(255),
	@Sucursal		int,
	@Moneda			varchar(10)
  
	DECLARE @Tabla table (ID int)
  
	INSERT @Tabla
	SELECT ID 
	FROM ListaID 
	WHERE Estacion = @Estacion
  
	DELETE ListaID WHERE Estacion = @Estacion 
  
	DECLARE crSucursal CURSOR LOCAL FOR
    SELECT Sucursal, Moneda
    FROM POSCierreDia
    WHERE ID IN (SELECT ID FROM @Tabla )    
    GROUP BY Sucursal, Moneda         
    
	OPEN crSucursal   
    FETCH NEXT FROM crSucursal INTO @Sucursal, @Moneda
    WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @@FETCH_STATUS <> -2
				BEGIN
					IF @Ok IS NULL
						BEGIN
							DELETE ListaID WHERE Estacion = @Estacion 
          
							INSERT ListaID(Estacion,ID)
							SELECT @Estacion, v.ID
							FROM Venta v JOIN POSCierreDia p ON v.Sucursal = p.Sucursal AND v.FechaEmision = p.FechaEmision AND v.Empresa = p.Empresa 
							AND v.Almacen = p.Almacen AND v.Moneda = p.Moneda
							WHERE p.ID IN (SELECT ID FROM @Tabla ) AND p.Sucursal = @Sucursal
            
							IF EXISTS(SELECT * FROM ListaID WHERE Estacion = @Estacion)
								EXEC spProcesarVentaN @Estacion = @Estacion, @Empresa = @Empresa, @FacturaMov = @FacturaMov , @FechaEmision = @Fecha, @Usuario = @Usuario,
									@EnSilencio = 0, @Ok = @Ok OUTPUT, @OkRef = @OkRefNota OUTPUT, @DevolucionMov = @DevolucionMov, @Sucursal = @Sucursal
						END        
				END
      
			FETCH NEXT FROM crSucursal INTO @Sucursal, @Moneda
		END
    CLOSE crSucursal
    DEALLOCATE crSucursal      
   
	IF @Ok IS NOT NULL
		SELECT Descripcion+' '+ISNULL(RTRIM(@OkRef),'') 
		FROM MensajeLista
		WHERE Mensaje = @Ok
	ELSE
		SELECT ISNULL(@OkRefNota  ,'')+ISNULL(@OkRef,'')
	
	RETURN
END
GO 


/************************ spPOSBorrarPOSDepurarTablasTemp *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSBorrarPOSDepurarTablasTemp') AND type = 'P') DROP PROCEDURE dbo.spPOSBorrarPOSDepurarTablasTemp
GO             
CREATE PROCEDURE spPOSBorrarPOSDepurarTablasTemp
	@Estacion  int, 
	@Empresa   varchar(5)
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE
	@Dias		int,
	@Fecha		datetime
      
	SELECT @Dias = DiasDepuracion 
	FROM POSCfg 
	WHERE Empresa = @Empresa
  
	SELECT @Fecha = dbo.fnFechaSinHora(DATEADD (day , -ISNULL(@Dias,1), GETDATE())) 
  
	DELETE POSDepurarTablasTemp WHERE Estacion = @Estacion
  
	INSERT POSDepurarTablasTemp (
		Estacion, Fecha)
	SELECT
		@Estacion, @Fecha

	RETURN
END
GO 


/**************** fnPOSValidarFechaDepuracion ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidarFechaDepuracion') DROP FUNCTION fnPOSValidarFechaDepuracion
GO
CREATE FUNCTION dbo.fnPOSValidarFechaDepuracion (
	@Empresa        varchar(5)
) 
RETURNS datetime
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE  
	@Dias		int,
	@Fecha		datetime
   
	SELECT @Dias = DiasDepuracion 
	FROM POSCfg 
	WHERE Empresa = @Empresa
  
	SELECT @Fecha = dbo.fnFechaSinHora(DATEADD (day , -ISNULL(@Dias,1), GETDATE())) 
      
	SELECT @Fecha = dbo.fnFechaSinHora(@Fecha)

	RETURN (@Fecha)
END
GO


/**************** fnPOSValidarCapturaFormaPago ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidarCapturaFormaPago') DROP FUNCTION fnPOSValidarCapturaFormaPago
GO
CREATE FUNCTION dbo.fnPOSValidarCapturaFormaPago (
	@Codigo		varchar(15)
) 
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado  bit
    
	SET @Resultado = 1
	IF ISNULL(@Codigo,'') <> ''
		IF NOT EXISTS(SELECT * FROM CB WHERE Codigo = @Codigo AND TipoCuenta = 'Forma Pago' )
			SELECT @Resultado = 0
  
	RETURN (@Resultado)
END
GO


/**************** fnPOSValidarCteMost ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSValidarCteMost') DROP FUNCTION fnPOSValidarCteMost
GO
CREATE FUNCTION dbo.fnPOSValidarCteMost (
	@Cliente		varchar(10)
) 
RETURNS bit
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
    @Resultado		bit,
    @RFC			varchar(15)
    
	SELECT @RFC = NULLIF(RFC,'')
	FROM Cte 
	WHERE Cliente = @Cliente
    
	SET @Resultado = 1
   
	IF NULLIF(@RFC,'') IS NOT NULL
		SET @Resultado = 0

	IF @Resultado = 1
	BEGIN 
		IF EXISTS (SELECT * FROM POSCteFacCred WHERE Cliente = @Cliente)
			SET @Resultado = 0
	END
  
	RETURN (@Resultado)
END
GO

      
/**************** fnPOSCalculaMoratoriosPagados ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPOSCalculaMoratoriosPagados') DROP FUNCTION fnPOSCalculaMoratoriosPagados
GO
CREATE FUNCTION fnPOSCalculaMoratoriosPagados (
	@Mov		varchar(20), 
	@MovID		varchar(20)
)
RETURNS float
--//WITH ENCRYPTION
AS 
BEGIN
	RETURN(SELECT ISNULL(SUM(d.DescuentoRecargos),0) 
		   FROM POSHistMoratorios m JOIN CxcD d ON m.IDGenerado = d.ID 
		   WHERE d.Aplica = @Mov AND d.AplicaID = @MovID)  
END
GO


/************************ spPOSAsociarTarjetaRegalo *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSAsociarTarjetaRegalo') AND type = 'P') DROP PROCEDURE dbo.spPOSAsociarTarjetaRegalo
GO             
CREATE PROCEDURE spPOSAsociarTarjetaRegalo
	@ID             varchar(36),
    @Monedero		varchar(20),
    @Usuario        varchar(10),
    @Estacion       int,
    @Importe		money
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@Cliente					varchar(10),
    @Proyecto					varchar(50),
	@Almacen					varchar(10),
	@Agente						varchar(10),
	@Cajero						varchar(10),
	@FormaEnvio					varchar(50),
	@Condicion					varchar(50),
	@Vencimiento				varchar(50),
	@Descuento					varchar(50),
	@DescuentoGlobal			varchar(50),
	@ListaPreciosEsp			varchar(20),
	@ZonaImpuesto				varchar(50),
	@ZonaImpuestoSucursal		varchar(50),
	@ImagenNombreAnexo			varchar(255),
	@Sucursal					int,	  
	@Nombre						varchar(100),
	@Direccion					varchar(100),
	@DireccionNumero			varchar(20),
	@DireccionNumeroInt			varchar(20),
	@EntreCalles				varchar(100),
	@Delegacion					varchar(100),
	@Colonia					varchar(100),
	@Poblacion					varchar(100),
	@Estado						varchar(50),
	@Pais						varchar(50),
	@Zona						varchar(50),
	@CodigoPostal				varchar(15),
	@RFC						varchar(15),
	@CURP						varchar(50),	
	@ListaPreciosSucursal		varchar(20),		
	@ListaPreciosUsuario		varchar(20),
	@Puntos						float,
	@Empresa					varchar(5),
	@Ok							int,
	@OkRef						varchar(255),
	@OKRefLDI					varchar(500),
	@MonederoLDI				bit,
    @FechaNacimiento			datetime,
    @EstadoCivil				varchar(20),
    @Conyuge					varchar(100),	
    @Sexo						varchar(20),	
    @Fuma						bit,
    @Profesion					varchar(100),	
    @Puesto						varchar(100),
    @NumeroHijos				int,
    @Religion					varchar(50),
    @ValorTarjeta				money	  
   
	BEGIN TRANSACTION
	
	SELECT @ValorTarjeta = Precio 
	FROM ValeSerie 
	WHERE Serie = @Monedero
   
	IF @Importe < = @ValorTarjeta AND @Monedero IS NOT NULL
		BEGIN
			IF EXISTS(SELECT * FROM POSValeSerie WHERE Serie = @Monedero) 
				SELECT @Cliente = Cliente FROM POSValeSerie WHERE Serie = @Monedero
   
			SELECT @Empresa = Empresa, @Sucursal = Sucursal 
			FROM POSL 
			WHERE ID = @ID
   
			SELECT @ListaPreciosSucursal = ListaPreciosEsp, @ZonaImpuestoSucursal = ZonaImpuesto
			FROM Sucursal
			WHERE Sucursal = @Sucursal   
   
			UPDATE POSL SET Monedero = @Monedero WHERE ID = @ID
     
			EXEC spPOSAltaMonedero @ID, @Usuario, @Empresa ,@Sucursal, @Cliente, @Monedero, @Ok OUTPUT 
		END 
	ELSE
		SELECT @OkRef = 'Saldo no corresponde al Valor de la Tarjeta'--30096
   
	IF @Monedero IS NULL
		SELECT @OkRef = NULL
   
	ROLLBACK TRANSACTION
   
	SELECT @OkRef
	
	RETURN
END
GO  


/************************ spPOSDesAsociarTarjetaRegalo *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSDesAsociarTarjetaRegalo') AND type = 'P') DROP PROCEDURE dbo.spPOSDesAsociarTarjetaRegalo
GO             
CREATE PROCEDURE spPOSDesAsociarTarjetaRegalo
	@ID             varchar(36),
    @Monedero		varchar(20),
    @Usuario        varchar(10),
    @Estacion       int
--//WITH ENCRYPTION           
AS 
BEGIN
	DECLARE 
	@Cliente					varchar(10),
    @Proyecto					varchar(50),
	@Almacen					varchar(10),
	@Agente						varchar(10),
	@Cajero						varchar(10),
	@FormaEnvio					varchar(50),
	@Condicion					varchar(50),
	@Vencimiento				varchar(50),
	@Descuento					varchar(50),
	@DescuentoGlobal			varchar(50),
	@ListaPreciosEsp			varchar(20),
	@ZonaImpuesto				varchar(50),
	@ZonaImpuestoSucursal		varchar(50),
	@ImagenNombreAnexo			varchar(255),
	@Sucursal					int,	  
	@Nombre						varchar(100),
	@Direccion					varchar(100),
	@DireccionNumero			varchar(20),
	@DireccionNumeroInt			varchar(20),
	@EntreCalles				varchar(100),
	@Delegacion					varchar(100),
	@Colonia					varchar(100),
	@Poblacion					varchar(100),
	@Estado						varchar(50),
	@Pais						varchar(50),
	@Zona						varchar(50),
	@CodigoPostal				varchar(15),
	@RFC						varchar(15),
	@CURP						varchar(50),	
	@ListaPreciosSucursal		varchar(20),		
	@ListaPreciosUsuario		varchar(20),
	@Puntos						float,
	@Importe					float,
	@Empresa					varchar(5),
	@Ok							int,
	@OkRef						varchar(255),
	@OKRefLDI					varchar(500),
	@MonederoLDI				bit,
    @FechaNacimiento			datetime,
    @EstadoCivil				varchar(20),
    @Conyuge					varchar(100),	
    @Sexo						varchar(20),	
    @Fuma						bit,
    @Profesion					varchar(100),	
    @Puesto						varchar(100),
    @NumeroHijos				int,
    @Religion					varchar(50)		  

	SELECT @Empresa = Empresa, @Sucursal = Sucursal 
	FROM POSL 
	WHERE ID = @ID
   
	SELECT @Cliente = DefCliente 
	FROM Usuario 
	WHERE Usuario = @Usuario
   
	SELECT @ListaPreciosSucursal = ListaPreciosEsp, @ZonaImpuestoSucursal = ZonaImpuesto
    FROM Sucursal
    WHERE Sucursal = @Sucursal   
   
	SELECT @MonederoLDI = 0
   
	IF @Cliente IS NOT NULL
		BEGIN
			SELECT  
				@Proyecto = ct.Proyecto,
				@Agente = ct.Agente,
				@FormaEnvio = ct.FormaEnvio,
				@Condicion = ct.Condicion,
				@Descuento = ct.Descuento,
				@DescuentoGlobal = d.Porcentaje,
				@ListaPreciosEsp = ISNULL(ISNULL(ISNULL(NULLIF(u.DefListaPreciosEsp,''), NULLIF(ct.ListaPreciosEsp,'')), NULLIF(@ListaPreciosSucursal,'')),'(Precio Lista)'),
				@ZonaImpuesto = ISNULL(ISNULL(NULLIF(u.DefZonaImpuesto,''),NULLIF(ct.ZonaImpuesto,'')),NULLIF(@ZonaImpuestoSucursal,'')),
				@Nombre	= ct.Nombre,
				@Direccion = ct.Direccion,
 				@DireccionNumero = ct.DireccionNumero,
 				@DireccionNumeroInt	= ct.DireccionNumeroInt,
				@EntreCalles = ct.EntreCalles,		
				@Delegacion	= ct.Delegacion,	
				@Colonia = ct.Colonia,	
				@Poblacion = ct.Poblacion,
				@Estado = ct.Estado,		
				@Pais = ct.Pais,			
				@Zona = ct.Zona,			
				@CodigoPostal = ct.CodigoPostal,
				@RFC = ct.RFC,		
				@CURP = ct.CURP,
				@FechaNacimiento = ct.FechaNacimiento,
				@EstadoCivil = ct.EstadoCivil,	 
				@Conyuge = ct.Conyuge,
				@Sexo = ct.Sexo,     
				@Fuma = ct.Fuma,   
				@Profesion = ct.Profesion,
				@Puesto = ct.Puesto,
				@NumeroHijos = ct.NumeroHijos,
				@Religion = ct.Religion  	     	     
			FROM Cte ct 
			LEFT OUTER JOIN Descuento d ON ct.Descuento = d.Descuento  
			JOIN Usuario u ON 1=1   
			WHERE ct.Cliente = @Cliente
			AND u.Usuario = @Usuario
         
			IF @Cliente IS NOT NULL  
				UPDATE POSL SET 
					Cliente = @Cliente, 
					Proyecto = @Proyecto, 
					FormaEnvio = @FormaEnvio, 
					Condicion = @Condicion, 
					Descuento = @Descuento, 
					DescuentoGlobal = @DescuentoGlobal, 
					ListaPreciosEsp = @ListaPreciosEsp, 
					ZonaImpuesto = @ZonaImpuesto,
					Nombre = @Nombre,
					Direccion = @Direccion,
					DireccionNumero	= @DireccionNumero,
					DireccionNumeroInt = @DireccionNumeroInt,
					EntreCalles	= @EntreCalles,
					Delegacion = @Delegacion,	
					Colonia = @Colonia,
					Poblacion = @Poblacion,
					Estado = @Estado,
					Pais = @Pais,
					Zona = @Zona,
					CodigoPostal = @CodigoPostal,
					RFC	= @RFC,
					CURP = @CURP,
					Monedero = @Monedero,
                    FechaNacimiento = @FechaNacimiento,	
                    EstadoCivil	= @EstadoCivil,
					Conyuge	= @Conyuge,	
					Sexo = @Sexo,	
					Fuma = @Fuma,
					Profesion = @Profesion ,	
					Puesto = @Puesto,		
					NumeroHijos	= @NumeroHijos,
                    Religion = @Religion		     	       
				WHERE ID = @ID                  
		END 
	ELSE        
		UPDATE POSL SET Monedero = @Monedero WHERE ID = @ID
     
	EXEC spPOSOfertaAplicar	@ID
   
	EXEC spPOSOfertaPuntosInsertarTemp @ID, NULL, 0, @Estacion     
	
	RETURN
END
GO 


/**************** spPOSCancelarPartida****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSCancelarPartida') AND type = 'P') DROP PROCEDURE dbo.spPOSCancelarPartida
GO             
CREATE PROCEDURE spPOSCancelarPartida
	@ID					varchar (36),
	@EliminaRenglon		bit
--//WITH ENCRYPTION
AS 
BEGIN
	INSERT INTO POSCancelarPartida (ID, EliminaRenglon) VALUES (@ID, @EliminaRenglon) 
END
GO


/**************** spPOSDevTotalBit ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSDevTotalBit') AND type = 'P') DROP PROCEDURE dbo.spPOSDevTotalBit
GO             
CREATE PROCEDURE spPOSDevTotalBit
	@ID				varchar (36),
	@Ofertados		bit
--//WITH ENCRYPTION
AS 
BEGIN
	INSERT INTO POSDevolucionTotal (ID, Ofertados) VALUES (@ID, @Ofertados) 
END
GO


/**************** fnPOSRegresaFormaPagoCambio ****************/
IF EXISTS(SELECT * FROM Sysobjects WHERE name = 'fnPOSRegresaFormaPagoCambio' AND type='FN') DROP FUNCTION dbo.fnPOSRegresaFormaPagoCambio
GO
CREATE FUNCTION fnPOSRegresaFormaPagoCambio (
	@FormaPago		varchar(50), 
	@Empresa		varchar(5)
)    
RETURNS varchar(50)    
--//WITH ENCRYPTION    
AS 
BEGIN    
	IF (SELECT PermiteCambio FROM FormaPago WHERE FormaPago = (SELECT FormaPago FROM CB WHERE  TipoCuenta = 'Forma Pago' AND Codigo = @FormaPago) ) = 1  
		SELECT @FormaPago = DefFormaPagoCambio FROM POSCfg WHERE Empresa = @Empresa     
	ELSE     
		SELECT @FormaPago = DefFormaPagoCambio FROM POSCfg WHERE Empresa = @Empresa  
    
	RETURN(@FormaPago)    
END 
GO


/************************ spPOSInsertarReferenciaCobroDoc *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSInsertarReferenciaCobroDoc') AND type = 'P') DROP PROCEDURE dbo.spPOSInsertarReferenciaCobroDoc
GO             
CREATE PROCEDURE spPOSInsertarReferenciaCobroDoc
	@Empresa        varchar(5), 
	@Sucursal       int, 
	@Usuario        varchar(10),
	@Estacion		int, 
	@ID             int,
	@IDPOS          varchar(36)
--//WITH ENCRYPTION	     	     
AS 
BEGIN
	DECLARE
    @Aplica                 varchar(20),
    @AplicaID               varchar(20),
    @Host                   varchar(20),
    @Caja                   varchar(10),
    @Orden                  int,
    @CXCSaldoTotal          float,
    @Moratorios				float,
    @TasaMoratorios			float,
    @Renglon				float,
    @DiasMoratorios			int,
	@ImporteReal			money, 
	@ImporteAPagar			money, 
	@ImporteMoratorio		money, 
	@MoratorioAPagar		money, 
	@Origen					varchar(20), 
	@OrigenID				varchar(20)
        
	SELECT @TasaMoratorios = ISNULL(CxcMoratoriosTasa,0)/100 
	FROM EmpresaCfg 
	WHERE Empresa = @Empresa  
      
	SELECT @Host = Host , @Caja = Caja 
	FROM POSL 
	WHERE ID = @IDPOS
  
	IF EXISTS (SELECT * FROM POSLVenta WHERE ID = @IDPOS)
		DELETE POSLVenta WHERE ID = @IDPOS
             
	DECLARE crFormaPago CURSOR LOCAL FOR
    SELECT Mov, MovID, ImporteAPagar, MoratorioAPagar, ImporteReal, ImporteAPagar, ImporteMoratorio, MoratorioAPagar, Origen, OrigenID
    FROM NegociaMoratoriosMAVI
    WHERE IDCobro = @ID   
    
	SET @Renglon = 2048.0   
    
	OPEN crFormaPago   
    FETCH NEXT FROM crFormaPago INTO @Aplica, @AplicaID, @CXCSaldoTotal, @Moratorios, @ImporteReal, @ImporteAPagar, @ImporteMoratorio, @MoratorioAPagar, @Origen, @OrigenID
    WHILE @@FETCH_STATUS <> -1
		BEGIN
			IF @@FETCH_STATUS <> -2
				BEGIN
					INSERT POSLVenta(
						ID, Renglon, RenglonID, RenglonTipo, Articulo, Cantidad, Aplica, AplicaID, Precio, PrecioImpuestoInc, ImporteReal, ImporteAPagar, 
						ImporteMoratorio, MoratorioAPagar, Origen, OrigenID)
					SELECT 
						@IDPOS, @Renglon, 1, 'K', 'COBRO', 1, @Aplica, @AplicaID, @CXCSaldoTotal, @CXCSaldoTotal, @ImporteReal, @ImporteAPagar, 
						@ImporteMoratorio, @MoratorioAPagar, @Origen, @OrigenID

					SET @Renglon = @Renglon + 2048.0	
	  
					IF @Moratorios > 0
						BEGIN
							INSERT POSLVenta(
								ID, Renglon, RenglonID, RenglonTipo, Articulo, Cantidad, Aplica, AplicaID, Precio, PrecioImpuestoInc, DiasMoratorios, TasaMoratorios,
								ImporteReal, ImporteAPagar, ImporteMoratorio, MoratorioAPagar, Origen, OrigenID)
							SELECT
								@IDPOS, @Renglon, 1, 'K', 'MORATORIO', 1, @Aplica, @AplicaID, @Moratorios, @Moratorios, @DiasMoratorios, @TasaMoratorios, 
								@ImporteReal, @ImporteAPagar, @ImporteMoratorio, @MoratorioAPagar, @Origen, @OrigenID 
						END

					SET @Renglon = @Renglon + 2048.0					  
				END
      
			FETCH NEXT FROM crFormaPago INTO @Aplica, @AplicaID, @CXCSaldoTotal, @Moratorios, @ImporteReal, @ImporteAPagar, @ImporteMoratorio, @MoratorioAPagar, 
				@Origen, @OrigenID
		END
	CLOSE crFormaPago
    DEALLOCATE crFormaPago
          
	UPDATE POSL SET CXCSaldoTotal = (SELECT SUM(d.Importe+d.Importe*c.DiasMoratorios*@TasaMoratorios) 
    FROM POSCxcAnticipoTemp c JOIN POSCxcAnticipoTempD d on c.Estacion = d.Estacion AND c.Mov = d.Aplica AND c.MovID = d.AplicaID)
    WHERE ID = @IDPOS
	  
	INSERT POSLAccion (
		Host,  Caja, Accion)
	VALUES (
		@Host, @Caja,'IMPORTE ANTICIPO')     
END
GO
 

/************************ spPOSUsuarioAutorizaValidaSucSup *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSUsuarioAutorizaValidaSucSup') AND type = 'P') DROP PROCEDURE dbo.spPOSUsuarioAutorizaValidaSucSup
GO             
CREATE PROCEDURE spPOSUsuarioAutorizaValidaSucSup
	@Usuario		varchar(20),
	@Sucursal		int
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE @PuedeAutorizar		int
  
	SELECT @PuedeAutorizar = 0
  
	IF EXISTS(SELECT 1 FROM UsuarioSucursalAcceso us WHERE us.Usuario = @Usuario AND us.Sucursal = @Sucursal) 
	OR EXISTS (SELECT 1 FROM Usuario u WHERE u.Usuario = @Usuario AND u.Sucursal = @Sucursal)
	OR (SELECT AccesarOtrasSucursalesEnLinea FROM Usuario u WHERE u.Usuario = @Usuario) = 1
	BEGIN 
		IF (SELECT u.POSEsSupervisor FROM Usuario u WHERE u.Usuario = @Usuario) = 1
			SELECT @PuedeAutorizar = 1 
	END  

	SELECT @PuedeAutorizar
END
GO


/************************ spPOSEstadoCaja *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSEstadoCaja') AND type = 'P') DROP PROCEDURE dbo.spPOSEstadoCaja
GO             
CREATE PROCEDURE spPOSEstadoCaja
	@ID				varchar(36),
	@Usuario		varchar(10)		 
--//WITH ENCRYPTION	     
AS 
BEGIN
	DECLARE	
	@EstatusCaja		int,
	@Caja				varchar(10),
	@Host				varchar(20),
	@Cajero				varchar(10),
	@Abierto			bit
						
	SELECT @Caja = NULLIF(Caja,''), @Host = NULLIF(Host,''), @Cajero = NULLIF(Cajero,'') 
	FROM POSL 
	WHERE ID = @ID AND Usuario = @Usuario 

	IF EXISTS (SELECT * FROM POSEstatusCaja WHERE Usuario = @Usuario AND Caja = @Caja AND Host = @Host AND Cajero = @Cajero)
		BEGIN
			SELECT @Abierto = Abierto
			FROM POSEstatusCaja 
			WHERE Usuario = @Usuario
			AND Caja = @Caja
			AND Host = @Host 
			AND Cajero = @Cajero
	   
			IF @Abierto = 0 
				SELECT @EstatusCaja = 0
		  
			IF @Abierto = 1 
				SELECT @EstatusCaja = 1	
		END
	ELSE
		SELECT @EstatusCaja = 0
	 
	SELECT @EstatusCaja
END
GO


/**************** spPOSTotales ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSTotales') AND sysstat & 0xf = 4) DROP PROCEDURE dbo.spPOSTotales
GO             
CREATE PROCEDURE spPOSTotales
	@Filtro			varchar(255),
	@Posicion		float
--//WITH ENCRYPTION
AS 
BEGIN 
	DECLARE
    @TAB				char(2),
    @SUBTOTALText		varchar(50),
    @DESCUENTOText		varchar(50),
    @IMPUESTOSTex		varchar(50)
    
	SET @TAB = '<BR>' 
	SET @SUBTOTALText = 'SUBTOTAL'
	SET @DESCUENTOText = 'DESCUENTO'
	SET @IMPUESTOSTex = 'IMPUESTOS'
    
	EXEC spExtraerDato  @Filtro OUTPUT, @SUBTOTALText OUTPUT, @TAB       
	EXEC spExtraerDato  @Filtro OUTPUT, @DESCUENTOText OUTPUT, @TAB     
	EXEC spExtraerDato  @Filtro OUTPUT, @IMPUESTOSTex OUTPUT, @TAB        

	IF @Posicion = 1
		SELECT SubTotal = '$ '+SUBSTRING(@SUBTOTALText,PATINDEX('%$%',@SUBTOTALText)+1,50)

	IF @Posicion = 2
		SELECT Descuento = '$ '+SUBSTRING(@DESCUENTOText,PATINDEX('%$%',@DESCUENTOText)+1,50)

	IF @Posicion = 3
		SELECT Impuestos = '$ '+SUBSTRING(@IMPUESTOSTex,PATINDEX('%$%',@IMPUESTOSTex)+1,50)      
END 
GO


/**************** spPOSDescuentoDirecto ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSDescuentoDirecto') AND sysstat & 0xf = 4) DROP PROCEDURE dbo.spPOSDescuentoDirecto
GO             
CREATE PROCEDURE spPOSDescuentoDirecto
	@ID				varchar(50),
	@Renglon		float
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Usuario	varchar(50)
		
    SELECT @Usuario = UsuarioAutoriza 
	FROM POSL 
	WHERE ID = @ID

    UPDATE POSLVenta SET Observaciones = 'Descuento Aplicado de manera Directa, Autorizado por: '+@Usuario WHERE ID = @ID AND Renglon = @Renglon     	  
END		
GO


/**************** spPOSInsertaDevolucionP ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSInsertaDevolucionP') AND sysstat & 0xf = 4) DROP PROCEDURE dbo.spPOSInsertaDevolucionP
GO             
CREATE PROCEDURE spPOSInsertaDevolucionP
	@ID			varchar(50),
	@Mov		varchar(50)	
--//WITH ENCRYPTION	
AS 
BEGIN
	DECLARE
	@IDDevolucion					varchar(36),
	@Articulo						varchar(20),
	@Renglon						float,
	@CantidadM						float,
	@Cantidad						float,
    @UsuarioAutoriza				varchar(10), 
	@Empresa						varchar(5),
	@CfgMultiUnidades				bit,
	@CfgVentaFactorDinamico			bit,
	@CfgNivelFactorMultiUnidad		varchar(20),
	@Unidad							varchar(50),
	@UnidadFactor					float

	SELECT @Empresa = Empresa FROM POSL WHERE ID = @ID

	SELECT 
		@CfgMultiUnidades			= ISNULL(MultiUnidades,0),
		@CfgVentaFactorDinamico		= ISNULL(VentaFactorDinamico,0),
		@CfgNivelFactorMultiUnidad	= ISNULL(NivelFactorMultiUnidad,0)
    FROM EmpresaCfg2
	WHERE Empresa = @Empresa    


	IF @Mov <> 'NOTA'
		BEGIN		
			UPDATE POSLVenta SET Cantidad = CantidadM, Observaciones = 'Aplico Devolucion' WHERE ID = @ID
			DELETE POSLVenta WHERE ID = @ID AND CantidadM IS NULL
	
			SELECT @IDDevolucion = IDDevolucion FROM POSL WHERE ID = @ID
			UPDATE POSL SET Devolucion = 0 WHERE ID = @IDDevolucion	  

			BEGIN	
				DECLARE crDev CURSOR LOCAL FOR
				SELECT Articulo, Renglon, CantidadM
				FROM POSLVenta
				WHERE ID = @ID 	
			
				OPEN crDev   
				FETCH NEXT FROM crDev INTO @Articulo, @Renglon, @CantidadM
				WHILE @@FETCH_STATUS <> -1
					BEGIN
						IF @@FETCH_STATUS <> -2
							BEGIN
								IF @CantidadM > = 0 AND @Mov <> 'NOTA'
									BEGIN 
										UPDATE POSLVenta SET Observaciones = 'Aplico Devolucion', CantidadM = ISNULL(CantidadM,0)+@CantidadM*-1  
										WHERE ID = @IDDevolucion AND Articulo = @Articulo AND Renglon = @Renglon
					
										UPDATE POSLVenta SET Cantidad = Cantidad *-1, CantidadM = CantidadM *-1  
										WHERE ID = @ID AND Articulo = @Articulo AND Renglon = @Renglon
									END  
								ELSE
									UPDATE POSLVenta SET Observaciones = 'Aplico Devolucion', CantidadM = ISNULL(CantidadM,0)+@CantidadM  
									WHERE ID = @IDDevolucion AND Articulo = @Articulo AND Renglon = @Renglon 
							END
						
						FETCH NEXT FROM crDev INTO @Articulo, @Renglon, @CantidadM
					END
				CLOSE crDev
				DEALLOCATE crDev
			END
		END

	IF @Mov = 'NOTA'
		BEGIN    
			SELECT @Articulo = NULL, @Renglon = NULL, @CantidadM = NULL, @Cantidad = NULL, @Unidad = NULL
			SELECT @UsuarioAutoriza = UsuarioAutoriza 
			FROM POSL 
			WHERE ID = @ID
    
			DECLARE crDev CURSOR LOCAL FOR
			SELECT Articulo, Renglon, CantidadM, Cantidad, Unidad
			  FROM POSLVenta
			 WHERE ID = @ID
			   AND ISNULL(CantidadM,0) <> 0	
    
			OPEN crDev   
			FETCH NEXT FROM crDev INTO @Articulo, @Renglon, @CantidadM, @Cantidad, @Unidad
			WHILE @@FETCH_STATUS <> -1
				BEGIN
					IF @@FETCH_STATUS <> -2 AND @CantidadM > = 0
						BEGIN
							SET @UnidadFactor = NULL
							IF @CfgMultiUnidades = 1 OR @CfgVentaFactorDinamico = 1
							BEGIN      
								EXEC spUnidadFactor @Empresa, @Articulo, NULL, @Unidad, @UnidadFactor OUTPUT
								
								IF @UnidadFactor IS NULL 
									SET @UnidadFactor = 1      
							END

							
							UPDATE POSLVenta 
							SET Cantidad			= CantidadM, 
							    CantidadInventario	= CASE WHEN @CfgMultiUnidades = 1 OR @CfgVentaFactorDinamico = 1 THEN CantidadM * @UnidadFactor ELSE NULL END, 
							    Observaciones		= 'Cantidad Original:'+CONVERT(varchar, @Cantidad)+' '+'Modificada por: '+@UsuarioAutoriza   
							WHERE ID = @ID AND Articulo = @Articulo AND Renglon = @Renglon     
            
						END
      
					FETCH NEXT FROM crDev INTO @Articulo, @Renglon, @CantidadM, @Cantidad, @Unidad
				END
			CLOSE crDev
			DEALLOCATE crDev
    
			UPDATE POSLVenta SET CantidadM = NULL  WHERE ID = @ID 
		END
END		
GO


/************************ spPOSVentaInsertaComision *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSVentaInsertaComision') AND type = 'P') DROP PROCEDURE dbo.spPOSVentaInsertaComision
GO             
CREATE PROCEDURE spPOSVentaInsertaComision
	@ID             varchar(36),
	@Servicio		varchar(20),	   
	@Empresa	    varchar(5),	 
	@Usuario	    varchar(10),
	@Sucursal	    int,
	@Importe        float,
	@Codigo         varchar(50)
--//WITH ENCRYPTION    	     
AS
BEGIN
	DECLARE 
	@RedondeoVenta				bit,
	@RedondeoVentaModificar		bit,
	@Articulo					varchar(20),
	@Unidad						varchar(50),
	@Renglon					float,
	@RenglonID					int,
	@ImporteMov					float,
	@Comision					float,
	@RedondeoSugerido			float,
	@RedondeoActual				float,
	@RedondeoMonetarios         int
	
	--BUG 12054 SE COMENTA HASTA QUE SE COMPLETE LA PARTE DE SDK PARA LAS COMISIONES
	
	--SELECT @Articulo = Cuenta
 --   FROM CB
	--WHERE Codigo = 'COMISIONSERV'
 --   AND TipoCuenta = 'Articulos'
  
	--SELECT @Unidad = a.Unidad, @Importe = b.Importe 
 --   FROM Art a join ArtComision b on a.Comision = b.Comision
 --   JOIN POSLVenta v on a.Articulo = v.Articulo 
	--WHERE v.ID = @ID  

	----AQUI INSERTA LA COMISION
	--IF EXISTS(SELECT * FROM POSLVenta plv WHERE plv.ID = @ID AND plv.Articulo = @Articulo)
	--	UPDATE POSLVenta SET Precio = @Importe, PrecioImpuestoInc = @Importe, AplicaDescGlobal = 0 WHERE ID = @ID AND Articulo = @Articulo
 --   ELSE
	--	BEGIN
	--		IF EXISTS (SELECT * FROM POSLVenta WHERE ID = @ID AND Articulo = @Articulo)
	--			DELETE POSLVenta WHERE ID = @ID AND Articulo = @Articulo
      
	--		SELECT 
	--			@Renglon = MAX(Renglon),
	--			@RenglonID = MAX(RenglonID)
	--		FROM POSLVenta plv
	--		WHERE plv.ID = @ID
      
	--		SELECT 
	--			@Renglon = ISNULL(@Renglon, 0) + 2048,
	--			@RenglonID = ISNULL(@RenglonID, 0) + 1
	       	        
	--		INSERT POSLVenta (
	--			ID, Renglon, RenglonID, RenglonTipo, Cantidad, Articulo, Precio, Unidad, Factor, CantidadInventario, PrecioImpuestoInc, AplicaDescGlobal, Codigo)
 --           VALUES (
	--			@ID, @Renglon, @RenglonID, 'N', 1, @Articulo, @Importe, @Unidad, 1, 1, @Importe,0, @Codigo)
	--	END 
	RETURN 
END    	     
GO


/************************ xpPOSLGuardar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.xpPOSLGuardar') AND type = 'P') DROP PROCEDURE dbo.xpPOSLGuardar
GO    
CREATE PROCEDURE xpPOSLGuardar
	@Empresa		varchar(5),  
	@Sucursal		int,  
	@ID				varchar(36),  
	@Mov			varchar(20),
	@Cliente		varchar(10)
AS 
BEGIN  
	DECLARE 
	@Resultado		bit
	
	SELECT @Resultado = 0

	SELECT 'Resultado' = @Resultado
END  
GO


/************************ spPOSEstadoCajaV *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSEstadoCajaV') AND type = 'P') DROP PROCEDURE dbo.spPOSEstadoCajaV
GO             
CREATE PROCEDURE spPOSEstadoCajaV
	@Usuario   varchar(10)         
--//WITH ENCRYPTION      
AS 
BEGIN
	DECLARE 
	@EstatusCaja		int,
	@Caja				varchar(10),
	@Host				varchar(20),
	@Cajero				varchar(10),
	@Abierto			bit   

	SELECT @Caja = NULLIF(DefCtaDinero,''), @Cajero = NULLIF(DefCajero,'') 
	FROM Usuario 
	WHERE Usuario = @Usuario 
	
	SELECT @Host = NULLIF(HOST,'') 
	FROM CtaDinero 
	WHERE CtaDinero = @Caja
	
	SELECT @Abierto = 0 , @EstatusCaja = NULL
      
	IF EXISTS (SELECT * FROM POSEstatusCaja WHERE Usuario = @Usuario AND Caja = @Caja AND Host = @Host AND Cajero = @Cajero) 
		BEGIN
			SELECT @Abierto = Abierto
			FROM POSEstatusCaja 
			WHERE Usuario = @Usuario
			AND Caja = @Caja
			AND Host = @Host 
			AND Cajero = @Cajero

			IF @Abierto = 0 
				SELECT @EstatusCaja = 0

			IF @Abierto = 1 
				SELECT @EstatusCaja = 1 
		END
 
	IF @EstatusCaja IS NULL
		SELECT @EstatusCaja = 0
      
	SELECT @EstatusCaja
END
GO


/************************ spPOSActualizaAgenteDetalle *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSActualizaAgenteDetalle') AND type = 'P') DROP PROCEDURE dbo.spPOSActualizaAgenteDetalle
GO             
CREATE PROCEDURE spPOSActualizaAgenteDetalle
	@ID				varchar(50),
	@Agente			varchar(10),
	@Renglon		float,
	@Sucursal		int,
	@Ok				int = NULL				OUTPUT,
	@OkRef			varchar(255) = NULL		OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	IF EXISTS(SELECT * FROM Agente WHERE Estatus = 'ALTA' AND  Agente = @Agente AND SucursalEmpresa = @Sucursal )
		BEGIN
			UPDATE POSLVenta SET Agente = @Agente WHERE ID = @ID AND Renglon = @Renglon
		END 
	ELSE
		SELECT @Ok = 304190, @OkRef = 'Sucursal del Agente Incorrecta o Agente en Estatus Baja, Verifique....'

	SELECT @OkRef
END
GO


/**************** spGenerarArticulo****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spGenerarArticulo') AND type = 'P') DROP PROCEDURE dbo.spGenerarArticulo
GO
CREATE PROCEDURE spGenerarArticulo
	@ID				int,
	@Empresa		varchar(5),
	@Sucursal		int
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
	@Mensaje				varchar(MAX),
	@Articulo				varchar(20),
	@ListaModificarP		varchar(20),
	@FechainicioP			datetime,
	@FechaterminoP			datetime,
	@Unidad					varchar(50),
	@Nuevo					money,
	@Anterior				money,
	@MonedaPrecio			varchar(10),
	@Usuario				varchar(10),
	@IDPrecios				int,
	@MovID					varchar(20)
	
	SELECT @Articulo = Articulo 
	FROM HArticulos 
	WHERE ID = @ID
	
	IF NOT EXISTS (SELECT Articulo FROM Art WHERE Articulo = @Articulo )
		BEGIN
			INSERT INTO Art (
				Articulo, Tipo, Descripcion1, Unidad, UnidadCompra, Unidadtraspaso, TipoCosteo, Grupo, Familia, Linea, Categoria, 
				Impuesto1, Impuesto2, Impuesto3, TipoCompra, Proveedor, SeVende, SeCompra, Cuenta, Cuenta2,   Cuenta3, BasculaPesar, 
				Estatus, MonedaCosto, MonedaPrecio)
			SELECT 
				Articulo, Tipo, Descripcion1, Unidad, UnidadCompra, Unidadtraspaso, TipoCosteo,  Grupo, Familia, Linea, Categoria, 
				Impuesto1, Impuesto2, Impuesto3, TipoCompra, Proveedor, SeVende, SeCompra, Cuenta, Cuenta2, Cuenta3, BasculaPesar, 
				Estatus, MonedaCosto, MonedaPrecio
			FROM HArticulos
			WHERE ID = @ID
		 
			INSERT INTO CB (
				Codigo,    TipoCuenta,    Cuenta,   Cantidad, Unidad)
			SELECT 
				CodigoCB, TipoCuentaCB, Articulo, CantidadCB, UnidadCB
		    FROM HArticulos
			WHERE ID = @ID
		   
			DECLARE crCabecero CURSOR FOR
			SELECT ListaModificarP, FechainicioP, FechaterminoP, Unidad, Nuevo, Anterior, MonedaPrecio, ISNULL(Usuario, 'DEMO'), Articulo
		    FROM HArticulos
			WHERE ID = @ID
		
			OPEN crCabecero
			FETCH NEXT FROM crCabecero INTO @ListaModificarP, @FechainicioP, @FechaterminoP, @Unidad, @Nuevo, @Anterior, @MonedaPrecio, @Usuario, @Articulo
			WHILE @@FETCH_STATUS <> -1 AND @@Error = 0
				BEGIN
					IF @@FETCH_STATUS <> -2
						BEGIN
							INSERT INTO PC(
								Empresa, Mov, Fechaemision, Moneda, TipoCambio, Usuario, Estatus, Fechainicio, FechaTermino, Sucursal, ListaModificar, 
								SucursalOrigen, SucursalDestino, OrigenID, Observaciones)
							VALUES(
								@Empresa, 'Precios', GETDATE(), @MonedaPrecio, 1.00, @Usuario, 'SINAFECTAR', @FechainicioP, @FechaterminoP,	 @Sucursal, @ListaModificarP,
								@Sucursal, @Sucursal, @ID, 'Movimiento Generado desde la Herramienta de Alta de Articulos (POS) por el Usuario: '+CONVERT(varchar, @Usuario))

							SELECT @IDPrecios = SCOPE_IDENTITY()
		      
							INSERT INTO PCD(
								Id, Renglon, Articulo, Unidad, Nuevo, Anterior, baja, ListaModificar, Sucursal, SucursalOrigen)
							VALUES(
								@IDPrecios, 2048, @Articulo, @Unidad, @Nuevo, @Anterior, 0, @ListaModificarP, @Sucursal, @Sucursal)
		      
							EXEC spAfectar 'PC', @IDPrecios, 'AFECTAR', 'Todo', NULL, @Usuario
		   
							UPDATE HArticulos SET EstatusRegistro = 'PROCESADO'
							UPDATE HArticulos SET DestinoID = @IDPrecios WHERE ID = @ID
		   
							SELECT @MovID = MovID 
							FROM PC 
							WHERE ID = @IDPrecios
		   
							SELECT @Mensaje = 'El alta del Articulo: '+CONVERT(varchar, @Articulo)+' se Genero de manera correcta'+'<BR><BR>'+
								'y se Genero el Movimento de asignacion de Precio no: '+ CONVERT(varchar, @MovID)
						END
		
					FETCH NEXT FROM crCabecero INTO @ListaModificarP, @FechainicioP, @FechaterminoP, @Unidad, @Nuevo, @Anterior
				END
			CLOSE crCabecero
			DEALLOCATE crCabecero
	    END 
	ELSE	    
		SELECT @Mensaje = 'El articulo ya existe en el catalogo'
	
	SELECT @Mensaje
END
GO


/**************** spPOSSugerirCobro ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSSugerirCobro') AND type = 'P') DROP PROCEDURE dbo.spPOSSugerirCobro
GO             
CREATE PROCEDURE spPOSSugerirCobro
	@SugerirPago		varchar(20),
	@Modulo				char(5),
	@ID					varchar(36),
    @ImporteTotal		money = NULL
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE
    @Empresa						char(5),
    @Sucursal						int,
    @Hoy							datetime,
    @Vencimiento					datetime,
    @DiasCredito					int,
    @DiasVencido					int,
    @TasaDiaria						float,
    @Moneda							char(10),
    @TipoCambio						float,
    @Contacto						char(10),
    @Renglon						float,
    @Aplica							varchar(20),
    @AplicaID						varchar(20),
    @AplicaMovTipo					varchar(20),
    @Capital						money,
    @SaldoInteresesOrdinarios		money,
    @SaldoInteresesMoratorios		money,
    @SaldoMoratorios				money,
    @ImpuestoAdicional				float,
    @Importe						money,
    @SumaImporte					money,
    @Impuestos						money,
    @DesglosarImpuestos 			bit,
    @LineaCredito					varchar(20),
    @Metodo							int,
    @Estacion						int,
    @TasaMoratorios					float,
    @SaldoTotal						money,
    @Mydate							datetime

	SELECT @DesglosarImpuestos = 0 , @Renglon = 0.0, @SumaImporte = 0.0, @ImporteTotal = NULLIF(@ImporteTotal, 0.0), 
		@SugerirPago = UPPER(@SugerirPago), @SaldoMoratorios = 0.0       
    
	IF @SugerirPago <> 'IMPORTE ESPECIFICO' 
		SELECT @ImporteTotal = NULL 

	IF @Modulo = 'CXC'
		BEGIN
			SELECT @Empresa = Empresa, @Sucursal = 0, @Hoy = FechaEmision, @Moneda = Moneda, @TipoCambio = TipoCambio, @Contacto = Cliente   
			FROM POSL 
			WHERE ID = @ID 
			
			SELECT @TasaMoratorios = ISNULL(CxcMoratoriosTasa,0)/100 
			FROM EmpresaCfg 
			WHERE Empresa = @Empresa  

			DECLARE crAplica CURSOR FOR
			SELECT 
				p.Estacion, 
				p.Mov, 
				p.MovID, 
				p.Vencimiento, 
				mt.Clave, 
				ISNULL(p.Saldo*mt.Factor*p.MovTipoCambio/@TipoCambio, 0.0), 
				ISNULL(p.SaldoInteresesOrdinarios*mt.Factor*p.MovTipoCambio/@TipoCambio, 0.0), 
				ABS(ISNULL(p.SaldoInteresesMoratorios,0)-ISNULL(p.Saldo*mt.Factor*p.MovTipoCambio/@TipoCambio, 0.0)*ISNULL(p.DiasMoratorios*@TasaMoratorios, 0.0)),
				ta.Metodo, 
				p.LineaCredito, 
				p.Cliente     
			FROM POSCxcAnticipoTemp p 
			JOIN MovTipo mt ON mt.Modulo = @Modulo AND mt.Mov = p.Mov
			LEFT OUTER JOIN CfgAplicaOrden a ON a.Modulo = @Modulo AND a.Mov = p.Mov
			LEFT OUTER JOIN Cxc r ON r.ID = p.RamaID
			LEFT OUTER JOIN TipoAmortizacion ta ON ta.TipoAmortizacion = r.TipoAmortizacion
			WHERE p.Empresa = @Empresa AND p.Cliente = @Contacto AND mt.Clave NOT IN ('CXC.SCH','CXC.SD')
			ORDER BY a.Orden, p.Vencimiento, p.Mov, p.MovID
		
			SELECT @DesglosarImpuestos = ISNULL(CxcCobroImpuestos, 0) FROM EmpresaCfg2 WHERE Empresa = @Empresa	  
		END 
	ELSE
		IF @Modulo = 'CXP' 
			BEGIN
				DECLARE crAplica CURSOR FOR
				SELECT 
					p.Estacion, 
					p.Mov, 
					p.MovID, 
					p.Vencimiento, 
					mt.Clave, 
					ISNULL(p.Saldo*mt.Factor*p.MovTipoCambio/@TipoCambio, 0.0), 
					ISNULL(p.SaldoInteresesOrdinarios*mt.Factor*p.MovTipoCambio/@TipoCambio, 0.0), 
					ISNULL(p.SaldoInteresesMoratorios*mt.Factor*p.MovTipoCambio/@TipoCambio, 0.0), 
					ta.Metodo, 
					p.LineaCredito, 
					p.Cliente
				FROM POSCxcAnticipoTemp p
				JOIN MovTipo mt ON mt.Modulo = @Modulo AND mt.Mov = p.Mov
				LEFT OUTER JOIN CfgAplicaOrden a ON a.Modulo = @Modulo AND a.Mov = p.Mov
				LEFT OUTER JOIN Cxc r ON r.ID = p.RamaID
				LEFT OUTER JOIN TipoAmortizacion ta ON ta.TipoAmortizacion = r.TipoAmortizacion
				ORDER BY a.Orden, p.Vencimiento, p.Mov, p.MovID
			END 
		ELSE
			RETURN
		
	IF (SELECT Grupo FROM Cte WHERE Cliente =  @Contacto) = 'Par'
		BEGIN
			SELECT @Mydate = CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,@Hoy))),DATEADD(mm,1,@Hoy)))
		END 
	ELSE		    
		SELECT @Mydate = CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,@Hoy))+15),DATEADD(mm,1,@Hoy)))
	
	OPEN crAplica
	FETCH NEXT FROM crAplica INTO @Estacion, @Aplica, @AplicaID, @Vencimiento, @AplicaMovTipo, @Capital, @SaldoInteresesOrdinarios, @SaldoInteresesMoratorios, 
		@Metodo, @LineaCredito, @Contacto
	WHILE @@FETCH_STATUS <> -1 AND ((@SugerirPago = 'MINIMO' AND @Vencimiento<=@Mydate) OR (@SugerirPago = 'SALDO VENCIDO' AND @Vencimiento<=@Hoy) OR 
		(@SugerirPago = 'IMPORTE ESPECIFICO' AND @ImporteTotal > @SumaImporte) OR @SugerirPago = 'SALDO TOTAL')
		BEGIN
			IF @@FETCH_STATUS <> -2 
				BEGIN      		
					SELECT @SaldoMoratorios = SUM(ISNULL(h.Moratorios,0))
					FROM POSHistMoratorios h JOIN CxcD d ON d.ID = h.IDGenerado AND h.Aplica = d.Aplica AND h.AplicaID = d.AplicaID
					JOIN Cxc c ON c.ID = d.ID
					WHERE c.Estatus = 'CONCLUIDO' AND d.Aplica = @Aplica AND d.AplicaID = @AplicaID
		  
					IF @SaldoMoratorios = NULL
						SELECT @SaldoMoratorios = 0.0
		   
					-- BORRAR INTERESES ORDINARIOS CUANDO SON POR ANTICIPADO
					IF @Metodo IN (12, 22) 
						SELECT @SaldoInteresesOrdinarios = 0.0
					
					IF @Metodo = 50 
						SELECT @ImpuestoAdicional = DefImpuesto 
						FROM EmpresaGral 
						WHERE Empresa = @Empresa ELSE SELECT @ImpuestoAdicional = NULL

					-- INTERESES MORATORIOS
					IF @SumaImporte + @SaldoInteresesMoratorios > @ImporteTotal 
						SELECT @SaldoInteresesMoratorios = (@ImporteTotal - @SumaImporte)
		  
					SELECT @SumaImporte = @SumaImporte + @SaldoInteresesMoratorios

					-- INTERESES ORDINARIOS
					IF @SumaImporte + @SaldoInteresesOrdinarios > @ImporteTotal 
						SELECT @SaldoInteresesOrdinarios = @ImporteTotal - @SumaImporte
					
					SELECT @SumaImporte = @SumaImporte + @SaldoInteresesOrdinarios	      

					SELECT @SaldoInteresesMoratorios = @SaldoInteresesMoratorios-@SaldoMoratorios		  

					IF @SaldoInteresesMoratorios <> 0.0 OR @SaldoInteresesOrdinarios <> 0.0 OR @Capital <> 0.0
						BEGIN
							SELECT @Renglon = @Renglon + 2048.0
						
							IF @Modulo = 'CXC'
								INSERT POSCxcAnticipoTempD (
									Estacion, ID, Sucursal, Renglon, Aplica, AplicaID, Importe, InteresesOrdinarios, 
									InteresesMoratorios, ImpuestoAdicional, TasaMoratorios) 
								VALUES (
									@Estacion, 0, @Sucursal, @Renglon, @Aplica, @AplicaID, NULLIF(@Capital, 0.0), NULLIF(@SaldoInteresesOrdinarios, 0.0), 
									ABS(NULLIF(@SaldoInteresesMoratorios, 0.0)), @ImpuestoAdicional, @TasaMoratorios)
							ELSE
								INSERT POSCxcAnticipoTempD (
									Estacion, ID, Sucursal, Renglon, Aplica, AplicaID, Importe, InteresesOrdinarios, 
									InteresesMoratorios, TasaMoratorios) 
								VALUES (
									@Estacion, 0, @Sucursal, @Renglon, @Aplica, @AplicaID, NULLIF(@Capital, 0.0), NULLIF(@SaldoInteresesOrdinarios, 0.0), 
									ABS(NULLIF(@SaldoInteresesMoratorios, 0.0)), @TasaMoratorios)
						END
		  
					FETCH NEXT FROM crAplica INTO @Estacion, @Aplica, @AplicaID, @Vencimiento, @AplicaMovTipo, @Capital, @SaldoInteresesOrdinarios,
						@SaldoInteresesMoratorios, @Metodo, @LineaCredito, @Contacto
				END
		END
	CLOSE crAplica
	DEALLOCATE crAplica

	SELECT @SaldoTotal = @ImporteTotal-SUM(ISNULL(InteresesMoratorios,0)) 
	FROM POSCxcAnticipoTempD 
	WHERE Estacion = @Estacion

	IF @SaldoTotal > 0	  
		SELECT @Capital = 0.0
	
	SELECT @SumaImporte = 0.0
	  
	BEGIN
	DECLARE crAplicaD CURSOR FOR
	SELECT Estacion, Sucursal, Renglon, Aplica, AplicaID, Importe
	FROM POSCxcAnticipoTempD
	WHERE Estacion = @Estacion 
	
	OPEN crAplicaD
	FETCH NEXT FROM crAplicaD INTO @Estacion, @Sucursal, @Renglon, @Aplica, @AplicaID, @Capital
	WHILE @@FETCH_STATUS <> -1 AND ((@SugerirPago = 'MINIMO' AND @Vencimiento<=@Mydate) OR(@SugerirPago = 'SALDO VENCIDO' AND @Vencimiento<=@Hoy) 
		OR (@SugerirPago = 'IMPORTE ESPECIFICO' AND @ImporteTotal > @SumaImporte) OR @SugerirPago = 'SALDO TOTAL')
		BEGIN
			IF @@FETCH_STATUS <> -2 
				BEGIN      		
					-- CAPITAL
					IF @SumaImporte + @Capital > @SaldoTotal 
						SELECT @Capital = @SaldoTotal - @SumaImporte
		  
					SELECT @SumaImporte = @SumaImporte + @Capital

					IF @SaldoTotal > 0.0 
						BEGIN
							IF @Modulo = 'CXC'
								UPDATE POSCxcAnticipoTempD SET Importe = @Capital, Aplicado = 1 
								WHERE Estacion = @Estacion AND Sucursal = @Sucursal AND Renglon = @Renglon AND Aplica = @Aplica AND AplicaID = @AplicaID         
							ELSE
					
							UPDATE POSCxcAnticipoTempD SET Importe = @SaldoTotal, Aplicado = 1 
							WHERE Estacion = @Estacion AND Sucursal = @Sucursal AND Renglon = @Renglon AND Aplica = @Aplica AND AplicaID = @AplicaID         	          
						END

					IF @SaldoTotal = 0.0 
						BEGIN
							IF @Modulo = 'CXC'
								UPDATE POSCxcAnticipoTempD SET Importe = 0.0 , Aplicado = 1 
								WHERE Estacion = @Estacion AND Sucursal = @Sucursal AND Renglon = @Renglon AND Aplica = @Aplica AND AplicaID = @AplicaID         
							ELSE
								UPDATE POSCxcAnticipoTempD SET Importe = 0.0, Aplicado = 1 
								WHERE Estacion = @Estacion AND Sucursal = @Sucursal AND Renglon = @Renglon AND Aplica = @Aplica AND AplicaID = @AplicaID         	         
						END

					FETCH NEXT FROM crAplicaD INTO  @Estacion, @Sucursal, @Renglon, @Aplica, @AplicaID, @Capital
				END
		END
	CLOSE crAplicaD
	DEALLOCATE crAplicaD
	END
	
	RETURN
END
GO


/*************** spPOSServicios *******************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSServicios') AND type = 'P') DROP PROCEDURE dbo.spPOSServicios
GO             
CREATE PROCEDURE spPOSServicios
	@ID		varchar(255)			
--//WITH ENCRYPTION
AS 
BEGIN
	SELECT 
		A.ID,
		A.Empresa,
		A.Mov,
		A.MovID,
		A.FechaEmision,
		A.Moneda,
		A.TipoCambio,
		A.Usuario,
		A.Referencia,
		A.Estatus,
		A.Cliente,
		A.Nombre,
		A.Cajero,
		A.CtaDinero,
		A.CtaDineroDestino,
		A.Sucursal,
		B.Articulo,
		B.Cantidad,
		B.Precio,
		B.LDIServicio,
		C.FormaPago,
		C.Importe,
		D.Referencia1,
		D.Referencia2,
		'Carrier'=SUBSTRING(Referencia2,294,8),
		D.Referencia3,
		E.Nombre,
		E.RFC,
		E.Direccion,
		E.DireccionNumero,
		E.DireccionNumeroInt,
		E.Colonia,
		E.CodigoPostal,
		E.Estado,
		E.Telefonos,
		F.Nombre,
		F.Colonia,
		F.Estado,
		F.Telefonos	
	FROM POSL A
	JOIN POSLVenta B ON B.ID=A.ID
	JOIN  POSLCobro C ON C.ID=A.ID
	LEFT OUTER JOIN POSLDIVentaID D ON D.ID=A.ID
	JOIN Empresa E ON E.Empresa=A.Empresa
	JOIN Sucursal F ON F.Sucursal=A.Sucursal
	WHERE A.ID=@ID 

  RETURN
END
GO


/************************ POSCorteCaja*****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.POSCorteCaja') AND type = 'P') DROP PROCEDURE dbo.POSCorteCaja
GO             
CREATE PROCEDURE POSCorteCaja  
	@Fecha		datetime,   
    @Cajero		varchar(20)   
--//WITH ENCRYPTION 
AS 
BEGIN  
	CREATE TABLE #POSCorteCaja (  
        Num			int,   
        Concepto	varchar(25),   
        Cantidad    money)  
      
    INSERT INTO #POSCorteCaja  
    SELECT 'Num' = 0,   
           'Concepto' = '',   
           'Cantidad' = 0  
      
	INSERT INTO #POSCorteCaja  
    SELECT 'Num' = 1,   
           'Concepto' = 'Venta',  
           'Cantidad' = ISNULL(ROUND(SUM(CONVERT(Money, ISNULL((d.Cantidad * d.Precio) * (1 - ISNULL(ROUND(d.DescuentoLinea, 2), 0) / 100), 0))), 2), 0) - ISNULL(SUM(ISNULL(d.CantidadObsequio, 0) * d.Precio), 0)  
    FROM POSLVenta d  
    JOIN POSL e ON d.ID = e.ID  
    JOIN Art a ON d.Articulo = a.Articulo  
    WHERE e.Mov IN ('Nota', 'Otros Ingresos') AND e.Modulo = 'VTAS' AND a.Tipo != 'SERVICIO' 
	AND e.Usuario = @Cajero AND CONVERT(Date, FechaEmision) = @Fecha AND e.Estatus IN ('CONCLUIDO','TRASPASADO')  
      
	INSERT INTO #POSCorteCaja  
    SELECT 'Num' = 1,   
           'Concepto' = 'Venta Credito',  
           'Cantidad' = ISNULL(ROUND(SUM(CONVERT(Money, ISNULL((d.Cantidad * d.Precio) * (1 - ISNULL(ROUND(d.DescuentoLinea, 2), 0) / 100), 0))), 2), 0)  
    FROM POSLVenta d  
    JOIN POSL e ON d.ID = e.ID  
    JOIN Art a ON d.Articulo = a.Articulo  
    WHERE e.Mov = 'Venta Credito' AND e.Modulo = 'VTAS' AND a.Tipo != 'SERVICIO' 
	AND e.Usuario = @Cajero AND CONVERT(Date, FechaEmision) = @Fecha AND e.Estatus IN ('CONCLUIDO','TRASPASADO')  
      
    INSERT INTO #POSCorteCaja  
    SELECT 'Num' = 2,   
           'Concepto' = 'I.V.A.',  
           'Cantidad' = ISNULL(ROUND(SUM(CONVERT(Money, ISNULL((d.Cantidad * d.Precio) * (1 - ISNULL(ROUND(d.DescuentoLinea, 2), 0) / 100) * (ISNULL(d.Impuesto1, 0) / 100), 0))), 2), 0) - ISNULL(SUM(ISNULL(d.CantidadObsequio, 0) * d.Precio * (d.impuesto1/ 100)), 0)  
    FROM POSLVenta d  
    JOIN POSL e ON d.ID = e.ID  
    JOIN Art a ON d.Articulo = a.Articulo  
    WHERE e.Mov IN ('Nota', 'Venta Credito', 'Otros Ingresos') AND e.Modulo = 'VTAS' AND a.Tipo != 'SERVICIO' 
	AND e.Usuario = @Cajero AND CONVERT(Date, FechaEmision) = @Fecha AND e.Estatus IN ('CONCLUIDO','TRASPASADO')  
      
    INSERT INTO #POSCorteCaja  
    SELECT 'Num' = 3,   
           'Concepto' = 'Donativos',  
           'Cantidad' = ISNULL(ROUND(SUM(CONVERT(Money, ISNULL((d.Cantidad * d.Precio) * (1 - ISNULL(ROUND(d.DescuentoLinea, 2), 0) / 100), 0))), 2), 0)  
    FROM POSLVenta d  
    JOIN POSL e ON d.ID = e.ID  
    JOIN Art a ON d.Articulo = a.Articulo  
    WHERE e.Mov IN ('Nota', 'Otros Ingresos') AND e.Modulo = 'VTAS' AND d.Articulo = 'DONATIVOS' 
	AND e.Usuario = @Cajero AND CONVERT(Date, FechaEmision) = @Fecha AND e.Estatus IN ('CONCLUIDO','TRASPASADO')  
            
    INSERT INTO #POSCorteCaja  
    SELECT 'Num' = 4,   
           'Concepto' = 'Recargas a Celular',  
           'Cantidad' = ISNULL(ROUND(SUM(CONVERT(Money, ISNULL((d.Cantidad * d.Precio) * (1 - ISNULL(ROUND(d.DescuentoLinea, 2), 0) / 100), 0))), 2), 0)  
    FROM POSLVenta d  
    JOIN POSL e ON d.ID = e.ID  
    JOIN Art a ON d.Articulo = a.Articulo  
    WHERE e.Mov IN ('Nota', 'Otros Ingresos') AND e.Modulo = 'VTAS' AND (a.Tipo = 'SERVICIO' AND d.Articulo != 'DONATIVOS') 
	AND e.Usuario = @Cajero AND CONVERT(Date, FechaEmision) = @Fecha AND e.Estatus IN ('CONCLUIDO','TRASPASADO')  
  
    INSERT INTO #POSCorteCaja  
    SELECT 'Num' = 4,   
           'Concepto' = 'Otros Ingresos',  
           'Cantidad' = ISNULL(ROUND(SUM(CONVERT(Money, ISNULL((d.Cantidad * d.Precio) * (1 - ISNULL(ROUND(d.DescuentoLinea, 2), 0) / 100), 0))), 2), 0)  
    FROM POSLVenta d  
    JOIN POSL e ON d.ID = e.ID  
    JOIN Art a ON d.Articulo = a.Articulo  
    WHERE e.Mov IN ('Nota', 'Otros Ingresos') AND e.Modulo = 'VTAS' 
	AND (a.Tipo = 'SERVICIO' AND d.Articulo != 'DONATIVOS' AND d.Articulo IN ('AguaPotable','Predial')) AND   
           e.Usuario = @Cajero AND CONVERT(Date, FechaEmision) = @Fecha AND e.Estatus IN ('CONCLUIDO','TRASPASADO')  
                 
    INSERT INTO #POSCorteCaja  
    SELECT 'Num' = 5,   
           'Concepto' = 'T O T A L',  
           'Cantidad' = ISNULL(ROUND(SUM(CONVERT(Money, ISNULL((d.Cantidad * d.Precio) * (1 - ISNULL(ROUND(d.DescuentoLinea, 2), 0) / 100) * (1 + ISNULL(d.Impuesto1, 0) / 100), 0))), 2), 0) - ISNULL(SUM(ISNULL(d.cantidadObsequio, 0) * d.Precio * (1 + (d.Impuesto1 / 100))), 0)  
    FROM POSLVenta d  
    JOIN POSL      e ON d.ID       = e.ID  
    WHERE e.Mov IN ('Nota', 'Venta Credito', 'Otros Ingresos') AND e.Modulo = 'VTAS' 
	AND e.Usuario = @Cajero AND CONVERT(Date, FechaEmision) = @Fecha AND e.Estatus IN ('CONCLUIDO','TRASPASADO')  
      
    INSERT INTO #POSCorteCaja  
    SELECT 'Num' = 6,   
           'Concepto' = '',   
           'Cantidad' = 0  
  
    INSERT INTO #POSCorteCaja  
    SELECT 'Num' = 7,   
           'Concepto' = c.formaPago,   
           'Cantidad' = CASE WHEN ISNULL(SUM(ISNULL(c.importe,0)) ,0) IS NULL THEN 0 ELSE -(ISNULL(SUM(ISNULL(c.importe,0)) ,0)) END  
    FROM POSLCobro c   
    INNER JOIN POSL p ON p.ID=c.id   
    WHERE p.Cajero=@Cajero AND CAST(c.Fecha AS Date)=CAST(@Fecha AS Date) AND p.Modulo='VTAS' AND p.Estatus IN ('CONCLUIDO','TRASPASADO')  
    GROUP BY formaPago               
      
    INSERT INTO #POSCorteCaja  
    SELECT 'Num' = 8,   
           'Concepto' = 'T O T A L',  
           'Cantidad' = CASE WHEN ISNULL(SUM(ISNULL(c.Importe,0)) ,0) IS NULL THEN 0 ELSE -(ISNULL(SUM(ISNULL(c.Importe,0)) ,0)) END  
    FROM POSLCobro c   
    INNER JOIN POSL p ON p.ID=c.id   
    WHERE p.Cajero=@Cajero AND CAST(c.Fecha AS Date)=CAST(@Fecha AS Date) AND p.Modulo='VTAS' AND p.Estatus IN ('CONCLUIDO','TRASPASADO')        
      
    INSERT INTO #POSCorteCaja  
    SELECT 'Num' = 10,   
           'Concepto' = '',   
           'Cantidad' = 0  
             
    INSERT INTO #POSCorteCaja  
    SELECT 'Num' = 11,   
           'Concepto' = MovID,   
           'Cantidad' = 0  
    FROM POSL  
    WHERE Mov = 'Corte Caja' AND Cajero = @Cajero AND CAST(FechaEmision AS Date) =CAST(@Fecha AS Date)        
  
    SELECT Num, Concepto, Cantidad   
    FROM #POSCorteCaja   
    ORDER BY Num    
END
GO


/******************* spActualizaPOSJobError *******************/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'spActualizaPOSJobError') AND type in (N'P', N'PC'))
DROP PROCEDURE spActualizaPOSJobError
GO
CREATE PROCEDURE spActualizaPOSJobError
	@Sucursal		int
--//WITH ENCRYPTION
AS
BEGIN
	DECLARE 
	@ID				int, 
	@IDPos			varchar(36), 
	@Estatus		varchar(15)

	DECLARE crSE1 CURSOR LOCAL FOR			
	SELECT ID, IDPos
	FROM POSJobErrores
	WHERE /*Sucursal = @Sucursal
	AND*/ Atendido = 0
	
	OPEN crSE1
	FETCH NEXT FROM crSE1 INTO @ID, @IDPos
	WHILE @@FETCH_STATUS <> -1 
		BEGIN
			IF @@FETCH_STATUS <> -2 
				BEGIN
					SET @Estatus = NULL
					
					SELECT @Estatus = Estatus  
					FROM POSL WITH (NOLOCK) 
					WHERE ID = @IDPos 
		
					IF @Estatus <> 'CONCLUIDO'
						UPDATE POSJobErrores SET Atendido = 1 WHERE ID = @ID 
		
				END
		
			FETCH NEXT FROM crSE1 INTO @ID, @IDPos
		END
	CLOSE crSE1
	DEALLOCATE crSE1

	DELETE FROM POSJobErrores 
	WHERE /*Sucursal = @Sucursal
	AND*/ Atendido = 1

	SELECT '****** ACTUALIZADO ******'
END
GO


/************************ spPOSLDIFacCred *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSLDIFacCred') AND type = 'P') DROP PROCEDURE dbo.spPOSLDIFacCred
GO    
CREATE PROCEDURE spPOSLDIFacCred
	@Servicio				varchar(20),  
    @ID						varchar(36),  
    @NoTarjeta				varchar(36),  
    @Empresa                varchar(5),  
    @Usuario                varchar(10),  
    @Sucursal               int,  
    @NoTarjetaReemplazo		varchar(36) = NULL,  
    @Importe				float = NULL,  
    @EnSilencio				bit = 0,  
    @NoTelefono				varchar(10) = NULL,    
    @Ok						int = NULL				OUTPUT,  
    @OkRef					varchar(255) = NULL		OUTPUT,        
    @Modulo					varchar(5) = 'POS',  
    @Cuenta                 varchar(255) = NULL,  
    @Referencia             varchar(255) = NULL,  
    @RIDCobro               int = NULL,  
    @ADO                    bit = 0,  
    @Mes                    varchar(2) = NULL,  
    @Ano                    varchar(4) = NULL,  
    @FechaD                 datetime = NULL,  
    @FechaA                 datetime = NULL,  
    @ImporteS				float = NULL			OUTPUT        
                
--//WITH ENCRYPTION        
AS 
BEGIN  
	DECLARE 
	@Cadena					nvarchar(2048),  
	@CadenaRespuesta		nvarchar(2048),  
	@MensajeError			nvarchar(2048),  
    @DireccionIP			varchar(15),  
	@Puerto					varchar(10),  
	@TiempoEspera			nvarchar(4),  
	@Cliente				varchar(10),  
	@ImporteOUT				varchar(20),  
	@OkLDI					varchar(255),  
	@OkRefLDI               varchar(500),  
	@Mensaje                varchar(255),  
	@Voucher                varchar(MAX),  
	@Voucher2               varchar(MAX),  
	@Banco					varchar(255),  
	@IDLDI                  int,  
	@MonedaMonedero         varchar(10),  
	@Moneda                 varchar(10),  
	@TipoCambio             float,  
	@MonederoTipoCambio		float  
       
	IF @Modulo = 'POS'     
		IF NOT EXISTS (SELECT * FROM POSL WHERE ID = @ID)     
			SELECT @Ok = 14055  
    
	IF @Modulo = 'NOM'     
		IF NOT EXISTS (SELECT * FROM Nomina WHERE ID = @ID)     
			SELECT @Ok = 14055  
        
	DELETE POSLDIIDTemp WHERE Estacion = @@SPID  
        
	/* TIEMPO ESPERA, ES EL TIEMPO MAXIMO QUE LA DLL LOCAL, ESPERA RESPUESTA DEL SERVIDOR DE LDI, EN CASO DE NO RECIBIRLA EN ESE TIEMPO, RESPONDERÁ CADENA CON ERROR */  
	SELECT @TiempoEspera = '45'  
    
	/* DETERMINA LA DIRECCION A DONDE SE ENVIARA */  
	SELECT 
		@DireccionIP = pls.DireccionIP,  
		@Puerto = pls.Puerto  
	FROM POSLDIServicio pls  
	WHERE pls.Servicio = @Servicio  
     
	IF @Ok IS NULL       
		EXEC spPOSLDIGeneraCadena @Servicio, @ID, @NoTarjeta, @NoTarjetaReemplazo, @Cadena OUTPUT, @Importe, @NoTelefono, @Modulo, 
			@Ok OUTPUT, @OkRef OUTPUT, @Cuenta, @Referencia           
  
	--AQUI SE ENVIA LA TRANSACCION A LDI  
	IF @OK IS NULL  
		EXEC usp_EnviarMensaje @Cadena, @DireccionIP, @Puerto, @TiempoEspera, @CadenaRespuesta OUTPUT, @MensajeError OUTPUT  

	IF NULLIF(@CadenaRespuesta,'') IS NULL  
		SELECT @Ok = 2, @OkRef ='El Proveedor No envio Ninguna Respuesta'  
      
	/* DETERMINA SI FUE EXITOSA O HUBO ERROR */  
	EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '14', @OkLDI OUTPUT  
  
	/* SI @MENSAJEERROR ES DIFERENTE DE NULL, SIGNIFICA QUE HUBO ERROR DE CONEXION */  
	IF @MensajeError IS NOT NULL  
		SELECT @Ok = 2, @OkRef = @MensajeError  
    
	/* DETERMINA EL VOUCHER */  
	EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '163', @Voucher OUTPUT  
	EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '27', @Banco OUTPUT  
    
	IF @Voucher IS NOT NULL OR @Banco IS NOT NULL AND @Modulo = 'POS'  
		BEGIN  
			INSERT POSLRefBancaria (
				ID, Voucher, Banco)  
			VALUES (
				@ID, @Voucher, @Banco)  
      
			SELECT @Voucher2 = REPLACE(@Voucher,'^',':')  
    
			IF NOT EXISTS (SELECT * FROM POSLDIVentaID WHERE ID = @ID)  
				INSERT POSLDIVentaID(
					ID, Referencia2)  
				SELECT              
					@ID, @Voucher2  
    
			IF EXISTS (SELECT * FROM POSLDIVentaID WHERE ID = @ID)  
				UPDATE POSLDIVentaID SET Referencia2= @Voucher2 WHERE ID = @ID  
		END  
  
	/* SI @OKLDI ES DIFERENTE DE 0, ES QUE HUBO ERROR DE LDI O DE LOS PROVEEDORES DE SERVICIO*/    
	IF @Ok IS NULL AND @OkLDI <> 0  
		BEGIN  
			EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '16', @OkRefLDI OUTPUT  
     
			SELECT @Ok = 2, @OkRef = 'El Proveedor de transacción mandó el mensaje ' + @OkRefLDI  
		END  
    
	IF @Ok IS NULL  
		BEGIN               
			IF @Servicio = 'MON CONSULTA'  
				BEGIN  
					DELETE POSLDISaldoMonederoTemp WHERE Estacion = @@SPID  
        
					SELECT @MonedaMonedero = Moneda, @Cliente = Cliente 
					FROM POSValeSerie 
					WHERE Serie = @NoTarjeta  
      
					SELECT @Moneda = Moneda, @TipoCambio = TipoCambio 
					FROM POSLTipoCambioRef 
					WHERE EsPrincipal = 1 AND Sucursal = @Sucursal  
      
					SELECT @MonederoTipoCambio = TipoCambio 
					FROM POSLTipoCambioRef 
					WHERE Sucursal = @Sucursal AND Moneda = @MonedaMonedero  
        
					EXEC spPOSLDIAnalizaCadena @CadenaRespuesta, '45', @Importe OUTPUT  
					SELECT @ImporteS = ISNULL(@Importe,0)       
				END
		END  
END  
GO


/************************ spPOSChecarSaldoZaragoza *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSChecarSaldoZaragoza') AND type = 'P') DROP PROCEDURE dbo.spPOSChecarSaldoZaragoza
GO 

/************************ spPOSChecarSaldoMonFC *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSChecarSaldoMonFC') AND type = 'P') DROP PROCEDURE dbo.spPOSChecarSaldoMonFC
GO
CREATE PROCEDURE spPOSChecarSaldoMonFC
	@ID				varchar(36),
	@NoTarjeta		varchar(36),
	@Empresa        varchar(5),
	@Usuario        varchar(10),
	@Sucursal       int,
	@Importe		float
--//WITH ENCRYPTION
AS
BEGIN
	DECLARE 
	@Ok				int, 
	@OkRef			varchar(255), 
	@ImporteS		float

	SELECT @Ok = NULL, @OkRef = NULL

	EXEC spPOSLDIFacCred 'MON CONSULTA', @ID, @NoTarjeta, @Empresa, @Usuario, @Sucursal, @Ok = @Ok OUTPUT, @OkRef  = @OkRef OUTPUT, @ImporteS = @ImporteS OUTPUT

	IF @Ok IS NULL
		BEGIN
			IF ISNULL(@ImporteS,0) < ISNULL(@Importe,0) 
				SELECT @OkRef = 'El Saldo del Monedero es Insificiente... Verifique su Saldo'		
		END

	SELECT @OkRef 

	RETURN
END
GO


/******************* spPOSChecarAperturaCorte *******************/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'spPOSChecarAperturaCorte') AND type in (N'P', N'PC'))
DROP PROCEDURE spPOSChecarAperturaCorte
GO
CREATE PROCEDURE spPOSChecarAperturaCorte  
	@ID				varchar(36),  
    @Empresa		varchar(5),  
    @Sucursal		int,
	@Mensaje		varchar(255) = NULL  
--//WITH ENCRYPTION
AS  
BEGIN  
	DECLARE 
	@Ok			int, 
	@OkRef		varchar(255)  
 
	SELECT @Ok = NULL, @OkRef = NULL  
 
	IF @Mensaje NOT LIKE ('%MOVIMIENTO CONCLUIDO CON EXITO%')
		SELECT @OkRef = @Mensaje

	SELECT @OkRef      
END
GO


/******************* spPOSRevisaACZaragoza *******************/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'spPOSRevisaACZaragoza') AND type in (N'P', N'PC'))
DROP PROCEDURE spPOSRevisaACZaragoza
GO
CREATE PROCEDURE spPOSRevisaACZaragoza  
	@ID varchar(36)  
--//WITH ENCRYPTION
AS  
BEGIN  
	DECLARE 
	@Ok					int, 
	@OkReF				varchar(255), 
	@MovClave			varchar(20), 
	@Usuario			varchar(10), 
	@DefFormaPago		varchar(50)
  
	SELECT @Ok = 0, @OkReF = NULL  
  
	SELECT @MovClave = m.Clave, @Usuario = p.Usuario    
	FROM POSL p  
	JOIN MovTipo m ON p.Mov = m.Mov AND m.Modulo = 'POS'  
	WHERE p.ID = @ID
 
	SELECT @DefFormaPago = ISNULL(NULLIF(DefFormaPago,''),'EFECTIVO')  
	FROM Usuario 
	WHERE Usuario = @Usuario  
    
	IF EXISTS (SELECT * FROM POSLCobro WHERE ID = @ID AND FormaPago <> @DefFormaPago) AND @MovClave IN ('POS.AC', 'POS.ACM')  
		SELECT @Ok = 1  
  
	IF @Ok = 1  
		SELECT @OkReF = 'No se puede realizar Aperturas con una Forma Pago diferente a Efectivo'  
  
	SELECT @OkReF   
END  
GO


/************************** spHHTDC *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('spHHTDC') AND type = 'P') DROP PROCEDURE dbo.spHHTDC
GO   
CREATE PROCEDURE spHHTDC    
	@TieneDatos		int,    
	@Empresa		char(5),    
	@Sucursal		int,    
	@Usuario		char(10),    
	@Modulo			char(5),    
	@ModuloID		int,  
	@Importe		money,
	@Posicion		varchar(255)        
--//WITH ENCRYPTION
AS 
BEGIN    
	DECLARE        
	@IDLargo        int,    
	@ModuloID1		varchar(30),       
	@Suc            varchar(10),
	@Ruta			varchar(255)
    
	SET NOCOUNT ON    
  
	SELECT @ModuloID1 = CONVERT(int, CONVERT(varchar(30), @ModuloID))    
    
	SELECT @Suc = ltrim(rtrim(CONVERT(int, CONVERT(varchar(10), @Sucursal))))   
	
	IF @Posicion = 'BancoA01' 
		BEGIN 
			SET @Ruta = (SELECT DISTINCT TDCA01 FROM POSCobroFormasPago WHERE Sucursal = @Suc) 
		END
	
	IF @Posicion = 'BancoA02' 
		BEGIN 
			SET @Ruta = (SELECT DISTINCT TDCA02 FROM POSCobroFormasPago WHERE Sucursal = @Suc) 
		END

	IF @Posicion = 'BancoA03' 
		BEGIN 
			SET @Ruta = (SELECT DISTINCT TDCA03 FROM POSCobroFormasPago WHERE Sucursal = @Suc) 
		END

	IF @Posicion = 'BancoA04' 
		BEGIN 
			SET @Ruta = (SELECT DISTINCT TDCA04 FROM POSCobroFormasPago WHERE Sucursal = @Suc) 
		END
	
	IF @Posicion = 'BancoA05' 
		BEGIN 
			SET @Ruta = (SELECT DISTINCT TDCA05 FROM POSCobroFormasPago WHERE Sucursal = @Suc) 
		END
	
	IF @Posicion = 'BancoA06' 
		BEGIN 
			SET @Ruta = (SELECT DISTINCT TDCA06 FROM POSCobroFormasPago WHERE Sucursal = @Suc) 
		END
	
	IF @Posicion = 'BancoA07' 
		BEGIN 
			SET @Ruta = (SELECT DISTINCT TDCA07 FROM POSCobroFormasPago WHERE Sucursal = @Suc) 
		END

	IF @Posicion = 'BancoA08' 
		BEGIN 
			SET @Ruta = (SELECT DISTINCT TDCA08 FROM POSCobroFormasPago WHERE Sucursal = @Suc) 
		END
		           
	SELECT 'TieneDatos'='SI',     
		   'RutaEjecutableA'= @Ruta, --'C:\DemoTDC',     
		   'NombreServidorA'=SERVERPROPERTY('ServerName'),    
		   'BaseDeDatosA'=DB_NAME(),     
		   'UsuarioSQLA'='sa',     
		   'ContrasenaA'='',     
		   'EmpresaA'=rtrim(@Empresa),     
		   'SucursalA'=rtrim(@Sucursal),     
		   'EstacionA'= 0,    
		   'UsuarioA'=ltrim(rtrim(@Usuario)),     
		   'ModuloA'=@Modulo,     
		   'ModuloIDA'=@ModuloID,     
		   'OrdinalPagoA'=1,     
		   'ImporteTotalA'=CASE WHEN @Modulo='POS' THEN @Importe ELSE 0 END,     
		   'TipoTransaccionA'='Venta',     
		   'OrigenTrnIDA'=0,     
		   'VersionAppA'='1.0.12',     
		   'AmbienteA'='Pruebas'        
    
	RETURN    
END    
GO


/************************ fixPOSInsertaCodigosFaltantes *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.fixPOSInsertaCodigosFaltantes') AND type = 'P') DROP PROCEDURE dbo.fixPOSInsertaCodigosFaltantes
GO 
CREATE PROCEDURE fixPOSInsertaCodigosFaltantes
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE  
	@Articulo		varchar(20), 
	@Unidad			varchar(50), 
	@Bandera		bit 

	DECLARE crSE1 CURSOR LOCAL FOR			
	SELECT RTRIM(LTRIM(Articulo)), Unidad
	FROM Art with (nolock)
	WHERE Estatus <> 'BAJA'
	AND Tipo IN ('Normal', 'Servicio', 'Juego')
	AND NULLIF(CategoriaActivoFijo,'') IS NULL 
	AND Articulo not in (SELECT CONVERT(VARCHAR,Orden)  FROM MovTipo WHERE Modulo = 'POS' )
	
	OPEN crSE1
	FETCH NEXT FROM crSE1 INTO @Articulo, @Unidad
	WHILE @@FETCH_STATUS <> -1 
		BEGIN
			IF @@FETCH_STATUS <> -2 
				BEGIN		
					SELECT @Bandera = 0
					
					IF EXISTS (SELECT 1 FROM CB with (nolock) WHERE RTRIM(LTRIM(Codigo)) = @Articulo AND RTRIM(LTRIM(Cuenta)) <> @Articulo)
						SELECT @Bandera = 1

					IF @Bandera = 0
						BEGIN
							IF EXISTS (SELECT 1 FROM CB with (nolock) WHERE TipoCuenta = 'Articulos' AND RTRIM(LTRIM(Cuenta)) = @Articulo 
									   AND RTRIM(LTRIM(Codigo)) = @Articulo)
								UPDATE CB SET Cantidad = 1, Unidad = @Unidad WHERE TipoCuenta = 'Articulos' AND Cuenta = @Articulo AND Codigo = @Articulo
							ELSE
								INSERT INTO CB (
									Codigo, TipoCuenta, Cuenta, Cantidad, Unidad)
								VALUES (
									@Articulo, 'Articulos', @Articulo, 1, @Unidad)
						END
				END
			
			FETCH NEXT FROM crSE1 INTO @Articulo, @Unidad
		END
	CLOSE crSE1
	DEALLOCATE crSE1	
END
GO


/************************ spPOSPuedePesar *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSPuedePesar') AND type = 'P') DROP PROCEDURE dbo.spPOSPuedePesar
GO             
CREATE PROCEDURE spPOSPuedePesar
	@ID			varchar(36)
--//WITH ENCRYPTION	       
AS 
BEGIN
	DECLARE 
	@Respuesta	bit
	
	SET @Respuesta = 0

	IF EXISTS (SELECT * FROM POSLArtSeleccionado WHERE ID = @ID)
		SELECT @Respuesta = 1
	ELSE
		SELECT @Respuesta = 0

	SELECT @Respuesta
END
GO


/**************** spPOSFacturaCreditoCobro ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSFacturaCreditoCobro') AND type = 'P') DROP PROCEDURE dbo.spPOSFacturaCreditoCobro
GO
CREATE PROCEDURE spPOSFacturaCreditoCobro
	@ID				varchar(36)
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE 
	@Empresa								varchar(5),
	@Condicion								varchar(50),
	@CfgFacturaCobroIntegradoParcial		bit,
	@FacturaCobroIntegradoParcial			bit,
	@Resultado								bit

	SELECT @CfgFacturaCobroIntegradoParcial = 0, @FacturaCobroIntegradoParcial = 0, @Resultado = 0

	SELECT @Empresa=Empresa, @Condicion=Condicion 
	FROM POSL 
	WHERE ID = @ID
	
	SELECT @CfgFacturaCobroIntegradoParcial = FacturaCobroIntegradoParcial 
	FROM EmpresaCfg2 
	WHERE Empresa = @Empresa
	
	SELECT @FacturaCobroIntegradoParcial = FacturaCobroIntegradoParcial 
	FROM Condicion 
	WHERE Condicion = @Condicion

	IF @CfgFacturaCobroIntegradoParcial = 1 AND @FacturaCobroIntegradoParcial = 1
		SELECT @Resultado = 1

	SELECT @Resultado
END
GO


/********************************** spPOSMovEliminarNoc ************************************/
IF EXISTS (SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSMovEliminarNoc') AND type = 'P') DROP PROCEDURE dbo.spPOSMovEliminarNoc
GO             
CREATE PROCEDURE spPOSMovEliminarNoc
	@Usuario		varchar(10) = NULL
--//WITH ENCRYPTION
AS
BEGIN
	DECLARE 
	@ID varchar (36)

	IF @Usuario IS NULL
		BEGIN
			DECLARE crSE1 CURSOR LOCAL FOR			
			SELECT ID 
			FROM POSL 
			WHERE Estatus IN ('PENDIENTE','SINAFECTAR', 'PORCOBRAR')
			
			OPEN crSE1
			FETCH NEXT FROM crSE1 INTO @ID
			WHILE @@FETCH_STATUS <> -1 
				BEGIN
					IF @@FETCH_STATUS <> -2 
						BEGIN
							DELETE FROM POSL WHERE ID = @ID
							DELETE FROM POSLVenta WHERE ID = @ID
							DELETE FROM POSLCobro WHERE ID = @ID
							DELETE FROM POSLSerieLote WHERE ID = @ID						  
						END
			
					FETCH NEXT FROM crSE1 INTO @ID
				END
			CLOSE crSE1
			DEALLOCATE crSE1
		END
	ELSE
		BEGIN
			DECLARE crSE1 CURSOR LOCAL FOR			
			SELECT ID 
			FROM POSL 
			WHERE Estatus IN ('PENDIENTE','SINAFECTAR', 'PORCOBRAR')
		    AND Usuario = @Usuario
		   
			OPEN crSE1
			FETCH NEXT FROM crSE1 INTO @ID
			WHILE @@FETCH_STATUS <> -1 
				BEGIN
					IF @@FETCH_STATUS <> -2 
						BEGIN
							DELETE FROM POSL WHERE ID = @ID
							DELETE FROM POSLVenta WHERE ID = @ID
							DELETE FROM POSLCobro WHERE ID = @ID
							DELETE FROM POSLSerieLote WHERE ID = @ID						  
						END
					
					FETCH NEXT FROM crSE1 INTO @ID
				END
			CLOSE crSE1
			DEALLOCATE crSE1
		END
END
GO

/********************************** spPOSEstadoCajaSuc ************************************/
IF EXISTS (SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSEstadoCajaSuc') AND type = 'P') DROP PROCEDURE dbo.spPOSEstadoCajaSuc
GO
CREATE PROCEDURE spPOSEstadoCajaSuc
  @ID   varchar(36),  
  @Usuario varchar(10)  
--//WITH ENCRYPTION     
AS BEGIN  
  DECLARE	@EstatusCaja		varchar(50),  
			@Caja				varchar(10),  
			@Host				varchar(20),  
			@Cajero				varchar(10),  
			@Abierto			bit,  
			@EsSucursal			bit,  
			@POSEsSupervisor	bit,  
			@DefSucursal		int,  
			@DefAlmacen			varchar(10),  
			@DefCtaDinero		varchar(10),  
			@DefCtaDineroTrans	varchar(10),  
			@DefAlmacenSuc		int,  
			@DefCtaDineroSuc	int,  
			@DefCtaDineroTransSuc int,  
			@DefListaPreciosEsp varchar (20),  
			@SucListaPreciosEsp varchar (20),  
			@Bandera			int,  
			@EsConcentradora	bit,
			@DefCajero			varchar(10),
			@Sucursal			int
     
 SELECT @Bandera = 0  , @EstatusCaja = NULL,  @Sucursal = ISNULL(Sucursal,0) FROM POSiSync
  
 SELECT @POSEsSupervisor =		ISNULL(u.POSEsSupervisor,0),  
		@DefSucursal =			u.Sucursal,  
		@DefCtaDinero =			u.DefCtaDinero,  
		@DefCtaDineroTrans =	u.DefCtaDineroTrans,  
		@DefAlmacen =			u.DefAlmacen,  
		@DefListaPreciosEsp =	RTRIM(u.DefListaPreciosEsp),
		@DefCajero =			RTRIM(u.DefCajero)
   FROM Usuario u  
  WHERE u.Usuario = @Usuario  
   

 SELECT @SucListaPreciosEsp = RTRIM(ListaPreciosEsp) FROM Sucursal WHERE Sucursal = @Sucursal    
 SELECT @DefCtaDineroSuc = Sucursal					 FROM CtaDinero WHERE CtaDinero = @DefCtaDinero  
 SELECT @DefCtaDineroTransSuc = Sucursal			 FROM CtaDinero WHERE CtaDinero = @DefCtaDineroTrans  
 SELECT @DefAlmacenSuc = Sucursal					 FROM Alm  WHERE Almacen = @DefAlmacen   
  
 IF @Bandera = 0 AND @Sucursal <> @DefSucursal     SELECT @Bandera = 1  
 IF @Bandera = 0 AND @Sucursal <> @DefCtaDineroSuc    SELECT @Bandera = 2  
-- IF @Bandera = 0 AND @Sucursal <> @DefCtaDineroTransSuc   SELECT @Bandera = 1  
 IF @Bandera = 0 AND @Sucursal <> @DefAlmacenSuc    SELECT @Bandera = 3  
 IF @Bandera = 0 AND @SucListaPreciosEsp <> @DefListaPreciosEsp SELECT @Bandera = 4  

         
  IF @Bandera = 1 SELECT @EstatusCaja = 'DefSucursal'
  IF @Bandera = 2 SELECT @EstatusCaja = 'DefCtaDineroSuc' 
  IF @Bandera = 3 SELECT @EstatusCaja = 'DefAlmacenSuc'         
  IF @Bandera = 4 SELECT @EstatusCaja = 'DefListaPreciosEsp'
  IF @Bandera = 0 SELECT @EstatusCaja = 'OK'

  SELECT @EstatusCaja  


END  
GO

/********************************** spPOSUsuarioValidaCfg ************************************/
IF EXISTS (SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSUsuarioValidaCfg') AND type = 'P') DROP PROCEDURE dbo.spPOSUsuarioValidaCfg
GO
CREATE PROCEDURE spPOSUsuarioValidaCfg
				 @Usuario	varchar(10)
--//WITH ENCRYPTION
AS 
BEGIN

DECLARE @UsuarioBis		varchar(10),
		@DefCajero		varchar(10),
		@DefCtaDinero	varchar(10),
		@QueEs			varchar(255)


	SELECT @QueEs = NULL


	SELECT @DefCajero = NULLIF(DefCajero,''), @DefCtaDinero = NULLIF(DefCtaDinero,'') FROM Usuario WHERE Usuario = @Usuario


	IF @DefCajero IS NOT NULL
		IF EXISTS (SELECT * FROM Usuario WITH (NOLOCK) WHERE DefCajero = @DefCajero AND Usuario <> @Usuario AND Estatus = 'ALTA')
			SELECT TOP 1 @QueEs = 'Cajero', @UsuarioBis = Usuario FROM Usuario WITH (NOLOCK) WHERE DefCajero = @DefCajero AND Usuario <> @Usuario

	IF @DefCtaDinero IS NOT NULL AND @QueEs IS NULL
		IF EXISTS (SELECT * FROM Usuario WITH (NOLOCK) WHERE DefCtaDinero = @DefCtaDinero AND Usuario <> @Usuario AND Estatus = 'ALTA')
			SELECT TOP 1 @QueEs = 'CtaDinero', @UsuarioBis = Usuario FROM Usuario WITH (NOLOCK) WHERE DefCtaDinero = @DefCtaDinero AND Usuario <> @Usuario


	IF @QueEs = 'Cajero'
		SET @QueEs = 'ESTA CONFIGURACIÓN NO ES APROPIADA PARA OPERAR EL POS, EL USUARIO '+ @UsuarioBis + 'TIENE EL MISMO CAJERO, SE SUGIERE QUE SEA MODIFICADO'

	IF @QueEs = 'CtaDinero'
		SET @QueEs = 'ESTA CONFIGURACIÓN NO ES APROPIADA PARA OPERAR EL POS, EL USUARIO '+ @UsuarioBis + 'TIENE LA MISMA CTADINERO, SE SUGIERE QUE SEA MODIFICADA'

	SELECT @QueEs

END
GO

/********************************** spPOSDatosVueloVerificar ************************************/
IF EXISTS (SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSDatosVueloVerificar') AND type = 'P') DROP PROCEDURE dbo.spPOSDatosVueloVerificar
GO
CREATE PROCEDURE spPOSDatosVueloVerificar
				 @ID		varchar(36),
				 @Requiere	bit,
				 @Expresion	varchar(255) = NULL OUTPUT
--//WITH ENCRYPTION
AS 
BEGIN
	DECLARE @NombreDF			varchar(30), 
			@ApellidosDF		varchar(60),
			@PasaporteDF		varchar(30), 
			@NacionalidadDF		varchar(30), 
			@NoVueloDF			varchar(20), 
			@AerolineaDF		varchar(50), 
			@OrigenDF			varchar(100), 
			@DestinoDF			varchar(100),
			@Respuesta			bit

	SET @Respuesta = 0
	
	SELECT	@NombreDF			= NULLIF(NombreDF,''),
			@ApellidosDF		= NULLIF(ApellidosDF,''),
			@PasaporteDF		= NULLIF(PasaporteDF,''),
			@NacionalidadDF		= NULLIF(NacionalidadDF,''),
			@NoVueloDF			= NULLIF(NoVueloDF,''),
			@AerolineaDF		= NULLIF(AerolineaDF,''),
			@OrigenDF			= NULLIF(OrigenDF,''),
			@DestinoDF			= NULLIF(DestinoDF,'')
	  FROM  POSL 
	 WHERE  ID = @ID

	IF @NombreDF IS NULL OR @ApellidosDF IS NULL OR @PasaporteDF IS NULL OR 
	   @NacionalidadDF IS NULL OR @NoVueloDF IS NULL OR @AerolineaDF  IS NULL OR
	   @OrigenDF IS NULL OR @DestinoDF IS NULL
		SET	@Respuesta = 1

	IF @Requiere = 0
		SELECT @Respuesta

	IF @Requiere = 1 
		IF @Respuesta = 1
			SELECT @Expresion = 'FormaModal('+CHAR(39)+'DatosVueloDF'+CHAR(39)+')'	
		ELSE
			SELECT @Expresion = NULL

END
GO


/************** spCopiarPOSperfil *************/
if exists (select * from sysobjects where id = object_id('dbo.spCopiarPOSperfil') and sysstat & 0xf = 4) drop procedure dbo.spCopiarPOSperfil
GO
CREATE PROCEDURE spCopiarPOSperfil
                   @UsuarioD    char(10),
                   @UsuarioA	char(10)
--//WITH ENCRYPTION
AS BEGIN


IF NULLIF(@UsuarioD,'') IS NOT NULL 
BEGIN
 UPDATE a
    SET POSEsSupervisor	= d.POSEsSupervisor
   FROM Usuario a, Usuario d 
  WHERE a.Usuario = @UsuarioA AND d.Usuario = @UsuarioD


  DELETE POSUsuarioAccion WHERE Usuario = @UsuarioA
  INSERT POSUsuarioAccion (Usuario,		Accion)
  SELECT				   @UsuarioA,	Accion
    FROM POSUsuarioAccion
   WHERE Usuario = @UsuarioD

  DELETE POSUsuarioMov WHERE Usuario = @UsuarioA
  INSERT POSUsuarioMov (Usuario,	Mov, PuedeAutorizar)
  SELECT				@UsuarioA,	Mov, 1
    FROM POSUsuarioMov
   WHERE Usuario = @UsuarioD
   
END
  RETURN
END
GO



/************************ spPOSVerificaCBFormaPago *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spPOSVerificaCBFormaPago') AND type = 'P') DROP PROCEDURE dbo.spPOSVerificaCBFormaPago
GO             
CREATE PROCEDURE spPOSVerificaCBFormaPago
					@Empresa		varchar(5)

--//WITH ENCRYPTION

AS
BEGIN

DECLARE	@FormaPago			varchar (50),
		@FormaPagoRef		varchar (50),
		@CfgMultiMoneda		bit,
		@Ok					int,
		@OkRef				varchar(255),
		@ContMoneda			varchar(10),
		@MovIngresos		varchar(10),
		@MovEgresos			varchar(10),
		@Moneda				varchar(10)

	SELECT @CfgMultiMoneda = MultiMoneda FROM POSCfg WHERE Empresa = @Empresa

	SELECT @ContMoneda = ContMoneda
	  FROM EmpresaCfg 
	 WHERE Empresa = @Empresa

	DECLARE crSE1 CURSOR LOCAL FOR			
	 SELECT cb.FormaPago,  fp.MovIngresos, fp.MovEgresos, nullif(fp.Moneda,'')
	   FROM CB cb
	   JOIN FormaPago fp ON cb.FormaPago = fp.FormaPago
	  WHERE cb.TipoCuenta = 'Forma Pago'
	   OPEN crSE1
	FETCH NEXT FROM crSE1 INTO @FormaPago, @MovIngresos, @MovEgresos, @Moneda
	WHILE @@FETCH_STATUS <> -1 
	BEGIN
		IF @@FETCH_STATUS <> -2 AND @Ok IS NULL
		BEGIN
			SELECT @FormaPagoRef = @FormaPago
			IF @Moneda IS NULL
				SELECT @Ok = 1, @OkRef = 'La Forma de Pago no cuenta con Moneda, Forma Pago '

			IF @MovIngresos <> 'Ingreso' AND @Ok IS NULL
				SELECT @Ok = 2, @OkRef = 'El Movimiento de Ingresos debe ser Ingreso, Forma Pago '

			IF @MovEgresos <> 'Egreso' AND @Ok IS NULL
				SELECT @Ok = 3, @OkRef = 'El Movimiento de Egresos debe ser Egreso, Forma Pago '


			IF @CfgMultiMoneda = 0 AND @Ok IS NULL
			BEGIN
				IF @Moneda <> @ContMoneda
					SELECT @Ok = 4, @OkRef = 'No está configurada la opción de Multimoneda, Forma Pago '
			END
			
		
		END
	FETCH NEXT FROM crSE1 INTO @FormaPago, @MovIngresos, @MovEgresos, @Moneda
	END
	CLOSE crSE1
	DEALLOCATE crSE1

	IF NULLIF(@OkRef,'') IS NOT NULL
		SELECT @OkRef = @OkRef + @FormaPagoRef

	SELECT @OkRef

END
GO

/**************** spPOSVerificarAnticiposTipoServicio ****************/
IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.spPOSVerificarAnticiposTipoServicio') and type = 'P') DROP PROCEDURE dbo.spPOSVerificarAnticiposTipoServicio
GO             
CREATE PROCEDURE spPOSVerificarAnticiposTipoServicio
					@Estacion		int,
					@ID				varchar(36),
					@Empresa		varchar(5)


AS BEGIN

DECLARE @SubTotal			float,
		@ImporteMov			float,
		@ImpuestosMov		float,
		@TotalImpuesto1		float,
		@TotalDescuento		float,
		@Total				float,
		@ArticuloRedondeo	varchar(20),
		@ImportePagado		float,
		@TotalAnticipos		float,
		@Respuesta			bit

	SET	@Respuesta = 1

	SELECT @ArticuloRedondeo = c.Cuenta
	  FROM CB c
	  JOIN POSCfg p ON c.Codigo = p.RedondeoVentaCodigo AND c.TipoCuenta = 'Articulos'
	 WHERE p.Empresa = @Empresa
	 
	SELECT @ImportePagado = SUM(ISNULL(Importe,0)) 
	  FROM POSLCobro 
	 WHERE ID = @ID

	SELECT @TotalAnticipos = SUM(ISNULL(AnticipoAplicar,0)) 
	  FROM POSCxcAnticipoTemp 
	 WHERE Estacion = @Estacion

	SELECT @SubTotal = SUM(ISNULL(((Cantidad - ISNULL(CantidadObsequio,0)) * Precio) ,0))
	  FROM POSLVenta
	 WHERE ID = @ID  
	   AND Articulo <> ISNULL(@ArticuloRedondeo,'')	 
              
	SELECT @ImporteMov = SUM((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0)/100))) - 
						 ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0)/100))) * (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),
		   @ImpuestosMov = (SUM(dbo.fnPOSImporteMov(((plv.Cantidad  - ISNULL(plv.CantidadObsequio,0.0)) * ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) - ((plv.Precio - (plv.precio * (ISNULL(plv.DescuentoLinea,0.0)/100.0))) * 
		   (CASE WHEN ISNULL(plv.AplicaDescGlobal, 1) = 1 THEN ISNULL(p.DescuentoGlobal,0.0) ELSE 0 END)/100))),plv.Impuesto1,plv.Impuesto2,plv.Impuesto3,plv.Cantidad))-@ImporteMov)
	  FROM POSLVenta plv 
	 INNER JOIN POSL p ON p.ID = plv.ID
	 WHERE plv.ID = @ID
				
	SET @TotalImpuesto1 = ISNULL(@ImpuestosMov,0)
	SET @TotalDescuento = ISNULL(@SubTotal,0) - ISNULL(@ImporteMov,0)
	SET @Total = ISNULL(@ImporteMov,0) + ISNULL(@ImpuestosMov,0)

	 

	SET @Total = @Total - ISNULL(@ImportePagado,0)
	SET @Total = @Total - ISNULL(@TotalAnticipos,0)

	IF @Total < 0.00
		SET @Respuesta = 0
	

	SELECT @Respuesta


END
GO

/*** OK **/

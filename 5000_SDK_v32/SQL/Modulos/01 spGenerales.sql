SET ANSI_DEFAULTS OFF
SET ANSI_NULLS OFF
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET LOCK_TIMEOUT -1
SET QUOTED_IDENTIFIER OFF
GO

--IF exists (SELECT * FROM dbo.sysobjects WHERE id = object_id('[dbo].[fnPrecioSucursal]'))
--  DROP FUNCTION [dbo].[fnPrecioSucursal]
--GO

--REQ 13389
/**************** spSincronizarCRM ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSincronizarCRM') and type = 'P') drop procedure dbo.spSincronizarCRM
GO             
CREATE PROCEDURE spSincronizarCRM
			@Tabla			varchar(20) = NULL,
			@valor			varchar(2)

--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Query						varchar(max),
    @ValorSincronizar			varchar(2),
    @GUI						uniqueidentifier,
    @prospectoID				varchar(20),
    @cteID						varchar(20),
    @ID							varchar(20)
  
   IF RTRIM(LTRIM(UPPER(@Valor))) = 'S'
     SET @ValorSincronizar = '1'
   ELSE
   IF RTRIM(LTRIM(UPPER(@Valor))) = 'N'
     SET @ValorSincronizar = '0'
   
   IF RTRIM(LTRIM(UPPER(@Tabla))) = 'PROSPECTO'
     SET @ID = 'prospecto'
   ELSE
   IF RTRIM(LTRIM(UPPER(@Tabla))) = 'CTE'
     SET @ID = 'cliente'
   
   SET @Query= '
DECLARE
  @IDcur	varchar(20),
  @GUI		uniqueidentifier,
  @Sincro	bit,
  @Tmp		varchar(30),
  @vquery	varchar(max)  
  
SET @vquery=''''  
DECLARE crSincronizarCRM CURSOR FOR  
 SELECT SincronizarCRM, CRMID, ' +  @ID  + ' FROM  ' + @Tabla + ' WHERE Estatus=''ALTA'' AND SincronizarCRM <> ' + @ValorSincronizar +  
 ' OPEN crSincronizarCRM
  FETCH NEXT FROM crSincronizarCRM INTO @Sincro, @GUI, @IDcur
  WHILE @@FETCH_STATUS = 0
  BEGIN
    SET @Tmp = ''CRMID = CRMID''
    IF RTRIM(LTRIM(UPPER(''' + @valor + '''))) = ''S''
    BEGIN
      IF @GUI IS NULL
        UPDATE ' + @Tabla + ' SET SincronizarCRM = ' + @ValorSincronizar  + ', CRMID = NEWID() WHERE ' + @ID + ' = @IDcur' +
    ' ELSE
        UPDATE ' + @Tabla + ' SET SincronizarCRM = ' + @ValorSincronizar  + ' WHERE ' + @ID + ' = @IDcur' +  
  ' END
    ELSE
      UPDATE ' + @Tabla + ' SET SincronizarCRM = ' + @ValorSincronizar  + ' WHERE ' + @ID + ' = @IDcur' +  
     
' FETCH NEXT FROM crSincronizarCRM INTO @Sincro,@GUI,@IDcur  
END  
CLOSE crSincronizarCRM  
DEALLOCATE crSincronizarCRM'  
  
  --PRINT @Query
  EXEC (@Query)  
  RETURN
END
GO

-- REQ12336
/**************** fnDineroEsPagoEmida ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnDineroEsPagoEmida') DROP FUNCTION fnDineroEsPagoEmida
GO
CREATE FUNCTION fnDineroEsPagoEmida(
			@ModuloID		int)
RETURNS int
AS
BEGIN
  DECLARE @Valor	int

  SELECT @Valor = COUNT(c.ID)
    FROM DineroD Dd
    JOIN Dinero D ON Dd.Aplica = D.Mov AND Dd.AplicaID = D.MovID
    JOIN MovImpuesto m ON m.Modulo = 'DIN' AND m.ModuloID = D.ID AND m.OrigenModulo = 'CXP'
    JOIN Cxp c ON m.OrigenModuloID = c.ID
    JOIN MovTipo mt ON c.Mov = mt.Mov AND mt.Modulo = 'CXP' AND ISNULL(mt.SubClave, '') = 'CXP.AEMIDA'
   WHERE Dd.ID = @ModuloID

  RETURN @Valor 
END
GO

/**************** fnSerieExistenciaTransito ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnSerieExistenciaTransito') DROP FUNCTION fnSerieExistenciaTransito
GO
CREATE FUNCTION fnSerieExistenciaTransito(
				@SerieLote		varchar(50),	 
				@Articulo		varchar(20),
				@SubCuenta		varchar(50), 
				@Empresa		varchar(5)
				)
RETURNS bit
AS
BEGIN
  DECLARE @Valor	bit
  
  IF EXISTS(SELECT i.ID
              FROM SerieLoteMov sm
              JOIN Inv i ON sm.Empresa = i.Empresa AND sm.Modulo = 'INV' AND sm.ID = i.ID
              JOIN InvD id ON i.ID = id.ID AND sm.Articulo = id.Articulo AND ISNULL(id.SubCuenta, '') = ISNULL(sm.SubCuenta, '') AND id.RenglonID = sm.RenglonID
              JOIN MovTipo mt ON i.Mov = mt.Mov
              JOIN Art ON id.Articulo = Art.Articulo
             WHERE sm.Articulo = @Articulo
               AND ISNULL(sm.SubCuenta, '') = ISNULL(@SubCuenta, '')
               AND i.Empresa = @Empresa
               AND sm.SerieLote = @SerieLote
               AND mt.Clave IN('INV.TI', 'INV.TIF', 'INV.TIS')
               AND i.Estatus IN('PENDIENTE', 'SINCRO')
               AND Art.Tipo IN ('SERIE', 'VIN'))
    SELECT @Valor = 1
  ELSE
    SELECT @Valor = 0
  
  RETURN @Valor
END
GO

/**************** fnIdiomaTraducir ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnIdiomaTraducir') DROP FUNCTION fnIdiomaTraducir --MEJORA1244 --AUTORIZACIONREMOTA
GO
CREATE FUNCTION fnIdiomaTraducir
	(
	@Usuario				varchar(10), 
	@Texto					varchar(255)
	)
RETURNS varchar(255)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @TextoTraducido	varchar(255)

  SET @TextoTraducido = NULL
  
  SELECT @TextoTraducido = RTRIM(ie.Nombre) 
    FROM IdiomaEtiqueta ie JOIN Idioma i
      ON i.Idioma = ie.Idioma JOIN Usuario u
      ON u.Idioma = i.Idioma
   WHERE u.Usuario = @Usuario   
     AND RTRIM(ie.Etiqueta) = RTRIM(@Texto)
     
  IF @TextoTraducido IS NULL
    SELECT @TextoTraducido = RTRIM(ie.Etiqueta) 
      FROM IdiomaEtiqueta ie JOIN Idioma i
        ON i.Idioma = ie.Idioma JOIN Usuario u
        ON u.Idioma = i.Idioma
     WHERE u.Usuario = @Usuario   
       AND RTRIM(ie.Nombre) = RTRIM(@Texto)
       
  IF @TextoTraducido IS NULL SET @TextoTraducido = @Texto  
  
  RETURN (@TextoTraducido)
END
GO
--select dbo.fnIdiomaTraducir('JHEFFES','No Autorizado')

/**************** fnPeriodoNombre ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPeriodoNombre') DROP FUNCTION fnPeriodoNombre
GO
CREATE FUNCTION fnPeriodoNombre 
	(
	@Periodo				int,
	@Usuario				varchar(10)
	)
	
RETURNS varchar(50)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Resultado	varchar(50)

  SET @Periodo = ISNULL(@Periodo,0)
  
  IF @Periodo = 1  SET @Resultado = 'Enero'      ELSE
  IF @Periodo = 2  SET @Resultado = 'Febrero'    ELSE  
  IF @Periodo = 3  SET @Resultado = 'Marzo'      ELSE    
  IF @Periodo = 4  SET @Resultado = 'Abril'      ELSE      
  IF @Periodo = 5  SET @Resultado = 'Mayo'       ELSE        
  IF @Periodo = 6  SET @Resultado = 'Junio'      ELSE          
  IF @Periodo = 7  SET @Resultado = 'Julio'      ELSE            
  IF @Periodo = 8  SET @Resultado = 'Agosto'     ELSE              
  IF @Periodo = 9  SET @Resultado = 'Septiembre' ELSE                
  IF @Periodo = 10 SET @Resultado = 'Octubre'    ELSE                    
  IF @Periodo = 11 SET @Resultado = 'Noviembre'  ELSE                  
  IF @Periodo = 12 SET @Resultado = 'Diciembre'  ELSE                    
  SET @Resultado = 'Periodo ' + LTRIM(RTRIM(CONVERT(varchar,@Periodo)))
  
  SET @Resultado = dbo.fnIdiomaTraducir(@Usuario,@Resultado)
  
  RETURN (@Resultado)
END
GO  

--select dbo.fnPeriodoNombre(1,'DEMO')

/**************** fnUsuarioACorreo ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnUsuarioACorreo') DROP FUNCTION fnUsuarioACorreo --AUTORIZACIONREMOTA
GO
CREATE FUNCTION fnUsuarioACorreo 
	(
	@Usuario					varchar(10)
	)
RETURNS varchar(255)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
  @Correo				varchar(255),
  @Personal				varchar(10)
  
  SET @Correo = ''

  SELECT @Correo = ISNULL(eMail,''), @Personal = Personal FROM Usuario WHERE Usuario = @Usuario
  IF NULLIF(@Correo,'') IS NULL SELECT @Correo = ISNULL(eMail,'') FROM Personal WHERE Personal = @Personal
  
  RETURN (@Correo)
END
GO

--SELECT dbo.fnUsuarioACorreo('JHEFFES')

/**************** fnSituacionSiguiente ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnSituacionSiguiente') DROP FUNCTION fnSituacionSiguiente --AUTORIZACIONREMOTA
GO
CREATE FUNCTION fnSituacionSiguiente 
	(
	@Modulo					varchar(5), 
	@Mov					varchar(20),
	@Estatus				varchar(15),
	@Situacion				varchar(50)
	)
RETURNS varchar(50)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Resultado				varchar(50),
    @Orden					int,
    @OrdenSiguiente			int

  SET @Resultado = NULL
  SET @Orden = NULL
  
  SELECT
    @Orden = Orden
    FROM MovSituacion
   WHERE Modulo = @Modulo
     AND Mov = @Mov
     AND Estatus = @Estatus
     AND Situacion = @Situacion
  
  IF @Orden IS NOT NULL
  BEGIN
        SET @OrdenSiguiente = NULL
        SELECT @OrdenSiguiente = MIN(Orden) 
          FROM MovSituacion
         WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @Estatus AND Orden > @Orden

        SELECT @Resultado = MIN(Situacion)
          FROM MovSituacion
         WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @Estatus AND  Orden = @OrdenSiguiente
        
  END
      
  RETURN (@Resultado)
END
GO

-- select dbo.fnSituacionSiguiente('VTAS','Pedido','PENDIENTE','Por Autorizar')

/**************** fnSituacionPermiteAvanzar ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnSituacionPermiteAvanzar') DROP FUNCTION fnSituacionPermiteAvanzar --AUTORIZACIONREMOTA
GO
CREATE FUNCTION fnSituacionPermiteAvanzar 
	(
	@Empresa				varchar(5),
	@Modulo					varchar(5), 
	@Mov					varchar(20),
	@Estatus				varchar(15),
	@Situacion				varchar(50),
	@Usuario				varchar(10)
	)
RETURNS bit
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Resultado				bit,
    @Situaciones			bit,
    @UsuarioConPermiso		bit,
    @ControlUsuarios		bit,
    @ID						int

  SET @Resultado = 0

  SET @Situaciones = ISNULL((SELECT 1 FROM EmpresaCfgModulo WHERE Empresa = @Empresa AND Modulo = @Modulo AND Situaciones = 'Si'),0)     
  IF @Situaciones = 1
  BEGIN
    SET @UsuarioConPermiso = ISNULL((SELECT 1 FROM Usuario WHERE Usuario = @Usuario AND ModificarSituacion = 1),0)
    IF @UsuarioConPermiso = 1
    BEGIN
      SELECT @ControlUsuarios = ISNULL(ControlUsuarios,1), @ID = ID FROM MovSituacion WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @Estatus AND Situacion = @Situacion
      IF @ControlUsuarios = 0
      BEGIN
        SET @Resultado = 1    
      END ELSE
      BEGIN
        SET @Resultado = ISNULL((SELECT 1 FROM MovSituacionUsuario WHERE ID = @ID AND Usuario = @Usuario),0)
      END
      
    END
  END  
  
  RETURN (@Resultado)
END
GO

/**************** fnGenerarCadenaConexionCorreo ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnGenerarCadenaConexionCorreo') DROP FUNCTION fnGenerarCadenaConexionCorreo --AUTORIZACIONREMOTA
GO
CREATE FUNCTION fnGenerarCadenaConexionCorreo
			(
			@Ruta						varchar(255),
			@RecibirCorreoPerfil		varchar(50)
			)
RETURNS varchar(max)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @CadenaConexion				varchar(max),
    @UIDTexto					varchar(50)
      
  SELECT 
    @CadenaConexion = 'ServidorP3=' + LTRIM(RTRIM(ISNULL(Servidor,''))) + 
                     ';UsuarioP3=' + LTRIM(RTRIM(ISNULL(Usuario,''))) + 
                     ';ContraseñaP3=' + LTRIM(RTRIM(ISNULL(Contrasena,''))) +     
                     ';Cuenta="' + LTRIM(RTRIM(ISNULL(NombreCuenta,''))) + '"' +        
                     ';Servidor=' + @@SERVERNAME +           
                     ';BaseDatos=' + DB_NAME() +      
                     ';Empresa=' + '' +               
                     ';MaxCaracteres=65536' +
                     ';PuertoP3=' + CONVERT(varchar, Puerto) +
                     ';UsarSSL=' + CONVERT(varchar, ActivarSSL) +
                     ';Ruta="' +  @Ruta + '"'                             
    FROM CFDFlexPerfilDBMail
   WHERE NombrePerfil = @RecibirCorreoPerfil 

  RETURN (@CadenaConexion)
END
GO

-- SELECT dbo.fnGenerarCadenaConexionCorreo(newid())

/******************************* spLeerArchivo *************************************************/
if exists (select * from sysobjects where id = object_id('dbo.spLeerArchivo') and type = 'P') drop procedure dbo.spLeerArchivo --AUTORIZACIONREMOTA
GO             
CREATE PROCEDURE spLeerArchivo
		@RutaArchivo			varchar(255),
		@Archivo				varchar(max) OUTPUT,
		@Ok						int = NULL OUTPUT,
		@OkRef					varchar(255) = NULL OUTPUT		

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @Codigo					int,
    @SQL					nvarchar(max),
    @Campo					varchar(max)

--SELECT @RutaArchivo = @RutaArchivo + '1'
  SET @Codigo = '1252'
  SET @Archivo = ''

  IF (OBJECT_ID('Tempdb..#NotificacionLeerArchivo')) IS NOT NULL
    DROP TABLE #NotificacionLeerArchivo

  CREATE TABLE #NotificacionLeerArchivo
  (
    ArchivoXML varchar(max) NOT NULL
   )

  SET @SQL = N'BULK INSERT #NotificacionLeerArchivo
                FROM ''' +  @RutaArchivo + '''
                WITH (CODEPAGE = ' + CONVERT(varchar, @Codigo) + ')'
                
  EXEC (@SQL)
  IF NOT EXISTS(SELECT * FROM #NotificacionLeerArchivo)
  BEGIN
    SELECT @OK = 71525
    SELECT @OkRef = (SELECT Descripcion FROM MensajeLista WHERE Mensaje = @Ok)
    SELECT @OkRef = @OkRef + ' ' + @RutaArchivo
  END

  DECLARE crArchivoXML CURSOR FOR
   SELECT ISNULL(ArchivoXML, '')
     FROM #NotificacionLeerArchivo

  OPEN crArchivoXML
  FETCH NEXT FROM crArchivoXML INTO @Campo
  WHILE @@FETCH_STATUS = 0
  BEGIN
	SELECT @Archivo = @Archivo + @Campo

    FETCH NEXT FROM crArchivoXML INTO @Campo
  END
  CLOSE crArchivoXML
  DEALLOCATE crArchivoXML

END
GO

/******************************* spLeerCorreo *************************************************/
if exists (select * from sysobjects where id = object_id('dbo.spLeerCorreo') and type = 'P') drop procedure dbo.spLeerCorreo --AUTORIZACIONREMOTA
GO             
CREATE PROCEDURE spLeerCorreo
		@Archivo				varchar(max) OUTPUT,
		@Ok						int = NULL OUTPUT,
		@OkRef					varchar(255) = NULL OUTPUT		

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
  @UID						uniqueidentifier,
  @UIDTexto					varchar(50),
  @RutaCompleta				varchar(255),
  @RecibirCorreoPerfil		varchar(50),
  @RecibirCorreoPOP3		varchar(255),
  @CadenaConexion			varchar(max),
  @Shell					varchar(8000),
  @iDatos					int,
  @Cuenta					varchar(50),
  @Fecha					varchar(50),  
  @CantidadMensajes			int,
  @Servidor					varchar(50),
  @BaseDatos				varchar(50),
  @Empresa					varchar(5)    

  DECLARE @Mensaje TABLE
  (
  ID				int NULL,
  De				varchar(255) COLLATE DATABASE_DEFAULT NULL,
  Para				varchar(max) COLLATE DATABASE_DEFAULT NULL,  
  CC				varchar(max) COLLATE DATABASE_DEFAULT NULL,    
  Asunto			varchar(max) COLLATE DATABASE_DEFAULT NULL,      
  Mensaje			varchar(max) COLLATE DATABASE_DEFAULT NULL,        
  Enviado			varchar(50) COLLATE DATABASE_DEFAULT NULL
  )    
  
  SET @UID = NEWID()  
  SET @UIDTexto = LTRIM(RTRIM(CONVERT(varchar(50),@UID)))

  SELECT 
    @RutaCompleta = LTRIM(RTRIM(ISNULL(RecibirCorreoRuta,''))), 
    @RecibirCorreoPerfil = LTRIM(RTRIM(ISNULL(RecibirCorreoPerfil,''))), 
    @RecibirCorreoPOP3 = LTRIM(RTRIM(ISNULL(RecibirCorreoRutaComponentePOP,''))) 
    FROM Version

  IF NULLIF(@RecibirCorreoPerfil,'') IS NULL SELECT @Ok = 53060 ELSE
  IF NULLIF(@RutaCompleta,'') IS NULL SELECT @Ok = 53070 ELSE    
  IF NULLIF(@RecibirCorreoPOP3,'') IS NULL SELECT @Ok = 53080     
  
  IF @Ok IS NULL
  BEGIN  
    DELETE FROM CorreoRecibido WHERE SPID = @@SPID
    
    IF SUBSTRING(REVERSE(@RutaCompleta),1,1) = '\'
      SET @RutaCompleta = @RutaCompleta + 'CorreoRecibido_' + @UIDTexto + '.XML'
    ELSE
      SET @RutaCompleta = @RutaCompleta + '\CorreoRecibido_' + @UIDTexto + '.XML'

    SELECT @CadenaConexion = dbo.fnGenerarCadenaConexionCorreo(@RutaCompleta, @RecibirCorreoPerfil)  
    
    SET @Shell = @RecibirCorreoPOP3 + ' ' + @CadenaConexion

    EXEC xp_cmdshell @Shell, no_output
    
    EXEC spLeerArchivo @RutaCompleta, @Archivo OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
    
    EXEC sp_xml_preparedocument @iDatos OUTPUT, @Archivo
    SELECT  
      @Cuenta = Cuenta,
      @Fecha = Fecha, 
      @CantidadMensajes = CantidadMensajes,     
      @Servidor = Servidor,
      @BaseDatos = BaseDatos,
      @Empresa = Empresa 
      FROM OPENXML (@iDatos, '/Mensajes', 1) WITH (Cuenta varchar(50), Fecha varchar(50), CantidadMensajes int, Servidor varchar(50), BaseDatos varchar(50), Empresa varchar(5))    
      

    INSERT CorreoRecibido (SPID,   ID, Cuenta,  Fecha,  CantidadMensajes,  Servidor,  BaseDatos,  Empresa,  De, Para, CC, Asunto, Mensaje, Enviado)
                   SELECT  @@SPID, ID, @Cuenta, @Fecha, @CantidadMensajes, @Servidor, @BaseDatos, @Empresa, De, Para, CC, Asunto, Mensaje, Enviado
                     FROM OPENXML (@iDatos, '/Mensajes/Mensaje', 1) WITH (ID int, De varchar(255), Para varchar(max), CC varchar(max), Asunto varchar(max), Mensaje varchar(max), Enviado varchar(50))            
    EXEC sp_xml_removedocument @iDatos          
  END
      
    
END
GO

--BUG17262
/**************** fnCaracterAUTF8 ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnCaracterAUTF8') DROP FUNCTION fnCaracterAUTF8
GO
CREATE FUNCTION fnCaracterAUTF8 
	(
	@Caracter				CHAR(1),
	@ConvertirCP437			bit,
	@ConvertirComillas		bit = 1
	)
RETURNS varCHAR(20)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @CaracterCP437	int,
    @CaracterUTF8	varCHAR(20)

  SET @CaracterCP437 = dbo.fnASCII_CP437(@Caracter,@ConvertirCP437)
  
  --IF @Caracter = CHAR(60) SET @CaracterUTF8  = '&lt;'     ELSE
  --IF @Caracter = CHAR(62) SET @CaracterUTF8  = '&gt;'     ELSE
  IF @Caracter = CHAR(38) SET @CaracterUTF8  = '&#038;'    ELSE
  IF @Caracter = CHAR(94) SET @CaracterUTF8  = '&#094;'    ELSE
  IF @Caracter = CHAR(34) AND @ConvertirComillas = 1 SET @CaracterUTF8  = '&#034;'    ELSE  
  IF (@CaracterCP437 >= 128 OR @CaracterCP437 <= 31) AND @CaracterCP437 NOT IN (10,13) SET @CaracterUTF8 = '&#' + REPLICATE('0',3-LEN(CONVERT(varchar,dbo.fnASCII_CP437(@Caracter,@ConvertirCP437)))) + CONVERT(varchar,dbo.fnASCII_CP437(@Caracter,@ConvertirCP437)) + ';' ELSE
  IF (@CaracterCP437 < 128 AND @CaracterCP437 >= 32) OR @CaracterCP437 IN (10,13) SET @CaracterUTF8 = @Caracter
  
  RETURN (@CaracterUTF8)
END
GO

--BUG17262
/**************** fneDocXmlAUTF8 ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fneDocXmlAUTF8') DROP FUNCTION dbo.fneDocXmlAUTF8
GO
CREATE FUNCTION dbo.fneDocXmlAUTF8 
	(
	@XML				varchar(max),
	@ConvertirCP437		bit = 0,
	@ConvertirComillas  bit = 1
	)
RETURNS varchar(max)

--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @LongitudTexto			bigint,
    @Caracter				char(1),
    @Contador				bigint,
    @Estado					int,
    @Consecutivo			varchar(50),
    @EstadoAnterior			int,
    @PosicionIni			bigint,
    @PosicionFin			bigint,
    @XMLResultado			varchar(max),
    @Numero					int,
    @CaracterUTF8			varchar(20),
    @PosicionPuntoyComa		int    
    

  SET @XMLResultado = ''
  SELECT @LongitudTexto = LEN(@XML), @Contador = 1, @Estado = 0, @Consecutivo = '', @PosicionIni = 0
  WHILE @Contador <= @LongitudTexto
  BEGIN
    SELECT @Caracter = SUBSTRING(@XML,@Contador,1)
    SET @EstadoAnterior = @Estado
    SET @Estado = CASE 
      WHEN @Estado IN (0,1) AND @Caracter IN ('&')     THEN 1
      WHEN @Estado IN (0,1) AND @Caracter NOT IN ('&') THEN 0
    END

    IF @Estado = 0
    BEGIN
      SET @XMLResultado = @XMLResultado + dbo.fnCaracterAUTF8(@Caracter,@ConvertirCP437,@ConvertirComillas)      
    END
    IF @Estado = 1
    BEGIN
      SET @CaracterUTF8 = SUBSTRING(@XML,@Contador,20)
      SET @PosicionPuntoyComa = ISNULL(PATINDEX('%;%',@CaracterUTF8),0)
      IF @PosicionPuntoyComa <> 0 
        SET @CaracterUTF8 = SUBSTRING(@CaracterUTF8,1,@PosicionPuntoyComa)
      ELSE
        SET @CaracterUTF8 = NULL
        
      IF @CaracterUTF8 IS NOT NULL AND dbo.fnEsCaracterUTF8(@CaracterUTF8) = 0
        SET @XMLResultado = @XMLResultado + dbo.fnCaracterAUTF8(@Caracter,@ConvertirCP437,@ConvertirComillas)      
      ELSE IF @CaracterUTF8 IS NOT NULL 
          SET @XMLResultado = @XMLResultado + @Caracter

      IF @CaracterUTF8 IS NULL 
        SET @XMLResultado = @XMLResultado + dbo.fnCaracterAUTF8(@Caracter,@ConvertirCP437,@ConvertirComillas)                      
    END
     
    SET @Contador = @Contador + 1
  END
  
  RETURN @XMLResultado
END
GO

--C:\IntelisisPOP3 ServidorP3=mail.intelisis.com.mx;UsuarioP3=aromano@intelisis.com.mx;ContraseñaP3=intelisis;Cuenta=Aromano Intelisis;Servidor=ABRAHAMROMANO;BaseDatos=V4500;Empresa=;MaxCaracteres=65536;Ruta="C:\CFD\AutorizacionRemota\CorreoRecibido_FCC38C9E-83C2-4680-BC01-4DCA8BFBF710.XML"
/*
DECLARE
@Archivo					varchar(max),
@Ok							int,
@OkRef						varchar(255)

EXEC spLeerCorreo @Archivo OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
SELECT CONVERT(XML,@Archivo), @Ok, @OkRef
SELECT * FROM CorreoRecibido WHERE SPID = @@SPID
*/

/******************************* spProcesarCorreo *************************************************/
if exists (select * from sysobjects where id = object_id('dbo.spProcesarCorreo') and type = 'P') drop procedure dbo.spProcesarCorreo --AUTORIZACIONREMOTA
GO             
CREATE PROCEDURE spProcesarCorreo
				(
				@UsuarioProceso					varchar(10)
				)
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
  @Archivo					varchar(max),
  @Ok						int,
  @OkRef					varchar(255),
  
  @ID						int, 
  @Cuenta					varchar(50), 
  @Fecha					varchar(50),
  @CantidadMensajes			int,
  @Servidor					varchar(50),
  @BaseDatos				varchar(50),
  @Empresa					varchar(5),
  @De						varchar(255),
  @Para						varchar(max),
  @CC						varchar(max),
  @Asunto					varchar(max),
  @Mensaje					varchar(max),
  @Enviado					varchar(50),   
  @Tipo						varchar(50),
  @EmpresaMov				varchar(5),
  @Sucursal					int,
  @Modulo					varchar(5),
  @IDMov					int,
  @Mov						varchar(20),
  @MovID					varchar(20),  
  @Estatus					varchar(15),
  @Situacion				varchar(50),
  @Usuario					varchar(10),
  @CheckSum					int,
  @CadenaAutorizacionValida	bit,
  @Solicitud				varchar(max),
  @Resultado				varchar(max),  
  @Contrasena				varchar(32),
  @IntelisisServiceID		int,
  @Movimiento				varchar(50)      

  SELECT @Contrasena = Contrasena FROM Usuario WHERE Usuario = @UsuarioProceso
  
  EXEC spLeerCorreo @Archivo OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
  
  DECLARE crCorreoRecibido CURSOR FOR
   SELECT ID, Cuenta, Fecha, CantidadMensajes, Servidor, BaseDatos, Empresa, De, Para, CC, Asunto, Mensaje, Enviado 
     FROM CorreoRecibido
    WHERE SPID = @@SPID

  OPEN crCorreoRecibido
  FETCH NEXT FROM crCorreoRecibido INTO @IDMov, @Cuenta, @Fecha, @CantidadMensajes, @Servidor, @BaseDatos, @Empresa, @De, @Para, @CC, @Asunto, @Mensaje, @Enviado 
  WHILE @@FETCH_STATUS = 0
  BEGIN
    SELECT @Tipo = NULL, @EmpresaMov = NULL, @Sucursal = NULL, @Modulo = NULL, @IDMov = NULL, @Estatus = NULL, @Situacion = NULL, @Usuario = NULL, @CheckSum = NULL, @CadenaAutorizacionValida = 0
    EXEC spValidarCadenaAutorizacion @Mensaje, @Tipo OUTPUT, @EmpresaMov OUTPUT, @Sucursal OUTPUT, @Modulo OUTPUT, @IDMov OUTPUT, @Estatus OUTPUT, @Situacion OUTPUT, @Usuario OUTPUT, @CheckSum OUTPUT, @CadenaAutorizacionValida OUTPUT    
    IF @Tipo = 'AUTORIZACION'
    BEGIN
      EXEC spMovInfo @IDMov, @Modulo, @Mov = @Mov OUTPUT, @MovID = @MovID OUTPUT --AUTORIZACION
      SELECT @Movimiento = LTRIM(RTRIM(ISNULL(@Mov,''))) + ' ' + LTRIM(RTRIM(ISNULL(@MovID,'')))      
      SET @Solicitud = '<Intelisis Sistema="Intelisis" Contenido="Solicitud" Referencia="Intelisis.Autorizacion" SubReferencia="' + ISNULL(@Modulo,'') + '" Version="1.0">' +
                       '  <Solicitud>' +                    
                       '    <Autorizacion Empresa = "' + dbo.fneDocXMLAUTF8(@EmpresaMov,0,1) + '" Sucursal="' + CONVERT(varchar,ISNULL(@Sucursal,-1))  + '" Modulo="' + LTRIM(RTRIM(dbo.fneDocXMLAUTF8(ISNULL(@Modulo,''),0,1))) + '" ID="' + LTRIM(RTRIM(CONVERT(varchar,ISNULL(@IDMov,0)))) + '" Mov="' + dbo.fneDocXMLAUTF8(LTRIM(RTRIM(ISNULL(@Mov,''))),0,1) + '" Movimiento="' + dbo.fneDocXMLAUTF8(LTRIM(RTRIM(ISNULL(@Movimiento,''))),0,1) + '" Estatus="' + LTRIM(RTRIM(dbo.fneDocXMLAUTF8(ISNULL(@Estatus,''),0,1))) + '" Situacion="' + LTRIM(RTRIM(dbo.fneDocXMLAUTF8(ISNULL(@Situacion,''),0,1))) + '" CadenaAutorizacionValida="' + LTRIM(RTRIM(CONVERT(varchar,ISNULL(@CadenaAutorizacionValida,0)))) + '" De="' + LTRIM(RTRIM(dbo.fneDocXMLAUTF8(ISNULL(@De,''),0,1))) + '" Asunto="' + LTRIM(RTRIM(dbo.fneDocXMLAUTF8(ISNULL(@Asunto,''),0,1))) + '" Mensaje="' + REPLACE(REPLACE(LTRIM(RTRIM(dbo.fneDocXMLAUTF8(ISNULL(@Mensaje,''),0,1))),'<','&#060;'),'>','&#062;') + '"/>' +
                       '  </Solicitud>' +
                       '</Intelisis>'

      EXEC spIntelisisService @Usuario, @Contrasena, @Solicitud, @Resultado OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, 1, 0, @IntelisisServiceID OUTPUT                                              
    END
    FETCH NEXT FROM crCorreoRecibido INTO @ID, @Cuenta, @Fecha, @CantidadMensajes, @Servidor, @BaseDatos, @Empresa, @De, @Para, @CC, @Asunto, @Mensaje, @Enviado 
  END
  CLOSE crCorreoRecibido
  DEALLOCATE crCorreoRecibido

END
GO

--exec spProcesarCorreo 'DEMO'
/*
DECLARE
  @Tipo							varchar(50),
  @Empresa						varchar(5),
  @Sucursal						int,  
  @Modulo						varchar(5),
  @ID							int,
  @Estatus						varchar(15),  
  @Situacion					varchar(50),    
  @Usuario						varchar(10),
  @CheckSum						int,
  @CadenaAutorizacionValida		bit

SET @CadenaAutorizacionValida = 0
EXEC spValidarCadenaAutorizacion '||AUTORIZACION|DEMO|0|VTAS|1|PENDIENTE|POR AUTORIZAR|DEMO|567807976||fin del mensaje', @Tipo OUTPUT, @Empresa OUTPUT, @Sucursal OUTPUT, @Modulo OUTPUT, @ID OUTPUT, @Estatus OUTPUT, @Situacion OUTPUT, @Usuario OUTPUT, @CheckSum OUTPUT, @CadenaAutorizacionValida OUTPUT
SELECT @Tipo, @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @Situacion, @Usuario, @Checksum, @CadenaAutorizacionValida
*/


/**************** fnModuloID ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnModuloID') DROP FUNCTION fnModuloID
GO
CREATE FUNCTION fnModuloID (@Empresa char(5), @Modulo char(5), @Mov char(20), @MovID varchar(20), @Ejercicio int, @Periodo int)
RETURNS int
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @ID	int
  SELECT @ID = NULL

  IF @Modulo = 'VTAS'  SELECT @ID = ID FROM Venta 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'CXC'   SELECT @ID = ID FROM Cxc 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'ST'    SELECT @ID = ID FROM Soporte 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'COMS'  SELECT @ID = ID FROM Compra 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'CXP'   SELECT @ID = ID FROM Cxp 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'AGENT' SELECT @ID = ID FROM Agent 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'GAS'   SELECT @ID = ID FROM Gasto 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'DIN'   SELECT @ID = ID FROM Dinero    		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'AF'    SELECT @ID = ID FROM ActivoFijo 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'VALE'  SELECT @ID = ID FROM Vale 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'CR'    SELECT @ID = ID FROM CR 			WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'CAM'   SELECT @ID = ID FROM Cambio 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'PACTO' SELECT @ID = ID FROM Contrato 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'CAP'   SELECT @ID = ID FROM Capital 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'INC'   SELECT @ID = ID FROM Incidencia 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'CONC'  SELECT @ID = ID FROM Conciliacion	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'PPTO'  SELECT @ID = ID FROM Presup      	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'CREDI' SELECT @ID = ID FROM Credito		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'TMA'   SELECT @ID = ID FROM TMA 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'RSS'   SELECT @ID = ID FROM RSS 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'CMP'   SELECT @ID = ID FROM Campana		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'FIS'   SELECT @ID = ID FROM Fiscal		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  --REQ25014
  IF @Modulo = 'CONTP' SELECT @ID = ID FROM ContParalela WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  --REQ16092
  IF @Modulo = 'OPORT' SELECT @ID = ID FROM Oportunidad WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE  
  IF @Modulo = 'CORTE' SELECT @ID = ID FROM Corte		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE  
  IF @Modulo = 'FRM'   SELECT @ID = ID FROM FormaExtra		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'CAPT'  SELECT @ID = ID FROM Captura 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'GES'   SELECT @ID = ID FROM Gestion 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'CP'    SELECT @ID = ID FROM CP   		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'PCP'   SELECT @ID = ID FROM PCP   		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE --MEJORA4722  
  IF @Modulo = 'PROY'  SELECT @ID = ID FROM Proyecto		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  --IF @Modulo = 'ACT'   SELECT @ID = ID FROM Act 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  --IF @Modulo = 'MEX01' SELECT @ID = ID FROM ModuloExtra01	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  --IF @Modulo = 'MEX02' SELECT @ID = ID FROM ModuloExtra02	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  --IF @Modulo = 'MEX03' SELECT @ID = ID FROM ModuloExtra03	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  --IF @Modulo = 'MEX04' SELECT @ID = ID FROM ModuloExtra04	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  --IF @Modulo = 'MEX05' SELECT @ID = ID FROM ModuloExtra05	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  --IF @Modulo = 'MEX06' SELECT @ID = ID FROM ModuloExtra06	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  --IF @Modulo = 'MEX07' SELECT @ID = ID FROM ModuloExtra07	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  --IF @Modulo = 'MEX08' SELECT @ID = ID FROM ModuloExtra08	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  --IF @Modulo = 'MEX09' SELECT @ID = ID FROM ModuloExtra09	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'ORG'   SELECT @ID = ID FROM Organiza	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'RE'    SELECT @ID = ID FROM Recluta		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'ISL'   SELECT @ID = ID FROM ISL         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'CONT'  SELECT @ID = ID FROM Cont 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'PROD'  SELECT @ID = ID FROM Prod 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'INV'   SELECT @ID = ID FROM Inv 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'PC'    SELECT @ID = ID FROM PC 			WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'OFER'  SELECT @ID = ID FROM Oferta		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'NOM'   SELECT @ID = ID FROM Nomina 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'RH'    SELECT @ID = ID FROM RH 			WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'ASIS'  SELECT @ID = ID FROM Asiste 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'EMB'   SELECT @ID = ID FROM Embarque 	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'SAUX'  SELECT @ID = ID FROM SAUX 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = ISNULL(@Ejercicio, Ejercicio) AND Periodo = ISNULL(@Periodo, Periodo) AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')
  RETURN (@ID)
END
GO 

/**************** fnModuloIDContRegAnterior ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnModuloIDContRegAnterior') DROP FUNCTION fnModuloIDContRegAnterior
GO
CREATE FUNCTION fnModuloIDContRegAnterior (@Empresa char(5), @Modulo char(5), @Mov char(20), @MovID varchar(20), @Ejercicio int, @Periodo int)
RETURNS int
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @ID	int
  SELECT @ID = NULL

  IF @Modulo = 'VTAS'  SELECT @ID = ID FROM Venta 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'CXC'   SELECT @ID = ID FROM Cxc 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'ST'    SELECT @ID = ID FROM Soporte 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'COMS'  SELECT @ID = ID FROM Compra 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'CXP'   SELECT @ID = ID FROM Cxp 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'AGENT' SELECT @ID = ID FROM Agent 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'GAS'   SELECT @ID = ID FROM Gasto 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'DIN'   SELECT @ID = ID FROM Dinero    		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'AF'    SELECT @ID = ID FROM ActivoFijo 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'VALE'  SELECT @ID = ID FROM Vale 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'CR'    SELECT @ID = ID FROM CR 			WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'CAM'   SELECT @ID = ID FROM Cambio 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'PACTO' SELECT @ID = ID FROM Contrato 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'CAP'   SELECT @ID = ID FROM Capital 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'INC'   SELECT @ID = ID FROM Incidencia 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'CONC'  SELECT @ID = ID FROM Conciliacion	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'PPTO'  SELECT @ID = ID FROM Presup      	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'CREDI' SELECT @ID = ID FROM Credito		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'TMA'   SELECT @ID = ID FROM TMA 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'RSS'   SELECT @ID = ID FROM RSS 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'CMP'   SELECT @ID = ID FROM Campana		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'FIS'   SELECT @ID = ID FROM Fiscal		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  --REQ25014
  IF @Modulo = 'CONTP' SELECT @ID = ID FROM ContParalela WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE   
  --REQ16092
  IF @Modulo = 'OPORT' SELECT @ID = ID FROM Oportunidad WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE  
  IF @Modulo = 'CORTE' SELECT @ID = ID FROM Corte		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'FRM'   SELECT @ID = ID FROM FormaExtra 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'CAPT'  SELECT @ID = ID FROM Captura		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'GES'   SELECT @ID = ID FROM Gestion 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO') ELSE
  IF @Modulo = 'CP'    SELECT @ID = ID FROM CP   		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'PCP'   SELECT @ID = ID FROM PCP   		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE --MEJORA4722 
  IF @Modulo = 'PROY'  SELECT @ID = ID FROM Proyecto		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  --IF @Modulo = 'ACT'   SELECT @ID = ID FROM Act 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  --IF @Modulo = 'MEX01' SELECT @ID = ID FROM ModuloExtra01	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  --IF @Modulo = 'MEX02' SELECT @ID = ID FROM ModuloExtra02	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  --IF @Modulo = 'MEX03' SELECT @ID = ID FROM ModuloExtra03	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  --IF @Modulo = 'MEX04' SELECT @ID = ID FROM ModuloExtra04	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  --IF @Modulo = 'MEX05' SELECT @ID = ID FROM ModuloExtra05	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  --IF @Modulo = 'MEX06' SELECT @ID = ID FROM ModuloExtra06	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  --IF @Modulo = 'MEX07' SELECT @ID = ID FROM ModuloExtra07	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  --IF @Modulo = 'MEX08' SELECT @ID = ID FROM ModuloExtra08	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  --IF @Modulo = 'MEX09' SELECT @ID = ID FROM ModuloExtra09	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'ORG'   SELECT @ID = ID FROM Organiza	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'RE'    SELECT @ID = ID FROM Recluta		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'ISL'   SELECT @ID = ID FROM ISL         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'CONT'  SELECT @ID = ID FROM Cont 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'PROD'  SELECT @ID = ID FROM Prod 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'INV'   SELECT @ID = ID FROM Inv 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'PC'    SELECT @ID = ID FROM PC 			WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'OFER'  SELECT @ID = ID FROM Oferta		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'NOM'   SELECT @ID = ID FROM Nomina 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'RH'    SELECT @ID = ID FROM RH 			WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'ASIS'  SELECT @ID = ID FROM Asiste 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'EMB'   SELECT @ID = ID FROM Embarque 	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
  IF @Modulo = 'SAUX'  SELECT @ID = ID FROM SAUX	 	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @Ejercicio AND Periodo = @Periodo AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') 

  IF @ID IS NULL
  BEGIN
    IF @Modulo = 'VTAS'  SELECT @ID = ID FROM Venta 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CXC'   SELECT @ID = ID FROM Cxc 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'ST'    SELECT @ID = ID FROM Soporte 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'COMS'  SELECT @ID = ID FROM Compra 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CXP'   SELECT @ID = ID FROM Cxp 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'AGENT' SELECT @ID = ID FROM Agent 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'GAS'   SELECT @ID = ID FROM Gasto 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'DIN'   SELECT @ID = ID FROM Dinero    	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'AF'    SELECT @ID = ID FROM ActivoFijo 	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'VALE'  SELECT @ID = ID FROM Vale 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CR'    SELECT @ID = ID FROM CR 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CAM'   SELECT @ID = ID FROM Cambio 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'PACTO' SELECT @ID = ID FROM Contrato		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CAP'   SELECT @ID = ID FROM Capital 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'INC'   SELECT @ID = ID FROM Incidencia 	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CONC'  SELECT @ID = ID FROM Conciliacion	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'PPTO'  SELECT @ID = ID FROM Presup      	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CREDI' SELECT @ID = ID FROM Credito		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'TMA'   SELECT @ID = ID FROM TMA 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'RSS'   SELECT @ID = ID FROM RSS 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CMP'   SELECT @ID = ID FROM Campana		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'FIS'   SELECT @ID = ID FROM Fiscal		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --REQ25014
    IF @Modulo = 'CONTP' SELECT @ID = ID FROM ContParalela WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE        
    --REQ16092
	IF @Modulo = 'OPORT' SELECT @ID = ID FROM Oportunidad   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CORTE' SELECT @ID = ID FROM Corte		    WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'FRM'   SELECT @ID = ID FROM FormaExtra	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CAPT'  SELECT @ID = ID FROM Captura   	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'GES'   SELECT @ID = ID FROM Captura   	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CP'    SELECT @ID = ID FROM CP      		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'PCP'   SELECT @ID = ID FROM PCP      		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE --MEJORA4722   
    IF @Modulo = 'PROY'  SELECT @ID = ID FROM Proyecto		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'ACT'   SELECT @ID = ID FROM Act 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX01' SELECT @ID = ID FROM ModuloExtra01	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX02' SELECT @ID = ID FROM ModuloExtra02	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX03' SELECT @ID = ID FROM ModuloExtra03	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX04' SELECT @ID = ID FROM ModuloExtra04	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX05' SELECT @ID = ID FROM ModuloExtra05	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX06' SELECT @ID = ID FROM ModuloExtra06	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX07' SELECT @ID = ID FROM ModuloExtra07	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX08' SELECT @ID = ID FROM ModuloExtra08	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX09' SELECT @ID = ID FROM ModuloExtra09	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'ORG'   SELECT @ID = ID FROM Organiza		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'RE'    SELECT @ID = ID FROM Recluta		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'ISL'	 SELECT @ID = ID FROM ISL         	WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CONT'  SELECT @ID = ID FROM Cont 			WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'PROD'  SELECT @ID = ID FROM Prod 			WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'INV'   SELECT @ID = ID FROM Inv 			WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'PC'    SELECT @ID = ID FROM PC 			WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'OFER'  SELECT @ID = ID FROM Oferta		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'NOM'   SELECT @ID = ID FROM Nomina 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'RH'    SELECT @ID = ID FROM RH 			WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'ASIS'  SELECT @ID = ID FROM Asiste 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'EMB'   SELECT @ID = ID FROM Embarque 		WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'SAUX'  SELECT @ID = ID FROM SAUX 			WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') 
  END

  IF @ID IS NULL
  BEGIN
    IF @Modulo = 'VTAS'  SELECT @ID = ID FROM Venta 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CXC'   SELECT @ID = ID FROM Cxc 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'ST'    SELECT @ID = ID FROM Soporte 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'COMS'  SELECT @ID = ID FROM Compra 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CXP'   SELECT @ID = ID FROM Cxp 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'AGENT' SELECT @ID = ID FROM Agent 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'GAS'   SELECT @ID = ID FROM Gasto 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'DIN'   SELECT @ID = ID FROM Dinero    	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'AF'    SELECT @ID = ID FROM ActivoFijo 	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'VALE'  SELECT @ID = ID FROM Vale 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CR'    SELECT @ID = ID FROM CR 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CAM'   SELECT @ID = ID FROM Cambio 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'PACTO' SELECT @ID = ID FROM Contrato		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CAP'   SELECT @ID = ID FROM Capital 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'INC'   SELECT @ID = ID FROM Incidencia 	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CONC'  SELECT @ID = ID FROM Conciliacion	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'PPTO'  SELECT @ID = ID FROM Presup      	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CREDI' SELECT @ID = ID FROM Credito		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'TMA'   SELECT @ID = ID FROM TMA 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'RSS'   SELECT @ID = ID FROM RSS 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CMP'   SELECT @ID = ID FROM Campana		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'FIS'   SELECT @ID = ID FROM Fiscal		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --REQ25014
    IF @Modulo = 'CONTP' SELECT @ID = ID FROM ContParalela  WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE    
    --REQ16092
	IF @Modulo = 'OPORT' SELECT @ID = ID FROM Oportunidad   WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE    
    IF @Modulo = 'CORTE' SELECT @ID = ID FROM Corte		    WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE    
    IF @Modulo = 'FRM'   SELECT @ID = ID FROM FormaExtra	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CAPT'  SELECT @ID = ID FROM Captura   	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'GES'   SELECT @ID = ID FROM Gestion   	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CP'    SELECT @ID = ID FROM CP      		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'PCP'   SELECT @ID = ID FROM PCP      		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE --MEJORA4722   
    IF @Modulo = 'PROY'  SELECT @ID = ID FROM Proyecto		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'ACT'   SELECT @ID = ID FROM Act 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX01' SELECT @ID = ID FROM ModuloExtra01	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX02' SELECT @ID = ID FROM ModuloExtra02	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX03' SELECT @ID = ID FROM ModuloExtra03	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX04' SELECT @ID = ID FROM ModuloExtra04	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX05' SELECT @ID = ID FROM ModuloExtra05	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX06' SELECT @ID = ID FROM ModuloExtra06	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX07' SELECT @ID = ID FROM ModuloExtra07	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX08' SELECT @ID = ID FROM ModuloExtra08	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    --IF @Modulo = 'MEX09' SELECT @ID = ID FROM ModuloExtra09	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'ORG'   SELECT @ID = ID FROM Organiza		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'RE'    SELECT @ID = ID FROM Recluta		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'ISL'   SELECT @ID = ID FROM ISL         	WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'CONT'  SELECT @ID = ID FROM Cont 			WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'PROD'  SELECT @ID = ID FROM Prod 			WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'INV'   SELECT @ID = ID FROM Inv 			WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'PC'    SELECT @ID = ID FROM PC 			WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'OFER'  SELECT @ID = ID FROM Oferta		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'NOM'   SELECT @ID = ID FROM Nomina 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'RH'    SELECT @ID = ID FROM RH 			WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'ASIS'  SELECT @ID = ID FROM Asiste 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'EMB'   SELECT @ID = ID FROM Embarque 		WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') ELSE
    IF @Modulo = 'SAUX'  SELECT @ID = ID FROM SAUX 			WHERE Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') 
  END

  RETURN (@ID)
END
GO 

/**************** spActivoF ****************/
if exists (select * from sysobjects where id = object_id('dbo.spActivoF') and type = 'P') drop procedure dbo.spActivoF
GO              
CREATE PROCEDURE spActivoF 
		   @Sucursal			int,
	           @Empresa			char(5),
                   @Modulo                      char(5),
                   @Accion			char(20),
		   @EsEntrada			bit, 
		   @EsSalida			bit, 
		   @EsTransferencia		bit,

                   @ID  			int, 
	           @RenglonID			int, 
                   @Almacen			char(10),
		   @AlmacenDestino		char(10),
                   @Articulo                    char(20),
		   @ArtTipo			char(20),
                   @CantidadMovimiento 		float,
		   @ArtCosto			float,
		   @ArtMoneda			char(10),
		   @FechaEmision		datetime,

                   @Ok 				int		OUTPUT,
                   @OkRef 			varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Serie		varchar(50),
    @Cantidad		float,
    @Categoria		varchar(50),
    @VidaUtil		int,
    @DepreciacionAnual	float, 
    @Periodicidad 	varchar(20),
    @InicioDepreciacion	varchar(20),
    @ActivoFID		int,
    @ActivoFEstatus	char(15),
    @ActivoFAlmacen	char(10),
    @Inicio		datetime,
    @InicioF	datetime,
    @InicioF2	datetime,
    @SiguienteAno	int,
    @SiguienteAnoF	int,
    @SiguienteAnoF2	int,
    @AdquisicionFecha	datetime,
    @ValorDesecho	money,
	@VidaUtilF		int,
	@DepreciacionAnualF		float,
	@AdquisicionValorF		money,
	@AdquisicionFechaF		datetime,
	@DepreciacionInicioF	datetime,
	@InicioDepreciacionF	varchar(20),
    @ValorDesechoF			money,	
	@VidaUtilF2				int,
	@DepreciacionAnualF2	float,
	@InicioDepreciacionF2	varchar(20),
	@AdquisicionValorF2		money,
	@AdquisicionFechaF2		datetime,
	@DepreciacionInicioF2	datetime,
    @ValorDesechoF2			money,	
	@PorcentajeDeducible	float

  EXEC spExtraerFecha @FechaEmision OUTPUT
  DECLARE crSerieLoteMov CURSOR FOR 
   SELECT NULLIF(RTRIM(s.SerieLote), ''), ISNULL(s.Cantidad, 0.0), NULLIF(RTRIM(a.CategoriaActivoFijo), ''), cat.VidaUtil, NULLIF(cat.DepreciacionAnual, 0.0), cat.MantenimientoPeriodicidad, UPPER(cat.InicioDepreciacion), cat.ValorDesecho, cat.VidaUtilF, NULLIF(cat.DepreciacionAnualF, 0.0), UPPER(cat.InicioDepreciacionF), cat.ValorDesechoF, cat.VidaUtilF2, NULLIF(cat.DepreciacionAnualF2, 0.0), UPPER(cat.InicioDepreciacionF2), cat.ValorDesechoF2, ISNULL(PorcentajeDeducible,0.0)
     FROM Art a
     JOIN SerieLoteMov s ON a.Articulo = s.Articulo 
     LEFT OUTER JOIN ActivoFCat cat ON a.CategoriaActivoFijo = cat.Categoria
    WHERE Empresa   = @Empresa
      AND Modulo    = @Modulo
      AND ID        = @ID
      AND RenglonID = @RenglonID
      AND s.Articulo  = @Articulo

  OPEN crSerieLoteMov
  FETCH NEXT FROM crSerieLoteMov INTO @Serie, @Cantidad, @Categoria, @VidaUtil, @DepreciacionAnual, @Periodicidad, @InicioDepreciacion, @ValorDesecho, @VidaUtilF, @DepreciacionAnualF, @InicioDepreciacionF, @ValorDesechoF, @VidaUtilF2, @DepreciacionAnualF2, @InicioDepreciacionF2, @ValorDesechoF2, @PorcentajeDeducible
  IF @@ERROR <> 0 SELECT @Ok = 1
  WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
  BEGIN
    IF @@FETCH_STATUS <> -2 
    BEGIN
      SELECT @Inicio = DATEADD(day, -DATEPART(day, @FechaEmision)+1, @FechaEmision)
      IF @InicioDepreciacion = 'SIGUIENTE MES' SELECT @Inicio = DATEADD(month, 1, @Inicio) ELSE
      IF @InicioDepreciacion = 'SIGUIENTE AÑO'
      BEGIN
        SELECT @SiguienteAno = DATEPART(year, @FechaEmision)+ 1  
        EXEC spIntToDateTime 1, 1, @SiguienteAno, @Inicio OUTPUT
      END

      SELECT @InicioF = DATEADD(day, -DATEPART(day, @FechaEmision)+1, @FechaEmision)
      IF @InicioDepreciacionF = 'SIGUIENTE MES' SELECT @InicioF = DATEADD(month, 1, @InicioF) ELSE
      IF @InicioDepreciacionF = 'SIGUIENTE AÑO'
      BEGIN
        SELECT @SiguienteAnoF = DATEPART(year, @FechaEmision)+ 1  
        EXEC spIntToDateTime 1, 1, @SiguienteAnoF, @InicioF OUTPUT
      END

      SELECT @InicioF2 = DATEADD(day, -DATEPART(day, @FechaEmision)+1, @FechaEmision)
      IF @InicioDepreciacionF2 = 'SIGUIENTE MES' SELECT @InicioF2 = DATEADD(month, 1, @InicioF2) ELSE
      IF @InicioDepreciacionF2 = 'SIGUIENTE AÑO'
      BEGIN
        SELECT @SiguienteAnoF2 = DATEPART(year, @FechaEmision)+ 1  
        EXEC spIntToDateTime 1, 1, @SiguienteAnoF2, @InicioF2 OUTPUT
      END

      SELECT @ActivoFID = NULL, @ActivoFEstatus = NULL, @ActivoFAlmacen = NULL, @AdquisicionFecha = NULL
      SELECT @ActivoFID = ID, @ActivoFEstatus = Estatus, @ActivoFAlmacen = Almacen, @AdquisicionFecha = AdquisicionFecha
        FROM ActivoF 
       WHERE Empresa  = @Empresa
         AND Articulo = @Articulo 
         AND Serie    = @Serie

      IF @EsTransferencia = 1
      BEGIN
        IF @Almacen = @ActivoFAlmacen
          UPDATE ActivoF SET Almacen = @AlmacenDestino WHERE ID = @ActivoFID
        ELSE SELECT @Ok = 44040
      END ELSE      
      IF @EsEntrada = 1
      BEGIN
        IF @ActivoFEstatus IS NULL
	  INSERT ActivoF (Sucursal,      Empresa,  Articulo,  Serie,  Moneda,     Almacen,  AdquisicionValor, AdquisicionValorF, AdquisicionValorF2, AdquisicionFecha, AdquisicionFechaF, AdquisicionFechaF2, DepreciacionInicio, DepreciacionInicioF, DepreciacionInicioF2, Categoria,  VidaUtil,  DepreciacionAnual,  MantenimientoPeriodicidad, ValorDesecho,  Estatus,  VidaUtilF,  DepreciacionAnualF,  ValorDesechoF,  VidaUtilF2,  DepreciacionAnualF2,  ValorDesechoF2,  PorcentajeDeducible) 
                  VALUES (@Sucursal, @Empresa, @Articulo, @Serie, @ArtMoneda, @Almacen, @ArtCosto,        @ArtCosto,         @ArtCosto,          @FechaEmision,    @FechaEmision,     @FechaEmision,      @Inicio,            @InicioF,            @InicioF2,            @Categoria, @VidaUtil, @DepreciacionAnual, @Periodicidad,             @ValorDesecho, 'ACTIVO', @VidaUtilF, @DepreciacionAnualF, @ValorDesechoF, @VidaUtilF2, @DepreciacionAnualF2, @ValorDesechoF2, @PorcentajeDeducible)
        ELSE 
          IF @ActivoFEstatus = 'INACTIVO'
          BEGIN
            IF @AdquisicionFecha IS NULL /** JH 24.11.2006 **/ AND @Accion <> 'CANCELAR'
              UPDATE ActivoF 
                 SET Almacen = @Almacen,
		     Categoria = @Categoria,  
		     VidaUtil = @VidaUtil,  
             DepreciacionAnual = @DepreciacionAnual,
 		     MantenimientoPeriodicidad = @Periodicidad,
             AdquisicionValor = CASE @Accion WHEN 'CANCELAR' THEN AdquisicionValor ELSE @ArtCosto END, 
             AdquisicionFecha = @FechaEmision, 
             DepreciacionInicio = @Inicio,
		     Utilizacion = NULL,
		     DepreciacionAcum = NULL,
		     DepreciacionUltima = NULL,
		     ValorRevaluado = NULL,
		     RevaluacionUltima = NULL,
		     SeguroAcum = NULL,
             ValorDesecho = @ValorDesecho,
		     Estatus = 'ACTIVO',
			 VidaUtilF = @VidaUtilF,
             DepreciacionAnualF = @DepreciacionAnualF,
             AdquisicionValorF = CASE @Accion WHEN 'CANCELAR' THEN AdquisicionValorF ELSE @ArtCosto END, 
             AdquisicionFechaF = @FechaEmision, 
             DepreciacionInicioF = @InicioF,
             VidaUtilF2 = @VidaUtilF2,
             DepreciacionAnualF2 = @DepreciacionAnualF2,
             AdquisicionValorF2 = CASE @Accion WHEN 'CANCELAR' THEN AdquisicionValorF2 ELSE @ArtCosto END, 
             AdquisicionFechaF2 = @FechaEmision, 
             DepreciacionInicioF2 = @InicioF2,
			 PorcentajeDeducible = @PorcentajeDeducible    
               WHERE ID = @ActivoFID
            ELSE
              UPDATE ActivoF 
                 SET Almacen = @Almacen,
		     Estatus = 'ACTIVO'                 
               WHERE ID = @ActivoFID
          END ELSE SELECT @Ok = 44020
      END ELSE
      IF @EsSalida = 1 
      BEGIN
        IF @ActivoFEstatus = 'ACTIVO'
          UPDATE ActivoF SET Estatus = 'INACTIVO', AdquisicionFecha = CASE WHEN @Accion = 'CANCELAR' THEN NULL ELSE AdquisicionFecha END, AdquisicionFechaF = CASE WHEN @Accion = 'CANCELAR' THEN NULL ELSE AdquisicionFechaF END, AdquisicionFechaF2 = CASE WHEN @Accion = 'CANCELAR' THEN NULL ELSE AdquisicionFechaF2 END WHERE ID = @ActivoFID
        ELSE SELECT @Ok = 44030
      END 
    END
    FETCH NEXT FROM crSerieLoteMov INTO @Serie, @Cantidad, @Categoria, @VidaUtil, @DepreciacionAnual, @Periodicidad, @InicioDepreciacion, @ValorDesecho, @VidaUtilF, @DepreciacionAnualF, @InicioDepreciacionF, @ValorDesechoF, @VidaUtilF2, @DepreciacionAnualF2, @InicioDepreciacionF2, @ValorDesechoF2, @PorcentajeDeducible
    IF @@ERROR <> 0 SELECT @Ok = 1
  END
  CLOSE crSerieLoteMov
  DEALLOCATE crSerieLoteMov

  IF @Ok IS NOT NULL 
    SELECT @OkRef = RTRIM(@Articulo)+' - '+RTRIM(@Serie)
  RETURN
END
GO

/************** spActualizarZonaImpuestos *************/
if exists (select * from sysobjects where id = object_id('dbo.spActualizarZonaImpuestos') and sysstat & 0xf = 4) drop procedure dbo.spActualizarZonaImpuestos
GO
CREATE PROCEDURE spActualizarZonaImpuestos
		   	@Modulo		char(5),
			@ID		int
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Mov		varchar(20),
    @Empresa		varchar(5),
    @Sucursal		int,
    @Contacto		varchar(10),
    @EnviarA		int,
    @FechaEmision	datetime,
    @ZonaImpuesto	varchar(50), 
    @Articulo		varchar(20),
    @Impuesto1		float, 
    @Impuesto2		float, 
    @Impuesto3		float

  IF @Modulo = 'COMS'
    DECLARE crMovD CURSOR FOR
     SELECT e.Mov, e.Empresa, e.Sucursal, e.FechaEmision, e.Proveedor, CONVERT(int, NULL), e.ZonaImpuesto, d.Articulo, a.Impuesto1, a.Impuesto2, a.Impuesto3
       FROM CompraD d, Compra e, Art a 
      WHERE e.ID = @ID AND e.ID = d.ID AND d.Articulo = a.Articulo
  IF @Modulo = 'VTAS'
    DECLARE crMovD CURSOR FOR
     SELECT e.Mov, e.Empresa, e.Sucursal, e.FechaEmision, e.Cliente, e.EnviarA, e.ZonaImpuesto, d.Articulo, a.Impuesto1, a.Impuesto2, a.Impuesto3
       FROM VentaD d, Venta e, Art a 
      WHERE e.ID = @ID AND e.ID = d.ID AND d.Articulo = a.Articulo

  OPEN crMovD
  FETCH NEXT FROM crMovD INTO @Mov, @Empresa, @Sucursal, @FechaEmision, @Contacto, @EnviarA, @ZonaImpuesto, @Articulo, @Impuesto1, @Impuesto2, @Impuesto3
  WHILE @@FETCH_STATUS <> -1 
  BEGIN
    IF @@FETCH_STATUS <> -2 
    BEGIN
      EXEC spZonaImp @ZonaImpuesto, @Impuesto1 OUTPUT
      EXEC spZonaImp @ZonaImpuesto, @Impuesto2 OUTPUT
      EXEC spZonaImp @ZonaImpuesto, @Impuesto3 OUTPUT
      EXEC spTipoImpuesto @Modulo, @ID, @Mov, @FechaEmision, @Empresa, @Sucursal, @Contacto, @EnviarA, @Articulo = @Articulo, @EnSilencio = 1, @Impuesto1 = @Impuesto1 OUTPUT, @Impuesto2 = @Impuesto2 OUTPUT, @Impuesto3 = @Impuesto3 OUTPUT

      IF @Modulo = 'COMS' UPDATE CompraD SET Impuesto1 = @Impuesto1, Impuesto2 = @Impuesto2, @Impuesto3 = @Impuesto1 WHERE CURRENT OF crMovD ELSE
      IF @Modulo = 'VTAS' UPDATE VentaD  SET Impuesto1 = @Impuesto1, Impuesto2 = @Impuesto2, @Impuesto3 = @Impuesto1 WHERE CURRENT OF crMovD 
    END
    FETCH NEXT FROM crMovD INTO @Mov, @Empresa, @Sucursal, @FechaEmision, @Contacto, @EnviarA, @ZonaImpuesto, @Articulo, @Impuesto1, @Impuesto2, @Impuesto3
  END  -- While
  CLOSE crMovD
  DEALLOCATE crMovD
END
GO

/**************** spAfectarMovRecurrente ****************/
if exists (select * from sysobjects where id = object_id('dbo.spAfectarMovRecurrente') and type = 'P') drop procedure dbo.spAfectarMovRecurrente
GO             
CREATE PROCEDURE spAfectarMovRecurrente
			@Accion		char(20),
			@Empresa	char(5),
			@Modulo		char(5),
			@Mov		char(20),
			@MovID		varchar(20),
			@Ok		int		OUTPUT,
			@OkRef		varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @ID			int,
    @Periodicidad	varchar(50),
    @FechaEmision	datetime,
    @Vencimiento	datetime,
    @FechaD		datetime,
    @FechaA		datetime,
    @Reversa		bit,
    @ConVigencia	bit,
    @VigenciaDesde	datetime,
    @VigenciaHasta	datetime,
    @Estatus		char(15)

  IF @Accion = 'CANCELAR' SELECT @Reversa = 1 ELSE SELECT @Reversa = 0
  IF @Modulo = 'GAS'  SELECT @ID = ID, @Periodicidad = Periodicidad, @FechaEmision = FechaEmision, @Vencimiento = Vencimiento, @ConVigencia = ConVigencia, @VigenciaDesde = VigenciaDesde, @VigenciaHasta = VigenciaHasta, @Estatus = Estatus FROM Gasto WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus = 'RECURRENTE' ELSE
  IF @Modulo = 'VTAS' SELECT @ID = ID, @Periodicidad = Periodicidad, @FechaEmision = FechaEmision, @Vencimiento = Vencimiento, @ConVigencia = ConVigencia, @VigenciaDesde = VigenciaDesde, @VigenciaHasta = VigenciaHasta, @Estatus = Estatus FROM Venta WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus = 'RECURRENTE' 

  SELECT @FechaD = @Vencimiento
  EXEC spCalcularPeriodicidad @FechaD, @Periodicidad, @FechaA OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @Reversa = @Reversa

  IF @ConVigencia = 1 AND @FechaA > @VigenciaHasta 
     SELECT @Estatus = 'CONCLUIDO'

  IF @Modulo = 'GAS'  UPDATE Gasto SET FechaEmision = @FechaD, Vencimiento = @FechaA, Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'VTAS' UPDATE Venta SET FechaEmision = @FechaD, Vencimiento = @FechaA, Estatus = @Estatus WHERE ID = @ID 
  RETURN
END
GO

/*********** spAgregarCapas ***********/
if exists (select * from sysobjects where id = object_id('dbo.spAgregarCapas') and type = 'P') drop procedure dbo.spAgregarCapas
GO
CREATE PROCEDURE spAgregarCapas
		   @Sucursal		int,
		   @Sistema		char(1),
		   @Empresa		char(5), 
		   @Articulo		char(20), 
		   @SubCuenta		varchar(50),
		   @Fecha		datetime, 
		   @Cantidad		float, 
		   @Costo		float, 
		   @Modulo		char(5), 
		   @Mov			char(20), 
		   @MovID 		varchar(20),
		  
		   @Ok			int	OUTPUT,
		   
		   @Almacen		varchar(10)	= NULL,
		   @ID			int		= NULL,
		   @Renglon		float		= NULL,
		   @RenglonSub		int		= NULL,
           @OtraMoneda						varchar(10) = NULL, --MEJORA6230
           @OtraMonedaTipoCambio			float = NULL, --MEJORA6230
           @OtraMonedaTipoCambioVenta		float = NULL, --MEJORA6230
           @OtraMonedaTipoCambioCompra		float = NULL  --MEJORA6230		   
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @InvCapaID	int
    
  -- SET nocount ON
  UPDATE InvCapa
     SET @InvCapaID = ID,
         Existencia = Existencia + ISNULL(@Cantidad, 0.0)
   WHERE Sucursal = @Sucursal
     AND Sistema  = @Sistema
     AND Empresa  = @Empresa
     AND Articulo = @Articulo
     AND SubCuenta= @SubCuenta
     AND Modulo   = @Modulo
     AND Mov      = @Mov
     AND MovID    = @MovID
     AND Costo    = @Costo
     AND Existencia IS NOT NULL

   IF @@ROWCOUNT = 0
   BEGIN
     INSERT INTO InvCapa (Sucursal,  Sistema,  Empresa,  Articulo,  SubCuenta,  Fecha,  Existencia, Costo,  Modulo,  Mov,  MovID,  OtraMoneda,  OtraMonedaTipoCambio,  OtraMonedaTipoCambioVenta,  OtraMonedaTipoCambioCompra) --MEJORA6230
                 VALUES  (@Sucursal, @Sistema, @Empresa, @Articulo, @SubCuenta, @Fecha, @Cantidad,  @Costo, @Modulo, @Mov, @MovID, @OtraMoneda, @OtraMonedaTipoCambio, @OtraMonedaTipoCambioVenta, @OtraMonedaTipoCambioCompra) --MEJORA6230
     SELECT @InvCapaID = SCOPE_IDENTITY()
   END
   
   INSERT InvCapaAux (
   	   ID,         Fecha,  Modulo,  ModuloID, Renglon,  RenglonSub,  Almacen,  CargoU)
   VALUES (@InvCapaID, @Fecha, @Modulo, @ID,      @Renglon, @RenglonSub, @Almacen, @Cantidad)
   
  RETURN
END
GO

/************** spAlertaCtaDinero *************/
if exists (select * from sysobjects where id = object_id('dbo.spAlertaCtaDinero') and sysstat & 0xf = 4) drop procedure dbo.spAlertaCtaDinero
GO
CREATE PROCEDURE spAlertaCtaDinero
                   @Empresa     char(5),
		   @CtaDinero	char(10)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Ok		int,
    @Saldo	money,
    @Inferior	money,
    @Superior	money

  SELECT @Ok = NULL, @Inferior = NULL, @Superior = NULL
  SELECT @Inferior = AlertaLimiteInferior, @Superior = AlertaLimiteSuperior
    FROM CtaDinero
   WHERE CtaDinero = @CtaDinero AND Tipo = 'Caja' AND Alerta = 1

  SELECT @Saldo = SUM(s.Saldo*m.TipoCambio)
    FROM DineroSaldo s, Mon m
   WHERE s.Moneda = m.Moneda 
     AND s.Empresa = @Empresa AND s.CtaDinero = @CtaDinero

  IF @Inferior IS NOT NULL AND @Saldo < @Inferior SELECT @Ok = 21010 ELSE
  IF @Superior IS NOT NULL AND @Saldo > @Superior SELECT @Ok = 21020

  IF @Ok IS NOT NULL
    SELECT RTRIM(@CtaDinero)+': '+RTRIM(Descripcion) FROM MensajeLista WHERE Mensaje = @Ok
  ELSE
    SELECT "Descripcion" = NULL
  RETURN
END
GO
-- spAlertaCtaDinero 'DEMO', 'C1'

/**************** spAplicaOk ****************/
if exists (select * from sysobjects where id = object_id('dbo.spAplicaOk') and type = 'P') drop procedure dbo.spAplicaOk
GO
CREATE PROCEDURE spAplicaOk
			@Empresa	char(5),
			@Usuario	char(10),
			@Modulo		char(5),
			@IDAplica	int,
			@Ok		int		OUTPUT,
			@OkRef		varchar(255)	OUTPUT,
                        @Sucursal 	int	= NULL	OUTPUT 
--//WITH ENCRYPTION
AS BEGIN
  IF @IDAplica IS NULL OR (SELECT Sincro FROM Version) = 0 RETURN

  DECLARE
    @PuedeEditar	bit,
    @Mov		char(20),
    @MovID		varchar(20),
    @Estatus		char(15),
    @UEN		int

  /*SELECT @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Sucursal = Sucursal, @UEN = UEN
    FROM dbo.fnMovReg(@Modulo, @IDAplica)*/
  EXEC spMovInfo @IDAplica, @Modulo, @Mov OUTPUT, @MovID OUTPUT, @Estatus OUTPUT, @Sucursal OUTPUT, @UEN OUTPUT
  EXEC spPuedeEditarMovMatrizSucursal @Sucursal, @Sucursal, @IDAplica, @Modulo, @Empresa, @usuario, @Mov, @Estatus, 1, @PuedeEditar OUTPUT, 1
  IF @PuedeEditar = 0 
  BEGIN
    IF (SELECT Clave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov) <> 'INV.TI'
      SELECT @Ok = 60300, @OkRef = @Mov
  END
  RETURN
END
GO

/*********** spArtCosto ***********/
if exists (select * from sysobjects where id = object_id('dbo.spArtCosto') and type = 'P') drop procedure dbo.spArtCosto
GO
CREATE PROCEDURE spArtCosto
		   @Sucursal			int,
		   @Accion	     		char(20),
		   @Empresa          	char(5),
		   @Modulo           	char(5),
		   @AfectarCostos		bit,
		   @EsEntrada        	bit,
		   @EsSalida	     	bit,
		   @EsTransferencia  	bit,
		   @AfectarSerieLote	bit, 
		   @CfgFormaCosteo   	char(20),
		   @CfgTipoCosteo    	char(20),
		   @ArtTipo				char(20),
		   @Articulo	     	char(20),
		   @SubCuenta	     	varchar(50),
		   @Cantidad	     	float,
		   @Unidad				varchar(50),
		   @Factor	     		float,
		   @Costo	     		float,
		   @CostoSinGastos		float,
		   @Mov	             	char(20),
		   @MovID	     		varchar(20),
		   @MovTipo	     		char(20),
		   @AplicaMovTipo		char(20),
		   @Fecha            	datetime,
		   @MovMoneda	     	char(10),
		   @MovTipoCambio    	float,
		   @ID		     		int,
		   @RenglonID	     	int,
		   @Almacen				char(10),
		   @AlmacenTipo	     	char(20),
           @CostearNivelSubCuenta 	bit,
		   @CfgCosteoSeries		bit, 
		   @CfgCosteoLotes		bit,
           @CfgCosteoMultipleSimultaneo	bit,
		   @ArtCostoIdentificado	bit,
    	   @ArtCosto	     	float       	 OUTPUT,
		   @ArtAjusteCosteo		float		 OUTPUT,
		   @ArtCostoUEPS		float		 OUTPUT,
		   @ArtCostoPEPS		float		 OUTPUT,
		   @ArtUltimoCosto		float		 OUTPUT,
		   @ArtCostoEstandar	float		 OUTPUT,
		   @ArtCostoPromedio	float		 OUTPUT,
		   @ArtCostoReposicion	float		 OUTPUT,
		   @ArtPrecioLista		float		 OUTPUT,
		   @ArtMoneda        	char(10)	 OUTPUT,
   		   @ArtFactor        	float	 	 OUTPUT,
		   @ArtTipoCambio    	float	 	 OUTPUT,
		   @Ok               	int         	 OUTPUT,
		   @Renglon				float	= NULL,
		   @RenglonSub			int	= NULL,
		   @OtraMoneda						varchar(10) = NULL, --MEJORA6230
		   @OtraMonedaTipoCambio			float = NULL, --MEJORA6230
		   @OtraMonedaTipoCambioVenta		float = NULL, --MEJORA6230
		   @OtraMonedaTipoCambioCompra		float = NULL  --MEJORA6230    		   
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  IF @Ok IS NOT NULL RETURN
  DECLARE
    @Existencia			float,
    @ArtTipoCosteo      	varchar(10),
    @ArtSubCosto		float,
    @CostoSerieLote		float,
    @UltimoCosto     		float, 
    @CostoPromedio      	float,
    @CostoEstandar		float,
    @CostoReposicion		float,
    @ArtCostoSinGastos		float,
    @UltimoCostoSinGastos	float,
    @EsCompraConsignacion	bit

  -- Inicializar Variables
  IF @Factor = 0
	SET @Factor = NULL

  SELECT @ArtAjusteCosteo      = NULL,
		 @ArtCosto	       = 0.0,
		 @ArtSubCosto	       = 0.0,
		 @UltimoCosto          = 0.0, 
		 @UltimoCostoSinGastos = 0.0,
		 @CostoPromedio        = 0.0,
		 @CostoEstandar        = 0.0,
		 @CostoReposicion      = 0.0,
		 @CostoSerieLote       = NULL,
         @EsCompraConsignacion = 0,
         @Cantidad             = ISNULL(@Cantidad, 0.0) * ISNULL(@Factor, 1.0),
         @Costo				   = ISNULL(@Costo, 0.0) / ISNULL(@Factor, 1.0),		-- a proposito se divide 
         @CostoSinGastos       = ISNULL(@CostoSinGastos, 0.0) / ISNULL(@Factor, 1.0), 	-- a proposito se divide 
         @ArtAjusteCosteo      = @ArtCostoUEPS / ISNULL(@Factor, 1.0),			-- a proposito se divide 
         @ArtCostoUEPS	       = @ArtCostoUEPS / ISNULL(@Factor, 1.0),			-- a proposito se divide 
         @ArtCostoPEPS	       = @ArtCostoPEPS / ISNULL(@Factor, 1.0),			-- a proposito se divide 
         @ArtUltimoCosto       = @ArtUltimoCosto / ISNULL(@Factor, 1.0)			-- a proposito se divide 

  IF @CostearNivelSubCuenta = 0 SELECT @SubCuenta = ''
  IF @SubCuenta IS NULL SELECT @SubCuenta = ''
  IF @AplicaMovTipo = 'COMS.CC' AND @MovTipo IN ('COMS.F', 'COMS.FL', 'COMS.EG', 'COMS.EI') SELECT @EsCompraConsignacion = 1

  SELECT @ArtMoneda       = MonedaCosto,
         @ArtTipoCosteo   = UPPER(TipoCosteo),
         @CostoEstandar   = ISNULL(CostoEstandar, 0.0),
         @CostoReposicion = ISNULL(CostoReposicion, 0.0)
    FROM Art
   WHERE Articulo = @Articulo 
  IF @@ERROR <> 0 SELECT @Ok = 1

  -- Calcular MonedaFactor
  EXEC spMoneda NULL, @MovMoneda, @MovTipoCambio, @ArtMoneda, @ArtFactor OUTPUT, @ArtTipoCambio OUTPUT, @Ok OUTPUT

  IF @AlmacenTipo = 'ACTIVOS FIJOS' 
  BEGIN
    IF @EsEntrada = 1 SELECT @ArtCosto = @Costo / @ArtFactor ELSE	-- a proposito se divide 
    IF @EsSalida = 1 
      SELECT @ArtCosto = AVG(ISNULL(NULLIF(ValorRevaluado, 0.0), AdquisicionValor)-ISNULL(DepreciacionAcum, 0.0)) / @ArtFactor  -- a proposito se divide 
        FROM ActivoF
       WHERE Empresa = @Empresa 
         AND Articulo = @Articulo 
         AND Serie IN (SELECT SerieLote FROM SerieLoteMov WHERE /*Sucursal = @Sucursal AND */Empresa = @Empresa AND Modulo = @Modulo AND ID = @ID AND RenglonID = @RenglonID AND Articulo = @Articulo)
    RETURN
  END

  IF @CostearNivelSubCuenta = 1 
  BEGIN
    SELECT @CostoEstandar        = ISNULL(CostoEstandar, 0.0),
           @CostoReposicion      = ISNULL(CostoReposicion, 0.0)
      FROM ArtSub
     WHERE Articulo = @Articulo AND SubCuenta = @SubCuenta 
    SELECT @UltimoCosto	         = ISNULL(UltimoCosto, 0.0),
           @UltimoCostoSinGastos = ISNULL(UltimoCostoSinGastos, 0.0),
           @CostoPromedio        = ISNULL(CostoPromedio, 0.0)
      FROM ArtSubCosto
     WHERE Articulo = @Articulo AND SubCuenta = @SubCuenta AND Empresa = @Empresa AND Sucursal = @Sucursal     
  END ELSE
    SELECT @UltimoCosto	         = ISNULL(UltimoCosto, 0.0),
           @UltimoCostoSinGastos = ISNULL(UltimoCostoSinGastos, 0.0),
           @CostoPromedio        = ISNULL(CostoPromedio, 0.0)
      FROM ArtCosto
     WHERE Articulo = @Articulo AND Empresa = @Empresa AND Sucursal = @Sucursal
  IF @@ERROR <> 0 SELECT @Ok = 1

  IF @CfgFormaCosteo = 'ARTICULO'
    SELECT @CfgTipoCosteo = @ArtTipoCosteo

  IF UPPER(@CfgTipoCosteo) NOT IN ('PROMEDIO', 'ESTANDAR', 'REPOSICION', 'UEPS', 'PEPS') SELECT @Ok = 70080

  EXEC xpArtCosto @Empresa, @Sucursal, @Accion, @Modulo, @ID, @RenglonID, @Articulo, @SubCuenta, @CostoEstandar OUTPUT, @CostoPromedio OUTPUT, @CostoReposicion OUTPUT, @UltimoCosto OUTPUT, @UltimoCostoSinGastos OUTPUT, @Ok OUTPUT

  IF @EsEntrada = 1 
  BEGIN
    -- Esto es para Prestamos de Garantia
    IF @EsTransferencia = 1 AND ISNULL(@Costo, 0) = 0.0 SELECT @Costo = @CostoPromedio

    IF @MovMoneda <> @ArtMoneda AND @CfgFormaCosteo = 'ARTICULO' AND EXISTS (SELECT * FROM EmpresaCfgModulo where Empresa = @Empresa AND Modulo = @Modulo)
    BEGIN
      --Cuando: 
      -- 1.- El Costo esta en Dolares 
      -- 2.- Esta configurado las Opciones de Modulos para que el Tipo de Cambio sea el de General/Venta/Compra
      -- Debe tomar de la tabla de Moneda los campos TipoCambio/TipoCambioVenta/TipoCambioCompra  
      
      IF EXISTS (SELECT * FROM EmpresaCfgModulo where Empresa = @Empresa AND Modulo = @Modulo AND TipoCambio = 'General')     
        SELECT @ArtCosto          = @Costo          / @ArtFactor,	-- a proposito se divide 
               @ArtCostoSinGastos = @CostoSinGastos / @ArtFactor	-- a proposito se divide 
      ELSE
      IF EXISTS (SELECT * FROM EmpresaCfgModulo where Empresa = @Empresa AND Modulo = @Modulo AND TipoCambio = 'Compra')     
        SELECT @ArtCosto          = @Costo          / ISNULL(dbo.fnTipoCambioCompra(@ArtMoneda), @ArtFactor),	-- a proposito se divide 
               @ArtCostoSinGastos = @CostoSinGastos / ISNULL(dbo.fnTipoCambioCompra(@ArtMoneda), @ArtFactor)	-- a proposito se divide 
      ELSE
      IF EXISTS (SELECT * FROM EmpresaCfgModulo where Empresa = @Empresa AND Modulo = @Modulo AND TipoCambio = 'Venta')     
        SELECT @ArtCosto          = @Costo          / ISNULL(dbo.fnTipoCambioVenta(@ArtMoneda), @ArtFactor),	-- a proposito se divide 
               @ArtCostoSinGastos = @CostoSinGastos / ISNULL(dbo.fnTipoCambioVenta(@ArtMoneda), @ArtFactor)	-- a proposito se divide 

    END
    ELSE
      SELECT @ArtCosto          = @Costo          / @ArtFactor,	-- a proposito se divide 
             @ArtCostoSinGastos = @CostoSinGastos / @ArtFactor	-- a proposito se divide    

    IF @CfgTipoCosteo IN ('UEPS','PEPS') AND @EsCompraConsignacion = 0
      EXEC spAgregarCapas @Sucursal, 'G', @Empresa, @Articulo, @SubCuenta, @Fecha, @Cantidad, @ArtCosto, @Modulo, @Mov, @MovID, @Ok OUTPUT, @Almacen = @Almacen, @ID = @ID, @Renglon = @Renglon, @RenglonSub = @RenglonSub, @OtraMoneda = @OtraMoneda, @OtraMonedaTipoCambio = @OtraMonedaTipoCambio, @OtraMonedaTipoCambioVenta = @OtraMonedaTipoCambioVenta, @OtraMonedaTipoCambioCompra = @OtraMonedaTipoCambioCompra --MEJORA6230


    -- Cuando Cancela, Cancela a mismo costo que se genero previamente
    IF @Accion <> 'CANCELAR'
      SELECT @ArtCostoUEPS = @ArtCosto, @ArtCostoPEPS = @ArtCosto

    IF @CfgCosteoMultipleSimultaneo = 1 AND @EsCompraConsignacion = 0
    BEGIN
      EXEC spAgregarCapas @Sucursal, 'U', @Empresa, @Articulo, @SubCuenta, @Fecha, @Cantidad, @ArtCostoUEPS, @Modulo, @Mov, @MovID, @Ok OUTPUT, @Almacen = @Almacen, @ID = @ID, @Renglon = @Renglon, @RenglonSub = @RenglonSub, @OtraMoneda = @OtraMoneda, @OtraMonedaTipoCambio = @OtraMonedaTipoCambio, @OtraMonedaTipoCambioVenta = @OtraMonedaTipoCambioVenta, @OtraMonedaTipoCambioCompra = @OtraMonedaTipoCambioCompra --MEJORA6230
      EXEC spAgregarCapas @Sucursal, 'P', @Empresa, @Articulo, @SubCuenta, @Fecha, @Cantidad, @ArtCostoPEPS, @Modulo, @Mov, @MovID, @Ok OUTPUT, @Almacen = @Almacen, @ID = @ID, @Renglon = @Renglon, @RenglonSub = @RenglonSub, @OtraMoneda = @OtraMoneda, @OtraMonedaTipoCambio = @OtraMonedaTipoCambio, @OtraMonedaTipoCambioVenta = @OtraMonedaTipoCambioVenta, @OtraMonedaTipoCambioCompra = @OtraMonedaTipoCambioCompra --MEJORA6230
    END

    IF @Accion <> 'CANCELAR' AND @MovTipo IN ('COMS.F','COMS.FL','COMS.EG','COMS.EI','INV.E','INV.EP','INV.EI','PROD.E') 
      SELECT @UltimoCosto = @ArtCosto, @UltimoCostoSinGastos = @ArtCostoSinGastos

    /* Para que cuando cancele la factura borre SalidaID */
    IF @ArtTipo = 'VIN' AND @Accion = 'CANCELAR'
      UPDATE VINCostoExtra SET SalidaID = NULL WHERE Empresa = @Empresa AND VIN IN (SELECT SerieLote FROM SerieLoteMov WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID = @ID AND RenglonID = @RenglonID AND Articulo = @Articulo AND SubCuenta = ISNULL(@SubCuenta, ''))
  END -- EsEntrada

  ELSE
  IF @EsSalida = 1
  BEGIN 
    IF @Accion = 'CANCELAR' OR (@MovTipo IN ('COMS.D', 'INV.A') AND @Costo <> 0.0)
    BEGIN
      SELECT @ArtCosto = @Costo / @ArtFactor	-- a proposito se divide 
      IF @CfgTipoCosteo IN ('UEPS','PEPS') 
        EXEC spModificarCapas @Sucursal, @Accion, @Modulo, @MovTipo, @Mov, @MovID, @Fecha, @CfgTipoCosteo, 'G', @Empresa, @Articulo, @SubCuenta, @Cantidad, 0, @ArtCosto OUTPUT, @Ok OUTPUT, @CostoEspecifico = 1, @AjusteCosteo = @ArtAjusteCosteo OUTPUT, @Almacen = @Almacen, @ID = @ID, @Renglon = @Renglon, @RenglonSub = @RenglonSub
    END ELSE 
    BEGIN
     IF @CfgTipoCosteo = 'PROMEDIO'   SELECT @ArtCosto = @CostoPromedio   ELSE
     IF @CfgTipoCosteo = 'ESTANDAR'   SELECT @ArtCosto = @CostoEstandar   ELSE
     IF @CfgTipoCosteo = 'REPOSICION' SELECT @ArtCosto = @CostoReposicion ELSE
     IF @CfgTipoCosteo IN ('UEPS','PEPS') AND @EsCompraConsignacion = 0
       EXEC spModificarCapas @Sucursal, @Accion, @Modulo, @MovTipo, @Mov, @MovID, @Fecha, @CfgTipoCosteo, 'G', @Empresa, @Articulo, @SubCuenta, @Cantidad, 0, @ArtCosto OUTPUT, @Ok OUTPUT, @Almacen = @Almacen, @ID = @ID, @Renglon = @Renglon, @RenglonSub = @RenglonSub
    END

    IF @CfgCosteoMultipleSimultaneo = 1 AND @EsCompraConsignacion = 0
    BEGIN
      SELECT @ArtCostoUEPS = @ArtCosto, @ArtCostoPEPS = @ArtCosto
      EXEC spModificarCapas @Sucursal, @Accion, @Modulo, @MovTipo, @Mov, @MovID, @Fecha, 'UEPS', 'U', @Empresa, @Articulo, @SubCuenta, @Cantidad, 0, @ArtCostoUEPS OUTPUT, @Ok OUTPUT, @Almacen = @Almacen, @ID = @ID, @Renglon = @Renglon, @RenglonSub = @RenglonSub
      EXEC spModificarCapas @Sucursal, @Accion, @Modulo, @MovTipo, @Mov, @MovID, @Fecha, 'PEPS', 'P', @Empresa, @Articulo, @SubCuenta, @Cantidad, 0, @ArtCostoPEPS OUTPUT, @Ok OUTPUT, @Almacen = @Almacen, @ID = @ID, @Renglon = @Renglon, @RenglonSub = @RenglonSub
    END
  END 

  IF @EsTransferencia = 1 AND @AfectarCostos = 0 
  BEGIN
    IF @CfgTipoCosteo = 'ESTANDAR'   SELECT @ArtCosto = @CostoEstandar ELSE
    IF @CfgTipoCosteo = 'REPOSICION' SELECT @ArtCosto = @CostoReposicion 
    ELSE SELECT @ArtCosto = @CostoPromedio
  END

  IF /*@AfectarSerieLote = 1 AND */(@EsSalida = 1 OR (@EsTransferencia = 1 AND @AfectarCostos = 0)) AND @Accion <> 'CANCELAR'
    IF (@ArtTipo IN ('LOTE', 'PARTIDA') AND (@CfgCosteoLotes = 1 OR @ArtCostoIdentificado = 1)) OR 
       (@ArtTipo IN ('SERIE', 'VIN')    AND (@CfgCosteoSeries = 1 OR @ArtCostoIdentificado = 1))      
    BEGIN
      SELECT @CostoSerieLote = 0.0
      SELECT @CostoSerieLote = ISNULL(SUM(m.Cantidad*ISNULL(s.CostoPromedio, 0.0))/NULLIF(SUM(m.Cantidad), 0.0), 0.0)
        FROM SerieLoteMov m, SerieLote s 
        WHERE m.Empresa = @Empresa AND m.Modulo = @Modulo AND m.ID = @ID AND m.RenglonID = @RenglonID AND m.Articulo = @Articulo AND m.SubCuenta = ISNULL(@SubCuenta, '')
          AND s.Empresa = @Empresa AND s.Articulo = @Articulo AND s.SubCuenta = ISNULL(@SubCuenta, '') AND s.SerieLote = m.SerieLote AND s.Sucursal = @Sucursal AND s.Almacen = @Almacen AND m.Tarima = s.Tarima

      IF @ArtTipo = 'VIN'
      BEGIN
/*        SELECT @CostoSerieLote = @CostoSerieLote + ISNULL(SUM(m.Cantidad*ISNULL(s.CostoExtra, 0.0))/NULLIF(SUM(m.Cantidad), 0.0), 0.0)
          FROM SerieLoteMov m, VINCostoExtraEmpresaSinSalida s 
          WHERE m.Empresa = @Empresa AND m.Modulo = @Modulo AND m.ID = @ID AND m.RenglonID = @RenglonID AND m.Articulo = @Articulo AND m.SubCuenta = ISNULL(@SubCuenta, '')
            AND s.Empresa = @Empresa AND s.VIN = m.SerieLote
        IF ISNULL(@CostoSerieLote, 0.0) < 0.0 SELECT @Ok = 20101
*/
        UPDATE VINCostoExtra SET SalidaID = @ID WHERE Empresa = @Empresa AND VIN IN (SELECT SerieLote FROM SerieLoteMov WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID = @ID AND RenglonID = @RenglonID AND Articulo = @Articulo AND SubCuenta = ISNULL(@SubCuenta, ''))
      END

      IF @CostoSerieLote <> 0.0 SELECT @ArtCosto = @CostoSerieLote
  END

  IF @MovTipo IN ('COMS.B', 'COMS.CA', 'COMS.GX')
  BEGIN
    SELECT @ArtCosto = @Costo / @ArtFactor	-- a proposito se divide 
    IF @CfgTipoCosteo IN ('UEPS','PEPS') AND @EsCompraConsignacion = 0
      EXEC spModificarCapas @Sucursal, @Accion, @Modulo, @MovTipo, @Mov, @MovID, @Fecha, @CfgTipoCosteo, 'G', @Empresa, @Articulo, @SubCuenta, @Cantidad, 0, @ArtCosto, @Ok OUTPUT,
			    @CostoEspecifico = 1, @AjusteCosteo = @ArtAjusteCosteo OUTPUT, @Almacen = @Almacen, @ID = @ID, @Renglon = @Renglon, @RenglonSub = @RenglonSub

    IF @CfgCosteoMultipleSimultaneo = 1 AND @EsCompraConsignacion = 0
    BEGIN
      SELECT @ArtCostoUEPS = @ArtCosto, @ArtCostoPEPS = @ArtCosto
      EXEC spModificarCapas @Sucursal, @Accion, @Modulo, @MovTipo, @Mov, @MovID, @Fecha, 'UEPS', 'U', @Empresa, @Articulo, @SubCuenta, @Cantidad, 0, @ArtCostoUEPS, @Ok OUTPUT, @Almacen = @Almacen, @ID = @ID, @Renglon = @Renglon, @RenglonSub = @RenglonSub/*,
			    @CostoEspecifico = 1, @AjusteCosteo = @ArtAjusteCosteo OUTPUT*/
      EXEC spModificarCapas @Sucursal, @Accion, @Modulo, @MovTipo, @Mov, @MovID, @Fecha, 'PEPS', 'P', @Empresa, @Articulo, @SubCuenta, @Cantidad, 0, @ArtCostoPEPS, @Ok OUTPUT, @Almacen = @Almacen, @ID = @ID, @Renglon = @Renglon, @RenglonSub = @RenglonSub/*, 
			    @CostoEspecifico = 1, @AjusteCosteo = @ArtAjusteCosteo OUTPUT*/
    END

    IF @Ok IS NULL
      EXEC spExistenciaSucursal @Sucursal, @Empresa, @Articulo, @SubCuenta, @CostearNivelSubCuenta, @Existencia OUTPUT
      EXEC spBonificarCostoPromedio @Existencia, @Accion, @MovTipo, @Cantidad, @ArtCosto, @CostoPromedio OUTPUT
  END 
  ELSE
  -- Transferencia Costo
  IF @AfectarCostos = 1 AND @EsTransferencia = 1 AND @EsEntrada = 0 AND @EsSalida = 0
  BEGIN
    SELECT @ArtCosto = @Costo / @ArtFactor		-- a proposito se divide 
    IF @CfgTipoCosteo IN ('UEPS','PEPS') AND @EsCompraConsignacion = 0
      EXEC spModificarCapas @Sucursal, @Accion, @Modulo, @MovTipo, @Mov, @MovID, @Fecha, @CfgTipoCosteo, 'G', @Empresa, @Articulo, @SubCuenta, @Cantidad, 1, @ArtCosto OUTPUT, @Ok OUTPUT, @Almacen = @Almacen, @ID = @ID, @Renglon = @Renglon, @RenglonSub = @RenglonSub

    IF @CfgCosteoMultipleSimultaneo = 1 AND @EsCompraConsignacion = 0
    BEGIN
      SELECT @ArtCostoUEPS = @ArtCosto, @ArtCostoPEPS = @ArtCosto
      EXEC spModificarCapas @Sucursal, @Accion, @Modulo, @MovTipo, @Mov, @MovID, @Fecha, 'UEPS', 'U', @Empresa, @Articulo, @SubCuenta, @Cantidad, 1, @ArtCostoUEPS OUTPUT, @Ok OUTPUT, @Almacen = @Almacen, @ID = @ID, @Renglon = @Renglon, @RenglonSub = @RenglonSub
      EXEC spModificarCapas @Sucursal, @Accion, @Modulo, @MovTipo, @Mov, @MovID, @Fecha, 'PEPS', 'P', @Empresa, @Articulo, @SubCuenta, @Cantidad, 1, @ArtCostoPEPS OUTPUT, @Ok OUTPUT, @Almacen = @Almacen, @ID = @ID, @Renglon = @Renglon, @RenglonSub = @RenglonSub
    END

    EXEC spExistenciaSucursal @Sucursal, @Empresa, @Articulo, @SubCuenta, @CostearNivelSubCuenta, @Existencia OUTPUT
    EXEC spCalcCostoPromedio @Existencia, 1, @Cantidad, @ArtCosto, @CostoPromedio OUTPUT
  END  -- EsTransferencia


  -- Afectar Costos Promedios "SIEMPRE"
  IF (@EsEntrada = 1 OR @EsSalida = 1 OR @MovTipo = 'COMS.CC') AND @EsTransferencia = 0 AND @MovTipo NOT IN ('COMS.B', 'COMS.CA', 'COMS.GX') AND @Ok IS NULL
  BEGIN
    EXEC spExistenciaSucursal @Sucursal, @Empresa, @Articulo, @SubCuenta, @CostearNivelSubCuenta, @Existencia OUTPUT
    EXEC spCalcCostoPromedio @Existencia, @EsEntrada, @Cantidad, @ArtCosto, @CostoPromedio OUTPUT
  END

  IF @AfectarCostos = 1 --OR (@MovTipo = 'COMS.CC' AND @Existencia = 0.0) ** Esto no es necesario porque ya se hizo el spChecarConsignacion
  BEGIN
    IF @CostearNivelSubCuenta = 1
    BEGIN
      UPDATE ArtSubCosto
         SET UltimoCosto          = @UltimoCosto, 
             UltimoCostoSinGastos = @UltimoCostoSinGastos,
             CostoPromedio        = @CostoPromedio
       WHERE Articulo = @Articulo AND SubCuenta = @SubCuenta AND Empresa = @Empresa AND Sucursal = @Sucursal

      IF @@ROWCOUNT = 0
        INSERT ArtSubCosto (Sucursal,  Empresa,  Articulo,  SubCuenta,  UltimoCosto,  UltimoCostoSinGastos,  CostoPromedio) 
                    VALUES (@Sucursal, @Empresa, @Articulo, @SubCuenta, @UltimoCosto, @UltimoCostoSinGastos, @CostoPromedio)
    END ELSE
    BEGIN
      UPDATE ArtCosto
         SET UltimoCosto          = @UltimoCosto, 
             UltimoCostoSinGastos = @UltimoCostoSinGastos,
             CostoPromedio        = @CostoPromedio
       WHERE Articulo = @Articulo AND Empresa = @Empresa AND Sucursal = @Sucursal

      IF @@ROWCOUNT = 0
        INSERT ArtCosto (Sucursal,  Empresa,  Articulo,  UltimoCosto,  UltimoCostoSinGastos,  CostoPromedio) 
                 VALUES (@Sucursal, @Empresa, @Articulo, @UltimoCosto, @UltimoCostoSinGastos, @CostoPromedio)
    END
    IF @@ERROR <> 0 SELECT @Ok = 1
  END

  SELECT @ArtCosto            = @ArtCosto        * @Factor,
         @ArtAjusteCosteo     = @ArtAjusteCosteo * @Factor,
         @ArtCostoUEPS        = @ArtCostoUEPS    * @Factor, 
         @ArtCostoPEPS        = @ArtCostoPEPS    * @Factor,
         @ArtUltimoCosto      = @UltimoCosto     * @Factor,
	 @ArtCostoEstandar    = @CostoEstandar   * @Factor,
	 @ArtCostoPromedio    = @CostoPromedio   * @Factor,
	 @ArtCostoReposicion  = @CostoEstandar   * @Factor



  SELECT @ArtPrecioLista = dbo.fnPrecioSucursal(@Empresa, @Sucursal, @MovMoneda, @MovTipoCambio, @Articulo, @SubCuenta, @Unidad)
  RETURN
END
GO

/************** spArtDisponible ***************/
if exists (select * from sysobjects where id = object_id('dbo.spArtDisponible') and type = 'P') drop procedure dbo.spArtDisponible
GO
CREATE PROCEDURE spArtDisponible
	           @Empresa		char(5),
	           @Almacen		char(10),
	           @Articulo		char(20),
		   @Consignacion 	bit,
		   @AlmacenTipo		char(20),
		   @Factor		float,

		   @Disponible		float   OUTPUT,
		   @Ok			int	OUTPUT,
		   @Tarima		varchar(20) = NULL
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  SELECT @Disponible = NULL, @Tarima = ISNULL(dbo.fnAlmacenTarima(@Almacen, @Tarima), '')

  IF @AlmacenTipo = 'ACTIVOS FIJOS' AND @Consignacion = 0
    SELECT @Disponible = Disponible 
      FROM ActivoFDisponible 
     WHERE Empresa = @Empresa 
       AND Almacen = @Almacen 
       AND Articulo = @Articulo
  ELSE
  IF @Consignacion = 1
    SELECT @Disponible = Consignacion 
      FROM ArtConsignacion 
     WHERE Empresa = @Empresa 
       AND Almacen = @Almacen 
       AND Articulo = @Articulo
  ELSE
  IF @Tarima <> ''
    SELECT @Disponible = Disponible 
      FROM ArtDisponibleTarima 
     WHERE Empresa = @Empresa 
       AND Almacen = @Almacen 
       AND Tarima = @Tarima
       AND Articulo = @Articulo
  ELSE
    SELECT @Disponible = Disponible 
      FROM ArtDisponible 
     WHERE Empresa = @Empresa 
       AND Almacen = @Almacen 
       AND Articulo = @Articulo

  IF @@ERROR <> 0 SELECT @Ok = 1
  SELECT @Disponible = ISNULL(@Disponible, 0.0) / ISNULL(@Factor, 1.0)  -- a proposito se divide por el factor

  RETURN
END
GO

/************** spArtSubDisponible ***************/
if exists (select * from sysobjects where id = object_id('dbo.spArtSubDisponible') and type = 'P') drop procedure dbo.spArtSubDisponible
GO
CREATE PROCEDURE spArtSubDisponible
	           @Empresa		char(5),
	           @Almacen		char(10),
	           @Articulo		char(20),
		   @ArtTipo		char(20),
	           @SubCuenta		varchar(50),
		   @Consignacion 	bit,
		   @AlmacenTipo		char(20),
		   @Factor		float,

		   @Disponible		float 	OUTPUT,
		   @Ok			int	OUTPUT,
		   @Tarima		varchar(20) = NULL
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  SELECT @Disponible = NULL, @SubCuenta = ISNULL(RTRIM(@SubCuenta), ''), @Tarima = ISNULL(dbo.fnAlmacenTarima(@Almacen, @Tarima), '')

  IF @AlmacenTipo = 'ACTIVOS FIJOS' AND @Consignacion = 0
    SELECT @Disponible = Disponible
      FROM ActivoFSubDisponible
     WHERE Empresa   = @Empresa 
       AND Almacen   = @Almacen 
       AND Articulo  = @Articulo 
       AND SubCuenta = @SubCuenta
  ELSE
  IF @Consignacion = 1
    SELECT @Disponible = Consignacion
      FROM ArtSubConsignacion
     WHERE Empresa   = @Empresa 
       AND Almacen   = @Almacen 
       AND Articulo  = @Articulo 
       AND SubCuenta = @SubCuenta
  ELSE 
  IF @Tarima <> ''
    SELECT @Disponible = Disponible
      FROM ArtSubDisponibleTarima
     WHERE Empresa   = @Empresa 
       AND Almacen   = @Almacen 
       AND Tarima    = @Tarima
       AND Articulo  = @Articulo 
       AND SubCuenta = @SubCuenta
  ELSE
    SELECT @Disponible = Disponible
      FROM ArtSubDisponible
     WHERE Empresa   = @Empresa 
       AND Almacen   = @Almacen 
       AND Articulo  = @Articulo 
       AND SubCuenta = @SubCuenta

  IF @@ERROR <> 0 SELECT @Ok = 1
  SELECT @Disponible = ISNULL(@Disponible, 0.0) / ISNULL(@Factor, 1.0)  -- a proposito se divide por el factor

  RETURN
END
GO

/************** spArtUlt *************/
if exists (select * from sysobjects where id = object_id('dbo.spArtUlt') and sysstat & 0xf = 4) drop procedure dbo.spArtUlt
GO
CREATE PROCEDURE spArtUlt
			@Articulo	char(20),
			@Fecha		datetime,
		   	@Modulo		char(5),
			@MovTipo	varchar(20),
			@ID		int
--//WITH ENCRYPTION
AS BEGIN
  IF @Modulo = 'VTAS'
  BEGIN
    UPDATE ArtUlt WITH (ROWLOCK) SET UltimaVenta = @Fecha WHERE Articulo = @Articulo AND UltimaVenta <> @Fecha
    IF NOT EXISTS(SELECT * FROM ArtUlt WHERE Articulo = @Articulo AND UltimaVenta = @Fecha)
      INSERT ArtUlt (Articulo, UltimaVenta) VALUES (@Articulo, @Fecha)
  END ELSE
  IF @Modulo = 'COMS'
  BEGIN
    UPDATE ArtUlt WITH (ROWLOCK) SET UltimaCompra = @Fecha WHERE Articulo = @Articulo AND UltimaCompra <> @Fecha
    IF NOT EXISTS(SELECT * FROM ArtUlt WHERE Articulo = @Articulo AND UltimaCompra = @Fecha)
      INSERT ArtUlt (Articulo, UltimaCompra) VALUES (@Articulo, @Fecha)
  END
  EXEC xpArtUlt @Articulo, @Fecha, @Modulo, @MovTipo, @ID
  RETURN
END
GO

/**************** spAsignarSucursalEstatusRelacionadas ****************/
if exists (select * from sysobjects where id = object_id('dbo.spAsignarSucursalEstatusRelacionadas') and type = 'P') drop procedure dbo.spAsignarSucursalEstatusRelacionadas
GO
CREATE PROCEDURE spAsignarSucursalEstatusRelacionadas
                        @ID		int,
			@Modulo		char(5),
			@Sucursal	int
--//WITH ENCRYPTION
AS BEGIN
  IF @Modulo = 'CONT'  UPDATE ContD       SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'VTAS'  UPDATE VentaD      SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'PROD'  UPDATE ProdD       SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'INV'   UPDATE InvD        SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'COMS'  UPDATE CompraD     SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'CXC'   UPDATE CxcD        SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'CXP'   UPDATE CxpD        SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'AGENT' UPDATE AgentD      SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'GAS'   UPDATE GastoD      SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'DIN'   UPDATE DineroD     SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'AF'    UPDATE ActivoFijoD SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'PC'    UPDATE PCD         SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'OFER'  UPDATE OfertaD     SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'VALE'  UPDATE ValeD       SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'CR'
  BEGIN
    UPDATE CRVenta  SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE CRAgente SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE CRCobro  SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE CRCaja   SET Sucursal = @Sucursal WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'NOM'   UPDATE NominaD       SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'RH'    UPDATE RHD           SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'ASIS'  UPDATE AsisteD       SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'EMB'   UPDATE EmbarqueD     SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'CAM'   UPDATE CambioD       SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'CAP'   UPDATE CapitalD      SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'INC'   UPDATE IncidenciaD   SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'CONC'  UPDATE ConciliacionD SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'PPTO'  UPDATE PresupD 	    SET Sucursal = @Sucursal WHERE ID = @ID ELSE
--  IF @Modulo = 'CREDI'  UPDATE CreditoD    SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'TMA'   UPDATE TMAD          SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'RSS'   UPDATE RSSD          SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'CMP'   UPDATE CampanaD      SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'FIS'   UPDATE FiscalD       SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'FRM'   UPDATE FormaExtraD   SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'CAPT'  UPDATE CapturaD      SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'GES'
  BEGIN
    UPDATE GestionPara    SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE GestionRecurso SET Sucursal = @Sucursal WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'CP'
  BEGIN
    UPDATE CPD   SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE CPCal SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE CPEsp SET Sucursal = @Sucursal WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'PCP'  UPDATE PCPD      SET Sucursal = @Sucursal WHERE ID = @ID ELSE          
  IF @Modulo = 'PROY'
  BEGIN
    UPDATE ProyectoDia	    SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE ProyectoD	    SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE ProyectoDRecurso SET Sucursal = @Sucursal WHERE ID = @ID 
  END ELSE
--  IF @Modulo = 'ACT'   UPDATE ActD        SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'ST'    UPDATE SoporteD      SET Sucursal = @Sucursal WHERE ID = @ID 

  -- Otras Tablas Relacionadas con el Modulo
  IF @Modulo = 'VTAS'
  BEGIN
    UPDATE ServicioAccesorios SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE ServicioTarea      SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE VentaCobro         SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE VentaDLogPicos     SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE VentaOrigen        SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE VentaOtros         SET Sucursal = @Sucursal WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'COMS' 
  BEGIN
    UPDATE CompraGastoDiverso  SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE CompraGastoDiversoD SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE CompraDProrrateo    SET Sucursal = @Sucursal WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'INV' 
  BEGIN
    UPDATE InvGastoDiverso  SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE InvGastoDiversoD SET Sucursal = @Sucursal WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'GAS'
  BEGIN
    UPDATE GastoDProrrateo SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE GastoAplica     SET Sucursal = @Sucursal WHERE ID = @ID 
  END ELSE
  --IF @Modulo = 'MEX01' UPDATE ModuloExtra01D SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX02' UPDATE ModuloExtra02D SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX03' UPDATE ModuloExtra03D SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX04' UPDATE ModuloExtra04D SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX05' UPDATE ModuloExtra05D SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX06' UPDATE ModuloExtra06D SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX07' UPDATE ModuloExtra07D SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX08' UPDATE ModuloExtra08D SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX09' UPDATE ModuloExtra09D SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'ORG'   UPDATE OrganizaD SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'RE'
  BEGIN
    UPDATE ReclutaD			SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE ReclutaPlaza			SET Sucursal = @Sucursal WHERE ID = @ID 
    UPDATE ReclutaCometenciaTipo	SET Sucursal = @Sucursal WHERE ID = @ID 
  END ELSE    
  IF @Modulo = 'ISL'   UPDATE ISLD	SET Sucursal = @Sucursal WHERE ID = @ID ELSE

  IF @Modulo = 'CXC' UPDATE CxcAplicaDif SET Sucursal = @Sucursal WHERE ID = @ID ELSE
  IF @Modulo = 'CXP' UPDATE CxpAplicaDif SET Sucursal = @Sucursal WHERE ID = @ID 

  
  RETURN
END
GO

/**************** spAsignarSucursalEstatusEncabezado ****************/
if exists (select * from sysobjects where id = object_id('dbo.spAsignarSucursalEstatusEncabezado') and type = 'P') drop procedure dbo.spAsignarSucursalEstatusEncabezado
GO
CREATE PROCEDURE spAsignarSucursalEstatusEncabezado
                        @ID		int,
			@Modulo		char(5),
			@Sucursal	int,
			@Estatus	char(15),
			@MovID		varchar(20) = NULL
--//WITH ENCRYPTION
AS BEGIN
  IF @Modulo = 'CONT'  UPDATE Cont         SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'VTAS'  UPDATE Venta        SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'PROD'  UPDATE Prod         SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'INV'   UPDATE Inv          SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'COMS'  UPDATE Compra       SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'CXC'   UPDATE Cxc          SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'CXP'   UPDATE Cxp          SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'AGENT' UPDATE Agent        SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'GAS'   UPDATE Gasto        SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'DIN'   UPDATE Dinero       SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'AF'    UPDATE ActivoFijo   SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'PC'    UPDATE PC           SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'OFER'  UPDATE Oferta       SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'VALE'  UPDATE Vale         SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'CR'    UPDATE CR           SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'NOM'   UPDATE Nomina       SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'RH'    UPDATE RH           SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'ASIS'  UPDATE Asiste       SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'EMB'   UPDATE Embarque     SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'ST'    UPDATE Soporte      SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'CAP'   UPDATE Capital      SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'INC'   UPDATE Incidencia   SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'CONC'  UPDATE Conciliacion SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'PPTO'  UPDATE Presup       SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'CREDI' UPDATE Credito      SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'TMA'   UPDATE TMA          SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'RSS'   UPDATE RSS          SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'CMP'   UPDATE Campana      SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'FIS'   UPDATE Fiscal       SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  --REQ25014
  IF @Modulo = 'CONTP' UPDATE ContParalela SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE    
  --REQ16092
  IF @Modulo = 'OPORT' UPDATE Oportunidad  SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE  
  IF @Modulo = 'CORTE' UPDATE Corte        SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'FRM'   UPDATE FormaExtra   SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'CAPT'  UPDATE Captura      SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'GES'   UPDATE Gestion      SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'CP'    UPDATE CP           SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'PCP'   UPDATE PCP          SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE  
  IF @Modulo = 'PROY'  UPDATE Proyecto     SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  --IF @Modulo = 'ACT'   UPDATE Act           SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX01' UPDATE ModuloExtra01 SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX02' UPDATE ModuloExtra02 SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX03' UPDATE ModuloExtra03 SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX04' UPDATE ModuloExtra04 SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX05' UPDATE ModuloExtra05 SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX06' UPDATE ModuloExtra06 SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX07' UPDATE ModuloExtra07 SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX08' UPDATE ModuloExtra08 SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX09' UPDATE ModuloExtra09 SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'ORG'   UPDATE Organiza	   SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'RE'    UPDATE Recluta	   SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'ISL'   UPDATE ISL          SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'CAM'   UPDATE Cambio       SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'PACTO' UPDATE Contrato     SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID ELSE
  IF @Modulo = 'SAUX'  UPDATE SAUX		   SET Sucursal = ISNULL(@Sucursal, Sucursal), Estatus = ISNULL(@Estatus, Estatus), MovID = ISNULL(@MovID, MovID) WHERE ID = @ID 
  RETURN
END
GO

/**************** spAsignarSucursalEstatus ****************/
if exists (select * from sysobjects where id = object_id('dbo.spAsignarSucursalEstatus') and type = 'P') drop procedure dbo.spAsignarSucursalEstatus
GO
CREATE PROCEDURE spAsignarSucursalEstatus
                        @ID		int,
			@Modulo		char(5),
			@Sucursal	int,
			@Estatus	char(15)
--//WITH ENCRYPTION
AS BEGIN
  EXEC spAsignarSucursalEstatusEncabezado @ID, @Modulo, @Sucursal, @Estatus
  EXEC spAsignarSucursalEstatusRelacionadas @ID, @Modulo, @Sucursal
  RETURN
END
GO

/**************** spAutoSeriesLotes ****************/
if exists (select * from sysobjects where id = object_id('dbo.spAutoSeriesLotes') and type = 'P') drop procedure dbo.spAutoSeriesLotes
GO              
/*
CREATE PROCEDURE spAutoSeriesLotes
	           @Empresa			char(5),
                   @Modulo                      char(5),
                   @EstatusNuevo                char(15),

                   @ID  			int, 
	           @Renglon			float, 
                   @Almacen			char(10),
                   @Articulo                    char(20),
                   @Cantidad			float,

    		   @CfgSeriesLotesAutoCampo	char(20),
    		   @CfgSeriesLotesAutoOrden	char(20),

                   @Ok 				int		OUTPUT, 
                   @OkRef 			varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @DetalleID          int,   -- para que no imprima el FETCH NEXT
    @Contador		int,
    @RenglonInicial     int,
    @CuantosRenglones	int,
    @SubCuenta 		varchar(50),
    @Disponible		float,
    @Requiere		float,
    @Obtenido		float,
    @RenglonSub		int,
    @Suma		float,
    @RenRenglonSub	int,
    @RenSubCuenta 	varchar(50),
    @RenCantidad	float,
    @CantidadPendiente  float

  CREATE TABLE #Ren(
    ID                  int             NOT NULL IDENTITY(1,1),
    RenglonSub		int		NULL,
    SubCuenta		varchar(50)  	NULL,
    Cantidad		float	     	NULL,

    CONSTRAINT priRen PRIMARY KEY CLUSTERED (ID)
  )
  IF @@ERROR <> 0 SELECT @Ok = 1

  IF @CfgSeriesLotesAutoCampo = 'NUMERO' 
  BEGIN
    IF @CfgSeriesLotesAutoOrden = 'DESCENDENTE' DECLARE crAutoSeriesLotesRen CURSOR FOR SELECT NULLIF(RTRIM(SubCuenta), ''), ISNULL(Disponible, 0.0) FROM ArtSubDisponible WHERE Empresa = @Empresa AND Articulo = @Articulo AND Almacen = @Almacen ORDER BY SubCuenta DESC 
                                           ELSE DECLARE crAutoSeriesLotesRen CURSOR FOR SELECT NULLIF(RTRIM(SubCuenta), ''), ISNULL(Disponible, 0.0) FROM ArtSubDisponible WHERE Empresa = @Empresa AND Articulo = @Articulo AND Almacen = @Almacen ORDER BY SubCuenta ASC
  END ELSE 
   SELECT @Ok = 70010, @OkRef = @CfgSeriesLotesAutoCampo

  -- Inicializar Variables
  IF @Modulo = 'VTAS' SELECT @RenglonInicial = MAX(RenglonSub) FROM VentaD  WHERE ID = @ID AND Renglon = @Renglon ELSE
  IF @Modulo = 'PROD' SELECT @RenglonInicial = MAX(RenglonSub) FROM ProdD   WHERE ID = @ID AND Renglon = @Renglon ELSE
  IF @Modulo = 'COMS' SELECT @RenglonInicial = MAX(RenglonSub) FROM CompraD WHERE ID = @ID AND Renglon = @Renglon ELSE
  IF @Modulo = 'INV'  SELECT @RenglonInicial = MAX(RenglonSub) FROM InvD    WHERE ID = @ID AND Renglon = @Renglon
  IF @@ERROR <> 0 SELECT @Ok = 1

  SELECT @Suma = 0.0, @RenglonSub = @RenglonInicial

  OPEN crAutoSeriesLotesRen
  FETCH NEXT FROM crAutoSeriesLotesRen INTO @SubCuenta, @Disponible
  IF @@ERROR <> 0 SELECT @Ok = 1
  WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL 
  BEGIN   
    IF @@FETCH_STATUS <> -2 AND @SubCuenta IS NOT NULL AND @Disponible > 0.0
    BEGIN

      SELECT @Requiere = @Cantidad - @Suma
      IF @Requiere < @Disponible         
        SELECT @Obtenido = @Requiere	-- Si Alcanza
      ELSE        
        SELECT @Obtenido = @Disponible	-- No Alcanza

      IF @Obtenido > 0.0 
      BEGIN
        SELECT @RenglonSub = @RenglonSub + 1
        INSERT INTO #Ren (RenglonSub, SubCuenta, Cantidad) VALUES (@RenglonSub, @SubCuenta, @Obtenido)
        IF @@ERROR <> 0 SELECT @Ok = 1

        SELECT @Suma = @Suma + @Obtenido
        IF @Suma = @Cantidad BREAK
      END
    END -- fetch_status
    FETCH NEXT FROM crAutoSeriesLotesRen INTO @SubCuenta, @Disponible
    IF @@ERROR <> 0 SELECT @Ok = 1
  END
  CLOSE crAutoSeriesLotesRen
  DEALLOCATE crAutoSeriesLotesRen

  IF @Suma <> @Cantidad SELECT @Ok = 20020, @OkRef = 'Articulo: '+@Articulo
  IF @Ok IS NULL 
  BEGIN
    SELECT @CuantosRenglones = Count(*) FROM #Ren

    IF @Modulo = 'VTAS' 
    BEGIN
      SELECT VentaD.* INTO #VentaDetalle FROM cVentaD, #Ren WHERE VentaD.ID = @ID AND VentaD.Renglon = @Renglon 
      IF @@ERROR <> 0 SELECT @Ok = 1
      DECLARE crAutoSeriesLotesDetalle CURSOR FOR SELECT ID FROM #VentaDetalle
    END ELSE
    IF @Modulo = 'PROD' 
    BEGIN
      SELECT ProdD.* INTO #ProdDetalle FROM cProdD, #Ren WHERE ProdD.ID = @ID AND ProdD.Renglon = @Renglon 
      IF @@ERROR <> 0 SELECT @Ok = 1
      DECLARE crAutoSeriesLotesDetalle CURSOR FOR SELECT ID FROM #ProdDetalle
    END ELSE
    IF @Modulo = 'COMS' 
    BEGIN
      SELECT CompraD.* INTO #CompraDetalle FROM cCompraD, #Ren WHERE CompraD.ID = @ID AND CompraD.Renglon = @Renglon 
      IF @@ERROR <> 0 SELECT @Ok = 1
      DECLARE crAutoSeriesLotesDetalle CURSOR FOR SELECT ID FROM #CompraDetalle
    END ELSE
    IF @Modulo = 'INV' 
    BEGIN
      SELECT InvD.* INTO #InvDetalle FROM cInvD, #Ren WHERE InvD.ID   = @ID AND InvD.Renglon = @Renglon 
      IF @@ERROR <> 0 SELECT @Ok = 1
      DECLARE crAutoSeriesLotesDetalle CURSOR FOR SELECT ID FROM #InvDetalle
    END

    OPEN crAutoSeriesLotesDetalle
    SELECT @Contador = 0
  
    FETCH NEXT FROM crAutoSeriesLotesDetalle INTO @DetalleID
    IF @@ERROR <> 0 SELECT @Ok = 1
    WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
    BEGIN
      IF @@FETCH_STATUS <> -2 
      BEGIN
        SELECT @Contador = @Contador + 1
        IF @Contador > @CuantosRenglones BREAK

        SELECT @RenRenglonSub = RenglonSub, @RenSubCuenta = SubCuenta, @RenCantidad = Cantidad
          FROM #Ren
         WHERE ID = (@RenglonInicial + @Contador)
        IF @@ERROR <> 0 SELECT @Ok = 1

        IF @EstatusNuevo = 'PENDIENTE'
          SELECT @CantidadPendiente = @RenCantidad
        ELSE 
          SELECT @CantidadPendiente = NULL

	IF @Modulo = 'VTAS' 
        BEGIN
          UPDATE #VentaDetalle 
             SET RenglonSub = @RenRenglonSub, SubCuenta = @RenSubCuenta, Cantidad = @RenCantidad, CantidadPendiente = @CantidadPendiente, CantidadA = NULL
           WHERE CURRENT OF crAutoSeriesLotesDetalle
          IF @@ERROR <> 0 SELECT @Ok = 1

          INSERT INTO VentaD SELECT * FROM #VentaDetalle WHERE RenglonSub = @RenRenglonSub
          IF @@ERROR <> 0 SELECT @Ok = 1
        END ELSE
	IF @Modulo = 'PROD' 
        BEGIN
          UPDATE #ProdDetalle 
             SET RenglonSub = @RenRenglonSub, SubCuenta = @RenSubCuenta, Cantidad = @RenCantidad, CantidadPendiente = @CantidadPendiente, CantidadA = NULL
           WHERE CURRENT OF crAutoSeriesLotesDetalle
          IF @@ERROR <> 0 SELECT @Ok = 1

          INSERT INTO ProdD SELECT * FROM #ProdDetalle WHERE RenglonSub = @RenRenglonSub
          IF @@ERROR <> 0 SELECT @Ok = 1
        END ELSE
	IF @Modulo = 'COMS' 
        BEGIN
          UPDATE #CompraDetalle 
             SET RenglonSub = @RenRenglonSub, SubCuenta = @RenSubCuenta, Cantidad = @RenCantidad, CantidadPendiente = @CantidadPendiente, CantidadA = NULL
           WHERE CURRENT OF crAutoSeriesLotesDetalle
          IF @@ERROR <> 0 SELECT @Ok = 1

          INSERT INTO CompraD SELECT * FROM #CompraDetalle WHERE RenglonSub = @RenRenglonSub
          IF @@ERROR <> 0 SELECT @Ok = 1
        END ELSE
	IF @Modulo = 'INV' 
        BEGIN
          UPDATE #InvDetalle 
             SET RenglonSub = @RenRenglonSub, SubCuenta = @RenSubCuenta, Cantidad = @RenCantidad, CantidadPendiente = @CantidadPendiente, CantidadA = NULL
           WHERE CURRENT OF crAutoSeriesLotesDetalle
          IF @@ERROR <> 0 SELECT @Ok = 1

          INSERT INTO InvD SELECT * FROM #InvDetalle WHERE RenglonSub = @RenRenglonSub
          IF @@ERROR <> 0 SELECT @Ok = 1
        END
      END
      FETCH NEXT FROM crAutoSeriesLotesDetalle INTO @DetalleID
      IF @@ERROR <> 0 SELECT @Ok = 1
    END
    CLOSE crAutoSeriesLotesDetalle
    DEALLOCATE crAutoSeriesLotesDetalle
  END

  RETURN
END*/
GO

/************** spAuxiliarReg *************/
if exists (select * from sysobjects where id = object_id('dbo.spAuxiliarReg') and type = 'P') drop procedure dbo.spAuxiliarReg
GO
CREATE PROCEDURE spAuxiliarReg
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  SELECT "Conteo" = (SELECT ISNULL(COUNT(*), 0.0) FROM Auxiliar)  +
                    (SELECT ISNULL(COUNT(*), 0.0) FROM AuxiliarU) +
                    (SELECT ISNULL(COUNT(*), 0.0) FROM AuxiliarR) +
                    (SELECT ISNULL(COUNT(*), 0.0) FROM AuxiliarRU)
END
GO

/*********** spBonificarCostoPromedio ***********/
if exists (select * from sysobjects where id = object_id('dbo.spBonificarCostoPromedio') and type = 'P') drop procedure dbo.spBonificarCostoPromedio
GO
CREATE PROCEDURE spBonificarCostoPromedio
			@Existencia	float,
			@Accion		char(20),
			@MovTipo	char(20),
			@Cantidad	float,
			@Costo		float,
			@CostoPromedio	float	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @CostoAnterior	float,
    @CostoMov		float,
    @EsCargo		bit

  SELECT @Existencia = ISNULL(@Existencia, 0.0)
  SELECT @CostoAnterior = ABS(@Existencia) * @CostoPromedio
  SELECT @CostoMov = @Cantidad * @Costo

  IF @MovTipo = 'COMS.B' SELECT @EsCargo = 0 ELSE SELECT @EsCargo = 1
  IF @Accion = 'CANCELAR' IF @EsCargo = 0 SELECT @EsCargo = 1 ELSE SELECT @EsCargo = 0

  IF @EsCargo = 1
    SELECT @CostoPromedio = (@CostoAnterior + @CostoMov) / NULLIF(@Existencia, 0)
  ELSE 
    SELECT @CostoPromedio = (@CostoAnterior - @CostoMov) / NULLIF(@Existencia, 0)
  RETURN
END
GO

/*********** spCalcCostoPromedio ***********/
if exists (select * from sysobjects where id = object_id('dbo.spCalcCostoPromedio') and type = 'P') drop procedure dbo.spCalcCostoPromedio
GO
CREATE PROCEDURE spCalcCostoPromedio
		        @Existencia     float,
			@EsEntrada	bit,
			@Cantidad	float,
			@Costo		float,
			@CostoPromedio	float	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
--  IF @EsEntrada = 0 RETURN
  -- SET nocount ON
  DECLARE
    @ExistenciaNueva	float,
    @CostoAnterior	float,
    @CostoMov		float

  SELECT @Existencia = ISNULL(@Existencia, 0.0)
  IF @EsEntrada = 1 
    SELECT @ExistenciaNueva = @Existencia + @Cantidad 
  ELSE 
    SELECT @ExistenciaNueva = @Existencia - @Cantidad 

  SELECT @ExistenciaNueva = ROUND(@ExistenciaNueva, 10)
  SELECT @CostoAnterior = ABS(@Existencia) * @CostoPromedio
  SELECT @CostoMov = @Cantidad * @Costo

  IF @ExistenciaNueva < 0.01
    SELECT @CostoPromedio = @Costo
  ELSE 
    IF @EsEntrada = 1 
      SELECT @CostoPromedio = (@CostoAnterior + @CostoMov) / @ExistenciaNueva
    ELSE BEGIN
      /*IF @CostoAnterior - @CostoMov <= 0.0 
        SELECT @CostoPromedio = 0.0
      ELSE*/
        SELECT @CostoPromedio = (@CostoAnterior - @CostoMov) / @ExistenciaNueva
    END
  RETURN
END
GO

/**************** spCalculaImporte ****************/
if exists (select * from sysobjects where id = object_id('dbo.spCalculaImporte') and type = 'P') drop procedure dbo.spCalculaImporte
GO             
CREATE PROCEDURE spCalculaImporte
                   @Accion			char(20),
		   @Modulo			char(5),
		   @CfgImpInc			bit,
		   @MovTipo			char(20),
		   @EsEntrada			bit,
    		   @Cantidad			float,
		   @Precio	  		float,
	           @DescuentoTipo		char(1),
		   @DescuentoLinea 		float,
		   @DescuentoGlobal		float,
		   @SobrePrecio			float,
		   @Impuesto1			float,
		   @Impuesto2			float,
		   @Impuesto3			float,
		   @Impuesto5			float,
		   @Importe			float	OUTPUT,
		   @ImporteNeto			float	OUTPUT,
		   @DescuentoLineaImporte	float	OUTPUT,
		   @DescuentoGlobalImporte	float   OUTPUT,
		   @SobrePrecioImporte		float   OUTPUT,
		   @Impuestos			float   OUTPUT,
		   @ImpuestosNetos		float   OUTPUT,

		   @Impuesto1Neto		float	 = NULL OUTPUT,
		   @Impuesto2Neto		float	 = NULL OUTPUT,
		   @Impuesto3Neto		float	 = NULL OUTPUT,
		   @Impuesto5Neto		float	 = NULL OUTPUT,
		   @Articulo 			char(20) = NULL,
		   @CantidadObsequio		float	 = NULL,
		   @CfgPrecioMoneda		bit	 = 0,
		   @MovTipoCambio		float	 = NULL,
		   @PrecioTipoCambio		float	 = NULL,
		   @Retencion1			float	 = NULL,
		   @Retencion2			float	 = NULL,
		   @Retencion3			float	 = NULL,
		   @ID					int		 = NULL,
           @AnticipoFacturado	bit		 = NULL, --ANTICIPOFACTURADO
		   @Retencion1Neto		float	 = NULL OUTPUT,
		   @Retencion2Neto		float	 = NULL OUTPUT,
		   @Retencion3Neto		float	 = NULL OUTPUT,		   
           @RetencionesNeto		float    = NULL OUTPUT
                      
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @PorDescLinea		float,
    @PorDescGlobal		float,
    @PorSobrePrecio		float,
    @JuntarImpuestos		float,
    --@Imp3			float,
    @SubImpuesto1		float,
    @SubImpuestoNeto1		float,
    @SubImpuesto2		float,
    @SubImpuestoNeto2		float,
    @SubImpuesto3		float,
    @SubImpuestoNeto3		float,
    @RedondeoMonetarios		int,
    @Impuesto2Info		bit,
    @Impuesto3Info		bit,
    @Impuesto2BaseImpuesto1	bit,
    @Retencion2BaseImpuesto1	bit,    
    @SubImpuesto5		float,
    @SubImpuestoNeto5		float,
    @SubMovTipo				varchar(20),
    @Mov					varchar(20)
    
  IF NULLIF(@ID,0) IS NOT NULL
  BEGIN  
    IF @Modulo = 'VTAS' SELECT @Mov = Mov FROM Venta WHERE ID = @ID ELSE
    IF @Modulo = 'COMS' SELECT @Mov = Mov FROM Compra WHERE ID = @ID ELSE  
    IF @Modulo = 'PROD' SELECT @Mov = Mov FROM Prod WHERE ID = @ID ELSE  
    IF @Modulo = 'INV' SELECT @Mov = Mov FROM Inv WHERE ID = @ID    
    SELECT @SubMovTipo = SubClave FROM MovTipo WHERE Mov = @Mov AND Modulo = @Modulo   
  END
  
  SELECT @RedondeoMonetarios = RedondeoMonetarios, @Impuesto2Info = ISNULL(Impuesto2Info, 0), @Impuesto3Info = ISNULL(Impuesto3Info, 0), @Impuesto2BaseImpuesto1 = ISNULL(Impuesto2BaseImpuesto1, 0), @Retencion2BaseImpuesto1 = ISNULL(Retencion2BaseImpuesto1, 0) FROM Version

  SELECT @Cantidad        = ISNULL(@Cantidad, 0.0) - ISNULL(@CantidadObsequio, 0.0),
         @Precio   	  = ISNULL(@Precio, 0.0),
	 @DescuentoTipo   = ISNULL(@DescuentoTipo, '%'),
	 @DescuentoLinea  = ISNULL(@DescuentoLinea, 0.0),
       	 @DescuentoGlobal = ISNULL(@DescuentoGlobal, 0.0),
       	 @SobrePrecio     = ISNULL(@SobrePrecio, 0.0),
	 @Impuesto1	  = ISNULL(@Impuesto1, 0.0),
	 @Impuesto2	  = ISNULL(@Impuesto2, 0.0),
	 @Impuesto3	  = ISNULL(@Impuesto3, 0.0),
	 @Impuesto5	  = ISNULL(@Impuesto5, 0.0),
	 @Retencion1	  = ISNULL(@Retencion1, 0.0),
	 @Retencion2	  = ISNULL(@Retencion2, 0.0),
	 @Retencion3	  = ISNULL(@Retencion3, 0.0)

  IF @Impuesto2Info = 1 SELECT @Impuesto2 = 0.0
  IF @Impuesto3Info = 1 SELECT @Impuesto3 = 0.0
  
  -- SET nocount ON
  IF @MovTipo IN ('VTAS.N','VTAS.NO','VTAS.NR','VTAS.FM') 
    IF (@Accion <> 'CANCELAR' AND @EsEntrada = 1) OR
       (@Accion = 'CANCELAR' AND @EsEntrada = 0) SELECT @Cantidad = -@Cantidad

  /*IF @CfgImpInc = 1 AND ISNULL(@Impuesto3, 0) = 0 AND @Articulo IS NOT NULL 
    SELECT @Imp3 = ISNULL(Impuesto3, 0) FROM Art WHERE Articulo = @Articulo
  ELSE
    SELECT @Imp3 = @Impuesto3*/

  SELECT @JuntarImpuestos = CASE WHEN @Impuesto2BaseImpuesto1 = 1 THEN ((100.0+@Impuesto2)*(1+((@Impuesto1/*+@Imp3*/)/100.0))-100.0) ELSE @Impuesto1+@Impuesto2 END,
	 @PorDescLinea    = CONVERT(float, @DescuentoLinea/100.0),
	 @PorDescGlobal   = CONVERT(float, @DescuentoGlobal/100.0),
         @PorSobrePrecio  = CONVERT(float, @SobrePrecio/100.0)

  IF @Modulo = 'VTAS' AND @CfgImpInc = 1 
    SELECT @Precio = (@Precio-@Impuesto3)/(1+(@JuntarImpuestos/100.0))		

  IF @Modulo = 'VTAS' AND @CfgPrecioMoneda = 1
    SELECT @Precio = (@Precio * @PrecioTipoCambio) / @MovTipoCambio

  SELECT @Importe                = @Cantidad * @Precio,
         @DescuentoGlobalImporte = 0.0, 
         @SobrePrecioImporte	 = 0.0, 
         @Impuestos              = 0.0

  EXEC xpCalculaImporte1 @RedondeoMonetarios, @Importe OUTPUT
  
  IF @DescuentoTipo <> '$' 
    SELECT @DescuentoLineaImporte  = @DescuentoLinea * @Cantidad
  ELSE SELECT @DescuentoLineaImporte  = @DescuentoLinea

  IF @DescuentoLinea <> 0.0 
  BEGIN
    IF @DescuentoTipo <> '$' 
      SELECT @DescuentoLineaImporte = @Importe * @PorDescLinea
    SELECT @Importe = @Importe - @DescuentoLineaImporte					
  END

  IF @DescuentoGlobal <> 0.0 AND ISNULL(@AnticipoFacturado,0) = 0--ANTICIPOFACTURADO
    SELECT @DescuentoGlobalImporte = ROUND(@Importe * @PorDescGlobal, @RedondeoMonetarios)

  IF @SobrePrecio <> 0.0 
    SELECT @SobrePrecioImporte = ROUND(@Importe * @PorSobrePrecio, @RedondeoMonetarios)

  SELECT @ImporteNeto = @Importe - @DescuentoGlobalImporte + @SobrePrecioImporte
  IF @ID IS NOT NULL AND (@MovTipo = 'GAS.G' AND @SubMovTipo = 'GAS.GE/GT') SELECT @ImporteNeto = @ImporteNeto * (1-(@Retencion3/100.0))

  SELECT @SubImpuesto2 = @Importe * (@Impuesto2/100.0) 
  --SELECT @SubImpuesto3 = @Importe * (@Impuesto3/100.0) 
  IF @Impuesto2BaseImpuesto1 = 1
    SELECT @SubImpuesto1 = (@Importe + @SubImpuesto2) * ((@Impuesto1/*+@Impuesto3*/)/100.0)
  ELSE
    SELECT @SubImpuesto1 = @Importe * (@Impuesto1/100.0) 
    
  SELECT @Impuestos    = @SubImpuesto1 + @SubImpuesto2 

  SELECT @SubImpuestoNeto2 = @ImporteNeto * (@Impuesto2/100.0)
  SELECT @SubImpuestoNeto3 = @Cantidad * @Impuesto3
  SELECT @SubImpuestoNeto5 = @Impuesto5
  SELECT @SubImpuestoNeto1 = (@ImporteNeto + CASE WHEN @Impuesto2BaseImpuesto1 = 1 THEN @SubImpuestoNeto2 ELSE 0.0 END) * ((@Impuesto1/*+@Impuesto3*/)/100.0)

  
  SELECT @ImpuestosNetos  = @SubImpuestoNeto1 + @SubImpuestoNeto2 + @SubImpuestoNeto3 + @SubImpuestoNeto5,
         @Impuesto1Neto   = @SubImpuestoNeto1 /*- (@ImporteNeto * (@Impuesto3/100.0))*/,
         @Impuesto2Neto   = @SubImpuestoNeto2,
         @Impuesto3Neto   = @SubImpuestoNeto3,
	 @Impuesto5Neto   = @SubImpuestoNeto5

  SELECT @Retencion1Neto = @ImporteNeto * (@Retencion1/100.0)
  SELECT @Retencion2Neto = (CASE WHEN @Retencion2BaseImpuesto1 = 1 THEN @SubImpuestoNeto1 ELSE @ImporteNeto END) * (@Retencion2/100.0)
  SELECT @Retencion3Neto = @ImporteNeto * (@Retencion3/100.0)  
  SELECT @RetencionesNeto = @Retencion1Neto + @Retencion2Neto + @Retencion3Neto
    
  EXEC xpCalculaImporte2 @RedondeoMonetarios, @Importe OUTPUT, @ImporteNeto OUTPUT, @DescuentoLineaImporte OUTPUT, @DescuentoGlobalImporte OUTPUT, @SobrePrecioImporte OUTPUT, @Impuestos OUTPUT, @ImpuestosNetos OUTPUT, @Impuesto1Neto OUTPUT, @Impuesto2Neto OUTPUT, @Impuesto3Neto OUTPUT, @Impuesto5Neto OUTPUT
  RETURN
END
GO

/**************** spCalculaImporteMN ****************/
if exists (select * from sysobjects where id = object_id('dbo.spCalculaImporteMN') and type = 'P') drop procedure dbo.spCalculaImporteMN
GO             
CREATE PROCEDURE spCalculaImporteMN
		   @CfgImpInc			bit,
    		   @Cantidad			float,
		   @Precio	  		float,
	           @DescuentoTipo		char(1),
		   @DescuentoLinea 		float,
		   @DescuentoGlobal		float,
		   @SobrePrecio			float,
		   @Impuesto1			float,
		   @Impuesto2			float,
		   @Impuesto3			float,
		   @Impuesto5			float,
		   @TipoCambio			float,

		   @ImporteMN			float	OUTPUT,
                   @DescuentoMN			float	OUTPUT,
		   @Impuesto1MN			float	= NULL OUTPUT,
		   @Impuesto2MN			float	= NULL OUTPUT,
		   @Impuesto3MN			float	= NULL OUTPUT,
		   @Impuesto5MN			float	= NULL OUTPUT,
		   @ImporteTotalMN		float	= NULL OUTPUT,
		   @CantidadObsequio		float	= NULL,
		   @CfgPrecioMoneda		bit	= 0,
		   @MovTipoCambio		float	= NULL,
		   @PrecioTipoCambio		float	= NULL
--//WITH ENCRYPTION
AS BEGIN
  EXEC spCalculaImporte @CfgImpInc, @Cantidad, @Precio, @DescuentoTipo, @DescuentoLinea, @DescuentoGlobal, @SobrePrecio, @Impuesto1, @Impuesto2, @Impuesto3, @Impuesto5,
                        @ImporteMN OUTPUT, @DescuentoMN OUTPUT, @Impuesto1MN OUTPUT, @Impuesto2MN OUTPUT, @Impuesto3MN OUTPUT, @Impuesto5MN OUTPUT,  
		        @CantidadObsequio = @CantidadObsequio, @CfgPrecioMoneda = @CfgPrecioMoneda, @MovTipoCambio = @MovTipoCambio, @PrecioTipoCambio = @PrecioTipoCambio
  SELECT @ImporteMN = @ImporteMN * @TipoCambio, 
         @DescuentoMN = @DescuentoMN * @TipoCambio, 
         @Impuesto1MN = @Impuesto1MN * @TipoCambio,
         @Impuesto2MN = @Impuesto2MN * @TipoCambio,
         @Impuesto3MN = @Impuesto3MN * @TipoCambio,
         @Impuesto5MN = @Impuesto5MN * @TipoCambio

  SELECT @ImporteTotalMN = ISNULL(@ImporteMN, 0.0) + ISNULL(@Impuesto1MN, 0.0) + ISNULL(@Impuesto2MN, 0.0) + ISNULL(@Impuesto3MN, 0.0) + ISNULL(@Impuesto5MN, 0.0)
  RETURN
END
GO

/*

DECLARE
  @Importe	money
  EXEC spCalculaImporteNeto 200, 10, 10, 10, @Importe OUTPUT
  SELECT @Importe
*/

/**************** spCalculaImporteNeto ****************/
--if exists (select * from sysobjects where id = object_id('dbo.spCalculaImporteNeto') and type = 'P') drop procedure dbo.spCalculaImporteNeto
GO             
/*CREATE PROCEDURE spCalculaImporteNeto
			@Precio		money, 
			@Cantidad	float, 
			@Desc1		float, 
			@Desc2		float,
		   	@Impuesto1	float,
		   	@Impuesto2	float,
			@SubTotal	money OUTPUT,
			@Importe1	money OUTPUT,
			@Importe2	money OUTPUT,
--//WITH ENCRYPTION
AS BEGIN
  SELECT @SubTotal = (@Precio * @Cantidad) 
  IF NULLIF(@Desc1, 0) IS NOT NULL SELECT @SubTotal = @SubTotal * ((100-@Desc1)/100)
  IF NULLIF(@Desc2, 0) IS NOT NULL SELECT @SubTotal = @SubTotal * ((100-@Desc2)/100)
  RETURN
END*/
GO

/**************** spCalculaImporteNeto ****************/
if exists (select * from sysobjects where id = object_id('dbo.spCalculaImporteNeto') and type = 'P') drop procedure dbo.spCalculaImporteNeto
GO             
CREATE PROCEDURE spCalculaImporteNeto
		   @CfgImpInc			bit,
    		   @Cantidad			float,
		   @Precio	  		float,
	           @DescuentoTipo		char(1),
		   @DescuentoLinea 		float,
		   @DescuentoGlobal		float,
		   @SobrePrecio			float,
		   @Impuesto1			float,
		   @Impuesto2			float,
		   @Impuesto3			float,

		   @ImporteNeto			float	OUTPUT,
                   @DescuentosNetos		float	OUTPUT,
		   @Impuesto1Neto		float	= NULL OUTPUT,
		   @Impuesto2Neto		float	= NULL OUTPUT,
		   @Impuesto3Neto		float	= NULL OUTPUT,
		   @CantidadObsequio		float	= NULL,
		   @CfgPrecioMoneda		bit 	= 0,
		   @MovTipoCambio		float	= NULL,
		   @PrecioTipoCambio		float	= NULL
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Importe			float,
    @Impuestos			float,
    @ImpuestosNetos		float,
    @DescuentoLineaImporte	float,
    @DescuentoGlobalImporte	float,
    @SobrePrecioImporte		float

  EXEC spCalculaImporte 'AFECTAR', NULL, @CfgImpInc, NULL, NULL, @Cantidad, @Precio, @DescuentoTipo, @DescuentoLinea, @DescuentoGlobal, @SobrePrecio, @Impuesto1, @Impuesto2, @Impuesto3,
                        @Importe OUTPUT, @ImporteNeto OUTPUT, @DescuentoLineaImporte OUTPUT, @DescuentoGlobalImporte OUTPUT, @SobrePrecioImporte OUTPUT, 
                        @Impuestos OUTPUT, @ImpuestosNetos OUTPUT, @Impuesto1Neto OUTPUT, @Impuesto2Neto OUTPUT, @Impuesto3Neto OUTPUT, 
			@CantidadObsequio = @CantidadObsequio, @CfgPrecioMoneda = @CfgPrecioMoneda, @MovTipoCambio = @MovTipoCambio, @PrecioTipoCambio = @PrecioTipoCambio
  SELECT @DescuentosNetos = ISNULL(@DescuentoLineaImporte, 0.0) + ISNULL(@DescuentoGlobalImporte, 0.0)
  RETURN
END
GO

/************** spCambiarCtaSituacion *************/
if exists (select * from sysobjects where id = object_id('dbo.spCambiarCtaSituacion') and type = 'P') drop procedure dbo.spCambiarCtaSituacion
GO
CREATE PROCEDURE spCambiarCtaSituacion
                   @Rama		char(5),
                   @Cuenta		char(20),
		   @Situacion		char(50),
		   @SituacionFecha	datetime,
		   @SituacionUsuario	varchar(10) = NULL,
		   @SituacionNota	varchar(100) = NULL,
		   @Empresa		varchar(5) = NULL,
		   @Usuario		varchar(10) = NULL
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @SituacionesPorArea	bit,
    @Area		varchar(50)
    
  SELECT @Situacion = NULLIF(RTRIM(@Situacion), '')
  SELECT @SituacionesPorArea = SituacionesPorArea FROM EmpresaGral WHERE Empresa = @Empresa
  SELECT @Area = SituacionArea FROM Usuario WHERE Usuario = @Usuario
  
  BEGIN TRANSACTION 
    IF (ISNULL(@SituacionesPorArea, 0) = 1) AND (ISNULL(UPPER(@Area), '') <> '(GENERAL)')
    BEGIN
      UPDATE SituacionCta
         SET Situacion = @Situacion, SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota 
       WHERE Rama = @Rama AND Cuenta = @Cuenta AND Area = @Area
      IF @@ROWCOUNT = 0
        INSERT SituacionCta (
               Rama, Cuenta, Area, Situacion, SituacionFecha, SituacionUsuario, SituacionNota)
        VALUES (@Rama, @Cuenta, @Area, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota)
    END ELSE
    BEGIN
      IF @Rama = 'INV'  UPDATE Art       SET Situacion = @Situacion, SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE Articulo     = @Cuenta ELSE
      IF @Rama = 'CXC'  UPDATE Cte       SET Situacion = @Situacion, SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE Cliente      = @Cuenta ELSE
      IF @Rama = 'CXP'  UPDATE Prov      SET Situacion = @Situacion, SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE Proveedor    = @Cuenta ELSE
      IF @Rama = 'RH'   UPDATE Personal  SET Situacion = @Situacion, SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE Personal     = @Cuenta ELSE
      IF @Rama = 'PROY' UPDATE Proy      SET Situacion = @Situacion, SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE Proyecto     = @Cuenta ELSE
      IF @Rama = 'ESP'  UPDATE Espacio   SET Situacion = @Situacion, SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE Espacio      = @Cuenta ELSE
      IF @Rama = 'AUTO' UPDATE VIN       SET Situacion = @Situacion, SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE VIN          = @Cuenta ELSE
      IF @Rama = 'REP'  UPDATE Rep       SET Situacion = @Situacion, SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE Reporte      = @Cuenta ELSE
      IF @Rama = 'AC'   UPDATE LC        SET Situacion = @Situacion, SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE LineaCredito = @Cuenta ELSE
      IF @Rama = 'ARO'  UPDATE aroRiesgo SET Situacion = @Situacion, SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE Riesgo       = @Cuenta 
    END
  COMMIT TRANSACTION
  RETURN 
END
GO

/************** spCambiarSituacion *************/
if exists (select * from sysobjects where id = object_id('dbo.spCambiarSituacion') and type = 'P') drop procedure dbo.spCambiarSituacion
GO
CREATE PROCEDURE spCambiarSituacion
           @Modulo				char(5),
           @ID					int,
		   @Situacion			char(50),
		   @SituacionFecha		datetime,
		   @Usuario				char(10),
		   @SituacionUsuario	varchar(10)  = NULL,
		   @SituacionNota		varchar(100) = NULL,
		   -- 11464
		   @Hora				varchar(30)  = NULL 

--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @FechaComenzo		datetime,
    @Empresa			varchar(5), --AUTORIZACIONREMOTA
    @Notificacion		bit --AUTORIZACIONREMOTA

  -- 11464
  IF ISNULL(@Hora, '') <> ''
  BEGIN
    IF @Hora LIKE '%p.m.%'
      SELECT @Hora = CONVERT(varchar(5), CONVERT(int, SUBSTRING(@Hora, 1, 2)) + 12) + ':' + SUBSTRING(@Hora, 4, 2)
    ELSE
      SELECT @Hora = SUBSTRING(@Hora, 1, 5)
      
    SELECT @SituacionFecha = dbo.fnFechaConHora(@SituacionFecha, @Hora)
  END
  
  BEGIN TRANSACTION

    IF @Modulo = 'CONT'  UPDATE Cont         SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'VTAS'  UPDATE Venta        SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'PROD'  UPDATE Prod         SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'COMS'  UPDATE Compra       SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'INV'   UPDATE Inv          SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'CXC'   UPDATE Cxc          SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'CXP'   UPDATE Cxp          SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'AGENT' UPDATE Agent        SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'GAS'   UPDATE Gasto        SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'DIN'   UPDATE Dinero       SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'EMB'   UPDATE Embarque     SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'NOM'   UPDATE Nomina       SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'RH'    UPDATE RH           SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'ASIS'  UPDATE Asiste       SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'AF'    UPDATE ActivoFijo   SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'PC'    UPDATE PC           SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'OFER'  UPDATE Oferta       SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'VALE'  UPDATE Vale         SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'CR'    UPDATE CR           SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'ST'    UPDATE Soporte      SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'CAP'   UPDATE Capital      SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'INC'   UPDATE Incidencia   SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'CONC'  UPDATE Conciliacion SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'PPTO'  UPDATE Presup       SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'CREDI' UPDATE Credito      SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'TMA'   UPDATE TMA          SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'RSS'   UPDATE RSS          SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'CMP'   UPDATE Campana      SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'FIS'   UPDATE Fiscal       SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    --REQ25014
    IF @Modulo = 'CONTP' UPDATE ContParalela SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE    
    --REQ16092
	IF @Modulo = 'OPORT' UPDATE Oportunidad  SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE	
    IF @Modulo = 'CORTE' UPDATE Corte        SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'FRM'   UPDATE FormaExtra   SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'CAPT'  UPDATE Captura      SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'GES'   UPDATE Gestion      SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'CP'    UPDATE CP           SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'PCP'   UPDATE PCP          SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE    
    IF @Modulo = 'PROY'  UPDATE Proyecto     SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE

    --IF @Modulo = 'ACT'   UPDATE Act           SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX01' UPDATE ModuloExtra01 SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX02' UPDATE ModuloExtra02 SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX03' UPDATE ModuloExtra03 SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX04' UPDATE ModuloExtra04 SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX05' UPDATE ModuloExtra05 SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX06' UPDATE ModuloExtra06 SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX07' UPDATE ModuloExtra07 SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX08' UPDATE ModuloExtra08 SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX09' UPDATE ModuloExtra09 SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'ORG'   UPDATE Organiza     SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'RE'    UPDATE Recluta	     SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'ISL'   UPDATE ISL          SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE

    IF @Modulo = 'CAM'   UPDATE Cambio       SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'PACTO' UPDATE Contrato     SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID ELSE
    IF @Modulo = 'SAUX'	 UPDATE SAUX		 SET Situacion = NULLIF(RTRIM(@Situacion), ''), SituacionFecha = @SituacionFecha, SituacionUsuario = @SituacionUsuario, SituacionNota = @SituacionNota WHERE ID = @ID

    SELECT @FechaComenzo = NULL
    SELECT @FechaComenzo = MAX(FechaComenzo) FROM MovTiempo WHERE Modulo = @Modulo AND ID = @ID AND Situacion = @Situacion

    IF @FechaComenzo IS NOT NULL
      UPDATE MovTiempo SET Usuario = @Usuario WHERE Modulo = @Modulo AND ID = @ID AND FechaComenzo = @FechaComenzo AND Situacion = @Situacion

    EXEC xpCambiarSituacion @Modulo, @ID, @Situacion, @SituacionFecha, @Usuario, @SituacionUsuario, @SituacionNota

  COMMIT TRANSACTION

  SET @Notificacion = 0
  EXEC spMovInfo @ID, @Modulo, @Empresa = @Empresa OUTPUT --AUTORIZACIONREMOTA
  SELECT @Notificacion = ISNULL(Notificacion,0) FROM EmpresaGral WHERE Empresa = @Empresa --AUTORIZACIONREMOTA

  IF @Notificacion = 1 --AUTORIZACIONREMOTA
  BEGIN
    EXEC spNotificacion @ID, @Modulo
  END 
  
  RETURN 
END
GO


/************** spCambiarSucursalDestino *************/
if exists (select * from sysobjects where id = object_id('dbo.spCambiarSucursalDestino') and type = 'P') drop procedure dbo.spCambiarSucursalDestino
GO
CREATE PROCEDURE spCambiarSucursalDestino
                   @Modulo		char(5),
                   @ID			int,
		   @SucursalDestino	int
--//WITH ENCRYPTION
AS BEGIN
  BEGIN TRANSACTION

    IF @Modulo = 'CONT'  UPDATE Cont         SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'VTAS'  UPDATE Venta        SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'PROD'  UPDATE Prod         SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'COMS'  UPDATE Compra       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'INV'   UPDATE Inv          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'CXC'   UPDATE Cxc          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'CXP'   UPDATE Cxp          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'AGENT' UPDATE Agent        SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'GAS'   UPDATE Gasto        SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'DIN'   UPDATE Dinero       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'EMB'   UPDATE Embarque     SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'NOM'   UPDATE Nomina       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'RH'    UPDATE RH           SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'ASIS'  UPDATE Asiste       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'AF'    UPDATE ActivoFijo   SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'PC'    UPDATE PC           SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'OFER'  UPDATE Oferta       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'VALE'  UPDATE Vale         SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'CR'    UPDATE CR           SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'ST'    UPDATE Soporte      SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'CAP'   UPDATE Capital      SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'INC'   UPDATE Incidencia   SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'CONC'  UPDATE Conciliacion SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'PPTO'  UPDATE Presup       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'CREDI' UPDATE Credito      SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'TMA'   UPDATE TMA          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'RSS'   UPDATE RSS          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'CMP'   UPDATE Campana      SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'FIS'   UPDATE Fiscal       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    --REQ25014
    IF @Modulo = 'CONTP' UPDATE ContParalela SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE    
    --REQ16092
	IF @Modulo = 'OPORT' UPDATE Oportunidad  SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE	
    IF @Modulo = 'CORTE' UPDATE Corte        SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'FRM'   UPDATE FormaExtra   SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'CAPT'  UPDATE Captura      SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'GES'   UPDATE Gestion      SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'CP'    UPDATE CP           SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'PCP'   UPDATE PCP          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE    
    IF @Modulo = 'PROY'  UPDATE Proyecto     SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE            
    --IF @Modulo = 'ACT'   UPDATE Act           SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX01' UPDATE ModuloExtra01 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX02' UPDATE ModuloExtra02 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX03' UPDATE ModuloExtra03 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX04' UPDATE ModuloExtra04 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX05' UPDATE ModuloExtra05 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX06' UPDATE ModuloExtra06 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX07' UPDATE ModuloExtra07 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX08' UPDATE ModuloExtra08 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX09' UPDATE ModuloExtra09 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'ORG'   UPDATE Organiza     SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'RE'    UPDATE Recluta	     SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'ISL'   UPDATE ISL          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'CAM'   UPDATE Cambio       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'PACTO' UPDATE Contrato     SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
    IF @Modulo = 'SAUX'	 UPDATE SAUX		 SET SucursalDestino = @SucursalDestino WHERE ID = @ID

  COMMIT TRANSACTION
  RETURN 
END
GO

/************** spCambiarSucursalDestino2 *************/
if exists (select * from sysobjects where id = object_id('dbo.spCambiarSucursalDestino2') and type = 'P') drop procedure dbo.spCambiarSucursalDestino2
GO
CREATE PROCEDURE spCambiarSucursalDestino2
                   @Modulo		char(5),
                   @ID			int,
		   @SucursalDestino	int
--//WITH ENCRYPTION
AS BEGIN

  DECLARE
    @Sucursal				int,
    @Mov					varchar(20)

  IF @Modulo = 'CONT'  SELECT @Sucursal = Sucursal, @Mov = Mov FROM Cont         WHERE ID = @ID ELSE
  IF @Modulo = 'VTAS'  SELECT @Sucursal = Sucursal, @Mov = Mov FROM Venta        WHERE ID = @ID ELSE
  IF @Modulo = 'PROD'  SELECT @Sucursal = Sucursal, @Mov = Mov FROM Prod         WHERE ID = @ID ELSE
  IF @Modulo = 'COMS'  SELECT @Sucursal = Sucursal, @Mov = Mov FROM Compra       WHERE ID = @ID ELSE
  IF @Modulo = 'INV'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Inv          WHERE ID = @ID ELSE
  IF @Modulo = 'CXC'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Cxc          WHERE ID = @ID ELSE
  IF @Modulo = 'CXP'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Cxp          WHERE ID = @ID ELSE
  IF @Modulo = 'AGENT' SELECT @Sucursal = Sucursal, @Mov = Mov FROM Agent        WHERE ID = @ID ELSE
  IF @Modulo = 'GAS'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Gasto        WHERE ID = @ID ELSE
  IF @Modulo = 'DIN'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Dinero       WHERE ID = @ID ELSE
  IF @Modulo = 'EMB'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Embarque     WHERE ID = @ID ELSE
  IF @Modulo = 'NOM'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Nomina       WHERE ID = @ID ELSE
  IF @Modulo = 'RH'    SELECT @Sucursal = Sucursal, @Mov = Mov FROM RH           WHERE ID = @ID ELSE
  IF @Modulo = 'ASIS'  SELECT @Sucursal = Sucursal, @Mov = Mov FROM Asiste       WHERE ID = @ID ELSE
  IF @Modulo = 'AF'    SELECT @Sucursal = Sucursal, @Mov = Mov FROM ActivoFijo   WHERE ID = @ID ELSE
  IF @Modulo = 'PC'    SELECT @Sucursal = Sucursal, @Mov = Mov FROM PC           WHERE ID = @ID ELSE
  IF @Modulo = 'OFER'  SELECT @Sucursal = Sucursal, @Mov = Mov FROM Oferta       WHERE ID = @ID ELSE
  IF @Modulo = 'VALE'  SELECT @Sucursal = Sucursal, @Mov = Mov FROM Vale         WHERE ID = @ID ELSE
  IF @Modulo = 'CR'    SELECT @Sucursal = Sucursal, @Mov = Mov FROM CR           WHERE ID = @ID ELSE
  IF @Modulo = 'ST'    SELECT @Sucursal = Sucursal, @Mov = Mov FROM Soporte      WHERE ID = @ID ELSE
  IF @Modulo = 'CAP'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Capital      WHERE ID = @ID ELSE
  IF @Modulo = 'INC'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Incidencia   WHERE ID = @ID ELSE
  IF @Modulo = 'CONC'  SELECT @Sucursal = Sucursal, @Mov = Mov FROM Conciliacion WHERE ID = @ID ELSE
  IF @Modulo = 'PPTO'  SELECT @Sucursal = Sucursal, @Mov = Mov FROM Presup       WHERE ID = @ID ELSE
  IF @Modulo = 'CREDI' SELECT @Sucursal = Sucursal, @Mov = Mov FROM Credito      WHERE ID = @ID ELSE
  IF @Modulo = 'TMA'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM TMA          WHERE ID = @ID ELSE
  IF @Modulo = 'RSS'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM RSS          WHERE ID = @ID ELSE
  IF @Modulo = 'CMP'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Campana      WHERE ID = @ID ELSE
  IF @Modulo = 'FIS'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Fiscal       WHERE ID = @ID ELSE
  --REQ25014
  IF @Modulo = 'CONTP' SELECT @Sucursal = Sucursal, @Mov = Mov FROM ContParalela WHERE ID = @ID ELSE  
  --REQ16092
  IF @Modulo = 'OPORT' SELECT @Sucursal = Sucursal, @Mov = Mov FROM Oportunidad  WHERE ID = @ID ELSE  
  IF @Modulo = 'CORTE' SELECT @Sucursal = Sucursal, @Mov = Mov FROM Corte        WHERE ID = @ID ELSE
  IF @Modulo = 'FRM'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM FormaExtra   WHERE ID = @ID ELSE
  IF @Modulo = 'CAPT'  SELECT @Sucursal = Sucursal, @Mov = Mov FROM Captura      WHERE ID = @ID ELSE
  IF @Modulo = 'GES'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Gestion      WHERE ID = @ID ELSE
  IF @Modulo = 'CP'    SELECT @Sucursal = Sucursal, @Mov = Mov FROM CP           WHERE ID = @ID ELSE
  IF @Modulo = 'PCP'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM PCP          WHERE ID = @ID ELSE  
  IF @Modulo = 'PROY'  SELECT @Sucursal = Sucursal, @Mov = Mov FROM Proyecto     WHERE ID = @ID ELSE
  --IF @Modulo = 'ACT'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Act           WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX01' SELECT @Sucursal = Sucursal, @Mov = Mov FROM ModuloExtra01 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX02' SELECT @Sucursal = Sucursal, @Mov = Mov FROM ModuloExtra02 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX03' SELECT @Sucursal = Sucursal, @Mov = Mov FROM ModuloExtra03 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX04' SELECT @Sucursal = Sucursal, @Mov = Mov FROM ModuloExtra04 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX05' SELECT @Sucursal = Sucursal, @Mov = Mov FROM ModuloExtra05 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX06' SELECT @Sucursal = Sucursal, @Mov = Mov FROM ModuloExtra06 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX07' SELECT @Sucursal = Sucursal, @Mov = Mov FROM ModuloExtra07 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX08' SELECT @Sucursal = Sucursal, @Mov = Mov FROM ModuloExtra08 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX09' SELECT @Sucursal = Sucursal, @Mov = Mov FROM ModuloExtra09 WHERE ID = @ID ELSE
  IF @Modulo = 'ORG'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Organiza     WHERE ID = @ID ELSE
  IF @Modulo = 'RE'    SELECT @Sucursal = Sucursal, @Mov = Mov FROM Recluta	     WHERE ID = @ID ELSE
  IF @Modulo = 'ISL'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM ISL          WHERE ID = @ID ELSE
  IF @Modulo = 'CAM'   SELECT @Sucursal = Sucursal, @Mov = Mov FROM Cambio       WHERE ID = @ID ELSE
  IF @Modulo = 'PACTO' SELECT @Sucursal = Sucursal, @Mov = Mov FROM Contrato     WHERE ID = @ID ELSE
  IF @Modulo = 'SAUX'  SELECT @Sucursal = Sucursal, @Mov = Mov FROM Contrato     WHERE ID = @ID  
      
  IF NOT EXISTS(SELECT 1 FROM SucursalMovBloquearCambio WHERE Sucursal = @Sucursal AND RTRIM(Modulo) = RTRIM(@Modulo) AND RTRIM(Mov) = RTRIM(@Mov))      
  BEGIN

    BEGIN TRANSACTION

      IF @Modulo = 'CONT'  UPDATE Cont         SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'VTAS'  UPDATE Venta        SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'PROD'  UPDATE Prod         SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'COMS'  UPDATE Compra       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'INV'   UPDATE Inv          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'CXC'   UPDATE Cxc          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'CXP'   UPDATE Cxp          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'AGENT' UPDATE Agent        SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'GAS'   UPDATE Gasto        SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'DIN'   UPDATE Dinero       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'EMB'   UPDATE Embarque     SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'NOM'   UPDATE Nomina       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'RH'    UPDATE RH           SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'ASIS'  UPDATE Asiste       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'AF'    UPDATE ActivoFijo   SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'PC'    UPDATE PC           SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'OFER'  UPDATE Oferta       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'VALE'  UPDATE Vale         SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'CR'    UPDATE CR           SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'ST'    UPDATE Soporte      SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'CAP'   UPDATE Capital      SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'INC'   UPDATE Incidencia   SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'CONC'  UPDATE Conciliacion SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'PPTO'  UPDATE Presup       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'CREDI' UPDATE Credito      SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'TMA'   UPDATE TMA          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'RSS'   UPDATE RSS          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'CMP'   UPDATE Campana      SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'FIS'   UPDATE Fiscal       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      --REQ25014
      IF @Modulo = 'CONTP' UPDATE ContParalela SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE      
      --REQ16092
	  IF @Modulo = 'OPORT' UPDATE Oportunidad  SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE	  
      IF @Modulo = 'CORTE' UPDATE Corte		   SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'FRM'   UPDATE FormaExtra   SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'CAPT'  UPDATE Captura      SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'GES'   UPDATE Gestion      SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'CP'    UPDATE CP           SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'PCP'   UPDATE PCP          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE    
      IF @Modulo = 'PROY'  UPDATE Proyecto     SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE            
      --IF @Modulo = 'ACT'   UPDATE Act           SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX01' UPDATE ModuloExtra01 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX02' UPDATE ModuloExtra02 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX03' UPDATE ModuloExtra03 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX04' UPDATE ModuloExtra04 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX05' UPDATE ModuloExtra05 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX06' UPDATE ModuloExtra06 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX07' UPDATE ModuloExtra07 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX08' UPDATE ModuloExtra08 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX09' UPDATE ModuloExtra09 SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'ORG'   UPDATE Organiza     SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'RE'    UPDATE Recluta	     SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'ISL'   UPDATE ISL          SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'CAM'   UPDATE Cambio       SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'PACTO' UPDATE Contrato     SET SucursalDestino = @SucursalDestino WHERE ID = @ID ELSE
      IF @Modulo = 'SAUX'	 UPDATE SAUX		 SET SucursalDestino = @SucursalDestino WHERE ID = @ID

      SELECT NULL
    COMMIT TRANSACTION
  END ELSE
    SELECT 'No es posible cambiar la sucursal destino del movimiento. Verifique la configuración de la sucursal del movimiento.'
    
  RETURN 
END
GO

/************** spCambiarUsuario *************/
if exists (select * from sysobjects where id = object_id('dbo.spCambiarUsuario') and type = 'P') drop procedure dbo.spCambiarUsuario
GO
CREATE PROCEDURE spCambiarUsuario
                   @Modulo  	char(5),
                   @ID	    	int,
		   @Usuario 	char(10)
--//WITH ENCRYPTION
AS BEGIN
  IF NOT EXISTS(SELECT * FROM Usuario WHERE Usuario=@Usuario) RETURN
  BEGIN TRANSACTION

    IF @Modulo = 'CONT'  UPDATE Cont         SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'VTAS'  UPDATE Venta        SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'PROD'  UPDATE Prod         SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'COMS'  UPDATE Compra       SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'INV'   UPDATE Inv          SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'CXC'   UPDATE Cxc          SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'CXP'   UPDATE Cxp          SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'AGENT' UPDATE Agent        SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'GAS'   UPDATE Gasto        SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'DIN'   UPDATE Dinero       SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'EMB'   UPDATE Embarque     SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'NOM'   UPDATE Nomina       SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'RH'    UPDATE RH           SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'ASIS'  UPDATE Asiste       SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'AF'    UPDATE ActivoFijo   SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'PC'    UPDATE PC           SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'OFER'  UPDATE Oferta       SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'VALE'  UPDATE Vale         SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'CR'    UPDATE CR           SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'ST'    UPDATE Soporte      SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'CAP'   UPDATE Capital      SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'INC'   UPDATE Incidencia   SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'CONC'  UPDATE Conciliacion SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'PPTO'  UPDATE Presup       SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'CREDI' UPDATE Credito      SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'TMA'   UPDATE TMA          SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'RSS'   UPDATE RSS          SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'CMP'   UPDATE Campana      SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'FIS'   UPDATE Fiscal       SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    --REQ25014
    IF @Modulo = 'CONTP' UPDATE ContParalela SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE    
    --REQ16092
	IF @Modulo = 'OPORT' UPDATE Oportundidad SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE	
    IF @Modulo = 'CORTE' UPDATE Corte        SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'FRM'   UPDATE FormaExtra   SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'CAPT'  UPDATE Captura      SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'GES'   UPDATE Gestion      SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'CP'    UPDATE CP           SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'PCP'   UPDATE PCP          SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE    
    IF @Modulo = 'PROY'  UPDATE Proyecto     SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    --IF @Modulo = 'ACT'   UPDATE Act           SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX01' UPDATE ModuloExtra01 SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX02' UPDATE ModuloExtra02 SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX03' UPDATE ModuloExtra03 SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX04' UPDATE ModuloExtra04 SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX05' UPDATE ModuloExtra05 SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX06' UPDATE ModuloExtra06 SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX07' UPDATE ModuloExtra07 SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX08' UPDATE ModuloExtra08 SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX09' UPDATE ModuloExtra09 SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'ORG'   UPDATE Organiza     SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'RE'    UPDATE Recluta	     SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'ISL'   UPDATE ISL          SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'CAM'   UPDATE Cambio       SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'PACTO' UPDATE Contrato     SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID ELSE
    IF @Modulo = 'SAUX'	 UPDATE SAUX		 SET Usuario = NULLIF(RTRIM(@Usuario), '') WHERE ID = @ID

  COMMIT TRANSACTION
  RETURN 
END
GO

/************** spCancelarFlujo *************/
if exists (select * from sysobjects where id = object_id('dbo.spCancelarFlujo') and type = 'P') drop procedure dbo.spCancelarFlujo
GO
CREATE PROCEDURE spCancelarFlujo
                   @Empresa     	char(5),
                   @Modulo		char(5),
                   @ID			int,
				   @Ok			int	OUTPUT,
				   @CancelarHijos	bit	= 0,
				   @Usuario varchar(10)=NULL
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @DModulo	char(5),
    @DID	int

  IF @CancelarHijos = 1
  BEGIN
    DECLARE crMovFlujo CURSOR LOCAL FOR
      --REQ25300
      SELECT DModulo, DID FROM MovFlujo WHERE Empresa = @Empresa AND OModulo = @Modulo AND OID = @ID AND Cancelado = 0  AND DModulo <> 'CONTP'

    OPEN crMovFlujo
    FETCH NEXT FROM crMovFlujo INTO @DModulo, @DID
    WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
    BEGIN
      IF @@FETCH_STATUS <> -2 
        EXEC spAfectar @DModulo, @DID, 'CANCELAR', @EnSilencio = 1, @Conexion = 1,@Usuario=@Usuario, @Ok = @Ok OUTPUT

      FETCH NEXT FROM crMovFlujo INTO @DModulo, @DID
    END  -- While	
    CLOSE crMovFlujo
    DEALLOCATE crMovFlujo
  END
  
  UPDATE MovFlujo 
     SET Cancelado = 1
   WHERE Empresa = @Empresa AND OModulo = @Modulo AND OID = @ID AND Cancelado = 0 
  IF @@ERROR <> 0 SELECT @Ok = 1

  UPDATE MovFlujo 
     SET Cancelado = 1
   WHERE Empresa = @Empresa AND DModulo = @Modulo AND DID = @ID AND Cancelado = 0 
  IF @@ERROR <> 0 SELECT @Ok = 1

  RETURN 
END
GO

-- select * from fechatrabajo
-- update fechatrabajo set fechatrabajo= '8/5/2008'
-- spCerrarDia 'CASHF', 0, '9/5/2008', @Debug = 1
-- select * from empresa

/**************** spCancelaSaldosTarjetas ****************/
IF EXISTS (SELECT * FROM SysObjects WHERE id = OBJECT_ID('dbo.spValeCancelaSaldosTarjetas') AND type = 'P') DROP PROCEDURE dbo.spValeCancelaSaldosTarjetas
GO
CREATE PROCEDURE spValeCancelaSaldosTarjetas
	@Empresa			varchar(5),
	@Usuario			varchar(10),
	@Sucursal			int,
	@FechaEmision		datetime,
	@Ok					int = NULL		OUTPUT,
	@OkRef				varchar(255) = NULL		OUTPUT
--//WITH ENCRYPTION
AS
BEGIN
  DECLARE
  @ID			int,
  @Mov			varchar(20),
  @Moneda		varchar(10),
  @TipoCambio	float
	
  SELECT @Mov = 'Caducidad Saldo'

  SELECT @FechaEmision = dbo.fnFechaSinHora(@FechaEmision)
  SELECT @Moneda = ec.ContMoneda FROM EmpresaCfg ec WHERE ec.Empresa = @Empresa
  SELECT @TipoCambio = m.TipoCambio FROM Mon m WHERE m.Moneda = @Moneda
		
  INSERT INTO Vale
        (Empresa,  Mov,  FechaEmision,  Moneda,  TipoCambio,  Usuario, Observaciones, 
		   Estatus, Sucursal, SucursalOrigen)
  VALUES(@Empresa, @Mov, @FechaEmision, @Moneda, @TipoCambio, @Usuario, 'Caducidad Saldo - Cierre de Día', 
		   'SINAFECTAR', @Sucursal, @Sucursal)

  SELECT @ID = SCOPE_IDENTITY()
  
  INSERT INTO ValeD(ID, Serie, Sucursal, SucursalOrigen, Importe)
  SELECT @ID, Serie, @Sucursal, @Sucursal, dbo.fnVerSaldoVale(Serie)
	FROM ValeSerie
   WHERE dbo.fnVerSaldoVale(Serie) > 0 AND Empresa = @Empresa AND Moneda = @Moneda

  EXEC spAfectar 'VALE', @ID, 'AFECTAR', 'Todo', NULL, @Usuario, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT

END
GO

/**************** spCerrarDia ****************/
if exists (select * from sysobjects where id = object_id('dbo.spCerrarDia') and type = 'P') drop procedure dbo.spCerrarDia
GO
CREATE PROCEDURE spCerrarDia
    		   @Empresa	 char(5), 
                   @Sucursal	 int,
                   @Fecha	 datetime     = NULL,
		   @Usuario	 char(10)     = NULL,
		   @Estacion	 int	      = NULL,
		   @EnSilencio	 bit	      = 0,
                   @Ok		 int	      = NULL OUTPUT,
                   @OkRef	 varchar(255) = NULL OUTPUT,
		   @Debug	 bit	      = 0
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @AC							bit,
    @PC							bit,
    @OFER						bit,
    @PPTO						bit,
    @CMP						bit,
    @PACTO						bit,
    @PM							bit,
    @FechaTrabajo 				datetime,
    @DiasHabiles  				char(20),
    @CerrarSucursalAuto				bit,
    @CxcCaducidadTarjeta			bit,			-- MPFP Caducidad Saldos 19012009
    @CxcCaducidadTarjetaFecha			datetime,		-- MPFP Caducidad Saldos 19012009
    @Moneda					varchar(10),	-- MPFP Caducidad Saldos 19012009
    @TipoCambio					float,			-- MPFP Caducidad Saldos 19012009
    @Articulo					varchar(20),	-- MPFP Caducidad Saldos 19012009
    @Almacen					varchar(20),	-- MPFP Caducidad Saldos 19012009
    @UEN					int,
    @EsEcuador					bit,
    @TipoImpuesto				bit,
    @Notificacion				bit, --MEJORA5066
    
    --'CORTE'
    @Corte						bit


  SELECT @EsEcuador = ISNULL(EsEcuador,0) FROM Empresa WHERE Empresa = @Empresa

  SELECT @FechaTrabajo = NULL
  IF @Fecha IS NULL SELECT @Fecha = GETDATE()

  SELECT @AC = ISNULL(AC, 0), 
         @PC = ISNULL(PC, 0),
         @OFER = ISNULL(OFER, 0),
         @PPTO = ISNULL(PPTO, 0),
         @CMP = ISNULL(CMP, 0),
         @PACTO = ISNULL(PACTO, 0),
	 @PM = ISNULL(PM, 0),
         @CerrarSucursalAuto = ISNULL(CerrarSucursalAuto, 0),
         @DiasHabiles = UPPER(ISNULL(DiasHabiles, 'LUN-VIE')),
         @TipoImpuesto = ISNULL(TipoImpuesto,0),
         @Notificacion = ISNULL(Notificacion,0), --MEJORA5066
         -- 'CORTE'
         @Corte	= ISNULL(Corte,0)
   FROM EmpresaGral 
  WHERE Empresa = @Empresa
  
  SELECT @CxcCaducidadTarjeta = CxcCaducidadTarjeta,
		 @CxcCaducidadTarjetaFecha = CxcCaducidadTarjetaFecha
    FROM EmpresaCfg
   WHERE Empresa = @Empresa

  IF @CerrarSucursalAuto = 1
  BEGIN
    IF @Ok IS NULL EXEC spCerrarSucursalCajas  @Estacion, @Empresa, @Sucursal, @Usuario, @Fecha, @Ok OUTPUT, @OkRef OUTPUT
    IF @Ok IS NULL EXEC spCerrarSucursalVentas @Estacion, @Empresa, @Sucursal, @Usuario, @Fecha, @Ok OUTPUT, @OkRef OUTPUT
  END

  IF EXISTS(SELECT * FROM CtaDinero c, CtaDineroCajero j WHERE c.CtaDinero = j.CtaDinero AND c.Sucursal = @Sucursal AND j.Cajero IS NOT NULL) AND @Ok IS NULL
    SELECT @Ok = 22010

  IF EXISTS(SELECT * FROM Venta WHERE Estatus = 'PROCESAR' AND Sucursal = @Sucursal) AND @Ok IS NULL
    SELECT @Ok = 22020

  IF @Ok IS NULL
    EXEC xpCerrarDia @Empresa, @Fecha, @Ok OUTPUT
  IF @Ok IS NULL
  BEGIN
    EXEC spExtraerFecha @Fecha OUTPUT  
    SELECT @FechaTrabajo = FechaTrabajo FROM FechaTrabajo WHERE Empresa = @Empresa AND Sucursal = @Sucursal
    IF @FechaTrabajo IS NULL 
      SELECT @FechaTrabajo = @Fecha
    ELSE 
    IF @FechaTrabajo = @Fecha EXEC spCalcularDiasHabiles @Fecha, 1, @DiasHabiles, 0, @Fecha OUTPUT

    IF @Sucursal = 0
      EXEC spCtaSituacionProg @Empresa, @Sucursal, @Fecha, @Ok OUTPUT, @OkRef OUTPUT

    BEGIN TRANSACTION
      IF @Ok IS NULL
        EXEC spDineroGenerarIntereses @Sucursal, @Empresa, @Usuario, @FechaTrabajo, @Fecha, @Ok OUTPUT, @OkRef OUTPUT

      IF @Ok IS NULL AND @AC = 1
        EXEC spACCerrarDia @Sucursal, @Empresa, @Usuario, @FechaTrabajo, @Fecha, @Ok OUTPUT, @OkRef OUTPUT

      IF @Ok IS NULL AND @PC = 1
        EXEC spPCCerrarDia @Fecha, @Ok OUTPUT, @OkRef OUTPUT

      IF @Ok IS NULL AND @OFER = 1
        EXEC spOfertaCerrarDia @Fecha, @Ok OUTPUT, @OkRef OUTPUT

      IF @Ok IS NULL AND @CMP = 1
        EXEC spCampanaCerrarDia @Sucursal, @Empresa, @Usuario, @FechaTrabajo, @Fecha, @Ok OUTPUT, @OkRef OUTPUT

      IF @Ok IS NULL AND @PPTO = 1
        EXEC spPresupuestoCerrarDia @Sucursal, @Empresa, @Usuario, @FechaTrabajo, @Fecha, @Ok OUTPUT, @OkRef OUTPUT
      
      IF @Ok IS NULL
        EXEC spGastoConcluirPresupuestos @Empresa

      /*IF @Ok IS NULL
        EXEC spGenerarIntereses @Sucursal, @Empresa, @Usuario, @FechaTrabajo, @Fecha, @Ok OUTPUT, @OkRef OUTPUT*/

      IF @Ok IS NULL AND @PACTO = 1																	-- Linea Nueva!!
   	    EXEC spContratoCerrarDia @Fecha, @Ok OUTPUT, @OkRef OUTPUT

      IF @Ok IS NULL AND @PM = 1
        EXEC spProyectoCerrarDia @Sucursal, @Empresa, @Usuario, @FechaTrabajo, @Fecha, @Ok OUTPUT, @OkRef OUTPUT

-- MPFP 19012009 Caducidad Saldos
      IF @Ok IS NULL AND @Sucursal = 0 AND @CxcCaducidadTarjeta = 1 AND dbo.fnFechaSinHora(@Fecha) = dbo.fnFechaSinHora(@CxcCaducidadTarjetaFecha)
      BEGIN
        EXEC spValeCancelaSaldosTarjetas @Empresa, @Usuario, @Sucursal, @FechaTrabajo, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT
      END

      IF @Ok IS NULL AND @EsEcuador = 1
      BEGIN
        EXEC spTipoComprobanteCerrarDia @Fecha, @Ok OUTPUT, @OkRef OUTPUT
        
        IF @Ok IS NULL
          EXEC spSustentoComprobanteCerrarDia @Fecha, @Ok OUTPUT, @OkRef OUTPUT

        IF @Ok IS NULL
          EXEC spTipoRegistroCerrarDia @Fecha, @Ok OUTPUT, @OkRef OUTPUT
      END

      IF @Ok IS NULL AND @TipoImpuesto = 1
        EXEC spTipoImpuestoCerrarDia @Fecha, @Ok OUTPUT, @OkRef OUTPUT

      IF @Ok IS NULL AND @Notificacion = 1 --MEJORA5066
        EXEC spNotificacionCerrarDia @Sucursal, @Empresa, @Usuario, @Fecha, @Ok OUTPUT, @OkRef OUTPUT

      -- 'CORTE'
      IF @Ok IS NULL AND @Corte = 1
        EXEC spCorteCerrarDia @Sucursal, @Empresa, @Usuario, @Fecha, @Estacion, @Ok OUTPUT, @OkRef OUTPUT        
        
      IF @Ok IS NULL
      BEGIN
        UPDATE FechaTrabajo
           SET FechaTrabajo = @Fecha
         WHERE Empresa = @Empresa AND Sucursal = @Sucursal
  
        IF @@ROWCOUNT = 0 
         INSERT FechaTrabajo (Empresa, Sucursal, FechaTrabajo) VALUES (@Empresa, @Sucursal, @Fecha)
      END
    IF @Debug = 1
      ROLLBACK TRANSACTION
    ELSE
      COMMIT TRANSACTION
  END
  IF @Ok IS NULL
    EXEC xpCerrarDiaFinal @Empresa, @Fecha, @Ok OUTPUT

  IF @EnSilencio = 0
  BEGIN
    IF @Ok IS NULL  
    BEGIN
      SELECT @OkRef = 'Sucursal Cerrada.'
      SELECT @OkRef
    END ELSE
    BEGIN
      SELECT Descripcion+' '+RTRIM(@OkRef) 
        FROM MensajeLista
       WHERE Mensaje = @Ok  
    END
  END
  RETURN
END
GO

/************** spChecarConsignacion ***************/
if exists (select * from sysobjects where id = object_id('dbo.spChecarConsignacion') and type = 'P') drop procedure dbo.spChecarConsignacion
GO
CREATE PROCEDURE spChecarConsignacion
			@Empresa		char(5),
			@Sucursal		int,
			@Usuario		char(10),
			@Modulo			char(5), 
			@Mov			varchar(20), 
			@MovID			varchar(20),
			@Fecha			datetime, 
			@EjercicioAfectacion	int, 
			@PeriodoAfectacion	int,
			@Moneda			char(10),
			@Grupo			char(10),
			@SubGrupo		varchar(20),
			@Cuenta			varchar(20),
			@SubCuenta		varchar(50),
			@Cantidad		float,
			@Ok			int		OUTPUT,
			@OkRef			varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Existencia		float,
    @Faltante		float,
    @EnConsignacion	float,
    
    -- 10286
    @MovTipo		varchar(20)
    
  SELECT @MovTipo = Clave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov
  
  IF @MovTipo IN('VTAS.N') RETURN  

  SELECT @Existencia = 0.0, @Faltante = 0.0, @EnConsignacion = 0.0, @SubGrupo = ISNULL(@SubGrupo, ''), @SubCuenta = ISNULL(@SubCuenta, '')
  SELECT @Existencia = ISNULL(SUM(SaldoU), 0.0)
    FROM SaldoU
   WHERE /*Sucursal = @Sucursal AND */Empresa = @Empresa AND Rama = 'INV' AND Moneda = @Moneda AND Grupo = @Grupo AND Cuenta = @Cuenta AND ISNULL(SubCuenta, '') = ISNULL(@SubCuenta, '') AND ISNULL(SubGrupo, '') = ISNULL(@SubGrupo, '')

  IF @Cantidad > @Existencia SELECT @Faltante = @Cantidad - @Existencia
  IF @Faltante > 0.0
  BEGIN
    SELECT @EnConsignacion = ISNULL(SUM(SaldoU), 0.0) 
      FROM SaldoU
     WHERE Rama='CSG' AND Sucursal = @Sucursal AND Empresa = @Empresa AND Grupo = @Grupo AND Cuenta = @Cuenta AND ISNULL(SubCuenta, '') = ISNULL(@SubCuenta, '') AND ISNULL(SubGrupo, '') = ISNULL(@SubGrupo, '')

    IF @EnConsignacion >= @Faltante
    BEGIN
      EXEC spComprarConsignacion @Sucursal, @Empresa, @Usuario, @Cuenta, @SubCuenta, @Grupo, @SubGrupo, @Faltante, @Modulo, @Mov, @MovID,
                                 @Fecha, @EjercicioAfectacion, @PeriodoAfectacion,
                                 @Ok OUTPUT, @OkRef OUTPUT
    END
  END

  RETURN
END
GO

/*
declare
  @Consecutivo		varchar(20)
EXEC spConsecutivo 'Art', 0, @Consecutivo OUTPUT, @PrefijoEsp = 'A'
SELECT @Consecutivo
*/

/************** spComprarConsignacion ***************/
if exists (select * from sysobjects where id = object_id('dbo.spComprarConsignacion') and type = 'P') drop procedure dbo.spComprarConsignacion
GO
CREATE PROCEDURE spComprarConsignacion
			@Sucursal		int,
		    	@Empresa		char(5), 
                        @Usuario		char(10),
	           	@Articulo		char(20),
	           	@SubCuenta		varchar(50),
	           	@Almacen		char(10),
	           	@Tarima			varchar(20),
			@Cantidad		float,
 		        @Modulo			char(5),
			@Mov			char(20),
			@MovID			varchar(20),
                        @FechaRegistro		datetime, 
			@Ejercicio		int, 
			@Periodo		int,

   		   	@Ok                	int          OUTPUT,
			@OkRef			varchar(255) OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @OrigenID			int,
    @ID  			int,
    @UltID			int,
    @ContID			int,
    @Renglon			float,
    @RenglonID			int,
    @Requiere   		float,
    @Obtenido			float,
    @Posicion			varchar(10),
    @Aplica			char(20),
    @UltAplica			char(20),
    @AplicaID			varchar(20),
    @UltAplicaID		varchar(20),
    @PendienteInventario	float,
    @Costo			money, 
    @MovUnidad			varchar(50),
    @Factor			float,
    @DescTipo			char(1), 
    @Desc			money, 
    @Impuesto1			float, 
    @Impuesto2			float, 
    @Impuesto3			money, 
    @DescExtra			varchar(255), 
    @DestinoTipo 		char(20), 
    @Destino			char(20),
    @DestinoID   		varchar(20),
    @GenerarMov 		char(20), 
    @GenerarMovID 		varchar(20),
    @FechaCaducidad		datetime

  SELECT @Requiere = @Cantidad, @UltID = NULL, @UltAplica = NULL, @UltAplicaID = NULL, @SubCuenta = NULLIF(RTRIM(@SubCuenta), '')
  SELECT @GenerarMov = CompraEntrada FROM EmpresaCfgMov WHERE Empresa = @Empresa 
  SELECT @OrigenID = dbo.fnModuloID (@Empresa, @Modulo, @Mov, @MovID, @Ejercicio, @Periodo)

  DECLARE crComprarConsig CURSOR
    FOR SELECT Compra.Mov, Compra.MovID, CompraD.Posicion, ISNULL(CompraD.CantidadPendiente*NULLIF(CompraD.Factor, 0.0), 0.0), CompraD.Unidad, CompraD.Factor, CompraD.Costo, CompraD.DescuentoTipo, CompraD.DescuentoLinea, CompraD.Impuesto1, CompraD.Impuesto2, CompraD.Impuesto3, CompraD.DescripcionExtra, CompraD.DestinoTipo, CompraD.Destino, CompraD.DestinoID, CompraD.FechaCaducidad
          FROM CompraD, Compra, MovTipo
         WHERE Compra.Estatus = 'PENDIENTE'
           AND MovTipo.Mov = Compra.Mov
           AND MovTipo.Clave = 'COMS.CC'
	   AND CompraD.ID = Compra.ID
           AND CompraD.Almacen = @Almacen
	   AND CompraD.Articulo = @Articulo
	   AND ISNULL(CompraD.SubCuenta, '') = ISNULL(@SubCuenta, '')
	   AND ISNULL(CompraD.Tarima, '') = ISNULL(@Tarima, '')
	   AND CompraD.CantidadPendiente > 0.0
         ORDER BY Compra.Mov, Compra.MovID

  OPEN crComprarConsig
  FETCH NEXT FROM crComprarConsig INTO @Aplica, @AplicaID, @Posicion, @PendienteInventario, @MovUnidad, @Factor, @Costo, @DescTipo, @Desc, @Impuesto1, @Impuesto2, @Impuesto3, @DescExtra, @DestinoTipo, @Destino, @DestinoID, @FechaCaducidad
  IF @@ERROR <> 0 SELECT @Ok = 1

  WHILE @@FETCH_STATUS <> -1 AND @OK IS NULL AND @Requiere > 0 
  BEGIN
    IF @@FETCH_STATUS <> -2 
    BEGIN
      IF @Aplica <> @UltAplica OR @AplicaID <> @UltAplicaID 
      BEGIN
        IF @UltID IS NOT NULL
          EXEC spInv @UltID, 'COMS', 'AFECTAR', 'TODO', @FechaRegistro, NULL, @Usuario, 1, 0, NULL,
                     @UltAplica OUTPUT, @UltAplicaID OUTPUT, @ID OUTPUT, @ContID OUTPUT,
                     @Ok OUTPUT, @OkRef OUTPUT, 0 

        IF @Ok IS NULL
        BEGIN
  	  SELECT @GenerarMovID = NULL
          EXEC spMovGenerar @Sucursal, @Empresa, 'COMS', @Ejercicio, @Periodo, @Usuario, @FechaRegistro, 'SINAFECTAR', 
	                    @Almacen, NULL, 
			    @Aplica, @AplicaID, 0,
			    @GenerarMov, NULL, @GenerarMovID OUTPUT, @ID OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
          SELECT @Renglon = 0, @RenglonID = 0, @UltAplica = @Aplica, @UltAplicaID = @AplicaID, @UltID = @ID
          UPDATE Compra SET OrigenTipo = @Modulo, Origen = @Mov, OrigenID = @MovID WHERE ID = @ID
        END
      END
      IF @Requiere < @PendienteInventario
        SELECT @Obtenido = @Requiere	
      ELSE
        SELECT @Obtenido = @PendienteInventario	

      SELECT @Requiere = @Requiere - @Obtenido, @Renglon = @Renglon + 2048, @RenglonID = @RenglonID + 1
      IF @OK IS NULL
      BEGIN
        INSERT INTO CompraD (Sucursal, ID,  Renglon,  RenglonSub, RenglonID,  Aplica,  AplicaID,  Posicion,  Almacen,  Tarima,  Articulo,  SubCuenta,  Cantidad,          Unidad,     Factor,  CantidadInventario, Costo,  DescuentoTipo, DescuentoLinea, Impuesto1,  Impuesto2,  Impuesto3,  DescripcionExtra, DestinoTipo,  Destino,  DestinoID, FechaCaducidad)
                     VALUES (@Sucursal, @ID, @Renglon, 0,         @RenglonID, @Aplica, @AplicaID, @Posicion, @Almacen, @Tarima, @Articulo, @SubCuenta, @Obtenido/@Factor, @MovUnidad, @Factor, @Obtenido,          @Costo, @DescTipo,     @Desc,          @Impuesto1, @Impuesto2, @Impuesto3, @DescExtra,       @DestinoTipo, @Destino, @DestinoID, @FechaCaducidad)

        IF (SELECT Tipo FROM Art WHERE Articulo = @Articulo) IN ('SERIE', 'LOTE', 'VIN', 'PARTIDA')
          INSERT SerieLoteMov (Empresa,  Sucursal,  Modulo, ID,  RenglonID,  Articulo,  SubCuenta,              SerieLote, Cantidad, ArtCostoInv) 
                       SELECT  @Empresa, @Sucursal, 'COMS', @ID, @RenglonID, @Articulo, ISNULL(@SubCuenta, ''), SerieLote, Cantidad, ArtCostoInv
                         FROM fnSerieLoteMovParcialConExistencia (@Empresa, @Modulo, @OrigenID, @Articulo, @SubCuenta, @Obtenido, @Almacen)
      END
      IF @@ERROR <> 0 SELECT @Ok = 1
    END
    IF @Requiere > 0 
      FETCH NEXT FROM crComprarConsig INTO @Aplica, @AplicaID, @Posicion, @PendienteInventario, @MovUnidad, @Factor, @Costo, @DescTipo, @Desc, @Impuesto1, @Impuesto2, @Impuesto3, @DescExtra, @DestinoTipo, @Destino, @DestinoID, @FechaCaducidad
    IF @@ERROR <> 0 SELECT @Ok = 1
  END
  CLOSE crComprarConsig
  DEALLOCATE crComprarConsig
  IF @Requiere = 0 
    IF @UltID IS NOT NULL
      EXEC spInv @UltID, 'COMS', 'AFECTAR', 'TODO', @FechaRegistro, NULL, @Usuario, 1, 0, NULL,
                 @UltAplica OUTPUT, @UltAplicaID OUTPUT, @ID OUTPUT, @ContID OUTPUT,
                 @Ok OUTPUT, @OkRef OUTPUT, 0
  ELSE 
    IF @Ok IS NULL SELECT @Ok = 30130 
END
GO

/************** spConsecutivo *************/
if exists (select * from sysobjects where id = object_id('dbo.spConsecutivo') and type = 'P') drop procedure dbo.spConsecutivo
GO
CREATE PROCEDURE spConsecutivo
		   @Tipo		char(20),
		   @Sucursal		int,
		   @Consecutivo		varchar(20)		OUTPUT,
                   @Maximo              int          = NULL,		
		   @Referencia		varchar(50)  = NULL	OUTPUT,
		   @Ok			int	     = NULL	OUTPUT,
		   @OkRef		varchar(255) = NULL	OUTPUT,
		   @PrefijoEsp		varchar(10)  = NULL,
		   @AutoGenerar		bit	     = 0
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Nivel 		char(20),
    @Prefijo		char(10),
    @UltConsecutivo	int,
    @TieneControl	bit,
    @Concurrencia	varchar(20),
    @Tabla		varchar(100),
    @SQL		nvarchar(4000)

  SELECT @UltConsecutivo = NULL, @Consecutivo = NULL, @Prefijo = NULL, @Referencia = NULL

  BEGIN TRANSACTION
    SELECT @Nivel = UPPER(Nivel),
           @Prefijo = ISNULL(RTRIM(Prefijo), ''),
           @TieneControl = ISNULL(TieneControl, 0),
           @Concurrencia = UPPER(ISNULL(RTRIM(Concurrencia), '')),
           @UltConsecutivo = ISNULL(Consecutivo, 0)
      FROM Consecutivo
     WHERE Tipo = @Tipo
    IF @@ROWCOUNT = 0 AND @AutoGenerar = 1
    BEGIN
      SELECT @Nivel = 'Global', @Concurrencia = 'Normal'
      INSERT Consecutivo (Tipo, Nivel, Concurrencia) VALUES (@Tipo, @Nivel, @Concurrencia)
    END

    IF @PrefijoEsp IS NOT NULL SELECT @Prefijo = @PrefijoEsp

    IF @Concurrencia = 'ALTA'
    BEGIN
      SELECT @Tabla = 'Consecutivo/'+CONVERT(varchar(20), @Tipo) 
      IF @Prefijo <> '' SELECT @Tabla = @Tabla + '/' + CONVERT(varchar(20), @Prefijo)
      IF @Nivel = 'SUCURSAL' SELECT @Tabla = @Tabla + '/S' + CONVERT(varchar, @Sucursal)
      IF NOT EXISTS (SELECT * FROM sysobjects where id = object_id(@Tabla) and type = 'U') 
      BEGIN
        SELECT @SQL = N'CREATE TABLE ['+@Tabla+'] (Consecutivo int IDENTITY('+CONVERT(varchar, ISNULL(@UltConsecutivo, 0) + 1)+', 1) NOT NULL PRIMARY KEY, Fecha datetime NULL DEFAULT GETDATE())'
        EXEC sp_ExecuteSQL @SQL
      END
      SELECT @SQL = N'INSERT ['+@Tabla+'] (Fecha) VALUES (DEFAULT) SELECT @UltConsecutivo=SCOPE_IDENTITY()'
      EXEC sp_ExecuteSQL @SQL, N'@UltConsecutivo int OUTPUT', @UltConsecutivo OUTPUT
    END ELSE
    BEGIN
      IF @Nivel = 'SUCURSAL'
      BEGIN
        UPDATE ConsecutivoSucursal WITH (ROWLOCK) 
           SET @UltConsecutivo = Consecutivo = ISNULL(Consecutivo, 0) + 1
         WHERE Tipo = @Tipo AND Sucursal = @Sucursal
        IF @@ROWCOUNT = 0
          INSERT ConsecutivoSucursal (Tipo, Sucursal, Consecutivo) VALUES (@Tipo, @Sucursal, 1)

        IF @UltConsecutivo > @Maximo
          UPDATE ConsecutivoSucursal WITH (ROWLOCK) 
             SET @UltConsecutivo = Consecutivo = 1
           WHERE Tipo = @Tipo AND Sucursal = @Sucursal

        SELECT @Prefijo = Prefijo FROM Sucursal WHERE Sucursal = @Sucursal     
      END ELSE
      BEGIN      
        UPDATE Consecutivo WITH (ROWLOCK) 
           SET @UltConsecutivo = Consecutivo = ISNULL(Consecutivo, 0) + 1
         WHERE Tipo = @Tipo 

        IF @UltConsecutivo > @Maximo
          UPDATE Consecutivo WITH (ROWLOCK) 
             SET @UltConsecutivo = Consecutivo = 1
           WHERE Tipo = @Tipo
      END
    END
    IF @UltConsecutivo > 0 
      SELECT @Consecutivo = RTRIM(@Prefijo) + CONVERT(varchar, @UltConsecutivo)

    IF @TieneControl = 1
    BEGIN
      SELECT @Referencia = MIN(Referencia) FROM ConsecutivoControl WHERE Tipo = @Tipo AND Estatus = 'ALTA' AND @UltConsecutivo BETWEEN ConsecutivoD AND ConsecutivoA
      IF @@ROWCOUNT = 0 SELECT @Ok = 30012, @OkRef = @Tipo
    END

    EXEC xpConsecutivo @Tipo, @Sucursal, @Consecutivo OUTPUT, @Maximo, @Referencia OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
  IF @Ok IS NULL
    COMMIT TRANSACTION
  ELSE
    ROLLBACK TRANSACTION
  RETURN 
END
GO
-- select * from consecutivo

-- spVerConsecutivo 'BX', 0
/************** spVerConsecutivo *************/
if exists (select * from sysobjects where id = object_id('dbo.spVerConsecutivo') and type = 'P') drop procedure dbo.spVerConsecutivo
GO
CREATE PROCEDURE spVerConsecutivo
		   @Tipo		char(20),
		   @Sucursal		int = NULL
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Consecutivo char(20)
  EXEC spConsecutivo @Tipo, @Sucursal, @Consecutivo OUTPUT
  SELECT @Consecutivo
  RETURN 
END
GO

/************** spConsecutivoActualizar *************/
if exists (select * from sysobjects where id = object_id('dbo.spConsecutivoActualizar') and type = 'P') drop procedure dbo.spConsecutivoActualizar
GO
CREATE PROCEDURE spConsecutivoActualizar
                   @Modulo		char(5),
		   @ID			int,
                   @MovID      		varchar(20)
--//WITH ENCRYPTION
AS BEGIN
  IF @Modulo = 'CONT'  UPDATE Cont         SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'VTAS'  UPDATE Venta        SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'PROD'  UPDATE Prod         SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'COMS'  UPDATE Compra       SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'INV'   UPDATE Inv          SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'CXC'   UPDATE Cxc          SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'CXP'   UPDATE Cxp          SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'AGENT' UPDATE Agent        SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'GAS'   UPDATE Gasto        SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'DIN'   UPDATE Dinero       SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'EMB'   UPDATE Embarque     SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'NOM'   UPDATE Nomina       SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'RH'    UPDATE RH           SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'ASIS'  UPDATE Asiste       SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'AF'    UPDATE ActivoFijo   SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'PC'    UPDATE PC           SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'OFER'  UPDATE Oferta       SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'VALE'  UPDATE Vale         SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'CR'    UPDATE CR           SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'ST'    UPDATE Soporte      SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'CAP'   UPDATE Capital      SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'INC'   UPDATE Incidencia   SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'CONC'  UPDATE Conciliacion SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'PPTO'  UPDATE Presup       SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'CREDI' UPDATE Credito      SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'TMA'   UPDATE TMA          SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'RSS'   UPDATE RSS          SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'CMP'   UPDATE Campana      SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'FIS'   UPDATE Fiscal       SET MovID = @MovID WHERE ID = @ID ELSE
  --REQ25014
  IF @Modulo = 'CONTP' UPDATE ContParalela SET MovID = @MovID WHERE ID = @ID ELSE  
  --REQ16092
  IF @Modulo = 'OPORT' UPDATE Oportunidad  SET MovID = @MovID WHERE ID = @ID ELSE  
  IF @Modulo = 'CORTE' UPDATE Corte        SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'FRM'   UPDATE FormaExtra   SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'CAPT'  UPDATE Captura      SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'GES'   UPDATE Gestion      SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'CP'    UPDATE CP           SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'PCP'   UPDATE PCP          SET MovID = @MovID WHERE ID = @ID ELSE  
  IF @Modulo = 'PROY'  UPDATE Proyecto     SET MovID = @MovID WHERE ID = @ID ELSE
  --IF @Modulo = 'ACT'   UPDATE Act           SET MovID = @MovID WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX01' UPDATE ModuloExtra01 SET MovID = @MovID WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX02' UPDATE ModuloExtra02 SET MovID = @MovID WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX03' UPDATE ModuloExtra03 SET MovID = @MovID WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX04' UPDATE ModuloExtra04 SET MovID = @MovID WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX05' UPDATE ModuloExtra05 SET MovID = @MovID WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX06' UPDATE ModuloExtra06 SET MovID = @MovID WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX07' UPDATE ModuloExtra07 SET MovID = @MovID WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX08' UPDATE ModuloExtra08 SET MovID = @MovID WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX09' UPDATE ModuloExtra09 SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'ORG'   UPDATE Organiza     SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'RE'    UPDATE Recluta	   SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'ISL'   UPDATE ISL          SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'CAM'   UPDATE Cambio       SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'PACTO' UPDATE Contrato	   SET MovID = @MovID WHERE ID = @ID ELSE
  IF @Modulo = 'SAUX'  UPDATE SAUX		   SET MovID = @MovID WHERE ID = @ID 
  RETURN 
END
GO

/************** spConsecutivoAuto *************/
if exists (select * from sysobjects where id = object_id('dbo.spConsecutivoAuto') and type = 'P') drop procedure dbo.spConsecutivoAuto
GO
CREATE PROCEDURE spConsecutivoAuto
		   @Sucursal		int,
                   @Empresa     	char(5),
                   @Modulo		char(5),
                   @Mov      		char(20),
                   @Ejercicio	        int,
                   @Periodo	        int,
		   @Serie		varchar(50),
                   @MovID		varchar(20)	OUTPUT,
		   @Ok			int		OUTPUT,
		   @OkRef		varchar(255)	OUTPUT,
		   @CFD			bit		OUTPUT,
		   @SubFoliosOrigen	bit = 0,
		   @ConsecutivoUnico	bit = 0,
		   @ID			int = NULL                   
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @Consecutivo		bigint,
    @ConsecutivoPorPeriodo	bit,
    @ConsecutivoPorEjercicio	bit,
    @ConsecutivoPorEmpresa	char(20),
    @ConsecutivoSerial		bit,
    @ConsecutivoDigitos		int,
    @ConsecutivoSucursalEsp	bit,
    @SucursalEsp		int,
    @ModuloAfectacion		char(5),
    @MovAfectacion		varchar(20),
    @MovIDSt			char(20),
    @TipoConsecutivo		varchar(20),
    @ConsecutivoGeneral		varchar(20)
    

  IF @MovID IS NULL 
    EXEC xpConsecutivoAuto @Sucursal OUTPUT, @Empresa OUTPUT, @Modulo OUTPUT, @Mov OUTPUT, @Ejercicio OUTPUT, @Periodo OUTPUT, @Serie OUTPUT, @MovID OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @CFD OUTPUT

  IF @MovID IS NULL 
  BEGIN
    SELECT @ModuloAfectacion 	    = @Modulo,
           @MovAfectacion	    = @Mov

    IF @SubFoliosOrigen = 1 OR @ConsecutivoUnico = 1
      SELECT @ConsecutivoPorPeriodo   = 0,
             @ConsecutivoPorEjercicio = 0,
             @ConsecutivoPorEmpresa   = 'SI',
             @ConsecutivoSucursalEsp  = 0,
             @SucursalEsp             = NULL,
             @ConsecutivoSerial       = 0,
             @ConsecutivoDigitos      = NULL
    ELSE    
      SELECT @Modulo 		      = ConsecutivoModulo,
             @Mov    		      = ConsecutivoMov,
             @ConsecutivoPorPeriodo   = ConsecutivoPorPeriodo,
             @ConsecutivoPorEjercicio = ConsecutivoPorEjercicio,
             @ConsecutivoPorEmpresa   = ISNULL(UPPER(ConsecutivoPorEmpresa), 'SI'),
             @ConsecutivoSucursalEsp  = ISNULL(ConsecutivoSucursalEsp, 0),
             @SucursalEsp             = SucursalEsp,
             @TipoConsecutivo	      = UPPER(TipoConsecutivo),
             @ConsecutivoGeneral      = ConsecutivoGeneral
        FROM MovTipo
       WHERE Modulo = @Modulo
         AND Mov    = @Mov

    IF @TipoConsecutivo = 'GENERAL'
     EXEC spConsecutivo @ConsecutivoGeneral, @Sucursal, @MovID OUTPUT, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT
    ELSE 
    BEGIN
      EXEC spMovTipoCFD @Empresa, @ModuloAfectacion, @MovAfectacion, @CFD OUTPUT
      IF @CFD = 1
        EXEC spCFDFolio @Sucursal, @Empresa, @Modulo, @Mov, @MovID OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @ModuloAfectacion, @ID
      ELSE 
      BEGIN
        IF @SubFoliosOrigen = 0
          SELECT @ConsecutivoSerial  = ConsecutivoSerial, 
                 @ConsecutivoDigitos = ConsecutivoDigitos 
            FROM EmpresaGral 
           WHERE Empresa = @Empresa

        IF @ConsecutivoPorPeriodo   = 0 SELECT @Periodo = NULL
        IF @ConsecutivoPorEjercicio = 0 SELECT @Ejercicio = NULL
        IF @ConsecutivoPorEmpresa   = 'NO'    SELECT @Empresa = NULL ELSE
        IF @ConsecutivoPorEmpresa   = 'GRUPO' SELECT @Empresa = Clave FROM EmpresaGrupo, Empresa WHERE EmpresaGrupo.Grupo = Empresa.Grupo AND Empresa.Empresa = @Empresa
        IF @ConsecutivoSucursalEsp = 1 AND @SucursalEsp IS NOT NULL SELECT @Sucursal = @SucursalEsp

        IF @Modulo = 'CONT'  UPDATE ContC         WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'VTAS'  UPDATE VentaC        WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'PROD'  UPDATE ProdC         WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'COMS'  UPDATE CompraC       WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'INV'   UPDATE InvC          WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'CXC'   UPDATE CxcC          WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'CXP'   UPDATE CxpC          WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'AGENT' UPDATE AgentC        WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'GAS'   UPDATE GastoC        WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'DIN'   UPDATE DineroC       WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'EMB'   UPDATE EmbarqueC     WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'NOM'   UPDATE NominaC       WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'RH'    UPDATE RHC 	  WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'ASIS'  UPDATE AsisteC       WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'AF'    UPDATE ActivoFijoC   WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'PC'    UPDATE PCC           WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'OFER'  UPDATE OfertaC       WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'VALE'  UPDATE ValeC         WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'CR'    UPDATE CRC           WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'ST'    UPDATE SoporteC      WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'CAP'   UPDATE CapitalC      WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'INC'   UPDATE IncidenciaC   WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'CONC'  UPDATE ConciliacionC WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'PPTO'  UPDATE PresupC 	  WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'CREDI' UPDATE CreditoC 	  WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'TMA'   UPDATE TMAC          WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'RSS'   UPDATE RSSC          WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'CMP'   UPDATE CampanaC      WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'FIS'   UPDATE FiscalC       WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        --REQ25014
        IF @Modulo = 'CONTP' UPDATE ContParalelaC WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE        
        --REQ16092
		IF @Modulo = 'OPORT' UPDATE OportunidadC  WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE		
        IF @Modulo = 'CORTE' UPDATE CorteC        WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'FRM'   UPDATE FormaExtraC   WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'CAPT'  UPDATE CapturaC      WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'GES'   UPDATE GestionC      WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'CP'    UPDATE CPC           WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
        IF @Modulo = 'PCP'    UPDATE PCPC         WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE        
        IF @Modulo = 'PROY'  UPDATE ProyectoC     WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	--IF @Modulo = 'ACT'   UPDATE ActC           WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	--IF @Modulo = 'MEX01' UPDATE ModuloExtra01C WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	--IF @Modulo = 'MEX02' UPDATE ModuloExtra02C WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	--IF @Modulo = 'MEX03' UPDATE ModuloExtra03C WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	--IF @Modulo = 'MEX04' UPDATE ModuloExtra04C WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	--IF @Modulo = 'MEX05' UPDATE ModuloExtra05C WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	--IF @Modulo = 'MEX06' UPDATE ModuloExtra06C WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	--IF @Modulo = 'MEX07' UPDATE ModuloExtra07C WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	--IF @Modulo = 'MEX08' UPDATE ModuloExtra08C WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	--IF @Modulo = 'MEX09' UPDATE ModuloExtra09C WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	IF @Modulo = 'ORG'   UPDATE OrganizaC		WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	IF @Modulo = 'RE'    UPDATE ReclutaC		WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	IF @Modulo = 'ISL'   UPDATE ISLC			WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'CAM'   UPDATE CambioC			WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	IF @Modulo = 'PACTO' UPDATE ContratoC		WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
	IF @Modulo = 'SAUX'  UPDATE SAUXC			WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
     IF @Modulo = 'PREV'  UPDATE PrevencionLDC   WITH (ROWLOCK) SET Consecutivo = Consecutivo + 1 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo 
        IF @@ERROR <> 0 SELECT @Ok = 1
        EXEC spConsecutivoUltimo @Sucursal, @Empresa, @Modulo, @Mov, @Ejercicio, @Periodo, @Serie, @Consecutivo OUTPUT, @Ok OUTPUT

        IF NULLIF(@Consecutivo, 0) = NULL AND @Ok IS NULL
        BEGIN
          IF @Modulo = 'CONT'  INSERT INTO ContC         (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'VTAS'  INSERT INTO VentaC        (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'PROD'  INSERT INTO ProdC         (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'COMS'  INSERT INTO CompraC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'INV'   INSERT INTO InvC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'CXC'   INSERT INTO CxcC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'CXP'   INSERT INTO CxpC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'AGENT' INSERT INTO AgentC        (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'GAS'   INSERT INTO GastoC        (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'DIN'   INSERT INTO DineroC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'EMB'   INSERT INTO EmbarqueC     (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'NOM'   INSERT INTO NominaC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'RH'    INSERT INTO RHC           (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'ASIS'  INSERT INTO AsisteC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'AF'    INSERT INTO ActivoFijoC   (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'PC'    INSERT INTO PCC           (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'OFER'  INSERT INTO OfertaC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'VALE'  INSERT INTO ValeC         (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'CR'    INSERT INTO CRC           (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'ST'    INSERT INTO SoporteC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'CAP'   INSERT INTO CapitalC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'INC'   INSERT INTO IncidenciaC   (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'CONC'  INSERT INTO ConciliacionC (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'PPTO'  INSERT INTO PresupC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'CREDI' INSERT INTO CreditoC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'TMA'   INSERT INTO TMAC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'RSS'   INSERT INTO RSSC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'CMP'   INSERT INTO CampanaC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'FIS'   INSERT INTO FiscalC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          --REQ25014
          IF @Modulo = 'CONTP' INSERT INTO ContParalelaC (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE          
          --REQ16092
		  IF @Modulo = 'OPORT' INSERT INTO OportunidadC  (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE		  
          IF @Modulo = 'CORTE' INSERT INTO CorteC        (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'FRM'   INSERT INTO FormaExtraC   (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'CAPT'  INSERT INTO CapturaC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'GES'   INSERT INTO GestionC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'CP'    INSERT INTO CPC           (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'PCP'   INSERT INTO PCPC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE          
          IF @Modulo = 'PROY'  INSERT INTO ProyectoC     (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
	--IF @Modulo = 'ACT'   INSERT INTO ActC           (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
	--IF @Modulo = 'MEX01' INSERT INTO ModuloExtra01C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
	--IF @Modulo = 'MEX02' INSERT INTO ModuloExtra02C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
	--IF @Modulo = 'MEX03' INSERT INTO ModuloExtra03C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
	--IF @Modulo = 'MEX04' INSERT INTO ModuloExtra04C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
	--IF @Modulo = 'MEX05' INSERT INTO ModuloExtra05C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
	--IF @Modulo = 'MEX06' INSERT INTO ModuloExtra06C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
	--IF @Modulo = 'MEX07' INSERT INTO ModuloExtra07C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
	--IF @Modulo = 'MEX08' INSERT INTO ModuloExtra08C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
	--IF @Modulo = 'MEX09' INSERT INTO ModuloExtra09C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'ORG'   INSERT INTO OrganizaC     (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'RE'    INSERT INTO ReclutaC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'ISL'   INSERT INTO ISLC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'CAM'   INSERT INTO CambioC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'PACTO' INSERT INTO ContratoC     (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'SAUX'  INSERT INTO SAUXC         (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1) ELSE
          IF @Modulo = 'PREV'  INSERT INTO PrevencionLDC     (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, 1)
          IF @@ERROR <> 0 SELECT @Ok = 1

          SELECT @Consecutivo = 1
        END 

--      SELECT @MovID = CONVERT(varchar, @Consecutivo)
        SELECT @MovID = dbo.fnConsecutivoEnMovID(@Sucursal, @Empresa, @Modulo, @Mov, @Ejercicio, @Periodo, @Serie, @Consecutivo)

        IF @SubFoliosOrigen = 1
        BEGIN
          SELECT @MovID = ISNULL(@Serie, '') + @MovID
        END ELSE
        IF @ConsecutivoSerial = 1 
        BEGIN
          SELECT @Serie = LTRIM(RTRIM(@Serie))
          IF @Serie IS NOT NULL AND dbo.fnEsNumerico(@Serie) = 1
          BEGIN
            EXEC spLlenarCeros @MovID, @ConsecutivoDigitos, @MovIDSt OUTPUT
            SELECT @MovID = CONVERT(int, LTRIM(RTRIM(@Serie)) + RTRIM(LTRIM(@MovIDSt)))
          END
        END
      END
    END
  END
  RETURN 
END
GO

/************** spConsecutivoUltimo *************/
if exists (select * from sysobjects where id = object_id('dbo.spConsecutivoUltimo') and type = 'P') drop procedure dbo.spConsecutivoUltimo
GO
CREATE PROCEDURE spConsecutivoUltimo
		   @Sucursal		int,
                   @Empresa     	char(5),
                   @Modulo		char(5),
                   @Mov      		char(20),
                   @Ejercicio	        int,
                   @Periodo	        int,
		   @Serie		varchar(50),
                   @Consecutivo		bigint		OUTPUT,
		   @Ok			int		OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  SELECT @Consecutivo = NULL
  IF @Modulo = 'CONT'  SELECT @Consecutivo = MAX(Consecutivo) FROM ContC         WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'VTAS'  SELECT @Consecutivo = MAX(Consecutivo) FROM VentaC        WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'PROD'  SELECT @Consecutivo = MAX(Consecutivo) FROM ProdC         WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'COMS'  SELECT @Consecutivo = MAX(Consecutivo) FROM CompraC       WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'INV'   SELECT @Consecutivo = MAX(Consecutivo) FROM InvC          WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'CXC'   SELECT @Consecutivo = MAX(Consecutivo) FROM CxcC          WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'CXP'   SELECT @Consecutivo = MAX(Consecutivo) FROM CxpC          WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'AGENT' SELECT @Consecutivo = MAX(Consecutivo) FROM AgentC        WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'GAS'   SELECT @Consecutivo = MAX(Consecutivo) FROM GastoC        WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'DIN'   SELECT @Consecutivo = MAX(Consecutivo) FROM DineroC       WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'EMB'   SELECT @Consecutivo = MAX(Consecutivo) FROM EmbarqueC     WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'NOM'   SELECT @Consecutivo = MAX(Consecutivo) FROM NominaC       WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'RH'    SELECT @Consecutivo = MAX(Consecutivo) FROM RHC           WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'ASIS'  SELECT @Consecutivo = MAX(Consecutivo) FROM AsisteC       WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'AF'    SELECT @Consecutivo = MAX(Consecutivo) FROM ActivoFijoC   WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'PC'    SELECT @Consecutivo = MAX(Consecutivo) FROM PCC           WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'OFER'  SELECT @Consecutivo = MAX(Consecutivo) FROM OfertaC       WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'VALE'  SELECT @Consecutivo = MAX(Consecutivo) FROM ValeC         WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'CR'    SELECT @Consecutivo = MAX(Consecutivo) FROM CRC           WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'ST'    SELECT @Consecutivo = MAX(Consecutivo) FROM SoporteC      WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'CAP'   SELECT @Consecutivo = MAX(Consecutivo) FROM CapitalC      WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'INC'   SELECT @Consecutivo = MAX(Consecutivo) FROM IncidenciaC   WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'CONC'  SELECT @Consecutivo = MAX(Consecutivo) FROM ConciliacionC WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'PPTO'  SELECT @Consecutivo = MAX(Consecutivo) FROM PresupC 	 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'CREDI' SELECT @Consecutivo = MAX(Consecutivo) FROM CreditoC 	 WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'TMA'   SELECT @Consecutivo = MAX(Consecutivo) FROM TMAC          WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'RSS'   SELECT @Consecutivo = MAX(Consecutivo) FROM RSSC          WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'CMP'   SELECT @Consecutivo = MAX(Consecutivo) FROM CampanaC      WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'FIS'   SELECT @Consecutivo = MAX(Consecutivo) FROM FiscalC       WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  --REQ25014
  IF @Modulo = 'CONTP' SELECT @Consecutivo = MAX(Consecutivo) FROM ContParalelaC WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE  
  --REQ16092
  IF @Modulo = 'OPORT' SELECT @Consecutivo = MAX(Consecutivo) FROM OportunidadC  WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE  
  IF @Modulo = 'CORTE' SELECT @Consecutivo = MAX(Consecutivo) FROM CorteC        WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'FRM'   SELECT @Consecutivo = MAX(Consecutivo) FROM FormaExtraC   WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'CAPT'  SELECT @Consecutivo = MAX(Consecutivo) FROM CapturaC      WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'GES'   SELECT @Consecutivo = MAX(Consecutivo) FROM GestionC      WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'CP'    SELECT @Consecutivo = MAX(Consecutivo) FROM CPC           WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'PCP'   SELECT @Consecutivo = MAX(Consecutivo) FROM PCPC          WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE  
  IF @Modulo = 'PROY'  SELECT @Consecutivo = MAX(Consecutivo) FROM ProyectoC     WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
--IF @Modulo = 'ACT'   SELECT @Consecutivo = MAX(Consecutivo) FROM ActC		  WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
--IF @Modulo = 'MEX01' SELECT @Consecutivo = MAX(Consecutivo) FROM ModuloExtra01C WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
--IF @Modulo = 'MEX02' SELECT @Consecutivo = MAX(Consecutivo) FROM ModuloExtra02C WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
--IF @Modulo = 'MEX03' SELECT @Consecutivo = MAX(Consecutivo) FROM ModuloExtra03C WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
--IF @Modulo = 'MEX04' SELECT @Consecutivo = MAX(Consecutivo) FROM ModuloExtra04C WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
--IF @Modulo = 'MEX05' SELECT @Consecutivo = MAX(Consecutivo) FROM ModuloExtra05C WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
--IF @Modulo = 'MEX06' SELECT @Consecutivo = MAX(Consecutivo) FROM ModuloExtra06C WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
--IF @Modulo = 'MEX07' SELECT @Consecutivo = MAX(Consecutivo) FROM ModuloExtra07C WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
--IF @Modulo = 'MEX08' SELECT @Consecutivo = MAX(Consecutivo) FROM ModuloExtra08C WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
--IF @Modulo = 'MEX09' SELECT @Consecutivo = MAX(Consecutivo) FROM ModuloExtra09C WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'ORG'   SELECT @Consecutivo = MAX(Consecutivo) FROM OrganizaC     WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'RE'    SELECT @Consecutivo = MAX(Consecutivo) FROM ReclutaC      WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'ISL'   SELECT @Consecutivo = MAX(Consecutivo) FROM ISLC          WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'CAM'   SELECT @Consecutivo = MAX(Consecutivo) FROM CambioC       WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'PACTO' SELECT @Consecutivo = MAX(Consecutivo) FROM ContratoC     WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
  IF @Modulo = 'SAUX'  SELECT @Consecutivo = MAX(Consecutivo) FROM SAUXC         WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE 
  IF @Modulo = 'PREV'  SELECT @Consecutivo = MAX(Consecutivo) FROM PrevencionLDC WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo
  RETURN 
END
GO

/************** spConsecutivoManual *************/
if exists (select * from sysobjects where id = object_id('dbo.spConsecutivoManual') and type = 'P') drop procedure dbo.spConsecutivoManual
GO
CREATE PROCEDURE spConsecutivoManual
		   @Sucursal		int,
                   @Empresa     	char(5),
                   @Modulo		char(5),
		   @ID			int,
                   @Mov      		char(20),
                   @Ejercicio	        int,
                   @Periodo	        int,
		   @Serie		varchar(50) 	OUTPUT,
                   @MovIDSt		varchar(20) 	OUTPUT,
		   @Ok			int	 	OUTPUT,
		   @OkRef		varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @Consecutivo		bigint,
    @ConsecutivoPorPeriodo	bit,
    @ConsecutivoPorEjercicio	bit,
    @ConsecutivoPorEmpresa	char(20),
    @ConsecutivoSerial		bit,
    @ConsecutivoDigitos		int,
    @ConsecutivoSucursalEsp	bit,
    @SucursalEsp		int,
    @ModuloAfectacion		char(5),
    @MovID			bigint

  IF dbo.fnEsNumerico(@MovIDSt) = 0 OR CHARINDEX('.', @MovIDSt) > 0 OR SUBSTRING(@MovIDSt, 1, 1) = '0' RETURN
  SELECT @MovID = CONVERT(bigint, @MovIDSt)

  EXEC xpConsecutivoSerie @Empresa, @Modulo, @ID, @Mov, @Serie OUTPUT, @Ok OUTPUT, @OkRef OUTPUT

  SELECT @ModuloAfectacion = @Modulo
  SELECT @Modulo                  = ConsecutivoModulo,
         @Mov    		  = ConsecutivoMov,
         @ConsecutivoPorPeriodo   = ConsecutivoPorPeriodo,
         @ConsecutivoPorEjercicio = ConsecutivoPorEjercicio,
         @ConsecutivoPorEmpresa   = ISNULL(UPPER(ConsecutivoPorEmpresa), 'SI'),
         @ConsecutivoSucursalEsp  = ISNULL(ConsecutivoSucursalEsp, 0),
         @SucursalEsp             = SucursalEsp
    FROM MovTipo
   WHERE Modulo = @Modulo
     AND Mov    = @Mov
  IF @@ERROR <> 0 SELECT @Ok = 1

  SELECT @ConsecutivoSerial  = ConsecutivoSerial, 
         @ConsecutivoDigitos = ConsecutivoDigitos 
    FROM EmpresaGral 
   WHERE Empresa = @Empresa

  IF @ConsecutivoPorPeriodo   = 0 SELECT @Periodo = NULL
  IF @ConsecutivoPorEjercicio = 0 SELECT @Ejercicio = NULL
  IF @ConsecutivoPorEmpresa   = 'NO'    SELECT @Empresa = NULL ELSE
  IF @ConsecutivoPorEmpresa   = 'GRUPO' SELECT @Empresa = Clave FROM EmpresaGrupo, Empresa WHERE EmpresaGrupo.Grupo = Empresa.Grupo AND Empresa.Empresa = @Empresa
  IF @ConsecutivoSucursalEsp = 1 AND @SucursalEsp IS NOT NULL SELECT @Sucursal = @SucursalEsp

  EXEC spConsecutivoUltimo @Sucursal, @Empresa, @Modulo, @Mov, @Ejercicio, @Periodo, @Serie, @Consecutivo OUTPUT, @Ok OUTPUT
  IF @Consecutivo < @MovID
  BEGIN
    IF @Modulo = 'CONT'  UPDATE ContC         WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'VTAS'  UPDATE VentaC        WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'PROD'  UPDATE ProdC         WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'COMS'  UPDATE CompraC       WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'INV'   UPDATE InvC          WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'CXC'   UPDATE CxcC          WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'CXP'   UPDATE CxpC          WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'AGENT' UPDATE AgentC        WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'GAS'   UPDATE GastoC        WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'DIN'   UPDATE DineroC       WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'EMB'   UPDATE EmbarqueC     WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'NOM'   UPDATE NominaC       WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'RH'    UPDATE RHC           WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'ASIS'  UPDATE AsisteC       WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'AF'    UPDATE ActivoFijoC   WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'PC'    UPDATE PCC           WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'OFER'  UPDATE OfertaC       WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'VALE'  UPDATE ValeC         WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'CR'    UPDATE CRC           WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'ST'    UPDATE SoporteC      WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'CAP'   UPDATE CapitalC      WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'INC'   UPDATE IncidenciaC   WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'CONC'  UPDATE ConciliacionC WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'PPTO'  UPDATE PresupC       WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'CREDI' UPDATE CreditoC      WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'TMA'   UPDATE TMAC          WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'RSS'   UPDATE RSSC          WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'CMP'   UPDATE CampanaC      WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'FIS'   UPDATE FiscalC       WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    --REQ25014    
    IF @Modulo = 'CONTP' UPDATE ContParalelaC WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE    
    --REQ16092
	IF @Modulo = 'OPORT' UPDATE OportunidadC  WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'CORTE' UPDATE CorteC        WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'FRM'   UPDATE FormaExtraC   WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'CAPT'  UPDATE CapturaC      WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'GES'   UPDATE GestionC      WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'CP'    UPDATE CPC           WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'PCP'   UPDATE PCPC          WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE    
    IF @Modulo = 'PROY'  UPDATE ProyectoC     WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    --IF @Modulo = 'ACT'   UPDATE ActC           WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    --IF @Modulo = 'MEX01' UPDATE ModuloExtra01C WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    --IF @Modulo = 'MEX02' UPDATE ModuloExtra02C WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    --IF @Modulo = 'MEX03' UPDATE ModuloExtra03C WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    --IF @Modulo = 'MEX04' UPDATE ModuloExtra04C WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    --IF @Modulo = 'MEX05' UPDATE ModuloExtra05C WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    --IF @Modulo = 'MEX06' UPDATE ModuloExtra06C WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    --IF @Modulo = 'MEX07' UPDATE ModuloExtra07C WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    --IF @Modulo = 'MEX08' UPDATE ModuloExtra08C WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    --IF @Modulo = 'MEX09' UPDATE ModuloExtra09C WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'ORG'   UPDATE OrganizaC	WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'RE'    UPDATE ReclutaC	WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'ISL'   UPDATE ISLC		WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'CAM'   UPDATE CambioC		WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'PACTO' UPDATE ContratoC	WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'SAUX'  UPDATE SAUXC	    WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
    IF @Modulo = 'PREV'  UPDATE PrevencionLDC WITH (ROWLOCK) SET Consecutivo = @MovID WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Mov = @Mov AND Serie = @Serie AND Ejercicio = @Ejercicio AND Periodo = @Periodo 
    IF @@ROWCOUNT = 0 
    BEGIN
      IF @Modulo = 'CONT'  INSERT INTO ContC         (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'VTAS'  INSERT INTO VentaC        (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'PROD'  INSERT INTO ProdC         (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'COMS'  INSERT INTO CompraC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'INV'   INSERT INTO InvC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'CXC'   INSERT INTO CxcC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'CXP'   INSERT INTO CxpC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'AGENT' INSERT INTO AgentC        (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'GAS'   INSERT INTO GastoC        (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'DIN'   INSERT INTO DineroC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'EMB'   INSERT INTO EmbarqueC     (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'NOM'   INSERT INTO NominaC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'RH'    INSERT INTO RHC           (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'ASIS'  INSERT INTO AsisteC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'AF'    INSERT INTO ActivoFijoC   (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'PC'    INSERT INTO PCC           (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'OFER'  INSERT INTO OfertaC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'VALE'  INSERT INTO ValeC         (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'CR'    INSERT INTO CRC           (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'ST'    INSERT INTO SoporteC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'CAP'   INSERT INTO CapitalC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'INC'   INSERT INTO IncidenciaC   (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'CONC'  INSERT INTO ConciliacionC (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'PPTO'  INSERT INTO PresupC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'CREDI' INSERT INTO CreditoC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'TMA'   INSERT INTO TMAC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'RSS'   INSERT INTO RSSC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'CMP'   INSERT INTO CampanaC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'FIS'   INSERT INTO FiscalC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      --REQ25014
      IF @Modulo = 'CONTP' INSERT INTO ContParalelaC (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      --REQ16092
	  IF @Modulo = 'OPORT' INSERT INTO OportunidadC  (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE	  
      IF @Modulo = 'CORTE' INSERT INTO CorteC        (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'FRM'   INSERT INTO FormaExtraC   (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'CAPT'  INSERT INTO CapturaC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'GES'   INSERT INTO GestionC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'CP'    INSERT INTO CPC           (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'PCP'   INSERT INTO PCPC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE      
      IF @Modulo = 'PROY'  INSERT INTO ProyectoC     (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      --IF @Modulo = 'ACT'   INSERT INTO ActC           (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      --IF @Modulo = 'MEX01' INSERT INTO ModuloExtra01C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      --IF @Modulo = 'MEX02' INSERT INTO ModuloExtra02C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      --IF @Modulo = 'MEX03' INSERT INTO ModuloExtra03C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      --IF @Modulo = 'MEX04' INSERT INTO ModuloExtra04C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      --IF @Modulo = 'MEX05' INSERT INTO ModuloExtra05C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      --IF @Modulo = 'MEX06' INSERT INTO ModuloExtra06C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      --IF @Modulo = 'MEX07' INSERT INTO ModuloExtra07C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      --IF @Modulo = 'MEX08' INSERT INTO ModuloExtra08C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      --IF @Modulo = 'MEX09' INSERT INTO ModuloExtra09C (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'ORG'   INSERT INTO OrganizaC     (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'RE'    INSERT INTO ReclutaC      (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'ISL'   INSERT INTO ISLC          (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'CAM'   INSERT INTO CambioC       (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'PACTO' INSERT INTO ContratoC     (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'SAUX'  INSERT INTO SAUXC         (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) ELSE
      IF @Modulo = 'PREV'  INSERT INTO PrevencionLDC  (Sucursal, Empresa, Mov, Serie, Ejercicio, Periodo, Consecutivo) VALUES (@Sucursal, @Empresa, @Mov, @Serie, @Ejercicio, @Periodo, @MovID) 
      IF @@ERROR <> 0 SELECT @Ok = 1
  
    END
    IF @@ERROR <> 0 SELECT @Ok = 1
  END

  IF @ConsecutivoSerial = 1 
  BEGIN
    SELECT @Serie = LTRIM(RTRIM(@Serie))
    IF @Serie IS NOT NULL AND dbo.fnEsNumerico(@Serie) = 1
    BEGIN
      EXEC spLlenarCeros @MovID, @ConsecutivoDigitos, @MovIDSt OUTPUT
      SELECT @MovID = CONVERT(int, LTRIM(RTRIM(@Serie)) + RTRIM(LTRIM(@MovIDSt)))
      EXEC spConsecutivoActualizar @Modulo, @ID, @MovID
    END
  END
  SELECT @MovIDSt = CONVERT(char, @MovID)

/*  IF @Ok IS NULL
    EXEC spConsecutivoControl @Empresa, @ModuloAfectacion, @Mov, @Ejercicio, @Periodo, @Serie, @MovID, @Ok OUTPUT*/
  RETURN 
END
GO

/*
declare
  @subtipo varchar(20)
exec spContactoSubTipo 'MEX', 'Cliente', @SubTipo OUTPUT
select @subtipo
*/
/**************** spContactoSubTipo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spContactoSubTipo') and type = 'P') drop procedure dbo.spContactoSubTipo
GO
CREATE PROCEDURE spContactoSubTipo
		        @Contacto		varchar(10),
			@ContactoTipo		varchar(20),
			@ContactoSubTipo	varchar(20) 	OUTPUT,
			@Intercompania		bit = 0 	OUTPUT 
--//WITH ENCRYPTION
AS BEGIN
  SELECT @ContactoSubTipo = NULL, @Intercompania = 0
  IF NULLIF(RTRIM(@Contacto), '') IS NOT NULL 
  BEGIN
    IF @ContactoTipo = 'Cliente'   SELECT @ContactoSubTipo = Tipo, @Intercompania = ISNULL(Intercompania, 0) FROM Cte  WHERE Cliente   = @Contacto ELSE
    IF @ContactoTipo = 'Proveedor' SELECT @ContactoSubTipo = Tipo, @Intercompania = ISNULL(Intercompania, 0) FROM Prov WHERE Proveedor = @Contacto ELSE
    IF @ContactoTipo = 'Personal'  SELECT @ContactoSubTipo = Tipo FROM Personal WHERE Personal  = @Contacto ELSE
    IF @ContactoTipo = 'Agente'    SELECT @ContactoSubTipo = Tipo FROM Agente   WHERE Agente    = @Contacto ELSE
    IF @ContactoTipo = 'Almacen'   SELECT @ContactoSubTipo = Tipo FROM Alm      WHERE Almacen   = @Contacto
  END
  RETURN
END
GO 

/**************** spCopiarTablaAmortizacionGuia ****************/
if exists (select * from sysobjects where id = object_id('dbo.spCopiarTablaAmortizacionGuia') and type = 'P') drop procedure dbo.spCopiarTablaAmortizacionGuia
GO             
CREATE PROCEDURE spCopiarTablaAmortizacionGuia
		   @OModulo		char(5),
    		   @OID         	int,
		   @DModulo		char(5),
                   @DID			int
--//WITH ENCRYPTION
AS BEGIN
  DELETE TablaAmortizacionGuia WHERE Modulo = @DModulo AND ID = @DID
  INSERT TablaAmortizacionGuia 
        (Modulo,   ID,   Vencimiento, Capital)
  SELECT @DModulo, @DID, Vencimiento, Capital
    FROM TablaAmortizacionGuia
   WHERE Modulo = @OModulo AND ID = @OID

  DELETE TablaAmortizacionMigracion WHERE Modulo = @DModulo AND ID = @DID
  INSERT TablaAmortizacionMigracion
        (Modulo,   ID,   Amortizacion, FechaD, FechaA, SaldoInicial, Capital, Intereses, InteresesOrdinarios, InteresesMoratorios, TasaDiaria, Pendiente, FechaCobro, IVAInteres,           InteresesOrdinariosIVA) --MEJORA10041
  SELECT @DModulo, @DID, Amortizacion, FechaD, FechaA, SaldoInicial, Capital, Intereses, InteresesOrdinarios, InteresesMoratorios, TasaDiaria, Pendiente, FechaCobro, IVAInteresPorcentaje, InteresesMoratoriosIVA  --MEJORA10041
    FROM TablaAmortizacionMigracion
   WHERE Modulo = @OModulo AND ID = @OID

END
GO

/**************** spCopiarUsuarioMaestroCfg ****************/
if exists (select * from sysobjects where id = object_id('dbo.spCopiarUsuarioMaestroCfg') and type = 'P') drop procedure dbo.spCopiarUsuarioMaestroCfg
GO
CREATE PROCEDURE spCopiarUsuarioMaestroCfg
		            @UsuarioD    char(10)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @UsuarioA	char(10)

  IF NULLIF(@UsuarioD,'') IS NULL RETURN

  BEGIN TRANSACTION
    DECLARE crUsuarioCfg CURSOR FOR
      SELECT Usuario FROM Usuario WHERE Configuracion = @UsuarioD

    OPEN crUsuarioCfg
    FETCH NEXT FROM crUsuarioCfg INTO @UsuarioA
    WHILE @@FETCH_STATUS <> -1 
    BEGIN
      IF @@FETCH_STATUS <> -2 
        EXEC spCopiarUsuarioCfg @UsuarioD, @UsuarioA

      FETCH NEXT FROM crUsuarioCfg INTO @UsuarioA
    END  -- While	
    CLOSE crUsuarioCfg
    DEALLOCATE crUsuarioCfg

  COMMIT TRANSACTION
  RETURN
END
GO

/**************** spCopiarUsuarioMaestroAcceso ****************/
if exists (select * from sysobjects where id = object_id('dbo.spCopiarUsuarioMaestroAcceso') and type = 'P') drop procedure dbo.spCopiarUsuarioMaestroAcceso
GO
CREATE PROCEDURE spCopiarUsuarioMaestroAcceso
		            @UsuarioD    char(10)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @UsuarioA	char(10)

  BEGIN TRANSACTION
    DECLARE crUsuarioAcceso CURSOR LOCAL FOR
      SELECT Usuario FROM Usuario WHERE Acceso = @UsuarioD

    OPEN crUsuarioAcceso
    FETCH NEXT FROM crUsuarioAcceso INTO @UsuarioA
    WHILE @@FETCH_STATUS <> -1 
    BEGIN
      IF @@FETCH_STATUS <> -2 
        EXEC spCopiarUsuarioAcceso @UsuarioD, @UsuarioA

      FETCH NEXT FROM crUsuarioAcceso INTO @UsuarioA
    END  -- While	
    CLOSE crUsuarioAcceso
    DEALLOCATE crUsuarioAcceso
  COMMIT TRANSACTION
  RETURN
END
GO

/**************** spCopiarTabla ****************/
if exists (select * from sysobjects where id = object_id('dbo.spCopiarTabla') and type = 'P') drop procedure dbo.spCopiarTabla
GO             
CREATE PROCEDURE spCopiarTabla
  @TablaO			varchar(50),
  @Origen   		varchar(50),
  @Destino			varchar(50)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
  @Tabla				varchar(50),
  @Ok					int,
  @Campo				varchar(50),
  @SQL					nvarchar(MAX),
  @Insert				nvarchar(MAX),
  @Values				nvarchar(MAX),
  @Contador				int,
  @Detalle				int,
  @PK					nvarchar(MAX),
  @Texto				nvarchar(MAX)
  
  DECLARE crTabla CURSOR FOR
   SELECT Tabla
     FROM dbo.fnCopiarTabla(@TablaO)
    WHERE Tabla IS NOT NULL
     
  OPEN crTabla
  FETCH NEXT FROM crTabla INTO @Tabla
  WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
  BEGIN
  
    EXEC spSincroISTablaEstructura @Tabla, @SELECT = @Texto OUTPUT, @ExcluirTimeStamp = 1, @ExcluirCalculados = 1, @ExcluirIdentity = 1  
    SELECT @SQL = '', @Insert = '', @Values = '', @Contador = 0, @Detalle = 0
    
    DECLARE crCampo CURSOR FOR
     SELECT Resultado
       FROM dbo.fnConvertirTextoaTabla(@Texto+',', 0, ',')
      WHERE Resultado NOT IN(@TablaO)

    OPEN crCampo
    FETCH NEXT FROM crCampo INTO @Campo
    WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
    BEGIN
        
      SELECT @SQL = @SQL + 'd.' + @Campo + ' = o.' + @Campo + ','
      SELECT @Insert = @Insert + @Campo + ' , ', @Values = @Values + @Campo + ','
    
      FETCH NEXT FROM crCampo INTO @Campo
    END
    CLOSE crCampo
    DEALLOCATE crCampo
    
    EXEC spSincroISTablaEstructura @Tabla, @SELECT = @PK OUTPUT, @ExcluirTimeStamp = 1, @ExcluirCalculados = 1, @ExcluirIdentity = 1, @PK = 1
    SELECT @Detalle = dbo.fnTablaCamposPK(@PK, ',')
    
    IF @Detalle < 1
    BEGIN
      IF @TablaO = 'UsuarioAcceso'
      BEGIN
        SELECT @SQL = SUBSTRING(@SQL, 1, LEN(@SQL)-1)
        SELECT @SQL = REPLACE(@SQL, 'd.Usuario = o.Usuario,', '')        
        SELECT @SQL = 'UPDATE d SET ' + @SQL        
        SELECT @SQL = @SQL + ' FROM ' + @Tabla + ' o, ' + @Tabla + ' d WHERE o.' + 'Usuario' + ' = ''' + @Origen + ''' AND d.' + 'Usuario' + ' = ''' + @Destino + ''''
      END
      ELSE
      BEGIN
        SELECT @SQL = 'UPDATE d SET ' + @SQL + @TablaO +' = ''' + @Destino + ''''        
        SELECT @SQL = @SQL + ' FROM ' + @Tabla + ' o, ' + @Tabla + ' d WHERE o.' + @TablaO + ' = ''' + @Origen + ''' AND d.' + @TablaO + ' = ''' + @Destino + ''''
      END
      
      EXEC sp_executesql @SQL
      SELECT @Contador = @@ROWCOUNT
    END

    IF @Contador = 0 OR @Detalle > 1
    BEGIN
      IF @TablaO = 'UsuarioAcceso'
      BEGIN
        SELECT @Values = SUBSTRING(@Values, 1, LEN(@Values)-1)
        SELECT @Insert = SUBSTRING(@Insert, 1, LEN(@Insert)-1)
        SELECT @Values = REPLACE(@Values, 'Usuario', ''''+@Destino+'''')
        SELECT @Insert = 'DELETE ' + @Tabla + ' WHERE ' + 'Usuario' + ' = ''' + @Destino + ''' INSERT ' + @Tabla + ' (' + @Insert + ') '
        SELECT @Values = 'SELECT ' + @Values + ' FROM ' + @Tabla + ' WHERE ' + 'Usuario' +' = ''' + @Origen + ''''
      END
      ELSE
      BEGIN    
        SELECT @Insert = 'DELETE ' + @Tabla + ' WHERE ' + @TablaO + ' = ''' + @Destino + ''' INSERT ' + @Tabla + ' (' + @Insert + @TablaO + ') '
        SELECT @Values = 'SELECT ' + @Values + '''' + @Destino + '''' + ' FROM ' + @Tabla + ' WHERE ' + @TablaO +' = ''' + @Origen + ''''
      END
      SELECT @SQL = @Insert + @Values
      EXEC sp_executesql @SQL        
    END

    FETCH NEXT FROM crTabla INTO @Tabla
  END
  CLOSE crTabla
  DEALLOCATE crTabla
  RETURN
END
GO
--EXEC spCopiarTabla 'UsuarioAcceso', 'demo', 'demo22'

/**************** spCopiarTablaLista ****************/
if exists (select * from sysobjects where id = object_id('dbo.spCopiarTablaLista') and type = 'P') drop procedure dbo.spCopiarTablaLista
GO
CREATE PROCEDURE spCopiarTablaLista		            
		            @TablaO			varchar(50),
		            @Destino	    varchar(50)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @EmpresaA	char(10)

  BEGIN TRANSACTION
  
    IF @TablaO = 'Empresa'
    BEGIN
      IF EXISTS(SELECT * FROM sys.dm_exec_cursors(@@SPID) WHERE name = 'crCopiarTablaLista')
        DEALLOCATE crCopiarTablaLista
      ELSE
        DECLARE crCopiarTablaLista CURSOR FOR 
         SELECT Empresa FROM Empresa WHERE Configuracion = @Destino
    END
    ELSE
    IF @TablaO = 'Usuario' AND EXISTS(SELECT * FROM Usuario WHERE Configuracion = @Destino)
    BEGIN
      IF EXISTS(SELECT * FROM sys.dm_exec_cursors(@@SPID) WHERE name = 'crCopiarTablaLista')
        DEALLOCATE crCopiarTablaLista
      ELSE    
        DECLARE crCopiarTablaLista CURSOR FOR 
         SELECT Usuario FROM Usuario WHERE Configuracion = @Destino
    END

    IF (@TablaO = 'Usuario' AND EXISTS(SELECT * FROM Usuario WHERE Configuracion = @Destino)) OR (@TablaO = 'Empresa' AND EXISTS(SELECT * FROM Empresa WHERE Configuracion = @Destino))
    BEGIN
      OPEN crCopiarTablaLista
      FETCH NEXT FROM crCopiarTablaLista INTO @EmpresaA
      WHILE @@FETCH_STATUS <> -1
      BEGIN
        IF @@FETCH_STATUS <> -2 
          EXEC spCopiarTabla @TablaO, @Destino, @EmpresaA

        FETCH NEXT FROM crCopiarTablaLista INTO @EmpresaA
      END
      CLOSE crCopiarTablaLista
      DEALLOCATE crCopiarTablaLista
    END

  COMMIT TRANSACTION
  RETURN
END
GO

/************** spCtaSituacionProg *************/
if exists (select * from sysobjects where id = object_id('dbo.spCtaSituacionProg') and type = 'P') drop procedure dbo.spCtaSituacionProg
GO
CREATE PROCEDURE spCtaSituacionProg
    		   @Empresa	 char(5), 
                   @Sucursal	 int,
		   @Fecha	datetime,
                   @Ok		int		OUTPUT,
		   @OkRef	varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @TipoCuenta		varchar(20), 
    @Cuenta		varchar(20), 
    @SituacionFecha	datetime,
    @Situacion 		varchar(50)

  IF EXISTS(SELECT * FROM CtaSituacionProg WHERE Fecha <= @Fecha AND Estatus = 'ACTIVO')
  BEGIN
    BEGIN TRANSACTION
      DECLARE crCtaSituacionProg CURSOR FOR
        SELECT UPPER(TipoCuenta), UPPER(Cuenta), Fecha, Situacion 
          FROM CtaSituacionProg 
         WHERE Fecha <= @Fecha AND Estatus = 'ACTIVO'

      OPEN crCtaSituacionProg
      FETCH NEXT FROM crCtaSituacionProg INTO @TipoCuenta, @Cuenta, @SituacionFecha, @Situacion 
      WHILE @@FETCH_STATUS <> -1 
      BEGIN
        IF @@FETCH_STATUS <> -2 
        BEGIN
          IF @TipoCuenta = 'ARTICULOS'   UPDATE Art      SET Situacion = @Situacion, SituacionFecha = @SituacionFecha WHERE Articulo  = @Cuenta ELSE
          IF @TipoCuenta = 'CLIENTES'    UPDATE Cte      SET Situacion = @Situacion, SituacionFecha = @SituacionFecha WHERE Cliente   = @Cuenta ELSE
          IF @TipoCuenta = 'PROVEEDORES' UPDATE Prov     SET Situacion = @Situacion, SituacionFecha = @SituacionFecha WHERE Proveedor = @Cuenta ELSE
          IF @TipoCuenta = 'PERSONAL'    UPDATE Personal SET Situacion = @Situacion, SituacionFecha = @SituacionFecha WHERE Personal  = @Cuenta ELSE
          IF @TipoCuenta = 'PROYECTOS'   UPDATE Proy     SET Situacion = @Situacion, SituacionFecha = @SituacionFecha WHERE Proyecto  = @Cuenta ELSE
          IF @TipoCuenta = 'ESPACIOS'    UPDATE Espacio  SET Situacion = @Situacion, SituacionFecha = @SituacionFecha WHERE Espacio   = @Cuenta
        END
        FETCH NEXT FROM crCtaSituacionProg INTO @TipoCuenta, @Cuenta, @SituacionFecha, @Situacion 
      END  -- While	
      CLOSE crCtaSituacionProg
      DEALLOCATE crCtaSituacionProg
    COMMIT TRANSACTION
  END
  RETURN
END
GO

/**************** spCteEstatus ****************/
if exists (select * from sysobjects where id = object_id('dbo.spCteEstatus') and type = 'P') drop procedure dbo.spCteEstatus
GO             
CREATE PROCEDURE spCteEstatus
			@Cliente	char(10),
			@Estatus	char(15)
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @Ok int
  SELECT @Ok = NULL

  SELECT @Cliente = UPPER(@Cliente), @Estatus = UPPER(@Estatus)
  IF EXISTS (SELECT * FROM Cte WHERE Cliente = @Cliente) AND (@Estatus IN ('ALTA', 'BLOQUEADO', 'BLOQ_AVISO') OR EXISTS (SELECT * FROM Bloqueo WHERE Bloqueo = @Estatus))
  BEGIN
    BEGIN TRANSACTION
      UPDATE Cte SET Estatus = @Estatus WHERE Cliente = @Cliente
      IF @@ERROR <> 0 SELECT @Ok = 1

    IF @Ok IS NULL
      COMMIT TRANSACTION
    ELSE
      ROLLBACK TRANSACTION
  END
END
GO

/**************** spCteEnviarAEstatus ****************/
if exists (select * from sysobjects where id = object_id('dbo.spCteEnviarAEstatus') and type = 'P') drop procedure dbo.spCteEnviarAEstatus
GO             
CREATE PROCEDURE spCteEnviarAEstatus
			@Cliente	char(10),
			@ID		int,
			@Estatus	char(15)
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @Ok int
  SELECT @Ok = NULL

  SELECT @Cliente = UPPER(@Cliente), @Estatus = UPPER(@Estatus)
  IF EXISTS (SELECT * FROM CteEnviarA WHERE Cliente = @Cliente AND ID = @ID) AND (@Estatus IN ('ALTA', 'BLOQUEADO', 'BLOQ_AVISO') OR EXISTS (SELECT * FROM Bloqueo WHERE Bloqueo = @Estatus))
  BEGIN
    BEGIN TRANSACTION
      UPDATE CteEnviarA SET Estatus = @Estatus WHERE Cliente = @Cliente AND ID = @ID
      IF @@ERROR <> 0 SELECT @Ok = 1

    IF @Ok IS NULL
      COMMIT TRANSACTION
    ELSE
      ROLLBACK TRANSACTION
  END
END
GO

/************** spCteImpuesto *************/
if exists (select * from sysobjects where id = object_id('dbo.spCteImpuesto') and sysstat & 0xf = 4) drop procedure dbo.spCteImpuesto
GO
CREATE PROCEDURE spCteImpuesto
			@Empresa	char(5),
		   	@Cliente	char(10),
			@EnviarA	int,
			@Impuesto	float	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @ZonaImpuesto	varchar(50)

  SELECT @Impuesto = DefImpuesto FROM EmpresaGral WHERE Empresa = @Empresa
  SELECT @ZonaImpuesto = NULLIF(RTRIM(ZonaImpuesto), '') FROM Cte WHERE Cliente = @Cliente
  SELECT @ZonaImpuesto = ISNULL(NULLIF(RTRIM(ZonaImpuesto), ''), @ZonaImpuesto) FROM CteEnviarA WHERE Cliente = @Cliente AND ID = @EnviarA
  IF @ZonaImpuesto IS NOT NULL
    EXEC spZonaImp @ZonaImpuesto, @Impuesto OUTPUT

  SELECT @Impuesto = ISNULL(@Impuesto, 0.0)
  RETURN
END
GO

/**************** spEliminarMov ****************/
if exists (select * from sysobjects where id = object_id('dbo.spEliminarMov') and type = 'P') drop procedure dbo.spEliminarMov
GO
CREATE PROCEDURE spEliminarMov
			@Modulo		char(5),
                        @ID		int
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @MovID	varchar(20),
    @Estatus	char(15)

  SELECT @MovID = NULL, @Estatus = NULL

  IF @Modulo = 'CONT'  SELECT @MovID = MovID, @Estatus = Estatus FROM Cont  	   WHERE ID = @ID ELSE
  IF @Modulo = 'VTAS'  SELECT @MovID = MovID, @Estatus = Estatus FROM Venta        WHERE ID = @ID ELSE
  IF @Modulo = 'PROD'  SELECT @MovID = MovID, @Estatus = Estatus FROM Prod         WHERE ID = @ID ELSE
  IF @Modulo = 'COMS'  SELECT @MovID = MovID, @Estatus = Estatus FROM Compra       WHERE ID = @ID ELSE
  IF @Modulo = 'INV'   SELECT @MovID = MovID, @Estatus = Estatus FROM Inv          WHERE ID = @ID ELSE
  IF @Modulo = 'CXC'   SELECT @MovID = MovID, @Estatus = Estatus FROM Cxc          WHERE ID = @ID ELSE
  IF @Modulo = 'CXP'   SELECT @MovID = MovID, @Estatus = Estatus FROM Cxp          WHERE ID = @ID ELSE
  IF @Modulo = 'AGENT' SELECT @MovID = MovID, @Estatus = Estatus FROM Agent        WHERE ID = @ID ELSE
  IF @Modulo = 'GAS'   SELECT @MovID = MovID, @Estatus = Estatus FROM Gasto        WHERE ID = @ID ELSE
  IF @Modulo = 'DIN'   SELECT @MovID = MovID, @Estatus = Estatus FROM Dinero       WHERE ID = @ID ELSE
  IF @Modulo = 'EMB'   SELECT @MovID = MovID, @Estatus = Estatus FROM Embarque     WHERE ID = @ID ELSE
  IF @Modulo = 'NOM'   SELECT @MovID = MovID, @Estatus = Estatus FROM Nomina       WHERE ID = @ID ELSE
  IF @Modulo = 'RH'    SELECT @MovID = MovID, @Estatus = Estatus FROM RH      	   WHERE ID = @ID ELSE
  IF @Modulo = 'ASIS'  SELECT @MovID = MovID, @Estatus = Estatus FROM Asiste       WHERE ID = @ID ELSE
  IF @Modulo = 'AF'    SELECT @MovID = MovID, @Estatus = Estatus FROM ActivoFijo   WHERE ID = @ID ELSE
  IF @Modulo = 'PC'    SELECT @MovID = MovID, @Estatus = Estatus FROM PC           WHERE ID = @ID ELSE
  IF @Modulo = 'OFER'  SELECT @MovID = MovID, @Estatus = Estatus FROM Oferta       WHERE ID = @ID ELSE
  IF @Modulo = 'VALE'  SELECT @MovID = MovID, @Estatus = Estatus FROM Vale         WHERE ID = @ID ELSE
  IF @Modulo = 'CR'    SELECT @MovID = MovID, @Estatus = Estatus FROM CR           WHERE ID = @ID ELSE
  IF @Modulo = 'ST'    SELECT @MovID = MovID, @Estatus = Estatus FROM Soporte      WHERE ID = @ID ELSE
  IF @Modulo = 'CAP'   SELECT @MovID = MovID, @Estatus = Estatus FROM Capital      WHERE ID = @ID ELSE
  IF @Modulo = 'INC'   SELECT @MovID = MovID, @Estatus = Estatus FROM Incidencia   WHERE ID = @ID ELSE
  IF @Modulo = 'CONC'  SELECT @MovID = MovID, @Estatus = Estatus FROM Conciliacion WHERE ID = @ID ELSE
  IF @Modulo = 'PPTO'  SELECT @MovID = MovID, @Estatus = Estatus FROM Presup       WHERE ID = @ID ELSE
  IF @Modulo = 'CREDI' SELECT @MovID = MovID, @Estatus = Estatus FROM Credito	   WHERE ID = @ID ELSE
  IF @Modulo = 'TMA'   SELECT @MovID = MovID, @Estatus = Estatus FROM TMA          WHERE ID = @ID ELSE
  IF @Modulo = 'RSS'   SELECT @MovID = MovID, @Estatus = Estatus FROM RSS          WHERE ID = @ID ELSE
  IF @Modulo = 'CMP'   SELECT @MovID = MovID, @Estatus = Estatus FROM Campana      WHERE ID = @ID ELSE
  IF @Modulo = 'FIS'   SELECT @MovID = MovID, @Estatus = Estatus FROM Fiscal       WHERE ID = @ID ELSE
  --REQ25014          
  IF @Modulo = 'CONTP' SELECT @MovID = MovID, @Estatus = Estatus FROM ContParalela WHERE ID = @ID ELSE
  --REQ16092
  IF @Modulo = 'OPORT' SELECT @MovID = MovID, @Estatus = Estatus FROM Oportunidad  WHERE ID = @ID ELSE  
  IF @Modulo = 'CORTE' SELECT @MovID = MovID, @Estatus = Estatus FROM Corte        WHERE ID = @ID ELSE
  IF @Modulo = 'FRM'   SELECT @MovID = MovID, @Estatus = Estatus FROM FormaExtra   WHERE ID = @ID ELSE
  IF @Modulo = 'CAPT'  SELECT @MovID = MovID, @Estatus = Estatus FROM Captura      WHERE ID = @ID ELSE
  IF @Modulo = 'GES'   SELECT @MovID = MovID, @Estatus = Estatus FROM Gestion      WHERE ID = @ID ELSE
  IF @Modulo = 'CP'    SELECT @MovID = MovID, @Estatus = Estatus FROM CP           WHERE ID = @ID ELSE
  IF @Modulo = 'PCP'   SELECT @MovID = MovID, @Estatus = Estatus FROM PCP          WHERE ID = @ID ELSE  
  IF @Modulo = 'PROY'  SELECT @MovID = MovID, @Estatus = Estatus FROM Proyecto     WHERE ID = @ID ELSE
  --IF @Modulo = 'ACT'   SELECT @MovID = MovID, @Estatus = Estatus FROM Act           WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX01' SELECT @MovID = MovID, @Estatus = Estatus FROM ModuloExtra01 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX02' SELECT @MovID = MovID, @Estatus = Estatus FROM ModuloExtra02 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX03' SELECT @MovID = MovID, @Estatus = Estatus FROM ModuloExtra03 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX04' SELECT @MovID = MovID, @Estatus = Estatus FROM ModuloExtra04 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX05' SELECT @MovID = MovID, @Estatus = Estatus FROM ModuloExtra05 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX06' SELECT @MovID = MovID, @Estatus = Estatus FROM ModuloExtra06 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX07' SELECT @MovID = MovID, @Estatus = Estatus FROM ModuloExtra07 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX08' SELECT @MovID = MovID, @Estatus = Estatus FROM ModuloExtra08 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX09' SELECT @MovID = MovID, @Estatus = Estatus FROM ModuloExtra09 WHERE ID = @ID ELSE
  IF @Modulo = 'ORG'   SELECT @MovID = MovID, @Estatus = Estatus FROM Organiza     WHERE ID = @ID ELSE
  IF @Modulo = 'RE'    SELECT @MovID = MovID, @Estatus = Estatus FROM Recluta      WHERE ID = @ID ELSE
  IF @Modulo = 'ISL'   SELECT @MovID = MovID, @Estatus = Estatus FROM ISL          WHERE ID = @ID ELSE
  IF @Modulo = 'CAM'   SELECT @MovID = MovID, @Estatus = Estatus FROM Cambio       WHERE ID = @ID ELSE
  IF @Modulo = 'PACTO' SELECT @MovID = MovID, @Estatus = Estatus FROM Contrato     WHERE ID = @ID ELSE
  IF @Modulo = 'SAUX'  SELECT @MovID = MovID, @Estatus = Estatus FROM SAUX         WHERE ID = @ID
  
  IF @MovID IS NOT NULL OR @Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') RETURN 0

  IF @Modulo = 'CONT'  DELETE Cont         WHERE ID = @ID ELSE
  IF @Modulo = 'VTAS'  DELETE Venta        WHERE ID = @ID ELSE
  IF @Modulo = 'PROD'  DELETE Prod         WHERE ID = @ID ELSE
  IF @Modulo = 'INV'   DELETE Inv          WHERE ID = @ID ELSE
  IF @Modulo = 'COMS'  DELETE Compra       WHERE ID = @ID ELSE
  IF @Modulo = 'CXC'   DELETE Cxc          WHERE ID = @ID ELSE
  IF @Modulo = 'CXP'   DELETE Cxp          WHERE ID = @ID ELSE
  IF @Modulo = 'AGENT' DELETE Agent        WHERE ID = @ID ELSE
  IF @Modulo = 'GAS'   DELETE Gasto        WHERE ID = @ID ELSE
  IF @Modulo = 'DIN'   DELETE Dinero       WHERE ID = @ID ELSE
  IF @Modulo = 'AF'    DELETE ActivoFijo   WHERE ID = @ID ELSE
  IF @Modulo = 'PC'    DELETE PC           WHERE ID = @ID ELSE
  IF @Modulo = 'OFER'  DELETE Oferta       WHERE ID = @ID ELSE
  IF @Modulo = 'VALE'  DELETE Vale         WHERE ID = @ID ELSE
  IF @Modulo = 'CR'    DELETE CR           WHERE ID = @ID ELSE
  IF @Modulo = 'NOM'   DELETE Nomina       WHERE ID = @ID ELSE
  IF @Modulo = 'RH'    DELETE RH           WHERE ID = @ID ELSE
  IF @Modulo = 'ASIS'  DELETE Asiste       WHERE ID = @ID ELSE
  IF @Modulo = 'EMB'   DELETE Embarque     WHERE ID = @ID ELSE
  IF @Modulo = 'CAM'   DELETE Cambio       WHERE ID = @ID ELSE
  IF @Modulo = 'PACTO' DELETE Contrato     WHERE ID = @ID ELSE
  IF @Modulo = 'CAP'   DELETE Capital      WHERE ID = @ID ELSE
  IF @Modulo = 'INC'   DELETE Incidencia   WHERE ID = @ID ELSE
  IF @Modulo = 'CONC'  DELETE Conciliacion WHERE ID = @ID ELSE
  IF @Modulo = 'PPTO'  DELETE Presup       WHERE ID = @ID ELSE
  IF @Modulo = 'CREDI' DELETE Credito	   WHERE ID = @ID ELSE
  IF @Modulo = 'TMA'   DELETE TMA          WHERE ID = @ID ELSE
  IF @Modulo = 'RSS'   DELETE RSS          WHERE ID = @ID ELSE
  IF @Modulo = 'CMP'   DELETE Campana      WHERE ID = @ID ELSE
  IF @Modulo = 'FIS'   DELETE Fiscal       WHERE ID = @ID ELSE
  --REQ25014          
  IF @Modulo = 'CONTP' DELETE ContParalela WHERE ID = @ID ELSE
  --REQ16092
  IF @Modulo = 'OPORT' DELETE Oportunidad  WHERE ID = @ID ELSE  
  IF @Modulo = 'CORTE' DELETE Corte        WHERE ID = @ID ELSE
  IF @Modulo = 'FRM'   DELETE FormaExtra   WHERE ID = @ID ELSE
  IF @Modulo = 'CAPT'  DELETE Captura      WHERE ID = @ID ELSE
  IF @Modulo = 'GES'   DELETE Gestion      WHERE ID = @ID ELSE
  IF @Modulo = 'CP'    DELETE CP           WHERE ID = @ID ELSE
  IF @Modulo = 'PCP'   DELETE PCP          WHERE ID = @ID ELSE  
  IF @Modulo = 'PROY'  DELETE Proyecto     WHERE ID = @ID ELSE
  --IF @Modulo = 'ACT'   DELETE Act           WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX01' DELETE ModuloExtra01 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX02' DELETE ModuloExtra02 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX03' DELETE ModuloExtra03 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX04' DELETE ModuloExtra04 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX05' DELETE ModuloExtra05 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX06' DELETE ModuloExtra06 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX07' DELETE ModuloExtra07 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX08' DELETE ModuloExtra08 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX09' DELETE ModuloExtra09 WHERE ID = @ID ELSE
  IF @Modulo = 'ORG'   DELETE Organiza     WHERE ID = @ID ELSE
  IF @Modulo = 'RE'    DELETE Recluta      WHERE ID = @ID ELSE
  IF @Modulo = 'ISL'   DELETE ISL          WHERE ID = @ID ELSE
  IF @Modulo = 'ST'    DELETE Soporte      WHERE ID = @ID ELSE
  IF @Modulo = 'SAUX'  DELETE SAUX         WHERE ID = @ID 

  IF @Modulo = 'CONT'
  BEGIN
    DELETE ContD   WHERE ID = @ID 
    DELETE ContReg WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'VTAS'  DELETE VentaD      WHERE ID = @ID ELSE
  IF @Modulo = 'PROD'  DELETE ProdD       WHERE ID = @ID ELSE
  IF @Modulo = 'INV'   DELETE InvD        WHERE ID = @ID ELSE
  IF @Modulo = 'COMS'  DELETE CompraD     WHERE ID = @ID ELSE
  IF @Modulo = 'CXC'   DELETE CxcD        WHERE ID = @ID ELSE
  IF @Modulo = 'CXP'   DELETE CxpD        WHERE ID = @ID ELSE
  IF @Modulo = 'AGENT' DELETE AgentD      WHERE ID = @ID ELSE
  IF @Modulo = 'GAS'   DELETE GastoD      WHERE ID = @ID ELSE
  IF @Modulo = 'DIN'   DELETE DineroD     WHERE ID = @ID ELSE
  IF @Modulo = 'AF'    DELETE ActivoFijoD WHERE ID = @ID ELSE
  IF @Modulo = 'PC'    DELETE PCD         WHERE ID = @ID ELSE
  IF @Modulo = 'OFER'
  BEGIN
    DELETE OfertaFiltro WHERE ID = @ID 
    DELETE OfertaD      WHERE ID = @ID 
    DELETE OfertaDVol   WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'VALE'  DELETE ValeD       WHERE ID = @ID ELSE
  IF @Modulo = 'CR'    
  BEGIN 
    DELETE CRVenta  WHERE ID = @ID 
    DELETE CRAgente WHERE ID = @ID 
    DELETE CRCobro  WHERE ID = @ID 
    DELETE CRVenta  WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'NOM'   DELETE NominaD       WHERE ID = @ID ELSE
  IF @Modulo = 'RH'    DELETE RHD           WHERE ID = @ID ELSE
  IF @Modulo = 'ASIS'  DELETE AsisteD       WHERE ID = @ID ELSE
  IF @Modulo = 'EMB'   DELETE EmbarqueD     WHERE ID = @ID ELSE
  IF @Modulo = 'CAM'   DELETE CambioD       WHERE ID = @ID ELSE
  IF @Modulo = 'CAP'   DELETE CapitalD      WHERE ID = @ID ELSE
  IF @Modulo = 'INC'   DELETE IncidenciaD   WHERE ID = @ID ELSE
  IF @Modulo = 'CONC'  DELETE ConciliacionD WHERE ID = @ID ELSE
  IF @Modulo = 'PPTO'  DELETE PresupD       WHERE ID = @ID ELSE
--  IF @Modulo = 'CREDI'  DELETE CreditoD    WHERE ID = @ID ELSE
  IF @Modulo = 'TMA'   DELETE TMAD          WHERE ID = @ID ELSE
--  IF @Modulo = 'RSS'   DELETE RSSD          WHERE ID = @ID ELSE
  IF @Modulo = 'CMP'   
  BEGIN
    DELETE CampanaD            WHERE ID = @ID 
    DELETE CampanaEncuesta     WHERE ID = @ID 
    DELETE CampanaEvento       WHERE ID = @ID 
    DELETE CampanaCorreo       WHERE ID = @ID 
    DELETE CampanaTarea        WHERE ID = @ID 
    DELETE CampanaCfgCorreo    WHERE ID = @ID 
    DELETE CampanaCfgSituacion WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'FIS'   DELETE FiscalD       WHERE ID = @ID ELSE 
  --REQ25014
  IF @Modulo = 'CONTP' DELETE ContParalelaD WHERE ID = @ID ELSE  
  --REQ16092
  IF @Modulo = 'OPORT' DELETE OportunidadD        WHERE ID = @ID ELSE  
  IF @Modulo = 'CORTE'
  BEGIN
    DELETE CorteD			WHERE ID = @ID
    DELETE CorteDReporte    WHERE ID = @ID
  END ELSE
  IF @Modulo = 'FRM'   DELETE FormaExtraD WHERE ID = @ID ELSE
  IF @Modulo = 'CAPT'  DELETE CapturaD    WHERE ID = @ID ELSE
  IF @Modulo = 'GES'
  BEGIN
    DELETE GestionPara    WHERE ID = @ID 
    DELETE GestionRecurso WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'CP'
  BEGIN
    DELETE CPD    WHERE ID = @ID 
    DELETE CPCal  WHERE ID = @ID 
    DELETE CPEsp  WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'PCP'  
  BEGIN
    DELETE PCPD WHERE ID = @ID
    DELETE PCPDRegla WHERE ID = @ID
  END ELSE  
  IF @Modulo = 'PROY'  
  BEGIN
    DELETE ProyectDia       WHERE ID = @ID 
    DELETE ProyectD         WHERE ID = @ID 
    DELETE ProyectoDRecurso WHERE ID = @ID 
  END ELSE
--  IF @Modulo = 'ACT'   DELETE ActD        WHERE ID = @ID ELSE
  IF @Modulo = 'ST'    DELETE SoporteD    WHERE ID = @ID ELSE
  IF @Modulo = 'SAUX'  DELETE SAUXD       WHERE ID = @ID 

  -- Otras Tablas Relacionadas con el Modulo
  IF @Modulo = 'VTAS'
  BEGIN
    DELETE VentaDAgente       WHERE ID = @ID 
    DELETE ServicioAccesorios WHERE ID = @ID 
    DELETE ServicioTarea      WHERE ID = @ID 
    DELETE VentaCobro         WHERE ID = @ID 
    DELETE VentaCobroD        WHERE ID = @ID 
    DELETE VentaDLogPicos     WHERE ID = @ID 
    DELETE VentaOrigen        WHERE ID = @ID 
    DELETE VentaOtros         WHERE ID = @ID 
    DELETE VentaEntrega       WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'COMS' 
  BEGIN
    DELETE CompraGastoDiverso  WHERE ID = @ID 
    DELETE CompraGastoDiversoD WHERE ID = @ID 
    DELETE CompraDProrrateo    WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'INV' 
  BEGIN
    DELETE InvGastoDiverso  WHERE ID = @ID 
    DELETE InvGastoDiversoD WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'GAS'
  BEGIN
    DELETE GastoDProrrateo WHERE ID = @ID 
    DELETE GastoAplica     WHERE ID = @ID 
  END ELSE
  --IF @Modulo = 'MEX01' DELETE ModuloExtra01D WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX02' DELETE ModuloExtra02D WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX03' DELETE ModuloExtra03D WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX04' DELETE ModuloExtra04D WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX05' DELETE ModuloExtra05D WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX06' DELETE ModuloExtra06D WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX07' DELETE ModuloExtra07D WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX08' DELETE ModuloExtra08D WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX09' DELETE ModuloExtra09D WHERE ID = @ID ELSE
  IF @Modulo = 'ORG' DELETE OrganizaD    WHERE ID = @ID ELSE
  IF @Modulo = 'RE'  
  BEGIN 
    DELETE ReclutaD			WHERE ID = @ID 
    DELETE ReclutaPlaza			WHERE ID = @ID 
    DELETE ReclutaCompetenciaTipo	WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'ISL' DELETE ISLD	 WHERE ID = @ID ELSE
  IF @Modulo = 'CXC' DELETE CxcAplicaDif WHERE ID = @ID ELSE
  IF @Modulo = 'CXP' DELETE CxpAplicaDif WHERE ID = @ID 
  RETURN 1
END
GO

/*********** spExistenciaSucursal ***********/
if exists (select * from sysobjects where id = object_id('dbo.spExistenciaSucursal') and type = 'P') drop procedure dbo.spExistenciaSucursal
GO
CREATE PROCEDURE spExistenciaSucursal
			@Sucursal	int,
			@Empresa	char(5),
			@Articulo	char(20),
			@SubCuenta	varchar(50),
			@NivelSubCuenta	bit,
			@Existencia	float	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  SELECT @Existencia = 0.0
  SELECT @SubCuenta = ISNULL(RTRIM(@SubCuenta), '')

  IF @NivelSubCuenta = 0
    SELECT @Existencia = ISNULL(Sum(Inventario),0.0) 
      FROM ArtExistenciaInv 
     WHERE Sucursal = @Sucursal 
       AND Empresa = @Empresa 
       AND Articulo = @Articulo
  ELSE
    SELECT @Existencia = ISNULL(Sum(Inventario),0.0) 
      FROM ArtSubExistenciaInv 
     WHERE Sucursal = @Sucursal 
       AND Empresa = @Empresa 
       AND Articulo = @Articulo
       AND SubCuenta = @SubCuenta
  RETURN
END
GO


/**************** spExtraerUltimoElemento ****************/
/*
if exists (select * from sysobjects where id = object_id('dbo.spExtraerUltimoElemento') and type = 'P') drop procedure dbo.spExtraerUltimoElemento
*/
GO
/*             
CREATE PROCEDURE spExtraerUltimoElemento 
			@Lista		varchar(255),
			@Elemento	varchar(20)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Pos int

  SELECT @Elemento = NULL, @Lista = NULLIF(RTRIM(@Lista), '')
  SELECT @Lista = REVERSE(@Lista)
  SELECT @Pos = CHARINDEX(',', @Lista)
  IF @Pos > 0
    SELECT @Elemento = NULLIF(LTRIM(RTRIM(REVERSE(SUBSTRING(@Lista, 1, @Pos-1)))), '')
  ELSE SELECT @Elemento = REVERSE(@Lista)
  RETURN
END
*/
GO

/************** spFechaAfectacion *************/
if exists (select * from sysobjects where id = object_id('dbo.spFechaAfectacion') and type = 'P') drop procedure dbo.spFechaAfectacion
GO
CREATE PROCEDURE spFechaAfectacion
		   @Empresa		char(5),
		   @Modulo		char(10),
		   @ID			int,
		   @Accion 		char(20),
		   @FechaEmision	datetime	OUTPUT,
		   @FechaRegistro	datetime,
		   @FechaAfectacion	datetime	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @CfgFechaEmision	varchar(20),
    @FechaNueva		datetime,
    @Estatus		varchar(15)
/*    @DiaEmision	int,
    @Dia  int,
    @Mes  int,
    @Ano  int
*/
  SELECT @CfgFechaEmision = NULL
  SELECT @CfgFechaEmision = UPPER(FechaEmision) FROM EmpresaCfgModulo WHERE Empresa = @Empresa AND Modulo = @Modulo
  IF NULLIF(@CfgFechaEmision,'') IS NULL AND @Modulo NOT IN ('NOM','RH','ASIS','ST','RE') SELECT @CfgFechaEmision = 'SERVIDOR'
--POS BUG 13699
  IF @Modulo = 'VTAS'
  BEGIN
	IF (SELECT OrigenTipo FROM Venta WHERE ID = @ID) = 'POS'
		SELECT @CfgFechaEmision = 'CLIENTE'		
  END
  IF @Modulo = 'DIN'
  BEGIN
	IF (SELECT OrigenTipo FROM Dinero WHERE ID = @ID) = 'POS'
		SELECT @CfgFechaEmision = 'CLIENTE'		
  END
  IF @CfgFechaEmision = 'SERVIDOR' AND @Accion NOT IN ('GENERAR', 'CANCELAR', 'RESERVAR', 'DESRESERVAR', 'RESERVARPARCIAL', 'ASIGNAR', 'DESASIGNAR')
  BEGIN 
    EXEC spMovInfo @ID, @Modulo, @Estatus = @Estatus OUTPUT -- ETO
    SELECT @FechaNueva = @FechaRegistro
    EXEC spExtraerFecha @FechaNueva OUTPUT
    EXEC xpFechaAfectacion @Empresa, @Modulo, @ID, @Accion, @FechaEmision, @FechaNueva OUTPUT
    IF @FechaNueva <> @FechaEmision AND @Estatus <> 'PENDIENTE' 
    BEGIN
      EXEC xpFechaAfectacion @Empresa, @Modulo, @ID, @Accion, @FechaEmision, @FechaNueva OUTPUT
      SELECT @FechaEmision = @FechaNueva
      IF @Modulo = 'CONT'  UPDATE Cont         SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'VTAS'  UPDATE Venta        SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'PROD'  UPDATE Prod         SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'COMS'  UPDATE Compra       SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'INV'   UPDATE Inv          SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'CXC'   UPDATE Cxc          SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'CXP'   UPDATE Cxp          SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'AGENT' UPDATE Agent        SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'GAS'   UPDATE Gasto        SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'DIN'   UPDATE Dinero       SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'EMB'   UPDATE Embarque     SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'NOM'   UPDATE Nomina       SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'RH'    UPDATE RH           SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'ASIS'  UPDATE Asiste       SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'AF'    UPDATE ActivoFijo   SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'PC'    UPDATE PC           SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'OFER'  UPDATE Oferta       SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'VALE'  UPDATE Vale         SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'CR'    UPDATE CR           SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'ST'    UPDATE Soporte      SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'CAP'   UPDATE Capital      SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'INC'   UPDATE Incidencia   SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'CONC'  UPDATE Conciliacion SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'PPTO'  UPDATE Presup       SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'CREDI' UPDATE Credito      SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'TMA'   UPDATE TMA          SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'RSS'   UPDATE RSS          SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'CMP'   UPDATE Campana      SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'FIS'   UPDATE Fiscal       SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      --REQ25014
      IF @Modulo = 'CONTP' UPDATE ContParalela SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE      
      --REQ16092
	  IF @Modulo = 'OPORT' UPDATE Oportunidad  SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE	  
      IF @Modulo = 'CORTE' UPDATE Corte        SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'FRM'   UPDATE FormaExtra   SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'CAPT'  UPDATE Captura      SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'GES'   UPDATE Gestion      SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'CP'    UPDATE CP           SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'PCP'   UPDATE PCP          SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE      
      IF @Modulo = 'PROY'  UPDATE Proyecto     SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      --IF @Modulo = 'ACT'   UPDATE Act           SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX01' UPDATE ModuloExtra01 SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX02' UPDATE ModuloExtra02 SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX03' UPDATE ModuloExtra03 SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX04' UPDATE ModuloExtra04 SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX05' UPDATE ModuloExtra05 SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX06' UPDATE ModuloExtra06 SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX07' UPDATE ModuloExtra07 SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX08' UPDATE ModuloExtra08 SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      --IF @Modulo = 'MEX09' UPDATE ModuloExtra09 SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'ORG'   UPDATE Organiza     SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'RE'    UPDATE Recluta      SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'ISL'   UPDATE ISL          SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'CAM'   UPDATE Cambio       SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'PACTO' UPDATE Contrato     SET FechaEmision = @FechaEmision WHERE ID = @ID ELSE
      IF @Modulo = 'SAUX'  UPDATE SAUX         SET FechaEmision = @FechaEmision WHERE ID = @ID 
    END
  END
  SELECT @FechaAfectacion = @FechaEmision
/*  IF @Accion = 'CANCELAR' 
  BEGIN
    EXEC spExtraerFecha @FechaRegistro OUTPUT
    IF @FechaRegistro > @FechaEmision
    BEGIN
      SELECT @Mes = DATEPART(month, @FechaEmision),
             @Ano = DATEPART(year,  @FechaEmision), 
             @DiaEmision = DATEPART(day, @FechaEmision)
      IF DATEPART(month, @FechaRegistro) > @Mes OR DATEPART(year, @FechaRegistro) > @Ano
      BEGIN
        EXEC spDiasMes @Mes, @Ano, @Dia OUTPUT
        SELECT @FechaAfectacion = DATEADD(day, @Dia-@DiaEmision, @FechaEmision)
      END ELSE SELECT @FechaAfectacion = @FechaRegistro
    END
  END*/
END
GO

-- spVerFechaTrabajo 'DEMO', 0
-- select * from fechatrabajo
/**************** spVerFechaTrabajo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVerFechaTrabajo') and type = 'P') drop procedure dbo.spVerFechaTrabajo
GO             
CREATE PROCEDURE spVerFechaTrabajo
			@Empresa	varchar(5),
			@Sucursal	int
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @FechaTrabajo datetime

  SELECT @FechaTrabajo = FechaTrabajo 
    FROM FechaTrabajo 
   WHERE Empresa = @Empresa AND Sucursal = @Sucursal
  IF @FechaTrabajo IS NULL
  BEGIN
    SELECT @FechaTrabajo = dbo.fnFechaSinHora(GETDATE())
    INSERT FechaTrabajo (
            Empresa,  Sucursal,  FechaTrabajo) 
    VALUES (@Empresa, @Sucursal, @FechaTrabajo)
  END
  SELECT 'FechaTrabajo' = @FechaTrabajo
  RETURN
END
GO

/**************** spFechaTrabajo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spFechaTrabajo') and type = 'P') drop procedure dbo.spFechaTrabajo
GO             
CREATE PROCEDURE spFechaTrabajo
			    @Sucursal	int = 0
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Empresa		char(5),
    @FechaTrabajo	datetime

  SELECT @FechaTrabajo = GETDATE()
  EXEC spExtraerFecha @FechaTrabajo OUTPUT

  DECLARE crFechaTrabajo CURSOR FOR
   SELECT Empresa
     FROM FechaTrabajo
    WHERE FechaTrabajo < @FechaTrabajo AND Sucursal = @Sucursal

  OPEN crFechaTrabajo
  FETCH NEXT FROM crFechaTrabajo INTO @Empresa
  WHILE @@FETCH_STATUS <> -1 
  BEGIN
    IF @@FETCH_STATUS <> -2 
    BEGIN
      UPDATE FechaTrabajo 
         SET FechaTrabajo = @FechaTrabajo 
       WHERE CURRENT OF crFechaTrabajo
    END
    FETCH NEXT FROM crFechaTrabajo INTO @Empresa
  END  -- While
  CLOSE crFechaTrabajo
  DEALLOCATE crFechaTrabajo

  RETURN
END
GO

/*
  DECLARE
		   @FormaMoneda 	char(10),
		   @FormaTipoCambio	float,
		   @Ok			int

EXEC spFormaPagoMonTC 'Efectivo', NULL, 'Pesos', 1.0, NULL, @FormaMoneda OUTPUT, @FormaTipoCambio OUTPUT, @Ok OUTPUT
SELECT @FormaMoneda, @FormaTipoCambio, @Ok
*/

/**************** spFormaPagoMonTC ****************/
if exists (select * from sysobjects where id = object_id('dbo.spFormaPagoMonTC') and type = 'P') drop procedure dbo.spFormaPagoMonTC
GO             
CREATE PROCEDURE spFormaPagoMonTC
		   @FormaPago		varchar(50),
		   @Referencia		varchar(50),
		   @Moneda		char(10),
		   @TipoCambio		float,
		   @Importe		money,
		   @SumaEfectivo	money		OUTPUT,
		   @FormaMoneda 	char(10)	OUTPUT,
		   @FormaTipoCambio	float		OUTPUT,
		   @Ok			int		OUTPUT,
		   @FormaCobroVales	varchar(50)	= NULL
		
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @MonedaEsp		char(10),
    @RequiereReferencia	bit,
    @PermiteCambio	bit

  SELECT @FormaMoneda = @Moneda, @FormaTipoCambio = @TipoCambio

  IF NULLIF(RTRIM(@FormaPago), '') IS NULL RETURN

  SELECT @MonedaEsp = NULL
  SELECT @MonedaEsp = NULLIF(RTRIM(Moneda), ''),
         @RequiereReferencia = ISNULL(RequiereReferencia, 0),
         @PermiteCambio      = ISNULL(PermiteCambio, 0)
    FROM FormaPago 
   WHERE FormaPago = @FormaPago

  IF @RequiereReferencia = 1 AND NULLIF(RTRIM(@Referencia), '') IS NULL SELECT @Ok = 20910
  IF @MonedaEsp IS NOT NULL
  BEGIN
    IF @MonedaEsp <> @Moneda
      SELECT @FormaMoneda = Moneda, @FormaTipoCambio = TipoCambio 
        FROM Mon
       WHERE Moneda = @MonedaEsp

    SELECT @Importe = @Importe * @FormaTipoCambio
  END
  IF @PermiteCambio = 1 SELECT @SumaEfectivo = ISNULL(@SumaEfectivo, 0) + ISNULL(@Importe, 0)

  IF @FormaCobroVales IS NOT NULL AND @FormaPago = @FormaCobroVales AND @Importe < 0.0 SELECT @Ok = 36100

  EXEC xpValidarFormaPago @FormaPago, @Referencia, @Importe, @Ok OUTPUT
  RETURN
END
GO

/**************** spVerFormaPagoMonTC ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVerFormaPagoMonTC') and type = 'P') drop procedure dbo.spVerFormaPagoMonTC --MEJORA5512
GO             
CREATE PROCEDURE spVerFormaPagoMonTC
           @Empresa			varchar(5),
		   @FormaPago		varchar(50),
		   @Referencia		varchar(50),
		   @Moneda			char(10),
		   @TipoCambio		float,
		   @Importe			money
		
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
  @SumaEfectivo				money,
  @FormaMoneda				char(10),
  @FormaTipoCambio			float,
  @Ok						int,
  @FormaCobroVales			varchar(50)

  SELECT @SumaEfectivo = null, @FormaMoneda = NULL, @FormaTipoCambio = NULL, @Ok = NULL, @FormaCobroVales = NULL

  SELECT @FormaPago = ISNULL(NULLIF(@FormaPago,''),FormaPagoCambio) FROM EmpresaCfg WHERE Empresa = @Empresa
      
  EXEC spFormaPagoMonTC @FormaPago, @Referencia, @Moneda, @TipoCambio, @Importe, @SumaEfectivo OUTPUT, @FormaMoneda OUTPUT, @FormaTipoCambio OUTPUT, @Ok OUTPUT, @FormaCobroVales
  
  SELECT @FormaTipoCambio  
  RETURN
END
GO


/**************** spFormaPagoTC ****************/
if exists (select * from sysobjects where id = object_id('dbo.spFormaPagoTC') and type = 'P') drop procedure dbo.spFormaPagoTC
GO             
CREATE PROCEDURE spFormaPagoTC
		   @FormaPago	varchar(50),
		   @Importe	money 	OUTPUT,
		   @Moneda	char(10) 	= NULL,
		   @TipoCambio	float 		= 1.0
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @FormaPagoMoneda char(10)

  SELECT @Importe = ISNULL(@Importe, 0.0), @FormaPago = NULLIF(RTRIM(@FormaPago), '')
  IF @Importe = 0.0 OR @FormaPago IS NULL RETURN

  SELECT @FormaPagoMoneda = Moneda
    FROM FormaPago
   WHERE FormaPago = @FormaPago

  IF ISNULL(@Moneda, '') = ISNULL(@FormaPagoMoneda, '')
    SELECT @Importe = @Importe * @TipoCambio
  ELSE
    SELECT @Importe = @Importe * TipoCambio FROM Mon WHERE Moneda = @FormaPagoMoneda
  RETURN
END
GO

/**************** spGastoAnexoEliminar ****************/
if exists (select * from sysobjects where id = object_id('dbo.spGastoAnexoEliminar') and type = 'P') drop procedure dbo.spGastoAnexoEliminar
GO
CREATE PROCEDURE spGastoAnexoEliminar
		   @Empresa			char(5),
    		   @AnexoModulo	      		char(5),
                   @AnexoID                  	int
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @ID  	int

  DECLARE crGastoAnexo CURSOR FOR
   SELECT ID
     FROM Gasto 
    WHERE Empresa = @Empresa AND AnexoModulo = @AnexoModulo AND AnexoID = @AnexoID AND Estatus = 'SINAFECTAR'

  OPEN crGastoAnexo
  FETCH NEXT FROM crGastoAnexo INTO @ID
  WHILE @@FETCH_STATUS <> -1 
  BEGIN
    IF @@FETCH_STATUS <> -2 
    BEGIN
      DELETE GastoD WHERE ID = @ID
      DELETE Gasto WHERE CURRENT OF crGastoAnexo
    END
    FETCH NEXT FROM crGastoAnexo INTO @ID
  END  -- While
  CLOSE crGastoAnexo
  DEALLOCATE crGastoAnexo

  RETURN
END
GO

/**************** spGastoConcepto ****************/
if exists (select * from sysobjects where id = object_id('dbo.spGastoConcepto') and type = 'P') drop procedure dbo.spGastoConcepto
GO             
CREATE PROCEDURE spGastoConcepto
			@Cfg		varchar(50),
			@ConceptoGasto	varchar(50),
			@Concepto	varchar(50)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  IF @Cfg = '(Concepto Gasto)'       SELECT @Concepto = @ConceptoGasto ELSE 
  IF @Cfg = 'ISR - (Concepto Gasto)' SELECT @Concepto = 'ISR ' + @ConceptoGasto ELSE 
  IF @Cfg = 'IVA - (Concepto Gasto)' SELECT @Concepto = 'IVA ' + @ConceptoGasto ELSE
  IF @Cfg = 'R3 - (Concepto Gasto)' SELECT @Concepto = 'R3 ' + @ConceptoGasto
  RETURN
END
GO

/**************** spIDEnMov ****************/
if exists (select * from sysobjects where id = object_id('dbo.spIDEnMov') and type = 'P') drop procedure dbo.spIDEnMov
GO             
CREATE PROCEDURE spIDEnMov
			@Modulo		char(5), 
			@ID		int,
		    	@Empresa	char(5)  	OUTPUT, 
			@Mov		char(20) 	OUTPUT, 
			@MovID 		varchar(20) 	OUTPUT, 
			@Moneda		char(10) 	OUTPUT,
      	                @Almacen	char(10) 	OUTPUT,
		        @AlmacenDestino char(10) 	OUTPUT,
                        @Ok		int	 	OUTPUT
--//WITH ENCRYPTION
AS BEGIN 
  SELECT @Empresa = NULL, @Mov = NULL, @MovID = NULL, @Moneda = NULL
  IF @Modulo = 'CONT'  SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Cont       WHERE ID = @ID ELSE
  IF @Modulo = 'VTAS'  SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda, @Almacen = Almacen, @AlmacenDestino = AlmacenDestino FROM Venta WHERE ID = @ID ELSE
  IF @Modulo = 'PROD'  SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda, @Almacen = Almacen FROM Prod WHERE ID = @ID ELSE
  IF @Modulo = 'INV'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda, @Almacen = Almacen, @AlmacenDestino = AlmacenDestino FROM Inv   WHERE ID = @ID ELSE
  IF @Modulo = 'COMS'  SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda, @Almacen = Almacen FROM Compra WHERE ID = @ID ELSE
  IF @Modulo = 'CXC'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Cxc        WHERE ID = @ID ELSE
  IF @Modulo = 'CXP'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Cxp        WHERE ID = @ID ELSE
  IF @Modulo = 'AGENT' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Agent      WHERE ID = @ID ELSE
  IF @Modulo = 'GAS'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Gasto      WHERE ID = @ID ELSE
  IF @Modulo = 'DIN'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Dinero     WHERE ID = @ID ELSE
  IF @Modulo = 'AF'    SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM ActivoFijo WHERE ID = @ID ELSE
  IF @Modulo = 'PC'    SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM PC         WHERE ID = @ID ELSE
  IF @Modulo = 'OFER'  SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Oferta     WHERE ID = @ID ELSE
  IF @Modulo = 'VALE'  SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Vale       WHERE ID = @ID ELSE
  IF @Modulo = 'CR'    SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM CR         WHERE ID = @ID ELSE
  IF @Modulo = 'NOM'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Nomina     WHERE ID = @ID ELSE
  IF @Modulo = 'RH'    SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM RH         WHERE ID = @ID ELSE
  IF @Modulo = 'ASIS'  SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Asiste     WHERE ID = @ID ELSE
  IF @Modulo = 'CAP'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Capital    WHERE ID = @ID ELSE
  IF @Modulo = 'INC'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Incidencia WHERE ID = @ID ELSE
  IF @Modulo = 'CONC'  SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Conciliacion WHERE ID = @ID ELSE
  IF @Modulo = 'PPTO'  SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Presup     WHERE ID = @ID ELSE
  IF @Modulo = 'CREDI' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Credito  WHERE ID = @ID ELSE
  IF @Modulo = 'TMA'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID FROM TMA        WHERE ID = @ID ELSE
  IF @Modulo = 'RSS'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID FROM RSS        WHERE ID = @ID ELSE
  IF @Modulo = 'CMP'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID FROM Campana    WHERE ID = @ID ELSE
  IF @Modulo = 'FIS'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Fiscal  WHERE ID = @ID ELSE
  --REQ25014
  IF @Modulo = 'CONTP' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID FROM ContParalela WHERE ID = @ID ELSE  
  --REQ16092
  IF @Modulo = 'OPORT' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Oportunidad     WHERE ID = @ID ELSE  
  IF @Modulo = 'CORTE' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID FROM Corte      WHERE ID = @ID ELSE
  IF @Modulo = 'FRM'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID FROM FormaExtra  WHERE ID = @ID ELSE
  IF @Modulo = 'CAPT'  SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID FROM Captura     WHERE ID = @ID ELSE
  IF @Modulo = 'GES'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID FROM Gestion     WHERE ID = @ID ELSE
  IF @Modulo = 'CP'    SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM CP         WHERE ID = @ID ELSE
  IF @Modulo = 'PCP'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM PCP        WHERE ID = @ID ELSE  
  IF @Modulo = 'PROY'  SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Proyecto   WHERE ID = @ID ELSE
  --IF @Modulo = 'ACT'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID FROM Act           WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX01' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM ModuloExtra01 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX02' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM ModuloExtra02 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX03' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM ModuloExtra03 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX04' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM ModuloExtra04 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX05' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM ModuloExtra05 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX06' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM ModuloExtra06 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX07' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM ModuloExtra07 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX08' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM ModuloExtra08 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX09' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM ModuloExtra09 WHERE ID = @ID ELSE
  IF @Modulo = 'ORG'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Organiza WHERE ID = @ID ELSE
  IF @Modulo = 'RE'    SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Recluta  WHERE ID = @ID ELSE
  IF @Modulo = 'ISL'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM ISL      WHERE ID = @ID ELSE
  IF @Modulo = 'EMB'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID FROM Embarque   WHERE ID = @ID ELSE
  IF @Modulo = 'ST'    SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID FROM Soporte    WHERE ID = @ID ELSE
  IF @Modulo = 'CAM'   SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID FROM Cambio     WHERE ID = @ID ELSE
  IF @Modulo = 'PACTO' SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Contrato WHERE ID = @ID ELSE
  IF @Modulo = 'SAUX'  SELECT @Empresa = Empresa, @Mov = Mov, @MovID = MovID/*, @Moneda = Moneda*/ FROM SAUX WHERE ID = @ID 
  IF @Empresa IS NULL SELECT @Ok = 60220
END
GO

/**************** spInvAnexarTodoDetalle ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInvAnexarTodoDetalle') and type = 'P') drop procedure dbo.spInvAnexarTodoDetalle
GO             
CREATE PROCEDURE spInvAnexarTodoDetalle
		   @Empresa		char(5),
		   @Modulo		char(5),
    		   @ID                	int,
                   @AnexoID		int,
		   @CfgImpInc		bit,
  		   @CfgMultiUnidades	bit,
		   @Ok			int	OUTPUT,
		   @CfgPrecioMoneda	bit = 0
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Renglon 		float,
    @DescuentoGlobal	float,
    @SobrePrecio	float,
    @RenglonID int

  -- SET nocount ON
  IF @Modulo = 'VTAS'
  BEGIN
    SELECT @DescuentoGlobal = DescuentoGlobal, @SobrePrecio = SobrePrecio FROM Venta WHERE ID = @AnexoID
    SELECT @Renglon = MAX(Renglon), @RenglonID = MAX(RenglonID) FROM VentaD WHERE ID = @AnexoID
    
    IF ISNULL(@CfgMultiUnidades, 0) = 0
      UPDATE d
         SET d.Unidad = a.Unidad
        FROM VentaD d
        JOIN Art a ON d.Articulo = a.Articulo
       WHERE d.ID = @ID
    
    SELECT * INTO #VentaDetalle FROM cVentaD WHERE ID = @ID
    IF @@ERROR <> 0 SELECT @Ok = 1

    UPDATE #VentaDetalle SET ID = @AnexoID, Renglon = Renglon + @Renglon, RenglonID = RenglonID + @RenglonID, CantidadPendiente = Cantidad, AplicaRenglon = @Renglon
    IF @@ERROR <> 0 SELECT @Ok = 1

    -- Actualizar Descuento Importe
    UPDATE #VentaDetalle SET DescuentoImporte = (Cantidad*Precio)*(DescuentoLinea/100.0), CantidadA = Cantidad
    IF @@ERROR <> 0 SELECT @Ok = 1


    IF EXISTS ( SELECT s.SerieLote FROM SerieLoteMov s JOIN Art a ON s.Articulo = a.Articulo 
                                  WHERE s.Modulo = @Modulo AND s.ID IN (@AnexoID, @ID) AND a.tipo = 'SERIE'
                                  GROUP BY s.Empresa, s.Modulo, s.Articulo, s.SubCuenta, s.SerieLote
                                 HAVING COUNT(SerieLote) > 1 )

       SELECT @Ok = 20080 

    IF @Ok IS NULL
      INSERT SerieLoteMov (Sucursal, Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, CantidadAlterna, Propiedades, Ubicacion, Cliente, Localizacion, ArtCostoInv)
      SELECT m.Sucursal, m.Empresa, m.Modulo, @AnexoID, m.RenglonID+@RenglonID, m.Articulo, m.SubCuenta, m.SerieLote, m.Cantidad, m.CantidadAlterna, m.Propiedades, m.Ubicacion, m.Cliente, m.Localizacion, m.ArtCostoInv
        FROM SerieLoteMov m
       WHERE m.Modulo = @Modulo AND m.ID = @ID
           IF @@ERROR <> 0 SELECT @Ok = 1

    IF @Ok IS NULL  
      INSERT INTO cVentaD SELECT * FROM #VentaDetalle --WHERE ID = @ID
      IF @@ERROR <> 0 SELECT @Ok = 1

    DROP TABLE #VentaDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1

    EXEC spInvReCalcEncabezado @AnexoID, @Modulo, @CfgImpInc, @CfgMultiUnidades, @DescuentoGlobal, @SobrePrecio, @CfgPrecioMoneda = @CfgPrecioMoneda
  END

  RETURN
END
GO

/**************** spInvGenerarDetalle ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInvGenerarDetalle') and type = 'P') drop procedure dbo.spInvGenerarDetalle
GO             
CREATE PROCEDURE spInvGenerarDetalle
		   @Sucursal		int,
		   @Modulo		char(5),
    		   @ID                	int,
		   @Renglon		float,
	           @RenglonSub		int,
                   @GenerarID		int,
		   @GenerarDirecto	bit,
                   @Mov			char(20),
                   @MovID		varchar(20),
	           @Cantidad		float,

		   @Ok			int	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  IF @GenerarDirecto = 1 SELECT @Mov = NULL, @MovID = NULL

  IF @Modulo = 'VTAS'
  BEGIN
    SELECT * INTO #VentaDetalle FROM cVentaD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub 
    IF @@ERROR <> 0 SELECT @Ok = 1

    UPDATE #VentaDetalle SET Sucursal = @Sucursal, ID = @GenerarID, SustitutoArticulo = NULL, SustitutoSubCuenta = NULL, CantidadReservada = NULL, CantidadOrdenada = NULL, CantidadPendiente = NULL, CantidadA = NULL, CantidadCancelada = NULL, Aplica = @Mov, AplicaID = @MovID, Cantidad = @Cantidad, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = @Renglon
    IF @@ERROR <> 0 SELECT @Ok = 1

    -- Actualizar Descuento Importe
    UPDATE #VentaDetalle SET DescuentoImporte = (Cantidad*Precio)*(DescuentoLinea/100.0)
    IF @@ERROR <> 0 SELECT @Ok = 1

    INSERT INTO cVentaD SELECT * FROM #VentaDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1

    DROP TABLE #VentaDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1
  END ELSE

  IF @Modulo = 'PROD'
  BEGIN
    SELECT * INTO #ProdDetalle FROM cProdD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub 
    IF @@ERROR <> 0 SELECT @Ok = 1

    UPDATE #ProdDetalle SET Sucursal = @Sucursal, ID = @GenerarID, SustitutoArticulo = NULL, SustitutoSubCuenta = NULL, CantidadReservada = NULL, CantidadOrdenada = NULL, CantidadPendiente = NULL, CantidadA = NULL, CantidadCancelada = NULL, Aplica = @Mov, AplicaID = @MovID, Cantidad = @Cantidad, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = @Renglon
    IF @@ERROR <> 0 SELECT @Ok = 1

    INSERT INTO cProdD SELECT * FROM #ProdDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1

    DROP TABLE #ProdDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1
  END ELSE

  IF @Modulo = 'COMS'
  BEGIN
    SELECT * INTO #CompraDetalle FROM cCompraD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub 
    IF @@ERROR <> 0 SELECT @Ok = 1

    UPDATE #CompraDetalle SET Sucursal = @Sucursal, ID = @GenerarID, CantidadPendiente = NULL, CantidadA = NULL, CantidadCancelada = NULL, Aplica = @Mov, AplicaID = @MovID, Cantidad = @Cantidad, AplicaRenglon = @Renglon
    IF @@ERROR <> 0 SELECT @Ok = 1

    -- Actualizar Descuento Importe
    UPDATE #CompraDetalle SET DescuentoImporte = (Cantidad*Costo)*(DescuentoLinea/100.0)
    IF @@ERROR <> 0 SELECT @Ok = 1

    INSERT INTO cCompraD SELECT * FROM #CompraDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1

    DROP TABLE #CompraDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1
  END ELSE

  IF @Modulo = 'INV'
  BEGIN
    SELECT * INTO #InvDetalle FROM cInvD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub 
    IF @@ERROR <> 0 SELECT @Ok = 1

    UPDATE #InvDetalle SET Sucursal = @Sucursal, ID = @GenerarID, CantidadReservada = NULL, CantidadOrdenada = NULL, CantidadPendiente = NULL, CantidadA = NULL, CantidadCancelada = NULL, Aplica = @Mov, AplicaID = @MovID, Cantidad = @Cantidad, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = @Renglon
    IF @@ERROR <> 0 SELECT @Ok = 1

    INSERT INTO cInvD SELECT * FROM #InvDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1

    DROP TABLE #InvDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1
  END 

  RETURN
END
GO

-- spMovCopiar 0, 'VTAS', 49177, 'DEMO', '1/12/2001'
--REQ12615 WMS
/**************** spInvUtilizarTodoDetalleWMS ****************/ --BUG 14127
if exists (select * from sysobjects where id = object_id('dbo.spInvUtilizarTodoDetalleWMS') and type = 'P') drop procedure dbo.spInvUtilizarTodoDetalleWMS --BUG 14127
GO             
CREATE PROCEDURE spInvUtilizarTodoDetalleWMS --BUG 14127
			@Modulo			char(5),
    		@OID           	int,
            @DID			int

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @OMov			varchar(20),
    @DMov			varchar(20),
    @MovTipo		varchar(20),
    @SubClave		varchar(20)

  IF @Modulo = 'INV'
  BEGIN      
    SELECT @OMov = Mov FROM Inv WHERE ID = @OID
    SELECT @DMov = Mov FROM Inv WHERE ID = @DID
	SELECT @MovTipo = Clave, @SubClave = SubClave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @OMov
    IF @OMov = @DMov AND @MovTipo <> 'INV.SI' AND ISNULL(@SubClave,'') = ''
      UPDATE InvD SET Tarima = NULL WHERE ID = @DID
  END
  ELSE
  IF @Modulo = 'TMA'
  BEGIN      
    SELECT @OMov = Mov FROM TMA WHERE ID = @OID
    SELECT @DMov = Mov FROM TMA WHERE ID = @DID
    SELECT @MovTipo = Clave, @SubClave = SubClave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @OMov
    IF @OMov = @DMov
      UPDATE TMAD SET Tarima = NULL WHERE ID = @DID
  END
  ELSE
  IF @Modulo = 'COMS'
  BEGIN      
    SELECT @OMov = Mov FROM Compra WHERE ID = @OID
    SELECT @DMov = Mov FROM Compra WHERE ID = @DID
    SELECT @MovTipo = Clave, @SubClave = SubClave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @OMov
    IF @OMov = @DMov
      UPDATE CompraD SET Tarima = NULL WHERE ID = @DID
  END
  ELSE
  IF @Modulo = 'VTAS'
  BEGIN      
    SELECT @OMov = Mov FROM Venta WHERE ID = @OID
    SELECT @DMov = Mov FROM Venta WHERE ID = @DID
    SELECT @MovTipo = Clave, @SubClave = SubClave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @OMov
    IF @OMov = @DMov
      UPDATE VentaD SET Tarima = NULL WHERE ID = @DID
  END
  RETURN
END
GO

/**************** spInvUtilizarTodoDetalle ****************/
if exists (select * from sysobjects where id = object_id('dbo.spInvUtilizarTodoDetalle') and type = 'P') drop procedure dbo.spInvUtilizarTodoDetalle
GO             
CREATE PROCEDURE spInvUtilizarTodoDetalle
		   @Sucursal		int,
		   @Modulo		    char(5),
		   @Base		    char(20), 		-- IDENTICO
    	   @OID           	int,
           @OrigenMov		char(20),
           @OrigenMovID		varchar(20),
           @OrigenMovTipo	char(20),
           @DID			    int,
		   @GenerarDirecto	bit,
		   @Ok			    int	OUTPUT,
		   @Empresa		    char(5)	= NULL,
		   @MovTipo		    varchar(20) = NULL
--//WITH ENCRYPTION
AS BEGIN
--REQ12615 WMS
  DECLARE
    @OMov			varchar(20),
    @DMov			varchar(20),
    @RenglonTipo	varchar(1), 
    @RenglonID		int,
    @Cantidad		float,
    @HuboCambio		bit,
    @MonedaD        varchar(10),
    @TipoCambioD    float,

	@CantidadP      float,
	@CantidadaE     float,
	@Articulo	    varchar(20),
	@Subcuenta		varchar(50),
	@Tarima			varchar(20),
	@Almacen		varchar(10),
	@cTarima		varchar(20),
	@cArticulo		varchar(20),
	@cSerieLote		varchar(50), 
	@cSubCuenta		varchar(50), 
	@cAlmacen		varchar(10), 
	@cSucursal		int, 
	@cEmpresa		varchar(5), 
	@cExistencia	float,
	@cRenglonID		int,
	@SubClave		varchar(20),
    @Proveedor      varchar(10),
    @Referencia     varchar(100)

    DECLARE @SerieLoteMov as TABLE (Empresa varchar(5) null, Modulo varchar(5) null, ID int null, RenglonID int null, Articulo varchar(20) null, SubCuenta varchar(50) null,
	  							SerieLote varchar(50) null,	Cantidad float null, CantidadAlterna float null, Propiedades varchar(20) null, Ubicacion int null, Cliente varchar(10) null,
								Localizacion varchar(10) null, Sucursal int null, ArtCostoInv money null, Tarima varchar(20) null, AsignacionUbicacion bit null)

  IF @Modulo = 'VTAS'
  BEGIN
    --REQ12615 WMS
    SELECT @OMov = Mov FROM Venta WHERE ID = @OID
    SELECT @DMov = Mov FROM Venta WHERE ID = @DID
    IF @OMov = @DMov
      UPDATE VentaD SET Tarima = NULL WHERE ID = @DID
    --REQ12615 WMS

    IF @GenerarDirecto = 1 SELECT @OrigenMov = NULL, @OrigenMovID = NULL
    SELECT * INTO #VentaDetalle FROM cVentaD   WHERE ID = @OID
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF @Base IN ('TODO', 'IDENTICO') UPDATE #VentaDetalle SET ID = @DID, CantidadPendiente = NULL, CantidadCancelada = NULL, CantidadReservada = NULL, CantidadOrdenada = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = Renglon  ELSE
    IF @Base = 'SELECCION' UPDATE #VentaDetalle SET ID = @DID, Cantidad = CantidadA, CantidadInventario = CantidadA * CantidadInventario / Cantidad, CantidadPendiente = NULL, CantidadCancelada = NULL, CantidadReservada = NULL, CantidadOrdenada = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = Renglon  ELSE
	IF @Base = 'PENDIENTE' UPDATE #VentaDetalle SET ID = @DID, Cantidad = NULLIF(ISNULL(CantidadPendiente,0.0)/* + ISNULL(CantidadReservada, 0.0)*/, 0.0), CantidadInventario = (NULLIF(ISNULL(CantidadPendiente,0.0) + ISNULL(CantidadReservada, 0.0), 0.0)) * CantidadInventario / Cantidad, CantidadPendiente = NULL, CantidadReservada = NULL, CantidadCancelada = NULL, CantidadOrdenada = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = Renglon  ELSE    
    IF @Base = 'RESERVADO' UPDATE #VentaDetalle SET ID = @DID, Cantidad = CantidadReservada, CantidadInventario = CantidadReservada * CantidadInventario / Cantidad, CantidadPendiente = NULL, CantidadCancelada = NULL, CantidadReservada = NULL, CantidadOrdenada = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = Renglon  
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF @Base = 'IDENTICO'
      UPDATE #VentaDetalle SET Aplica = o.Aplica, AplicaID = o.AplicaID FROM #VentaDetalle n, VentaD o WHERE o.ID = @OID AND n.Renglon = o.Renglon AND n.RenglonSub = o.RenglonSub
    ELSE
      UPDATE #VentaDetalle SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, SustitutoArticulo = NULL, SustitutoSubCuenta = NULL

/*
    IF @Base = 'SELECCION'
      UPDATE #VentaDetalle SET Precio = Precio * Factor WHERE Factor <> 1.0
    ELSE
      UPDATE #VentaDetalle SET Cantidad = Cantidad / Factor, Precio = Precio * Factor WHERE Factor <> 1.0
*/
    SELECT @HuboCambio = 0
    DECLARE crJuegoReservado CURSOR FOR
      SELECT RenglonTipo, RenglonID, Cantidad
        FROM #VentaDetalle
      WHERE RenglonTipo IN ('J', 'C')  

    OPEN crJuegoReservado
    FETCH NEXT FROM crJuegoReservado INTO @RenglonTipo, @RenglonID, @Cantidad
    WHILE @@FETCH_STATUS = 0
    BEGIN
	  IF @RenglonTipo = 'J' BEGIN
	  	IF ISNULL(@Cantidad, 0.0) = 0.0 BEGIN
	      IF (SELECT SUM(ISNULL(Cantidad, 0.0)) FROM #VentaDetalle WHERE RenglonTipo = 'C' AND RenglonID = @RenglonID) > 0 BEGIN
	        UPDATE #VentaDetalle SET Cantidad = -1 WHERE RenglonTipo = @RenglonTipo AND RenglonID = @RenglonID
	        SELECT @HuboCambio = 1                  
	      END  
	    END
	  END 

      FETCH NEXT FROM crJuegoReservado INTO @RenglonTipo, @RenglonID, @Cantidad
    END
    CLOSE crJuegoReservado
    DEALLOCATE crJuegoReservado

    DELETE #VentaDetalle WHERE Cantidad IS NULL OR Cantidad = 0.0
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF @HuboCambio = 1 
      UPDATE #VentaDetalle SET Cantidad = NULL WHERE Cantidad = -1

    -- Actualizar Descuento Importe
    UPDATE #VentaDetalle SET DescuentoImporte = (Cantidad*Precio)*(DescuentoLinea/100.0)
    IF @@ERROR <> 0 SELECT @Ok = 1

    INSERT INTO cVentaD SELECT * FROM #VentaDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1

    DROP TABLE #VentaDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1
  END ELSE

  IF @Modulo = 'PROD'
  BEGIN
    IF @GenerarDirecto = 1 SELECT @OrigenMov = NULL, @OrigenMovID = NULL
    SELECT * INTO #ProdDetalle FROM cProdD WHERE ID = @OID

    IF @@ERROR <> 0 SELECT @Ok = 1
    IF @Base = 'TODO' DELETE #ProdDetalle WHERE AutoGenerado = 1
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF @Base = 'TODO'      UPDATE #ProdDetalle SET ID = @DID, AutoGenerado = 0, ProdSerieLote = NULL, CantidadPendiente = NULL, CantidadCancelada = NULL, CantidadReservada = NULL, CantidadOrdenada = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = Renglon ELSE
    IF @Base = 'SELECCION' UPDATE #ProdDetalle SET ID = @DID, AutoGenerado = 0, Cantidad = CantidadA, CantidadInventario = CantidadA * CantidadInventario / Cantidad, CantidadPendiente = NULL, CantidadCancelada = NULL, CantidadReservada = NULL, CantidadOrdenada = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = Renglon ELSE
    IF @Base = 'PENDIENTE' UPDATE #ProdDetalle SET ID = @DID, AutoGenerado = 0, Cantidad = NULLIF(ISNULL(CantidadPendiente,0.0) + ISNULL(CantidadReservada, 0.0), 0.0), CantidadInventario = (NULLIF(ISNULL(CantidadPendiente,0.0) + ISNULL(CantidadReservada, 0.0), 0.0)) * CantidadInventario / Cantidad, CantidadPendiente = NULL, CantidadReservada = NULL, CantidadCancelada = NULL, CantidadOrdenada = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = Renglon ELSE
    IF @Base = 'RESERVADO' UPDATE #ProdDetalle SET ID = @DID, AutoGenerado = 0, Cantidad = CantidadReservada, CantidadInventario = CantidadReservada * CantidadInventario / Cantidad, CantidadPendiente = NULL, CantidadCancelada = NULL, CantidadReservada = NULL, CantidadOrdenada = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = Renglon

    UPDATE #ProdDetalle SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, DestinoTipo = NULL, Destino = NULL, DestinoID = NULL

    IF @@ERROR <> 0 SELECT @Ok = 1

    UPDATE #ProdDetalle SET SustitutoArticulo = NULL, SustitutoSubCuenta = NULL

    DELETE #ProdDetalle WHERE Cantidad IS NULL OR Cantidad = 0.0
    IF @@ERROR <> 0 SELECT @Ok = 1

    CREATE TABLE #ProdAplica(
      Aplica		  char(20)	COLLATE Database_Default NULL, 
      AplicaID		  varchar(20)	COLLATE Database_Default NULL, 
      ProdSerieLote	  varchar(50)	COLLATE Database_Default NULL,
      Articulo		  char(20)	COLLATE Database_Default NULL, 
      SubCuenta		  varchar(50)	COLLATE Database_Default NULL,
      Unidad		  varchar(50)	COLLATE Database_Default NULL,
      Almacen		  char(10)	COLLATE Database_Default NULL,
      Centro		  char(10)	COLLATE Database_Default NULL,
      Renglon		  float		NULL,
      RenglonSub	  int		NULL,
      Cantidad		  float		NULL,
      CantidadInventario  float		NULL,
      AplicaRenglon		  float		NULL)

    INSERT 
      INTO #ProdAplica
    SELECT Aplica, AplicaID, ProdSerieLote, Articulo, SubCuenta, Unidad, Almacen, Centro, Min(Renglon), Min(RenglonSub), SUM(Cantidad), SUM(CantidadInventario), AplicaRenglon
      FROM #ProdDetalle 
     GROUP BY Aplica, AplicaID, ProdSerieLote, Articulo, SubCuenta, Unidad, Almacen, Centro, AplicaRenglon
     ORDER BY Aplica, AplicaID, ProdSerieLote, Articulo, SubCuenta, Unidad, Almacen, Centro, AplicaRenglon
    IF @@ERROR <> 0 SELECT @Ok = 1

    INSERT INTO cProdD 
    SELECT d.* 
      FROM #ProdDetalle d, #ProdAplica a 
     WHERE ISNULL(d.ProdSerieLote, '') = ISNULL(a.ProdSerieLote, '')
       AND ISNULL(d.Aplica,'') = ISNULL(a.Aplica, '') 
       AND ISNULL(d.AplicaID, '') = ISNULL(a.AplicaID, '')
       AND d.Articulo = a.Articulo
       AND ISNULL(d.SubCuenta,'') = ISNULL(a.SubCuenta, '')
       AND d.Almacen = a.Almacen
       AND ISNULL(d.Centro, '') = ISNULL(a.Centro, '')
       AND d.Renglon = a.Renglon
       AND d.RenglonSub = a.RenglonSub
       AND d.AplicaRenglon = a.AplicaRenglon
      IF @@ERROR <> 0 SELECT @Ok = 1

    UPDATE ProdD 
       SET ProdD.Cantidad = a.Cantidad,
           ProdD.CantidadInventario = a.CantidadInventario
      FROM ProdD d, #ProdAplica a 
     WHERE d.ID = @DID 
       AND ISNULL(d.ProdSerieLote, '') = ISNULL(a.ProdSerieLote, '')
       AND ISNULL(d.Aplica,'') = ISNULL(a.Aplica, '') 
       AND ISNULL(d.AplicaID, '') = ISNULL(a.AplicaID, '')
       AND d.Articulo = a.Articulo 
       AND ISNULL(d.SubCuenta,'') = ISNULL(a.SubCuenta, '')
       AND d.Almacen = a.Almacen
       AND ISNULL(d.Centro, '') = ISNULL(a.Centro, '')
       AND d.Renglon = a.Renglon
       AND d.RenglonSub = a.RenglonSub
       AND d.AplicaRenglon = a.AplicaRenglon
      IF @@ERROR <> 0 SELECT @Ok = 1

    DROP TABLE #ProdDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1
  END ELSE

  IF @Modulo = 'COMS'
  BEGIN

    --REQ12615 WMS
    SELECT @OMov = Mov, @MonedaD = Moneda, @TipoCambioD = TipoCambio, @Proveedor = Proveedor, @Referencia = @Referencia FROM Compra WHERE ID = @OID
    SELECT @DMov = Mov FROM Compra WHERE ID = @DID
    IF @OMov = @DMov
      UPDATE CompraD SET Tarima = NULL WHERE ID = @DID
    --REQ12615 WMS

    SELECT @SubClave = Subclave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @DMov

    SELECT * INTO #CompraDetalle FROM cCompraD  WHERE ID = @OID
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF @Base IN ('TODO', 'IDENTICO') UPDATE #CompraDetalle SET ID = @DID, CantidadCancelada = NULL, CantidadPendiente = NULL, CantidadA = NULL, Aplica = CASE WHEN @OrigenMovTipo <> 'COMS.C' THEN @OrigenMov ELSE Aplica END, AplicaID = CASE WHEN @OrigenMovTipo <> 'COMS.C' THEN @OrigenMovID ELSE AplicaID END, AplicaRenglon = Renglon ELSE
    IF @Base = 'SELECCION' UPDATE #CompraDetalle SET ID = @DID, DestinoTipo = CASE WHEN @MovTipo IN ('COMS.CP', 'COMS.O', 'COMS.EI') THEN DestinoTipo ELSE NULL END, Destino = CASE WHEN @MovTipo IN ('COMS.CP', 'COMS.O', 'COMS.EI') THEN Destino ELSE NULL END, DestinoID = CASE WHEN @MovTipo IN ('COMS.CP', 'COMS.O', 'COMS.EI') THEN DestinoID ELSE NULL END, Cantidad = CantidadA, CantidadInventario = CantidadA * CantidadInventario / Cantidad, CantidadCancelada = NULL, CantidadPendiente = NULL, CantidadA = NULL, Aplica = CASE WHEN @OrigenMovTipo <> 'COMS.C' THEN @OrigenMov ELSE Aplica END, AplicaID = CASE WHEN @OrigenMovTipo <> 'COMS.C' THEN @OrigenMovID ELSE AplicaID END, AplicaRenglon = Renglon ELSE
    IF @Base = 'PENDIENTE' UPDATE #CompraDetalle SET ID = @DID, DestinoTipo = CASE WHEN @MovTipo IN ('COMS.CP', 'COMS.O', 'COMS.EI') THEN DestinoTipo ELSE NULL END, Destino = CASE WHEN @MovTipo IN ('COMS.CP', 'COMS.O', 'COMS.EI') THEN Destino ELSE NULL END, DestinoID = CASE WHEN @MovTipo IN ('COMS.CP', 'COMS.O', 'COMS.EI') THEN DestinoID ELSE NULL END, Cantidad = CantidadPendiente, CantidadInventario = CantidadPendiente * CantidadInventario / Cantidad, CantidadCancelada = NULL, CantidadPendiente = NULL, CantidadA = NULL, Aplica = CASE WHEN @OrigenMovTipo <> 'COMS.C' THEN @OrigenMov ELSE Aplica END, AplicaID = CASE WHEN @OrigenMovTipo <> 'COMS.C' THEN @OrigenMovID ELSE AplicaID END, AplicaRenglon = Renglon 
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF @Base <> 'IDENTICO'
      UPDATE #CompraDetalle SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal 

    IF @MovTipo = 'COMS.EI' OR @SubClave = 'COMS.EIMPO'
      UPDATE #CompraDetalle SET MonedaD = @MonedaD, TipoCambioD = @TipoCambioD, ImportacionProveedor = @Proveedor, ImportacionReferencia = @Referencia


    DELETE #CompraDetalle WHERE Cantidad IS NULL OR Cantidad = 0.0
    IF @@ERROR <> 0 SELECT @Ok = 1
    
    IF @OrigenMovTipo IN ('COMS.R','COMS.O','COMS.OP','COMS.OG','COMS.OD','COMS.OI')
    BEGIN
      CREATE TABLE #CompraAplica(
        Almacen			char(10)	COLLATE Database_Default NULL,
        Aplica			char(20)	COLLATE Database_Default NULL, 
        AplicaID		varchar(20)	COLLATE Database_Default NULL, 
        Articulo		char(20)	COLLATE Database_Default NULL, 
        SubCuenta		varchar(50)	COLLATE Database_Default NULL,
	Unidad			varchar(50)	COLLATE Database_Default NULL,
	Cliente			char(10)	COLLATE Database_Default NULL,
	ContUso			char(20)	COLLATE Database_Default NULL,
	FechaRequerida		datetime	NULL,
        Renglon			float		NULL,
        RenglonSub		int		NULL,
        Cantidad		float		NULL,
        CantidadInventario  	float		NULL,
	Costo			float		NULL,
	ContUso2		char(20)	COLLATE Database_Default NULL,
	ContUso3		char(20)	COLLATE Database_Default NULL,
	AplicaRenglon	float NULL)
	
      IF (SELECT CompraConcentrarEntrada FROM EmpresaCfg WHERE Empresa = @Empresa) = 1
        INSERT 
          INTO #CompraAplica
        SELECT Almacen, Aplica, AplicaID, Articulo, SubCuenta, Unidad, Cliente, ContUso, FechaRequerida, Min(Renglon), Min(RenglonSub), SUM(Cantidad), SUM(CantidadInventario), SUM(Costo*Cantidad)/SUM(Cantidad), ContUso2, ContUso3, AplicaRenglon
          FROM #CompraDetalle 
         GROUP BY Almacen, Aplica, AplicaID, Articulo, SubCuenta, Unidad, Cliente, ContUso, FechaRequerida, ContUso2, ContUso3, AplicaRenglon
         ORDER BY Almacen, Aplica, AplicaID, Articulo, SubCuenta, Unidad, Cliente, ContUso, FechaRequerida, ContUso2, ContUso3, AplicaRenglon
      ELSE
        INSERT 
          INTO #CompraAplica
        SELECT Almacen, Aplica, AplicaID, Articulo, SubCuenta, Unidad, Cliente, ContUso, FechaRequerida, Renglon, RenglonSub, Cantidad, CantidadInventario, Costo, ContUso2, ContUso3, AplicaRenglon
          FROM #CompraDetalle 
         --GROUP BY Almacen, Aplica, AplicaID, Articulo, SubCuenta, Unidad, Cliente, ContUso, FechaRequerida
         --ORDER BY Almacen, Aplica, AplicaID, Articulo, SubCuenta, Unidad, Cliente, ContUso, FechaRequerida
      IF @@ERROR <> 0 SELECT @Ok = 1

      -- Actualizar Descuento Importe
      UPDATE #CompraDetalle SET DescuentoImporte = (Cantidad*Costo)*(DescuentoLinea/100.0)
      IF @@ERROR <> 0 SELECT @Ok = 1

      INSERT INTO cCompraD 
      SELECT d.* 
        FROM #CompraDetalle d, #CompraAplica a 
       WHERE d.Almacen = a.Almacen
         AND d.Aplica = a.Aplica 
         AND d.AplicaID = a.AplicaID 
         AND d.Articulo = a.Articulo 
         AND ISNULL(d.SubCuenta,'') = ISNULL(a.SubCuenta, '')
         AND ISNULL(d.Cliente,'') = ISNULL(a.Cliente, '')
         AND d.Renglon = a.Renglon
         AND d.RenglonSub = a.RenglonSub
		 AND d.AplicaRenglon = a.AplicaRenglon
      IF @@ERROR <> 0 SELECT @Ok = 1


      UPDATE CompraD 
         SET DestinoTipo    = CASE WHEN @MovTipo IN ('COMS.CP', 'COMS.O', 'COMS.EI') THEN DestinoTipo ELSE NULL END,
             Destino        = CASE WHEN @MovTipo IN ('COMS.CP', 'COMS.O', 'COMS.EI') THEN Destino     ELSE NULL END, 
             DestinoID      = CASE WHEN @MovTipo IN ('COMS.CP', 'COMS.O', 'COMS.EI') THEN DestinoID   ELSE NULL END, 
             CompraD.Cantidad = a.Cantidad,
             CompraD.CantidadInventario = a.CantidadInventario,
             CompraD.Costo  = a.Costo
        FROM CompraD d, #CompraAplica a 
       WHERE d.ID = @DID 
         AND d.Almacen = a.Almacen
         AND d.Aplica = a.Aplica 
         AND d.AplicaID = a.AplicaID 
         AND d.Articulo = a.Articulo 
         AND ISNULL(d.SubCuenta,'') = ISNULL(a.SubCuenta, '')
         AND ISNULL(d.Cliente,'') = ISNULL(a.Cliente, '')
         AND d.Renglon = a.Renglon
         AND d.RenglonSub = a.RenglonSub
		 AND d.AplicaRenglon = a.AplicaRenglon
      IF @@ERROR <> 0 SELECT @Ok = 1
    END ELSE
    BEGIN
      -- Actualizar Descuento Importe
      UPDATE #CompraDetalle SET DescuentoImporte = (Cantidad*Costo)*(DescuentoLinea/100.0)
      IF @@ERROR <> 0 SELECT @Ok = 1

      INSERT INTO cCompraD SELECT * FROM #CompraDetalle
      IF @@ERROR <> 0 SELECT @Ok = 1
    END

    DROP TABLE #CompraDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1
  END ELSE

  IF @Modulo = 'INV'
  BEGIN

    --REQ12615 WMS
    SELECT @OMov = Mov FROM Inv WHERE ID = @OID
    SELECT @DMov = Mov FROM Inv WHERE ID = @DID
    IF @OMov = @DMov
      UPDATE InvD SET Tarima = NULL WHERE ID = @DID
    --REQ12615 WMS

    IF @GenerarDirecto = 1 SELECT @OrigenMov = NULL, @OrigenMovID = NULL
    SELECT * INTO #InvDetalle FROM cInvD   WHERE ID = @OID
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF @Base IN ('TODO', 'IDENTICO') UPDATE #InvDetalle SET ID = @DID, CantidadPendiente = NULL, CantidadCancelada = NULL, CantidadReservada = NULL, CantidadOrdenada = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = Renglon ELSE
    IF @Base = 'SELECCION' UPDATE #InvDetalle SET ID = @DID, Cantidad = CantidadA, CantidadInventario = CantidadA * CantidadInventario / Cantidad, CantidadPendiente = NULL, CantidadCancelada = NULL, CantidadReservada = NULL, CantidadOrdenada = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = Renglon ELSE
    IF @Base = 'PENDIENTE' UPDATE #InvDetalle SET ID = @DID, Cantidad = NULLIF(ISNULL(CantidadPendiente,0.0) + ISNULL(CantidadReservada, 0.0), 0.0), CantidadInventario = (NULLIF(ISNULL(CantidadPendiente,0.0) + ISNULL(CantidadReservada, 0.0), 0.0)) * CantidadInventario / Cantidad, CantidadPendiente = NULL, CantidadReservada = NULL, CantidadCancelada = NULL, CantidadOrdenada = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = Renglon ELSE
    IF @Base = 'RESERVADO' UPDATE #InvDetalle SET ID = @DID, Cantidad = CantidadReservada, CantidadInventario = CantidadReservada * CantidadInventario / Cantidad, CantidadPendiente = NULL, CantidadCancelada = NULL, CantidadReservada = NULL, CantidadOrdenada = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID, UltimoReservadoCantidad = NULL, UltimoReservadoFecha = NULL, AplicaRenglon = Renglon
    IF @@ERROR <> 0 SELECT @Ok = 1

    UPDATE #InvDetalle SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal 

    DELETE #InvDetalle WHERE Cantidad IS NULL OR Cantidad = 0.0
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF @OrigenMovTipo IN ('INV.SOL', 'INV.SM')
    BEGIN
    
      CREATE TABLE #InvAplica   (
	    ProdSerieLote		    varchar(50)	COLLATE Database_Default NULL,
	    Producto		        char(20)	COLLATE Database_Default NULL,
	    SubProducto		        varchar(50)	COLLATE Database_Default NULL,
        Almacen			        char(10)	COLLATE Database_Default NULL,
        Aplica			        char(20)	COLLATE Database_Default NULL, 
        AplicaID		        varchar(20)	COLLATE Database_Default NULL, 
        Articulo		        char(20)	COLLATE Database_Default NULL, 
        SubCuenta		        varchar(50)	COLLATE Database_Default NULL,
	    Unidad			        varchar(50)	COLLATE Database_Default NULL,
	    ContUso			        char(20)	COLLATE Database_Default NULL,
        Renglon			        float		NULL,
        RenglonSub		        int		    NULL,
        RenglonID               int         NULL,
        Cantidad		        float		NULL,
        CantidadInventario  	float		NULL,
	    Merma			        float		NULL,
        Desperdicio		        float		NULL,        
        FechaCaducidad	        datetime	NULL,
		AplicaRenglon	        float		NULL
                                )

		CREATE TABLE #SerieLoteMov(Empresa				varchar(5)  COLLATE Database_Default NULL,
								   Modulo				varchar(4)  COLLATE Database_Default NULL,
								   ID					int,
								   RenglonID			int,
								   Articulo				varchar(20) COLLATE Database_Default NULL,
								   SubCuenta			varchar(50) COLLATE Database_Default NULL,
								   SerieLote			varchar(50) COLLATE Database_Default NULL,
								   Cantidad				float,
								   CantidadAlterna		float,
								   Propiedades			varchar(20) COLLATE Database_Default NULL,
								   Ubicacion			int NULL,
								   Cliente				varchar(10) COLLATE Database_Default NULL,
								   Localizacion			varchar(10) COLLATE Database_Default NULL,
								   Sucursal				int NULL,
								   ArtCostoInv			money NULL,
								   Tarima				varchar(20) COLLATE Database_Default NULL,
								   AsignacionUbicacion	bit NULL)

      DELETE SerieLoteMov WHERE Modulo = @Modulo AND ID = @DID

       INSERT 
        INTO #InvAplica (ProdSerieLote, Producto, SubProducto, Almacen, Aplica, AplicaID, Articulo, SubCuenta, Unidad, ContUso, Renglon, RenglonSub, RenglonID, Cantidad, CantidadInventario, Merma, Desperdicio, FechaCaducidad, AplicaRenglon)
                  SELECT ProdSerieLote, Producto, SubProducto, Almacen, Aplica, AplicaID, Articulo, SubCuenta, Unidad, ContUso, Min(Renglon), Min(RenglonSub), Min(RenglonID), SUM(Cantidad), SUM(CantidadInventario), SUM(Merma), SUM(Desperdicio), CASE WHEN @MovTipo = 'INV.TMA' THEN FechaCaducidad END, AplicaRenglon
                    FROM #InvDetalle 
                   GROUP BY ProdSerieLote, Producto, SubProducto, Almacen, Aplica, AplicaID, Articulo, SubCuenta, Unidad, ContUso, CASE WHEN @MovTipo = 'INV.TMA' THEN FechaCaducidad END, AplicaRenglon --REQ12615 WMS
                   ORDER BY ProdSerieLote, Producto, SubProducto, Almacen, Aplica, AplicaID, Articulo, SubCuenta, Unidad, ContUso, CASE WHEN @MovTipo = 'INV.TMA' THEN FechaCaducidad END, AplicaRenglon --REQ12615 WMS

	  INSERT #SerieLoteMov(Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, CantidadAlterna,
						   Propiedades, Ubicacion, Cliente, Localizacion, Sucursal, ArtCostoInv, Tarima, AsignacionUbicacion)
					SELECT A.Empresa, A.Modulo, @DID, B.RenglonID, A.Articulo, A.SubCuenta, A.SerieLote, Sum(ISNULL(A.Cantidad,0)), SUM(ISNULL(A.CantidadAlterna,0)),
						   A.Propiedades, A.Ubicacion, A.Cliente, A.Localizacion, A.Sucursal, A.ArtCostoInv, A.Tarima, A.AsignacionUbicacion
					  FROM SerieLoteMov A
					  JOIN #InvAplica B 
						ON A.Articulo = B.Articulo 
					   AND ISNULL(A.SubCuenta,'') = ISNULL(B.SubCuenta,'')
					  JOIN InvD C
						ON A.ID = C.ID
					   AND A.Articulo = C.Articulo
					   AND ISNULL(A.SubCuenta,'') = ISNULL(C.SubCuenta,'')
					   AND A.RenglonID = C.RenglonID
					   AND ISNULL(B.FechaCaducidad,'') = ISNULL(C.FechaCaducidad,'')
					 WHERE A.Modulo = @Modulo
					   AND A.ID = @OID
				  GROUP BY A.Empresa, A.Modulo, A.ID, B.RenglonID, A.Articulo, A.SubCuenta, A.SerieLote, A.Propiedades,
						   A.Ubicacion, A.Cliente, A.Localizacion, A.Sucursal, A.ArtCostoInv, A.Tarima, A.AsignacionUbicacion,
						   ISNULL(C.FechaCaducidad,'')
	
		IF EXISTS(SELECT * FROM #SerieLoteMov)
			BEGIN
				DELETE FROM SerieLoteMov WHERE Modulo = @Modulo AND ID = @DID
				INSERT SerieLoteMov(Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, CantidadAlterna,
									Propiedades, Ubicacion, Cliente, Localizacion, Sucursal, ArtCostoInv, Tarima, AsignacionUbicacion)
							 SELECT Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, CantidadAlterna,
									Propiedades, Ubicacion, Cliente, Localizacion, Sucursal, ArtCostoInv, Tarima, AsignacionUbicacion
							   FROM #SerieLoteMov 

			END   

      IF @@ERROR <> 0 SELECT @Ok = 1

      INSERT INTO cInvD 
      SELECT d.* 
        FROM #InvDetalle d, #InvAplica a 
       WHERE ISNULL(d.ProdSerieLote, '') = ISNULL(a.ProdSerieLote, '')
         AND ISNULL(d.Producto, '') = ISNULL(a.Producto, '')
         AND ISNULL(d.SubProducto, '') = ISNULL(a.SubProducto, '')
         AND d.Almacen = a.Almacen
         AND d.Aplica = a.Aplica 
         AND d.AplicaID = a.AplicaID 
         AND d.Articulo = a.Articulo 
         AND ISNULL(d.SubCuenta,'') = ISNULL(a.SubCuenta, '')
         AND d.Renglon = a.Renglon
         AND d.RenglonSub = a.RenglonSub
         AND d.AplicaRenglon = a.AplicaRenglon
      IF @@ERROR <> 0 SELECT @Ok = 1

      UPDATE InvD 
         SET InvD.Cantidad = a.Cantidad,
             InvD.CantidadInventario = a.CantidadInventario,
             InvD.Merma = a.Merma,
             InvD.Desperdicio = a.Desperdicio
        FROM InvD d, #InvAplica a 
       WHERE d.ID = @DID 
         AND ISNULL(d.ProdSerieLote, '') = ISNULL(a.ProdSerieLote, '')
         AND ISNULL(d.Producto, '') = ISNULL(a.Producto, '')
         AND ISNULL(d.SubProducto, '') = ISNULL(a.SubProducto, '')
         AND d.Almacen = a.Almacen
         AND d.Aplica = a.Aplica 
         AND d.AplicaID = a.AplicaID 
         AND d.Articulo = a.Articulo 
         AND ISNULL(d.SubCuenta,'') = ISNULL(a.SubCuenta, '')
         AND d.Renglon = a.Renglon
         AND d.RenglonSub = a.RenglonSub
         AND d.AplicaRenglon = a.AplicaRenglon
      IF @@ERROR <> 0 SELECT @Ok = 1
    END ELSE
    BEGIN
      INSERT INTO cInvD SELECT * FROM #InvDetalle
      IF @@ERROR <> 0 SELECT @Ok = 1
    END
    DROP TABLE #InvDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1
  END 

/*  IF @Modulo = 'TMA'
  BEGIN
    IF @GenerarDirecto = 1 SELECT @OrigenMov = NULL, @OrigenMovID = NULL
    SELECT * INTO #TMADetalle FROM cTMAD WHERE ID = @OID
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF @Base = 'TODO'      UPDATE #InvDetalle SET ID = @DID, CantidadPendiente = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID  ELSE
    IF @Base = 'SELECCION' UPDATE #InvDetalle SET ID = @DID, Cantidad = CantidadA, CantidadPendiente = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID  ELSE
    IF @Base = 'PENDIENTE' UPDATE #InvDetalle SET ID = @DID, Cantidad = CantidadPendiente, CantidadPendiente = NULL, CantidadA = NULL, Aplica = @OrigenMov, AplicaID = @OrigenMovID 
    IF @@ERROR <> 0 SELECT @Ok = 1

    UPDATE #TMADetalle SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal 

    DELETE #TMADetalle WHERE Cantidad IS NULL OR Cantidad = 0.0
    IF @@ERROR <> 0 SELECT @Ok = 1
  END */

  --REQ12615 WMS
  IF @Modulo = 'TMA'
  BEGIN          
    SELECT @OMov = Mov FROM TMA WHERE ID = @OID
    SELECT @DMov = Mov FROM TMA WHERE ID = @DID
    IF @OMov = @DMov
      UPDATE TMAD SET Tarima = NULL WHERE ID = @DID
  END

  IF @Modulo = 'SAUX'
  BEGIN
    IF @GenerarDirecto = 1 SELECT @OrigenMov = NULL, @OrigenMovID = NULL
    SELECT * INTO #SAUXDetalle FROM cSAUXD WHERE ID = @OID
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF @Base = 'TODO'      UPDATE #SAUXDetalle SET ID = @DID, CantidadPendeiente = NULL, CantidadA = NULL ELSE
    IF @Base = 'SELECCION' UPDATE #SAUXDetalle SET ID = @DID, Cantidad = CantidadA, CantidadPendeiente = NULL, CantidadA = NULL ELSE
    IF @Base = 'PENDIENTE' UPDATE #SAUXDetalle SET ID = @DID, Cantidad = CantidadPendeiente, CantidadPendeiente = NULL, CantidadA = NULL
    IF @@ERROR <> 0 SELECT @Ok = 1

    DELETE #SAUXDetalle WHERE Cantidad IS NULL OR Cantidad = 0.0
    IF @@ERROR <> 0 SELECT @Ok = 1

    INSERT INTO cSAUXD SELECT * FROM #SAUXDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1

    DROP TABLE #SAUXDetalle
    IF @@ERROR <> 0 SELECT @Ok = 1

  END 

  EXEC spInvUtilizarTodoDetalleWMS @Modulo, @OID, @DID --REQ12615 WMS --BUG 14127

  EXEC xpInvUtilizarTodoDetalle @Sucursal, @Modulo, @Base, @OID, @OrigenMov, @OrigenMovID, @OrigenMovTipo, @DID, @GenerarDirecto, @Ok OUTPUT

  /*********************************************************     BUG 7029     *********************************************************************/ 
  IF @Modulo = 'INV'
	SELECT @SubClave = B.SubClave FROM Inv A JOIN MovTipo B ON B.Modulo = @Modulo AND A.Mov = B.Mov WHERE A.ID = @OID

  IF @Modulo = 'INV' AND @MovTipo = 'INV.T' --AND @SubClave = 'INV.TMA'
  BEGIN
  		--DELETE FROM SerieLoteMOV WHERE ID = @OID AND Modulo = @Modulo --Arrastre SerieLoteMov
		DECLARE crArticuloTarima CURSOR FOR 
			SELECT Articulo, isnull(Subcuenta,''), Tarima, Almacen, SUM(Cantidad), RenglonID  FROM InvD WHERE ID = @OID GROUP BY Articulo, SubCuenta, Tarima, Almacen, RenglonID 

		OPEN crArticuloTarima
	FETCH NEXT FROM crArticuloTarima INTO @Articulo, @Subcuenta, @Tarima, @Almacen, @CantidadP, @cRenglonID

	WHILE @@FETCH_STATUS = 0 AND @CantidadP > 0
		BEGIN

			DECLARE crTarimaSerie CURSOR FOR
				SELECT Tarima, Articulo, SerieLote, SubCuenta, Almacen, Sucursal, Empresa, Existencia
				  FROM SerieLote
				 WHERE Tarima = @Tarima
				   AND Articulo = @Articulo
				   AND SubCuenta = @Subcuenta
				   AND Almacen = @Almacen
				   AND Sucursal = @Sucursal
				   AND Empresa = @Empresa
				   AND Existencia > 0
				
			OPEN crTarimaSerie
			FETCH NEXT FROM crTarimaSerie INTO @cTarima, @cArticulo, @cSerieLote, @cSubCuenta, @cAlmacen, @cSucursal, @cEmpresa, @cExistencia
			WHILE @@FETCH_STATUS = 0 AND @CantidadP > 0
				BEGIN
					IF @cExistencia >= @CantidadP
						BEGIN
							INSERT @SerieLoteMov(Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal, Tarima, AsignacionUbicacion)
										 SELECT @Empresa, @Modulo, @DID, @cRenglonID, @cArticulo, @cSubCuenta, @cSerieLote, @CantidadP, @Sucursal, @cTarima, 0 
							
							SET @CantidadP = 0 
						END

					IF @cExistencia < @CantidadP
						BEGIN
							INSERT @SerieLoteMov(Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal, Tarima, AsignacionUbicacion)
										 SELECT @Empresa, @Modulo, @DID, @cRenglonID, @cArticulo, @cSubCuenta, @cSerieLote, @cExistencia, @Sucursal, @cTarima, 0 
							
							SET @CantidadP = @CantidadP - @cExistencia 
						END

					FETCH NEXT FROM crTarimaSerie INTO @cTarima, @cArticulo, @cSerieLote, @cSubCuenta,	@cAlmacen, @cSucursal, @cEmpresa, @cExistencia
				END
			
			CLOSE crTarimaSerie
			DEALLOCATE crTarimaSerie
			FETCH NEXT FROM crArticuloTarima INTO @Articulo, @Subcuenta, @Tarima, @Almacen, @CantidadP, @cRenglonID
		END

	CLOSE crArticuloTarima
	DEALLOCATE crArticuloTarima 		

	IF EXISTS(SELECT * FROM @SerieLoteMov)
		BEGIN
			DELETE FROM SERIELOTEMOV WHERE Modulo = @Modulo AND ID = @DID
			
			INSERT INTO SerieLoteMov(Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal, Tarima, AsignacionUbicacion)
			                  SELECT Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal, Tarima, AsignacionUbicacion
							    FROM @SerieLoteMov
		END

  END

  IF @MovTipo IN ('VTAS.F','INV.OT','INV.OI','COMS.OD')
  BEGIN
	IF @Modulo = 'VTAS'
		BEGIN 
			DECLARE crArticuloTarima CURSOR FOR		
				SELECT Articulo, isnull(Subcuenta,''), Tarima, Almacen, SUM(Cantidad), RenglonID FROM VentaD WHERE ID = @DID GROUP BY Articulo, SubCuenta , Tarima, Almacen, RenglonID 
		END
	IF @Modulo = 'INV'
		BEGIN
			DELETE FROM SerieLoteMOV WHERE ID = @DID AND Modulo = @Modulo
			DECLARE crArticuloTarima CURSOR FOR 
				SELECT Articulo, isnull(Subcuenta,''), Tarima, Almacen, SUM(Cantidad), RenglonID  FROM InvD WHERE ID = @DID GROUP BY Articulo, SubCuenta, Tarima, Almacen, RenglonID 
		END
	IF @Modulo = 'COMS'
		DECLARE crArticuloTarima CURSOR FOR 
			SELECT Articulo, isnull(Subcuenta,''), Tarima, Almacen, SUM(Cantidad), RenglonID  FROM CompraD WHERE ID = @DID GROUP BY Articulo, SubCuenta, Tarima, Almacen, RenglonID 

	OPEN crArticuloTarima
	FETCH NEXT FROM crArticuloTarima INTO @Articulo, @Subcuenta, @Tarima, @Almacen, @CantidadP, @cRenglonID

	WHILE @@FETCH_STATUS = 0 AND @CantidadP > 0
		BEGIN
			DECLARE crTarimaSerie CURSOR FOR
				SELECT Tarima, Articulo, SerieLote, SubCuenta, Almacen, Sucursal, Empresa, Existencia
				  FROM SerieLote
				 WHERE Tarima = @Tarima
				   AND Articulo = @Articulo
				   AND SubCuenta = @Subcuenta
				   AND Almacen = @Almacen
				   AND Sucursal = @Sucursal
				   AND Empresa = @Empresa
				   AND Existencia > 0
				
			OPEN crTarimaSerie
			FETCH NEXT FROM crTarimaSerie INTO @cTarima, @cArticulo, @cSerieLote, @cSubCuenta, @cAlmacen, @cSucursal, @cEmpresa, @cExistencia
			WHILE @@FETCH_STATUS = 0 AND @CantidadP > 0
				BEGIN
					IF @cExistencia >= @CantidadP
						BEGIN
							INSERT @SerieLoteMov(Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal, Tarima, AsignacionUbicacion)
										 SELECT @Empresa, @Modulo, @DID, @cRenglonID, @cArticulo, @cSubCuenta, @cSerieLote, @CantidadP, @Sucursal, @cTarima, 0 
							
							SET @CantidadP = 0 
						END

					IF @cExistencia < @CantidadP
						BEGIN
							INSERT @SerieLoteMov(Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal, Tarima, AsignacionUbicacion)
										 SELECT @Empresa, @Modulo, @DID, @cRenglonID, @cArticulo, @cSubCuenta, @cSerieLote, @cExistencia, @Sucursal, @cTarima, 0 
							
							SET @CantidadP = @CantidadP - @cExistencia 
						END

					FETCH NEXT FROM crTarimaSerie INTO @cTarima, @cArticulo, @cSerieLote, @cSubCuenta,	@cAlmacen, @cSucursal, @cEmpresa, @cExistencia
				END
			
			CLOSE crTarimaSerie
			DEALLOCATE crTarimaSerie
			FETCH NEXT FROM crArticuloTarima INTO @Articulo, @Subcuenta, @Tarima, @Almacen, @CantidadP, @cRenglonID
		END


	CLOSE crArticuloTarima
	DEALLOCATE crArticuloTarima 		


	IF EXISTS(SELECT * FROM @SerieLoteMov)
		BEGIN
			DELETE FROM SERIELOTEMOV WHERE Modulo = @Modulo AND ID = @DID
			
			INSERT INTO SerieLoteMov(Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal, Tarima, AsignacionUbicacion)
			                  SELECT Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, Sucursal, Tarima, AsignacionUbicacion
							    FROM @SerieLoteMov
		END
  END
  RETURN
END
GO

/********** spJornadaDiasLibres *********/
if exists (select * from sysobjects where id =object_id('dbo.spJornadaDiasLibres') and type = 'P') drop procedure dbo.spJornadaDiasLibres
GO  
CREATE PROCEDURE spJornadaDiasLibres
			@Jornada        char(20),
                        @FechaDel       dateTime,
                        @FechaAl        dateTime,
                        @DiasLibres	int = 0 OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE 
    @PrimerDia int,
    @Domingo   int,
    @Lunes     int,
    @Martes    int,
    @Miercoles int,
    @Jueves    int,
    @Viernes   int,
    @Sabado    int

  SELECT @Domingo = 0, @Lunes = 0, @Martes = 0, @Miercoles = 0, @Jueves = 0, @Viernes = 0, @Sabado = 0
  SELECT @DiasLibres = 0
  SELECT @Domingo   = Domingo, 
         @Lunes     = Lunes, 
         @Martes    = Martes, 
         @Miercoles = Miercoles, 
         @Jueves    = Jueves, 
         @Viernes   = Viernes, 
         @Sabado    = Sabado
    FROM Jornada 
   WHERE Jornada    = @Jornada

  SELECT @PrimerDia = @@DateFirst/* para guardar la configuracion actual */
  SET DATEFIRST 7 /* para que el domingo sea el primer dia */

  WHILE @FechaDel <= @FechaAl 
  BEGIN
    IF DATEPART(dw, @FechaDel) = 1 AND @Domingo   = 1   SELECT @DiasLibres = @DiasLibres + 1 
    IF DATEPART(dw, @FechaDel) = 2 AND @Lunes     = 1   SELECT @DiasLibres = @DiasLibres + 1 
    IF DATEPART(dw, @FechaDel) = 3 AND @Martes    = 1   SELECT @DiasLibres = @DiasLibres + 1 
    IF DATEPART(dw, @FechaDel) = 4 AND @Miercoles = 1   SELECT @DiasLibres = @DiasLibres + 1 
    IF DATEPART(dw, @FechaDel) = 5 AND @Jueves    = 1   SELECT @DiasLibres = @DiasLibres + 1
    IF DATEPART(dw, @FechaDel) = 6 AND @Viernes   = 1   SELECT @DiasLibres = @DiasLibres + 1 
    IF DATEPART(dw, @FechaDel) = 7 AND @Sabado    = 1   SELECT @DiasLibres = @DiasLibres + 1 
    SELECT @FechaDel = @FechaDel + 1
  END

-- para restaurar la configuracion original
  SET DATEFIRST @PrimerDia 
--  SELECT @DiasLibres
END
GO

/************** spJuegoComponentes *************/
if exists (select * from sysobjects where id = object_id('dbo.spJuegoComponentes') and sysstat & 0xf = 4) drop procedure dbo.spJuegoComponentes
GO
CREATE PROCEDURE spJuegoComponentes
                   @Articulo    char(20),
                   @ArtCantidad	float,
		   @Moneda	char(10)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @PrecioIndependiente	bit,
    @ListaPrecios		varchar(50),
    @Cantidad			float,
    @Juego			char(10),
    @Renglon			float,
    @Componente			char(20),
    @Precio			money

  CREATE TABLE #JuegoComponente(
    Componente		char(20)	COLLATE Database_Default NULL,
    Cantidad		float	     	NULL,
    Precio		money		NULL)

  DECLARE crArtJuego CURSOR FOR
   SELECT j.Juego, j.Cantidad*@ArtCantidad, j.PrecioIndependiente, j.ListaPreciosEsp, (SELECT MIN(Renglon) FROM ArtJuegoD WHERE Articulo = j.Articulo AND Juego = j.Juego)
     FROM ArtJuego j
    WHERE j.Articulo = @Articulo AND j.SinOpcionOmision = 0
    ORDER BY j.Juego

  OPEN crArtJuego
  FETCH NEXT FROM crArtJuego INTO @Juego, @Cantidad, @PrecioIndependiente, @ListaPrecios, @Renglon
  WHILE @@FETCH_STATUS <> -1 
  BEGIN
    IF @@FETCH_STATUS <> -2 
    BEGIN
      SELECT @Componente = NULL, @Precio = NULL
      SELECT @Componente = Opcion FROM ArtJuegoD WHERE Articulo = @Articulo AND Juego = @Juego AND Renglon = @Renglon
      IF @PrecioIndependiente = 1
      BEGIN
        SELECT @Precio = Precio 
          FROM ListaPreciosD
         WHERE Lista = @ListaPrecios AND Moneda = @Moneda AND Articulo = @Componente
        IF @Precio IS NULL
          SELECT @Precio = PrecioLista FROM Art WHERE Articulo = @Componente
      END
      INSERT #JuegoComponente (Componente, Cantidad, Precio) VALUES (@Componente, @Cantidad, @Precio)
    END
    FETCH NEXT FROM crArtJuego INTO @Juego, @Cantidad, @PrecioIndependiente, @ListaPrecios, @Renglon
  END  -- While
  CLOSE crArtJuego
  DEALLOCATE crArtJuego

  SELECT j.*, a.Descripcion1, a.Unidad, a.Tipo FROM #JuegoComponente j, Art a WHERE j.Componente = a.Articulo
  RETURN
END
GO

/************** spLigarMovCont *************/
if exists (select * from sysobjects where id = object_id('dbo.spLigarMovCont') and type = 'P') drop procedure dbo.spLigarMovCont
GO
CREATE PROCEDURE spLigarMovCont
		   @Accion		char(20),
		   @Empresa		char(5),
                   @OrigenTipo 		char(10),
                   @Mov			char(20),
                   @MovID		varchar(20),
		   @ContID		int,
		   @Poliza		char(20),
                   @PolizaID		varchar(20),
		   @ID			int	= NULL 	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Modulo  	    char(5),
    @GenerarPoliza  bit

  IF @Accion <> 'CANCELAR' SELECT @GenerarPoliza = 0 ELSE SELECT @GenerarPoliza = 1, @Poliza = NULL, @PolizaID = NULL, @ID = NULL
  SELECT @Poliza = NULLIF(RTRIM(@Poliza), ''), @Mov = NULLIF(RTRIM(@Mov), ''), @Modulo = @OrigenTipo

  IF @Modulo = 'VTAS'
  BEGIN
    UPDATE Venta        SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID 
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Venta WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'PROD'  
  BEGIN 
    UPDATE Prod         SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Prod WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'COMS'
  BEGIN  
    UPDATE Compra       SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID 
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Compra WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'INV'
  BEGIN
    UPDATE Inv          SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Inv WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'CXC'
  BEGIN
    UPDATE Cxc          SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Cxc WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'CXP'
  BEGIN
    UPDATE Cxp          SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID 
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Cxp WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'AGENT'
  BEGIN
    UPDATE Agent        SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Agent WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'GAS'
  BEGIN
    UPDATE Gasto        SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Gasto WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'DIN'
  BEGIN
    UPDATE Dinero       SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Dinero WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'EMB'
  BEGIN
    UPDATE Embarque     SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Embarque WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'NOM'
  BEGIN
   UPDATE Nomina       SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Nomina WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'RH'
  BEGIN
    UPDATE RH           SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM RH WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'ASIS'
  BEGIN
    UPDATE Asiste       SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Asiste WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'AF'
  BEGIN
    UPDATE ActivoFijo   SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM ActivoFijo WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'PC'
  BEGIN
    UPDATE PC           SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM PC WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'OFER'
  BEGIN
    UPDATE Oferta       SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Oferta WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'VALE'
  BEGIN
    UPDATE Vale         SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Vale WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'CR'
  BEGIN
    UPDATE CR           SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM CR WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'ST'
  BEGIN
    UPDATE Soporte      SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Soporte WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'CAP'
  BEGIN
    UPDATE Capital      SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Capital WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'INC'
  BEGIN
    UPDATE Incidencia   SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Incidencia WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'CONC'
  BEGIN
    UPDATE Conciliacion SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Conciliacion WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'PPTO'
  BEGIN
    UPDATE Presup       SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Presup WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'CREDI'
  BEGIN
    UPDATE Credito      SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Credito WHERE ContID = @ContID)
  END ELSE
  IF @Modulo = 'FIS'
  BEGIN
    UPDATE Fiscal       SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Fiscal WHERE ContID = @ContID)
  END ELSE
  --REQ25014
  IF @Modulo = 'CONTP'
  BEGIN
    UPDATE ContParalela SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM ContParalela WHERE ContID = @ContID)
  END ELSE
  --REQ16092
  IF @Modulo = 'OPORT'
  BEGIN
    UPDATE Oportunidad      SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Oportunidad WHERE ContID = @ContID)
  END ELSE  

/*  IF @Modulo = 'WMS'   UPDATE WMS        SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID ELSE*/
/*  IF @Modulo = 'RSS'   UPDATE RSS        SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID ELSE*/
/*  IF @Modulo = 'CMP'   UPDATE Campana    SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID ELSE*/
/*  IF @Modulo = 'FRM'   UPDATE FormaExtra SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID ELSE*/
/*  IF @Modulo = 'PROY'  UPDATE Proyecto   SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID ELSE*/
/*  IF @Modulo = 'ACT'  UPDATE Act         SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID ELSE*/
  IF @Modulo = 'CAM'
  BEGIN
    UPDATE Cambio       SET @ID = ID, GenerarPoliza = @GenerarPoliza, Poliza = @Poliza, PolizaID = @PolizaID WHERE ContID = @ContID 
    UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID IN (SELECT ID FROM Cambio WHERE ContID = @ContID)
  END

  --UPDATE Mov SET ContID = @ContID, Poliza = @Poliza, PolizaID = @PolizaID WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID = @ID 
  RETURN 
END
GO

/*********** spModificarCapas ***********/
if exists (select * from sysobjects where id = object_id('dbo.spModificarCapas') and type = 'P') drop procedure dbo.spModificarCapas
GO
CREATE PROCEDURE spModificarCapas
		   @Sucursal			int,
                   @Accion			char(20),
		   @Modulo			char(5),
		   @MovTipo			char(20),
		   @Mov		     		char(20),
		   @MovID	     		varchar(20),
		   @Fecha			datetime,
                   @CfgTipoCosteo    		char(20),
		   @Sistema			char(1),
    		   @Empresa          		char(5),
    		   @Articulo	     		char(20),
		   @SubCuenta			varchar(50),
    		   @Cantidad	     		float,
		   @EsTransferenciaCosto 	bit,

    		   @Costo	     		float 	    OUTPUT,
    		   @Ok               		int         OUTPUT,
		   @CostoEspecifico 		bit 	= 0,
		   @AjusteCosteo		float 	= NULL OUTPUT,

   		   @Almacen		varchar(10)	= NULL,
		   @ID			int		= NULL,
		   @Renglon		float		= NULL,
		   @RenglonSub		int		= NULL	   
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @Suma           float,
    @Requiere	    float,
    @Obtenido       float,
    @Existencia     float,
    @CapaModulo     char(5),
    @CapaMov	    char(20),
    @CapaMovID	    varchar(20),
    @CapaFecha	    datetime,
    @CapaCosto      float,
    @NuevoCosto	    float,
    @Promedio       float,
    @CostoAnterior  float,
    @EsCargo	    bit,
    @InvCapaID	    int,
    @InvCapaIDN	    int

  IF @CostoEspecifico = 1 SELECT @CostoAnterior = @Costo
  IF @MovTipo IN ('COMS.B', 'COMS.CA', 'COMS.GX')
  BEGIN
    IF @CfgTipoCosteo='PEPS' 
      DECLARE crCapas CURSOR FOR SELECT ID, ISNULL(Existencia, 0.0), ISNULL(Costo, 0.0), Fecha, Modulo, Mov, MovID FROM InvCapa WHERE Sucursal = @Sucursal AND Sistema = @Sistema AND Empresa  = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND ISNULL(Existencia, 0.0) > 0.0 AND Activa = 1 ORDER BY Fecha ASC, ID ASC
    ELSE 
      DECLARE crCapas CURSOR FOR SELECT ID, ISNULL(Existencia, 0.0), ISNULL(Costo, 0.0), Fecha, Modulo, Mov, MovID FROM InvCapa WHERE Sucursal = @Sucursal AND Sistema = @Sistema AND Empresa  = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND ISNULL(Existencia, 0.0) > 0.0 AND Activa = 1 ORDER BY Fecha DESC, ID DESC
  END ELSE
  /*IF @CostoEspecifico = 1  ** en lugar de buscar un costo especifico hay que ajustarlo
  BEGIN
    IF @CfgTipoCosteo='PEPS' OR @EsTransferenciaCosto = 1 
      DECLARE crCapas CURSOR FOR SELECT ISNULL(Existencia, 0.0), ISNULL(Costo, 0.0), Fecha, Modulo, Mov, MovID FROM InvCapa WHERE Sucursal = @Sucursal AND Sistema = @Sistema AND Empresa  = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Costo = @Costo AND ISNULL(Existencia, 0.0) > 0.0 AND Activa = 1 ORDER BY Fecha ASC, ID ASC
    ELSE 
      DECLARE crCapas CURSOR FOR SELECT ISNULL(Existencia, 0.0), ISNULL(Costo, 0.0), Fecha, Modulo, Mov, MovID FROM InvCapa WHERE Sucursal = @Sucursal AND Sistema = @Sistema AND Empresa  = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Costo = @Costo AND ISNULL(Existencia, 0.0) > 0.0 AND Activa = 1 ORDER BY Fecha DESC, ID DESC
  END ELSE

JGD 15Febrero2011 Ticket 2976. Se comenta esta parte.
  BEGIN
    IF @CfgTipoCosteo='PEPS' OR @EsTransferenciaCosto = 1 
      DECLARE crCapas CURSOR FOR SELECT ID, ISNULL(Existencia, 0.0), ISNULL(Costo, 0.0), Fecha, Modulo, Mov, MovID FROM InvCapa WHERE Sucursal = @Sucursal AND Sistema = @Sistema AND Empresa  = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND ISNULL(Existencia, 0.0) > 0.0 AND Activa = 1 ORDER BY Fecha ASC, ID ASC
    ELSE 
      DECLARE crCapas CURSOR FOR SELECT ID, ISNULL(Existencia, 0.0), ISNULL(Costo, 0.0), Fecha, Modulo, Mov, MovID FROM InvCapa WHERE Sucursal = @Sucursal AND Sistema = @Sistema AND Empresa  = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND ISNULL(Existencia, 0.0) > 0.0 AND Activa = 1 ORDER BY Fecha DESC, ID DESC
  END

JGD 15Febrero2011 Ticket 2976. Se valida la Cancelación de una Entrada Diverza ingresada de forma Erronea, la unica condición es que este Movimiento 
                               no tenga modificada la Existencia en InvCapa, es decir, no tenga Movientos de Salida, y de esta manera se Cancela 
                               con respecto al Costo del Movimiento en el cual se esta parado, ignorando el tipo de Costeo PEPS
*/
  BEGIN
    IF @CfgTipoCosteo='PEPS' OR @EsTransferenciaCosto = 1 
    BEGIN
      IF @CfgTipoCosteo='PEPS' AND @Accion = 'CANCELAR'-- AND @Modulo = 'INV' AND @MovTipo = 'INV.E'
      BEGIN
        IF (SELECT  MAX(ISNULL(Existencia, 0.0)) FROM InvCapa WHERE Sucursal = @Sucursal AND Sistema = @Sistema AND Empresa  = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND ISNULL(Existencia, 0.0) > 0.0 AND Activa = 1 AND Mov = @Mov AND MovID = @MovID) = @Cantidad
          DECLARE crCapas CURSOR FOR SELECT ID, ISNULL(Existencia, 0.0), ISNULL(Costo, 0.0), Fecha, Modulo, Mov, MovID FROM InvCapa WHERE Sucursal = @Sucursal AND Sistema = @Sistema AND Empresa  = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND ISNULL(Existencia, 0.0) > 0.0 AND Activa = 1 AND Mov = @Mov AND MovID = @MovID
        ELSE
          DECLARE crCapas CURSOR FOR SELECT ID, ISNULL(Existencia, 0.0), ISNULL(Costo, 0.0), Fecha, Modulo, Mov, MovID FROM InvCapa WHERE Sucursal = @Sucursal AND Sistema = @Sistema AND Empresa  = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND ISNULL(Existencia, 0.0) > 0.0 AND Activa = 1 ORDER BY Fecha ASC, ID ASC
      END
      ELSE
        DECLARE crCapas CURSOR FOR SELECT ID, ISNULL(Existencia, 0.0), ISNULL(Costo, 0.0), Fecha, Modulo, Mov, MovID FROM InvCapa WHERE Sucursal = @Sucursal AND Sistema = @Sistema AND Empresa  = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND ISNULL(Existencia, 0.0) > 0.0 AND Activa = 1 ORDER BY Fecha ASC, ID ASC
    END
    ELSE 
      DECLARE crCapas CURSOR FOR SELECT ID, ISNULL(Existencia, 0.0), ISNULL(Costo, 0.0), Fecha, Modulo, Mov, MovID FROM InvCapa WHERE Sucursal = @Sucursal AND Sistema = @Sistema AND Empresa  = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND ISNULL(Existencia, 0.0) > 0.0 AND Activa = 1 ORDER BY Fecha DESC, ID DESC
    END
--Fin JGD 15Febrero2011 Ticket 2976

  SELECT @Suma = 0.0, @Promedio = 0.0
  OPEN crCapas
  FETCH NEXT FROM crCapas INTO @InvCapaID, @Existencia, @CapaCosto, @CapaFecha, @CapaModulo, @CapaMov, @CapaMovID
  IF @@ERROR <> 0 SELECT @Ok = 1
  WHILE @Suma < @Cantidad AND @@FETCH_STATUS <> -1 AND @Ok IS NULL
  BEGIN
    IF @@FETCH_STATUS <> -2
    BEGIN
      SELECT @Requiere = @Cantidad - @Suma

      IF @Requiere < @Existencia 
      BEGIN  -- Alcanza
        SELECT @Obtenido = @Requiere
        UPDATE InvCapa SET Existencia = Existencia - @Obtenido WHERE CURRENT OF crCapas
      END ELSE 
      BEGIN
        SELECT @Obtenido = @Existencia
        UPDATE InvCapa SET Activa = 0, Existencia = NULL WHERE CURRENT OF crCapas
      END
      IF @@ERROR <> 0 SELECT @Ok = 1
      INSERT InvCapaAux (
     	      ID,         Fecha,  Modulo,  ModuloID, Renglon,  RenglonSub,  Almacen,  AbonoU)
      VALUES (@InvCapaID, @Fecha, @Modulo, @ID,      @Renglon, @RenglonSub, @Almacen, @Obtenido)

      IF @MovTipo IN ('COMS.B', 'COMS.CA', 'COMS.GX')
      BEGIN
        IF @MovTipo = 'COMS.B' SELECT @EsCargo = 0 ELSE SELECT @EsCargo = 1
        IF @Accion = 'CANCELAR' IF @EsCargo = 0 SELECT @EsCargo = 1 ELSE SELECT @EsCargo = 0
        IF @EsCargo = 1 SELECT @NuevoCosto = @CapaCosto + @Costo ELSE SELECT @NuevoCosto = @CapaCosto - @Costo
        INSERT INTO InvCapa (Sucursal,  Sistema,  Empresa,  Articulo,  SubCuenta,  Fecha,      Existencia, Costo,       Modulo,      Mov,      MovID)
                    VALUES  (@Sucursal, @Sistema, @Empresa, @Articulo, @SubCuenta, @CapaFecha, @Obtenido,  @NuevoCosto, @CapaModulo, @CapaMov, @CapaMovID)
        SELECT @InvCapaIDN = SCOPE_IDENTITY()                    
        INSERT InvCapaAux (
                ID,          Fecha,  Modulo,  ModuloID, Renglon,  RenglonSub,  Almacen,  CargoU)
        VALUES (@InvCapaIDN, @Fecha, @Modulo, @ID,      @Renglon, @RenglonSub, @Almacen, @Obtenido)
      END 
      ELSE
      IF @EsTransferenciaCosto = 1
      BEGIN
        INSERT INTO InvCapa (Sucursal,  Sistema,  Empresa,  Articulo,  SubCuenta,  Fecha,  Existencia, Costo,             Modulo,  Mov,  MovID)
                    VALUES  (@Sucursal, @Sistema, @Empresa, @Articulo, @SubCuenta, @Fecha, @Obtenido,  @CapaCosto+@Costo, @Modulo, @Mov, @MovID)
        SELECT @InvCapaIDN = SCOPE_IDENTITY()                    
        INSERT InvCapaAux (
                ID,          Fecha,  Modulo,  ModuloID, Renglon,  RenglonSub,  Almacen,  CargoU)
        VALUES (@InvCapaIDN, @Fecha, @Modulo, @ID,      @Renglon, @RenglonSub, @Almacen, @Obtenido)
      END ELSE
        SELECT @Promedio = ((@Promedio * @Suma) + (@Obtenido * @CapaCosto)) / (@Suma + @Obtenido)
      IF @@ERROR <> 0 SELECT @Ok = 1

      SELECT @Suma = @Suma + @Obtenido
    END -- fetch_status
    FETCH NEXT FROM crCapas INTO @InvCapaID, @Existencia, @CapaCosto, @CapaFecha, @CapaModulo, @CapaMov, @CapaMovID
    IF @@ERROR <> 0 SELECT @Ok = 1
  END -- While
  Close crCapas
  DEALLOCATE crCapas
  
  IF @EsTransferenciaCosto = 0 SELECT @Costo = @Promedio
  IF ROUND(@Suma, 4) < ROUND(@Cantidad, 4) SELECT @Ok = 20110

  IF @CostoEspecifico = 1 SELECT @AjusteCosteo = @Costo - @CostoAnterior  
  RETURN
END
GO

/*********** spMoneda ***********/
if exists (select * from sysobjects where id = object_id('dbo.spMoneda') and type = 'P') drop procedure dbo.spMoneda
GO
CREATE PROCEDURE spMoneda
		   @Accion	     char(20),
    		   @MovMoneda	     char(10),
    		   @MovTipoCambio    float,
                   @CuentaMoneda     char(10),
    		   @CuentaFactor     float    OUTPUT,
    		   @CuentaTipoCambio float    OUTPUT,
                   @Ok		     int      OUTPUT,
		   @Modulo	     char(5)	= NULL,
		   @ModuloID	     int	= NULL
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @TipoCambioBase	float,
    @ToleranciaBase	float,
    @Minimo		float,
    @Maximo		float


  SELECT @CuentaFactor = 1.0, @CuentaTipoCambio = ISNULL(@CuentaTipoCambio, 0.0)

  IF ISNULL(@MovTipoCambio, 0) = 0 SELECT @Ok = 30140 ELSE
  IF @MovMoneda     IS NULL SELECT @Ok = 30040 ELSE
  IF @CuentaMoneda  IS NULL SELECT @Ok = 30050 
  ELSE
  BEGIN
    IF UPPER(@MovMoneda) <> UPPER(@CuentaMoneda)
    BEGIN
      IF @Accion = 'CANCELAR' AND @CuentaTipoCambio <> 0.0
        SELECT @CuentaTipoCambio = @CuentaTipoCambio
      ELSE BEGIN
        SELECT @CuentaTipoCambio = 1.0
	  IF EXISTS(SELECT * FROM DINERO WHERE ID = @ModuloID )
         SELECT @CuentaTipoCambio = ISNULL(TipoCambioDestino, 1.0) FROM DINERO WHERE ID = @ModuloID
		ELSE
		 SELECT @CuentaTipoCambio = ISNULL(TipoCambio, 1.0)
           FROM Mon
          WHERE Moneda = @CuentaMoneda
      END

      SELECT @CuentaFactor = @CuentaTipoCambio / @MovTipoCambio
      IF @@ERROR <> 0 SELECT @Ok = 1
    END ELSE 
      SELECT @CuentaTipoCambio = @MovTipoCambio

    IF @Accion <> 'CANCELAR'
    BEGIN
      SELECT @TipoCambioBase = TipoCambio, 
             @ToleranciaBase = Tolerancia
        FROM Mon
       WHERE Moneda = @MovMoneda

      SELECT @Minimo = @TipoCambioBase * (1 - (@ToleranciaBase/100.0)), 
             @Maximo = @TipoCambioBase * (1 + (@ToleranciaBase/100.0))
      IF @MovTipoCambio < @Minimo SELECT @Ok = 35080 ELSE
      IF @MovTipoCambio > @Maximo SELECT @Ok = 35090 
    END
  END

  RETURN
END
GO

/**************** spMonedaRecalc ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMonedaRecalc') and type = 'P') drop procedure dbo.spMonedaRecalc
GO
CREATE PROCEDURE spMonedaRecalc
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @TipoCambio		float,
    @TipoCambioDolar	float

  BEGIN TRANSACTION
    SELECT @TipoCambio = ISNULL(TipoCambio, 0.0) FROM Mon WHERE TipoCambioDolar = 1.0		-- Leer TC de los Dolares
    UPDATE Mon SET TipoCambioDolar = @TipoCambio FROM Mon WHERE TipoCambio = 1.0 			-- Actualizar TCD en los Pesos

    DECLARE CMPon CURSOR FOR
      SELECT ISNULL(TipoCambioDolar, 0.0) FROM Mon WHERE ISNULL(TipoCambio, 0.0) <> 1.0 AND ISNULL(TipoCambioDolar, 0.0) <> 1.0 AND ISNULL(TipoCambioDolar, 0.0) > 0.0

    OPEN CMPon
    FETCH NEXT FROM CMPon INTO @TipoCambioDolar
    WHILE @@FETCH_STATUS <> -1 
    BEGIN
      IF @@FETCH_STATUS <> -2 
        UPDATE Mon SET TipoCambio = ROUND(@TipoCambio / @TipoCambioDolar, 6) WHERE CURRENT OF CMPon

      FETCH NEXT FROM CMPon INTO @TipoCambioDolar
    END  -- While	
    CLOSE CMPon
    DEALLOCATE CMPon
  COMMIT TRANSACTION
  RETURN
END
GO

/************************ spWebServiceSolicitud *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spWebServiceSolicitud') AND type = 'P') DROP PROCEDURE dbo.spWebServiceSolicitud
GO             
CREATE PROCEDURE spWebServiceSolicitud
                @URI            varchar(8000) = '', 
                @NombreMetodo   varchar(50) = '',      
                @Solictud       varchar(8000) = '',  
                @AccionSOAP     varchar(255),    
                @Usuario        nvarchar(100), -- Domain\UserName or UserName      
                @Password       nvarchar(100), 
                @Respuesta      varchar(max) = NULL OUTPUT,
                @Ok             varbinary(4) = NULL OUTPUT,
                @OkRef          varchar(255) = NULL OUTPUT
--//WITH ENCRYPTION          
AS BEGIN
  DECLARE
  
   @IDObjeto            int,
   @hResult             int,
   @Origen              varchar(8000), 
   @Descripcion         varchar(8000),
   @ResultadoXml        varchar(max) ,
   @len                 int ,
   @EstatusTexto        varchar(8000), 
   @Estatus             varchar(8000),
   @SQL					varchar(8000)

  CREATE table #Tabla (Campo xml)
  DECLARE @Tabla TABLE (Campo varchar(max))

  SET NOCOUNT ON 
  IF    @NombreMetodo = '' 
  BEGIN      
    SELECT FailPoint = 'Es Necesario Asignar Un Metodo'      
    RETURN 
  END
  SET  @Respuesta = 'FAILED'

  EXEC @hResult = sp_OACreate 'MSXML2.ServerXMLHTTP', @IDObjeto OUT IF @hResult <> 0 
  BEGIN      
    EXEC sp_OAGetErrorInfo @IDObjeto, @Origen OUT, @Descripcion OUT      
    SELECT @Ok = convert(varbinary(4), @hResult), @Okref = ISNULL(@Origen,'') +'  '+ ISNULL(@Descripcion,'')+'   '+'Create failed'      
  END
  
  IF @Ok IS NULL
  BEGIN
    -- open the destination URI with Specified method
    EXEC @hResult = sp_OAMethod @IDObjeto, 'open', null, @NombreMetodo, @URI, 'false', @Usuario, @Password 
    IF @hResult <> 0 
    BEGIN      
      EXEC sp_OAGetErrorInfo @IDObjeto, @Origen OUT, @Descripcion OUT      
      SELECT @Ok = convert(varbinary(4), @hResult), @Okref = ISNULL(@Origen,'') +'  '+ ISNULL(@Descripcion,'')+'   '+'Open failed'       
    END
  END
   
  IF ISNULL(@Solictud,'') <> ''
  BEGIN
    IF @Ok IS NULL
    BEGIN  
     -- set request headers 
      EXEC @hResult = sp_OAMethod @IDObjeto, 'setRequestHeader', null, 'Content-Type', 'text/xml;charset=UTF-8'
      IF @hResult <> 0 
      BEGIN      
        EXEC sp_OAGetErrorInfo @IDObjeto, @Origen OUT, @Descripcion OUT      
        SELECT @Ok = convert(varbinary(4), @hResult), @Okref = ISNULL(@Origen,'') +'  '+ ISNULL(@Descripcion,'')+'   '+'SetRequestHeader failed'  
      END
    END
    
    IF @Ok IS NULL
    BEGIN
     -- set soap action 
      EXEC @hResult = sp_OAMethod @IDObjeto, 'setRequestHeader', null, 'SOAPAction', @AccionSOAP
      IF @hResult <> 0
      BEGIN
        EXEC sp_OAGetErrorInfo @IDObjeto, @Origen OUT, @Descripcion OUT
        SELECT hResult = convert(varbinary(4), @hResult), source = @Origen, description = @Descripcion, FailPoint = 'SetRequestHeader failed', MedthodName = @NombreMetodo
      END   
    END

    IF @Ok IS NULL
    BEGIN    
      SET @len = len(@Solictud) 
      EXEC @hResult = sp_OAMethod @IDObjeto, 'setRequestHeader', null, 'Content-Length', @len 
      IF @hResult <> 0 
      BEGIN      
        EXEC sp_OAGetErrorInfo @IDObjeto, @Origen OUT, @Descripcion OUT      
        SELECT hResult = convert(varbinary(4), @hResult), source = @Origen, description = @Descripcion, FailPoint = 'SetRequestHeader failed', MedthodName = @NombreMetodo       
      END
    END
  END
  
  IF @Ok IS NULL
  BEGIN  
    -- send the request
    EXEC @hResult = sp_OAMethod @IDObjeto, 'send', null, @Solictud 
    IF    @hResult <> 0 
    BEGIN      
      EXEC sp_OAGetErrorInfo @IDObjeto, @Origen OUT, @Descripcion OUT
      SELECT @Ok = convert(varbinary(4), @hResult), @Okref = ISNULL(@Origen,'') +'  '+ ISNULL(@Descripcion,'')+'   '+'Send failed'             
    END     
    -- Get status text
    EXEC sp_OAGetProperty @IDObjeto, 'StatusText', @EstatusTexto out
     
    EXEC sp_OAGetProperty @IDObjeto, 'Status', @Estatus out
  END

  IF @Ok IS NULL
  BEGIN  
   -- Get response text 
    IF ISNULL(@Solictud,'') <> ''
      INSERT #Tabla( Campo )
      EXEC @hResult = sp_OAGetProperty @IDObjeto, 'responseXML.xml'
    ELSE
    BEGIN     
      INSERT @Tabla( Campo )
      EXEC @hResult = sp_OAGetProperty @IDObjeto, 'responseText'    
    END

    IF @hResult <> 0 
    BEGIN     
      EXEC sp_OAGetErrorInfo @IDObjeto, @Origen OUT, @Descripcion OUT      
      SELECT @Ok = convert(varbinary(4), @hResult), @Okref = ISNULL(@Origen,'') +'  '+ ISNULL(@Descripcion,'')+'   '+'responseXML failed'  
    END
  END
    
  IF ISNULL(@Solictud,'') <> ''
    SELECT TOP 1 @Respuesta = convert(varchar(max),Campo) FROM #Tabla
  ELSE
    SELECT TOP 1 @Respuesta = convert(varchar(max),Campo) FROM @Tabla
   
  EXEC @hResult = sp_OADestroy @IDObjeto
  IF @hResult <> 0
  BEGIN
    EXEC sp_OAGetErrorInfo @IDObjeto
    RETURN
  END   
  SET NOCOUNT OFF 
END
GO

/*
declare @xmlOut varchar(max), @url varchar(max)
select @url = 'http' + CHAR(58) + '//www.xe.com/currency/mxn-mexican-peso'
exec spWebServiceSolicitud @url, 'post', '','','', '', @xmlOut out
select @xmlOut
*/

/************************ spMonConsultarTipoCambio *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spMonConsultarTipoCambio') AND type = 'P') DROP PROCEDURE dbo.spMonConsultarTipoCambio
GO             
CREATE PROCEDURE spMonConsultarTipoCambio
                @Estacion	int
                
--//WITH ENCRYPTION          
AS BEGIN
  DECLARE
    @Respuesta			varchar(max),
    @LongitudInicial	int,
    @LongitudFinal		int,
    @LEN				int,
    @Longitud			int,
    @TipoCambio			float,
    @Ok					int,
    @OkRef				varchar(255),
    
    @URL				varchar(max),
    @ExpInicial			varchar(max),
    @ExpFinal			varchar(max),
    @Codigo				varchar(5)
    
  DELETE MonActualizarTemp WHERE Estacion = @Estacion
  DECLARE crMonConsultarTipoCambio CURSOR LOCAL FOR 
   SELECT m.CodigoInt, a.Url, a.ExpInicial, a.ExpFinal
     FROM Mon m
     JOIN MonCodigoInternacional c
       ON m.CodigoInt = c.Codigo
     JOIN MonActualizacionAuto a
       ON c.ActualizacionAuto = a.ActualizacionAuto

  OPEN crMonConsultarTipoCambio
  FETCH NEXT FROM crMonConsultarTipoCambio INTO @Codigo, @URL, @ExpInicial, @ExpFinal
  WHILE @@FETCH_STATUS <> -1 
  BEGIN
    IF @@FETCH_STATUS <> -2
    BEGIN      
      
      EXEC spWebServiceSolicitud @URL, 'post', '','','', '', @Respuesta out
      
	  SELECT @ExpInicial = SUBSTRING(@ExpInicial,48,18)
      SELECT @LEN = LEN(@ExpInicial)
      SELECT @LongitudInicial = CHARINDEX(@ExpInicial,@Respuesta,0)+ @LEN
      SELECT @LongitudFinal = CHARINDEX(@ExpFinal,@Respuesta, @LongitudInicial)
      SELECT @Longitud = @LongitudFinal - @LongitudInicial
      
      SELECT @TipoCambio = CASE WHEN dbo.fnEsNumerico(SUBSTRING(@Respuesta,@LongitudInicial,@Longitud))=0 THEN NULL ELSE SUBSTRING(@Respuesta,@LongitudInicial,@Longitud) END
      
      IF @TipoCambio IS NULL
        SELECT @Ok = 35110, @OkRef = ISNULL(@Codigo,'') + ' ' + (SELECT Descripcion FROM MensajeLista WHERE Mensaje = 35110)
        
      IF @Ok IS NULL
        INSERT MonActualizarTemp(Estacion, Moneda, Codigo,  TipoCambio,  Estatus,    Icono)
        SELECT                  @Estacion, Moneda, @Codigo, @TipoCambio, 'Correcto', 339
          FROM Mon WHERE CodigoInt = @Codigo
      ELSE
        INSERT MonActualizarTemp(Estacion, Moneda, Codigo,  TipoCambio, Estatus, Icono)
        SELECT                  @Estacion, Moneda, @Codigo, NULL,       'Error', 416
          FROM Mon WHERE CodigoInt = @Codigo
      
      SELECT @Ok = NULL
    END
    FETCH NEXT FROM crMonConsultarTipoCambio INTO @Codigo, @URL, @ExpInicial, @ExpFinal
  END
  CLOSE crMonConsultarTipoCambio
  DEALLOCATE crMonConsultarTipoCambio
--  SELECT * FROM MonActualizarTemp WHERE Estacion = @Estacion
END
GO
--EXEC spMonConsultarTipoCambio 1

/************************ spMonActualizarTipoCambio *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spMonActualizarTipoCambio') AND type = 'P') DROP PROCEDURE dbo.spMonActualizarTipoCambio
GO             
CREATE PROCEDURE spMonActualizarTipoCambio
                @Estacion	int

--//WITH ENCRYPTION          
AS BEGIN
  DECLARE
    @Moneda			varchar(20),
    @TipoCambio		float
    
  DECLARE crMonActualizar CURSOR LOCAL FOR 
   SELECT Moneda, TipoCambio
     FROM MonActualizarTemp
    WHERE Estacion = @Estacion
      AND TipoCambio IS NOT NULL

  OPEN crMonActualizar
  FETCH NEXT FROM crMonActualizar INTO @Moneda, @TipoCambio
  WHILE @@FETCH_STATUS <> -1 
  BEGIN
    IF @@FETCH_STATUS <> -2
    BEGIN      
      UPDATE Mon SET TipoCambio = @TipoCambio WHERE Moneda = @Moneda
    
    END
    FETCH NEXT FROM crMonActualizar INTO @Moneda, @TipoCambio
  END
  CLOSE crMonActualizar
  DEALLOCATE crMonActualizar
  
END
GO
--exec spMonActualizarTipoCambio 1





/************************ spBorrarMonHistTemp *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spBorrarMonHistTemp') AND type = 'P') DROP PROCEDURE dbo.spBorrarMonHistTemp
GO             
CREATE PROCEDURE spBorrarMonHistTemp
  @Estacion             int
            
--//WITH ENCRYPTION             
AS BEGIN

  DELETE MonHistTemp WHERE Estacion = @Estacion


END
GO






/************************ spInsertarMonHist *****************************/
IF EXISTS(SELECT * FROM SysObjects WHERE id = object_id('dbo.spInsertarMonHist') AND type = 'P') DROP PROCEDURE dbo.spInsertarMonHist
GO             
CREATE PROCEDURE spInsertarMonHist
  @Estacion             int,
  @Moneda	        varchar(10),	   
  @Sucursal	        int
            
--//WITH ENCRYPTION             
AS BEGIN

   INSERT MonHist(Moneda, Fecha, TipoCambio, Sucursal, FechaSinHora)
   SELECT         Moneda, Fecha, TipoCambio, Sucursal, dbo.fnFechaSinHora(Fecha)
     FROM MonHistTemp
    WHERE Estacion = @Estacion
   EXCEPT
   SELECT Moneda, Fecha, TipoCambio, Sucursal, FechaSinHora
     FROM MonHist
    WHERE Moneda = @Moneda AND Sucursal = @Sucursal   
    
   DELETE  MonHistTemp WHERE Estacion = @Estacion
    
   SELECT 'SE ACTUALIZARON LOS REGISTROS EXISTOSAMENTE'

END
GO 

/************** spMovAlActualizar *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovAlActualizar') and type = 'P') drop procedure dbo.spMovAlActualizar
GO
CREATE PROCEDURE spMovAlActualizar
                   @Modulo		char(5),
		   @ID			int,
		   @Mov			varchar(20),
		   @EstatusNuevo	varchar(15),
		   @EstatusAnterior	varchar(15), 
		   @SituacionNueva	varchar(50), 
		   @SituacionAnterior	varchar(50)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @SMS		varchar(20),
    @CtoTipo 		varchar(20), 
    @Contacto 		char(10),
    @ContactoSMS	bit,
    @Telefono		varchar(50),
    @Mensaje		varchar(255),
    @MovID		varchar(20),
    @Importe		money,
    @Moneda		varchar(10),
    @EstatusNombre	varchar(100),
    @Referencia		varchar(50),
    @Usuario		varchar(10),
    @DefUsuario		varchar(10),
    @Sucursal		int

  SELECT @DefUsuario = NULL
  SELECT @DefUsuario = NULLIF(RTRIM(DefUsuario), '')
    FROM MovTipo
   WHERE Modulo = @Modulo AND Mov = @Mov
  IF @DefUsuario IS NOT NULL
    EXEC spMovPutInfo @ID, @Modulo, @Usuario = @DefUsuario

  EXEC spMovReg @Modulo, @ID, @UnicamenteActualizar = 1

  IF @EstatusNuevo IN ('PENDIENTE', 'CONCLUIDO', 'CONCILIADO', 'CANCELADO') AND (@EstatusNuevo<>@EstatusAnterior OR @SituacionNueva<>@SituacionAnterior)
    EXEC spMailAuto @Modulo, @ID, @Mov

  IF ISNULL(@SituacionNueva, '') <> ISNULL(@SituacionAnterior, '')
  BEGIN
    SELECT @SMS = NULL
    SELECT @SMS = NULLIF(UPPER(NULLIF(RTRIM(SMS), '')), 'No') FROM MovSituacion WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @EstatusNuevo AND Situacion = @SituacionNueva
    IF @SMS IN ('INFORMAR', 'AVANZAR')
    BEGIN
      SELECT @Sucursal = Sucursal, @CtoTipo = UPPER(CtoTipo), @Contacto = Contacto, @MovID = MovID, @Importe = Importe, @Moneda = Moneda, @Usuario = Usuario
        FROM dbo.fnMovReg(@Modulo, @ID)

      IF @CtoTipo = 'CLIENTE' 
      BEGIN
        SELECT @ContactoSMS = 0, @Referencia = NULL
        SELECT @Telefono = NULLIF(RTRIM(PersonalTelefonoMovil), ''), @ContactoSMS = ISNULL(PersonalSMS, 0)
          FROM Cte
         WHERE Cliente = @Contacto
        SELECT @EstatusNombre = Nombre FROM Estatus WHERE Estatus = @EstatusNuevo
        SELECT @Mensaje = RTRIM(@Mov)+' '+@MovID+' ('+CONVERT(varchar, @Importe, 1)+' '+RTRIM(@Moneda)+') - '+@EstatusNombre+' '+@SituacionNueva
        IF @SMS = 'AVANZAR' SELECT @Mensaje = @Mensaje + ', para avanzar responda con el folio', @Referencia = @MovID
        SELECT @Mensaje = @Mensaje + '.'

        IF @ContactoSMS = 1 AND @Telefono IS NOT NULL 
        BEGIN
          INSERT SMS (Telefono, Tipo, EnvioMensaje, Modulo, ModuloID, Referencia) VALUES (@Telefono, 'Lote', @Mensaje, @Modulo, @ID, @Referencia)
          IF @SMS = 'INFORMAR'
            INSERT MovBitacora (Modulo, ID, Fecha, Evento, Sucursal, Usuario, Tipo) VALUES (@Modulo, @ID, GETDATE(), @Telefono, @Sucursal, @Usuario, 'Informe SMS')
        END
      END
    END
  END

  RETURN 
END
GO

/**************** spMovAlEliminar ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovAlEliminar') and type = 'P') drop procedure dbo.spMovAlEliminar
GO             
CREATE PROCEDURE spMovAlEliminar
                    @Modulo	char(5),
		    @ID		int

--//WITH ENCRYPTION
AS BEGIN
  -- si se movio no borrar nada
  IF @Modulo = 'VTAS' 
    IF EXISTS(SELECT * FROM Nota WHERE ID = @ID) RETURN

  DELETE MovTiempo     WHERE Modulo = @Modulo AND ID = @ID 
  DELETE MovUsuario    WHERE Modulo = @Modulo AND ID = @ID
  DELETE MovBitacora   WHERE Modulo = @Modulo AND ID = @ID
  DELETE AnexoMov      WHERE Rama   = @Modulo AND ID = @ID 
  DELETE AgenteAgenda  WHERE Modulo = @Modulo AND ID = @ID
  DELETE MovFormaAnexo WHERE Modulo = @Modulo AND ID = @ID

  IF @Modulo = 'VTAS'
  BEGIN
    DELETE ServicioAccesorios WHERE ID = @ID 
    DELETE ServicioTarea      WHERE ID = @ID 
    DELETE VentaCobro         WHERE ID = @ID 
    DELETE VentaDLogPicos     WHERE ID = @ID 
    DELETE VentaOrigen        WHERE ID = @ID 
    DELETE VentaOtros         WHERE ID = @ID 
    DELETE VentaEntrega       WHERE ID = @ID 
  END ELSE
  IF @Modulo = 'CR'
  BEGIN
    DELETE CRVenta  WHERE ID = @ID 
    DELETE CRAgente WHERE ID = @ID 
    DELETE CRCobro  WHERE ID = @ID 
    DELETE CRCaja   WHERE ID = @ID 
  END


  IF @Modulo IN ('VTAS', 'INV', 'COMS', 'PROD')
  BEGIN
    DELETE AnexoMovD     WHERE Rama   = @Modulo AND ID = @ID 
    DELETE SerieLoteMov  WHERE Modulo = @Modulo AND ID = @ID 
    DELETE GuiaEmbarque  WHERE Modulo = @Modulo AND ID = @ID 
    DELETE GuiaEmbarqueD WHERE Modulo = @Modulo AND ID = @ID 

    UPDATE PlanArtOP 
       SET LiberacionModulo = NULL, LiberacionID = NULL, LiberacionMov = NULL, LiberacionMovID = NULL, Estado = 'Plan'
     WHERE LiberacionModulo = @Modulo AND LiberacionID = @ID /*AND LiberacionMov = @Mov AND LiberacionMovID = @MovID*/
  END

  IF @Modulo = 'NOM'
    DELETE NominaD WHERE ID = @ID

  RETURN
END
GO

/**************** spMovCancelarSinAfectar ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovCancelarSinAfectar') and type = 'P') drop procedure dbo.spMovCancelarSinAfectar
GO             
CREATE PROCEDURE spMovCancelarSinAfectar
			@Modulo	char(5), 
			@ID	int,
			@Ok	int	OUTPUT,
			@EstatusNuevo	varchar(15) = 'CANCELADO'
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  /*INICIO Cambio CFD Flexible */
  DECLARE
    @eDoc   bit,
    @CFDFlex  bit,
    @CFDFlexMovTipo bit,
    @CFDMovTipo  bit,
    @CFD   bit,
    @Empresa  varchar(5),
    @eDocOk   int,
    @eDocOkRef  varchar(255)
   
  IF @Modulo = 'VTAS' SELECT @CFDFlexMovTipo = mt.CFDFlex, @CFDMovTipo = mt.CFD, @Empresa = v.Empresa FROM Venta v JOIN MovTipo mt ON mt.Mov = v.Mov AND mt.Modulo = @Modulo WHERE v.ID = @ID 
  IF @Modulo = 'CXC'  SELECT @CFDFlexMovTipo = mt.CFDFlex, @CFDMovTipo = mt.CFD, @Empresa = v.Empresa FROM Cxc v JOIN MovTipo mt ON mt.Mov = v.Mov AND mt.Modulo = @Modulo WHERE v.ID = @ID   
  
  IF @Modulo IN ('VTAS','CXC')
  BEGIN
    SELECT 
      @CFD = CFD
      FROM Empresa
     WHERE Empresa = @Empresa
     
    SELECT 
      @CFDFlex = CFDFlex,
      @eDoc = eDoc
      FROM EmpresaGral
     WHERE Empresa = @Empresa    
    IF ( ((@CFDFlexMovTipo = 1) AND (@CFDFlex = 1) AND (@eDoc = 1)) OR ((@CFDMovTipo = 1) AND (@CFD = 1)) ) AND (@Ok IS NULL OR @Ok BETWEEN 80030 AND 81000) --MEJORA2104
    BEGIN
      SELECT @eDocOk = NULL, @eDocOkRef = NULL  
      EXEC spCFDFlexCancelar @@SPID, @Empresa, @Modulo, @ID, @EstatusNuevo, @eDocOk OUTPUT, @eDocOkRef OUTPUT  
      IF @eDocOk IS NOT NULL SELECT @Ok = @eDocOk
    END     
  END  
  /*FIN Cambio CFD Flexible */

  IF @Ok IS NOT NULL RETURN

  BEGIN TRANSACTION
    IF @Modulo = 'CONT'  UPDATE Cont         SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'VTAS'  UPDATE Venta        SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'PROD'  UPDATE Prod         SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'COMS'  UPDATE Compra       SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'INV'   UPDATE Inv          SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'CXC'   UPDATE Cxc          SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'CXP'   UPDATE Cxp          SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'AGENT' UPDATE Agent        SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'GAS'   UPDATE Gasto        SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'DIN'   UPDATE Dinero       SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'EMB'   UPDATE Embarque     SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'NOM'   UPDATE Nomina       SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'RH'    UPDATE RH           SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'ASIS'  UPDATE Asiste       SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'AF'    UPDATE ActivoFijo   SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'PC'    UPDATE PC           SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'OFER'  UPDATE Oferta       SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'VALE'  UPDATE Vale         SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'CR'    UPDATE CR           SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'ST'    UPDATE Soporte      SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'CAP'   UPDATE Capital      SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'INC'   UPDATE Incidencia   SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'CONC'  UPDATE Conciliacion SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'PPTO'  UPDATE Presup       SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'CREDI' UPDATE Credito      SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'TMA'   UPDATE TMA          SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'RSS'   UPDATE RSS          SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'CMP'   UPDATE Campana      SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'FIS'   UPDATE Fiscal       SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    --REQ25014
    IF @Modulo = 'CONTP' UPDATE ContParalela SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE    
    --REQ16092
	IF @Modulo = 'OPORT' UPDATE Oportunidad  SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE	
    IF @Modulo = 'CORTE' UPDATE Corte        SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'FRM'   UPDATE FormaExtra   SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'CAPT'  UPDATE Captura      SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'GES'   UPDATE Gestion      SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'CP'    UPDATE CP           SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'PCP'   UPDATE PCP          SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE    
    IF @Modulo = 'PROY'  UPDATE Proyecto     SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    --IF @Modulo = 'ACT'   UPDATE Act           SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX01' UPDATE ModuloExtra01 SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX02' UPDATE ModuloExtra02 SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX03' UPDATE ModuloExtra03 SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX04' UPDATE ModuloExtra04 SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX05' UPDATE ModuloExtra05 SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX06' UPDATE ModuloExtra06 SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX07' UPDATE ModuloExtra07 SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX08' UPDATE ModuloExtra08 SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX09' UPDATE ModuloExtra09 SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'ORG'   UPDATE Organiza     SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'RE'    UPDATE Recluta	     SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'ISL'   UPDATE ISL          SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'CAM'   UPDATE Cambio       SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'PACTO' UPDATE Contrato     SET Estatus = @EstatusNuevo WHERE ID = @ID ELSE
    IF @Modulo = 'SAUX'  UPDATE SAUX         SET Estatus = @EstatusNuevo WHERE ID = @ID 

    IF @@ERROR <> 0 SELECT @Ok = 1

    -- En el caso de Ventas si se cancela eliminar VentaOrigen
    IF @Modulo = 'VTAS' UPDATE VentaOrigen SET OrigenID = 0 WHERE ID = @ID
    IF @@ERROR <> 0 SELECT @Ok = 1

  IF @Ok IS NULL
    COMMIT TRANSACTION
  ELSE 
    ROLLBACK TRANSACTION

  RETURN
END
GO

/**************** spMovChecarConsecutivo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovChecarConsecutivo') and type = 'P') drop procedure dbo.spMovChecarConsecutivo
GO             
CREATE PROCEDURE spMovChecarConsecutivo
		    	@Empresa	char(5), 
			@Modulo		char(5), 
			@Mov		char(20),
			@MovID		varchar(20),
			@Serie		varchar(50),
			@Ejercicio	int,
			@Periodo	int,
			@Ok		int		OUTPUT,
		        @OkRef		varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @YaExiste int,
    @ConsecutivoPorPeriodo	bit,
    @ConsecutivoPorEjercicio	bit

  SELECT @ConsecutivoPorPeriodo	  = ConsecutivoPorPeriodo,
	 @ConsecutivoPorEjercicio = ConsecutivoPorEjercicio
    FROM MovTipo
   WHERE Modulo = @Modulo 
     AND Mov    = @Mov

  SELECT @YaExiste = NULL
  IF @ConsecutivoPorPeriodo = 1
  BEGIN
    IF @Serie IS NULL
    BEGIN
      IF @Modulo = 'VTAS'  SELECT @YaExiste = COUNT(*) FROM Venta        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'PROD'  SELECT @YaExiste = COUNT(*) FROM Prod         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'COMS'  SELECT @YaExiste = COUNT(*) FROM Compra       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'CXC'   SELECT @YaExiste = COUNT(*) FROM Cxc          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'CXP'   SELECT @YaExiste = COUNT(*) FROM Cxp          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'AGENT' SELECT @YaExiste = COUNT(*) FROM Agent        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'INV'   SELECT @YaExiste = COUNT(*) FROM Inv          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'GAS'   SELECT @YaExiste = COUNT(*) FROM Gasto        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'DIN'   SELECT @YaExiste = COUNT(*) FROM Dinero       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'CONT'  SELECT @YaExiste = COUNT(*) FROM Cont         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'EMB'   SELECT @YaExiste = COUNT(*) FROM Embarque     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'NOM'   SELECT @YaExiste = COUNT(*) FROM Nomina       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'RH'    SELECT @YaExiste = COUNT(*) FROM RH           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'ASIS'  SELECT @YaExiste = COUNT(*) FROM Asiste       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'AF'    SELECT @YaExiste = COUNT(*) FROM ActivoFijo 	 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'PC'    SELECT @YaExiste = COUNT(*) FROM PC         	 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'OFER'  SELECT @YaExiste = COUNT(*) FROM Oferta     	 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'VALE'  SELECT @YaExiste = COUNT(*) FROM Vale       	 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'CR'    SELECT @YaExiste = COUNT(*) FROM CR         	 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'ST'    SELECT @YaExiste = COUNT(*) FROM Soporte    	 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'CAP'   SELECT @YaExiste = COUNT(*) FROM Capital    	 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'INC'   SELECT @YaExiste = COUNT(*) FROM Incidencia	 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'CONC'  SELECT @YaExiste = COUNT(*) FROM Conciliacion WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'PPTO'  SELECT @YaExiste = COUNT(*) FROM Presup       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'CREDI' SELECT @YaExiste = COUNT(*) FROM Credito      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'TMA'   SELECT @YaExiste = COUNT(*) FROM TMA        	 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'RSS'   SELECT @YaExiste = COUNT(*) FROM RSS        	 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'CMP'   SELECT @YaExiste = COUNT(*) FROM Campana      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'FIS'   SELECT @YaExiste = COUNT(*) FROM Fiscal       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      --REQ25014
      IF @Modulo = 'CONTP' SELECT @YaExiste = COUNT(*) FROM ContParalela WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE      
      --REQ16092
	  IF @Modulo = 'OPORT' SELECT @YaExiste = COUNT(*) FROM Oportunidad  WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE	  
      IF @Modulo = 'CORTE' SELECT @YaExiste = COUNT(*) FROM Corte        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'FRM'   SELECT @YaExiste = COUNT(*) FROM FormaExtra   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'CAPT'  SELECT @YaExiste = COUNT(*) FROM Captura      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'GES'   SELECT @YaExiste = COUNT(*) FROM Gestion      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'CP'    SELECT @YaExiste = COUNT(*) FROM CP           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'PCP'   SELECT @YaExiste = COUNT(*) FROM PCP          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE      
      IF @Modulo = 'PROY'  SELECT @YaExiste = COUNT(*) FROM Proyecto   	 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      --IF @Modulo = 'ACT'   SELECT @YaExiste = COUNT(*) FROM Act           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      --IF @Modulo = 'MEX01' SELECT @YaExiste = COUNT(*) FROM ModuloExtra01 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      --IF @Modulo = 'MEX02' SELECT @YaExiste = COUNT(*) FROM ModuloExtra02 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      --IF @Modulo = 'MEX03' SELECT @YaExiste = COUNT(*) FROM ModuloExtra03 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      --IF @Modulo = 'MEX04' SELECT @YaExiste = COUNT(*) FROM ModuloExtra04 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      --IF @Modulo = 'MEX05' SELECT @YaExiste = COUNT(*) FROM ModuloExtra05 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      --IF @Modulo = 'MEX06' SELECT @YaExiste = COUNT(*) FROM ModuloExtra06 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      --IF @Modulo = 'MEX07' SELECT @YaExiste = COUNT(*) FROM ModuloExtra07 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      --IF @Modulo = 'MEX08' SELECT @YaExiste = COUNT(*) FROM ModuloExtra08 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      --IF @Modulo = 'MEX09' SELECT @YaExiste = COUNT(*) FROM ModuloExtra09 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'ORG'   SELECT @YaExiste = COUNT(*) FROM Organiza     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'RE'    SELECT @YaExiste = COUNT(*) FROM Recluta      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'ISL'   SELECT @YaExiste = COUNT(*) FROM ISL          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'CAM'   SELECT @YaExiste = COUNT(*) FROM Cambio       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'PACTO' SELECT @YaExiste = COUNT(*) FROM Contrato     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo ELSE
      IF @Modulo = 'SAUX'  SELECT @YaExiste = COUNT(*) FROM SAUX         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo 
    END ELSE 
    BEGIN
      IF @Modulo = 'DIN' SELECT @YaExiste = COUNT(*) FROM Dinero  WHERE Empresa = @Empresa AND Mov = @Mov AND CtaDinero = @Serie AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio AND Periodo = @Periodo 
      ELSE SELECT @Ok = 60150
    END
  END ELSE
  IF @ConsecutivoPorEjercicio = 1
  BEGIN
    IF @Serie IS NULL
    BEGIN
      IF @Modulo = 'VTAS'  SELECT @YaExiste = COUNT(*) FROM Venta        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'PROD'  SELECT @YaExiste = COUNT(*) FROM Prod         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'COMS'  SELECT @YaExiste = COUNT(*) FROM Compra       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'CXC'   SELECT @YaExiste = COUNT(*) FROM Cxc          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'CXP'   SELECT @YaExiste = COUNT(*) FROM Cxp          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'AGENT' SELECT @YaExiste = COUNT(*) FROM Agent        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'GAS'   SELECT @YaExiste = COUNT(*) FROM Gasto        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'INV'   SELECT @YaExiste = COUNT(*) FROM Inv          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'DIN'   SELECT @YaExiste = COUNT(*) FROM Dinero       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'CONT'  SELECT @YaExiste = COUNT(*) FROM Cont         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'EMB'   SELECT @YaExiste = COUNT(*) FROM Embarque     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'NOM'   SELECT @YaExiste = COUNT(*) FROM Nomina       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'RH'    SELECT @YaExiste = COUNT(*) FROM RH           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'ASIS'  SELECT @YaExiste = COUNT(*) FROM Asiste       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'AF'    SELECT @YaExiste = COUNT(*) FROM ActivoFijo   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'PC'    SELECT @YaExiste = COUNT(*) FROM PC           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'OFER'  SELECT @YaExiste = COUNT(*) FROM Oferta       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'VALE'  SELECT @YaExiste = COUNT(*) FROM Vale         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'CR'    SELECT @YaExiste = COUNT(*) FROM CR           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'ST'    SELECT @YaExiste = COUNT(*) FROM Soporte      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'CAP'   SELECT @YaExiste = COUNT(*) FROM Capital      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'INC'   SELECT @YaExiste = COUNT(*) FROM Incidencia   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'CONC'  SELECT @YaExiste = COUNT(*) FROM Conciliacion WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'PPTO'  SELECT @YaExiste = COUNT(*) FROM Presup       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'CREDI' SELECT @YaExiste = COUNT(*) FROM Credito      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'TMA'   SELECT @YaExiste = COUNT(*) FROM TMA          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'RSS'   SELECT @YaExiste = COUNT(*) FROM RSS          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'CMP'   SELECT @YaExiste = COUNT(*) FROM Campana      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'FIS'   SELECT @YaExiste = COUNT(*) FROM Fiscal       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      --REQ25014
      IF @Modulo = 'CONTP' SELECT @YaExiste = COUNT(*) FROM ContParalela WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE      
      --REQ16092
	  IF @Modulo = 'OPORT' SELECT @YaExiste = COUNT(*) FROM Oportunidad  WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'CORTE' SELECT @YaExiste = COUNT(*) FROM Corte        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'FRM'   SELECT @YaExiste = COUNT(*) FROM FormaExtra   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'CAPT'  SELECT @YaExiste = COUNT(*) FROM Captura      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'GES'   SELECT @YaExiste = COUNT(*) FROM Gestion      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'CP'    SELECT @YaExiste = COUNT(*) FROM CP           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'PCP'   SELECT @YaExiste = COUNT(*) FROM PCP          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE      
      IF @Modulo = 'PROY'  SELECT @YaExiste = COUNT(*) FROM Proyecto     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      --IF @Modulo = 'ACT'   SELECT @YaExiste = COUNT(*) FROM Act           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      --IF @Modulo = 'MEX01' SELECT @YaExiste = COUNT(*) FROM ModuloExtra01 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      --IF @Modulo = 'MEX02' SELECT @YaExiste = COUNT(*) FROM ModuloExtra02 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      --IF @Modulo = 'MEX03' SELECT @YaExiste = COUNT(*) FROM ModuloExtra03 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      --IF @Modulo = 'MEX04' SELECT @YaExiste = COUNT(*) FROM ModuloExtra04 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      --IF @Modulo = 'MEX05' SELECT @YaExiste = COUNT(*) FROM ModuloExtra05 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      --IF @Modulo = 'MEX06' SELECT @YaExiste = COUNT(*) FROM ModuloExtra06 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      --IF @Modulo = 'MEX07' SELECT @YaExiste = COUNT(*) FROM ModuloExtra07 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      --IF @Modulo = 'MEX08' SELECT @YaExiste = COUNT(*) FROM ModuloExtra08 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      --IF @Modulo = 'MEX09' SELECT @YaExiste = COUNT(*) FROM ModuloExtra09 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'ORG'   SELECT @YaExiste = COUNT(*) FROM Organiza     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'RE'    SELECT @YaExiste = COUNT(*) FROM Recluta      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'ISL'   SELECT @YaExiste = COUNT(*) FROM ISL          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'CAM'   SELECT @YaExiste = COUNT(*) FROM Cambio       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE 
      IF @Modulo = 'PACTO' SELECT @YaExiste = COUNT(*) FROM Contrato     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio ELSE
      IF @Modulo = 'SAUX'  SELECT @YaExiste = COUNT(*) FROM SAUX         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio
    END ELSE 
    BEGIN
      IF @Modulo = 'DIN' SELECT @YaExiste = COUNT(*) FROM Dinero WHERE Empresa = @Empresa AND Mov = @Mov AND CtaDinero = @Serie AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) AND Ejercicio = @Ejercicio 
      ELSE SELECT @Ok = 60150
    END
  END ELSE
  BEGIN
    IF @Serie IS NULL
    BEGIN
      IF @Modulo = 'VTAS'  SELECT @YaExiste = COUNT(*) FROM Venta        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'PROD'  SELECT @YaExiste = COUNT(*) FROM Prod         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'COMS'  SELECT @YaExiste = COUNT(*) FROM Compra       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'CXC'   SELECT @YaExiste = COUNT(*) FROM Cxc          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'CXP'   SELECT @YaExiste = COUNT(*) FROM Cxp          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'AGENT' SELECT @YaExiste = COUNT(*) FROM Agent        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'GAS'   SELECT @YaExiste = COUNT(*) FROM Gasto        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'INV'   SELECT @YaExiste = COUNT(*) FROM Inv          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'DIN'   SELECT @YaExiste = COUNT(*) FROM Dinero       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'CONT'  SELECT @YaExiste = COUNT(*) FROM Cont         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'EMB'   SELECT @YaExiste = COUNT(*) FROM Embarque     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'NOM'   SELECT @YaExiste = COUNT(*) FROM Nomina       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'RH'    SELECT @YaExiste = COUNT(*) FROM RH           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'ASIS'  SELECT @YaExiste = COUNT(*) FROM Asiste       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'AF'    SELECT @YaExiste = COUNT(*) FROM ActivoFijo   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'PC'    SELECT @YaExiste = COUNT(*) FROM PC           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'OFER'  SELECT @YaExiste = COUNT(*) FROM Oferta       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'VALE'  SELECT @YaExiste = COUNT(*) FROM Vale         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'CR'    SELECT @YaExiste = COUNT(*) FROM CR           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'ST'    SELECT @YaExiste = COUNT(*) FROM Soporte      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'CAP'   SELECT @YaExiste = COUNT(*) FROM Capital      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'INC'   SELECT @YaExiste = COUNT(*) FROM Incidencia   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'CONC'  SELECT @YaExiste = COUNT(*) FROM Conciliacion WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'PPTO'  SELECT @YaExiste = COUNT(*) FROM Presup       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'CREDI' SELECT @YaExiste = COUNT(*) FROM Credito	 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'TMA'   SELECT @YaExiste = COUNT(*) FROM TMA          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'RSS'   SELECT @YaExiste = COUNT(*) FROM RSS          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'CMP'   SELECT @YaExiste = COUNT(*) FROM Campana      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'FIS'   SELECT @YaExiste = COUNT(*) FROM Fiscal       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      --REQ25014
      IF @Modulo = 'CONTP' SELECT @YaExiste = COUNT(*) FROM ContParalela WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      --REQ16092
	  IF @Modulo = 'OPORT' SELECT @YaExiste = COUNT(*) FROM Oportunidad  WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE	  
      IF @Modulo = 'CORTE' SELECT @YaExiste = COUNT(*) FROM Corte        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'FRM'   SELECT @YaExiste = COUNT(*) FROM FormaExtra   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'CAPT'  SELECT @YaExiste = COUNT(*) FROM Captura      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'GES'   SELECT @YaExiste = COUNT(*) FROM Gestion      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'CP'    SELECT @YaExiste = COUNT(*) FROM CP           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'PCP'   SELECT @YaExiste = COUNT(*) FROM PCP          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE      
      IF @Modulo = 'PROY'  SELECT @YaExiste = COUNT(*) FROM Proyecto     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      --IF @Modulo = 'ACT'   SELECT @YaExiste = COUNT(*) FROM Act           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      --IF @Modulo = 'MEX01' SELECT @YaExiste = COUNT(*) FROM ModuloExtra01 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      --IF @Modulo = 'MEX02' SELECT @YaExiste = COUNT(*) FROM ModuloExtra02 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      --IF @Modulo = 'MEX03' SELECT @YaExiste = COUNT(*) FROM ModuloExtra03 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      --IF @Modulo = 'MEX04' SELECT @YaExiste = COUNT(*) FROM ModuloExtra04 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      --IF @Modulo = 'MEX05' SELECT @YaExiste = COUNT(*) FROM ModuloExtra05 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      --IF @Modulo = 'MEX06' SELECT @YaExiste = COUNT(*) FROM ModuloExtra06 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      --IF @Modulo = 'MEX07' SELECT @YaExiste = COUNT(*) FROM ModuloExtra07 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      --IF @Modulo = 'MEX08' SELECT @YaExiste = COUNT(*) FROM ModuloExtra08 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      --IF @Modulo = 'MEX09' SELECT @YaExiste = COUNT(*) FROM ModuloExtra09 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'ORG'   SELECT @YaExiste = COUNT(*) FROM Organiza     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'RE'    SELECT @YaExiste = COUNT(*) FROM Recluta	     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'ISL'   SELECT @YaExiste = COUNT(*) FROM ISL          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'CAM'   SELECT @YaExiste = COUNT(*) FROM Cambio       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'PACTO' SELECT @YaExiste = COUNT(*) FROM Contrato     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) ELSE
      IF @Modulo = 'SAUX'  SELECT @YaExiste = COUNT(*) FROM SAUX         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) 
    END ELSE 
    BEGIN
      IF @Modulo = 'DIN' SELECT @YaExiste = COUNT(*) FROM Dinero WHERE Empresa = @Empresa AND Mov = @Mov AND CtaDinero = @Serie AND MovID = @MovID AND Estatus NOT IN (SELECT Estatus FROM CfgEstatusConsecutivoDuplicado) 
      ELSE SELECT @Ok = 60150
    END
  END
  IF @@ERROR <> 0 SELECT @Ok = 1
  IF ISNULL(@YaExiste, 0) > 0 SELECT @Ok = 30010, @OkRef = RTRIM(@Mov)+' '+RTRIM(@MovID)+' ('+RTRIM(@Modulo)+')'

  RETURN
END
GO

/**************** spMovConsecutivo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovConsecutivo') and type = 'P') drop procedure dbo.spMovConsecutivo
GO             
CREATE PROCEDURE spMovConsecutivo
			@Sucursal		int,
			@SucursalOrigen		int,
			@SucursalDestino	int,
		    	@Empresa		char(5), 
			@Usuario		char(10),
			@Modulo			char(5), 
			@Ejercicio		int, 
			@Periodo		int,
			@ID			int,
			@Mov			char(20), 
			@Serie			varchar(50),
			@Estatus		char(15),
			@Concepto		varchar(50),

	      	        @Accion			char(20),
			@Conexion		bit,
			@SincroFinal		bit,

			@MovID 			varchar(20)	OUTPUT, 

			@Ok			int		OUTPUT,
		        @OkRef			varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Prefijo				char(10),
    @PuedeEditar			bit,
    @SucursalConsecutivo		int,
    @SucursalPrincipal			int,
    @EnLinea				bit,
    @MovTipo				varchar(20),
    @SubFoliosOrigen			bit,
    @CfgSubFoliosOrigen			bit,
    @CfgSubFoliosOrigenSeparador	varchar(10),
    @ConsecutivoUnico			bit,
    @OrigenTipo				varchar(10),
    @Origen				varchar(20),
    @OrigenID				varchar(20),
    @CFD				bit,
    @RamaID				int,
    @prefijosucursal	bit

  SELECT @EnLinea = 0, @SucursalPrincipal = NULL, @CFD = 0, @MovTipo = NULL, @SubFoliosOrigen = 0, @ConsecutivoUnico = 0
  SELECT @ConsecutivoUnico = ISNULL(ConsecutivoUnico, 0)
    FROM Modulo
   WHERE Modulo = @Modulo
  SELECT @MovTipo = Clave, @SubFoliosOrigen = ISNULL(SubFoliosOrigen, 0)
    FROM MovTipo 
   WHERE Modulo = @Modulo AND Mov = @Mov
  SELECT @CfgSubFoliosOrigen = ISNULL(SubFoliosOrigen, 0),
         @CfgSubFoliosOrigenSeparador = ISNULL(NULLIF(RTRIM(SubFoliosOrigenSeparador), ''), '.')
    FROM EmpresaGral
   WHERE Empresa = @Empresa

  IF @CfgSubFoliosOrigen = 0 SELECT @SubFoliosOrigen = 0
  IF @ConsecutivoUnico = 1
  BEGIN
    EXEC spMovInfo @ID, @Modulo, @OrigenTipo = @OrigenTipo OUTPUT, @Origen = @Origen OUTPUT, @OrigenID = @OrigenID OUTPUT, @RamaID = @RamaID OUTPUT
    SELECT @Mov = @Modulo
    IF @RamaID IS NOT NULL
    BEGIN
      EXEC spMovInfo @RamaID, @Modulo,  @MovID = @Serie OUTPUT
      SELECT @Serie = @Serie + @CfgSubFoliosOrigenSeparador, @SubFoliosOrigen = 1
    END      
  END ELSE
/*  IF @ConsecutivoUnico = 1
  BEGIN
    EXEC spMovInfo @ID, @Modulo, @OrigenTipo = @OrigenTipo OUTPUT, @Origen = @Origen OUTPUT, @OrigenID = @OrigenID OUTPUT
    SELECT @Mov = @Modulo
    SELECT @p = dbo.fnUltimoCHARINDEX(@CfgSubFoliosOrigenSeparador, @OrigenID)
    IF @p > 0 
      SELECT @Serie = SUBSTRING(@OrigenID, 1, @p), @SubFoliosOrigen = 1
    IF @OrigenTipo = @Modulo AND @Origen IS NOT NULL AND @OrigenID IS NOT NULL 
    BEGIN
      IF @p = 0 --OR EXISTS(SELECT * FROM MovTipo WHERE Modulo = @OrigenTipo AND Mov = @Origen AND SubFoliosOrigen = 1)
        SELECT @Serie = @OrigenID + @CfgSubFoliosOrigenSeparador, @SubFoliosOrigen = 1
    END
  END ELSE*/
  IF @SubFoliosOrigen = 1 
  BEGIN
    EXEC spMovInfo @ID, @Modulo, @OrigenTipo = @OrigenTipo OUTPUT, @Origen = @Origen OUTPUT, @OrigenID = @OrigenID OUTPUT
    IF @OrigenTipo = @Modulo AND @Origen IS NOT NULL AND @OrigenID IS NOT NULL 
    BEGIN
      SELECT @Serie = @OrigenID + @CfgSubFoliosOrigenSeparador
    END ELSE SELECT @SubFoliosOrigen = 0
  END

  IF (@Conexion = 0 OR @Accion = 'CANCELAR') AND @SincroFinal = 0 AND @Accion <> 'SINCRO' /*AND @Verificar = 1*/
  BEGIN
    EXEC spPuedeEditarMovMatrizSucursal @Sucursal, @SucursalOrigen, @ID, @Modulo, @Empresa, @Usuario, @Mov, @Estatus, 1, @PuedeEditar OUTPUT
    IF @PuedeEditar = 0
    BEGIN
      IF @MovTipo <> 'INV.TI'
        SELECT @Ok = 60300, @OkRef = RTRIM(@Mov) + ' ('+RTRIM(@Modulo)+')'
    END
  END

  IF @Accion <> 'CANCELAR' AND NULLIF(RTRIM(@Concepto), '') IS NOT NULL AND @Ok IS NULL
    IF EXISTS(SELECT * FROM EmpresaConcepto c, EmpresaConceptoValidar v WHERE v.Empresa = c.Empresa AND v.Modulo = c.Modulo AND v.Mov = c.Mov AND c.Empresa = @Empresa AND c.Modulo = @Modulo AND c.Mov = @Mov)
      IF NOT EXISTS(SELECT * FROM EmpresaConceptoValidar WHERE Empresa = @Empresa AND Modulo = @Modulo AND Mov = @Mov AND Concepto = @Concepto)
        SELECT @Ok = 20485, @OkRef = RTRIM(@Mov) + ' ('+RTRIM(@Concepto)+')'


  IF @Ok IS NOT NULL RETURN

  IF @Conexion = 0 
  BEGIN TRANSACTION

    SELECT @MovID = NULLIF(RTRIM(@MovID), '')

    IF @MovID IS NULL
    BEGIN
      EXEC xpConsecutivoSerie @Empresa, @Modulo, @ID, @Mov, @Serie OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
	--bug4219
		SELECT @PREFIJOSUCURSAL=prefijosucursal From movtipo WHERE Modulo = @Modulo AND Mov = @Mov	  	
      IF @Serie IS NOT NULL 
      BEGIN
		IF @prefijosucursal=1
			BEGIN
				SELECT @sucursalprincipal=@sucursal
				SELECT @SucursalConsecutivo = @SucursalPrincipal
			END ELSE 
					SELECT @SucursalPrincipal = Sucursal FROM Version
					SELECT @SucursalConsecutivo = @SucursalPrincipal
      END ELSE 
      BEGIN
        IF @Ok IS NULL
          SELECT @SucursalConsecutivo = @Sucursal

        IF @Sucursal <> @SucursalDestino
        BEGIN
          IF EXISTS(SELECT * FROM EmpresaGral WHERE Empresa = @Empresa AND UsarConsecutivoSucursalDestino = 1)
          BEGIN
            EXEC spSucursalEnLinea @SucursalDestino, @EnLinea OUTPUT
            IF @EnLinea = 1 
              SELECT @SucursalConsecutivo = @SucursalDestino
          END
        END
      END
      IF @Ok IS NULL
      BEGIN
        --IF @SucursalPrincipal IS NULL SELECT @SucursalPrincipal = Sucursal FROM Version
        --IF @SucursalConsecutivo <> @SucursalPrincipal
--          SELECT /*@MovID = NULL, EToral 29/Jun/2009 */@SucursalConsecutivo = @SucursalPrincipal
--            EXEC spConsecutivoAuto @SucursalConsecutivo, @Empresa, @Modulo, @Mov, @Ejercicio, @Periodo, @Serie, @MovID OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @CFD OUTPUT, @ID
        EXEC spConsecutivoAuto @SucursalConsecutivo, @Empresa, @Modulo, @Mov, @Ejercicio, @Periodo, @Serie, @MovID OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @CFD OUTPUT, @SubFoliosOrigen, @ConsecutivoUnico, @ID
      END
 
      IF @MovID IS NOT NULL AND @CFD = 0 AND @Ok IS NULL 
      BEGIN
        SELECT @Prefijo = NULL
        SELECT @Prefijo = NULLIF(RTRIM(Prefijo), '') FROM Sucursal WHERE Sucursal = @SucursalConsecutivo
        EXEC xpConsecutivoPrefijo @Empresa, @Modulo, @ID, @Mov, @MovID, @Prefijo OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
        IF @Prefijo IS NOT NULL
        BEGIN
	  IF (@Serie IS NOT NULL AND @ConsecutivoUnico = 1) SELECT @Prefijo = NULL
          IF dbo.fnEsNumerico(@Prefijo) = 1 SELECT @Ok = 70110, @OkRef = @Prefijo
          SELECT @MovID = RTRIM(@Prefijo) + RTRIM(@MovID)
          IF @Serie IS NULL SELECT @Serie = @Prefijo
        END ELSE
        BEGIN
          IF @SucursalPrincipal IS NULL SELECT @SucursalPrincipal = Sucursal FROM Version
          IF @SucursalConsecutivo <> @SucursalPrincipal
          BEGIN
			SELECT /*@MovID = NULL, EToral 29/Jun/2009 */@SucursalConsecutivo = @SucursalPrincipal
            EXEC spConsecutivoAuto @SucursalConsecutivo, @Empresa, @Modulo, @Mov, @Ejercicio, @Periodo, @Serie, @MovID OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @CFD OUTPUT, @SubFoliosOrigen, @ConsecutivoUnico, @ID
          END
        END
      END

      IF @Ok IS NULL  
      BEGIN
        IF @Modulo = 'CONT'  UPDATE Cont         SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'VTAS'  UPDATE Venta        SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'PROD'  UPDATE Prod         SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'COMS'  UPDATE Compra       SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'INV'   UPDATE Inv          SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'CXC'   UPDATE Cxc          SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'CXP'   UPDATE Cxp          SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'AGENT' UPDATE Agent        SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'GAS'   UPDATE Gasto        SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'DIN'   UPDATE Dinero       SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'EMB'   UPDATE Embarque     SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'NOM'   UPDATE Nomina       SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'RH'    UPDATE RH           SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'ASIS'  UPDATE Asiste       SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'AF'    UPDATE ActivoFijo   SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'PC'    UPDATE PC           SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'OFER'  UPDATE Oferta       SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'VALE'  UPDATE Vale         SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'CR'    UPDATE CR           SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'ST'    UPDATE Soporte      SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'CAP'   UPDATE Capital      SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'INC'   UPDATE Incidencia   SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'CONC'  UPDATE Conciliacion SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'PPTO'  UPDATE Presup       SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'CREDI'  UPDATE Credito	 SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'TMA'   UPDATE TMA          SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'RSS'   UPDATE RSS          SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'CMP'   UPDATE Campana      SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'FIS'   UPDATE Fiscal       SET MovID = @MovID WHERE ID = @ID ELSE
        --REQ25014
        IF @Modulo = 'CONTP' UPDATE ContParalela SET MovID = @MovID WHERE ID = @ID ELSE
        --REQ16092
		IF @Modulo = 'OPORT' UPDATE Oportunidad  SET MovID = @MovID WHERE ID = @ID ELSE		
        IF @Modulo = 'CORTE' UPDATE Corte        SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'FRM'   UPDATE FormaExtra   SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'CAPT'  UPDATE Captura      SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'GES'   UPDATE Gestion      SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'CP'    UPDATE CP           SET MovID = @MovID WHERE ID = @ID ELSE        
        IF @Modulo = 'PCP'   UPDATE PCP          SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'PROY'  UPDATE Proyecto     SET MovID = @MovID WHERE ID = @ID ELSE
	--IF @Modulo = 'ACT'   UPDATE Act           SET MovID = @MovID WHERE ID = @ID ELSE
	--IF @Modulo = 'MEX01' UPDATE ModuloExtra01 SET MovID = @MovID WHERE ID = @ID ELSE
	--IF @Modulo = 'MEX02' UPDATE ModuloExtra02 SET MovID = @MovID WHERE ID = @ID ELSE
	--IF @Modulo = 'MEX03' UPDATE ModuloExtra03 SET MovID = @MovID WHERE ID = @ID ELSE
	--IF @Modulo = 'MEX04' UPDATE ModuloExtra04 SET MovID = @MovID WHERE ID = @ID ELSE
	--IF @Modulo = 'MEX05' UPDATE ModuloExtra05 SET MovID = @MovID WHERE ID = @ID ELSE
	--IF @Modulo = 'MEX06' UPDATE ModuloExtra06 SET MovID = @MovID WHERE ID = @ID ELSE
	--IF @Modulo = 'MEX07' UPDATE ModuloExtra07 SET MovID = @MovID WHERE ID = @ID ELSE
	--IF @Modulo = 'MEX08' UPDATE ModuloExtra08 SET MovID = @MovID WHERE ID = @ID ELSE
	--IF @Modulo = 'MEX09' UPDATE ModuloExtra09 SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'ORG'   UPDATE Organiza     SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'RE'    UPDATE Recluta      SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'ISL'   UPDATE ISL          SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'CAM'   UPDATE Cambio       SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'PACTO' UPDATE Contrato     SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'SAUX'  UPDATE SAUX         SET MovID = @MovID WHERE ID = @ID ELSE
        IF @Modulo = 'PREV'  UPDATE PrevencionLD SET MovID = @MovID WHERE ID = @ID ELSE
        IF @@ERROR <> 0 SELECT @Ok = 1
      END

    END ELSE
      IF @Estatus IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR')
        EXEC spConsecutivoManual @SucursalConsecutivo, @Empresa, @Modulo, @ID, @Mov, @Ejercicio, @Periodo, @Serie OUTPUT, @MovID OUTPUT, @OK OUTPUT, @OkRef OUTPUT


   EXEC xpMovConsecutivo @Sucursal, @SucursalOrigen, @SucursalDestino, @Empresa, @Usuario, @Modulo, @Ejercicio, @Periodo, @ID, @Mov,
		         @Serie, @Estatus, @Concepto, @Accion, @Conexion, @SincroFinal, @MovID OUTPUT,  @Ok OUTPUT, @OkRef OUTPUT

  IF @Conexion = 0 
  BEGIN
    IF @Ok IS NULL
      COMMIT TRANSACTION
    ELSE
    BEGIN
      IF @Ok IS NULL
        SELECT @Ok = 30010, @OkRef = LTRIM(Convert(char, @MovID))
      ROLLBACK TRANSACTION
    END
  END

  RETURN
END
GO
/*
declare @situacion varchar(50)
exec spMovSituacionNueva 'VTAS', 'Hoja Disposicion', 'PENDIENTE', 'CONCLUIDO', @Situacion OUTPUT
select  @situacion 
*/

/************** spMovContAuto *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovContAuto') and type = 'P') drop procedure dbo.spMovContAuto
GO
CREATE PROCEDURE spMovContAuto
                   @Empresa		char(5),
		   @Sucursal		int,
		   @Modulo		char(5), 
		   @ID			int, 			
		   @Estatus		char(15), 
                   @EstatusNuevo	char(15),
		   @Usuario		char(10),
		   @FechaEmision	datetime, 	
		   @FechaRegistro	datetime,
		   @Mov			char(20),
		   @MovID		varchar(20),
		   @MovTipo		char(20),
		   @IDGenerar		int,
		   @Ok			int		OUTPUT,
		   @OkRef		varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @ContMov			varchar(20),
    @AfectarPresupuesto		varchar(30),
    @EstatusContabilizar	varchar(15),
    @EstatusMovTipo		varchar(15),
    @ContAutoEmpresa		varchar(10)

  SELECT @EstatusMovTipo = NULLIF(RTRIM(EstatusContabilizar), ''),
         @AfectarPresupuesto = NULLIF(NULLIF(RTRIM(AfectarPresupuesto), ''), '(por Omision)')
    FROM MovTipo 
   WHERE Modulo = @Modulo AND Mov = @Mov

  IF @EstatusMovTipo = '(por Omision) W'
  BEGIN
    SELECT @EstatusMovTipo = '(por Omision)'
    UPDATE MovTipo SET EstatusContabilizar = '(por Omision)' WHERE EstatusContabilizar = '(por Omision) W'
  END

  SELECT @ContMov = NULLIF(RTRIM(ContMov), ''),
         @EstatusContabilizar = NULLIF(RTRIM(EstatusContabilizar), ''),
         @AfectarPresupuesto = ISNULL(@AfectarPresupuesto, ISNULL(NULLIF(RTRIM(AfectarPresupuesto), ''), 'No'))
    FROM MovClave 
   WHERE Clave = @MovTipo
  IF UPPER(@EstatusMovTipo) NOT IN (NULL, '(POR OMISION)') SELECT @EstatusContabilizar = @EstatusMovTipo

  IF EXISTS(SELECT * FROM MovTipoContAuto WHERE Empresa = @Empresa  AND Modulo = @Modulo AND Clave IN ('('+RTRIM(@MovTipo)+')', @Mov)) SELECT @ContAutoEmpresa = @Empresa ELSE
  IF EXISTS(SELECT * FROM MovTipoContAuto WHERE Empresa = '(Todas)' AND Modulo = @Modulo AND Clave IN ('('+RTRIM(@MovTipo)+')', @Mov)) SELECT @ContAutoEmpresa = '(Todas)'

  IF NOT(@ContMov IS NOT NULL AND (@EstatusNuevo = @EstatusContabilizar OR (@Estatus IN (@EstatusContabilizar, 'CONCLUIDO') AND @EstatusNuevo = 'CANCELADO')))
    SELECT @ContAutoEmpresa = NULL

  IF (@ContAutoEmpresa IS NOT NULL AND @ContMov IS NOT NULL) OR @AfectarPresupuesto <> 'No'
    EXEC spContAuto @Empresa, @Sucursal, @Modulo,  @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @ContMov, @Ok OUTPUT, @OkRef OUTPUT, @ContAutoEmpresa = @ContAutoEmpresa
END
GO

/**************** spMovCopiarSerieLote ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovCopiarSerieLote') and type = 'P') drop procedure dbo.spMovCopiarSerieLote
GO             
CREATE PROCEDURE spMovCopiarSerieLote
		   @Sucursal	int,
		   @Modulo	char(5),
    		   @OID         int,
                   @DID		int,
		   @CopiarArtCostoInv	bit = 0
--//WITH ENCRYPTION
AS BEGIN
DECLARE
		@AlmWMS		bit
		
	IF @Modulo = 'VTAS'
		BEGIN
			SELECT @AlmWMS = A.WMS FROM Venta V JOIN Alm A ON V.Almacen = A.Almacen WHERE V.ID = @DID
		END
	IF @Modulo = 'INV'
		BEGIN
			SELECT @AlmWMS = A.WMS FROM Inv V JOIN Alm A ON V.Almacen = A.Almacen WHERE V.ID = @DID
		END

	IF @Modulo = 'TMA'
		BEGIN
			SELECT @AlmWMS = A.WMS FROM Tma V JOIN Alm A ON V.Almacen = A.Almacen WHERE V.ID = @DID
		END
		
	IF @Modulo = 'COMS'
		BEGIN
			SELECT @AlmWMS = A.WMS FROM Compra V JOIN Alm A ON V.Almacen = A.Almacen WHERE V.ID = @DID
		END		
	
	IF @AlmWMS = 1
		INSERT SerieLoteMov (Sucursal, Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, CantidadAlterna, Propiedades, Ubicacion, Cliente, Localizacion, ArtCostoInv, Tarima)
		SELECT @Sucursal, m.Empresa, m.Modulo, @DID, m.RenglonID, m.Articulo, m.SubCuenta, m.SerieLote, m.Cantidad, m.CantidadAlterna, m.Propiedades, m.Ubicacion, m.Cliente, m.Localizacion, CASE WHEN @CopiarArtCostoInv = 1 THEN m.ArtCostoInv ELSE NULL END, Tarima
		  FROM SerieLoteMov m
		 WHERE m.Modulo = @Modulo AND m.ID = @OID
	ELSE
		INSERT SerieLoteMov (Sucursal, Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad, CantidadAlterna, Propiedades, Ubicacion, Cliente, Localizacion, ArtCostoInv, Tarima)
		SELECT @Sucursal, m.Empresa, m.Modulo, @DID, m.RenglonID, m.Articulo, m.SubCuenta, m.SerieLote, SUM(m.Cantidad), NULLIF(SUM(ISNULL(m.CantidadAlterna,0)),0), m.Propiedades, m.Ubicacion, m.Cliente, m.Localizacion, CASE WHEN @CopiarArtCostoInv = 1 THEN m.ArtCostoInv ELSE NULL END, ''
		  FROM SerieLoteMov m
		 WHERE m.Modulo = @Modulo AND m.ID = @OID
      GROUP BY Sucursal, Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Propiedades, Ubicacion, Cliente, Localizacion, ArtCostoInv
END
GO

/**************** spMovCopiarOtros ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovCopiarOtros') and type = 'P') drop procedure dbo.spMovCopiarOtros
GO             
CREATE PROCEDURE spMovCopiarOtros
		   @Sucursal	int,
		   @Modulo	char(5),
    		   @OID         int,
                   @DID		int
--//WITH ENCRYPTION
AS BEGIN
  IF @Modulo = 'VTAS'
  BEGIN
    /* VentaCobro */
    SELECT * INTO #VentaCobro FROM cVentaCobro WHERE ID = @OID
    UPDATE #VentaCobro SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cVentaCobro SELECT * FROM #VentaCobro

    /* VentaCobroD */
    SELECT * INTO #VentaCobroD FROM cVentaCobroD WHERE ID = @OID
    UPDATE #VentaCobroD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cVentaCobroD SELECT * FROM #VentaCobroD

    /* Copiar VentaParticipacion */  
    INSERT VentaParticipacion (
           ID,  Concepto, Acreedor, Importe, Sucursal,  SucursalOrigen)
    SELECT @DID,Concepto, Acreedor, Importe, @Sucursal, @Sucursal 
      FROM VentaParticipacion 
     WHERE ID = @OID AND Automatica = 0
  END
END
GO

/**************** spMovCopiarDetalle ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovCopiarDetalle') and type = 'P') drop procedure dbo.spMovCopiarDetalle
GO             
CREATE PROCEDURE spMovCopiarDetalle
					@Sucursal	int,
					@Modulo		char(5),
    					@OID        	int,
					@DID		int,
					@Usuario	char(10) = NULL,
					@Base		varchar(20) = NULL,
					@GenerarMov	varchar(20) = NULL,
					@GenerarMovID	varchar(20) = NULL                     
--//WITH ENCRYPTION
AS BEGIN
  DECLARE @GenerarMovTipo	varchar(20)
  
  SELECT @GenerarMovTipo = Clave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @GenerarMov
  
  IF @Modulo = 'CONT'
  BEGIN
    SELECT * INTO #ContD FROM cContD WHERE ID = @OID
    UPDATE #ContD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cContD SELECT * FROM #ContD
  END ELSE
  IF @Modulo = 'CXC'
  BEGIN
    SELECT * INTO #CxcD FROM cCxcD WHERE ID = @OID AND LigadoDR = 0 AND UPPER(Aplica) NOT IN ('REDONDEO', 'SALDO A FAVOR', 'EFECTIVO A FAVOR')
    UPDATE #CxcD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID, Ligado = 0
    INSERT INTO cCxcD SELECT * FROM #CxcD
  END ELSE
  IF @Modulo = 'CXP'
  BEGIN
    SELECT * INTO #CxpD FROM cCxpD WHERE ID = @OID AND LigadoDR = 0 AND UPPER(Aplica) NOT IN ('REDONDEO', 'SALDO A FAVOR', 'EFECTIVO A FAVOR')
    UPDATE #CxpD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID, Ligado = 0
    INSERT INTO cCxpD SELECT * FROM #CxpD
  END ELSE
  IF @Modulo = 'AGENT'
  BEGIN
    SELECT * INTO #AgentD FROM cAgentD WHERE ID = @OID
    UPDATE #AgentD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cAgentD SELECT * FROM #AgentD
  END ELSE
  IF @Modulo = 'GAS'
  BEGIN
    SELECT * INTO #GastoD FROM cGastoD WHERE ID = @OID
    UPDATE #GastoD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cGastoD SELECT * FROM #GastoD
  END ELSE
  IF @Modulo = 'DIN'
  BEGIN
    SELECT * INTO #DineroD FROM cDineroD WHERE ID = @OID
    UPDATE #DineroD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cDineroD SELECT * FROM #DineroD
  END ELSE
  IF @Modulo = 'EMB'
  BEGIN
    SELECT * INTO #EmbarqueD FROM cEmbarqueD WHERE ID = @OID
    UPDATE #EmbarqueD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cEmbarqueD SELECT * FROM #EmbarqueD
  END ELSE
  IF @Modulo = 'NOM'
  BEGIN
    SELECT * INTO #NominaD FROM cNominaD WHERE ID = @OID
    UPDATE #NominaD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cNominaD SELECT * FROM #NominaD
  END ELSE
  IF @Modulo = 'RH'
  BEGIN
    SELECT * INTO #RHD FROM cRHD WHERE ID = @OID
    UPDATE #RHD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cRHD SELECT * FROM #RHD
  END ELSE
  IF @Modulo = 'ASIS'
  BEGIN
    SELECT * INTO #AsisteD FROM cAsisteD WHERE ID = @OID
    UPDATE #AsisteD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cAsisteD SELECT * FROM #AsisteD
  END ELSE
  IF @Modulo = 'AF'
  BEGIN
    SELECT * INTO #ActivoFijoD FROM cActivoFijoD WHERE ID = @OID
    UPDATE #ActivoFijoD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cActivoFijoD SELECT * FROM #ActivoFijoD
  END ELSE
  IF @Modulo = 'PC'
  BEGIN
    SELECT * INTO #PCD FROM cPCD WHERE ID = @OID
    UPDATE #PCD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cPCD SELECT * FROM #PCD
  END ELSE
  IF @Modulo = 'OFER'
  BEGIN
    SELECT * INTO #OfertaD FROM cOfertaD WHERE ID = @OID
    UPDATE #OfertaD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cOfertaD SELECT * FROM #OfertaD
    INSERT OfertaDVol (
           ID,   Articulo, Desde, Hasta, Cantidad, Porcentaje, Precio, Importe, Sucursal, ListaPrecios)
    SELECT @DID, Articulo, Desde, Hasta, Cantidad, Porcentaje, Precio, Importe, Sucursal, ListaPrecios
      FROM OfertaDVol
     WHERE ID = @OID
  END ELSE
  IF @Modulo = 'VALE'
  BEGIN
    SELECT * INTO #ValeD FROM cValeD WHERE ID = @OID
    UPDATE #ValeD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cValeD SELECT * FROM #ValeD
  END ELSE
  IF @Modulo = 'CR'
  BEGIN
    SELECT * INTO #CRVenta FROM cCRVenta WHERE ID = @OID
    UPDATE #CRVenta SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCRVenta SELECT * FROM #CRVenta

    SELECT * INTO #CRAgente FROM cCRAgente WHERE ID = @OID
    UPDATE #CRAgente SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCRAgente SELECT * FROM #CRAgente

    SELECT * INTO #CRCobro FROM cCRCobro WHERE ID = @OID
    UPDATE #CRCobro SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCRCobro SELECT * FROM #CRCobro

    SELECT * INTO #CRCaja FROM cCRCaja WHERE ID = @OID
    UPDATE #CRCaja SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCRCaja SELECT * FROM #CRCaja

    SELECT * INTO #CRSoporte FROM cCRSoporte WHERE ID = @OID
    UPDATE #CRSoporte SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCRSoporte SELECT * FROM #CRSoporte

    SELECT * INTO #CRInvFisico FROM cCRInvFisico WHERE ID = @OID
    UPDATE #CRInvFisico SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCRInvFisico SELECT * FROM #CRInvFisico

    SELECT * INTO #CRTrans FROM cCRTrans WHERE ID = @OID
    UPDATE #CRTrans SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCRTrans SELECT * FROM #CRTrans
  END ELSE
  IF @Modulo = 'CAP'
  BEGIN
    SELECT * INTO #CapitalD FROM cCapitalD WHERE ID = @OID
    UPDATE #CapitalD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCapitalD SELECT * FROM #CapitalD
  END ELSE
/*  IF @Modulo = 'INC'
  BEGIN
    SELECT * INTO #IncidenciaD FROM cIncidenciaD WHERE ID = @OID
    UPDATE #IncidenciaD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cIncidenciaD SELECT * FROM #IncidenciaD
  END ELSE*/
  IF @Modulo = 'CONC'
  BEGIN
    SELECT * INTO #ConciliacionD FROM cConciliacionD WHERE ID = @OID
    UPDATE #ConciliacionD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cConciliacionD SELECT * FROM #ConciliacionD
  END ELSE
  IF @Modulo = 'PPTO'
  BEGIN
    SELECT * INTO #PresupD FROM cPresupD WHERE ID = @OID
    UPDATE #PresupD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cPresupD SELECT * FROM #PresupD
  END ELSE
  /*IF @Modulo = 'CREDI'
  BEGIN
    SELECT * INTO #CreditoD FROM cCreditoD WHERE ID = @OID
    UPDATE #CreditoD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCreditoD SELECT * FROM #CreditoD
  END ELSE*/
  IF @Modulo = 'TMA'
  BEGIN
    SELECT * INTO #TMAD FROM cTMAD WHERE ID = @OID
    UPDATE #TMAD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cTMAD SELECT * FROM #TMAD
  END ELSE
  /*IF @Modulo = 'RSS'
  BEGIN
    SELECT * INTO #RSSD FROM cRSSD WHERE ID = @OID
    UPDATE #RSSD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cRSSD SELECT * FROM #RSSD
  END ELSE*/
  IF @Modulo = 'CMP'
  BEGIN
    SELECT * INTO #CampanaD FROM cCampanaD WHERE ID = @OID
    UPDATE #CampanaD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCampanaD SELECT * FROM #CampanaD
  END ELSE
  IF @Modulo = 'FIS'
  BEGIN
    SELECT * INTO #FiscalD FROM cFiscalD WHERE ID = @OID
    UPDATE #FiscalD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cFiscalD SELECT * FROM #FiscalD
  END ELSE
  --REQ25014
  IF @Modulo = 'CONTP'
  BEGIN
    SELECT * INTO #ContParalelaD FROM cContParalelaD WHERE ID = @OID
    UPDATE #ContParalelaD SET ID = @DID
    INSERT INTO cContParalelaD SELECT * FROM #ContParalelaD
  END ELSE  
  --REQ16092
  IF @Modulo = 'OPORT'
  BEGIN
    SELECT * INTO #OportunidadInteresadoEn FROM cOportunidadInteresadoEn WHERE ID = @OID
    UPDATE #OportunidadInteresadoEn SET ID = @DID
    INSERT INTO cOportunidadInteresadoEn SELECT * FROM #OportunidadInteresadoEn
    
    SELECT * INTO #CRMCompentencia FROM cOportunidadCompetencia WHERE ID = @OID
    UPDATE #CRMCompentencia SET ID = @DID    
    INSERT INTO cOportunidadCompetencia SELECT * FROM #CRMCompentencia

    IF ISNULL(@GenerarMovTipo, '') IN('OPORT.G')
    BEGIN
      SELECT * INTO #OportunidadD FROM cOportunidadD WHERE ID = @OID
      UPDATE #OportunidadD SET ID = @DID
      INSERT INTO cOportunidadD SELECT * FROM #OportunidadD
    END
  END ELSE  
  IF @Modulo = 'CORTE'
  BEGIN
    IF ISNULL(@GenerarMovTipo, '') = 'CORTE.REPEXTERNO'
    BEGIN    
      SELECT * INTO #CorteDReporte FROM cCorteDReporte WHERE ID = @OID
      UPDATE #CorteDReporte SET ID = @DID
      INSERT INTO cCorteDReporte SELECT * FROM #CorteDReporte
    END
    IF ISNULL(@GenerarMovTipo, '') IN('CORTE.CORTEIMPORTE', 'CORTE.CORTECONTABLE', 'CORTE.CORTEUNIDADES', 'CORTE.CORTECX')
    BEGIN    
      SELECT * INTO #CorteDConsulta FROM cCorteDConsulta WHERE ID = @OID
      UPDATE #CorteDConsulta SET ID = @DID
      INSERT INTO cCorteDConsulta SELECT * FROM #CorteDConsulta
    END    
  END ELSE
  IF @Modulo = 'FRM'
  BEGIN
    SELECT * INTO #FormaExtraD FROM cFormaExtraD WHERE ID = @OID
    UPDATE #FormaExtraD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cFormaExtraD SELECT * FROM #FormaExtraD
  END ELSE
  IF @Modulo = 'CAPT'
  BEGIN
    SELECT * INTO #CapturaD FROM cCapturaD WHERE ID = @OID
    UPDATE #CapturaD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCapturaD SELECT * FROM #CapturaD
  END ELSE
  IF @Modulo = 'GES'
  BEGIN
    SELECT * INTO #GestionAgenda FROM cGestionAgenda WHERE ID = @OID
    UPDATE #GestionAgenda SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cGestionAgenda SELECT * FROM #GestionAgenda

    SELECT * INTO #GestionPara FROM cGestionPara WHERE ID = @OID
    UPDATE #GestionPara SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cGestionPara SELECT * FROM #GestionPara

    SELECT * INTO #GestionRecurso FROM cGestionRecurso WHERE ID = @OID
    UPDATE #GestionRecurso SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cGestionRecurso SELECT * FROM #GestionRecurso
    
    SELECT ID, Tipo, Indicador, Referencia, LecturaAnterior, Lectura INTO #GestionActivoFIndicador FROM GestionActivoFIndicador WHERE ID = @OID
    UPDATE #GestionActivoFIndicador SET ID = @DID
    INSERT INTO GestionActivoFIndicador (ID, Tipo, Indicador, Referencia, LecturaAnterior, Lectura) SELECT ID, Tipo, Indicador, Referencia, LecturaAnterior, Lectura
           FROM #GestionActivoFIndicador
  END ELSE
  IF @Modulo = 'CP'
  BEGIN
    SELECT * INTO #CPD FROM cCPD WHERE ID = @OID
    UPDATE #CPD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCPD SELECT * FROM #CPD

    SELECT * INTO #CPCal FROM cCPCal WHERE ID = @OID
    UPDATE #CPCal SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCPCal SELECT * FROM #CPCal

    SELECT * INTO #CPArt FROM cCPArt WHERE ID = @OID
    UPDATE #CPArt SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cCPArt SELECT * FROM #CPArt
  END ELSE  
  IF @Modulo = 'PCP'
  BEGIN
    SELECT * INTO #PCPD FROM cPCPD WHERE ID = @OID
    UPDATE #PCPD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cPCPD SELECT * FROM #PCPD
    
    SELECT * INTO #PCPDRegla FROM cPCPDRegla WHERE ID = @OID
    UPDATE #PCPDRegla SET ID = @DID
    INSERT INTO cPCPDRegla SELECT * FROM #PCPDRegla
  END ELSE    
  IF @Modulo = 'PROY'
  BEGIN
    SELECT * INTO #ProyectoD FROM cProyectoD WHERE ID = @OID
    UPDATE #ProyectoD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    IF @GenerarMov IS NOT NULL UPDATE #ProyectoD  SET Avance = NULL, Estado = NULL
    INSERT INTO cProyectoD SELECT * FROM #ProyectoD
  END 
  /*ELSE
  IF @Modulo = 'ACT'
  BEGIN
    SELECT * INTO #ActD FROM cActD WHERE ID = @OID
    UPDATE #ActD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cActD SELECT * FROM #ActD
  END*/
  /*ELSEOfertaD
  IF @Modulo = 'MEX01'
  BEGIN
    SELECT * INTO #ModuloExtra01D FROM cModuloExtra01D WHERE ID = @OID
    UPDATE #ModuloExtra01D SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cModuloExtra01D SELECT * FROM #ModuloExtra01D
  END*/
  /*ELSE
  IF @Modulo = 'MEX02'
  BEGIN
    SELECT * INTO #ModuloExtra02D FROM cModuloExtra02D WHERE ID = @OID
    UPDATE #ModuloExtra02D SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cModuloExtra02D SELECT * FROM #ModuloExtra02D
  END*/
  /*ELSE
  IF @Modulo = 'MEX03'
  BEGIN
    SELECT * INTO #ModuloExtra03D FROM cModuloExtra03D WHERE ID = @OID
    UPDATE #ModuloExtra03D SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cModuloExtra03D SELECT * FROM #ModuloExtra03D
  END*/
  /*ELSE
  IF @Modulo = 'MEX04'
  BEGIN
    SELECT * INTO #ModuloExtra04D FROM cModuloExtra04D WHERE ID = @OID
    UPDATE #ModuloExtra04D SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cModuloExtra04D SELECT * FROM #ModuloExtra04D
  END*/
  /*ELSE
  IF @Modulo = 'MEX05'
  BEGIN
    SELECT * INTO #ModuloExtra05D FROM cModuloExtra05D WHERE ID = @OID
    UPDATE #ModuloExtra05D SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cModuloExtra05D SELECT * FROM #ModuloExtra05D
  END*/
  /*ELSE
  IF @Modulo = 'MEX06'
  BEGIN
    SELECT * INTO #ModuloExtra06D FROM cModuloExtra01D WHERE ID = @OID
    UPDATE #ModuloExtra06D SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cModuloExtra06D SELECT * FROM #ModuloExtra06D
  END*/
  /*ELSE
  IF @Modulo = 'MEX07'
  BEGIN
    SELECT * INTO #ModuloExtra07D FROM cModuloExtra07D WHERE ID = @OID
    UPDATE #ModuloExtra07D SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cModuloExtra07D SELECT * FROM #ModuloExtra07D
  END*/
  /*ELSE
  IF @Modulo = 'MEX08'
  BEGIN
    SELECT * INTO #ModuloExtra08D FROM cModuloExtra08D WHERE ID = @OID
    UPDATE #ModuloExtra08D SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cModuloExtra08D SELECT * FROM #ModuloExtra08D
  END*/
  /*ELSE
  IF @Modulo = 'MEX09'
  BEGIN
    SELECT * INTO #ModuloExtra09D FROM cModuloExtra09D WHERE ID = @OID
    UPDATE #ModuloExtra09D SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cModuloExtra09D SELECT * FROM #ModuloExtra09D
  END*/
  ELSE
  IF @Modulo = 'ORG'
  BEGIN
    SELECT * INTO #OrganizaD FROM cOrganizaD WHERE ID = @OID
    UPDATE #OrganizaD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cOrganizaD SELECT * FROM #OrganizaD
  END
  ELSE
  IF @Modulo = 'RE'
  BEGIN
    SELECT * INTO #ReclutaD FROM cReclutaD WHERE ID = @OID
    UPDATE #ReclutaD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cReclutaD SELECT * FROM #ReclutaD

    SELECT * INTO #ReclutaPlaza FROM cReclutaPlaza WHERE ID = @OID
    UPDATE #ReclutaPlaza SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cReclutaPlaza SELECT * FROM #ReclutaPlaza

    SELECT * INTO #ReclutaCompetenciaTipo FROM cReclutaCompetenciaTipo WHERE ID = @OID
    UPDATE #ReclutaCompetenciaTipo SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cReclutaCompetenciaTipo SELECT * FROM #ReclutaCompetenciaTipo
  END
  ELSE
  IF @Modulo = 'ISL'
  BEGIN
    SELECT * INTO #ISLD FROM cISLD WHERE ID = @OID
    UPDATE #ISLD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID
    INSERT INTO cISLD SELECT * FROM #ISLD
  END
END
GO

/**************** spMovCopiarCambioD ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovCopiarCambioD') and type = 'P') drop procedure dbo.spMovCopiarCambioD
GO             
CREATE PROCEDURE spMovCopiarCambioD
                   @Empresa	char(5),
		   @Sucursal	int,
		   @Modulo	char(5),
    		   @OID         int,
                   @DID		int
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Moneda		char(10), 
    @Tipo		char(6), 
    @Instrumento	char(10), 
    @Cobertura		float

  SELECT * INTO #CambioD FROM cCambioD WHERE ID = @OID
  UPDATE #CambioD SET Sucursal = @Sucursal, SucursalOrigen = @Sucursal, ID = @DID

  DECLARE crCambioD CURSOR FOR
   SELECT i.Moneda, d.Tipo, d.Instrumento
     FROM #CambioD d, Instrumento i
    WHERE d.Instrumento = i.Instrumento

  OPEN crCambioD
  FETCH NEXT FROM crCambioD INTO @Moneda, @Tipo, @Instrumento
  WHILE @@FETCH_STATUS <> -1 
  BEGIN
    IF @@FETCH_STATUS <> -2 
    BEGIN
      EXEC spCalcCoberturaSilencio @Empresa, @Moneda, @Tipo, @Instrumento, @Cobertura OUTPUT
      UPDATE #CambioD SET Cobertura = @Cobertura WHERE CURRENT OF crCambioD
    END
    FETCH NEXT FROM crCambioD INTO @Moneda, @Tipo, @Instrumento
  END  -- While
  CLOSE crCambioD
  DEALLOCATE crCambioD

  INSERT INTO cCambioD SELECT * FROM #CambioD
END
GO

/**************** spMovCopiarGastoDiverso ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovCopiarGastoDiverso') and type = 'P') drop procedure dbo.spMovCopiarGastoDiverso
GO             
CREATE PROCEDURE spMovCopiarGastoDiverso
		   @Modulo	char(5),
		   @Sucursal	int,
                   @ID		int,
		   @GenerarID	int
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @RenglonID		int,
    @RenglonIDNuevo	int

  IF @Modulo = 'COMS' DECLARE crGastoDiverso CURSOR FOR SELECT RenglonID FROM CompraGastoDiverso WHERE ID = @ID ELSE
  IF @Modulo = 'INV'  DECLARE crGastoDiverso CURSOR FOR SELECT RenglonID FROM CompraGastoDiverso WHERE ID = @ID

  OPEN crGastoDiverso
  FETCH NEXT FROM crGastoDiverso INTO @RenglonID
  WHILE @@FETCH_STATUS <> -1 
  BEGIN
    IF @@FETCH_STATUS <> -2 
    BEGIN
      IF @Modulo = 'COMS'
      BEGIN
        INSERT CompraGastoDiverso 
               (ID,        Concepto, Acreedor, Importe, PorcentajeImpuestos, Moneda, TipoCambio, Prorrateo, FechaEmision, Condicion, Vencimiento, Referencia, Retencion, Retencion2, Retencion3, Impuestos, Multiple, Sucursal,  PedimentoEspecifico, ProrrateoNivel)
        SELECT @GenerarID, Concepto, Acreedor, Importe, PorcentajeImpuestos, Moneda, TipoCambio, Prorrateo, FechaEmision, Condicion, Vencimiento, Referencia, Retencion, Retencion2, Retencion3, Impuestos, Multiple, @Sucursal, PedimentoEspecifico, ProrrateoNivel
          FROM CompraGastoDiverso 
         WHERE ID = @ID AND RenglonID = @RenglonID
        SELECT @RenglonIDNuevo = SCOPE_IDENTITY()

        INSERT CompraGastoDiversoD 
              (ID,         RenglonID,       Concepto, Acreedor, ConceptoD, Importe, Retencion, Retencion2, Retencion3, Impuestos, Referencia, Sucursal)
        SELECT @GenerarID, @RenglonIDNuevo, Concepto, Acreedor, ConceptoD, Importe, Retencion, Retencion2, Retencion3, Impuestos, Referencia, @Sucursal
          FROM CompraGastoDiversoD
         WHERE ID = @ID AND RenglonID = @RenglonID

        INSERT CompraGastoDiversoProv
              (ID,         Concepto, Proveedor)
        SELECT @GenerarID, Concepto, Proveedor
          FROM CompraGastoDiversoProv
         WHERE ID = @ID

        INSERT CompraGastoDiversoRef
              (ID,         Concepto, Referencia)
        SELECT @GenerarID, Concepto, Referencia
          FROM CompraGastoDiversoRef
         WHERE ID = @ID

        INSERT CompraGastoDiversoArt
              (ID,         Concepto, Articulo)
        SELECT @GenerarID, Concepto, Articulo
          FROM CompraGastoDiversoArt
         WHERE ID = @ID

      END ELSE
      IF @Modulo = 'INV'
      BEGIN
        INSERT InvGastoDiverso 
               (ID,        Concepto, Acreedor, Importe, PorcentajeImpuestos, Moneda, TipoCambio, Prorrateo, FechaEmision, Condicion, Vencimiento, Referencia, Retencion, Retencion2, Retencion3, Impuestos, Multiple, Sucursal,  PedimentoEspecifico)
        SELECT @GenerarID, Concepto, Acreedor, Importe, PorcentajeImpuestos, Moneda, TipoCambio, Prorrateo, FechaEmision, Condicion, Vencimiento, Referencia, Retencion, Retencion2, Retencion3, Impuestos, Multiple, @Sucursal, PedimentoEspecifico
          FROM InvGastoDiverso 
         WHERE ID = @ID AND RenglonID = @RenglonID
        SELECT @RenglonIDNuevo = SCOPE_IDENTITY()

        INSERT InvGastoDiversoD 
               (ID,        RenglonID,       Concepto, Acreedor, ConceptoD, Importe, Retencion, Retencion2, Retencion3, Impuestos, Referencia, Sucursal)
        SELECT @GenerarID, @RenglonIDNuevo, Concepto, Acreedor, ConceptoD, Importe, Retencion, Retencion2, Retencion3, Impuestos, Referencia, @Sucursal
          FROM InvGastoDiversoD
         WHERE ID = @ID AND RenglonID = @RenglonID
      END
    END
    FETCH NEXT FROM crGastoDiverso INTO @RenglonID
  END  -- While
  CLOSE crGastoDiverso
  DEALLOCATE crGastoDiverso
END
GO
/**************** spMovCopiarFormaAnexa *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovCopiarFormaAnexa') and type = 'p') drop procedure dbo.spMovCopiarFormaAnexa
GO
CREATE PROCEDURE spMovCopiarFormaAnexa
                @Modulo                 varchar(5),
                @OID                    int,
                @DID                    int
--//WITH ENCRYPTION 
AS BEGIN
  IF @Modulo = 'PROY'
  BEGIN
    INSERT ProyectoDesarrollo (ID, Tipo, VersionCliente, Causa, FechaRequerida, Importe, Moneda, TipoCambio, Clase1, Clase2, Clase3, Clase4, Clase5, Problema, Solucion)
      SELECT @DID, Tipo, VersionCliente, Causa, FechaRequerida, Importe, Moneda, TipoCambio, Clase1, Clase2, Clase3, Clase4, Clase5, Problema, Solucion
        FROM ProyectoDesarrollo
       WHERE ID = @OID
  END

  EXEC xpMovCopiarFormaAnexa @Modulo, @OID, @DID
  RETURN
END
GO

/****************** spMovCopiarProyecto ******************/
if exists (select * from sysobjects where id = object_id('dbo.spMovCopiarProyecto') and type = 'p') drop procedure spMovCopiarProyecto
GO
CREATE PROCEDURE spMovCopiarProyecto
                @Empresa                varchar(5),
                @Sucursal               int,
                @ID                     int,
                @IDGenerar              int
--//WITH ENCRYPTION
AS BEGIN
  INSERT ProyectoRecurso ( 
           ID,         Recurso, Estatus, TieneMovimientos, Rol, HorasDia, PrecioHora, CostoHora, Comienzo, ComienzoProgramado, Fin, FinProgramado, Sucursal,  SucursalOrigen, SucursalDestino)
    SELECT @IDGenerar, Recurso, Estatus, TieneMovimientos, Rol, HorasDia, PrecioHora, CostoHora, Comienzo, ComienzoProgramado, Fin, FinProgramado, @Sucursal, @Sucursal,      @Sucursal
      FROM ProyectoRecurso
     WHERE ID = @ID

  INSERT ProyectoDRecurso ( ID, Actividad, Recurso, Comienzo, Fin, Sucursal, SucursalOrigen, SucursalDestino)
    SELECT @IDGenerar, Actividad, Recurso, Comienzo, Fin, @Sucursal, @Sucursal, @Sucursal
      FROM ProyectoDRecurso
     WHERE ID = @ID

  INSERT ProyectoDia ( ID, Fecha, HorasDia, Concepto, Sucursal, SucursalOrigen, SucursalDestino)
    SELECT @IDGenerar, Fecha, HorasDia, Concepto, @Sucursal, @Sucursal, @Sucursal
      FROM ProyectoDia
     WHERE ID = @ID

  INSERT MovCto (
         Modulo, ModuloID,   Nombre, ApellidoPaterno, ApellidoMaterno, Atencion, Tratamiento, Cargo, Grupo, FechaNacimiento, Telefonos, Extencion, eMail, Fax, PedirTono, Tipo, Sexo, Usuario)
  SELECT Modulo, @IDGenerar, Nombre, ApellidoPaterno, ApellidoMaterno, Atencion, Tratamiento, Cargo, Grupo, FechaNacimiento, Telefonos, Extencion, eMail, Fax, PedirTono, Tipo, Sexo, Usuario
    FROM MovCto
   WHERE ModuloID = @ID

  INSERT ProyectoDArtMaterial (
          ID,         Actividad, Material, SubCuenta, Cantidad, Unidad, Almacen) 
  SELECT  @IDGenerar, Actividad, Material, SubCuenta, Cantidad, Unidad, Almacen 
    FROM ProyectoDArtMaterial WHERE ID = @ID

  RETURN
END
GO

-- select * from ac
-- spMovCopiar 0, 'VTAS', 3, 'DEMO', '1/1/2004'
/**************** spMovCopiar ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovCopiar') and type = 'P') drop procedure dbo.spMovCopiar
GO             
CREATE PROCEDURE spMovCopiar
	@Sucursal				int,
	@Modulo					char(5),
	@ID						int,
	@Usuario				char(10),
	@FechaTrabajo			datetime,
	@EnSilencio				bit = 0,
	@Identico				bit = 0,
	@Directo				bit = 1,
	@Sub					bit = 0,
	@GenerarMov				varchar(20) = NULL,
	@GenerarMovID			varchar(20) = NULL,
	@CopiarArtCostoInv		bit = 0,
	@CopiarSucursalDestino	bit = 0,
	@Conexion				bit = 0,
	@SinDetalle				bit = 0
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
	@p					int,
	@Base				varchar(20),
	@Empresa			char(5),
	@Mov				varchar(20),
	@MovID				varchar(20),
	@MovTipo			varchar(20),
	@Moneda				char(10),
	@TipoCambio			float,
	@Almacen			char(10),
    @AlmacenDestino		char(10),
	@Ok					int,
	@GenerarID			int,
	@Max				int,
	@MasterMovID		varchar(20),
	@AnexoID			int,
	@AnexarOrdenes		int 

	IF @Identico = 1 
		SELECT @Base = 'IDENTICO' 
	ELSE 
		SELECT @Base = 'TODO'
  
	SELECT @GenerarID = NULL, @AnexarOrdenes = 0, @AnexoID = NULL
  
	EXEC spExtraerFecha @FechaTrabajo OUTPUT
	EXEC spIDEnMov @Modulo, @ID, @Empresa OUTPUT, @Mov OUTPUT, @MovID OUTPUT, @Moneda OUTPUT, @Almacen OUTPUT, @AlmacenDestino OUTPUT, @Ok OUTPUT
	
	SELECT @MovTipo = Clave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov
	
	IF @Sub = 1 AND @MovTipo IN ('VTAS.P', 'VTAS.S', 'VTAS.SD', 'VTAS.R'/*, 'VTAS.VCR'*/)
	BEGIN
		IF (SELECT VentaAnexarOrdenes FROM EmpresaCfg2 WHERE Empresa = @Empresa) = 1 
			BEGIN
				SELECT @AnexarOrdenes = 1 
				SELECT @AnexoID = ISNULL(AnexoID, ID) FROM Venta WHERE ID = @ID
			END
	END
	
	IF @GenerarMov IS NULL 
		SELECT @GenerarMov = @Mov
	
	IF @Sub = 1 
		BEGIN
			SELECT @p = CHARINDEX('-', @MovID)
			
			IF @p > 0 
				SELECT @MasterMovID = SUBSTRING(@MovID, 1, @p-1) ELSE SELECT @MasterMovID = @MovID
			
			IF @Modulo = 'VTAS'
				SELECT @Max = ISNULL(MAX(CONVERT(int, SUBSTRING(MovID, LEN(@MasterMovID)+2, 20))), 0) FROM Venta WHERE Empresa = @Empresa AND Mov = @GenerarMov AND MovID LIKE RTRIM(@MasterMovID)+'-%'
			ELSE
				SELECT @Max = ISNULL(MAX(CONVERT(int, SUBSTRING(MovID, LEN(@MasterMovID)+2, 20))), 0) FROM Mov WHERE Empresa = @Empresa AND Mov = @GenerarMov AND MovID LIKE RTRIM(@MasterMovID)+'-%'
    
			SELECT @GenerarMovID = RTRIM(@MasterMovID)+'-'+CONVERT(varchar, @Max+1)
		END

	IF @Conexion = 0 
		BEGIN TRANSACTION
			SELECT @TipoCambio = TipoCambio FROM Mon WHERE Moneda = @Moneda
			
			IF (SELECT ISNULL(ArrastrarTipoCambioGenerarMov, 0) FROM EmpresaGral WHERE Empresa = @Empresa) = 1 OR
				(SELECT ISNULL(ArrastrarTipoCambioGenerarMov, 0) FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov) = 1  
			
			SELECT @TipoCambio = NULL

			EXEC spMovCopiarEncabezado @Sucursal, @Modulo,  @ID, @Empresa, NULL, NULL, @Usuario, @FechaTrabajo, 
									   'SINAFECTAR', @Moneda, @TipoCambio, @Almacen, @AlmacenDestino, @Directo, @GenerarMov, @GenerarMovID,
									   @GenerarID OUTPUT, @Ok OUTPUT, 0, @CopiarSucursalDestino = @CopiarSucursalDestino
    
			IF @GenerarID IS NOT NULL 
				BEGIN
					IF @Identico = 1 
						EXEC spMovCopiarOtros @Sucursal, @Modulo, @ID, @GenerarID
					
					IF @Sub = 1
						BEGIN
							IF @AnexarOrdenes = 1 
								BEGIN
									IF @Modulo = 'VTAS' 
										UPDATE Venta SET AnexoID = @AnexoID WHERE ID = @GenerarID
								END
						END 
					ELSE 
						BEGIN
							IF @SinDetalle = 0
								BEGIN
									IF @Modulo IN ('VTAS', 'INV', 'COMS', 'PROD'/*, 'TMA'*/, 'SAUX') 
										BEGIN
											EXEC spInvUtilizarTodoDetalle @Sucursal, @Modulo, @Base, @ID, NULL, NULL, NULL, @GenerarID, 1, NULL, @Empresa = @Empresa
											
											-- BUG 6168
											IF @MovTipo NOT IN ('VTAS.P','INV.OT','INV.OI')
												EXEC spMovCopiarSerieLote @Sucursal, @Modulo, @ID, @GenerarID, @CopiarArtCostoInv = @CopiarArtCostoInv
											
											IF @Modulo IN ('COMS', 'INV') 
												EXEC spMovCopiarGastoDiverso @Modulo, @Sucursal, @ID, @GenerarID
										END
									ELSE
							
										IF @Modulo = 'CAM'
											EXEC spMovCopiarCambioD @Empresa, @Sucursal, @Modulo, @ID, @GenerarID
										ELSE 
											BEGIN
												IF @Modulo NOT IN ('EMB')
													EXEC spMovCopiarDetalle @Sucursal, @Modulo, @ID, @GenerarID, @Usuario, @Base, @GenerarMov, @GenerarMovID
												
												IF @Modulo = 'OFER'
													INSERT OfertaFiltro (ID,         Campo, Valor, Sucursal) 
																 SELECT @GenerarID, Campo, Valor, @Sucursal
																   FROM OfertaFiltro
																  WHERE ID = @ID
												
												IF @Modulo = 'PC' 
													EXEC spPCArtListaAceptar 0, @GenerarID
												
												IF @Modulo = 'PROY'
													EXEC spMovCopiarProyecto @Empresa, @Sucursal, @ID, @GenerarID
											END
									END
							END
		
					EXEC spMovCopiarFormaAnexa @Modulo, @ID, @GenerarID

					IF EXISTS(SELECT * FROM EmpresaCfgModulo WHERE Empresa = @Empresa AND Modulo = @Modulo AND Tiempos = 'Si')
						INSERT INTO MovTiempo (Modulo,  Sucursal,  ID,         Usuario,  FechaInicio, FechaComenzo, Estatus) 
									   VALUES (@Modulo, @Sucursal, @GenerarID, @Usuario, GETDATE(),   GETDATE(),    'SINAFECTAR')
				END

		--EXEC vic_spMovCopiar @Sucursal, @Modulo, @ID, @Usuario, @FechaTrabajo, @EnSilencio, @Identico, @Directo, @Sub, @GenerarID,  @GenerarMov, @GenerarMovID, @CopiarArtCostoInv

		EXEC xpMovCopiar @Sucursal, @Modulo, @ID, @Usuario, @FechaTrabajo, @EnSilencio, @Identico, @Directo, @Sub, @GenerarID,  @GenerarMov, @GenerarMovID, @CopiarArtCostoInv

		IF @Conexion = 0 
			COMMIT TRANSACTION

		IF @EnSilencio = 0
			SELECT 80030, NULL, NULL, NULL, @GenerarID

	RETURN @GenerarID
END
GO
/**************** spMovCopiarAnexos ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovCopiarAnexos') and type = 'P') drop procedure dbo.spMovCopiarAnexos
GO             
CREATE PROCEDURE spMovCopiarAnexos
		   @Sucursal		int,
		   @OModulo		char(5),
    		   @OID         	int,
		   @DModulo		char(5),
                   @DID			int,
                   @CopiarBitacora 	bit = 0
--//WITH ENCRYPTION
AS BEGIN
  DECLARE	@MovTipo		varchar(20),
		@SubMovTipo		varchar(20)

  IF @OModulo IS NOT NULL AND @OID IS NOT NULL AND @DModulo IS NOT NULL AND @DID IS NOT NULL
  BEGIN
    INSERT AnexoMov (Sucursal, Rama, ID, Nombre, Direccion, Icono, Tipo, Orden, Comentario)
    SELECT @Sucursal, @DModulo, @DID, Nombre, Direccion, Icono, Tipo, Orden, Comentario
      FROM AnexoMov
	 WHERE Rama = @OModulo AND ID = @OID AND CFD = 0

    IF @OModulo IN ('VTAS', 'INV', 'COMS', 'PROD')  AND @DModulo IN ('VTAS', 'INV', 'COMS', 'PROD') 
      INSERT AnexoMovD (Sucursal, Rama, ID, Cuenta, Nombre, Direccion, Icono, Tipo, Orden, Comentario)
      SELECT @Sucursal, @DModulo, @DID, Cuenta, Nombre, Direccion, Icono, Tipo, Orden, Comentario
        FROM AnexoMovD
       WHERE Rama = @OModulo AND ID = @OID

    -- Copiar Bitacora
    IF @CopiarBitacora = 1
      INSERT MovBitacora (Sucursal, Modulo, ID, Fecha, Evento, Usuario)
      SELECT @Sucursal, @DModulo, @DID, Fecha, Evento, Usuario
        FROM MovBitacora     
       WHERE Modulo = @OModulo AND ID = @OID

    -- Copiar Agentes
    IF @OModulo = 'VTAS' AND @DModulo = 'VTAS'
    BEGIN
      SELECT @MovTipo = mt.Clave, @SubMovTipo = mt.SubClave FROM Venta v JOIN MovTipo mt ON mt.Mov = v.Mov AND mt.Modulo =  @OModulo AND v.ID = @OID

      INSERT VentaDAgente (ID, Renglon, RenglonSub, Agente, Fecha, HoraD, HoraA, Minutos, Actividad, Estado, Comentarios, CantidadEstandar, CostoActividad, FechaConclusion)
                  SELECT @DID, Renglon, RenglonSub, Agente, Fecha, HoraD, HoraA, Minutos, Actividad, Estado, Comentarios, CantidadEstandar, CostoActividad, FechaConclusion
                    FROM VentaDAgente
                  WHERE ID = @OID
      INSERT VentaEntrega (ID, Sucursal, Embarque, EmbarqueFecha, EmbarqueReferencia, Recibo, ReciboFecha, ReciboReferencia)
                  SELECT @DID, @Sucursal, Embarque, EmbarqueFecha, EmbarqueReferencia, Recibo, ReciboFecha, ReciboReferencia
                    FROM VentaEntrega
                  WHERE ID = @OID

      

      IF @OModulo = 'VTAS' AND @MovTipo = 'VTAS.F' AND @SubMovTipo = 'FF.FF'
        INSERT VentaFlexibleD (ID,   Renglon, Articulo, Cantidad, Precio, Importe, Cliente)
                       SELECT  @DID, Renglon, Articulo, Cantidad, Precio, Importe, Cliente 
                         FROM VentaFlexibleD
                        WHERE ID = @OID

    END

    -- Copiar Prorrateos
    /*IF @OModulo = 'COMS' AND @DModulo = 'COMS'
      INSERT CompraDProrrateo (ID, RenglonID, Articulo, SubCuenta, Almacen, Cantidad, Sucursal, SucursalOrigen)
                        SELECT @DID, RenglonID, Articulo, SubCuenta, Almacen, Cantidad, Sucursal, SucursalOrigen
                          FROM CompraDProrrateo
                         WHERE ID = @OID*/
  END
END
GO

--REQ12615 WMS
/**************** xpMovCopiarEncabezadoWMS ****************/
if exists (select * from sysobjects where id = object_id('dbo.xpMovCopiarEncabezadoWMS') and type = 'P') drop procedure dbo.xpMovCopiarEncabezadoWMS
GO             
CREATE PROCEDURE xpMovCopiarEncabezadoWMS
			@Modulo			char(5), 
			@ID				int,
			@GenerarModulo	char(5), 
			@GenerarID		int

AS BEGIN
  -- SET nocount ON
  DECLARE
    @Posicion		varchar(10),
    @PosicionD		varchar(10),
    @Montacarga		varchar(10),
    @TarimaSurtido	varchar(20),
	@Prioridad      varchar(10)

  -- SET nocount ON
  SELECT @Posicion = PosicionWMS, @PosicionD = PosicionDWMS 
    FROM Inv 
   WHERE ID = @ID
  SELECT @Montacarga = Montacarga,
	     @TarimaSurtido = TarimaSurtido,
		 @Prioridad = Prioridad
    FROM TMA WHERE ID = @ID

  IF @Modulo = 'INV'
    UPDATE Inv SET PosicionWMS = @Posicion, PosicionDWMS = @PosicionD WHERE ID = @GenerarID
  ELSE
  IF @Modulo = 'TMA'
    UPDATE TMA SET Montacarga = @Montacarga, TarimaSurtido = @TarimaSurtido, Prioridad = @Prioridad WHERE ID = @GenerarID
  ELSE
  IF @Modulo = 'COMS'
    UPDATE Compra SET PosicionWMS = (SELECT PosicionWMS FROM Compra WHERE ID = @ID) WHERE ID = @GenerarID
  ELSE
  IF @Modulo = 'VTAS'
    UPDATE Venta SET PosicionWMS = (SELECT PosicionWMS FROM Venta WHERE ID = @ID) WHERE ID = @GenerarID
      
  RETURN
END
GO

/**************** spMovCopiarEncabezado ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovCopiarEncabezado') and type = 'P') drop procedure dbo.spMovCopiarEncabezado
GO             
CREATE PROCEDURE spMovCopiarEncabezado
			@Sucursal	int,
			@Modulo		char(5), 
			@ID		int,

		    	@Empresa	char(5), 
			@Mov		char(20),
			@MovID 		varchar(20),
			@Usuario	char(10), 
			@FechaEmision	datetime, 
			@Estatus	char(15),

			@Moneda		char(10),
			@TipoCambio	float,
			@Almacen	char(10),
		        @AlmacenDestino char(10),

			@GenerarDirecto	bit,
			@GenerarMov	char(20),
			@GenerarMovID 	varchar(20), 
			@GenerarID	int	OUTPUT,

			@Ok		int	OUTPUT,
			@CopiarBitacora	bit = 0,
			@CopiarSucursalDestino bit = 0
--//WITH ENCRYPTION
AS BEGIN 
  DECLARE
    @Contacto				char(10),
    @Condicion				varchar(50),
    @Vencimiento			datetime,
    @OrigenTipo				char(10),
    @Origen					char(20),
    @OrigenID				varchar(20),
    @UsarSucursalMovOrigen 	bit,
    @AC				        bit,
    @CfgTipoCambio			varchar(20),/*,
    @Nivel			varchar(20),*/
    --REQ 15448
    @MovClaveOrigen         varchar(20),
    @SubMovClaveOrigen      varchar(20),
	--Cambio Pedidos Móvil INICIO
	@SituacionPorOmision	varchar(30),
    @SituacionFecha			datetime,
	--Cambio Pedidos Móvil
	--Monedero 
	@Redime					bit,
	@AplicaMonedero			varchar(20)


  EXEC spExtraerFecha @FechaEmision OUTPUT

  SELECT @CfgTipoCambio = TipoCambio FROM EmpresaCfgModulo WHERE Empresa = @Empresa AND Modulo = @Modulo
  IF @CfgTipoCambio = 'Venta'  SELECT @TipoCambio = TipoCambioVenta  FROM Mon WHERE Moneda = @Moneda ELSE
  IF @CfgTipoCambio = 'Compra' SELECT @TipoCambio = TipoCambioCompra FROM Mon WHERE Moneda = @Moneda 

  SELECT @UsarSucursalMovOrigen = UsarSucursalMovOrigen,
         @AC = AC
    FROM EmpresaGral 
   WHERE Empresa = @Empresa

  IF @UsarSucursalMovOrigen = 0
    SELECT @Sucursal = Sucursal FROM UsuarioSucursal WHERE Usuario = @Usuario

  IF @Mov IS NOT NULL AND @MovID IS NOT NULL
  BEGIN
/*    SELECT @Nivel = 'HIJO'
    SELECT @Nivel = ISNULL(UPPER(NULLIF(RTRIM(Nivel), '')), 'HIJO')
      FROM CfgMovFlujo
     WHERE Modulo = @Modulo AND OMov = @Mov AND DMov = @GenerarMov
*/
    SELECT @OrigenTipo = @Modulo, @Origen = @Mov, @OrigenID = @MovID
    SELECT @MovClaveOrigen = Clave , @SubMovClaveOrigen = SubClave FROM MovTipo WHERE Mov = @Origen AND Modulo = @OrigenTipo
    
/*    IF @Nivel = 'DIRECTO' 
      SELECT @OrigenTipo = NULL, @Origen = NULL, @OrigenID = NULL 
    ELSE 
    IF @Nivel IN ('HERMANO', 'PADRE', 'ABUELO')
    BEGIN
      EXEC spMovInfo @ID, @Modulo, @OrigenTipo = @OrigenTipo OUTPUT, @Origen = @Origen OUTPUT, @OrigenID = @OrigenID OUTPUT
      IF @Nivel IN ('PADRE', 'ABUELO') AND @OrigenID IS NOT NULL
      BEGIN
        EXEC spMovInfo NULL, @Modulo, @Origen, @OrigenID, @Empresa = @Empresa, @OrigenTipo = @OrigenTipo OUTPUT, @Origen = @Origen OUTPUT, @OrigenID = @OrigenID OUTPUT
        IF @Nivel = 'ABUELO' AND @OrigenID IS NOT NULL
          EXEC spMovInfo NULL, @Modulo, @Origen, @OrigenID, @Empresa = @Empresa, @OrigenTipo = @OrigenTipo OUTPUT, @Origen = @Origen OUTPUT, @OrigenID = @OrigenID OUTPUT
      END
    END*/
  END

  IF @Modulo = 'CONT'
    INSERT Cont (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,        FechaEmision,   FechaContable, Concepto, Proyecto, UEN, Intercompania, Moneda,  TipoCambio,  Referencia, Observaciones, AfectarPresupuesto, Importe) -- BUG15627
          SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, @FechaEmision, Concepto, Proyecto, UEN, Intercompania, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, AfectarPresupuesto, Importe -- BUG15627
            FROM Cont WHERE ID = @ID ELSE
  IF @Modulo = 'VTAS'
    INSERT Venta (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Directo,         Almacen,  AlmacenDestino,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Prioridad, Codigo, Cliente, EnviarA, Agente, AgenteServicio, FormaEnvio, FechaRequerida, HoraRequerida, FechaOriginal, FechaOrdenCompra, ReferenciaOrdenCompra, OrdenCompra, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, ServicioTipo, ServicioArticulo, ServicioSerie, ServicioContrato, ServicioContratoID, ServicioContratoTipo, ServicioGarantia, ServicioDescripcion, ServicioFlotilla, ServicioRampa, ServicioIdentificador, ServicioFecha, ServicioPlacas, ServicioKms, ServicioSiniestro, Atencion, Departamento, ZonaImpuesto, ListaPreciosEsp, GenerarOP, DesglosarImpuestos, DesglosarImpuesto2, ExcluirPlaneacion, ConVigencia, VigenciaDesde, VigenciaHasta, Bonificacion, Causa, Periodicidad, SubModulo, ContUso, Espacio, AutoCorrida, AutoCorridaHora, AutoCorridaServicio, AutoCorridaRol, AutoCorridaOrigen, AutoCorridaDestino, AutoCorridaKms, AutoCorridaLts, AutoCorridaRuta, AutoBoleto, AutoKms, AutoKmsActuales, AutoBomba, AutoBombaContador, GastoAcreedor, GastoConcepto, Comentarios, ServicioTipoOrden, ServicioTipoOperacion, ServicioExpress, ServicioDemerito, ServicioDeducible, ServicioDeducibleImporte, ServicioNumero, ServicioNumeroEconomico, ServicioAseguradora, SucursalVenta, RenglonID, AF, AFArticulo, AFSerie, ContratoTipo, ContratoDescripcion, ContratoSerie, ContratoValor, ContratoValorMoneda, ContratoSeguro, ContratoVencimiento, ContratoResponsable, Clase, SubClase, EndosarA, LineaCredito, TipoAmortizacion, TipoTasa, TieneTasaEsp, TasaEsp, Comisiones, ComisionesIVA, AgenteComision, ServicioPoliza, FormaPagoTipo, SobrePrecio, ContUso2, ContUso3, ContratoID, ContratoMov, ContratoMovID,AnticipoFacturadoTipoServicio, PosicionWMS, Importe, Impuestos , PedidoReferencia, PedidoReferenciaID, CrossDocking, FolioCRM)--ANTICIPOFACTURADO --REQ12615 WMS -- BUG15627 --REQ 15448 POS
           SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, @GenerarDirecto, @Almacen, @AlmacenDestino, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, Prioridad, Codigo, Cliente, EnviarA, Agente, AgenteServicio, FormaEnvio, FechaRequerida, HoraRequerida, FechaOriginal, FechaOrdenCompra, ReferenciaOrdenCompra, OrdenCompra, Condicion, Vencimiento, CtaDinero, Descuento, DescuentoGlobal, ServicioTipo, ServicioArticulo, ServicioSerie, ServicioContrato, ServicioContratoID, ServicioContratoTipo, ServicioGarantia, ServicioDescripcion, ServicioFlotilla, ServicioRampa, ServicioIdentificador, ServicioFecha, ServicioPlacas, ServicioKms, ServicioSiniestro, Atencion, Departamento, ZonaImpuesto, ListaPreciosEsp, GenerarOP, DesglosarImpuestos, DesglosarImpuesto2, ExcluirPlaneacion, ConVigencia, VigenciaDesde, VigenciaHasta, Bonificacion, Causa, Periodicidad, SubModulo, ContUso, Espacio, AutoCorrida, AutoCorridaHora, AutoCorridaServicio, AutoCorridaRol, AutoCorridaOrigen, AutoCorridaDestino, AutoCorridaKms, AutoCorridaLts, AutoCorridaRuta, AutoBoleto, AutoKms, AutoKmsActuales, AutoBomba, AutoBombaContador, GastoAcreedor, GastoConcepto, Comentarios, ServicioTipoOrden, ServicioTipoOperacion, ServicioExpress, ServicioDemerito, ServicioDeducible, ServicioDeducibleImporte, ServicioNumero, ServicioNumeroEconomico, ServicioAseguradora, SucursalVenta, RenglonID, AF, AFArticulo, AFSerie, ContratoTipo, ContratoDescripcion, ContratoSerie, ContratoValor, ContratoValorMoneda, ContratoSeguro, ContratoVencimiento, ContratoResponsable, Clase, SubClase, EndosarA, LineaCredito, TipoAmortizacion, TipoTasa, TieneTasaEsp, TasaEsp, Comisiones, ComisionesIVA, AgenteComision, ServicioPoliza, FormaPagoTipo, SobrePrecio, ContUso2, ContUso3, ContratoID, ContratoMov, ContratoMovID, AnticipoFacturadoTipoServicio, PosicionWMS, Importe, Impuestos, CASE WHEN @MovClaveOrigen = 'VTAS.P' AND @SubMovClaveOrigen = 'VTAS.PEDANT' THEN LTRIM(RTRIM(@Origen))+' '+LTRIM(RTRIM(@OrigenID)) ELSE NULL END, CASE WHEN @MovClaveOrigen = 'VTAS.P' AND @SubMovClaveOrigen = 'VTAS.PEDANT' THEN @ID ELSE NULL END, CrossDocking, FolioCRM --ANTICIPOFACTURADO --REQ12615 WMS -- BUG15627
             FROM Venta WHERE ID = @ID ELSE
  IF @Modulo = 'PROD'
    INSERT Prod (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,          FechaEmision,  Directo,         Almacen,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Prioridad, AutoReservar, VerDestino, FechaInicio, FechaEntrega, RenglonID, Importe, CrossDocking) -- BUG15627
           SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, @GenerarDirecto, @Almacen, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, Prioridad, AutoReservar, VerDestino, FechaInicio, FechaEntrega, RenglonID, Importe, CrossDocking -- BUG15627
             FROM Prod WHERE ID = @ID ELSE
  IF @Modulo = 'COMS'
    INSERT Compra (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Directo,         Almacen,  Concepto, Proyecto, Actividad, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Prioridad, Proveedor, FormaEnvio, FechaEntrega, FechaRequerida, Condicion, Vencimiento, Instruccion, Agente, Descuento, DescuentoGlobal, Atencion, ZonaImpuesto, Idioma, ListaPreciosEsp, RenglonID, FormaEntrega, CancelarPendiente, LineaCredito, TipoAmortizacion, TipoTasa, TieneTasaEsp, TasaEsp, Comisiones, ComisionesIVA, AutoCargos, Cliente, ContUso, ContUso2, ContUso3, ContratoID, ContratoMov, ContratoMovID, PosicionWMS, Importe, Impuestos, CrossDocking) --REQ12615 WMS -- BUG15627
            SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, @GenerarDirecto, @Almacen, Concepto, Proyecto, Actividad, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, Prioridad, Proveedor, FormaEnvio, FechaEntrega, FechaRequerida, Condicion, Vencimiento, Instruccion, Agente, Descuento, DescuentoGlobal, Atencion, ZonaImpuesto, Idioma, ListaPreciosEsp, RenglonID, FormaEntrega, CancelarPendiente, LineaCredito, TipoAmortizacion, TipoTasa, TieneTasaEsp, TasaEsp, Comisiones, ComisionesIVA, AutoCargos, Cliente, ContUso, ContUso2, ContUso3, ContratoID, ContratoMov, ContratoMovID, PosicionWMS, Importe, Impuestos, CrossDocking --REQ12615 WMS -- BUG15627
              FROM Compra WHERE ID = @ID ELSE
  IF @Modulo = 'INV'
    INSERT Inv (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Directo,         Almacen,  AlmacenDestino,  Concepto, Proyecto, Actividad, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, AlmacenTransito, Largo, Condicion, Vencimiento, FormaEnvio, VerLote, VerDestino, RenglonID, Agente, PosicionWMS, PosicionDWMS, Importe,  ReferenciaMES, PedidoMES, CrossDocking) --REQ12615 WMS -- BUG15627
         SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, @GenerarDirecto, @Almacen, @AlmacenDestino, Concepto, Proyecto, Actividad, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, AlmacenTransito, Largo, Condicion, Vencimiento, FormaEnvio, VerLote, VerDestino, RenglonID, Agente, PosicionWMS, PosicionDWMS, Importe , ReferenciaMES, PedidoMES, CrossDocking --REQ12615 WMS -- BUG15627
          FROM Inv WHERE ID = @ID ELSE
  IF @Modulo = 'DIN'
    INSERT Dinero (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Directo,         Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, BeneficiarioNombre, LeyendaCheque, Beneficiario,  CtaDinero, CtaDineroDestino, ConDesglose, Importe, Comisiones, Impuestos, FormaPago, FechaProgramada, Cajero, Contacto, ContactoTipo, TipoCambioDestino, ProveedorAutoEndoso, CargoBancario, CargoBancarioIVA, Prioridad, Comentarios, Nota, FechaOrigen, Vencimiento, Tasa, TasaDias, TasaRetencion, Retencion, ContUso, Cliente, ClienteEnviarA, Proveedor, InteresTipo, Titulo, TituloValor, ValorOrigen, ContUso2, ContUso3) --MEJORA4752
            SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN d.SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, @GenerarDirecto, d.Concepto, d.Proyecto, d.UEN, @Moneda, ISNULL(@TipoCambio, d.TipoCambio), d.Referencia, d.Observaciones, d.BeneficiarioNombre, d.LeyendaCheque, d.Beneficiario,  d.CtaDinero, d.CtaDineroDestino, d.ConDesglose, d.Importe, d.Comisiones, d.Impuestos, d.FormaPago, d.FechaProgramada, d.Cajero, d.Contacto, d.ContactoTipo, d.TipoCambioDestino, d.ProveedorAutoEndoso, d.CargoBancario, d.CargoBancarioIVA, d.Prioridad, d.Comentarios, d.Nota, d.FechaOrigen, d.Vencimiento, d.Tasa, d.TasaDias, d.TasaRetencion, d.Retencion, d.ContUso, d.Cliente, d.ClienteEnviarA, d.Proveedor, d.InteresTipo, d.Titulo, t.Valor, d.ValorOrigen, d.ContUso2, d.ContUso3 --MEJORA4752
              FROM Dinero d 
              LEFT OUTER JOIN Titulo t ON t.Titulo = d.Titulo
             WHERE d.ID = @ID ELSE
  IF @Modulo = 'CXC'
    INSERT Cxc (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Codigo, Cliente, ClienteEnviarA, ClienteMoneda, ClienteTipoCambio, CtaDinero, Cobrador, PersonalCobrador, /*Condicion, Vencimiento, */FormaCobro, Importe, Impuestos, AplicaManual, Agente,MovAplica, MovAplicaID, ConDesglose, FormaCobro1, FormaCobro2, FormaCobro3, FormaCobro4, FormaCobro5, Importe1, Importe2, Importe3, Importe4, Importe5, Referencia1, Referencia2, Referencia3, Referencia4, Referencia5, Cambio, DelEfectivo, Cajero, FechaOriginal, Comentarios, Nota, VIN, ContUso, SubModulo, ContratoID, ContratoMov, ContratoMovID, Retencion, Retencion2, Retencion3, ContUso2, ContUso3) --MEJORA4648 --MEJORA4752
         SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, CASE WHEN OrigenTipo = 'CAM' THEN Cxc.TipoCambio ELSE ISNULL(@TipoCambio, Cxc.TipoCambio) END, Referencia, Observaciones, Codigo, Cliente, ClienteEnviarA, ClienteMoneda, CASE WHEN OrigenTipo = 'CAM' THEN ClienteTipoCambio ELSE CASE @CfgTipoCambio WHEN 'Venta' THEN ms.TipoCambioVenta WHEN 'Compra' THEN ms.TipoCambioCompra ELSE ms.TipoCambio END END, CtaDinero, Cobrador, PersonalCobrador, /*Condicion, Vencimiento, */FormaCobro, Importe, Impuestos, AplicaManual, Agente, MovAplica, MovAplicaID, ConDesglose, FormaCobro1, FormaCobro2, FormaCobro3, FormaCobro4, FormaCobro5, Importe1, Importe2, Importe3, Importe4, Importe5, Referencia1, Referencia2, Referencia3, Referencia4, Referencia5, Cambio, DelEfectivo, Cajero, FechaOriginal, Comentarios, Nota, VIN, ContUso, SubModulo, ContratoID, ContratoMov, ContratoMovID, Retencion, Retencion2, Retencion3, ContUso2, ContUso3 --MEJORA4648 --MEJORA4752
          FROM Cxc, Mon ms
         WHERE ms.Moneda = ClienteMoneda 
           AND ID = @ID ELSE
  IF @Modulo = 'CXP'
    INSERT Cxp (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Proveedor, ProveedorSucursal, ProveedorMoneda, ProveedorTipoCambio, CtaDinero, Condicion,/* Vencimiento, */FormaPago, Importe, Impuestos, AplicaManual, Beneficiario, MovAplica, MovAplicaID, Cajero, ProveedorAutoEndoso, Comentarios, Nota, VIN, ContUso, ContratoID, ContratoMov, ContratoMovID, ContUso2, ContUso3, EmidaCarrierID) --MEJORA4752 REQ12336 --Se descomenta el campo 'condicion ' bug 18323
         SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, CASE WHEN OrigenTipo = 'CAM' THEN Cxp.TipoCambio ELSE ISNULL(@TipoCambio, Cxp.TipoCambio) END, Referencia, Observaciones, Proveedor, ProveedorSucursal, ProveedorMoneda, CASE WHEN OrigenTipo = 'CAM' THEN ProveedorTipoCambio ELSE CASE @CfgTipoCambio WHEN 'Venta' THEN ms.TipoCambioVenta WHEN 'Compra' THEN ms.TipoCambioCompra ELSE ms.TipoCambio END END, CtaDinero, Condicion,/* Vencimiento, */FormaPago, Importe, Impuestos, AplicaManual, Beneficiario, MovAplica, MovAplicaID, Cajero, ProveedorAutoEndoso, Comentarios, Nota, VIN, ContUso, ContratoID, ContratoMov, ContratoMovID, ContUso2, ContUso3, EmidaCarrierID --MEJORA4752 REQ12336 --Se descomenta el campo 'condicion ' bug 18323
          FROM Cxp, Mon ms
         WHERE ms.Moneda = ProveedorMoneda 
           AND ID = @ID ELSE
  IF @Modulo = 'AGENT'
    INSERT Agent (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Agente, CtaDinero, FormaPago, Importe, Impuestos) -- BUG15627
           SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, Agente, CtaDinero, FormaPago, Importe, Impuestos -- BUG15627
             FROM Agent WHERE ID = @ID ELSE
  IF @Modulo = 'GAS'
    INSERT Gasto (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Proyecto, UEN, Moneda,  TipoCambio,  Observaciones, Acreedor, Clase, SubClase, CtaDinero, FormaPago, Condicion, /*Vencimiento, */Importe, Impuestos, MovAplica, MovAplicaID, Periodicidad, TieneRetencion, CXP, FechaRequerida, Actividad, AF, AFArticulo, AFSerie, ConVigencia, VigenciaDesde, VigenciaHasta, ContratoTipo, ContratoDescripcion, ContratoSerie, ContratoValor, ContratoValorMoneda, ContratoSeguro, ContratoVencimiento, ContratoResponsable, Prioridad, AnexoModulo, AnexoID, Comentarios, Nota, ClienteRef, ArticuloRef, ContUso, ContUso2, ContUso3, ContratoID, ContratoMov, ContratoMovID)
           SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Observaciones, Acreedor, Clase, SubClase, CtaDinero, FormaPago, Condicion, /*Vencimiento, */Importe, Impuestos, MovAplica, MovAplicaID, Periodicidad, TieneRetencion, CXP, FechaRequerida, Actividad, AF, AFArticulo, AFSerie, ConVigencia, VigenciaDesde, VigenciaHasta, ContratoTipo, ContratoDescripcion, ContratoSerie, ContratoValor, ContratoValorMoneda, ContratoSeguro, ContratoVencimiento, ContratoResponsable, Prioridad, AnexoModulo, AnexoID, Comentarios, Nota, ClienteRef, ArticuloRef, ContUso, ContUso2, ContUso3, ContratoID, ContratoMov, ContratoMovID
             FROM Gasto WHERE ID = @ID ELSE
  IF @Modulo = 'EMB'
    INSERT Embarque (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Referencia, Observaciones, Vehiculo, Ruta, Agente, FechaSalida, FechaRetorno, CtaDinero, Proveedor, Importe, Impuestos, Condicion, Vencimiento, PersonalCobrador/*, AlmacenD, AlmacenA*/)
              SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, Referencia, Observaciones, Vehiculo, Ruta, Agente, FechaSalida, FechaRetorno, CtaDinero, Proveedor, Importe, Impuestos, Condicion, Vencimiento, PersonalCobrador/*, AlmacenD, AlmacenA*/
                FROM Embarque WHERE ID = @ID ELSE
  IF @Modulo = 'NOM'
    INSERT Nomina (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Observaciones, Condicion, PeriodoTipo, FechaD, FechaA, FechaOrigen)
            SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Observaciones, Condicion, PeriodoTipo, FechaD, FechaA, FechaOrigen
              FROM Nomina WHERE ID = @ID ELSE
  IF @Modulo = 'RH'
    INSERT RH (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Evaluacion)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, Evaluacion
          FROM RH WHERE ID = @ID ELSE
  IF @Modulo = 'ASIS'
    INSERT Asiste (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Localidad, FechaD, FechaA)
            SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, Localidad, FechaD, FechaA
              FROM Asiste WHERE ID = @ID ELSE
  IF @Modulo = 'AF'
    -- 9036
    INSERT ActivoFijo (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Proveedor, Condicion, Vencimiento,Importe, Impuestos, FormaPago, CtaDinero, Todo, Revaluar, ValorMercado, Personal, Espacio, ContUso, ContUso2, ContUso3)
                SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, Proveedor, Condicion, Vencimiento,Importe, Impuestos, FormaPago, CtaDinero, Todo, Revaluar, ValorMercado, Personal, Espacio, ContUso, ContUso2, ContUso3
                  FROM ActivoFijo WHERE ID = @ID ELSE
  IF @Modulo = 'PC'
    INSERT PC (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, ListaModificar, Recalcular, Parcial, Proveedor, Metodo, Monto)
                SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, ListaModificar, Recalcular, Parcial, Proveedor, Metodo, Monto
                  FROM PC WHERE ID = @ID ELSE
  IF @Modulo = 'OFER'
    INSERT Oferta (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, FechaD, FechaA, HoraD, HoraA, DiasEsp, Tipo, Forma, Usar, TieneVolumen, MontoMinimo, TodasSucursales, Categoria, Grupo, Familia, Linea, Fabricante, Porcentaje, Obsequio, CantidadObsequio, SubCuentaObsequio, UnidadObsequio, GrupoTipo, Prioridad, PrioridadG, CategoriaD, GrupoD, FamiliaD, LineaD, FabricanteD, ProveedorD, ABC, FormaPago, Articulo, ListaPreciosEsp, Unidad)
                SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, FechaD, FechaA, HoraD, HoraA, DiasEsp, Tipo, Forma, Usar, TieneVolumen, MontoMinimo, TodasSucursales, Categoria, Grupo, Familia, Linea, Fabricante, Porcentaje, Obsequio, CantidadObsequio, SubCuentaObsequio, UnidadObsequio, GrupoTipo, Prioridad, PrioridadG, CategoriaD, GrupoD, FamiliaD, LineaD, FabricanteD, ProveedorD, ABC, FormaPago, Articulo, ListaPreciosEsp, Unidad
                  FROM Oferta WHERE ID = @ID ELSE
  IF @Modulo = 'VALE'
    INSERT Vale (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Cliente, Agente, Condicion, Vencimiento, Tipo, Precio, Cantidad, Importe, FechaInicio, Descuento, DescuentoGlobal, CtaDinero)
                  SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, Cliente, Agente, Condicion, Vencimiento, Tipo, Precio, Cantidad, Importe, GETDATE(), Descuento, DescuentoGlobal, CtaDinero
                    FROM Vale WHERE ID = @ID ELSE
  IF @Modulo = 'CR'
    INSERT CR (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Caja, Cajero, FechaD, FechaA)
                SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, Caja, Cajero, FechaD, FechaA
                  FROM CR WHERE ID = @ID ELSE
  IF @Modulo = 'ST'
    INSERT Soporte (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Referencia, Observaciones, Cliente, EnviarA, Agente, Contacto, Telefono, Extencion, Fax, eMail, UsuarioResponsable, TieneContrato, Prioridad, Clase, Subclase, Titulo, Problema, Solucion, Comentarios, Proveedor, Personal, Vencimiento, ReferenciaInicial, CondicionPago, Importe, Estado, CondicionEntrega, FechaInicio, FechaTermino, Version, Tiempo, TiempoUnidad, SubModulo, Espacio, VIN, ServicioTipo, FechaRequerida, Direccion, DireccionNumero, EntreCalles, Plano, Delegacion, Colonia, Poblacion, PaisEstado, Pais, Zona, CodigoPostal, Reporte, Articulo, Causa, Clase1, Clase2, Clase3, Clase4, Clase5)
             SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, Referencia, Observaciones, Cliente, EnviarA, Agente, Contacto, Telefono, Extencion, Fax, eMail, UsuarioResponsable, TieneContrato, Prioridad, Clase, Subclase, Titulo, Problema, Solucion, Comentarios, Proveedor, Personal, @FechaEmision, ReferenciaInicial, CondicionPago, Importe, 'No comenzado', CondicionEntrega, FechaInicio, FechaTermino, Version, Tiempo, TiempoUnidad, SubModulo, Espacio, VIN, ServicioTipo, FechaRequerida, Direccion, DireccionNumero, EntreCalles, Plano, Delegacion, Colonia, Poblacion, PaisEstado, Pais, Zona, CodigoPostal, Reporte, Articulo, Causa, Clase1, Clase2, Clase3, Clase4, Clase5
               FROM Soporte WHERE ID = @ID ELSE
  IF @Modulo = 'CAP'
    INSERT Capital (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Agente)
            SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, Agente
              FROM Capital WHERE ID = @ID 
  IF @Modulo = 'INC'
    INSERT Incidencia (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, FechaAplicacion, Personal, NominaConcepto, FechaD, FechaA, Cantidad, Valor, Porcentaje, Acreedor, Vencimiento, Repetir, Prorratear, Frecuencia, Veces)
            SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, FechaAplicacion, Personal, NominaConcepto, FechaD, FechaA, Cantidad, Valor, Porcentaje, Acreedor, Vencimiento, Repetir, Prorratear, Frecuencia, Veces
              FROM Incidencia WHERE ID = @ID 
  IF @Modulo = 'CONC'
    INSERT Conciliacion (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, CtaDinero, FechaD, FechaA)
            SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, CtaDinero, FechaD, FechaA
              FROM Conciliacion WHERE ID = @ID 
  IF @Modulo = 'PPTO'
    INSERT Presup (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones)
            SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones
              FROM Presup WHERE ID = @ID 
  IF @Modulo = 'CREDI'
    INSERT Credito (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Vencimiento, TipoAmortizacion, TipoTasa, Comisiones, ComisionesIVA, Deudor, Acreedor, Importe, CtaDinero, FormaPago, LineaCreditoEsp, LineaCredito, LineaCreditoFondeo, TieneTasaEsp, TasaEsp)
            SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, Vencimiento, TipoAmortizacion, TipoTasa, Comisiones, ComisionesIVA, Deudor, Acreedor, Importe, CtaDinero, FormaPago, LineaCreditoEsp, LineaCredito, LineaCreditoFondeo, TieneTasaEsp, TasaEsp
              FROM Credito WHERE ID = @ID 
  IF @Modulo = 'TMA'
    INSERT TMA (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Referencia, Observaciones, Almacen, Agente, Montacarga, TarimaSurtido, Prioridad) --REQ12615 WMS
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, Referencia, Observaciones, Almacen, Agente, Montacarga, TarimaSurtido, Prioridad --REQ12615 WMS
          FROM TMA WHERE ID = @ID 
  IF @Modulo = 'RSS'
    INSERT RSS (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Referencia, Observaciones, Canal, Titulo, Hipervinculo, Descripcion, Comentarios, Autor, Categoria, ArtOrigen, Adjunto, AdjuntoURL, AdjuntoTamano, AdjuntoTipo, FechaPublicacion)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, Referencia, Observaciones, Canal, Titulo, Hipervinculo, Descripcion, Comentarios, Autor, Categoria, ArtOrigen, Adjunto, AdjuntoURL, AdjuntoTamano, AdjuntoTipo, GETDATE()
          FROM RSS WHERE ID = @ID 
  IF @Modulo = 'CMP'
    INSERT Campana (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Referencia, Observaciones, Asunto, Agente, CampanaTipo, TieneVigencia, FechaD, FechaA)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, Referencia, Observaciones, Asunto, Agente, CampanaTipo, TieneVigencia, FechaD, FechaA
          FROM Campana WHERE ID = @ID 
  IF @Modulo = 'FIS'
    INSERT Fiscal (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Acreedor, Condicion, Vencimiento)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, Acreedor, Condicion, Vencimiento
          FROM Fiscal WHERE ID = @ID 
  --REQ25014
  IF @Modulo = 'CONTP'
    INSERT ContParalela (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Referencia, Observaciones, CuentaD, CuentaA, Nivel, GeneraEjercicio, GeneraPeriodo, GeneraFechaD, GeneraFechaA, GeneraEmpresaOrigen, GeneraMov, GeneraMovID, GeneraContMov, GeneraContMovID, GeneraContID)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, Referencia, Observaciones, CuentaD, CuentaA, Nivel, GeneraEjercicio, GeneraPeriodo, GeneraFechaD, GeneraFechaA, GeneraEmpresaOrigen, GeneraMov, GeneraMovID, GeneraContMov, GeneraContMovID, GeneraContID
          FROM ContParalela WHERE ID = @ID   
  --REQ16092
  IF @Modulo = 'OPORT'
    INSERT Oportunidad (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario, Estatus,   Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Moneda,  TipoCambio,  Referencia, Observaciones, Agente, NivelInteres, Plantilla, ContactoTipo, Comentarios, Competidor, Intermediario, Contacto, Almacen, ListaPreciosEsp, ServicioTipo, ServicioContratoTipo)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, @Moneda, ISNULL(@TipoCambio, TipoCambio), Referencia, Observaciones, Agente, NivelInteres, Plantilla, ContactoTipo, Comentarios, Competidor, Intermediario, Contacto, Almacen, ListaPreciosEsp, ServicioTipo, ServicioContratoTipo
          FROM Oportunidad WHERE ID = @ID 		  
  IF @Modulo = 'CORTE'
  BEGIN
    INSERT Corte (Empresa, Mov, FechaEmision, UltimoCambio, Concepto, Proyecto, UEN, Usuario, Referencia, Observaciones, Estatus, OrigenTipo, Origen, OrigenID, FechaRegistro, FechaConclusion, FechaCancelacion, Sucursal, SucursalOrigen, SucursalDestino, CorteCuentaTipo, CorteGrupoDe, CorteGrupoA, CorteSubGrupoDe, CorteSubGrupoA, CorteCuentaDe, CorteCuentaA, CorteSubCuentaDe, CorteSubCuenta2A, CorteSubCuenta2De, CorteSubCuenta3A, CorteSubCuenta3De, CorteSubCuentaA, CorteUENDe, CorteUENA, CorteProyectoDe, CorteProyectoA, CorteFechaD, CorteFechaA, Moneda, TipoCambio, CorteTitulo, CorteMensaje, CorteEstatus, CorteSucursalDe, CorteSucursalA, CorteFrecuencia, CorteGrupo, CorteTipo, CortePeriodo, CorteEjercicio, CorteOrigen, CorteValuacion, CorteDesglosar, CorteFiltrarFechas, DiaMes, Frecuencia, Domingo, Lunes, Martes, Miercoles, Jueves, Viernes, Sabado, VigenciaD, VigenciaA, CorteMoneda, CorteNoPeriodos, CorteTipoPeriodo)
        SELECT Empresa, @GenerarMov, @FechaEmision, GETDATE(), Concepto, Proyecto, UEN, Usuario, Referencia, Observaciones, @Estatus, @OrigenTipo, @Origen, @OrigenID, NULL, NULL, NULL, @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, CorteCuentaTipo, CorteGrupoDe, CorteGrupoA, CorteSubGrupoDe, CorteSubGrupoA, CorteCuentaDe, CorteCuentaA, CorteSubCuentaDe, CorteSubCuenta2A, CorteSubCuenta2De, CorteSubCuenta3A, CorteSubCuenta3De, CorteSubCuentaA, CorteUENDe, CorteUENA, CorteProyectoDe, CorteProyectoA, CorteFechaD, CorteFechaA, Moneda, TipoCambio, CorteTitulo, CorteMensaje, CorteEstatus, CorteSucursalDe, CorteSucursalA, CorteFrecuencia, CorteGrupo, CorteTipo, CortePeriodo, CorteEjercicio, CorteOrigen, CorteValuacion, CorteDesglosar, CorteFiltrarFechas, DiaMes, Frecuencia, Domingo, Lunes, Martes, Miercoles, Jueves, Viernes, Sabado, VigenciaD, VigenciaA, CorteMoneda, CorteNoPeriodos, CorteTipoPeriodo
          FROM Corte WHERE ID = @ID
  END
  IF @Modulo = 'FRM'
    INSERT FormaExtra (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Referencia, Observaciones, FormaTipo, Aplica, AplicaClave)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, Referencia, Observaciones, FormaTipo, Aplica, AplicaClave
          FROM FormaExtra WHERE ID = @ID 
  IF @Modulo = 'CAPT'
    INSERT Captura (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Referencia, Observaciones, Catalogo, Clave)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, Referencia, Observaciones, Catalogo, Clave
          FROM Captura WHERE ID = @ID 
  IF @Modulo = 'GES'
    --REQ16092
    INSERT Gestion (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Referencia, Observaciones, Asunto, Motivo, Espacio, Comentarios, FechaD, FechaA, HoraD, HoraA, TodoElDia, Duracion, Estado, Avance, Prioridad, AFArticulo, AFSerie, OPORTID)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, Referencia, Observaciones, Asunto, Motivo, Espacio, Comentarios, FechaD, FechaA, HoraD, HoraA, TodoElDia, Duracion, Estado, Avance, Prioridad, AFArticulo, AFSerie, OPORTID
          FROM Gestion WHERE ID = @ID 
  IF @Modulo = 'PROY'
    INSERT Proyecto (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Moneda, TipoCambio, ContactoTipo, Prospecto, Cliente, Proveedor, Personal, Agente, Riesgo, ProyectoRama, Supervisor, Comienzo, Fin, DiasHabiles, HorasDia, MontoEstimado, ProyectoReestructurar, /*Proyecto, */Reestructurar, Comentarios)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, @Moneda, ISNULL(@TipoCambio, TipoCambio), ContactoTipo, Prospecto, Cliente, Proveedor, Personal, Agente, Riesgo, ProyectoRama, Supervisor, Comienzo, Fin, DiasHabiles, HorasDia, MontoEstimado, ProyectoReestructurar, /*Proyecto, */0, Comentarios
          FROM Proyecto 
         WHERE ID = @ID 
/*  IF @Modulo = 'ACT'
    INSERT Act (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Actividad)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, Actividad
          FROM Act WHERE ID = @ID */
/*  IF @Modulo = 'MEX01'
    INSERT ModuloExtra01 (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Moneda,  TipoCambio)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, @Moneda, ISNULL(@TipoCambio, TipoCambio)
          FROM ModuloExtra01 WHERE ID = @ID */
/*  IF @Modulo = 'MEX02'
    INSERT ModuloExtra02 (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Moneda,  TipoCambio)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, @Moneda, ISNULL(@TipoCambio, TipoCambio)
          FROM ModuloExtra02 WHERE ID = @ID */
/*  IF @Modulo = 'MEX03'
    INSERT ModuloExtra03 (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Moneda,  TipoCambio)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, @Moneda, ISNULL(@TipoCambio, TipoCambio)
          FROM ModuloExtra03 WHERE ID = @ID */
/*  IF @Modulo = 'MEX04'
    INSERT ModuloExtra04 (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Moneda,  TipoCambio)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, @Moneda, ISNULL(@TipoCambio, TipoCambio)
          FROM ModuloExtra04 WHERE ID = @ID */
/*  IF @Modulo = 'MEX05'
    INSERT ModuloExtra05 (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Moneda,  TipoCambio)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, @Moneda, ISNULL(@TipoCambio, TipoCambio)
          FROM ModuloExtra05 WHERE ID = @ID */
/*  IF @Modulo = 'MEX06'
    INSERT ModuloExtra06 (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Moneda,  TipoCambio)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, @Moneda, ISNULL(@TipoCambio, TipoCambio)
          FROM ModuloExtra06 WHERE ID = @ID */
/*  IF @Modulo = 'MEX07'
    INSERT ModuloExtra07 (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Moneda,  TipoCambio)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, @Moneda, ISNULL(@TipoCambio, TipoCambio)
          FROM ModuloExtra07 WHERE ID = @ID */
/*  IF @Modulo = 'MEX08'
    INSERT ModuloExtra08 (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Moneda,  TipoCambio)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, @Moneda, ISNULL(@TipoCambio, TipoCambio)
          FROM ModuloExtra08 WHERE ID = @ID */
/*  IF @Modulo = 'MEX09'
    INSERT ModuloExtra09 (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Moneda,  TipoCambio)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, @Moneda, ISNULL(@TipoCambio, TipoCambio)
          FROM ModuloExtra09 WHERE ID = @ID */
  IF @Modulo = 'ORG'
    INSERT Organiza (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Moneda,  TipoCambio)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, @Moneda, ISNULL(@TipoCambio, TipoCambio)
          FROM Organiza WHERE ID = @ID 
  IF @Modulo = 'RE'
    INSERT Recluta (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Moneda,  TipoCambio, Puesto, Personal, Prioridad, Comentarios, SueldoD, SueldoA, SueldoActual, SueldoMinimo, SueldoAspira)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, @Moneda, ISNULL(@TipoCambio, TipoCambio), Puesto, Personal, Prioridad, Comentarios, SueldoD, SueldoA, SueldoActual, SueldoMinimo, SueldoAspira
          FROM Recluta WHERE ID = @ID 
  IF @Modulo = 'ISL'
    INSERT ISL (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Moneda,  TipoCambio)
        SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, @Moneda, ISNULL(@TipoCambio, TipoCambio)
          FROM ISL WHERE ID = @ID 
  IF @Modulo = 'CAM'
    INSERT Cambio (UltimoCambio, Sucursal, SucursalOrigen, SucursalDestino, OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Referencia, Observaciones, Cliente, Agente, Condicion, Vencimiento)
            SELECT GETDATE(), @Sucursal, @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, Referencia, Observaciones, Cliente, Agente, Condicion, Vencimiento
              FROM Cambio WHERE ID = @ID 

  IF @Modulo = 'PACTO'
    INSERT Contrato (UltimoCambio, Sucursal,  SucursalOrigen, SucursalDestino, OrigenTipo, Origen,      OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Referencia, Observaciones, ContactoTipo, Prospecto, Cliente, Proveedor, Personal, Agente, Moneda, TipoCambio, Prioridad, Comentarios, Documento, Titulo, Importe) -- BUG15627
	     SELECT  GETDATE(),	   @Sucursal, @Sucursal,      CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END,@OrigenTipo,	@Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, Referencia, Observaciones, ContactoTipo, Prospecto, Cliente, Proveedor, Personal, Agente, Moneda, TipoCambio, Prioridad, Comentarios, Documento, Titulo, Importe -- BUG15627
               FROM Contrato WHERE ID = @ID 
  IF @Modulo = 'CP'
    INSERT CP (UltimoCambio, Sucursal,  SucursalOrigen, SucursalDestino, OrigenTipo, Origen,      OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Referencia, Observaciones, Agente, Moneda, TipoCambio, Comentarios)
	     SELECT  GETDATE(),	   @Sucursal, @Sucursal,      CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END,@OrigenTipo,	@Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, Referencia, Observaciones, Agente, Moneda, TipoCambio, Comentarios
               FROM CP WHERE ID = @ID 
  IF @Modulo = 'PCP'  
    INSERT PCP (UltimoCambio, Sucursal,  SucursalOrigen, SucursalDestino,                                                              OrigenTipo,  Origen,  OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, UEN, Referencia, Observaciones, Proyecto, Moneda,  TipoCambio,                      FechaInicio, FechaFin, Categoria, Tipo, ClavePresupuestalMascara, ProyectoDescripcion, CategoriaPredominante)
        SELECT  GETDATE(),    @Sucursal, @Sucursal,      CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen, @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, UEN, Referencia, Observaciones, Proyecto, @Moneda, ISNULL(@TipoCambio, TipoCambio), FechaInicio, FechaFin, Categoria, Tipo, ClavePresupuestalMascara, ProyectoDescripcion, CategoriaPredominante
          FROM PCP WHERE ID = @ID 

  IF @Modulo = 'SAUX'  
    INSERT SAUX (UltimoCambio, SucursalOrigen, SucursalDestino,                                                         OrigenTipo,  Origen,   OrigenID,  Empresa,  Usuario,  Estatus,  Mov,         MovID,         FechaEmision,  Concepto, Proyecto, UEN, Referencia, Observaciones, Contacto, EnviarA, FechaEntrega, Situacion, SituacionFecha, SituacionNota, SituacionUsuario, TipoContacto)
        SELECT   GETDATE(),    @Sucursal, CASE WHEN @CopiarSucursalDestino = 1 THEN SucursalDestino ELSE @Sucursal END, @OrigenTipo, @Origen,  @OrigenID, @Empresa, @Usuario, @Estatus, @GenerarMov, @GenerarMovID, @FechaEmision, Concepto, Proyecto, UEN, Referencia, Observaciones, Contacto, EnviarA, FechaEntrega, Situacion, SituacionFecha, SituacionNota, SituacionUsuario, TipoContacto
          FROM SAUX WHERE ID = @ID 

  -- Leer Identity
  SELECT @GenerarID = SCOPE_IDENTITY()

/*  IF @Modulo = 'CMP'
    INSERT CampanaRecurso (ID, Recurso, Sucursal, SucursalOrigen)
    SELECT @GenerarID, Recurso, @Sucursal, @Sucursal
      FROM CampanaRecurso
     WHERE ID = @ID*/

  IF @AC = 1
    EXEC spCopiarTablaAmortizacionGuia @Modulo, @ID, @Modulo, @GenerarID

  EXEC spMovCopiarFormaAnexo @Modulo, @ID, @Modulo, @GenerarID 
  EXEC spMovCopiarAnexos @Sucursal, @Modulo, @ID, @Modulo, @GenerarID, @CopiarBitacora
  
  BEGIN
	EXEC xpMovCopiarEncabezado @Sucursal, @Modulo, @ID, @Empresa, @Mov, @MovID, @Usuario, @FechaEmision, @Estatus, @Moneda, @TipoCambio, @Almacen, @AlmacenDestino, @GenerarDirecto, @GenerarMov, @GenerarMovID, @GenerarID, @Ok OUTPUT, @CopiarBitacora
	
	--Cambio Pedidos Móvil 
	IF @Modulo = 'CMP'
	BEGIN
		SELECT @SituacionPorOmision = dbo.fnCampanaSituacionPorOmision(@ID)
		SELECT @SituacionFecha = (DATEADD(ms, -DATEPART(ms, GETDATE()), DATEADD(ss, -DATEPART(ss, GETDATE()),  GETDATE())))
		UPDATE CampanaD SET FechaD = NULL, FechaA = NULL, SituacionFecha =  @SituacionFecha, Situacion = @SituacionPorOmision WHERE ID = @ID
	END
	--Cambio Pedidos Móvil FIN
  END
  --EXEC xpMovCopiarEncabezadoWMS @Modulo, @ID, @Modulo, @GenerarID --REQ12615 WMS

  IF EXISTS(SELECT * FROM EmpresaCfgModulo WHERE Empresa = @Empresa AND Modulo = @Modulo AND UPPER(Tiempos) = 'SI')
    INSERT MovTiempo (Modulo,  Sucursal,  ID,         Usuario,  FechaInicio, FechaComenzo, Estatus) 
               VALUES(@Modulo, @Sucursal, @GenerarID, @Usuario, GETDATE(),   GETDATE(),    @Estatus)
  
  --Integración MES
  IF (SELECT IntelMESInterfase FROM EmpresaCfg WHERE Empresa = @Empresa) = 1
  BEGIN

	  DECLARE
	  @MovTipo          varchar(20),
	  @Lanzamiento      varchar(100)
   
	  IF @Modulo = 'COMS'
	  BEGIN
		EXEC spMovInfo @ID, @Modulo, @MovTipo = @MovTipo OUTPUT
		IF @MovTipo = 'COMS.O'
		BEGIN
		  SELECT @Lanzamiento = MesLanzamiento FROM Compra WHERE ID = @ID
		  UPDATE Compra SET MesLanzamiento = @Lanzamiento WHERE ID = @GenerarID
		END
	  END
  END
  --Monedero
  IF @Modulo = 'VTAS'  
  BEGIN  
    
    SELECT @Redime = RedimePuntos , @AplicaMonedero = Monedero FROM Venta WHERE  ID = @ID
    
    IF @Redime IS NOT NULL
      UPDATE Venta SET RedimePuntos = @Redime WHERE ID = @GenerarID

	IF @AplicaMonedero IS NOT NULL
	  UPDATE Venta SET Monedero = @AplicaMonedero WHERE ID = @GenerarID
 
  END


END
GO

/**************** spMovCopiarFormaAnexo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovCopiarFormaAnexo') and type = 'P') drop procedure dbo.spMovCopiarFormaAnexo
GO             
CREATE PROCEDURE spMovCopiarFormaAnexo
		   @OModulo		char(5),
    		   @OID         	int,
		   @DModulo		char(5),
                   @DID			int
--//WITH ENCRYPTION
AS BEGIN
  INSERT MovFormaAnexo (Modulo, ID, Clave, Nombre, Tipo, Datos)
  SELECT @DModulo, @DID, Clave, Nombre, Tipo, Datos
    FROM MovFormaAnexo
   WHERE Modulo = @OModulo AND ID = @OID
END
GO

/************** spMovDesafectar *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovDesafectar') and sysstat & 0xf = 4) drop procedure dbo.spMovDesafectar
GO
CREATE PROCEDURE spMovDesafectar
                   @Modulo	char(5),
		   @ID		int,
		   @Ok		int		OUTPUT,
		   @OkRef	varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
     @FechaRegistro	datetime,
     @Sucursal		int,
     @Empresa		char(5),
     @Usuario		char(10),
     @Mov		char(20),
     @MovID		varchar(20),
     @ContID		int,
     @ContMov		char(20),
     @ContMovID		varchar(20)

  SELECT @FechaRegistro = GETDATE()
  SELECT @Sucursal = Sucursal, @Empresa = Empresa, @Mov = Mov, @MovID = MovID, @Usuario = Usuario FROM Mov WHERE Modulo = @Modulo AND ID = @ID
  -- Cancelar Polizas Relacionadas
  DECLARE crCancelarPolizas CURSOR FOR
   SELECT ID, Mov, MovID 
     FROM Cont
    WHERE Empresa = @Empresa AND OrigenTipo = @Modulo AND Origen = @Mov AND OrigenID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO')
    ORDER BY ID DESC

  OPEN crCancelarPolizas
  FETCH NEXT FROM crCancelarPolizas INTO @ContID, @ContMov, @ContMovID
  WHILE @@FETCH_STATUS <> -1 
  BEGIN
    EXEC spCont @ContID, 'CONT', 'CANCELAR', 'TODO', @FechaRegistro, NULL, @Usuario, 1, 0, @ContMov, @ContMovID, NULL, @Ok OUTPUT, @OkRef OUTPUT
    EXEC spMovFlujo @Sucursal, 'CANCELAR', @Empresa, @Modulo, @ID, @Mov, @MovID, 'CONT', @ContID, @ContMov, @ContMovID, @Ok OUTPUT

    FETCH NEXT FROM crCancelarPolizas INTO @ContID, @ContMov, @ContMovID
  END 
  CLOSE crCancelarPolizas
  DEALLOCATE crCancelarPolizas

  RETURN
END
GO

/************** spDesAfectarPresupuesto *************/
if exists (select * from sysobjects where id = object_id('dbo.spDesAfectarPresupuesto') and sysstat & 0xf = 4) drop procedure dbo.spDesAfectarPresupuesto
GO
CREATE PROCEDURE spDesAfectarPresupuesto
                   @Modulo	char(5),
		   @Mov		char(20),
		   @ID		int
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @MovTipo 	char(20),
    @Ok		int,
    @OkRef	varchar(255),
    @Mensaje	varchar(255)

  SELECT @MovTipo = Clave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov
  BEGIN TRANSACTION
    EXEC spMovDesafectar @Modulo, @ID, @Ok OUTPUT, @OkRef OUTPUT
    IF @Ok IS NULL 
    BEGIN
      IF @Modulo = 'VTAS' AND @MovTipo IN ('VTAS.PR', 'VTAS.FR')
      BEGIN 
        UPDATE Venta SET Estatus = NULL, FechaConclusion = NULL WHERE ID = @ID 
        UPDATE Venta SET Estatus = 'SINAFECTAR' WHERE ID = @ID 
      END
      IF @Modulo = 'COMS' AND @MovTipo = 'COMS.PR' 
      BEGIN 
        UPDATE Compra SET Estatus = NULL, FechaConclusion = NULL WHERE ID = @ID 
        UPDATE Compra  SET Estatus = 'SINAFECTAR' WHERE ID = @ID 
      END
      IF @Modulo = 'GAS' AND @MovTipo IN ('GAS.PR', 'GAS.DPR', 'GAS.GR')
      BEGIN 
        UPDATE Gasto SET Estatus = NULL, FechaConclusion = NULL WHERE ID = @ID 
        UPDATE Gasto SET Estatus = 'SINAFECTAR' WHERE ID = @ID 
      END
    END
  IF @@ERROR = 0 OR @Ok IS NULL
    COMMIT TRANSACTION
  ELSE BEGIN
    ROLLBACK TRANSACTION
    IF @Ok IS NOT NULL
    BEGIN
      SELECT @Mensaje = RTRIM(Descripcion) + ' ' + ISNULL(RTRIM(@OkRef), '') FROM MensajeLista WHERE Mensaje = @Ok
      RAISERROR (@Mensaje,16,-1) 
    END
  END
  RETURN
END
GO
  
-- spDesAfectarPresupuesto  'VTAS', 'Presupuesto', 5


/************** spDesAfectarRecaudacion *************/
if exists (select * from sysobjects where id = object_id('dbo.spDesAfectarRecaudacion') and sysstat & 0xf = 4) drop procedure dbo.spDesAfectarRecaudacion
GO
CREATE PROCEDURE spDesAfectarRecaudacion
		   @ID		int
--//WITH ENCRYPTION
AS BEGIN
  IF EXISTS(SELECT * FROM Venta WHERE ID = @ID AND Estatus = 'BORRADOR')
  BEGIN
    BEGIN TRANSACTION
      DELETE VentaD WHERE ID = @ID AND RenglonID IS NULL
      DELETE VentaCobro WHERE ID = @ID 
      UPDATE Venta SET Estatus = 'SINAFECTAR' WHERE ID = @ID
    IF @@ERROR = 0
      COMMIT TRANSACTION
    ELSE 
      ROLLBACK TRANSACTION
  END
  RETURN
END
GO

-- spDesAfectarRecaudacion 21134

/************** spDesAfectarPedido *************/
if exists (select * from sysobjects where id = object_id('dbo.spDesAfectarPedido') and sysstat & 0xf = 4) drop procedure dbo.spDesAfectarPedido
GO
CREATE PROCEDURE spDesAfectarPedido
		   	@ID		int,
		 	@Usuario	char(10)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Ok			int,
    @OkRef		varchar(255),
    @Mensaje		varchar(255),
    @FechaRegistro	datetime,
    @Empresa		char(5),
    @Cliente		char(10),
    @Mov		char(20),
    @MovID		varchar(20),
    @Moneda		char(10),
    @Sucursal		int,
    @InvID		int,
    @InvMov		char(20),
    @InvMovID		varchar(20)

  SELECT @FechaRegistro = GETDATE(), @Ok = NULL
  SELECT @Sucursal = Sucursal, @Empresa = Empresa, @Cliente = Cliente, @Mov = Mov, @MovID = MovID, @Moneda = Moneda FROM Venta WHERE ID = @ID
  IF EXISTS(SELECT * FROM Venta WHERE ID = @ID AND Estatus = 'PENDIENTE')
  BEGIN
    IF EXISTS(SELECT * FROM Anticipo WHERE Empresa = @Empresa AND Abono IS NOT NULL AND (Referencia = RTRIM(@Mov)+' '+RTRIM(@MovID) OR Referencia LIKE RTRIM(@Mov)+' '+RTRIM(@MovID)+'-%'))
--    IF EXISTS(SELECT * FROM Anticipo WHERE Empresa = @Empresa AND Modulo = 'VTAS' AND ModuloID = @ID AND Abono IS NOT NULL)
      SELECT @Ok = 60201, @OkRef = '(Control de Anticipos)'

    IF @Ok IS NULL
    BEGIN
      BEGIN TRANSACTION
        DECLARE crCancelarInv CURSOR FOR 
         SELECT ID, Mov, MovID
           FROM Inv
          WHERE Empresa = @Empresa AND OrigenTipo = 'VTAS' AND Origen = @Mov AND OrigenID = @MovID
        OPEN crCancelarInv
        FETCH NEXT FROM crCancelarInv INTO @InvID, @InvMov, @InvMovID
        WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
        BEGIN
          IF @@FETCH_STATUS <> -2 AND @Ok IS NULL
          BEGIN
            EXEC spInv @InvID, 'INV', 'CANCELAR', 'TODO', @FechaRegistro, NULL, @Usuario, 1, 0, NULL, 
                       @InvMov, @InvMovID OUTPUT, NULL, NULL, 
                       @Ok OUTPUT, @OkRef OUTPUT, NULL
  
            EXEC spMovFlujo @Sucursal, 'CANCELAR', @Empresa, 'VTAS', @ID, @Mov, @MovID, 'INV', @InvID, @InvMov, @InvMovID, @Ok OUTPUT
          END
          FETCH NEXT FROM crCancelarInv INTO @InvID, @InvMov, @InvMovID
        END
        CLOSE crCancelarInv
        DEALLOCATE crCancelarInv

        IF EXISTS(SELECT * FROM VentaD WHERE ID = @ID AND (ISNULL(CantidadPendiente, 0) + ISNULL(CantidadReservada, 0) + ISNULL(CantidadOrdenada, 0)) <> ISNULL(Cantidad, 0))
          SELECT @Ok = 60400
        IF EXISTS(SELECT * FROM VentaD WHERE ID = @ID AND NULLIF(CantidadReservada, 0) IS NOT NULL) AND @Ok IS NULL
          EXEC spInv @ID, 'VTAS', 'DESRESERVAR', 'RESERVADO', @FechaRegistro, NULL, @Usuario, 1, 0, NULL,
                     NULL, NULL, NULL, NULL,
                     @Ok OUTPUT, @OkRef OUTPUT, NULL
        IF EXISTS(SELECT * FROM VentaD WHERE ID = @ID AND NULLIF(CantidadOrdenada, 0) IS NOT NULL) AND @Ok IS NULL
          EXEC spInv @ID, 'VTAS', 'DESASIGNAR', 'ORDENADO', @FechaRegistro, NULL, @Usuario, 1, 0, NULL,
                     NULL, NULL, NULL, NULL,
                     @Ok OUTPUT, @OkRef OUTPUT, NULL

        IF EXISTS(SELECT * FROM VentaD WHERE ID = @ID AND ISNULL(CantidadPendiente, 0) <> ISNULL(Cantidad, 0))
          SELECT @Ok = 60400
    
        IF @Ok IS NULL
        BEGIN
          UPDATE VentaD SET Aplica = NULL, AplicaID = NULL WHERE ID = @ID AND (Aplica IS NOT NULL OR AplicaID IS NOT NULL)
          UPDATE Venta  SET Estatus = NULL WHERE ID = @ID
          UPDATE Venta  SET Estatus = 'SINAFECTAR', Directo = 1 WHERE ID = @ID
          UPDATE Anticipo SET Cargo = NULL, Abono = NULL, Cancelado = 1 WHERE Empresa = @Empresa AND Modulo = 'VTAS' AND ModuloID = @ID AND Cancelado = 0 
        END
     
      IF @Ok IS NULL
        COMMIT TRANSACTION
      ELSE
        ROLLBACK TRANSACTION
    END
    IF @Ok IS NOT NULL
    BEGIN
      SELECT @Mensaje = RTRIM(Descripcion) + ' ' + ISNULL(RTRIM(@OkRef), '') FROM MensajeLista WHERE Mensaje = @Ok
      RAISERROR (@Mensaje,16,-1) 
    END
  END
  RETURN
END
GO

/**************** spMovEliminarSinAfectar ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovEliminarSinAfectar') and type = 'P') drop procedure dbo.spMovEliminarSinAfectar
GO             
CREATE PROCEDURE spMovEliminarSinAfectar
                    @Modulo	char(5),
		    @ID		int

--//WITH ENCRYPTION
AS BEGIN
  BEGIN TRANSACTION

  IF @Modulo = 'CONT'  DELETE Cont         WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'VTAS'  DELETE Venta        WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'PROD'  DELETE Prod         WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'COMS'  DELETE Compra       WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'INV'   DELETE Inv          WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'CXC'   DELETE Cxc          WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'CXP'   DELETE Cxp          WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'AGENT' DELETE Agent        WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'GAS'   DELETE Gasto        WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'DIN'   DELETE Dinero       WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'EMB'   DELETE Embarque     WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'NOM'   DELETE Nomina       WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'RH'    DELETE RH           WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'ASIS'  DELETE Asiste       WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'AF'    DELETE ActivoFijo   WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'PC'    DELETE PC           WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'OFER'  DELETE Oferta       WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'VALE'  DELETE Vale         WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'CR'    DELETE CR           WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'ST'    DELETE Soporte      WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'CAP'   DELETE Capital      WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'INC'   DELETE Incidencia   WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'CONC'  DELETE Conciliacion WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'PPTO'  DELETE Presup       WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'CREDI' DELETE Credito	   WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'TMA'   DELETE TMA          WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'RSS'   DELETE RSS          WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'CMP'   DELETE Campana      WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'FIS'   DELETE Fiscal       WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  --REQ25014
  IF @Modulo = 'CONTP' DELETE ContParalela WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  --REQ16092
  IF @Modulo = 'OPORT' DELETE Oportunidad  WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE  
  IF @Modulo = 'CORTE' DELETE Corte        WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'FRM'   DELETE FormaExtra   WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'CAPT'  DELETE Captura      WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'GES'   DELETE Gestion      WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'CP'    DELETE CP           WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'PCP'   DELETE PCP          WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE  
  IF @Modulo = 'PROY'  DELETE Proyecto     WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  --IF @Modulo = 'ACT'   DELETE Act           WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  --IF @Modulo = 'MEX01' DELETE ModuloExtra01 WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  --IF @Modulo = 'MEX02' DELETE ModuloExtra02 WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  --IF @Modulo = 'MEX03' DELETE ModuloExtra03 WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  --IF @Modulo = 'MEX04' DELETE ModuloExtra04 WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  --IF @Modulo = 'MEX05' DELETE ModuloExtra05 WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  --IF @Modulo = 'MEX06' DELETE ModuloExtra06 WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  --IF @Modulo = 'MEX07' DELETE ModuloExtra07 WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  --IF @Modulo = 'MEX08' DELETE ModuloExtra08 WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  --IF @Modulo = 'MEX09' DELETE ModuloExtra09 WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'ORG'   DELETE Organiza     WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'RE'    DELETE Recluta      WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'ISL'   DELETE ISL          WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'CAM'   DELETE Cambio       WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'PACTO' DELETE Contrato     WHERE ID = @ID AND Estatus = 'SINAFECTAR' ELSE
  IF @Modulo = 'SAUX'  DELETE SAUX         WHERE ID = @ID AND Estatus = 'SINAFECTAR' 

  IF @@ROWCOUNT <> 0 
  BEGIN
    IF @Modulo = 'CONT'
    BEGIN
      DELETE ContD   WHERE ID = @ID 
      DELETE ContReg WHERE ID = @ID 
    END ELSE
    IF @Modulo = 'VTAS'  DELETE VentaD      WHERE ID = @ID ELSE
    IF @Modulo = 'PROD'  DELETE ProdD       WHERE ID = @ID ELSE
    IF @Modulo = 'COMS'  DELETE CompraD     WHERE ID = @ID ELSE
    IF @Modulo = 'INV'   DELETE InvD        WHERE ID = @ID ELSE
    IF @Modulo = 'CXC'   DELETE CxcD        WHERE ID = @ID ELSE
    IF @Modulo = 'CXP'   DELETE CxpD        WHERE ID = @ID ELSE
    IF @Modulo = 'AGENT' DELETE AgentD      WHERE ID = @ID ELSE
    IF @Modulo = 'GAS'   DELETE GastoD      WHERE ID = @ID ELSE
    IF @Modulo = 'DIN'   DELETE DineroD     WHERE ID = @ID ELSE
    IF @Modulo = 'EMB'   DELETE EmbarqueD   WHERE ID = @ID ELSE
    IF @Modulo = 'NOM'   DELETE NominaD     WHERE ID = @ID ELSE
    IF @Modulo = 'RH'    DELETE RHD         WHERE ID = @ID ELSE
    IF @Modulo = 'ASIS'  DELETE AsisteD     WHERE ID = @ID ELSE
    IF @Modulo = 'AF'    DELETE ActivoFijoD WHERE ID = @ID ELSE
    IF @Modulo = 'PC'    DELETE PCD         WHERE ID = @ID ELSE
    IF @Modulo = 'OFER'
    BEGIN
      DELETE OfertaFiltro WHERE ID = @ID 
      DELETE OfertaD      WHERE ID = @ID 
      DELETE OfertaDVol   WHERE ID = @ID 
    END ELSE
    IF @Modulo = 'VALE'  DELETE ValeD       WHERE ID = @ID ELSE
    IF @Modulo = 'CR'
    BEGIN
      DELETE CRVenta  WHERE ID = @ID 
      DELETE CRAgente WHERE ID = @ID 
      DELETE CRCobro  WHERE ID = @ID 
      DELETE CRCaja   WHERE ID = @ID 
    END ELSE
    IF @Modulo = 'ST'    DELETE SoporteD      WHERE ID = @ID ELSE
    IF @Modulo = 'CAP'   DELETE CapitalD      WHERE ID = @ID ELSE
    IF @Modulo = 'INC'   DELETE IncidenciaD   WHERE ID = @ID ELSE
    IF @Modulo = 'CONC'  DELETE ConciliacionD WHERE ID = @ID ELSE
    IF @Modulo = 'PPTO'  DELETE PresupD       WHERE ID = @ID ELSE
--    IF @Modulo = 'CREDI'  DELETE CreditoD    WHERE ID = @ID ELSE
    IF @Modulo = 'TMA'   DELETE TMAD          WHERE ID = @ID ELSE
--    IF @Modulo = 'RSS'   DELETE RSSD          WHERE ID = @ID ELSE
    IF @Modulo = 'CMP'   DELETE CampanaD      WHERE ID = @ID ELSE
    IF @Modulo = 'FIS'   DELETE FiscalD       WHERE ID = @ID ELSE
    --REQ25014
    IF @Modulo = 'CONTP' DELETE ContParalelaD WHERE ID = @ID ELSE
    --REQ16092
	IF @Modulo = 'OPORT' DELETE OportunidadD          WHERE ID = @ID ELSE	
    IF @Modulo = 'CORTE' 
    BEGIN
      DELETE CorteD        WHERE ID = @ID
      DELETE CorteDReporte WHERE ID = @ID      
    END ELSE
    IF @Modulo = 'FRM'   DELETE FormaExtraD   WHERE ID = @ID ELSE
    IF @Modulo = 'CAPT'  DELETE CapturaD      WHERE ID = @ID ELSE
    IF @Modulo = 'GES'
    BEGIN
      DELETE GestionPara    WHERE ID = @ID 
      DELETE GestionRecurso WHERE ID = @ID 
    END ELSE
    IF @Modulo = 'CP'
    BEGIN
      DELETE CPD   WHERE ID = @ID 
      DELETE CPCal WHERE ID = @ID 
      DELETE CPEsp WHERE ID = @ID 
    END ELSE
    IF @Modulo = 'PCP'  
    BEGIN
      DELETE PCPD WHERE ID = @ID 
      DELETE PCPDRegla WHERE ID = @ID
    END ELSE    
/*    IF @Modulo = 'PROY'
    BEGIN
      DELETE ProyectoAct
        FROM Fase t
        JOIN ProyectoAct a ON a.FaseID = t.FaseID
       WHERE t.ProyectoID = @ID AND t.Estatus = 'SINAFECTAR'
      DELETE ProyectoTarea WHERE ProyectoID = @ID AND Estatus = 'SINAFECTAR'
      DELETE Fase     WHERE ID = @ID 
    END ELSE*/
    --IF @Modulo = 'ACT'   DELETE ActD           WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX01' DELETE ModuloExtra01D WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX02' DELETE ModuloExtra02D WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX03' DELETE ModuloExtra03D WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX04' DELETE ModuloExtra04D WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX05' DELETE ModuloExtra05D WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX06' DELETE ModuloExtra06D WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX07' DELETE ModuloExtra07D WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX08' DELETE ModuloExtra08D WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX09' DELETE ModuloExtra09D WHERE ID = @ID ELSE
    IF @Modulo = 'ORG'   DELETE OrganizaD   WHERE ID = @ID ELSE
    IF @Modulo = 'RE'
    BEGIN
      DELETE ReclutaD			WHERE ID = @ID 
      DELETE ReclutaPlaza		WHERE ID = @ID 
      DELETE ReclutaCompetenciaTipo	WHERE ID = @ID 
    END ELSE
    IF @Modulo = 'ISL'   DELETE ISLD        WHERE ID = @ID ELSE
    IF @Modulo = 'CAM'   DELETE CambioD     WHERE ID = @ID ELSE
    IF @Modulo = 'SAUX'  DELETE SAUXD       WHERE ID = @ID 
    COMMIT TRANSACTION
  END ELSE 
    ROLLBACK TRANSACTION
END
GO

/**************** spMovEnID ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovEnID') and type = 'P') drop procedure dbo.spMovEnID
GO             
CREATE PROCEDURE spMovEnID
			@Modulo		char(5), 
		    	@Empresa	char(5), 
			@Mov		char(20),
			@MovID 		varchar(20), 
			@ID		int	 OUTPUT,
		        @Moneda		char(10) OUTPUT,
                        @Ok		int 	 OUTPUT
--//WITH ENCRYPTION
AS BEGIN 
  SELECT @ID = NULL
  IF @Modulo = 'CONT'  SELECT @ID = ID, @Moneda = Moneda FROM Cont         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'VTAS'  SELECT @ID = ID, @Moneda = Moneda FROM Venta        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'PROD'  SELECT @ID = ID, @Moneda = Moneda FROM Prod         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'COMS'  SELECT @ID = ID, @Moneda = Moneda FROM Compra       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'INV'   SELECT @ID = ID, @Moneda = Moneda FROM Inv          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('CANCELADO') ELSE
  IF @Modulo = 'CXC'   SELECT @ID = ID, @Moneda = Moneda FROM Cxc          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'CXP'   SELECT @ID = ID, @Moneda = Moneda FROM Cxp          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'AGENT' SELECT @ID = ID, @Moneda = Moneda FROM Agent        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'GAS'   SELECT @ID = ID, @Moneda = Moneda FROM Gasto        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'DIN'   SELECT @ID = ID, @Moneda = Moneda FROM Dinero       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'EMB'   SELECT @ID = ID 		   	 FROM Embarque     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'NOM'   SELECT @ID = ID, @Moneda = Moneda FROM Nomina       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'RH'    SELECT @ID = ID, @Moneda = Moneda FROM RH           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'ASIS'  SELECT @ID = ID, @Moneda = Moneda FROM Asiste       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('CANCELADO') ELSE
  IF @Modulo = 'AF'    SELECT @ID = ID, @Moneda = Moneda FROM ActivoFijo   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'PC'    SELECT @ID = ID, @Moneda = Moneda FROM PC           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'OFER'  SELECT @ID = ID, @Moneda = Moneda FROM Oferta       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'VALE'  SELECT @ID = ID, @Moneda = Moneda FROM Vale         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'CR'    SELECT @ID = ID, @Moneda = Moneda FROM CR           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'ST'    SELECT @ID = ID 			 FROM Soporte      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'CAP'   SELECT @ID = ID, @Moneda = Moneda FROM Capital      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'INC'   SELECT @ID = ID, @Moneda = Moneda FROM Incidencia   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'CONC'  SELECT @ID = ID, @Moneda = Moneda FROM Conciliacion WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'PPTO'  SELECT @ID = ID, @Moneda = Moneda FROM Presup       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'CREDI' SELECT @ID = ID, @Moneda = Moneda FROM Credito      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'TMA'   SELECT @ID = ID 			 FROM TMA          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'RSS'   SELECT @ID = ID 			 FROM RSS          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'CMP'   SELECT @ID = ID 			 FROM Campana      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'FIS'   SELECT @ID = ID, @Moneda = Moneda FROM Fiscal   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  --REQ25014
  IF @Modulo = 'CONTP' SELECT @ID = ID           FROM ContParalela   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  --REQ16092
  IF @Modulo = 'OPORT' SELECT @ID = ID, @Moneda = Moneda FROM Oportunidad      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE  
  IF @Modulo = 'CORTE' SELECT @ID = ID           FROM Corte       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'FRM'   SELECT @ID = ID 			 FROM FormaExtra   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'CAPT'  SELECT @ID = ID 			 FROM Captura      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'GES'   SELECT @ID = ID 			 FROM Gestion      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'CP'    SELECT @ID = ID, @Moneda = Moneda FROM CP           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'PCP'   SELECT @ID = ID, @Moneda = Moneda FROM PCP          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE  
  IF @Modulo = 'PROY'  SELECT @ID = ID, @Moneda = Moneda FROM Proyecto     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
--IF @Modulo = 'ACT'   SELECT @ID = ID 			 FROM Act           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
--IF @Modulo = 'MEX01' SELECT @ID = ID, @Moneda = Moneda FROM ModuloExtra01 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
--IF @Modulo = 'MEX02' SELECT @ID = ID, @Moneda = Moneda FROM ModuloExtra02 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
--IF @Modulo = 'MEX03' SELECT @ID = ID, @Moneda = Moneda FROM ModuloExtra03 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
--IF @Modulo = 'MEX04' SELECT @ID = ID, @Moneda = Moneda FROM ModuloExtra04 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
--IF @Modulo = 'MEX05' SELECT @ID = ID, @Moneda = Moneda FROM ModuloExtra05 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
--IF @Modulo = 'MEX06' SELECT @ID = ID, @Moneda = Moneda FROM ModuloExtra06 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
--IF @Modulo = 'MEX07' SELECT @ID = ID, @Moneda = Moneda FROM ModuloExtra07 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
--IF @Modulo = 'MEX08' SELECT @ID = ID, @Moneda = Moneda FROM ModuloExtra08 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
--IF @Modulo = 'MEX09' SELECT @ID = ID, @Moneda = Moneda FROM ModuloExtra09 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'ORG'   SELECT @ID = ID, @Moneda = Moneda FROM Organiza     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'RE'    SELECT @ID = ID, @Moneda = Moneda FROM Recluta      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'ISL'   SELECT @ID = ID, @Moneda = Moneda FROM ISL          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'CAM'   SELECT @ID = ID 			         FROM Cambio       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'PACTO' SELECT @ID = ID, @Moneda = Moneda FROM Contrato     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') ELSE
  IF @Modulo = 'SAUX'  SELECT @ID = ID                   FROM SAUX         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CANCELADO') 
  IF @ID IS NULL SELECT @Ok = 60220
END
GO

/**************** spMovEnMaxID ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovEnMaxID') and type = 'P') drop procedure dbo.spMovEnMaxID
GO             
CREATE PROCEDURE spMovEnMaxID
			@Modulo		char(5), 
		    	@Empresa	char(5), 
			@Mov		char(20),
			@MovID 		varchar(20), 
			@ID		int	 OUTPUT,
                        @Ok		int 	 OUTPUT
--//WITH ENCRYPTION
AS BEGIN 
  SELECT @ID = NULL
  IF @Modulo = 'CONT'  SELECT @ID = MAX(ID) FROM Cont         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'VTAS'  SELECT @ID = MAX(ID) FROM Venta        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'PROD'  SELECT @ID = MAX(ID) FROM Prod         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'COMS'  SELECT @ID = MAX(ID) FROM Compra       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'INV'   SELECT @ID = MAX(ID) FROM Inv          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'CXC'   SELECT @ID = MAX(ID) FROM Cxc          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'CXP'   SELECT @ID = MAX(ID) FROM Cxp          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'AGENT' SELECT @ID = MAX(ID) FROM Agent        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'GAS'   SELECT @ID = MAX(ID) FROM Gasto        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'DIN'   SELECT @ID = MAX(ID) FROM Dinero       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'EMB'   SELECT @ID = MAX(ID) FROM Embarque     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'NOM'   SELECT @ID = MAX(ID) FROM Nomina       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'RH'    SELECT @ID = MAX(ID) FROM RH           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'ASIS'  SELECT @ID = MAX(ID) FROM Asiste       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'AF'    SELECT @ID = MAX(ID) FROM ActivoFijo   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'PC'    SELECT @ID = MAX(ID) FROM PC           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'OFER'  SELECT @ID = MAX(ID) FROM Oferta       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'VALE'  SELECT @ID = MAX(ID) FROM Vale         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'CR'    SELECT @ID = MAX(ID) FROM CR           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'ST'    SELECT @ID = MAX(ID) FROM Soporte      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'CAP'   SELECT @ID = MAX(ID) FROM Capital      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'INC'   SELECT @ID = MAX(ID) FROM Incidencia   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'CONC'  SELECT @ID = MAX(ID) FROM Conciliacion WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'PPTO'  SELECT @ID = MAX(ID) FROM Presup       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'CREDI' SELECT @ID = MAX(ID) FROM Credito      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'TMA'   SELECT @ID = MAX(ID) FROM TMA          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'RSS'   SELECT @ID = MAX(ID) FROM RSS          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'CMP'   SELECT @ID = MAX(ID) FROM Campana      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'FIS'   SELECT @ID = MAX(ID) FROM Fiscal       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  --REQ25014
  IF @Modulo = 'CONTP' SELECT @ID = MAX(ID) FROM ContParalela WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  --REQ16092
  IF @Modulo = 'OPORT' SELECT @ID = MAX(ID) FROM Oportunidad  WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE  
  IF @Modulo = 'CORTE' SELECT @ID = MAX(ID) FROM Corte        WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'FRM'   SELECT @ID = MAX(ID) FROM FormaExtra   WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'CAPT'  SELECT @ID = MAX(ID) FROM Captura      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'GES'   SELECT @ID = MAX(ID) FROM Gestion      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'CP'    SELECT @ID = MAX(ID) FROM CP           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'PCP'   SELECT @ID = MAX(ID) FROM PCP          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE  
  IF @Modulo = 'PROY'  SELECT @ID = MAX(ID) FROM Proyecto     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  --IF @Modulo = 'ACT'   SELECT @ID = MAX(ID) FROM Act           WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  --IF @Modulo = 'MEX01' SELECT @ID = MAX(ID) FROM ModuloExtra01 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  --IF @Modulo = 'MEX02' SELECT @ID = MAX(ID) FROM ModuloExtra02 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  --IF @Modulo = 'MEX03' SELECT @ID = MAX(ID) FROM ModuloExtra03 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  --IF @Modulo = 'MEX04' SELECT @ID = MAX(ID) FROM ModuloExtra04 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  --IF @Modulo = 'MEX05' SELECT @ID = MAX(ID) FROM ModuloExtra05 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  --IF @Modulo = 'MEX06' SELECT @ID = MAX(ID) FROM ModuloExtra06 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  --IF @Modulo = 'MEX07' SELECT @ID = MAX(ID) FROM ModuloExtra07 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  --IF @Modulo = 'MEX08' SELECT @ID = MAX(ID) FROM ModuloExtra08 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  --IF @Modulo = 'MEX09' SELECT @ID = MAX(ID) FROM ModuloExtra09 WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'ORG'   SELECT @ID = MAX(ID) FROM Organiza     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'RE'    SELECT @ID = MAX(ID) FROM Recluta      WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'ISL'   SELECT @ID = MAX(ID) FROM ISL          WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'CAM'   SELECT @ID = MAX(ID) FROM Cambio       WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'PACTO' SELECT @ID = MAX(ID) FROM Contrato     WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID ELSE
  IF @Modulo = 'SAUX'  SELECT @ID = MAX(ID) FROM SAUX         WHERE Empresa = @Empresa AND Mov = @Mov AND MovID = @MovID 

END
GO

/**************** spMovEstatus ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovEstatus') and type = 'P') drop procedure dbo.spMovEstatus
GO             
CREATE PROCEDURE spMovEstatus
			@Modulo		 char(5),
		  	@Estatus	 char(15),
			@ID		 int,
			@Generar	 bit,
			@GenerarID	 int,
       			@GenerarAfectado bit,

			@Ok		 int	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @GenerarEstatus char(15)

  IF @@TRANCOUNT = 0 SELECT @Ok = 10
  IF @Ok IS NOT NULL RETURN

  IF @GenerarAfectado = 1 SELECT @GenerarEstatus = 'AFECTANDO' ELSE SELECT @GenerarEstatus = 'SINAFECTAR'

  -- Cambiar el Estatus Movimiento Actual
  IF @Modulo = 'CONT'  UPDATE Cont         SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'VTAS'  UPDATE Venta        SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'PROD'  UPDATE Prod         SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'COMS'  UPDATE Compra       SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'INV'   UPDATE Inv          SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'CXC'   UPDATE Cxc          SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'CXP'   UPDATE Cxp          SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'AGENT' UPDATE Agent        SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'GAS'   UPDATE Gasto        SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'DIN'   UPDATE Dinero       SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'EMB'   UPDATE Embarque     SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'NOM'   UPDATE Nomina       SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'RH'    UPDATE RH           SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'ASIS'  UPDATE Asiste       SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'AF'    UPDATE ActivoFijo   SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'PC'    UPDATE PC           SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'OFER'  UPDATE Oferta       SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'VALE'  UPDATE Vale         SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'CR'    UPDATE CR           SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'ST'    UPDATE Soporte      SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'CAP'   UPDATE Capital      SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'INC'   UPDATE Incidencia   SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'CONC'  UPDATE Conciliacion SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'PPTO'  UPDATE Presup       SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'CREDI' UPDATE Credito      SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'TMA'   UPDATE TMA          SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'RSS'   UPDATE RSS          SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'CMP'   UPDATE Campana      SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'FIS'   UPDATE Fiscal       SET Estatus = @Estatus WHERE ID = @ID ELSE
  --REQ25014
  IF @Modulo = 'CONTP' UPDATE ContParalela SET Estatus = @Estatus WHERE ID = @ID ELSE
  --REQ16092
  IF @Modulo = 'OPORT' UPDATE Oportunidad  SET Estatus = @Estatus WHERE ID = @ID ELSE  
  IF @Modulo = 'CORTE' UPDATE Corte        SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'FRM'   UPDATE FormaExtra   SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'CAPT'  UPDATE Captura      SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'GES'   UPDATE Gestion      SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'CP'    UPDATE CP           SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'PCP'   UPDATE PCP          SET Estatus = @Estatus WHERE ID = @ID ELSE  
  IF @Modulo = 'PROY'  UPDATE Proyecto     SET Estatus = @Estatus WHERE ID = @ID ELSE
  --IF @Modulo = 'ACT'   UPDATE Act           SET Estatus = @Estatus WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX01' UPDATE ModuloExtra01 SET Estatus = @Estatus WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX02' UPDATE ModuloExtra02 SET Estatus = @Estatus WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX03' UPDATE ModuloExtra03 SET Estatus = @Estatus WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX04' UPDATE ModuloExtra04 SET Estatus = @Estatus WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX05' UPDATE ModuloExtra05 SET Estatus = @Estatus WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX06' UPDATE ModuloExtra06 SET Estatus = @Estatus WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX07' UPDATE ModuloExtra07 SET Estatus = @Estatus WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX08' UPDATE ModuloExtra08 SET Estatus = @Estatus WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX09' UPDATE ModuloExtra09 SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'ORG'   UPDATE Organiza     SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'RE'    UPDATE Recluta	   SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'ISL'   UPDATE ISL          SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'CAM'   UPDATE Cambio       SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'PACTO' UPDATE Contrato     SET Estatus = @Estatus WHERE ID = @ID ELSE
  IF @Modulo = 'SAUX'  UPDATE SAUX         SET Estatus = @Estatus WHERE ID = @ID 
  IF @@ERROR <> 0 SELECT @Ok = 1

  -- Cambiar el Estatus Movimiento Generado
  IF @Generar = 1
  BEGIN
    IF @Modulo = 'CONT'  UPDATE Cont         SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'VTAS'  UPDATE Venta        SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'PROD'  UPDATE Prod         SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'COMS'  UPDATE Compra       SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'INV'   UPDATE Inv          SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'CXC'   UPDATE Cxc          SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'CXP'   UPDATE Cxp          SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'AGENT' UPDATE Agent        SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'GAS'   UPDATE Gasto        SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'DIN'   UPDATE Dinero       SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'EMB'   UPDATE Embarque     SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'NOM'   UPDATE Nomina       SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'RH'    UPDATE RH           SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'ASIS'  UPDATE Asiste       SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'AF'    UPDATE ActivoFijo   SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'PC'    UPDATE PC           SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'OFER'  UPDATE Oferta       SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'VALE'  UPDATE Vale         SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'CR'    UPDATE CR           SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'ST'    UPDATE Soporte      SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'CAP'   UPDATE Capital      SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'INC'   UPDATE Incidencia   SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'CONC'  UPDATE Conciliacion SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'PPTO'  UPDATE Presup       SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'CREDI' UPDATE Credito      SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'TMA'   UPDATE TMA          SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'RSS'   UPDATE RSS          SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'CMP'   UPDATE Campana      SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'FIS'   UPDATE Fiscal       SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    --REQ25014
    IF @Modulo = 'CONTP' UPDATE ContParalela SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    --REQ16092
	IF @Modulo = 'OPORT' UPDATE Oportunidad  SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE	
    IF @Modulo = 'CORTE' UPDATE Corte        SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'FRM'   UPDATE FormaExtra   SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'CAPT'  UPDATE Captura      SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'GES'   UPDATE Gestion      SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'CP'    UPDATE CP           SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'PCP'   UPDATE PCP          SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE    
    IF @Modulo = 'PROY'  UPDATE Proyecto     SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    --IF @Modulo = 'ACT'   UPDATE Act           SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    --IF @Modulo = 'MEX01' UPDATE ModuloExtra01 SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    --IF @Modulo = 'MEX02' UPDATE ModuloExtra02 SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    --IF @Modulo = 'MEX03' UPDATE ModuloExtra03 SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    --IF @Modulo = 'MEX04' UPDATE ModuloExtra04 SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    --IF @Modulo = 'MEX05' UPDATE ModuloExtra05 SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    --IF @Modulo = 'MEX06' UPDATE ModuloExtra06 SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    --IF @Modulo = 'MEX07' UPDATE ModuloExtra07 SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    --IF @Modulo = 'MEX08' UPDATE ModuloExtra08 SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    --IF @Modulo = 'MEX09' UPDATE ModuloExtra09 SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'ORG'   UPDATE Organiza     SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'RE'    UPDATE Recluta	     SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'ISL'   UPDATE ISL          SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'CAM'   UPDATE Cambio       SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'PACTO' UPDATE Contrato     SET Estatus = @GenerarEstatus WHERE ID = @GenerarID ELSE
    IF @Modulo = 'SAUX'  UPDATE SAUX         SET Estatus = @GenerarEstatus WHERE ID = @GenerarID 
    IF @@ERROR <> 0 SELECT @Ok = 1
  END

  RETURN
END
GO

/************** spMovFinal *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovFinal') and type = 'P') drop procedure dbo.spMovFinal
GO
CREATE PROCEDURE spMovFinal
           @Empresa			char(5),
		   @Sucursal		int,
		   @Modulo			char(5), 
		   @ID				int, 			
		   @Estatus			char(15), 
           @EstatusNuevo	char(15),
		   @Usuario			char(10),
		   @FechaEmision	datetime, 	
		   @FechaRegistro	datetime,
		   @Mov				char(20),
		   @MovID			varchar(20),
		   @MovTipo			char(20),
		   @IDGenerar		int,
		   @Ok				int				OUTPUT,
		   @OkRef			varchar(255)	OUTPUT,
		   @Estacion		int = NULL		-- REQ12336
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @OkTemp			int,
    @OkRefTemp			varchar(255),
    @SoporteID			int,
    @SubModulo  		char(5),
    @GenerarParalelo		varchar(50),
    @AfectarFiscal		varchar(20),
    @AfectarCP			varchar(20),
    @AplicarCP			varchar(20),
    @eCollaboration		bit,
    @Fiscal			bit,
    @CP				bit,
    @CPContinua			bit,
    @Registro			bit,
    @ContAuto			bit,
    @CFD			bit,
    @FechaCancelacion		datetime,
    @CPEmpresa			varchar(5),
    @CPSucursal			int,
    @CPModulo			varchar(5), 
    @CPID			int, 			
    @CPEstatus			varchar(15), 
    @CPEstatusNuevo		varchar(15),
    @CPUsuario			varchar(10),
    @CPFechaEmision		datetime, 	
    @CPFechaRegistro		datetime, 	
    @CPMov			varchar(20),
    @CPMovID			varchar(20),
    @CPMovTipo			varchar(20),
    @CPAfectarCP		varchar(20),
    @ExportacionXML		bit,
    @eDoc				bit,          --MEJORA2104
    @CFDFlex			bit,          --MEJORA2104    
    @MovTipoCFDFlex		bit,          --MEJORA2104        
    @XML				varchar(max), --MEJORA2104
    @eDocOk				int,
    @eDocOkRef			varchar(255),
    @CRCFDSerie			varchar(20),
    @CRCFDFolio			varchar(20),
    @SubMovTipo			varchar(20),	-- REQ12336
    @InterfazEmida		bit,				-- REQ12336
    @OrigenTipo			varchar(20),  --REQ13383
    @IDSurtido          int
    
  SELECT @CRCFDSerie = NULL, @CRCFDFolio = NULL  

  /***********     ACtualizaciòn Valor Adquisición Activo Fijo     ********************/
  IF @Estatus <> @EstatusNuevo AND @Modulo IN ('COMS','GAS') AND @Ok IN (NULL, 80030) 
  BEGIN
    IF @EstatusNuevo IN ('CONCLUIDO', 'CANCELADO')
    EXEC spAplicaValAdquisicionAF @ID, @Modulo, @EstatusNuevo, @Empresa, @Usuario, @Ok OUTPUT, @OkRef OUTPUT
  END
  /***********************************************************************************/

  IF @Estatus <> @EstatusNuevo AND @EstatusNuevo = 'CANCELADO' AND @MovTipo IN (SELECT Clave FROM WMSModuloMovimiento WHERE Modulo = @Modulo)
  BEGIN

      DECLARE crCancelarSurtido CURSOR FOR
       SELECT ID
         FROM TMA 
        WHERE OrigenTipo = @Modulo 
          AND Origen = @Mov 
          AND OrigenID = @MovID
      OPEN crCancelarSurtido
      FETCH NEXT FROM crCancelarSurtido INTO @IDSurtido
      WHILE @@FETCH_STATUS = 0
      BEGIN
            UPDATE MovFlujo 
               SET Cancelado = 1
             WHERE Empresa = @Empresa AND OModulo = @Modulo AND OID = @ID

	        EXEC spAfectar 'TMA', @IDSurtido, 'CANCELAR', 'Todo', NULL, @Usuario, @Estacion, @EnSilencio = 1 ,@Ok = @Ok, @OkRef = @OkRef
            
        FETCH NEXT FROM crCancelarSurtido INTO @IDSurtido
      END
      CLOSE crCancelarSurtido
      DEALLOCATE crCancelarSurtido
  END
  
  IF @Estatus <> @EstatusNuevo
  BEGIN
    IF @EstatusNuevo IN ('PENDIENTE', 'CONCLUIDO', 'CONCILIADO', 'CANCELADO')
      EXEC spMovCampoExtraAfectarContacto @Modulo, @Mov, @ID, @Estatus, @EstatusNuevo

    INSERT MovEstatusLog (Sucursal,  Modulo,  ModuloID, Estatus,       Usuario,  Fecha)
                  VALUES (@Sucursal, @Modulo, @ID,      @EstatusNuevo, @Usuario, @FechaRegistro)

    IF @Modulo <> 'ST' AND @Mov IS NOT NULL AND @MovID IS NOT NULL AND @EstatusNuevo IN ('PENDIENTE', 'CONCLUIDO', 'CONCILIADO', 'CANCELADO')
    BEGIN
      SELECT @GenerarParalelo = NULL, @AfectarFiscal = NULL, @AfectarCP = NULL, @AplicarCP = NULL
      SELECT @GenerarParalelo = NULLIF(NULLIF(RTRIM(UPPER(GenerarParalelo)), ''), 'NO'),
             @AfectarFiscal = UPPER(NULLIF(RTRIM(AfectarFiscal), '')),
             @AfectarCP = UPPER(NULLIF(RTRIM(AfectarCP), '')),
             @AplicarCP = UPPER(NULLIF(RTRIM(AplicarCP), '')),
             @CFD = CFD,
             @MovTipoCFDFlex = ISNULL(CFDFlex,0),
             @SubMovTipo = ISNULL(SubClave, '') -- REQ12336
        FROM MovTipo
       WHERE Modulo = @Modulo AND Mov = @Mov

      SELECT @SubModulo = NULL
      IF @GenerarParalelo IS NOT NULL
      BEGIN
        IF NOT EXISTS(SELECT * FROM MovTipo WHERE Modulo = 'ST' AND Mov = @Mov)
        BEGIN
          SELECT @Ok = 70120, @OkRef = @Mov
          RETURN
        END
        IF @GenerarParalelo  = 'ATENCION CLIENTES'    SELECT @SubModulo = 'ST' 	  ELSE
        IF @GenerarParalelo  = 'ATENCION PROVEEDORES' SELECT @SubModulo = 'STPRO' ELSE
        IF @GenerarParalelo  = 'ATENCION PERSONAL'    SELECT @SubModulo = 'STPER' ELSE
        IF @GenerarParalelo  = 'PROYECTOS'	      SELECT @SubModulo = 'PROY'  ELSE
        IF @GenerarParalelo  = 'SERVICIOS INTERNOS'   SELECT @SubModulo = 'SI'
        IF @SubModulo IS NOT NULL
        BEGIN       
          SELECT @OkTemp = @Ok, @OkRefTemp = @OkRef
          SELECT @Ok = NULL, @OkRef = NULL
          SELECT @SoporteID = NULL
          SELECT @SoporteID = ID FROM Soporte WHERE Mov = @Mov AND MovID = @MovID AND SubModulo = @SubModulo
          IF @EstatusNuevo = 'CANCELADO'
          BEGIN
            IF @SoporteID IS NOT NULL 
            EXEC spSoporte @SoporteID, 'ST', 'CANCELAR', 'TODO', @FechaRegistro, NULL, @Usuario, 1, 0, @Mov, @MovID, NULL, @Ok OUTPUT, @OkRef OUTPUT
          END ELSE
          IF @SoporteID IS NULL 
          BEGIN
            IF @Modulo = 'CXC'
              INSERT Soporte (UltimoCambio, Sucursal,  SucursalOrigen, SucursalDestino, OrigenTipo, Origen,   OrigenID,  Empresa,  Usuario,  UsuarioResponsable,  Estatus,      Mov, MovID,  FechaEmision,  Estado,         SubModulo,  Concepto, Proyecto, Referencia, Observaciones, UEN, Cliente, EnviarA) 
                          SELECT GETDATE(), @Sucursal, @Sucursal,      @Sucursal,       @Modulo,    @Mov,     @MovID,   @Empresa,  @Usuario, @Usuario,           'SINAFECTAR', @Mov, @MovID, @FechaEmision, 'No comenzado', @SubModulo, Concepto, Proyecto, Referencia, Observaciones, UEN, Cliente, ClienteEnviarA FROM Cxc WHERE ID = @ID
            ELSE IF @Modulo = 'VTAS'
              INSERT Soporte (UltimoCambio, Sucursal,  SucursalOrigen, SucursalDestino, OrigenTipo, Origen,   OrigenID,  Empresa,  Usuario,  UsuarioResponsable,  Estatus,      Mov, MovID,  FechaEmision,  Estado,         SubModulo,  Concepto, Proyecto, Referencia, Observaciones, UEN, Cliente, EnviarA) 
                          SELECT GETDATE(), @Sucursal, @Sucursal,      @Sucursal,       @Modulo,    @Mov,     @MovID,   @Empresa,  @Usuario, @Usuario,           'SINAFECTAR', @Mov, @MovID, @FechaEmision, 'No comenzado', @SubModulo, Concepto, Proyecto, Referencia, Observaciones, UEN, Cliente, EnviarA FROM Venta WHERE ID = @ID
            ELSE IF @Modulo = 'CXP'
              INSERT Soporte (UltimoCambio, Sucursal,  SucursalOrigen, SucursalDestino, OrigenTipo, Origen,   OrigenID,  Empresa,  Usuario,  UsuarioResponsable,  Estatus,      Mov, MovID,  FechaEmision,  Estado,         SubModulo,  Concepto, Proyecto, Referencia, Observaciones, UEN, Proveedor) 
                          SELECT GETDATE(), @Sucursal, @Sucursal,      @Sucursal,       @Modulo,    @Mov,     @MovID,   @Empresa,  @Usuario, @Usuario,           'SINAFECTAR', @Mov, @MovID, @FechaEmision, 'No comenzado', @SubModulo, Concepto, Proyecto, Referencia, Observaciones, UEN, Proveedor FROM Cxp WHERE ID = @ID 
            ELSE IF @Modulo = 'COMS'
              INSERT Soporte (UltimoCambio, Sucursal,  SucursalOrigen, SucursalDestino, OrigenTipo, Origen,   OrigenID,  Empresa,  Usuario,  UsuarioResponsable,  Estatus,      Mov, MovID,  FechaEmision,  Estado,         SubModulo,  Concepto, Proyecto, Referencia, Observaciones, UEN, Proveedor) 
                          SELECT GETDATE(), @Sucursal, @Sucursal,      @Sucursal,       @Modulo,    @Mov,     @MovID,   @Empresa,  @Usuario, @Usuario,           'SINAFECTAR', @Mov, @MovID, @FechaEmision, 'No comenzado', @SubModulo, Concepto, Proyecto, Referencia, Observaciones, UEN, Proveedor FROM Compra WHERE ID = @ID 
            ELSE IF @Modulo = 'GAS'
              INSERT Soporte (UltimoCambio, Sucursal,  SucursalOrigen, SucursalDestino, OrigenTipo, Origen,   OrigenID,  Empresa,  Usuario,  UsuarioResponsable,  Estatus,      Mov, MovID,  FechaEmision,  Estado,         SubModulo,  Proyecto, Observaciones, UEN, Proveedor) 
                          SELECT GETDATE(), @Sucursal, @Sucursal,      @Sucursal,       @Modulo,    @Mov,     @MovID,   @Empresa,  @Usuario, @Usuario,           'SINAFECTAR', @Mov, @MovID, @FechaEmision, 'No comenzado', @SubModulo, Proyecto, Observaciones, UEN, Acreedor FROM Gasto WHERE ID = @ID
            ELSE
            INSERT Soporte (UltimoCambio, Sucursal,  SucursalOrigen, SucursalDestino, OrigenTipo, Origen,   OrigenID,  Empresa,  Usuario,  UsuarioResponsable,  Estatus,      Mov,   MovID,  FechaEmision,  Estado,         SubModulo,  Concepto, Proyecto, Referencia, Observaciones) 
                        SELECT GETDATE(), @Sucursal, @Sucursal,      @Sucursal,       @Modulo,    @Mov,     @MovID,   @Empresa,  @Usuario, @Usuario,           'SINAFECTAR', @Mov,  @MovID, @FechaEmision,  'No comenzado', @SubModulo, Concepto, Proyecto, Referencia, Observaciones 
                          FROM Mov 
                         WHERE Modulo = @Modulo AND ID = @ID
            SELECT @SoporteID = SCOPE_IDENTITY()

            IF @SoporteID IS NOT NULL 
            BEGIN
              EXEC spSoporte @SoporteID, 'ST', 'AFECTAR', 'TODO', @FechaRegistro, NULL, @Usuario, 1, 0, @Mov, @MovID, NULL, @Ok OUTPUT, @OkRef OUTPUT

              IF @Ok IS NULL OR @Ok BETWEEN 80030 AND 81000
                EXEC spMovFlujo @Sucursal, 'AFECTAR', @Empresa, @Modulo, @ID, @Mov, @MovID, 'ST', @SoporteID, @Mov, @MovID, @Ok OUTPUT

              IF @Ok IS NULL OR @Ok BETWEEN 80030 AND 81000
                SELECT @Ok = @OkTemp, @OkRef = @OkRefTemp
            END
          END
        END
      END
    END

    SELECT @Fiscal = ISNULL(Fiscal, 0),
           @CP = ISNULL(CP, 0),
           @eCollaboration = ISNULL(eCollaboration, 0),
           @ContAuto = ISNULL(ContAuto, 0),
           @Registro = ISNULL(Registro, 0),
           @eDoc = ISNULL(eDoc, 0),
           @CFDFlex = ISNULL(CFDFlex, 0),
           @InterfazEmida = ISNULL(InterfazEmida, 0) -- REQ12336
           /*,
           @CfgRegistro = CfgRegistro*/
      FROM EmpresaGral 
     WHERE Empresa = @Empresa


    -- e-Collaboration
    IF @eCollaboration = 1 AND @Ok IS NULL OR @Ok BETWEEN 80030 AND 81000 
      EXEC spECollaboration @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @Ok OUTPUT, @OkRef OUTPUT

    IF @Fiscal = 1 AND @AfectarFiscal NOT IN (NULL, 'NO') 
    BEGIN
      SELECT @OkTemp = @Ok, @OkRefTemp = @OkRef
      SELECT @Ok = NULL, @OkRef = NULL
      EXEC spGenerarFiscal @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @AfectarFiscal, @Ok OUTPUT, @OkRef OUTPUT
	  IF @Ok IS NULL OR @Ok BETWEEN 80030 AND 81000 SELECT @Ok = @OkTemp, @OkRef = @OkRefTemp
    END

    IF @CP = 1 AND (@AfectarCP NOT IN (NULL, 'NO') OR @AplicarCP NOT IN (NULL, 'NO'))
    BEGIN
      SELECT @CPContinua = 1
      
      -- si el estatus actual es pendiente que no haga nada
      IF @Estatus = 'CONCLUIDO' AND @EstatusNuevo = 'PENDIENTE'
        SELECT @CPContinua = 0
      ELSE
      IF @Estatus = 'PENDIENTE' AND @EstatusNuevo = 'CONCLUIDO'
      BEGIN
        SELECT @CPContinua = 0
        IF NOT EXISTS (SELECT * FROM sysobjects where id = object_id('#CPEsAjuste') and type = 'U') 
          CREATE TABLE #CPEsAjuste(
          	Empresa		varchar(5)	COLLATE Database_Default NULL,
          	Sucursal	int		NULL,
          	Modulo		varchar(5)	COLLATE Database_Default NULL,
		ID		int             NULL,
          	Estatus		varchar(15)	COLLATE Database_Default NULL,
          	EstatusNuevo	varchar(15)	COLLATE Database_Default NULL,
          	Usuario		varchar(10)	COLLATE Database_Default NULL,
          	FechaEmision	datetime	NULL,
          	FechaRegistro	datetime	NULL,
          	Mov		varchar(20)	COLLATE Database_Default NULL,
          	MovID		varchar(20)	COLLATE Database_Default NULL,
          	MovTipo		varchar(20)	COLLATE Database_Default NULL,
          	AfectarCP	varchar(20)	COLLATE Database_Default NULL)
          	
        INSERT #CPEsAjuste (
                Empresa,  Sucursal,  Modulo,  ID,  Estatus,  EstatusNuevo,  Usuario,  FechaEmision,  FechaRegistro,  Mov,  MovID,  MovTipo,  AfectarCP)
        VALUES (@Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @AfectarCP)        
      END 
      	
      IF @CPContinua = 1
      BEGIN
        SELECT @OkTemp = @Ok, @OkRefTemp = @OkRef
        SELECT @Ok = NULL, @OkRef = NULL
        EXEC spGenerarCP @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @AfectarCP, 0, @Ok OUTPUT, @OkRef OUTPUT
        IF @Ok BETWEEN 80030 AND 81000 SELECT @Ok = NULL

        IF EXISTS (SELECT * FROM sysobjects where id = object_id('#CPEsAjuste') and type = 'U') AND @Ok IS NULL
        BEGIN
          DECLARE crCPEsAjuste CURSOR LOCAL FOR 
           SELECT Empresa, Sucursal, Modulo, ID, Estatus, EstatusNuevo, Usuario, FechaEmision, FechaRegistro, Mov, MovID, MovTipo, AfectarCP
            FROM #CPEsAjuste
          OPEN crCPEsAjuste
          FETCH NEXT FROM crCPEsAjuste INTO @CPEmpresa, @CPSucursal, @CPModulo, @CPID, @CPEstatus, @CPEstatusNuevo, @CPUsuario, @CPFechaEmision, @CPFechaRegistro, @CPMov, @CPMovID, @CPMovTipo, @CPAfectarCP
          WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL 
          BEGIN
            IF @@FETCH_STATUS <> -2 
            BEGIN
              EXEC spGenerarCP @CPEmpresa, @CPSucursal, @CPModulo, @CPID, @CPEstatus, @CPEstatusNuevo, @CPUsuario, @CPFechaEmision, @CPFechaRegistro, @CPMov, @CPMovID, @CPMovTipo, @CPAfectarCP, 1, @Ok OUTPUT, @OkRef OUTPUT
              IF @Ok BETWEEN 80030 AND 81000 SELECT @Ok = NULL       
            END
            FETCH NEXT FROM crCPEsAjuste INTO @CPEmpresa, @CPSucursal, @CPModulo, @CPID, @CPEstatus, @CPEstatusNuevo, @CPUsuario, @CPFechaEmision, @CPFechaRegistro, @CPMov, @CPMovID, @CPMovTipo, @CPAfectarCP
          END
          CLOSE crCPEsAjuste
          DEALLOCATE crCPEsAjuste
        END
        IF @Ok IS NULL OR @Ok BETWEEN 80030 AND 81000
          SELECT @Ok = @OkTemp, @OkRef = @OkRefTemp
      END
    END

    -- Contabilidad Automatica
    IF @ContAuto = 1 AND @Modulo <> 'CONT' AND (@Ok IS NULL OR @Ok BETWEEN 80030 AND 81000)
      EXEC spMovContAuto @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @IDGenerar, @Ok OUTPUT, @OkRef OUTPUT

/*    IF @CfgRegistro IS NOT NULL
      EXEC spRegistro @CfgRegistro, @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @Ok OUTPUT, @OkRef OUTPUT
*/

    IF @Modulo = 'VTAS'
      SELECT @CRCFDSerie = NULLIF(CRCFDSerie,''), @CRCFDFolio = NULLIF(CRCFDFolio,'') FROM Venta WHERE ID = @ID
      
    -- Para Insertar a CFD    
    IF (@CFD = 1 OR (@CRCFDSerie IS NOT NULL OR @CRCFDFolio IS NOT NULL)) AND @EstatusNuevo = 'CANCELADO'
    BEGIN
      IF @Modulo = 'CXC'
        SELECT @FechaCancelacion = FechaCancelacion FROM CXC WHERE ID = @ID
      IF @Modulo = 'VTAS'
        SELECT @FechaCancelacion = FechaCancelacion FROM Venta WHERE ID = @ID
 
      IF (SELECT FechaCancelacion FROM CFD WHERE Modulo = @Modulo AND ModuloID = @ID) IS NULL
        UPDATE CFD SET FechaCancelacion = @FechaCancelacion WHERE Modulo = @Modulo AND ModuloID = @ID
    END

    -- xpOperacionRelevante
    IF (@Ok IS NULL OR @Ok BETWEEN 80030 AND 81000)
      EXEC xpOperacionRelevante @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @Ok OUTPUT, @OkRef OUTPUT

    -- Modulo Central
    IF (@Ok IS NULL OR @Ok BETWEEN 80030 AND 81000) AND (SELECT ModuloCentral FROM Version) = 1 
      IF (SELECT ModuloCentral FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov) = 1
        EXEC spMCMov @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @IDGenerar, @Ok OUTPUT, @OkRef OUTPUT

    -- xpMovEstatus 
    IF (@Ok IS NULL OR @Ok BETWEEN 80030 AND 81000)
      EXEC xpMovEstatus @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @Ok OUTPUT, @OkRef OUTPUT
  END

  /*IF @Ok IS NULL OR @Ok BETWEEN 80030 AND 81000
    EXEC vic_spRegistrarMovFlujo @Sucursal, 'AFECTAR', @Empresa, @Modulo, @ID, @Mov, @MovID, @OK OUTPUT*/

  IF (@Ok IS NULL OR @Ok BETWEEN 80030 AND 81000)
     EXEC xpMovFinal @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @IDGenerar, @Ok OUTPUT, @OkRef OUTPUT

  IF (@Ok IS NULL OR @Ok BETWEEN 80030 AND 81000)
     EXEC xpInterfacesMovFinal @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @IDGenerar, @Ok OUTPUT, @OkRef OUTPUT

  --SELECT @ExportacionXML = ExportacionXML FROM EmpresaGral WHERE Empresa = @Empresa --MEJORA2104
  --IF (@Ok IS NULL OR @Ok BETWEEN 80030 AND 81000) AND @EstatusNuevo = 'CONCLUIDO' AND @ExportacionXML = 1
  --  EXEC spExportacionXML @@SPID, @Modulo, @Mov, @ID, @Ok OUTPUT, @OkRef OUTPUT

  IF (@Ok IS NULL OR @Ok BETWEEN 80030 AND 81000) AND @eDoc = 1 AND @MovTipoCFDFlex = 0 --MEJORA2104
  BEGIN
    SELECT @eDocOk = NULL, @eDocOkRef = NULL
    EXEC speDocXML @@SPID, @Empresa, @Modulo, @Mov, @ID, NULL, @EstatusNuevo, 1, 0, @XML OUTPUT, @eDocOk OUTPUT, @eDocOkRef OUTPUT
    IF @eDocOk IS NOT NULL SELECT @Ok = @eDocOk, @OkRef = @eDocOkRef
  END    

 --REQ 15739  
  

  IF (@MovTipoCFDFlex = 1) AND (@CFDFlex = 1) AND (@eDoc = 1) AND (@Ok IS NULL OR @Ok BETWEEN 80030 AND 81000) --MEJORA2104
  BEGIN
	IF EXISTS(SELECT * FROM CFDFlexTemp WHERE ID = @ID AND Modulo = @Modulo)    
    DELETE CFDFlexTemp WHERE ID = @ID AND Modulo = @Modulo 
    EXEC spInsertarCFDFlexTemp @@SPID, @Empresa, @Modulo, @ID, @EstatusNuevo, @Estatus, @Mov, @MovID, @Ok OUTPUT, @OkRef OUTPUT
    IF @Ok IS NULL
      EXEC spCFDFlexTempVerificar  @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, 0,NULL, @Estacion, 1, 1, @Ok  OUTPUT, @OkRef   OUTPUT
      
  END
  IF (@MovTipoCFDFlex = 1) AND (@CFDFlex = 1) AND (@eDoc = 1) AND (@Ok IS NULL OR @Ok BETWEEN 80030 AND 81000) --MEJORA2104 
  BEGIN
    SELECT @eDocOk = NULL, @eDocOkRef = NULL  
    EXEC spCFDFlexCancelar @@SPID, @Empresa, @Modulo, @ID, @EstatusNuevo, @eDocOk OUTPUT, @eDocOkRef OUTPUT  
    IF @eDocOk IS NOT NULL SELECT @Ok = @eDocOk, @OkRef = @eDocOkRef
  END
 --REQ 15739  

  -- REQ12336
  IF @Modulo = 'VTAS' AND @InterfazEmida = 1 AND @Estatus <> @EstatusNuevo AND @EstatusNuevo = 'PROCESAR' -- REQ13894
  BEGIN
    SELECT @SubMovTipo = ISNULL(SubClave, '') -- REQ13894
      FROM MovTipo
     WHERE Modulo = @Modulo AND Mov = @Mov
     
    SELECT @OrigenTipo = OrigenTipo FROM Venta WHERE ID = @ID --REQ13383
    
    IF @SubMovTipo = 'VTAS.NEMIDA' AND @OrigenTipo NOT IN ('POS')-- REQ13894 --REQ13383
      EXEC spEmidaRecargaTelefonica @Modulo, @ID, @Estacion, @Empresa, @Sucursal, @Usuario, @Ok OUTPUT, @OkRef OUTPUT
  END

  IF @Modulo = 'DIN' AND @InterfazEmida = 1 AND @Estatus <> @EstatusNuevo AND @EstatusNuevo = 'CONCLUIDO' AND @MovTipo IN('DIN.CHE', 'DIN.CH', 'DIN.DE', 'DIN.D')
  BEGIN
    EXEC spEmidaDineroSubmitPayment @Modulo, @ID, @Empresa, @Estacion, @Usuario, @Sucursal, @Ok OUTPUT, @OkRef OUTPUT
  END  
  -- REQ12336
  
  --Integración MES
  IF (SELECT IntelMESInterfase FROM EmpresaCfg WHERE Empresa = @Empresa) = 1
	EXEC xpMESMovFinal @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @IDGenerar, @Ok OUTPUT, @OkRef OUTPUT

  --Monedero
  IF (@Ok IS NULL OR @Ok BETWEEN 80030 AND 81000)
     EXEC spMonederoFinal @Empresa, @Sucursal, @Modulo, @ID, @Estatus, @EstatusNuevo, @Usuario, @FechaEmision, @FechaRegistro, @Mov, @MovID, @MovTipo, @IDGenerar, @Ok OUTPUT, @OkRef OUTPUT

  RETURN 
END
GO

/************** spMovFlujo *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovFlujo') and type = 'P') drop procedure dbo.spMovFlujo
GO
CREATE PROCEDURE spMovFlujo
		   @Sucursal		int,
		   @Accion		char(20),
                   @Empresa     	char(5),
                   @OModulo		char(5),
		   @OID			int,
                   @OMov                char(20),
                   @OMovID		varchar(20),
                   @DModulo		char(5),
		   @DID			int,
                   @DMov                char(20),
                   @DMovID		varchar(20),
		   @Ok			int	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  IF @OID IS NULL OR @OMovID IS NULL OR @OMov IS NULL OR @DID IS NULL OR @DMov IS NULL OR @DMovID IS NULL OR @Accion = 'CANCELAR'
    RETURN

  IF NOT EXISTS (SELECT * FROM MovFlujo WHERE Empresa = @Empresa AND OModulo = @OModulo AND OID  = @OID AND DModulo = @DModulo AND DID = @DID)
  BEGIN
    INSERT MovFlujo (Sucursal,  Empresa, OModulo, OID, OMov, OMovID, DModulo, DID, DMov, DMovID)
             VALUES (@Sucursal, @Empresa, @OModulo, @OID, @OMov, @OMovID, @DModulo, @DID, @DMov, @DMovID)
    EXEC spCamposExtrasMovFlujo @OModulo, @OMov, @OID, @DModulo, @DMov, @DID
  END
  IF @@ERROR <> 0 SELECT @Ok = 1
  RETURN 
END
GO


/************** spMovFlujoOrigen *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovFlujoOrigen') and type = 'P') drop procedure dbo.spMovFlujoOrigen
GO
CREATE PROCEDURE spMovFlujoOrigen
                   @Empresa     	char(5),
                   @Modulo		char(5),
		   @ID			int
--//WITH ENCRYPTION
AS BEGIN
  SELECT RTRIM(OMov)+' '+LTRIM(CONVERT(char, OMovID))
    FROM MovFlujo
   WHERE Cancelado = 0 AND Empresa = @Empresa AND DModulo = @Modulo AND DID = @ID
  RETURN 
END
GO

/************** spMovFlujoDestino *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovFlujoDestino') and type = 'P') drop procedure dbo.spMovFlujoDestino
GO
CREATE PROCEDURE spMovFlujoDestino
                   @Empresa     	char(5),
                   @Modulo		char(5),
		   @ID			int
--//WITH ENCRYPTION
AS BEGIN
  SELECT RTRIM(DMov)+' '+LTRIM(CONVERT(char, DMovID))
    FROM MovFlujo
   WHERE Cancelado = 0 AND Empresa = @Empresa AND OModulo = @Modulo AND OID = @ID
  RETURN 
END
GO

/**************** spMovGenerar ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovGenerar') and type = 'P') drop procedure dbo.spMovGenerar
GO             
CREATE PROCEDURE spMovGenerar
			@Sucursal	int,
		    	@Empresa	char(5), 
			@Modulo		char(5), 
			@Ejercicio	int, 
			@Periodo	int,
			@Usuario	char(10), 
			@FechaEmision	datetime, 
			@Estatus	char(15),

			@Almacen	char(10),
		        @AlmacenDestino char(10),

			@Mov		char(20),
			@MovID 		varchar(20), 
			@GenerarDirecto	bit,

			@GenerarMov	char(20),
			@GenerarSerie	char(20),
			@GenerarMovID 	varchar(20)	OUTPUT, 
			@GenerarID	int		OUTPUT,

			@Ok		int		OUTPUT,
			@OkRef		varchar(255)	= NULL OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @ID					int,
    @Moneda				char(10),
    @TipoCambio				float,
    @CFD				bit,
    @CopiarBitacoraOrigen		bit,
    @ArrastrarTipoCambioGenerarMov	bit

  SELECT @CFD = 0
  IF @Ok IS NOT NULL RETURN
  EXEC spExtraerFecha @FechaEmision OUTPUT

  BEGIN TRANSACTION
    EXEC spMovEnID @Modulo, @Empresa, @Mov, @MovID, @ID OUTPUT, @Moneda OUTPUT, @Ok OUTPUT
    SELECT @TipoCambio = TipoCambio FROM Mon WHERE Moneda = @Moneda

    SELECT @CopiarBitacoraOrigen = ISNULL(CopiarBitacoraOrigen, 0),
           @ArrastrarTipoCambioGenerarMov = ISNULL(ArrastrarTipoCambioGenerarMov, 0) 
      FROM EmpresaGral 
     WHERE Empresa = @Empresa

    IF @ArrastrarTipoCambioGenerarMov = 1 OR
       (SELECT ISNULL(ArrastrarTipoCambioGenerarMov, 0) FROM MovTipo WHERE Modulo = @Modulo AND Mov = @GenerarMov) = 1  
      SELECT @TipoCambio = NULL

    IF @Estatus IN ('SINAFECTAR', 'CONFIRMAR', 'BORRADOR')
      SELECT @GenerarMovID = NULL
    ELSE
      EXEC spConsecutivoAuto @Sucursal, @Empresa, @Modulo, @GenerarMov, @Ejercicio, @Periodo, @GenerarSerie, @GenerarMovID OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @CFD OUTPUT

    EXEC spMovCopiarEncabezado @Sucursal, @Modulo, @ID, @Empresa, @Mov, @MovID, @Usuario, @FechaEmision, @Estatus,
			       @Moneda, @TipoCambio, @Almacen, @AlmacenDestino,
			       @GenerarDirecto, @GenerarMov, @GenerarMovID, 
			       @GenerarID OUTPUT, @Ok OUTPUT, @CopiarBitacoraOrigen

    IF @GenerarID IS NOT NULL
      EXEC xpMovGenerar @Sucursal, @Empresa, @Modulo, @ID, @Usuario, @FechaEmision, @Mov, @MovID,
                        @GenerarDirecto, @GenerarMov, @GenerarSerie, @GenerarMovID, @GenerarID, @Ok OUTPUT, @OkRef OUTPUT
  COMMIT TRANSACTION
  RETURN
END
GO

/**************** spMovGenerarSinAfectar ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovGenerarSinAfectar') and type = 'P') drop procedure dbo.spMovGenerarSinAfectar
GO             
CREATE PROCEDURE spMovGenerarSinAfectar
		    	@Empresa	char(5), 
			@Modulo		char(5), 
			@Usuario	char(10),

			@Mov		char(20),
			@MovID 		varchar(20), 
			@GenerarDirecto	bit,

			@GenerarMov	char(20),
    			@ID		int	OUTPUT,
			@GenerarID	int	OUTPUT,

			@Ok		int	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Sucursal		int,
    @GenerarMovID	int,
    @Almacen		char(10),
    @AlmacenDestino 	char(10),
    @FechaEmision	datetime, 
    @Moneda		char(10),
    @TipoCambio		float,
    @Estatus		char(15)

  SELECT @FechaEmision = GETDATE(), @Estatus = 'SINAFECTAR', @GenerarMovID = NULL
  EXEC spExtraerFecha @FechaEmision OUTPUT

  BEGIN TRANSACTION
    EXEC spMovEnID @Modulo, @Empresa, @Mov, @MovID, @ID OUTPUT, @Moneda OUTPUT, @Ok OUTPUT
    SELECT @TipoCambio = TipoCambio FROM Mon WHERE Moneda = @Moneda
    IF (SELECT ISNULL(ArrastrarTipoCambioGenerarMov, 0) FROM EmpresaGral WHERE Empresa = @Empresa) = 1 OR
       (SELECT ISNULL(ArrastrarTipoCambioGenerarMov, 0) FROM MovTipo WHERE Modulo = @Modulo AND Mov = @GenerarMov) = 1 
       SELECT @TipoCambio = NULL

    IF @Modulo = 'VTAS' SELECT @Sucursal = Sucursal, @Almacen = Almacen, @AlmacenDestino = AlmacenDestino FROM Venta  WHERE ID = @ID ELSE
    IF @Modulo = 'PROD' SELECT @Sucursal = Sucursal, @Almacen = Almacen FROM Prod WHERE ID = @ID ELSE
    IF @Modulo = 'INV'  SELECT @Sucursal = Sucursal, @Almacen = Almacen, @AlmacenDestino = AlmacenDestino FROM Inv    WHERE ID = @ID ELSE
    IF @Modulo = 'COMS' SELECT @Sucursal = Sucursal, @Almacen = Almacen FROM Compra WHERE ID = @ID 

    EXEC spMovCopiarEncabezado @Sucursal, @Modulo, @ID, @Empresa, @Mov, @MovID, @Usuario, @FechaEmision, @Estatus,
			       @Moneda, @TipoCambio, @Almacen, @AlmacenDestino,
			       @GenerarDirecto, @GenerarMov, @GenerarMovID, 
			       @GenerarID OUTPUT, @Ok OUTPUT, 0
    COMMIT TRANSACTION
  RETURN
END
GO

-- spMovInfo 1, 'VTAS', @Moneda = @Moneda OUTPUT, 
/**************** spMovInfo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovInfo') and type = 'P') drop procedure dbo.spMovInfo
GO
CREATE PROCEDURE spMovInfo
                        @ID		int 		       OUTPUT,
			@Modulo		char(5),

			@Mov		char(20) 	= NULL OUTPUT,
			@MovID		varchar(20) 	= NULL OUTPUT,
			@Estatus	char(15) 	= NULL OUTPUT,
			@Sucursal	int 		= NULL OUTPUT,
			@UEN		int		= NULL OUTPUT,

			@FechaEmision	datetime	= NULL	OUTPUT,
			@Empresa	char(5)		= NULL 	OUTPUT,
			@CtoTipo	varchar(20)  	= NULL	OUTPUT,
			@Contacto	char(10)	= NULL 	OUTPUT,
			@EnviarA	int		= NULL	OUTPUT,
			@Situacion	varchar(50)	= NULL	OUTPUT,
			@SituacionFecha	datetime	= NULL	OUTPUT,
			@Proyecto	varchar(50)	= NULL	OUTPUT,
			@Concepto	varchar(50)	= NULL	OUTPUT,
			@Referencia	varchar(50)	= NULL	OUTPUT,
			@Usuario	char(10)	= NULL	OUTPUT,
                        @MovTipo	varchar(20)	= NULL	OUTPUT,
			@Ejercicio	int		= NULL	OUTPUT,
			@Periodo	int		= NULL	OUTPUT,
			@FechaCancelacion datetime	= NULL	OUTPUT,
			@Clase		varchar(50)	= NULL	OUTPUT,
			@SubClase	varchar(50)	= NULL	OUTPUT,
			@Causa		varchar(50) 	= NULL	OUTPUT,
			@FormaEnvio	varchar(50) 	= NULL	OUTPUT,
			@Condicion	varchar(50) 	= NULL	OUTPUT,
			@ZonaImpuesto	varchar(30)  	= NULL	OUTPUT,
			@CtaDinero	varchar(10)	= NULL	OUTPUT,
			@Cajero		varchar(10)	= NULL	OUTPUT,
			@Moneda		varchar(10)	= NULL	OUTPUT,
			@TipoCambio 	float 		= NULL	OUTPUT,
   			@SituacionUsuario varchar(10)	= NULL	OUTPUT,
   			@SituacionNota	  varchar(100)	= NULL	OUTPUT,
			@Observaciones	varchar(100)	= NULL	OUTPUT,
			@Importe	money		= NULL	OUTPUT,
			@Impuestos	money		= NULL	OUTPUT,
			@Retenciones	money		= NULL	OUTPUT,
			@Total		money		= NULL	OUTPUT,
			@UltimoCambio	datetime	= NULL	OUTPUT,
			@OrigenTipo	varchar(10)	= NULL	OUTPUT,
			@Origen		varchar(20)	= NULL	OUTPUT,
			@OrigenID	varchar(20)	= NULL	OUTPUT,
			@RamaID		int		= NULL	OUTPUT,
			@Vencimiento	datetime = NULL OUTPUT, --MEJORA5066
			@FechaRegistro	datetime = NULL OUTPUT  --MEJORA5066

--//WITH ENCRYPTION
AS BEGIN
  SELECT @FechaEmision = NULL, @Empresa = NULLIF(@Empresa,''), @Sucursal = NULL, @Estatus = NULL, @Situacion = NULL, @SituacionFecha = NULL, @SituacionUsuario = NULL, @SituacionNota = NULL,
         @UEN = NULL, @CtoTipo = NULL, @Contacto = NULL, @EnviarA = NULL, @Proyecto = NULL, @Concepto = NULL, @Referencia = NULL, @Usuario = NULL,
         @Ejercicio = NULL, @Periodo = NULL, @FechaCancelacion = NULL,
         @Clase = NULL, @SubClase = NULL, @Causa = NULL, @FormaEnvio = NULL, @Condicion = NULL, @Condicion = NULL, @ZonaImpuesto = NULL, 
         @Moneda = NULL, @TipoCambio = NULL, @Cajero = NULL, @CtaDinero = NULL, @Observaciones = NULL, @Importe = NULL, @Impuestos = NULL, @Retenciones = NULL, @Total = NULL,
         @UltimoCambio = NULL, @OrigenTipo = NULL, @Origen = NULL, @OrigenID = NULL, @RamaID = NULL, @Vencimiento = NULL, @FechaRegistro = NULL --MEJORA5066
  IF @ID IS NOT NULL
    SELECT @Mov = NULL, @MovID = NULL
  IF @Modulo = 'VTAS'  SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @CtoTipo = 'Cliente',    @Contacto = Cliente, @EnviarA = EnviarA, @Clase = Clase, @SubClase = SubClase, @Causa = Causa, @FormaEnvio = FormaEnvio, @Condicion = Condicion, @ZonaImpuesto = ZonaImpuesto, @Moneda = Moneda, @TipoCambio = TipoCambio, @CtaDinero = CtaDinero, @Importe = Importe, @Impuestos = Impuestos, @Retenciones = Retencion, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM Venta WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'CXC'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @CtoTipo = 'Cliente',    @Contacto = Cliente, @EnviarA = ClienteEnviarA, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @Cajero = Cajero, @CtaDinero = CtaDinero, @Importe = Importe, @Impuestos = Impuestos, @Retenciones = ISNULL(Retencion, 0.0) + ISNULL(Retencion2, 0.0) + ISNULL(Retencion3, 0.0), @RamaID = RamaID, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM Cxc WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'ST'    SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @CtoTipo = 'Cliente',    @Contacto = Cliente, @EnviarA = EnviarA, @Clase = Clase, @SubClase = SubClase, @Importe = Importe, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM Soporte WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'COMS'  SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @CtoTipo = 'Proveedor',  @Contacto = Proveedor, @Causa = Causa, @FormaEnvio = FormaEnvio, @Condicion = Condicion, @ZonaImpuesto = ZonaImpuesto, @Moneda = Moneda, @TipoCambio = TipoCambio, @Importe = Importe, @Impuestos = Impuestos, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM Compra     WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'CXP'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @CtoTipo = 'Proveedor',  @Contacto = Proveedor, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @Cajero = Cajero, @CtaDinero = CtaDinero, @Importe = Importe, @Impuestos = Impuestos, @Retenciones = ISNULL(Retencion, 0.0) + ISNULL(Retencion2, 0.0) + ISNULL(Retencion3, 0.0), @RamaID = RamaID, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM Cxp WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'AGENT' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @CtoTipo = 'Agente',     @Contacto = Agente, @Moneda = Moneda, @TipoCambio = TipoCambio, @CtaDinero = CtaDinero, @Importe = Importe, @Impuestos = Impuestos, @Retenciones = Retencion, @FechaRegistro = FechaRegistro FROM Agent WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'GAS'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = NULL,     @Referencia = NULL,       @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @CtoTipo = 'Proveedor',  @Contacto = Acreedor, @Clase = Clase, @SubClase = SubClase, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @CtaDinero = CtaDinero, @Importe = Importe, @Impuestos = Impuestos, @Retenciones = Retencion, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM Gasto WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'DIN'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @CtoTipo = ContactoTipo, @Contacto = Contacto, @Moneda = Moneda, @TipoCambio = TipoCambio, @Cajero = Cajero, @CtaDinero = CtaDinero, @Importe = Importe, @Impuestos = Impuestos, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM Dinero WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'AF'    SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @CtoTipo = 'Proveedor',  @Contacto = Proveedor, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @CtaDinero = CtaDinero, @Importe = Importe, @Impuestos = Impuestos, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM ActivoFijo WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'VALE'  SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @CtoTipo = 'Cliente',    @Contacto = Cliente, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @CtaDinero = CtaDinero, @Importe = Importe, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM Vale WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'CR'    SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @CtoTipo = 'Agente',     @Contacto = Cajero, @Moneda = Moneda, @TipoCambio = TipoCambio, @Cajero = Cajero, @FechaRegistro = FechaRegistro FROM CR WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'CAM'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @CtoTipo = 'Cliente',    @Contacto = Cliente, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM Cambio WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'PACTO' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @CtoTipo = ContactoTipo,    @Contacto = (CASE ContactoTipo WHEN 'Cliente' THEN Cliente WHEN 'Prospecto' THEN Prospecto WHEN 'Proveedor' THEN Proveedor WHEN 'Personal' THEN Personal WHEN 'Agente' THEN Agente ELSE NULL END), @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro FROM Contrato WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'CAP'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro FROM Capital WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'INC'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM Incidencia WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'CONC'  SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro FROM Conciliacion WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'PPTO'  SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro FROM Presup WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'CREDI' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM Credito WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'TMA'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @FechaRegistro = FechaRegistro FROM TMA WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'RSS'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @FechaRegistro = FechaRegistro FROM RSS WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'CMP'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @FechaRegistro = FechaRegistro FROM Campana WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'FIS'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro  FROM Fiscal WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  --REQ25014
  IF @Modulo = 'CONTP' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @FechaRegistro = FechaRegistro  FROM ContParalela WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  --REQ16092
  IF @Modulo = 'OPORT' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro, @Importe = ImporteOportunidad FROM Oportunidad WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE  
  IF @Modulo = 'CORTE' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @Vencimiento = NULL, @FechaRegistro = FechaRegistro  FROM Corte WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'FRM'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @FechaRegistro = FechaRegistro FROM FormaExtra WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'CAPT'  SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @FechaRegistro = FechaRegistro FROM Captura WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'GES'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @RamaID = RamaID, @FechaRegistro = FechaRegistro FROM Gestion WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'CP'    SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro  FROM CP WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'PCP'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro  FROM PCP WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE  
  IF @Modulo = 'PROY'  SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro FROM Proyecto WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  --IF @Modulo = 'ACT'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio FROM Act WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  --IF @Modulo = 'MEX01' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra01 WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  --IF @Modulo = 'MEX02' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra02 WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  --IF @Modulo = 'MEX03' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra03 WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  --IF @Modulo = 'MEX04' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra04 WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  --IF @Modulo = 'MEX05' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra05 WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  --IF @Modulo = 'MEX06' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra06 WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  --IF @Modulo = 'MEX07' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra07 WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  --IF @Modulo = 'MEX08' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra08 WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  --IF @Modulo = 'MEX09' SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra09 WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'ORG'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro FROM Organiza WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'RE'    SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro FROM Recluta WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'ISL'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM ISL          WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'CONT'  SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @Importe = Importe, @FechaRegistro = FechaRegistro FROM Cont WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'PROD'  SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @Importe = Importe, @FechaRegistro = FechaRegistro FROM Prod WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'INV'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @FormaEnvio = FormaEnvio, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @Importe = Importe, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM Inv WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'PC'    SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro FROM PC WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'OFER'  SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro FROM Oferta WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'NOM'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = NULL,       @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro FROM Nomina WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'RH'    SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro FROM RH WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'ASIS'  SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = NULL,     @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Moneda = Moneda, @TipoCambio = TipoCambio, @FechaRegistro = FechaRegistro FROM Asiste WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) ELSE
  IF @Modulo = 'EMB'   SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @CtaDinero = CtaDinero, @Importe = Importe, @Impuestos = Impuestos, @Vencimiento = Vencimiento, @FechaRegistro = FechaRegistro FROM Embarque WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) 
  IF @Modulo = 'SAUX'  SELECT @ID = ID, @OrigenTipo = OrigenTipo, @Origen = Origen, @OrigenID = OrigenID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Observaciones = Observaciones, @UltimoCambio = UltimoCambio, @FechaRegistro = FechaRegistro  FROM SAUX WHERE ID = @ID OR (Empresa = ISNULL(@Empresa, Empresa) AND Mov = @Mov AND MovID = @MovID AND Estatus NOT IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR', 'CANCELADO')) 

  SELECT @Total = ISNULL(@Importe, 0.0) + ISNULL(@Impuestos, 0.0) - ISNULL(@Retenciones, 0.0)

  SELECT @MovTipo = Clave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov
  RETURN
END
GO

-- spMovInfoVerEstatus 29, 'VTAS'
/**************** spMovInfoVerEstatus ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovInfoVerEstatus') and type = 'P') drop procedure dbo.spMovInfoVerEstatus
GO
CREATE PROCEDURE spMovInfoVerEstatus
                        @ID		int,
			@Modulo		char(5)
--//WITH ENCRYPTION
AS BEGIN 
  DECLARE
    @Estatus	varchar(15)
  EXEC spMovInfo @ID = @ID OUTPUT, @Modulo = @Modulo, @Estatus = @Estatus OUTPUT
  SELECT 'Estatus' = @Estatus
  RETURN
END
GO

/**************** spMovInfoEstatus ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovInfoEstatus') and type = 'P') drop procedure dbo.spMovInfoEstatus
GO
CREATE PROCEDURE spMovInfoEstatus
                        @ID			int,
						@Modulo		char(5),
						@Estatus	varchar(15) OUTPUT
--//WITH ENCRYPTION
AS BEGIN 

  EXEC spMovInfo @ID = @ID OUTPUT, @Modulo = @Modulo, @Estatus = @Estatus OUTPUT
  
END
GO


-- spMovInfoVerUltimoCambio 125, 'VTAS'
/**************** spMovInfoVerUltimoCambio ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovInfoVerUltimoCambio') and type = 'P') drop procedure dbo.spMovInfoVerUltimoCambio
GO
CREATE PROCEDURE spMovInfoVerUltimoCambio
                        @ID		int,
			@Modulo		char(5)
--//WITH ENCRYPTION
AS BEGIN 
  DECLARE
    @UltimoCambio	datetime
  EXEC spMovInfo @ID, @Modulo, @UltimoCambio = @UltimoCambio OUTPUT
  SELECT 'UltimoCambio' = @UltimoCambio
  RETURN
END
GO

/**************** spMovOpcionVerificar ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovOpcionVerificar') and type = 'P') drop procedure dbo.spMovOpcionVerificar
GO             
CREATE PROCEDURE spMovOpcionVerificar
                    @Modulo			char(5),
                    @ID				int,
					@Renglon		float,
					@RenglonSub		int,
                    @Subcuenta		varchar(50),
                    @Ok             int          OUTPUT,
                    @OkRef          varchar(255) OUTPUT



--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
	@SQL			nvarchar(max),
	@Select			varchar(max),
	@Opciones		varchar(max),
	@OpcionOriginal varchar(2),
	@Opcion			varchar(2)
    
	
  IF NULLIF(@Subcuenta,'') IS NULL RETURN
  SELECT @Select = dbo.fnMovOpcionListaSeleccion(@Subcuenta, 1)
  SELECT @Opciones = REPLACE(REPLACE(REPLACE(@Select, CHAR(39), ''), ',', ''), ' ', '')
  
  SELECT @SQL = 'IF NOT EXISTS(SELECT * FROM tempdb.information_schema.tables WHERE TABLE_NAME LIKE '+ CHAR(39)+ '##TempMovOpcion%'+ CHAR(39) + ')
	               CREATE TABLE ##TempMovOpcion (Estacion int, Opcion varchar(255) COLLATE DATABASE_DEFAULT NULL)
	             ELSE
	               DELETE ##TempMovOpcion WHERE Estacion = @@SPID
	                 
	             INSERT ##TempMovOpcion SELECT @@SPID, Opcion FROM OpcionD WHERE Opcion IN (' + @Select + ') GROUP BY Opcion'
  
  BEGIN TRY
	EXEC sp_executesql @SQL
  END TRY
  BEGIN CATCH
    SELECT @Ok = 1
  END CATCH
  
  DECLARE crOpcionOriginal CURSOR FAST_FORWARD FOR
   SELECT CadenaOriginal
     FROM dbo.fnTextoaTabla(@Opciones, 2)

  OPEN crOpcionOriginal
  FETCH NEXT FROM crOpcionOriginal INTO @OpcionOriginal
  WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
  BEGIN
        
    SELECT @Opcion = NULL

    DECLARE crOpcion CURSOR FAST_FORWARD FOR
     SELECT Opcion
       FROM ##TempMovOpcion
      WHERE Estacion = @@SPID
        AND Opcion = @OpcionOriginal

    OPEN crOpcion
    FETCH NEXT FROM crOpcion INTO @Opcion
    WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
    BEGIN
        
      FETCH NEXT FROM crOpcion INTO @Opcion
    END
  
    CLOSE crOpcion
    DEALLOCATE crOpcion
    IF @OpcionOriginal <> @Opcion
      SELECT @Ok = 20041, @OkRef = @OpcionOriginal
    FETCH NEXT FROM crOpcionOriginal INTO @OpcionOriginal
  END
  
  CLOSE crOpcionOriginal
  DEALLOCATE crOpcionOriginal

  IF EXISTS(SELECT * FROM tempdb.information_schema.tables WHERE TABLE_NAME LIKE '##TempMovOpcion%')
  BEGIN
    DELETE ##TempMovOpcion WHERE Estacion = @@SPID
      
    IF NOT EXISTS(SELECT * FROM ##TempMovOpcion)
      DROP TABLE ##TempMovOpcion
  END

END
GO

/**************** spMovOpcion ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovOpcion') and type = 'P') drop procedure dbo.spMovOpcion
GO             
CREATE PROCEDURE spMovOpcion
                    @Modulo			char(5),
                    @ID				int,
					@Renglon		float,
					@RenglonSub		int,
                    @Subcuenta		varchar(50),
                    @Ok             int          OUTPUT,
                    @OkRef          varchar(255) OUTPUT



--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
	@SQL			nvarchar(max),
	@Insert			varchar(max),
	@Values			varchar(max)
    
	
	IF NULLIF(@Subcuenta,'') IS NULL RETURN
   
	SELECT @Insert = dbo.fnMovOpcionListaSeleccion(@Subcuenta,0)
	SELECT @Values = dbo.fnMovOpcionValores(@Subcuenta)

	SELECT @SQL = 'IF NOT EXISTS(SELECT * FROM MovOpcion WHERE Modulo = ''' + @Modulo + ''' AND ModuloID = ' + CONVERT(varchar,@ID) + ' AND Renglon = ' + CONVERT(varchar,@Renglon) + ' AND RenglonSub = ' + CONVERT(varchar,@RenglonSub) + ')
					BEGIN
                      INSERT MovOpcion (Modulo, ModuloID, Renglon, RenglonSub, ' + @Insert + ') 
                      VALUES (''' + @Modulo + ''', '+ CONVERT(varchar,@ID) + ', ' + CONVERT(varchar,@Renglon) + ', ' + CONVERT(varchar,@Renglonsub) + ', ' + @Values + ')
                    END'

    BEGIN TRY
	  EXEC sp_executesql @SQL
    END TRY
    BEGIN CATCH
      SELECT @Ok = 1
    END CATCH

END
GO

/******************************* spMovPosAscendencia *************************************************/
if exists (select * from sysobjects where id = object_id('dbo.spMovPosAscendencia') and type = 'P') drop procedure dbo.spMovPosAscendencia
GO             
CREATE PROCEDURE spMovPosAscendencia
        @Estacion		int,
        @Modulo			varchar(5),
		@DModulo		varchar(5),
		@DModuloID		int,
		@Nivel			int
		

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @ID					int,
    @OEstatus			varchar(15),
    @OModulo			varchar(5),
    @OModuloID			int,
    @Empresa			varchar(5),
    @Sucursal			int,
    @DEstatus			varchar(15),    
    @DMov				varchar(20),
    @DMovID				varchar(20),
    @OMov				varchar(20),
    @OMovID				varchar(20),
    @Cancelado			bit,
    @EsAcumulativa		bit

  SELECT @Nivel = @Nivel + 1      
  IF NOT EXISTS(SELECT OModulo FROM MovFlujo WHERE DModulo = @DModulo AND DID = @DModuloID) OR @Nivel > 20 RETURN
  
  DECLARE @MovFlujo TABLE
  (
    ID				int					IDENTITY(1,1),
	OModulo			varchar(5)			COLLATE DATABASE_DEFAULT NOT NULL,
    OID				int					NOT NULL,
	OMov			varchar(20)			COLLATE DATABASE_DEFAULT NOT NULL,
	OMovID			varchar(20)			COLLATE DATABASE_DEFAULT NOT NULL,
	DMov			varchar(20)			COLLATE DATABASE_DEFAULT NOT NULL,
	DMovID			varchar(20)			COLLATE DATABASE_DEFAULT NOT NULL,
	Cancelado		bit					NULL DEFAULT 0,
	Sucursal		int					NOT NULL DEFAULT -1,
	Empresa			varchar(5)			COLLATE DATABASE_DEFAULT NOT NULL	  
  )

  INSERT @MovFlujo (OModulo, OID, OMov, OMovID, DMov, DMovID, Cancelado, Empresa, Sucursal)
            SELECT  OModulo, OID, OMov, OMovID, DMov, DMovID, Cancelado, Empresa, ISNULL(Sucursal,-1)
              FROM  MovFlujo
             WHERE  DModulo = @DModulo
               AND  DID = @DModuloID

  EXEC spMovInfoEstatus @DModuloID, @DModulo, @DEstatus OUTPUT           

  IF @Nivel = 1
  BEGIN
    IF NOT EXISTS(SELECT OModulo FROM MovFlujo WHERE DModulo = @DModulo AND DID = @DModuloID) SELECT @EsAcumulativa = 0 ELSE SELECT @EsAcumulativa = 1  
    SELECT TOP 1 @OModulo = '', @OModuloID = '', @OMov = '', @OMovID = '', @DMov = DMov, @DMovID = DMovID, @Cancelado = Cancelado, @Empresa = Empresa, @Sucursal = ISNULL(Sucursal,-1) FROM MovFlujo WHERE DModulo = @DModulo AND DID = @DModuloID    

    INSERT MovPos (Estacion,  Modulo,  Sucursal,  Empresa,  OEstatus,  OModulo,  OID,        OMov,  OMovID,  DEstatus,  DModulo,  DID,        DMov,  DMovID,  Cancelado,  Clave,                                                         Rama, EsAcumulativa,  Movimiento,                                                                             Tipo)
           VALUES (@Estacion, @Modulo, @Sucursal, @Empresa, '',        @OModulo, @OModuloID, @OMov, @OMovID, @DEstatus, @DModulo, @DModuloID, @DMov, @DMovID, @Cancelado, 'ORIGEN' + RTRIM(@DModulo)+RTRIM(CONVERT(varchar,@DModuloID)), NULL, @EsAcumulativa, RTRIM(@DMov) + ' ' + RTRIM(@DMovID) + ' (' + RTRIM(dbo.fnModuloNombre(@DModulo)) + ')', 'ORIGEN')
  END
    
  WHILE (SELECT COUNT(ID) FROM @MovFlujo) > 0
  BEGIN
    
    SELECT TOP 1 @ID = ID, @OModulo = OModulo, @OModuloID = OID, @OMov = OMov, @OMovID = OMovID, @DMov = DMov, @DMovID = DMovID, @Cancelado = Cancelado, @Empresa = Empresa, @Sucursal = ISNULL(Sucursal,-1) FROM @MovFlujo 
    
    EXEC spMovInfoEstatus @OModuloID, @OModulo, @OEstatus OUTPUT     
    
    IF NOT EXISTS(SELECT Estacion FROM MovPos WHERE Estacion = @Estacion AND Modulo = @Modulo AND Tipo = 'ORIGEN' AND OModulo = @OModulo AND OID = @OModuloID AND DModulo = @DModulo AND DID = @DModuloID AND ISNULL(Sucursal,-1) = ISNULL(@Sucursal,-1) AND Empresa = @Empresa)
    BEGIN
      IF NOT EXISTS(SELECT OModulo FROM MovFlujo WHERE DModulo = @OModulo AND DID = @OModuloID) SELECT @EsAcumulativa = 0 ELSE SELECT @EsAcumulativa = 1

      IF NOT EXISTS(SELECT Estacion FROM MovPos WHERE Estacion = @Estacion AND Modulo = @Modulo AND Tipo = 'ORIGEN' AND OModulo = @DModulo AND OID = @DModuloID AND DModulo = @OModulo AND DID = @OModuloID AND Sucursal = @Sucursal AND Empresa = @Empresa)
      INSERT MovPos (Estacion,  Modulo,  Sucursal,  Empresa,  OEstatus,  OModulo,  OID,        OMov,  OMovID,  DEstatus,  DModulo,  DID,        DMov,  DMovID,  Cancelado,  Clave,                                                         Rama,                                                          EsAcumulativa,  Movimiento,                                                                             Tipo)
             VALUES (@Estacion, @Modulo, @Sucursal, @Empresa, @DEstatus, @DModulo, @DModuloID, @DMov, @DMovID, @OEstatus, @OModulo, @OModuloID, @OMov, @OMovID, @Cancelado, 'ORIGEN' + RTRIM(@OModulo)+RTRIM(CONVERT(varchar,@OModuloID)), 'ORIGEN' + RTRIM(@DModulo)+RTRIM(CONVERT(varchar,@DModuloID)), @EsAcumulativa, RTRIM(@OMov) + ' ' + RTRIM(@OMovID) + ' (' + RTRIM(dbo.fnModuloNombre(@OModulo)) + ')', 'ORIGEN')
      
      EXEC spMovPosAscendencia @Estacion, @Modulo, @OModulo, @OModuloID, @Nivel
    END
    
    DELETE FROM @MovFlujo WHERE ID = @ID
  END
             
END
GO

/******************************* spMovPosDescendencia *************************************************/
if exists (select * from sysobjects where id = object_id('dbo.spMovPosDescendencia') and type = 'P') drop procedure dbo.spMovPosDescendencia
GO             
CREATE PROCEDURE spMovPosDescendencia
        @Estacion		int,
        @Modulo			varchar(5),
		@OModulo		varchar(5),
		@OModuloID		int,
		@Nivel			int
		

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @ID					int,
    @OEstatus			varchar(15),
    @DModulo			varchar(5),
    @DModuloID			int,
    @Empresa			varchar(5),
    @Sucursal			int,
    @DEstatus			varchar(15),    
    @DMov				varchar(20),
    @DMovID				varchar(20),
    @OMov				varchar(20),
    @OMovID				varchar(20),
    @Cancelado			bit,
    @EsAcumulativa		bit

  SELECT @Nivel = @Nivel + 1      
  IF NOT EXISTS(SELECT OModulo FROM MovFlujo WHERE OModulo = @OModulo AND OID = @OModuloID) OR @Nivel > 20 RETURN

  DECLARE @MovFlujo TABLE
  (
    ID				int					IDENTITY(1,1),
	DModulo			varchar(5)			COLLATE DATABASE_DEFAULT NOT NULL,
    DID				int					NOT NULL,
	OMov			varchar(20)			COLLATE DATABASE_DEFAULT NOT NULL,
	OMovID			varchar(20)			COLLATE DATABASE_DEFAULT NOT NULL,
	DMov			varchar(20)			COLLATE DATABASE_DEFAULT NOT NULL,
	DMovID			varchar(20)			COLLATE DATABASE_DEFAULT NOT NULL,
	Cancelado		bit					NULL DEFAULT 0,
	Sucursal		int					NOT NULL DEFAULT -1,
	Empresa			varchar(5)			COLLATE DATABASE_DEFAULT NOT NULL	  
  )

  INSERT @MovFlujo (DModulo, DID, OMov, OMovID, DMov, DMovID, Cancelado, Empresa, Sucursal)
            SELECT  DModulo, DID, OMov, OMovID, DMov, DMovID, Cancelado, Empresa, ISNULL(Sucursal,-1)
              FROM  MovFlujo
             WHERE  OModulo = @OModulo
               AND  OID = @OModuloID

  EXEC spMovInfoEstatus @OModuloID, @OModulo, @OEstatus OUTPUT           

  IF @Nivel = 1
  BEGIN
    IF NOT EXISTS(SELECT OModulo FROM MovFlujo WHERE OModulo = @OModulo AND OID = @OModuloID) SELECT @EsAcumulativa = 0 ELSE SELECT @EsAcumulativa = 1  
    SELECT TOP 1 @DModulo = '', @DModuloID = '', @DMov = '', @DMovID = '', @OMov = OMov, @OMovID = OMovID, @Cancelado = Cancelado, @Empresa = Empresa, @Sucursal = ISNULL(Sucursal,-1) FROM MovFlujo WHERE OModulo = @OModulo AND OID = @OModuloID
    
    INSERT MovPos (Estacion,  Modulo,  Sucursal,  Empresa,  OEstatus,  OModulo,  OID,        OMov,  OMovID,  DEstatus,  DModulo,  DID,        DMov,  DMovID,  Cancelado,  Clave,                                                          Rama, EsAcumulativa,  Movimiento,                                                                             Tipo)
           VALUES (@Estacion, @Modulo, @Sucursal, @Empresa, '',        @DModulo, @DModuloID, @DMov, @DMovID, @OEstatus, @OModulo, @OModuloID, @OMov, @OMovID, @Cancelado, 'DESTINO' + RTRIM(@OModulo)+RTRIM(CONVERT(varchar,@OModuloID)), NULL, @EsAcumulativa, RTRIM(@OMov) + ' ' + RTRIM(@OMovID) + ' (' + RTRIM(dbo.fnModuloNombre(@OModulo)) + ')', 'DESTINO')
  END

  WHILE (SELECT COUNT(ID) FROM @MovFlujo) > 0
  BEGIN
    
    SELECT TOP 1 @ID = ID, @DModulo = DModulo, @DModuloID = DID, @OMov = OMov, @OMovID = OMovID, @DMov = DMov, @DMovID = DMovID, @Cancelado = Cancelado, @Empresa = Empresa, @Sucursal = ISNULL(Sucursal,-1) FROM @MovFlujo 
    
    EXEC spMovInfoEstatus @DModuloID, @DModulo, @DEstatus OUTPUT     
    
    IF NOT EXISTS(SELECT Estacion FROM MovPos WHERE Estacion = @Estacion AND Modulo = @Modulo AND Tipo = 'DESTINO' AND OModulo = @OModulo AND OID = @OModuloID AND DModulo = @DModulo AND DID = @DModuloID AND ISNULL(Sucursal,-1) = ISNULL(@Sucursal,-1) AND Empresa = @Empresa)
    BEGIN
      IF NOT EXISTS(SELECT OModulo FROM MovFlujo WHERE OModulo = @DModulo AND OID = @DModuloID) SELECT @EsAcumulativa = 0 ELSE SELECT @EsAcumulativa = 1      
      
    IF NOT EXISTS(SELECT Estacion FROM MovPos WHERE Estacion = @Estacion AND Modulo = @Modulo AND Tipo = 'DESTINO' AND OModulo = @DModulo AND OID = @DModuloID AND DModulo = @OModulo AND DID = @OModuloID AND Sucursal = @Sucursal AND Empresa = @Empresa)
      INSERT MovPos (Estacion,  Modulo,  Sucursal,  Empresa,  OEstatus,  OModulo,  OID,        OMov,  OMovID,  DEstatus,  DModulo,  DID,        DMov,  DMovID,  Cancelado,  Clave,                                                          Rama,                                                           EsAcumulativa,  Movimiento,                                                                             Tipo)
             VALUES (@Estacion, @Modulo, @Sucursal, @Empresa, @OEstatus, @OModulo, @OModuloID, @OMov, @OMovID, @DEstatus, @DModulo, @DModuloID, @DMov, @DMovID, @Cancelado, 'DESTINO' + RTRIM(@DModulo)+RTRIM(CONVERT(varchar,@DModuloID)), 'DESTINO' + RTRIM(@OModulo)+RTRIM(CONVERT(varchar,@OModuloID)), @EsAcumulativa, RTRIM(@DMov) + ' ' + RTRIM(@DMovID) + ' (' + RTRIM(dbo.fnModuloNombre(@DModulo)) + ')', 'DESTINO')

      EXEC spMovPosDescendencia @Estacion, @Modulo, @DModulo, @DModuloID, @Nivel
    END
    
    DELETE FROM @MovFlujo WHERE ID = @ID
  END
             
END
GO

/******************************* spMovPos *************************************************/
if exists (select * from sysobjects where id = object_id('dbo.spMovPos') and type = 'P') drop procedure dbo.spMovPos
GO             
CREATE PROCEDURE spMovPos
        @Estacion		int,
		@MovModulo		varchar(5),
		@MovModuloID	int
		

--//WITH ENCRYPTION
AS BEGIN
  DELETE FROM MovPos WHERE Estacion = @Estacion AND Modulo = @MovModulo
  
  EXEC spMovPosAscendencia @Estacion, @MovModulo, @MovModulo, @MovModuloID, 0
  EXEC spMovPosDescendencia @Estacion, @MovModulo, @MovModulo, @MovModuloID, 0
  
  -- SELECT Estacion, Modulo, Sucursal, Empresa, OModulo, OID, OMov, OMovID, OEstatus, DModulo, DID, DMov, DMovID, DEstatus, Cancelado, Clave, Rama, EsAcumulativa FROM MovPos WHERE Estacion = @Estacion AND Modulo = @Modulo
END
GO

/**************** spMovPutInfo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovPutInfo') and type = 'P') drop procedure dbo.spMovPutInfo
GO
CREATE PROCEDURE spMovPutInfo
                        @ID		int,
			@Modulo		char(5),

			@UEN		int		= NULL,
			@Usuario	varchar(10) 	= NULL,
			@Observaciones	varchar(100)	= NULL,
			@Prioridad	varchar(10)	= NULL
--//WITH ENCRYPTION
AS BEGIN
  SELECT @UEN = NULLIF(@UEN, 0), @Usuario = NULLIF(NULLIF(RTRIM(@Usuario), ''), '0'), @Observaciones = NULLIF(NULLIF(RTRIM(@Observaciones), ''), '0')

  IF @Modulo = 'VTAS'  UPDATE Venta 	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones), Prioridad = ISNULL(@Prioridad, Prioridad) WHERE ID = @ID ELSE
  IF @Modulo = 'PROD'  UPDATE Prod	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones), Prioridad = ISNULL(@Prioridad, Prioridad) WHERE ID = @ID ELSE
  IF @Modulo = 'INV'   UPDATE Inv	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones), Prioridad = ISNULL(@Prioridad, Prioridad) WHERE ID = @ID ELSE
  IF @Modulo = 'COMS'  UPDATE Compra 	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones), Prioridad = ISNULL(@Prioridad, Prioridad) WHERE ID = @ID ELSE
  IF @Modulo = 'GAS'   UPDATE Gasto	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones), Prioridad = ISNULL(@Prioridad, Prioridad) WHERE ID = @ID ELSE
  IF @Modulo = 'DIN'   UPDATE Dinero 	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones), Prioridad = ISNULL(@Prioridad, Prioridad) WHERE ID = @ID ELSE
  IF @Modulo = 'PROY'  UPDATE Proyecto	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones), Prioridad = ISNULL(@Prioridad, Prioridad) WHERE ID = @ID ELSE
  IF @Modulo = 'ST'    UPDATE Soporte 	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones), Prioridad = ISNULL(@Prioridad, Prioridad) WHERE ID = @ID ELSE
  IF @Modulo = 'CXC'   UPDATE Cxc 	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'CXP'   UPDATE Cxp 	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'AGENT' UPDATE Agent 	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'AF'    UPDATE ActivoFijo   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'VALE'  UPDATE Vale 	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'CR'    UPDATE CR	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'CAM'   UPDATE Cambio	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'PACTO' UPDATE Contrato     SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'CAP'   UPDATE Capital	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'INC'   UPDATE Incidencia   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'CONC'  UPDATE Conciliacion SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'PPTO'  UPDATE Presup       SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'CREDI' UPDATE Credito      SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'TMA'   UPDATE TMA	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'RSS'   UPDATE RSS	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'CMP'   UPDATE Campana	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'FIS'   UPDATE Fiscal	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  --REQ25014
  IF @Modulo = 'CONTP' UPDATE ContParalela SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  --REQ16092
  IF @Modulo = 'OPORT' UPDATE Oportunidad  SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE  
  IF @Modulo = 'CORTE' UPDATE Corte	       SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'FRM'   UPDATE FormaExtra   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'CAPT'  UPDATE Captura      SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'GES'   UPDATE Gestion      SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'CP'    UPDATE CP	       SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'PCP'   UPDATE PCP	       SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE  
  --IF @Modulo = 'ACT'   UPDATE Act 	      SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX01' UPDATE ModuloExtra01 SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX02' UPDATE ModuloExtra02 SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX03' UPDATE ModuloExtra03 SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX04' UPDATE ModuloExtra04 SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX05' UPDATE ModuloExtra05 SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX06' UPDATE ModuloExtra06 SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX07' UPDATE ModuloExtra07 SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX08' UPDATE ModuloExtra08 SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX09' UPDATE ModuloExtra09 SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'ORG'   UPDATE Organiza     SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'RE'    UPDATE Recluta	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones), Prioridad = ISNULL(@Prioridad, Prioridad) WHERE ID = @ID ELSE
  IF @Modulo = 'ISL'   UPDATE ISL          SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'CONT'  UPDATE Cont	       SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'PC'    UPDATE PC	       SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'OFER'  UPDATE Oferta	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'NOM'   UPDATE Nomina	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'RH'    UPDATE RH	       SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'ASIS'  UPDATE Asiste	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'EMB'   UPDATE Embarque	   SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID ELSE
  IF @Modulo = 'SAUX'  UPDATE SAUX	       SET UEN = ISNULL(@UEN, UEN), Usuario = ISNULL(@Usuario, Usuario), Observaciones = ISNULL(@Observaciones, Observaciones) WHERE ID = @ID 

  RETURN
END
GO

/**************** spMovInsertar ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovInsertar') and type = 'P') drop procedure dbo.spMovInsertar
GO             
CREATE PROCEDURE spMovInsertar
			@Sucursal	int,
			@Empresa	char(5), 
			@Modulo		char(5), 
			@Mov		char(20), 
			@MovID		varchar(20), 
			@ID		int,
			@Ejercicio	int, 
			@Periodo	int, 
			@FechaRegistro	datetime, 
			@FechaEmision	datetime,
                        @Concepto	varchar(50), 
			@Proyecto	varchar(50), 
			@Moneda		char(10), 
			@TipoCambio	float,
                        @Usuario	char(10), 
			@Autorizacion	char(10), 
			@Referencia	varchar(50), 
			@DocFuente	int, 
			@Observaciones	varchar(255),

			@Ok		int	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Turno		int,
    @Integradora	bit
  -- SET nocount ON

  IF @Ok IS NOT NULL RETURN
  EXEC spExtraerFecha @FechaEmision OUTPUT

  SELECT @Turno = NULL, @Integradora = 0
  EXEC xpMovInsertar @Sucursal, @Empresa, @Modulo, @Mov, @MovID, @ID, @Ejercicio, @Periodo, @FechaRegistro, @FechaEmision, @Concepto, @Proyecto, @Moneda, @TipoCambio, @Usuario, @Autorizacion, @Referencia, @DocFuente, @Observaciones, 
		     @Turno OUTPUT, @Integradora OUTPUT, @Ok OUTPUT

  UPDATE Mov
     SET Sucursal	= @Sucursal,
	 Empresa 	= @Empresa,
	 Modulo	 	= @Modulo, 
	 Mov		= @Mov, 
	 MovID		= @MovID, 
         ID		= @ID,
	 Ejercicio	= @Ejercicio, 
	 Periodo	= @Periodo, 
	 FechaRegistro	= @FechaRegistro,
	 FechaEmision	= @FechaEmision,
         Concepto	= @Concepto, 
	 Proyecto	= @Proyecto, 
	 Moneda		= @Moneda,
	 TipoCambio	= @TipoCambio,
         Usuario	= @Usuario,
	 Autorizacion	= @Autorizacion, 
	 Referencia	= @Referencia,
	 DocFuente	= @DocFuente, 
	 Observaciones	= @Observaciones,
         Turno          = @Turno,
         Integradora	= @Integradora
   WHERE Empresa = @Empresa
     AND Modulo  = @Modulo
     AND ID	 = @ID

  IF @@ROWCOUNT = 0
  BEGIN
    INSERT INTO Mov (Sucursal, Empresa, Modulo, Mov, MovID, ID, Ejercicio, Periodo, FechaRegistro, FechaEmision,
                     Concepto, Proyecto, Moneda, TipoCambio,
                     Usuario, Autorizacion, Referencia, DocFuente, Observaciones, Turno, Integradora)
             VALUES (@Sucursal, @Empresa, @Modulo, @Mov, @MovID, @ID, @Ejercicio, @Periodo, @FechaRegistro, @FechaEmision,
                     @Concepto, @Proyecto, @Moneda, @TipoCambio,
                     @Usuario, @Autorizacion, @Referencia, @DocFuente, @Observaciones, @Turno, @Integradora)

    IF (SELECT TieneMovimientos FROM Usuario WHERE Usuario = @Usuario) = 0
      UPDATE Usuario SET TieneMovimientos = 1 WHERE Usuario = @Usuario 
    IF (SELECT TieneMovimientos FROM Empresa WHERE Empresa = @Empresa) = 0
      UPDATE Empresa SET TieneMovimientos = 1 WHERE Empresa = @Empresa
  END
  IF @@ERROR <> 0 SELECT @Ok = 1

  IF @Ok IS NULL
  BEGIN
    IF @Modulo = 'CONT'  UPDATE Cont         SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'VTAS'  UPDATE Venta        SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'PROD'  UPDATE Prod         SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'COMS'  UPDATE Compra       SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'INV'   UPDATE Inv          SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'CXC'   UPDATE Cxc          SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'CXP'   UPDATE Cxp          SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'AGENT' UPDATE Agent        SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'GAS'   UPDATE Gasto        SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'DIN'   UPDATE Dinero       SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'EMB'   UPDATE Embarque     SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'NOM'   UPDATE Nomina       SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'RH'    UPDATE RH           SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'ASIS'  UPDATE Asiste       SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'AF'    UPDATE ActivoFijo   SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'PC'    UPDATE PC           SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'OFER'  UPDATE Oferta       SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'VALE'  UPDATE Vale         SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'CR'    UPDATE CR           SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'ST'    UPDATE Soporte      SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'CAP'   UPDATE Capital      SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'INC'   UPDATE Incidencia   SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'CONC'  UPDATE Conciliacion SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'PPTO'  UPDATE Presup       SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'CREDI' UPDATE Credito      SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'TMA'   UPDATE TMA          SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'RSS'   UPDATE RSS          SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'CMP'   UPDATE Campana      SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'FIS'   UPDATE Fiscal       SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    --REQ25014
    IF @Modulo = 'CONTP' UPDATE ContParalela SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    --REQ16092
	IF @Modulo = 'OPORT' UPDATE Oportunidad  SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE	
    IF @Modulo = 'CORTE' UPDATE Corte        SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'FRM'   UPDATE FormaExtra   SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'CAPT'  UPDATE Captura      SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'GES'   UPDATE Gestion      SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'CP'    UPDATE CP           SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'PCP'   UPDATE PCP          SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE    
    IF @Modulo = 'PROY'  UPDATE Proyecto     SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    --IF @Modulo = 'ACT'   UPDATE Act           SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX01' UPDATE ModuloExtra01 SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX02' UPDATE ModuloExtra02 SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX03' UPDATE ModuloExtra03 SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX04' UPDATE ModuloExtra04 SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX05' UPDATE ModuloExtra05 SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX06' UPDATE ModuloExtra06 SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX07' UPDATE ModuloExtra07 SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX08' UPDATE ModuloExtra08 SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    --IF @Modulo = 'MEX09' UPDATE ModuloExtra09 SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'ORG'   UPDATE Organiza     SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'RE'    UPDATE Recluta	     SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'ISL'   UPDATE ISL          SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'CAM'   UPDATE Cambio       SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'PACTO' UPDATE Contrato     SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID ELSE
    IF @Modulo = 'SAUX'  UPDATE SAUX         SET FechaRegistro = @FechaRegistro, Periodo = @Periodo, Ejercicio = @Ejercicio WHERE ID = @ID 
  END

  RETURN
END
GO


--- Task 25681
/**************** xpMovOk ****************/
if exists (select * from sysobjects where id = object_id('dbo.xpMovOk') and type = 'P') 
  drop procedure dbo.xpMovOk
GO 
CREATE PROCEDURE xpMovOk
	@SincroFinal		bit,
	@ID			int,
	@Estatus		char(15),
	@Sucursal		int,
	@Accion			char(20),
	@Empresa		char(5),
	@Usuario		char(10),
	@Modulo			char(5),
	@Mov			char(20),
	@FechaAfectacion	datetime,
	@FechaRegistro		datetime,
	@Ejercicio		int,
	@Periodo		int,
	@Proyecto		varchar(50), 
	@Ok			int 		OUTPUT,
	@OkRef			varchar(255) 	OUTPUT

AS BEGIN
  RETURN
END
GO


/**************** spMovOk ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovOk') and type = 'P') drop procedure dbo.spMovOk
GO             
CREATE PROCEDURE spMovOk
		   @SincroFinal		bit,
		   @ID			int,
		   @Estatus		char(15),
		   @Sucursal		int,
                   @Accion		char(20),
		   @Empresa		char(5),
		   @Usuario		char(10),
      		   @Modulo		char(5),
		   @Mov			char(20),
		   @FechaAfectacion	datetime,
                   @FechaRegistro	datetime,
		   @Ejercicio		int,
		   @Periodo		int,
		   @Proyecto		varchar(50),		
		   @Ok			int 		OUTPUT,
		   @OkRef		varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
    @EstatusProyecto	char(15),
    @ValidarFechas	char(20),
    @EjercicioInicio	datetime,
    @EjercicioFinal	datetime,
    @MovTipo		char(20),
    @EjercicioEsp	int,
    @PeriodoEsp		int,
    @CFD			bit, --Cambio CFD Flexible
    @CFDFlex		bit  --Cambio CFD Flexible


  IF (SELECT COUNT(0) FROM Empresa WHERE Empresa = ISNULL(@Empresa,'')) = 0 SET @Ok = 26070
  IF (SELECT COUNT(0) FROM Sucursal WHERE Sucursal = @Sucursal) = 0 SET @Ok = 72060
  IF (SELECT COUNT(0) FROM Usuario WHERE Usuario = ISNULL(@Usuario,'')) = 0 SET @Ok = 71020

  IF @SincroFinal = 0 AND @Estatus IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR') AND @Modulo <> 'CONT'
    EXEC spSincroSemillaOk @Modulo, @ID, @Mov, @Ok OUTPUT, @OkRef OUTPUT

  IF @Accion = 'GENERAR' RETURN
  EXEC spExtraerFecha @FechaAfectacion OUTPUT
  EXEC spExtraerFecha @FechaRegistro OUTPUT

  SELECT @ValidarFechas = NULL
  SELECT @ValidarFechas = NULLIF(UPPER(RTRIM(ValidarFechas)), '')
    FROM EmpresaCfgModulo 
   WHERE Empresa = @Empresa
     AND Modulo  = @Modulo

  IF @FechaAfectacion > DATEADD(month, 1, @FechaRegistro) 
  BEGIN
    SELECT @MovTipo = Clave 
      FROM MovTipo
     WHERE Modulo = @Modulo AND Mov = @Mov
    
    IF RIGHT(@MovTipo, 3) <> '.PR' AND RIGHT(@MovTipo, 4) <> '.EST' AND @Modulo NOT IN ('CONT', 'FIS', 'GAS', 'CORTE') AND @MovTipo NOT IN ('VTAS.P', 'VTAS.S', 'GAS.S', 'CXC.DP', 'CXC.NCP','CXP.DP', 'CXP.NCP', 'DIN.SD', 'DIN.D', 'DIN.DE', 'DIN.SCH', 'DIN.CH', 'DIN.CHE', 'AF.DP', 'AF.DT', 'AF.RV', 'GAS.DPR', 'CXC.INT', 'CXP.INT', 'NOM.NE') 
    BEGIN
      SELECT @Ok = 60170
      IF EXISTS(SELECT Empresa FROM EmpresaGral WHERE Empresa = @Empresa AND (AC = 1 OR Ford = 1 OR Chrysler = 1))-- Hay que quitar esto
        SELECT @Ok = NULL
    END
  END

  IF @ValidarFechas <> 'NO' AND NOT EXISTS(SELECT * FROM EmpresaCfgValidarFechasEx WHERE Empresa = @Empresa AND Modulo = @Modulo AND Mov = @Mov) AND @Accion NOT IN ('RESERVAR', 'DESRESERVAR', 'RESERVARPARCIAL', 'ASIGNAR', 'DESASIGNAR')
  BEGIN
    IF @ValidarFechas = 'EJERCICIO'
    BEGIN
      SELECT @EjercicioInicio = EjercicioInicio, @EjercicioFinal = EjercicioFinal
        FROM EmpresaGral
       WHERE Empresa = @Empresa
      EXEC spExtraerFecha @EjercicioInicio OUTPUT
      EXEC spExtraerFecha @EjercicioFinal OUTPUT
      IF @FechaAfectacion NOT BETWEEN @EjercicioInicio AND @EjercicioFinal SELECT @Ok = 50050
    END 

    IF @ValidarFechas = 'DENTRO DEL MES' 
      IF DATEPART(yy, @FechaAfectacion) <> DATEPART(yy, @FechaRegistro) OR
         DATEPART(mm, @FechaAfectacion) <> DATEPART(mm, @FechaRegistro) SELECT @Ok = 60170

    IF @ValidarFechas = 'NO ADELANTARSE'
      IF @FechaAfectacion > @FechaRegistro SELECT @Ok = 60170

    IF @ValidarFechas = 'MISMO DIA' 
      IF @FechaAfectacion <> @FechaRegistro SELECT @Ok = 60170

    IF @ValidarFechas = 'CIERRE DIARIO'
      IF @FechaAfectacion <> ISNULL((SELECT FechaTrabajo FROM FechaTrabajo WHERE Empresa = @Empresa AND Sucursal = @Sucursal), @FechaRegistro) SELECT @Ok = 60175
  END

/** AR 9.3.2007 se agrego para que valide un Periodo Cerrado de acuerdo a la configuracion de Periodos Especiales*/
  SELECT @PeriodoEsp = NULL, @EjercicioEsp = NULL
  EXEC spPeriodoEjercicio @Empresa, @Modulo, @FechaAfectacion, @PeriodoEsp OUTPUT, @EjercicioEsp OUTPUT, @Ok OUTPUT
  IF @PeriodoEsp IS NOT NULL AND @EjercicioEsp IS NOT NULL
    SELECT @Periodo = @PeriodoEsp, @Ejercicio = @EjercicioEsp
/** AR 9.3.2007 **/

  IF @Accion <> 'GENERAR' AND @Ok IS NULL 
    IF EXISTS (SELECT * 
                 FROM CerrarPeriodo 
                WHERE Empresa = @Empresa 
                  AND Rama = @Modulo
                  AND Ejercicio = @Ejercicio
                  AND Periodo = @Periodo)
	IF @Accion <> 'CANCELAR' OR NOT EXISTS(SELECT * FROM EmpresaCfgCancelarMov WHERE Empresa = @Empresa AND Modulo = @Modulo AND Mov = @Mov)
          SELECT @Ok = 60110   			-- Periodo Cerrado
  IF @@ERROR <> 0 SELECT @Ok = 1

  IF NULLIF(RTRIM(@Proyecto), '') IS NOT NULL AND @Ok IS NULL AND @Accion <> 'CANCELAR'
  BEGIN
    SELECT @EstatusProyecto = Estatus FROM Proy WHERE Proyecto = @Proyecto
    IF @EstatusProyecto = 'BLOQUEADO' SELECT @Ok = 26010 ELSE
    IF @EstatusProyecto = 'BAJA'      SELECT @Ok = 26020  
  END

  IF @Accion = 'CANCELAR'
    IF EXISTS(SELECT * FROM UsuarioMovCancelacionEx WHERE Usuario = @Usuario AND Modulo = @Modulo AND Mov = @Mov)
      SELECT @Ok = 20766

  IF @Accion IN ('VERIFICAR', 'AFECTAR') AND @Estatus IN ('SINAFECTAR', 'BORRADOR', 'EMAIL', 'CONFIRMAR')  AND @Ok IS NULL
  BEGIN
    EXEC spMovTipoCFD @Empresa, @Modulo, @Mov, @CFD OUTPUT, @CFDFlex OUTPUT --Cambio CFD Flexible

    IF @Modulo = 'CXC' AND (SELECT OrigenTipo FROM CXC WHERE ID = @ID) = 'VTAS'
       SELECT @CFD = 0

    IF @CFD = 1 AND ISNULL(@CFDFlex,0) = 0 --Cambio CFD Flexible
      EXEC spGenerarCFD NULL, @Modulo, @ID, NULL, @Validar = 1, @Ok = @Ok OUTPUT, @OkRef = @OkRef OUTPUT
  END

--- Task 25681
  EXEC xpMovOk @SincroFinal, @ID, @Estatus, @Sucursal, @Accion, @Empresa, @Usuario, @Modulo, @Mov, 
               @FechaAfectacion, @FechaRegistro, @Ejercicio, @Periodo, @Proyecto, @Ok OUTPUT, @OkRef OUTPUT

  RETURN
END
GO

/*
DECLARE
  @CostoMovPersonal money
exec spMovPersonalCosto 'INV', 16, 1.0, @CostoMovPersonal OUTPUT
select @CostoMovPersonal
*/
/**************** spMovPersonalCosto ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovPersonalCosto') and type = 'P') drop procedure dbo.spMovPersonalCosto
GO             
CREATE PROCEDURE spMovPersonalCosto
			@Modulo			char(5),
			@ID			int,
			@TipoCambio		float,
			@CostoMovPersonal	float	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  SELECT @CostoMovPersonal = SUM(p.SueldoDiario*m.TipoCambio*mp.Cantidad/j.HorasPromedio)/@TipoCambio
   FROM MovPersonal mp
   JOIN Personal p ON p.Personal = mp.Personal
   JOIN Jornada j ON j.Jornada = p.Jornada
   JOIN Mon m ON m.Moneda = p.Moneda
  WHERE mp.Modulo = @Modulo AND mp.ModuloID = @ID
  RETURN
END
GO

-- select Usuario,* from dbo.fnMovReg('VTAS', 104)
/**************** fnMovReg ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnMovReg' AND type = 'TF') DROP FUNCTION fnMovReg
GO
CREATE FUNCTION fnMovReg (@Modulo char(5), @ID int)
RETURNS @Resultado 
  TABLE (Modulo char(5), ID int, Mov char(20), MovID varchar(20), Estatus char(15), Sucursal int, UEN int, FechaEmision datetime, Empresa char(5), CtoTipo varchar(20), Contacto char(10), EnviarA int, 
         Situacion varchar(50), SituacionFecha datetime, SituacionUsuario varchar(10), SituacionNota varchar(100), Proyecto varchar(50), Concepto varchar(50), Referencia varchar(50), Usuario char(10), MovTipo varchar(20), Ejercicio int, Periodo int, 
         FechaCancelacion datetime, Clase varchar(50), SubClase varchar(50), Causa varchar(50), FormaEnvio varchar(50), Condicion varchar(50), ZonaImpuesto varchar(30), CtaDinero varchar(10), 
         Cajero varchar(10), Moneda varchar(10), TipoCambio float, Deudor char(10), Acreedor char(10), Personal char(10), Agente char(10), Importe money, ImporteMN money, ContID int)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Mov		char(20),
    @MovID		varchar(20),
    @Estatus		char(15),
    @Sucursal		int,
    @UEN		int,
    @FechaEmision	datetime,
    @Empresa		char(5),
    @CtoTipo		varchar(20),
    @Contacto		char(10),
    @EnviarA		int,
    @Deudor		char(10),
    @Acreedor		char(10),
    @Personal		char(10),
    @Agente		char(10),
    @Situacion		varchar(50),
    @SituacionFecha	datetime,
    @SituacionUsuario	varchar(10),
    @SituacionNota	varchar(100),
    @Proyecto		varchar(50),
    @Concepto		varchar(50),
    @Referencia		varchar(50),
    @Usuario		char(10),
    @MovTipo		varchar(20),
    @Ejercicio		int,
    @Periodo		int,
    @FechaCancelacion 	datetime,
    @Clase		varchar(50),
    @SubClase		varchar(50),
    @Causa		varchar(50),
    @FormaEnvio		varchar(50),
    @Condicion		varchar(50),
    @ZonaImpuesto	varchar(30),
    @CtaDinero		varchar(10),
    @Cajero		varchar(10),
    @Moneda		varchar(10),
    @TipoCambio 	float,
    @Importe		money,
    @ImporteMN		money,
    @ContID		int,
    @AutoEndoso		varchar(10)

  IF @ID IS NOT NULL
    SELECT @Mov = NULL, @MovID = NULL

  IF @Modulo = 'VTAS'  SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @CtoTipo = 'Cliente',    @Contacto = Cliente,   @EnviarA = EnviarA, @Clase = Clase, @SubClase = SubClase, @Causa = Causa, @FormaEnvio = FormaEnvio, @Condicion = Condicion, @ZonaImpuesto = ZonaImpuesto, @Moneda = Moneda, @TipoCambio = TipoCambio, @CtaDinero = CtaDinero, @Agente = Agente, @Importe = Importe FROM Venta WHERE ID = @ID ELSE
  IF @Modulo = 'CXC'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @CtoTipo = 'Cliente',    @Contacto = Cliente,   @EnviarA = ClienteEnviarA, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @Cajero = Cajero, @CtaDinero = CtaDinero, @Agente = Agente, @Importe = Importe FROM Cxc WHERE ID = @ID ELSE
  IF @Modulo = 'ST'    SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @CtoTipo = 'Cliente',    @Contacto = Cliente,   @EnviarA = EnviarA, @Clase = Clase, @SubClase = SubClase, @Agente = Agente, @Importe = Importe FROM Soporte WHERE ID = @ID ELSE
  IF @Modulo = 'COMS'  SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @CtoTipo = 'Proveedor',  @Contacto = Proveedor, @Causa = Causa, @FormaEnvio = FormaEnvio, @Condicion = Condicion, @ZonaImpuesto = ZonaImpuesto, @Moneda = Moneda, @TipoCambio = TipoCambio, @Agente = Agente, @Importe = Importe FROM Compra WHERE ID = @ID ELSE
  IF @Modulo = 'CXP'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @CtoTipo = 'Proveedor',  @Contacto = Proveedor, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @Cajero = Cajero, @CtaDinero = CtaDinero, @Importe = Importe FROM Cxp WHERE ID = @ID ELSE
  IF @Modulo = 'AGENT' SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @CtoTipo = 'Agente',     @Contacto = Agente,    @Moneda = Moneda, @TipoCambio = TipoCambio, @CtaDinero = CtaDinero, @Importe = Importe FROM Agent WHERE ID = @ID ELSE
  IF @Modulo = 'GAS'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = NULL,     @Referencia = NULL,       @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @CtoTipo = 'Proveedor',  @Contacto = Acreedor,  @Clase = Clase, @SubClase = SubClase, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @CtaDinero = CtaDinero, @Importe = Importe FROM Gasto WHERE ID = @ID ELSE
  IF @Modulo = 'DIN'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @CtoTipo = ContactoTipo, @Contacto = Contacto,  @Moneda = Moneda, @TipoCambio = TipoCambio, @Cajero = Cajero, @CtaDinero = CtaDinero, @Importe = Importe FROM Dinero WHERE ID = @ID ELSE
  IF @Modulo = 'AF'    SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @CtoTipo = 'Proveedor',  @Contacto = Proveedor, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @CtaDinero = CtaDinero, @Importe = Importe FROM ActivoFijo WHERE ID = @ID ELSE
  IF @Modulo = 'VALE'  SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @CtoTipo = 'Cliente',    @Contacto = Cliente,   @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @CtaDinero = CtaDinero, @Agente = Agente, @Importe = Importe FROM Vale WHERE ID = @ID ELSE
  IF @Modulo = 'CR'    SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @CtoTipo = 'Agente',     @Contacto = Cajero,    @Moneda = Moneda, @TipoCambio = TipoCambio, @Cajero = Cajero FROM CR WHERE ID = @ID  ELSE
  IF @Modulo = 'CAM'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @CtoTipo = 'Cliente',    @Contacto = Cliente,   @Agente = Agente FROM Cambio WHERE ID = @ID ELSE
  IF @Modulo = 'PACTO' SELECT @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @CtoTipo = ContactoTipo,    @Contacto = (CASE ContactoTipo WHEN 'Cliente' THEN Cliente WHEN 'Prospecto' THEN Prospecto WHEN 'Proveedor' THEN Proveedor WHEN 'Personal' THEN Personal WHEN 'Agente' THEN Agente ELSE NULL END),   @Agente = Agente, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Contrato WHERE ID = @ID ELSE
  IF @Modulo = 'CAP'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Capital WHERE ID = @ID ELSE
  IF @Modulo = 'INC'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Incidencia WHERE ID = @ID ELSE
  IF @Modulo = 'CONC'  SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Conciliacion WHERE ID = @ID ELSE
  IF @Modulo = 'PPTO'  SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Presup WHERE ID = @ID ELSE
  IF @Modulo = 'CREDI' SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Credito WHERE ID = @ID ELSE
  IF @Modulo = 'TMA'   SELECT /*@ContID = ContID, */@FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN FROM TMA WHERE ID = @ID ELSE
  IF @Modulo = 'RSS'   SELECT /*@ContID = ContID, */@FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN FROM RSS WHERE ID = @ID ELSE
  IF @Modulo = 'CMP'   SELECT /*@ContID = ContID, */@FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN FROM Campana WHERE ID = @ID ELSE
  IF @Modulo = 'FIS'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Fiscal WHERE ID = @ID ELSE
  --REQ25014
  IF @Modulo = 'CONTP' SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN FROM ContParalela WHERE ID = @ID ELSE
  --REQ16092
  IF @Modulo = 'OPORT' SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Oportunidad WHERE ID = @ID ELSE
  IF @Modulo = 'CORTE' SELECT @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN FROM Corte WHERE ID = @ID ELSE
  IF @Modulo = 'FRM'   SELECT /*@ContID = ContID, */@FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN FROM FormaExtra WHERE ID = @ID ELSE
  IF @Modulo = 'CAPT'  SELECT /*@ContID = ContID, */@FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN FROM Captura WHERE ID = @ID ELSE
  IF @Modulo = 'GES'   SELECT /*@ContID = ContID, */@FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN FROM Gestion WHERE ID = @ID ELSE
  IF @Modulo = 'CP'    SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM CP WHERE ID = @ID ELSE
  IF @Modulo = 'PCP'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM PCP WHERE ID = @ID ELSE  
  IF @Modulo = 'PROY'  SELECT /*@ContID = ContID, */@FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Proyecto WHERE ID = @ID ELSE
  --IF @Modulo = 'ACT'   SELECT /*@ContID = ContID, */@FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN FROM Act WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX01' SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra01 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX02' SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra02 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX03' SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra03 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX04' SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra04 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX05' SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra05 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX06' SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra06 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX07' SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra07 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX08' SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra08 WHERE ID = @ID ELSE
  --IF @Modulo = 'MEX09' SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ModuloExtra09 WHERE ID = @ID ELSE
  IF @Modulo = 'ORG'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Organiza WHERE ID = @ID ELSE
  IF @Modulo = 'RE'    SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Recluta WHERE ID = @ID ELSE
  IF @Modulo = 'ISL'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, /*@Proyecto = Proyecto, */@Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM ISL          WHERE ID = @ID ELSE
  IF @Modulo = 'CONT'  SELECT /*@ContID = ContID, */@FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio, @Importe = Importe, @CtoTipo = ContactoTipo, @Contacto = Contacto FROM Cont WHERE ID = @ID ELSE
  IF @Modulo = 'PROD'  SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio, @Importe = Importe FROM Prod WHERE ID = @ID ELSE
  IF @Modulo = 'INV'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @FormaEnvio = FormaEnvio, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @Agente = Agente, @Importe = Importe FROM Inv WHERE ID = @ID ELSE
  IF @Modulo = 'PC'    SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM PC WHERE ID = @ID ELSE
  IF @Modulo = 'OFER'  SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Oferta WHERE ID = @ID ELSE
  IF @Modulo = 'NOM'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = NULL,       @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Nomina WHERE ID = @ID ELSE
  IF @Modulo = 'RH'    SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM RH WHERE ID = @ID ELSE
  IF @Modulo = 'ASIS'  SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = NULL,     @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Moneda = Moneda, @TipoCambio = TipoCambio FROM Asiste WHERE ID = @ID ELSE
  IF @Modulo = 'EMB'   SELECT @ContID = ContID, @FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN, @Condicion = Condicion, @Moneda = Moneda, @TipoCambio = TipoCambio, @CtaDinero = CtaDinero, @Agente = Agente, @Importe = Importe FROM Embarque WHERE ID = @ID ELSE
  IF @Modulo = 'SAUX'  SELECT /*@ContID = ContID, */@FechaEmision = FechaEmision, @FechaCancelacion = FechaCancelacion, @Ejercicio = Ejercicio, @Periodo = Periodo, @Empresa = Empresa, @Usuario = Usuario, @Proyecto = Proyecto, @Concepto = Concepto, @Referencia = Referencia, @Sucursal = Sucursal, @Mov = Mov, @MovID = MovID, @Estatus = Estatus, @Situacion = Situacion, @SituacionFecha = SituacionFecha, @SituacionUsuario = SituacionUsuario, @SituacionNota = SituacionNota, @UEN = UEN FROM SAUX WHERE ID = @ID ELSE

  IF @Modulo = 'COMS' AND (SELECT CompraAutoEndoso FROM EmpresaCfg WHERE Empresa = @Empresa) = 1
  BEGIN
    SELECT @AutoEndoso = NULL
    SELECT @AutoEndoso = NULLIF(RTRIM(AutoEndoso), '') FROM Prov WHERE Proveedor = @Contacto
    IF @AutoEndoso IS NOT NULL SELECT @Contacto = @AutoEndoso
  END

  SELECT @MovTipo = Clave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov

  IF @CtoTipo = 'Cliente'   SELECT @Deudor   = @Contacto ELSE
  IF @CtoTipo = 'Proveedor' SELECT @Acreedor = @Contacto ELSE
  IF @CtoTipo = 'Agente'    SELECT @Agente   = @Contacto ELSE
  IF @CtoTipo = 'Personal'  SELECT @Personal = @Contacto 

  SELECT @ImporteMN = @Importe * @TipoCambio

  INSERT @Resultado (
          Modulo,  ID,  Mov,  MovID,  Estatus,  Sucursal,  UEN,  FechaEmision,  Empresa,  CtoTipo,  Contacto,  EnviarA,  Situacion,  SituacionFecha,  SituacionUsuario,  SituacionNota,  Proyecto,  Concepto,  Referencia,  Usuario,  MovTipo,  Ejercicio,  Periodo,  FechaCancelacion,  Clase,  SubClase,  Causa,  FormaEnvio,  Condicion,  ZonaImpuesto,  CtaDinero,  Cajero,  Moneda,  TipoCambio,  Deudor,  Acreedor,  Personal,  Agente,  Importe,  ImporteMN,  ContID)
  VALUES (@Modulo, @ID, @Mov, @MovID, @Estatus, @Sucursal, @UEN, @FechaEmision, @Empresa, @CtoTipo, @Contacto, @EnviarA, @Situacion, @SituacionFecha, @SituacionUsuario, @SituacionNota, @Proyecto, @Concepto, @Referencia, @Usuario, @MovTipo, @Ejercicio, @Periodo, @FechaCancelacion, @Clase, @SubClase, @Causa, @FormaEnvio, @Condicion, @ZonaImpuesto, @CtaDinero, @Cajero, @Moneda, @TipoCambio, @Deudor, @Acreedor, @Personal, @Agente, @Importe, @ImporteMN, @ContID)

  RETURN
END
GO

/**************** spMovReg ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovReg') and type = 'P') drop procedure dbo.spMovReg
GO
CREATE PROCEDURE spMovReg
			@Modulo			char(5),
                        @ID			int,
			@UnicamenteActualizar	bit = 0
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Existe	bit

  SELECT @Existe = 0
  IF EXISTS(SELECT * FROM MovReg WHERE Modulo = @Modulo AND ID = @ID)
    SELECT @Existe = 1
  IF @Existe = 0 AND @UnicamenteActualizar = 0
    INSERT MovReg (
           Modulo,  ID, Mov, MovID, Estatus, Sucursal, UEN, FechaEmision, Empresa, CtoTipo, Contacto, EnviarA, Situacion, SituacionFecha, SituacionUsuario, SituacionNota, Proyecto, Concepto, Referencia, Usuario, MovTipo, Ejercicio, Periodo, FechaCancelacion, Clase, SubClase, Causa, FormaEnvio, Condicion, ZonaImpuesto, CtaDinero, Cajero, Moneda, TipoCambio, Deudor, Acreedor, Personal, Agente)
    SELECT Modulo,  ID, Mov, MovID, Estatus, Sucursal, UEN, FechaEmision, Empresa, CtoTipo, Contacto, EnviarA, Situacion, SituacionFecha, SituacionUsuario, SituacionNota, Proyecto, Concepto, Referencia, Usuario, MovTipo, Ejercicio, Periodo, FechaCancelacion, Clase, SubClase, Causa, FormaEnvio, Condicion, ZonaImpuesto, CtaDinero, Cajero, Moneda, TipoCambio, Deudor, Acreedor, Personal, Agente
      FROM dbo.fnMovReg(@Modulo, @ID)

  IF @Existe = 1 AND @UnicamenteActualizar = 1
    UPDATE MovReg
       SET Mov = r.Mov, MovID = r.MovID, Estatus = r.Estatus, Sucursal = r.Sucursal, UEN = r.UEN, FechaEmision = r.FechaEmision, Empresa = r.Empresa, 
           CtoTipo = r.CtoTipo, Contacto = r.Contacto, EnviarA = r.EnviarA, Situacion = r.Situacion, SituacionFecha = r.SituacionFecha, SituacionUsuario = r.SituacionUsuario, SituacionNota = r.SituacionNota, Proyecto = r.Proyecto, 
           Concepto = r.Concepto, Referencia = r.Referencia, Usuario = r.Usuario, MovTipo = r.MovTipo, Ejercicio = r.Ejercicio, Periodo = r.Periodo, FechaCancelacion = r.FechaCancelacion, 
           Clase = r.Clase, SubClase = r.SubClase, Causa = r.Causa, FormaEnvio = r.FormaEnvio, Condicion = r.Condicion, ZonaImpuesto = r.ZonaImpuesto, CtaDinero = r.CtaDinero, 
           Cajero = r.Cajero, Moneda = r.Moneda, TipoCambio = r.TipoCambio, Deudor = r.Deudor, Acreedor = r.Acreedor, Personal = r.Personal, Agente = r.Agente
      FROM dbo.fnMovReg(@Modulo, @ID) r, MovReg m
     WHERE m.Modulo = @Modulo AND m.ID = @ID

  UPDATE Mov
     SET Concepto = r.Concepto, Proyecto = r.Proyecto, Referencia = r.Referencia
    FROM dbo.fnMovReg(@Modulo, @ID) r, Mov m
   WHERE m.Empresa = r.Empresa AND m.Modulo = @Modulo AND m.ID = @ID

  RETURN
END
GO

/**************** fnMovDReg ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnMovDReg' AND type = 'TF') DROP FUNCTION fnMovDReg
GO
/**************** spMovDRegDatos ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovDRegDatos') and type = 'P') drop procedure dbo.spMovDRegDatos
GO
CREATE PROCEDURE spMovDRegDatos
			@Modulo			char(5),
                        @ID			int,
			@Renglon 		float, 
			@RenglonSub 		int,
			@RenglonID 		int		OUTPUT,
			@RenglonTipo 		char(1)		OUTPUT,
			@UEN			int		OUTPUT,
			@Almacen 		char(10)	OUTPUT,
			@Codigo 		varchar(30)	OUTPUT,
			@Articulo 		varchar(20)	OUTPUT,
			@SubCuenta 		varchar(50)	OUTPUT,
			@Concepto		varchar(50)	OUTPUT,
			@Personal		varchar(10)	OUTPUT,
			@Cantidad 		float		OUTPUT,
			@Unidad 		varchar(50)	OUTPUT,
			@Factor 		float		OUTPUT,
			@CantidadInventario 	float		OUTPUT,
			@Costo 			float		OUTPUT,
			@CostoInv 		float		OUTPUT,
			@CostoActividad 	float		OUTPUT,
			@Precio 		float		OUTPUT,
			@DescuentoTipo 		char(1)		OUTPUT,
			@DescuentoLinea 	float		OUTPUT,
			@DescuentoImporte 	money		OUTPUT,
			@Impuesto1 		float		OUTPUT,
			@Impuesto2 		float		OUTPUT,
			@Impuesto3 		float		OUTPUT,
			@Retencion1 		float		OUTPUT,
			@Retencion2 		float		OUTPUT,
			@Retencion3 		float		OUTPUT,
			@DescripcionExtra 	varchar(100)	OUTPUT,
			@Paquete 		int		OUTPUT,
			@ContUso 		varchar(20)	OUTPUT,
			@Comision 		money		OUTPUT,
			@Aplica 		varchar(20)	OUTPUT,
			@AplicaID 		varchar(20)	OUTPUT,
			@DestinoTipo		varchar(10)	OUTPUT,
			@Destino 		varchar(20)	OUTPUT,
			@DestinoID 		varchar(20)	OUTPUT,
			@Cliente		varchar(10)	OUTPUT,
			@Agente 		varchar(10)	OUTPUT,
			@Departamento 		int		OUTPUT,
			@Espacio 		varchar(10)	OUTPUT,
			@Estado 		varchar(30)	OUTPUT,
			@AFArticulo 		varchar(20)	OUTPUT,
			@AFSerie 		varchar(50)	OUTPUT, -- BUG12333
			@CostoUEPS 		money		OUTPUT,
			@CostoPEPS 		money		OUTPUT,
			@UltimoCosto 		money		OUTPUT,
			@PrecioLista 		money		OUTPUT,
			@Posicion 		varchar(10)	OUTPUT,
			@DepartamentoDetallista int		OUTPUT,
			@SerieLote		varchar(50)	OUTPUT,
			@Producto		varchar(20)	OUTPUT,
			@SubProducto		varchar(50)	OUTPUT,
			@Merma			float		OUTPUT,
			@Desperdicio		float		OUTPUT,
			@Tipo			varchar(20)	OUTPUT,
			@Ruta			varchar(20)	OUTPUT,
			@Fecha			datetime	OUTPUT,
			@Importe		money		OUTPUT,
			@Impuestos		money		OUTPUT,
			@Provision		money		OUTPUT,
			@Depreciacion		money		OUTPUT,
			@DescuentoRecargos	money		OUTPUT,
			@InteresesOrdinarios	money		OUTPUT,
			@InteresesMoratorios	money		OUTPUT,
			@Porcentaje		float		OUTPUT,
			@FormaPago		varchar(50)	OUTPUT,
			@Referencia		varchar(50)	OUTPUT,
			@Proyecto		varchar(50)	OUTPUT,
			@Actividad		varchar(50)	OUTPUT,
			@Cuenta			varchar(20)	OUTPUT,
			@CtoTipo		varchar(20)	OUTPUT,
			@Contacto		varchar(10)	OUTPUT,
			@ObligacionFiscal	varchar(50)	OUTPUT,
			@Tasa			float		OUTPUT,
			@Base			money		OUTPUT,
			@ABC			varchar(50)	= NULL OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  SELECT @RenglonSub = ISNULL(@RenglonSub, 0)

  IF @Modulo = 'VTAS'  SELECT @RenglonID = RenglonID, @RenglonTipo = RenglonTipo, @UEN = UEN, @Almacen = Almacen, @Codigo = Codigo, @Articulo = Articulo, @SubCuenta = SubCuenta, @Cantidad = Cantidad, @Unidad = Unidad, @Factor = Factor, @CantidadInventario = CantidadInventario, @Costo = Costo, @CostoActividad = CostoActividad, @Precio = Precio,  @DescuentoTipo = DescuentoTipo,  @DescuentoLinea = DescuentoLinea,  @DescuentoImporte = DescuentoImporte, @Impuesto1 = Impuesto1,  @Impuesto2 = Impuesto2,  @Impuesto3 = Impuesto3, @Retencion1 = Retencion1, @Retencion2 = Retencion2, @Retencion3 = Retencion3,  @DescripcionExtra = DescripcionExtra, @Paquete = Paquete, @ContUso = ContUso, @Comision = Comision, @Aplica = Aplica, @AplicaID = AplicaID, @Agente = Agente, @Departamento = Departamento, @Espacio = Espacio, @Estado = Estado, @AFArticulo = AFArticulo, @AFSerie = AFSerie, @CostoUEPS = CostoUEPS, @CostoPEPS = CostoPEPS, @UltimoCosto = UltimoCosto, @PrecioLista = PrecioLista, @Posicion = Posicion, @DepartamentoDetallista = DepartamentoDetallista, @ABC = ABC FROM VentaD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub ELSE --MEJORA4648
  IF @Modulo = 'CXC'   SELECT @Importe = Importe, @Aplica = Aplica, @AplicaID = AplicaID, @Fecha = Fecha, @Comision = Comision, @DescuentoRecargos = DescuentoRecargos, @InteresesOrdinarios = InteresesOrdinarios, @InteresesMoratorios = InteresesMoratorios FROM CxcD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub ELSE
  IF @Modulo = 'CXP'   SELECT @Importe = Importe, @Aplica = Aplica, @AplicaID = AplicaID, @Fecha = Fecha, @DescuentoRecargos = DescuentoRecargos, @InteresesOrdinarios = InteresesOrdinarios, @InteresesMoratorios = InteresesMoratorios FROM CxpD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub ELSE
  IF @Modulo = 'FIS'   SELECT @ObligacionFiscal = ObligacionFiscal, @Importe = Importe, @Tasa = Tasa, @CtoTipo = ContactoTipo, @Contacto = Contacto, @AFArticulo = AFArticulo, @AFSerie = AFSerie FROM FiscalD WHERE ID = @ID AND Renglon = @Renglon ELSE
  IF @Modulo = 'ST'    SELECT @Aplica = Aplica, @AplicaID = AplicaID FROM SoporteD WHERE ID = @ID AND Renglon = @Renglon ELSE
  IF @Modulo = 'COMS'  SELECT @RenglonID = RenglonID, @RenglonTipo = RenglonTipo, @Almacen = Almacen, @Codigo = Codigo, @Articulo = Articulo, @SubCuenta = SubCuenta, @Cantidad = Cantidad, @Unidad = Unidad, @Factor = Factor, @CantidadInventario = CantidadInventario, @Costo = Costo, @CostoInv = CostoInv, @DescuentoTipo = DescuentoTipo, @DescuentoLinea = DescuentoLinea, @DescuentoImporte = DescuentoImporte, @Impuesto1 = Impuesto1, @Impuesto2 = Impuesto2, @Impuesto3 = Impuesto3, @Retencion1 = Retencion1, @Retencion2 = Retencion2, @Retencion3 = Retencion3, @DescripcionExtra = DescripcionExtra, @Paquete = Paquete, @ContUso = ContUso, @Aplica = Aplica, @AplicaID = AplicaID, @DestinoTipo = DestinoTipo, @Destino = Destino, @DestinoID = DestinoID, @Cliente = Cliente, @CostoUEPS = CostoUEPS, @CostoPEPS = CostoPEPS, @UltimoCosto = UltimoCosto, @PrecioLista = PrecioLista, @Posicion = Posicion, @DepartamentoDetallista = DepartamentoDetallista, @ABC = ABC FROM CompraD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub ELSE
  IF @Modulo = 'AGENT' SELECT @Importe = Importe, @Aplica = Aplica, @AplicaID = AplicaID FROM AgentD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub ELSE
  IF @Modulo = 'GAS'   SELECT @Concepto = Concepto, @Fecha = Fecha, @Referencia = Referencia, @Cantidad = Cantidad, @Precio = Precio, @Importe = Importe, @Retencion1 = Retencion, @Retencion2 = Retencion2, @Retencion3 = Retencion3, @Impuestos = Impuestos, @ContUso = ContUso, @Espacio = Espacio, @Actividad = Actividad, @Proyecto = Proyecto, @UEN = UEN, @SerieLote = VIN, @DescripcionExtra = DescripcionExtra, @AFArticulo = AFArticulo, @AFSerie = AFSerie, @Porcentaje = PorcentajeDeducible, @Provision = Provision, @Personal = Personal, @ABC = ABC FROM GastoD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub ELSE
  IF @Modulo = 'DIN'   SELECT @Importe = Importe, @FormaPago = FormaPago, @Referencia = Referencia, @Aplica = Aplica, @AplicaID = AplicaID FROM DineroD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub ELSE
  IF @Modulo = 'AF'    SELECT @Articulo = Articulo, @SerieLote = Serie, @Importe = Importe, @Impuestos = Impuestos, @Depreciacion = Depreciacion FROM ActivoFijoD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub ELSE
/*  IF @Modulo = 'VALE'  
  IF @Modulo = 'CR'    
  IF @Modulo = 'CAM'   
  IF @Modulo = 'CAP'   
  IF @Modulo = 'INC'   
  IF @Modulo = 'TMA'   
  IF @Modulo = 'RSS'   
  IF @Modulo = 'CMP'   
  IF @Modulo = 'PROY'   
  IF @Modulo = 'CONT'  
  IF @Modulo = 'RH'    
  IF @Modulo = 'ASIS'  
  IF @Modulo = 'EMB'   */
  IF @Modulo = 'PROD'  SELECT @RenglonID = RenglonID, @RenglonTipo = RenglonTipo, @Almacen = Almacen, @Codigo = Codigo, @Articulo = Articulo, @SubCuenta = SubCuenta, @Cantidad = Cantidad, @Unidad = Unidad, @Factor = Factor, @CantidadInventario = CantidadInventario, @Costo = Costo, @SerieLote = ProdSerieLote, @Paquete = Paquete, @DestinoTipo = DestinoTipo, @Destino = Destino, @DestinoID = DestinoID, @Aplica = Aplica, @AplicaID = AplicaID, @Cliente = Cliente, @Ruta = Ruta, @DescripcionExtra = DescripcionExtra, @Tipo = Tipo, @Comision = Comision, @Personal = Personal, @CostoUEPS = CostoUEPS, @CostoPEPS = CostoPEPS, @UltimoCosto = UltimoCosto, @PrecioLista = PrecioLista, @Posicion = Posicion, @DepartamentoDetallista = DepartamentoDetallista FROM ProdD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub ELSE
  IF @Modulo = 'INV'   SELECT @RenglonID = RenglonID, @RenglonTipo = RenglonTipo, @Cantidad = Cantidad, @Almacen = Almacen, @Codigo = Codigo, @Articulo = Articulo, @SubCuenta = SubCuenta, @Costo = Costo, @CostoInv = CostoInv, @ContUso = ContUso, @Espacio = Espacio, @Paquete = Paquete, @Aplica = Aplica, @AplicaID = AplicaID, @DestinoTipo = DestinoTipo, @Destino = Destino, @DestinoID = DestinoID, @Cliente = Cliente, @Unidad = Unidad, @Factor = Factor, @CantidadInventario = CantidadInventario, @SerieLote = ProdSerieLote, @Merma = Merma, @Desperdicio = Desperdicio, @Producto = Producto, @SubProducto = SubProducto, @Tipo = Tipo, @Precio = Precio, @DescripcionExtra = DescripcionExtra, @CostoUEPS = CostoUEPS, @CostoPEPS = CostoPEPS, @UltimoCosto = UltimoCosto, @PrecioLista = PrecioLista, @Posicion = Posicion, @DepartamentoDetallista = DepartamentoDetallista FROM InvD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub ELSE
  IF @Modulo = 'NOM'   SELECT @Personal = Personal, @Cuenta = Cuenta, @Importe = Importe, @Cantidad = Cantidad, @Concepto = Concepto, @Referencia = Referencia, @FormaPago = FormaPago, @Porcentaje = Porcentaje, @ContUso = ContUso FROM NominaD WHERE ID = @ID AND Renglon = @Renglon ELSE
  IF @Modulo = 'PC'    SELECT @Articulo = Articulo, @SubCuenta = SubCuenta, @Precio = Nuevo FROM PCD WHERE ID = @ID AND Renglon = @Renglon 

  RETURN
END
GO

/**************** spMovDReg ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovDReg') and type = 'P') drop procedure dbo.spMovDReg
GO
CREATE PROCEDURE spMovDReg
			@Modulo			char(5),
                        @ID			int,
			@Renglon 		float, 
			@RenglonSub 		int,
			@UnicamenteActualizar	bit = 0
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Existe			bit,
    @RenglonID 			int,
    @RenglonTipo 		char(1),
    @UEN			int,
    @Almacen 			char(10),
    @Codigo 			varchar(30),
    @Articulo 			varchar(20),
    @SubCuenta 			varchar(50),
    @Concepto			varchar(50),
    @Personal			varchar(10),
    @Cantidad 			float,
    @Unidad 			varchar(50),
    @Factor 			float,
    @CantidadInventario 	float,
    @Costo 			float,
    @CostoInv 			float,
    @CostoActividad 		float,
    @Precio 			float,
    @DescuentoTipo 		char(1),
    @DescuentoLinea 		float,
    @DescuentoImporte 		money,
    @Impuesto1 			float,
    @Impuesto2 			float,
    @Impuesto3 			float,
    @Retencion1 		float,
    @Retencion2 		float,
    @Retencion3 		float,
    @DescripcionExtra 		varchar(100),
    @Paquete 			int,
    @ContUso 			varchar(20),
    @Comision 			money,
    @Aplica 			varchar(20),
    @AplicaID 			varchar(20),
    @DestinoTipo		varchar(10),
    @Destino 			varchar(20),
    @DestinoID 			varchar(20),
    @Cliente			varchar(10),
    @Agente 			varchar(10),
    @Departamento 		int,
    @Espacio 			varchar(10),
    @Estado 			varchar(30),
    @AFArticulo 		varchar(20),
    @AFSerie			varchar(50),	-- BUG12333
    @CostoUEPS 			float,
    @CostoPEPS 			float,
    @UltimoCosto 		float,
    @PrecioLista 		float,
    @Posicion 			varchar(10),
    @DepartamentoDetallista 	int,
    @SerieLote			varchar(50),
    @Producto			varchar(20),
    @SubProducto		varchar(50),
    @Merma			float,
    @Desperdicio		float,
    @Tipo			varchar(20),
    @Ruta			varchar(20),
    @Fecha			datetime,
    @Importe			money,
    @Impuestos			money,
    @Provision			money,
    @Depreciacion		money,
    @DescuentoRecargos		money,
    @InteresesOrdinarios	money,    
    @InteresesMoratorios	money,
    @Porcentaje			float,    
    @FormaPago			varchar(50),
    @Referencia			varchar(50),
    @Proyecto			varchar(50),
    @Actividad			varchar(50),
    @Cuenta			varchar(20),
    @CtoTipo			varchar(20),
    @Contacto			varchar(10),
    @ObligacionFiscal		varchar(50),
    @Tasa			float,
    @ABC			varchar(50),
    @Base			money

  SELECT @Existe = 0, @RenglonSub = ISNULL(@RenglonSub, 0)
  IF EXISTS(SELECT * FROM MovDReg WHERE Modulo = @Modulo AND ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub)
    SELECT @Existe = 1

  EXEC spMovDRegDatos @Modulo, @ID, @Renglon, @RenglonSub,
		      @RenglonID OUTPUT, @RenglonTipo OUTPUT, @UEN OUTPUT,@Almacen OUTPUT, @Codigo OUTPUT, 
		      @Articulo OUTPUT, @SubCuenta OUTPUT, @Concepto OUTPUT, @Personal OUTPUT, @Cantidad OUTPUT, @Unidad OUTPUT, @Factor OUTPUT, @CantidadInventario OUTPUT,
		      @Costo OUTPUT, @CostoInv OUTPUT, @CostoActividad OUTPUT, @Precio OUTPUT, @DescuentoTipo OUTPUT, @DescuentoLinea OUTPUT, @DescuentoImporte OUTPUT,
		      @Impuesto1 OUTPUT, @Impuesto2 OUTPUT, @Impuesto3 OUTPUT, @Retencion1 OUTPUT, @Retencion2 OUTPUT,@Retencion3 OUTPUT,
		      @DescripcionExtra OUTPUT, @Paquete OUTPUT, @ContUso OUTPUT, @Comision OUTPUT, @Aplica OUTPUT, @AplicaID OUTPUT, 
		      @DestinoTipo OUTPUT, @Destino OUTPUT, @DestinoID OUTPUT, @Cliente OUTPUT, @Agente OUTPUT, @Departamento OUTPUT, @Espacio OUTPUT,
		      @Estado OUTPUT,  @AFArticulo OUTPUT, @AFSerie OUTPUT, @CostoUEPS OUTPUT, @CostoPEPS OUTPUT, @UltimoCosto OUTPUT, @PrecioLista OUTPUT,
		      @Posicion OUTPUT,  @DepartamentoDetallista OUTPUT, @SerieLote OUTPUT, @Producto OUTPUT, @SubProducto OUTPUT, @Merma OUTPUT, @Desperdicio OUTPUT,
		      @Tipo OUTPUT, @Ruta OUTPUT, @Fecha OUTPUT, @Importe OUTPUT, @Impuestos OUTPUT, @Provision OUTPUT, @Depreciacion OUTPUT, @DescuentoRecargos OUTPUT,
		      @InteresesOrdinarios OUTPUT, @InteresesMoratorios OUTPUT, @Porcentaje OUTPUT, @FormaPago OUTPUT, @Referencia OUTPUT, @Proyecto OUTPUT,
		      @Actividad OUTPUT,  @Cuenta OUTPUT, @CtoTipo OUTPUT, @Contacto OUTPUT, @ObligacionFiscal OUTPUT, @Tasa OUTPUT, @Base OUTPUT, @ABC OUTPUT

  IF @Existe = 0 AND @UnicamenteActualizar = 0
    INSERT MovDReg (
            Modulo,  ID,  Renglon,  RenglonSub,  RenglonID,  RenglonTipo,  UEN,  Concepto,  Personal,  Almacen,  Codigo,  Articulo,  SubCuenta,  Cantidad,  Unidad,  Factor,  CantidadInventario,  Costo,  CostoInv,  CostoActividad,  Precio,  DescuentoTipo,  DescuentoLinea,  DescuentoImporte,  Impuesto1,  Impuesto2,  Impuesto3,  Retencion1,  Retencion2,  Retencion3,  DescripcionExtra,  Paquete,  ContUso,  Comision,  Aplica,  AplicaID,  DestinoTipo,  Destino,  DestinoID,  Cliente,  Agente,  Departamento,  Espacio,  Estado,  AFArticulo,  AFSerie,  CostoUEPS,  CostoPEPS,  UltimoCosto,  PrecioLista,  Posicion,  DepartamentoDetallista,  SerieLote,  Producto,  SubProducto,  Merma,  Desperdicio,  Tipo,  Ruta,  Fecha,  Importe,  Porcentaje,  Impuestos,  Provision,  Depreciacion,  DescuentoRecargos,  InteresesOrdinarios,  InteresesMoratorios,  FormaPago,  Referencia,  Proyecto,  Actividad,  Cuenta,  CtoTipo,  Contacto,  ObligacionFiscal,  Tasa,  ABC)
    VALUES (@Modulo, @ID, @Renglon, @RenglonSub, @RenglonID, @RenglonTipo, @UEN, @Concepto, @Personal, @Almacen, @Codigo, @Articulo, @SubCuenta, @Cantidad, @Unidad, @Factor, @CantidadInventario, @Costo, @CostoInv, @CostoActividad, @Precio, @DescuentoTipo, @DescuentoLinea, @DescuentoImporte, @Impuesto1, @Impuesto2, @Impuesto3, @Retencion1, @Retencion2, @Retencion3, @DescripcionExtra, @Paquete, @ContUso, @Comision, @Aplica, @AplicaID, @DestinoTipo, @Destino, @DestinoID, @Cliente, @Agente, @Departamento, @Espacio, @Estado, @AFArticulo, @AFSerie, @CostoUEPS, @CostoPEPS, @UltimoCosto, @PrecioLista, @Posicion, @DepartamentoDetallista, @SerieLote, @Producto, @SubProducto, @Merma, @Desperdicio, @Tipo, @Ruta, @Fecha, @Importe, @Porcentaje, @Impuestos, @Provision, @Depreciacion, @DescuentoRecargos, @InteresesOrdinarios, @InteresesMoratorios, @FormaPago, @Referencia, @Proyecto, @Actividad, @Cuenta, @CtoTipo, @Contacto, @ObligacionFiscal, @Tasa, @ABC)

  IF @Existe = 1 AND @UnicamenteActualizar = 1
    UPDATE MovDReg
       SET RenglonID = @RenglonID,  RenglonTipo = @RenglonTipo,  UEN = @UEN,  Concepto = @Concepto,  Personal = @Personal,  Almacen = @Almacen,  Codigo = @Codigo,  
	   Articulo = @Articulo,  SubCuenta = @SubCuenta,  Cantidad = @Cantidad,  Unidad = @Unidad,  Factor = @Factor,  CantidadInventario = @CantidadInventario,  Costo = @Costo,  CostoInv = @CostoInv,  CostoActividad = @CostoActividad,  
	   Precio = @Precio,  DescuentoTipo = @DescuentoTipo,  DescuentoLinea = @DescuentoLinea,  DescuentoImporte = @DescuentoImporte,  Impuesto1 = @Impuesto1,  Impuesto2 = @Impuesto2,  Impuesto3 = @Impuesto3,  
	   Retencion1 = @Retencion1,  Retencion2 = @Retencion2,  Retencion3 = @Retencion3,  DescripcionExtra = @DescripcionExtra,  Paquete = @Paquete,  ContUso = @ContUso,  Comision = @Comision,  
	   Aplica = @Aplica,  AplicaID = @AplicaID,  DestinoTipo = @DestinoTipo,  Destino = @Destino,  DestinoID = @DestinoID,  Cliente = @Cliente,  Agente = @Agente,  
	   Departamento = @Departamento,  Espacio = @Espacio,  Estado = @Estado,  AFArticulo = @AFArticulo,  AFSerie = @AFSerie,  CostoUEPS = @CostoUEPS,  CostoPEPS = @CostoPEPS,  UltimoCosto = @UltimoCosto,  PrecioLista = @PrecioLista,  Posicion = @Posicion,  
	   DepartamentoDetallista = @DepartamentoDetallista,  SerieLote = @SerieLote,  Producto = @Producto,  SubProducto = @SubProducto,  Merma = @Merma,  Desperdicio = @Desperdicio,  Tipo = @Tipo,  Ruta = @Ruta,  
	   Fecha = @Fecha,  Importe = @Importe,  Porcentaje = @Porcentaje,  Impuestos = @Impuestos,  Provision = @Provision,  Depreciacion = @Depreciacion,  
	   DescuentoRecargos = @DescuentoRecargos,  InteresesOrdinarios = @InteresesOrdinarios,  InteresesMoratorios = @InteresesMoratorios, 
	   FormaPago = @FormaPago,  Referencia = @Referencia,  Proyecto = @Proyecto,  Actividad = @Actividad,  Cuenta = @Cuenta,
	   CtoTipo = @CtoTipo, Contacto = @Contacto, ObligacionFiscal = @ObligacionFiscal, Tasa = @Tasa, ABC = @ABC
     WHERE Modulo = @Modulo AND ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub
  RETURN
END
GO

/**************** spMovSincro ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovSincro') and type = 'P') drop procedure dbo.spMovSincro
GO
CREATE PROCEDURE spMovSincro
                        @ID		int,
			@Modulo		char(5),
			@SincroID	timestamp	OUTPUT,
			@SincroC	int		OUTPUT
--//WITH ENCRYPTION
AS BEGIN
DECLARE
  @SQL nvarchar(max)
  SELECT @SincroID = NULL, @SincroC = 0
  IF (SELECT Sincro FROM Version) = 0 RETURN
  SELECT @SQL = N'SELECT @SincroID = SincroID, @SincroC = SincroC FROM '+dbo.fnMovTabla(@Modulo)+'  WHERE ID = @ID'
  EXEC sp_executesql @SQL,
                     N'@SincroID timestamp, @SincroC int, @ID int', @SincroID = @SincroID, @SincroC = @SincroC, @ID = @ID
/*
  IF @Modulo = 'CONT'  SELECT @SincroID = SincroID, @SincroC = SincroC FROM Cont         WHERE ID = @ID ELSE
  IF @Modulo = 'VTAS'  SELECT @SincroID = SincroID, @SincroC = SincroC FROM Venta        WHERE ID = @ID ELSE
  IF @Modulo = 'PROD'  SELECT @SincroID = SincroID, @SincroC = SincroC FROM Prod         WHERE ID = @ID ELSE
  IF @Modulo = 'INV'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Inv          WHERE ID = @ID ELSE
  IF @Modulo = 'COMS'  SELECT @SincroID = SincroID, @SincroC = SincroC FROM Compra       WHERE ID = @ID ELSE
  IF @Modulo = 'CXC'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Cxc          WHERE ID = @ID ELSE
  IF @Modulo = 'CXP'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Cxp          WHERE ID = @ID ELSE
  IF @Modulo = 'AGENT' SELECT @SincroID = SincroID, @SincroC = SincroC FROM Agent        WHERE ID = @ID ELSE
  IF @Modulo = 'GAS'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Gasto        WHERE ID = @ID ELSE
  IF @Modulo = 'DIN'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Dinero       WHERE ID = @ID ELSE
  IF @Modulo = 'AF'    SELECT @SincroID = SincroID, @SincroC = SincroC FROM ActivoFijo   WHERE ID = @ID ELSE
  IF @Modulo = 'PC'    SELECT @SincroID = SincroID, @SincroC = SincroC FROM PC           WHERE ID = @ID ELSE
  IF @Modulo = 'OFER'  SELECT @SincroID = SincroID, @SincroC = SincroC FROM Oferta       WHERE ID = @ID ELSE
  IF @Modulo = 'VALE'  SELECT @SincroID = SincroID, @SincroC = SincroC FROM Vale         WHERE ID = @ID ELSE
  IF @Modulo = 'CR'    SELECT @SincroID = SincroID, @SincroC = SincroC FROM CR           WHERE ID = @ID ELSE
  IF @Modulo = 'NOM'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Nomina       WHERE ID = @ID ELSE
  IF @Modulo = 'RH'    SELECT @SincroID = SincroID, @SincroC = SincroC FROM RH           WHERE ID = @ID ELSE
  IF @Modulo = 'ASIS'  SELECT @SincroID = SincroID, @SincroC = SincroC FROM Asiste       WHERE ID = @ID ELSE
  IF @Modulo = 'EMB'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Embarque     WHERE ID = @ID ELSE
  IF @Modulo = 'ST'    SELECT @SincroID = SincroID, @SincroC = SincroC FROM Soporte      WHERE ID = @ID ELSE
  IF @Modulo = 'CAP'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Capital      WHERE ID = @ID ELSE
  IF @Modulo = 'INC'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Incidencia   WHERE ID = @ID ELSE
  IF @Modulo = 'CONC'  SELECT @SincroID = SincroID, @SincroC = SincroC FROM Conciliacion WHERE ID = @ID ELSE
  IF @Modulo = 'PPTO'  SELECT @SincroID = SincroID, @SincroC = SincroC FROM Presup       WHERE ID = @ID ELSE
  IF @Modulo = 'CREDI' SELECT @SincroID = SincroID, @SincroC = SincroC FROM Credito	     WHERE ID = @ID ELSE
  IF @Modulo = 'TMA'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM TMA          WHERE ID = @ID ELSE
  IF @Modulo = 'RSS'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM RSS          WHERE ID = @ID ELSE
  IF @Modulo = 'CMP'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Campana      WHERE ID = @ID ELSE
  IF @Modulo = 'FIS'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Fiscal       WHERE ID = @ID ELSE
  IF @Modulo = 'FRM'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM FormaExtra   WHERE ID = @ID ELSE
  IF @Modulo = 'CAPT'  SELECT @SincroID = SincroID, @SincroC = SincroC FROM Captura      WHERE ID = @ID ELSE
  IF @Modulo = 'GES'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Gestion      WHERE ID = @ID ELSE
  IF @Modulo = 'CP'    SELECT @SincroID = SincroID, @SincroC = SincroC FROM CP           WHERE ID = @ID ELSE
  IF @Modulo = 'PCP'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM PCP          WHERE ID = @ID ELSE  
  IF @Modulo = 'PROY'  SELECT @SincroID = SincroID, @SincroC = SincroC FROM Proyecto     WHERE ID = @ID ELSE
--IF @Modulo = 'ACT'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Act           WHERE ID = @ID ELSE
--IF @Modulo = 'MEX01' SELECT @SincroID = SincroID, @SincroC = SincroC FROM ModuloExtra01 WHERE ID = @ID ELSE
--IF @Modulo = 'MEX02' SELECT @SincroID = SincroID, @SincroC = SincroC FROM ModuloExtra02 WHERE ID = @ID ELSE
--IF @Modulo = 'MEX03' SELECT @SincroID = SincroID, @SincroC = SincroC FROM ModuloExtra03 WHERE ID = @ID ELSE
--IF @Modulo = 'MEX04' SELECT @SincroID = SincroID, @SincroC = SincroC FROM ModuloExtra04 WHERE ID = @ID ELSE
--IF @Modulo = 'MEX05' SELECT @SincroID = SincroID, @SincroC = SincroC FROM ModuloExtra05 WHERE ID = @ID ELSE
--IF @Modulo = 'MEX06' SELECT @SincroID = SincroID, @SincroC = SincroC FROM ModuloExtra06 WHERE ID = @ID ELSE
--IF @Modulo = 'MEX07' SELECT @SincroID = SincroID, @SincroC = SincroC FROM ModuloExtra07 WHERE ID = @ID ELSE
--IF @Modulo = 'MEX08' SELECT @SincroID = SincroID, @SincroC = SincroC FROM ModuloExtra08 WHERE ID = @ID ELSE
--IF @Modulo = 'MEX09' SELECT @SincroID = SincroID, @SincroC = SincroC FROM ModuloExtra09 WHERE ID = @ID ELSE
--IF @Modulo = 'ORG'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Organiza WHERE ID = @ID ELSE
--IF @Modulo = 'RE'    SELECT @SincroID = SincroID, @SincroC = SincroC FROM Recluta WHERE ID = @ID ELSE
--IF @Modulo = 'ISL'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM ISL          WHERE ID = @ID ELSE
  IF @Modulo = 'CAM'   SELECT @SincroID = SincroID, @SincroC = SincroC FROM Cambio       WHERE ID = @ID */
  RETURN
END
GO

/************** spMovSituacionNuevaAfectar *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovSituacionNuevaAfectar') and type = 'P') drop procedure dbo.spMovSituacionNuevaAfectar
GO
CREATE PROCEDURE spMovSituacionNuevaAfectar
		    @Modulo		char(5),
		    @ID			int,
		    @SituacionNueva 	varchar(50)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @SQL	nvarchar(4000)

  IF (SELECT Sincro FROM Version) = 1
    SELECT @SQL = N'UPDATE '+dbo.fnMovTabla(@Modulo)+' SET Situacion = @SituacionNueva, SituacionFecha = NULL, SituacionUsuario = NULL, SituacionNota = NULL, SincroC = SincroC WHERE ID = @ID'
  ELSE
    SELECT @SQL = N'UPDATE '+dbo.fnMovTabla(@Modulo)+' SET Situacion = @SituacionNueva, SituacionFecha = NULL, SituacionUsuario = NULL, SituacionNota = NULL WHERE ID = @ID'

  EXEC sp_executesql @SQL, N'@SituacionNueva varchar(50), @ID int', @SituacionNueva, @ID
  RETURN 
END
GO

-- 11464
/**************** fnMovSituacionBinariaCondicionesTexto ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnMovSituacionBinariaCondicionesTexto') DROP FUNCTION fnMovSituacionBinariaCondicionesTexto
GO
CREATE FUNCTION fnMovSituacionBinariaCondicionesTexto(
				@ID				int,
				@Operador		varchar(10),
				@Condicional	bit
				)
RETURNS varchar(max)
AS
BEGIN

  DECLARE @Resultado			varchar(max), --BUG20151 = 'Si',
		  @RID					int,
		  @RIDAnt				int,
		  @Expresion1			varchar(255),
		  @Expresion2			varchar(255),
		  @Expresion3			varchar(255),
		  @OperadorCondicion	varchar(20)

  --BUG20151
  SELECT @Resultado = 'Si'

  IF ISNULL(@Condicional, 0) = 0
    SELECT @Resultado = ''
  ELSE
  BEGIN
    IF @Operador = 'Todas'
      SELECT @Operador = '<Y>'
    ELSE IF @Operador = 'Alguna'
      SELECT @Operador = '<O>'
    
    SELECT @RIDAnt = 0
    WHILE(1=1)
    BEGIN
      SELECT @RID = MIN(RID)
        FROM MovSituacionBinariaCondicion
       WHERE ID = @ID
         AND RID > @RIDAnt

      IF @RID IS NULL BREAK
    
      SELECT @RIDAnt = @RID

      SELECT @Expresion1 = REPLACE(REPLACE(ISNULL(Expresion1, ''), '<', ''), '>', ''), @Expresion2 = ISNULL(Expresion2, ''), @Expresion3 = ISNULL(Expresion3, ''), @OperadorCondicion = ISNULL(Operador, '')
        FROM MovSituacionBinariaCondicion
       WHERE ID = @ID
         AND RID = @RID    
  
      IF @OperadorCondicion = 'Entre'
        SELECT @Resultado = @Resultado + ' (' + @Expresion1 + ' Entre ''' + @Expresion2 + ''' y ''' + @Expresion3 + ''') ' + @Operador
      ELSE IF @OperadorCondicion = 'Igual que'
        SELECT @Resultado = @Resultado + ' (' + @Expresion1 + ' = ''' + @Expresion2 + ''') ' + @Operador
      ELSE IF @OperadorCondicion = 'Mayor o igual que'
        SELECT @Resultado = @Resultado + ' (' + @Expresion1 + ' >= ''' + @Expresion2 + ''') ' + @Operador
      ELSE IF @OperadorCondicion = 'Menor o igual que'
        SELECT @Resultado = @Resultado + ' (' + @Expresion1 + ' <= ''' + @Expresion2 + ''') ' + @Operador
      ELSE IF @OperadorCondicion = 'Mayor que'
        SELECT @Resultado = @Resultado + ' (' + @Expresion1 + ' > ''' + @Expresion2 + ''') ' + @Operador
      ELSE IF @OperadorCondicion = 'Menor que'
        SELECT @Resultado = @Resultado + ' (' + @Expresion1 + ' < ''' + @Expresion2 + ''') ' + @Operador
      ELSE IF @OperadorCondicion = 'Distinto que'
        SELECT @Resultado = @Resultado + ' (' + @Expresion1 + ' <> ''' + @Expresion2 + ''') '  + @Operador
      ELSE IF @OperadorCondicion = 'Contiene'
        SELECT @Resultado = @Resultado + ' (' + @Expresion1 + ' Contiene ''%' + @Expresion2 + '%'') ' + @Operador
    END

    SELECT @Resultado = NULLIF(@Resultado, 'Si')
  
    SELECT @Resultado = REPLACE(LEFT(@Resultado, LEN(@Resultado) - 3), @Operador, REPLACE(REPLACE(@Operador, '<', ''), '>', ''))
  END
  
  RETURN @Resultado
END
GO

-- SELECT dbo.fnMovSituacionTipoFlujo('DEMO', 'VTAS', 'Pedido', 'PENDIENTE')
/**************** fnMovSituacionTipoFlujo ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnMovSituacionTipoFlujo') DROP FUNCTION fnMovSituacionTipoFlujo
GO
CREATE FUNCTION fnMovSituacionTipoFlujo(
				@Empresa		varchar(5),
				@Modulo			varchar(5),
				@Mov			varchar(20),
				@Estatus		varchar(15)
				)
RETURNS varchar(20)
AS
BEGIN
  DECLARE @Resultado				varchar(20),
		  @MovSituacionBinaria		bit,
		  @Flujo					varchar(20)
		  
  SELECT @MovSituacionBinaria = ISNULL(MovSituacionBinaria, 0) FROM EmpresaGral WHERE Empresa = @Empresa
  
  SELECT @Flujo = Flujo FROM MovSituacionL WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @Estatus
  
  IF @Flujo IS NOT NULL
    IF @MovSituacionBinaria = 0  OR (@MovSituacionBinaria = 1 AND @Flujo = 'Normal')
      SELECT @Resultado = 'Normal'
    ELSE
      SELECT @Resultado = 'Condicional'
  ELSE
    SELECT @Resultado = 'Normal'
    
  RETURN @Resultado
END
GO

/**************** fnMovSituacionBinariaIcono ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnMovSituacionBinariaIcono') DROP FUNCTION fnMovSituacionBinariaIcono
GO
CREATE FUNCTION fnMovSituacionBinariaIcono(
				@Modulo			varchar(5),
				@Mov			varchar(20),
				@Estatus		varchar(15),
				@Situacion		varchar(50),
				@Rama			varchar(50),
				@EsPadre		bit
				)
RETURNS int
AS
BEGIN
  DECLARE @SituacionVerdadero	varchar(50),
		  @Icono				int
  
  SELECT @SituacionVerdadero = SituacionVerdadero
    FROM MovSituacion
   WHERE Modulo		= @Modulo
     AND Mov		= @Mov
     AND Estatus	= @Estatus
     AND Situacion	= @Rama

  IF @Situacion = @SituacionVerdadero OR @EsPadre = 1
    SELECT @Icono = 339
  ELSE
    SELECT @Icono = 416
    
  RETURN @Icono
END
GO

/**************** fnMovSituacionBinariaPermiteRetroceder ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnMovSituacionBinariaPermiteRetroceder') DROP FUNCTION fnMovSituacionBinariaPermiteRetroceder
GO
CREATE FUNCTION fnMovSituacionBinariaPermiteRetroceder(
				@Modulo			varchar(5),
				@Mov			varchar(20),
				@Estatus		varchar(15),
				@Situacion		varchar(50)
				)
RETURNS bit
AS
BEGIN
  DECLARE @PermiteRetroceder		 bit  --BUG12896
  
  IF ISNULL(@Situacion, '') IN('')
    SELECT @Situacion = RTRIM(@Mov)+' '+RTRIM(Nombre) FROM Estatus WHERE Estatus = @Estatus
  
  SELECT @PermiteRetroceder = ISNULL(PermiteRetroceder, 0) FROM MovSituacion WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @Estatus AND Situacion = @Situacion --BUG12896
  
  RETURN(@PermiteRetroceder) --BUG12896
END
GO

/**************** fnMovSituacionBinariaRetroceder ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnMovSituacionBinariaRetroceder') DROP FUNCTION fnMovSituacionBinariaRetroceder
GO
CREATE FUNCTION fnMovSituacionBinariaRetroceder(
				@Modulo			varchar(5),
				@Mov			varchar(20),
				@Estatus		varchar(15),
				@Situacion		varchar(50)
				)
RETURNS varchar(50)
AS
BEGIN
  DECLARE @Rama varchar(50)
  
  IF ISNULL(@Situacion, '') IN('')
    SELECT @Situacion = RTRIM(@Mov)+' '+RTRIM(Nombre) FROM Estatus WHERE Estatus = @Estatus
  
  SELECT @Rama = Rama FROM MovSituacion WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @Estatus AND Situacion = @Situacion
  
  IF ISNULL(@Rama, '') IN('', '.')
    SELECT @Rama = @Situacion
    
  RETURN @Rama
END
GO

-- SELECT dbo.fnPuedeAvanzarSituacion('DEMO', 'VTAS', 'Pedido', 'PENDIENTE', 'No Autorizado', 'DEMO')
/**************** fnPuedeAvanzarSituacion ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPuedeAvanzarSituacion') DROP FUNCTION fnPuedeAvanzarSituacion
GO
CREATE FUNCTION fnPuedeAvanzarSituacion(
				@Empresa		varchar(5),
				@Modulo			varchar(5),
				@Mov			varchar(20),
				@Estatus		varchar(15),
				@Situacion		varchar(50),
				@Usuario		varchar(10)
				)
RETURNS bit
AS
BEGIN
  DECLARE @Resultado	bit
  
  IF ISNULL(@Situacion, '') IN('.', '')
    SELECT @Situacion = RTRIM(@Mov)+' '+RTRIM(Nombre) FROM Estatus WHERE Estatus = @Estatus
  
  IF dbo.fnMovSituacionTipoFlujo(@Empresa, @Modulo, @Mov, @Estatus) = 'Condicional'
  BEGIN
    --BUG15646
    IF(SELECT TOP 1 ISNULL(ControlUsuarios, 0) FROM MovSituacion WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @Estatus AND Situacion = @Situacion) = 0
      SELECT @Resultado = 1
    ELSE
    BEGIN
      IF EXISTS(SELECT u.Usuario FROM MovSituacionUsuario u JOIN MovSituacion s ON u.ID = s.ID WHERE s.Modulo = @Modulo AND s.Mov = @Mov AND s.Estatus = @Estatus AND s.Situacion = @Situacion AND u.Usuario = @Usuario)
        SELECT @Resultado = 1
      ELSE
        SELECT @Resultado = 0
    END
  END
  ELSE
    SELECT @Resultado = 0

  RETURN @Resultado
END
GO

-- SELECT dbo.fnPuedeAvanzarEstatus('DEMO', 'VTAS', 'Pedido', 'PENDIENTE', 'No Autorizado', 'DEMO')
/**************** fnPuedeAvanzarEstatus ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnPuedeAvanzarEstatus') DROP FUNCTION fnPuedeAvanzarEstatus
GO
CREATE FUNCTION fnPuedeAvanzarEstatus(
				@Empresa		varchar(5),
				@Modulo			varchar(5),
				@Mov			varchar(20),
				@Estatus		varchar(15),
				@Situacion		varchar(50),
				@Usuario		varchar(10)
				)
RETURNS bit
AS
BEGIN
  DECLARE @Resultado	bit

  --BUG15712
  IF ISNULL(@Situacion, '') IN('.', '')
    SELECT @Situacion = RTRIM(@Mov)+' '+RTRIM(Nombre) FROM Estatus WHERE Estatus = @Estatus
      
  IF dbo.fnMovSituacionTipoFlujo(@Empresa, @Modulo, @Mov, @Estatus) = 'Condicional'
  BEGIN
    --BUG15646
    IF(SELECT TOP 1 ISNULL(PermiteAfectacion, 0) FROM MovSituacion WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @Estatus AND Situacion = @Situacion) = 1
      SELECT @Resultado = 1
    ELSE
      SELECT @Resultado = 0
  END
  ELSE
    SELECT @Resultado = 0

  RETURN @Resultado
END
GO

/****** spMovSituacionBinariaAyudaCaptura ******/
if exists (select * from sysobjects where id = object_id('dbo.spMovSituacionBinariaAyudaCaptura') and type = 'p') drop proc dbo.spMovSituacionBinariaAyudaCaptura
GO
CREATE PROC spMovSituacionBinariaAyudaCaptura
--//WITH ENCRYPTION
AS
BEGIN  
  SELECT Tag FROM MovSituacionBinariaTagAyuda ORDER BY Tag
END
GO

/******************************* spMovSituacionBinariaParsearCondUsuario *************************************************/
if exists (select * from sysobjects where id = object_id('dbo.spMovSituacionBinariaParsearCondUsuario') and type = 'P') drop procedure dbo.spMovSituacionBinariaParsearCondUsuario
GO             
CREATE PROCEDURE spMovSituacionBinariaParsearCondUsuario
			@Modulo				varchar(5), 
			@ID					int, 
			@Mov				varchar(20),
			@Estatus			varchar(15),
			@Situacion			varchar(50), 
			@SituacionID		int,
		    @Cajero				varchar(10),
		    @Causa				varchar(50),
		    @Clase				varchar(50),
		    @Concepto			varchar(50),
		    @Condicion			varchar(50),
		    @Contacto			varchar(10),
		    @CtaDinero			varchar(10),
		    @Ejercicio			int,
		    @Empresa			varchar(5),
		    @EnviarA			int,
		    @FechaCancelacion	datetime,
		    @FechaEmision		datetime,
		    @FechaRegistro		datetime,
		    @FormaEnvio			varchar(50),
		    @Importe			money,
		    @Impuestos			money,
		    @Moneda				varchar(10),
		    @MovID				varchar(20),
		    @Observaciones		varchar(100),
		    @Origen				varchar(20),
		    @OrigenID			varchar(20),
		    @OrigenTipo			varchar(10),
		    @Periodo			int,
		    @Proyecto			varchar(50),
		    @RamaID				int,
		    @Referencia			varchar(50),
		    @Retenciones		money,
		    @SubClase			varchar(50),
		    @Sucursal			int,
		    @TipoCambio			float,
		    @Total				money,
		    @UEN				int,
		    @Usuario			varchar(10),
		    @Vencimiento		datetime,
		    @ZonaImpuesto		varchar(30),
			@CondicionUsuario	varchar(max)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Cajero>',ISNULL(RTRIM(@Cajero),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Causa>',ISNULL(RTRIM(@Causa),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Clase>',ISNULL(RTRIM(@Clase),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Concepto>',ISNULL(RTRIM(@Concepto),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Condicion>',ISNULL(RTRIM(@Condicion),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Contacto>',ISNULL(RTRIM(@Contacto),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<CtaDinero>',ISNULL(RTRIM(@CtaDinero),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Ejercicio>',ISNULL(RTRIM(CONVERT(varchar,@Ejercicio)),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Empresa>',ISNULL(RTRIM(@Empresa),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<EnviarA>',ISNULL(RTRIM(CONVERT(varchar,@EnviarA)),''))  
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<FechaCancelacion>',ISNULL(RTRIM(CONVERT(varchar,@FechaCancelacion)),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<FechaEmision>',ISNULL(RTRIM(CONVERT(varchar,@FechaEmision)),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<FechaRegistro>',ISNULL(RTRIM(CONVERT(varchar,@FechaRegistro)),''))        
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<FormaEnvio>',ISNULL(RTRIM(CONVERT(varchar,@FormaEnvio)),''))  
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Importe>',ISNULL(RTRIM(CONVERT(varchar,@Importe)),''))  
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Impuestos>',ISNULL(RTRIM(CONVERT(varchar,@Impuestos)),''))  
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Moneda>',ISNULL(RTRIM(@Moneda),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<MovID>',ISNULL(RTRIM(@MovID),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Observaciones>',ISNULL(RTRIM(@Observaciones),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Origen>',ISNULL(RTRIM(@Origen),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<OrigenID>',ISNULL(RTRIM(@OrigenID),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<OrigenTipo>',ISNULL(RTRIM(@OrigenTipo),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Perdiodo>',ISNULL(RTRIM(CONVERT(varchar,@Periodo)),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<RamaID>',ISNULL(RTRIM(CONVERT(varchar,@RamaID)),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Referencia>',ISNULL(RTRIM(@Referencia),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Retenciones>',ISNULL(RTRIM(CONVERT(varchar,@Retenciones)),''))  
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<SubClase>',ISNULL(RTRIM(@SubClase),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<TipoCambio>',ISNULL(RTRIM(CONVERT(varchar,@TipoCambio)),''))  
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Total>',ISNULL(RTRIM(CONVERT(varchar,@Total)),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Vencimiento>',ISNULL(RTRIM(CONVERT(varchar,@Vencimiento)),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<ZonaImpuesto>',ISNULL(RTRIM(@ZonaImpuesto),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Sucursal>',ISNULL(RTRIM(CONVERT(varchar,@Sucursal)),''))
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Proyecto>',ISNULL(RTRIM(@Proyecto),''))          
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<UEN>',ISNULL(RTRIM(CONVERT(varchar,@UEN)),''))  
  --SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Usuario>',ISNULL(RTRIM(@Usuario),''))  

  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<ID>','@ID')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Cajero>','@Cajero')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Causa>','@Causa')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Clase>','@Clase')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Concepto>','@Concepto')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Condicion>','@Concepto')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Contacto>','@Contacto')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<CtaDinero>','@CtaDinero')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Ejercicio>','@Ejercicio')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Empresa>','@Empresa')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<EnviarA>','@EnviarA')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<FechaCancelacion>','@FechaCancelacion')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<FechaEmision>','@FechaEmision')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<FechaRegistro>','@FechaRegistro')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<FormaEnvio>','@FormaEnvio')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Importe>','@Importe')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Impuestos>','@Impuestos')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Moneda>','@Moneda')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<MovID>','@MovID')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Observaciones>','@Observaciones')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Origen>','@Origen')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<OrigenID>','@OrigenID')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<OrigenTipo>','@OrigenTipo')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Perdiodo>','@Perdiodo')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<RamaID>','@RamaID')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Referencia>','@Referencia')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Retenciones>','@Retenciones')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<SubClase>','@SubClase')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<TipoCambio>','@TipoCambio')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Total>','@Total')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Vencimiento>','@Vencimiento')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<ZonaImpuesto>','@ZonaImpuesto')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Sucursal>','@Sucursal')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Proyecto>','@Proyecto')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<UEN>','@UEN')
  SET @CondicionUsuario = REPLACE(@CondicionUsuario,'<Usuario>','@Usuario')
END
GO

/************** spMovSituacionBinariaValidarCondUsuario *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovSituacionBinariaValidarCondUsuario') and type = 'P') drop procedure dbo.spMovSituacionBinariaValidarCondUsuario
GO
CREATE PROC spMovSituacionBinariaValidarCondUsuario 
			@Modulo				varchar(5), 
			@ID					int, 
			@Mov				varchar(20),
			@Estatus			varchar(15),
			@Situacion			varchar(50), 
			@SituacionID		int, 
			@CondicionUsuario	varchar(max),
		    @Cajero				varchar(10),
		    @Causa				varchar(50),
		    @Clase				varchar(50),
		    @Concepto			varchar(50),
		    @Condicion			varchar(50),
		    @Contacto			varchar(10),
		    @CtaDinero			varchar(10),
		    @Ejercicio			int,
		    @Empresa			varchar(5),
		    @EnviarA			int,
		    @FechaCancelacion	datetime,
		    @FechaEmision		datetime,
		    @FechaRegistro		datetime,
		    @FormaEnvio			varchar(50),
		    @Importe			money,
		    @Impuestos			money,
		    @Moneda				varchar(10),
		    @MovID				varchar(20),
		    @Observaciones		varchar(100),
		    @Origen				varchar(20),
		    @OrigenID			varchar(20),
		    @OrigenTipo			varchar(10),
		    @Periodo			int,
		    @Proyecto			varchar(50),
		    @RamaID				int,
		    @Referencia			varchar(50),
		    @Retenciones		money,
		    @SubClase			varchar(50),
		    @Sucursal			int,
		    @TipoCambio			float,
		    @Total				money,
		    @UEN				int,
		    @Usuario			varchar(10),
		    @Vencimiento		datetime,
		    @ZonaImpuesto		varchar(30),			
			@ValidaCondUsuario	bit			OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE @SQL					nvarchar(max),
		  @Parametros			nvarchar(max)

  SELECT @Parametros = '@ID					int,
                        @Cajero				varchar(10),
						@Causa				varchar(50),
						@Clase				varchar(50),
						@Concepto			varchar(50),
						@Condicion			varchar(50),
						@Contacto			varchar(10),
						@CtaDinero			varchar(10),
						@Ejercicio			int,
						@Empresa			varchar(5),
						@EnviarA			int,
						@FechaCancelacion	datetime,
						@FechaEmision		datetime,
						@FechaRegistro		datetime,
						@FormaEnvio			varchar(50),
						@Importe			money,
						@Impuestos			money,
						@Moneda				varchar(10),
						@MovID				varchar(20),
						@Observaciones		varchar(100),
						@Origen				varchar(20),
						@OrigenID			varchar(20),
						@OrigenTipo			varchar(10),
						@Periodo			int,
						@Proyecto			varchar(50),
						@RamaID				int,
						@Referencia			varchar(50),
						@Retenciones		money,
						@SubClase			varchar(50),
						@Sucursal			int,
						@TipoCambio			float,
						@Total				money,
						@UEN				int,
						@Usuario			varchar(10),
						@Vencimiento		datetime,
						@ZonaImpuesto		varchar(30),
						@ValidaCondUsuario	bit			OUTPUT'

  SELECT @CondicionUsuario = REPLACE(@CondicionUsuario,CHAR(10),'')  
  SELECT @CondicionUsuario = REPLACE(@CondicionUsuario,CHAR(13),'')  
  SELECT @CondicionUsuario = ISNULL(RTRIM(@CondicionUsuario),'')
  
  IF NULLIF(RTRIM(@CondicionUsuario),'') IS NULL
  BEGIN
    SELECT @ValidaCondUsuario = 1
    RETURN
  END
  
  EXEC spMovSituacionBinariaParsearCondUsuario @Modulo, @ID, @Mov, @Estatus, @Situacion, @SituacionID, @Cajero, @Causa, @Clase, @Concepto, @Condicion, @Contacto, 
											   @CtaDinero, @Ejercicio, @Empresa, @EnviarA, @FechaCancelacion, @FechaEmision, @FechaRegistro, @FormaEnvio, @Importe, 
											   @Impuestos, @Moneda, @MovID, @Observaciones, @Origen, @OrigenID, @OrigenTipo, @Periodo, @Proyecto, @RamaID, @Referencia, 
											   @Retenciones, @SubClase, @Sucursal, @TipoCambio, @Total, @UEN, @Usuario, @Vencimiento, @ZonaImpuesto, @CondicionUsuario OUTPUT

  SELECT @SQL = 'IF (' + @CondicionUsuario + ') SELECT @ValidaCondUsuario = 1 ELSE SELECT @ValidaCondUsuario = 0' 

  BEGIN TRY  
    EXEC sp_executesql @SQL, @Parametros, @ID, @Cajero, @Causa, @Clase, @Concepto, @Condicion, @Contacto, @CtaDinero, @Ejercicio, @Empresa, @EnviarA, @FechaCancelacion, 
					   @FechaEmision, @FechaRegistro, @FormaEnvio, @Importe, @Impuestos, @Moneda, @MovID, @Observaciones, @Origen, @OrigenID, @OrigenTipo, @Periodo, 
					   @Proyecto, @RamaID, @Referencia, @Retenciones, @SubClase, @Sucursal, @TipoCambio, @Total, @UEN, @Usuario, @Vencimiento, @ZonaImpuesto, @ValidaCondUsuario OUTPUT
  END TRY
  BEGIN CATCH
    SELECT @ValidaCondUsuario = 0
    RETURN
  END CATCH  
END
GO

/************** spMovSituacionBinariaValidarCondicion *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovSituacionBinariaValidarCondicion') and type = 'P') drop procedure dbo.spMovSituacionBinariaValidarCondicion
GO
CREATE PROC spMovSituacionBinariaValidarCondicion
		    @Modulo				varchar(5),
		    @ID					int,
		    @Mov				varchar(20),
		    @Estatus 			varchar(15),
		    @Situacion			varchar(50),
		    @SituacionID		int,
		    @Operador			varchar(10),
		    @Cajero				varchar(10),
		    @Causa				varchar(50),
		    @Clase				varchar(50),
		    @Concepto			varchar(50),
		    @Condicion			varchar(50),
		    @Contacto			varchar(10),
		    @CtaDinero			varchar(10),
		    @Ejercicio			int,
		    @Empresa			varchar(5),
		    @EnviarA			int,
		    @FechaCancelacion	datetime,
		    @FechaEmision		datetime,
		    @FechaRegistro		datetime,
		    @FormaEnvio			varchar(50),
		    @Importe			money,
		    @Impuestos			money,
		    @Moneda				varchar(10),
		    @MovID				varchar(20),
		    @Observaciones		varchar(100),
		    @Origen				varchar(20),
		    @OrigenID			varchar(20),
		    @OrigenTipo			varchar(10),
		    @Periodo			int,
		    @Proyecto			varchar(50),
		    @RamaID				int,
		    @Referencia			varchar(50),
		    @Retenciones		money,
		    @SubClase			varchar(50),
		    @Sucursal			int,
		    @TipoCambio			float,
		    @Total				money,
		    @UEN				int,
		    @Usuario			varchar(10),
		    @Vencimiento		datetime,
		    @ZonaImpuesto		varchar(30),
		    @ValidaCondicion	bit				OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE @SQL					nvarchar(max),
		  @Parametros			nvarchar(max),
		  
		  @RID					int,
		  @RIDAnt				int,
		  @Expresion1			varchar(255),
		  @Expresion2			varchar(255),
		  @Expresion3			varchar(255),
		  @OperadorCondicion	varchar(20)

  IF NOT EXISTS(SELECT RID FROM MovSituacionBinariaCondicion WHERE ID = @SituacionID) 
  BEGIN
    SELECT @ValidaCondicion = 1
    RETURN
  END

  IF @Operador = 'Todas'
    SELECT @Operador = 'AND'
  ELSE IF @Operador = 'Alguna'
    SELECT @Operador = 'OR'

  --BUG15730
  SELECT @SQL = 'SET ANSI_NULLS OFF IF '
  
  SELECT @Parametros = '@ID					int,
						@Cajero				varchar(10),
						@Causa				varchar(50),
						@Clase				varchar(50),
						@Concepto			varchar(50),
						@Condicion			varchar(50),
						@Contacto			varchar(10),
						@CtaDinero			varchar(10),
						@Ejercicio			int,
						@Empresa			varchar(5),
						@EnviarA			int,
						@FechaCancelacion	datetime,
						@FechaEmision		datetime,
						@FechaRegistro		datetime,
						@FormaEnvio			varchar(50),
						@Importe			money,
						@Impuestos			money,
						@Moneda				varchar(10),
						@MovID				varchar(20),
						@Observaciones		varchar(100),
						@Origen				varchar(20),
						@OrigenID			varchar(20),
						@OrigenTipo			varchar(10),
						@Periodo			int,
						@Proyecto			varchar(50),
						@RamaID				int,
						@Referencia			varchar(50),
						@Retenciones		money,
						@SubClase			varchar(50),
						@Sucursal			int,
						@TipoCambio			float,
						@Total				money,
						@UEN				int,
						@Usuario			varchar(10),
						@Vencimiento		datetime,
						@ZonaImpuesto		varchar(30),
						@ValidaCondicion	bit			OUTPUT'
  
  SELECT @RIDAnt = 0
  WHILE(1=1)
  BEGIN
    SELECT @RID = MIN(RID)
      FROM MovSituacionBinariaCondicion 
     WHERE ID = @SituacionID
       AND RID > @RIDAnt
  
    IF @RID IS NULL BREAK
    
    SELECT @RIDAnt = @RID, @Expresion1 = NULL, @Expresion2 = NULL, @OperadorCondicion = NULL

    SELECT @Expresion1 = '@' + REPLACE(REPLACE(ISNULL(Expresion1, ''), '<', ''), '>', ''), @Expresion2 = ISNULL(Expresion2, ''), @Expresion3 = ISNULL(Expresion3, ''), @OperadorCondicion = ISNULL(Operador, '')
      FROM MovSituacionBinariaCondicion
     WHERE ID = @SituacionID
       AND RID = @RID

    IF @OperadorCondicion = 'Entre'
      SELECT @SQL = @SQL + ' (' + @Expresion1 + ' BETWEEN ''' + @Expresion2 + ''' AND ''' + @Expresion3 + ''') ' + @Operador
    ELSE IF @OperadorCondicion = 'Igual que'
      SELECT @SQL = @SQL + ' (' + @Expresion1 + ' = ''' + @Expresion2 + ''') ' + @Operador
    ELSE IF @OperadorCondicion = 'Mayor o igual que'
      SELECT @SQL = @SQL + ' (' + @Expresion1 + ' >= ''' + @Expresion2 + ''') ' + @Operador
    ELSE IF @OperadorCondicion = 'Menor o igual que'
      SELECT @SQL = @SQL + ' (' + @Expresion1 + ' <= ''' + @Expresion2 + ''') ' + @Operador
    ELSE IF @OperadorCondicion = 'Mayor que'
      SELECT @SQL = @SQL + ' (' + @Expresion1 + ' > ''' + @Expresion2 + ''') ' + @Operador
    ELSE IF @OperadorCondicion = 'Menor que'
      SELECT @SQL = @SQL + ' (' + @Expresion1 + ' < ''' + @Expresion2 + ''') ' + @Operador
    ELSE IF @OperadorCondicion = 'Distinto que'
      SELECT @SQL = @SQL + ' (' + @Expresion1 + ' <> ''' + @Expresion2 + ''') '  + @Operador
    ELSE IF @OperadorCondicion = 'Contiene'
      SELECT @SQL = @SQL + ' (' + @Expresion1 + ' LIKE ''%' + @Expresion2 + '%'') ' + @Operador
  END
  
  BEGIN TRY  
    --BUG15664
    IF @Operador = 'AND'
      SELECT @SQL = LEFT(@SQL, LEN(@SQL) - 3)
    IF @Operador = 'OR'
      SELECT @SQL = LEFT(@SQL, LEN(@SQL) - 2)

    SELECT @SQL = @SQL + ' SELECT @ValidaCondicion = 1 ELSE SELECT @ValidaCondicion = 0'
    
    EXEC sp_executesql @SQL, @Parametros, @ID, @Cajero, @Causa, @Clase, @Concepto, @Condicion, @Contacto, @CtaDinero, @Ejercicio, @Empresa, @EnviarA, @FechaCancelacion, 
					   @FechaEmision, @FechaRegistro, @FormaEnvio, @Importe, @Impuestos, @Moneda, @MovID, @Observaciones, @Origen, @OrigenID, @OrigenTipo, @Periodo, 
					   @Proyecto, @RamaID, @Referencia, @Retenciones, @SubClase, @Sucursal, @TipoCambio, @Total, @UEN, @Usuario, @Vencimiento, @ZonaImpuesto, @ValidaCondicion OUTPUT
  END TRY
  BEGIN CATCH  
    SELECT @ValidaCondicion = 0
    RETURN
  END CATCH
  
  RETURN
END
GO

/************** spMovSituacionBinariaSiguiente *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovSituacionBinariaSiguiente') and type = 'P') drop procedure dbo.spMovSituacionBinariaSiguiente
GO
CREATE PROCEDURE spMovSituacionBinariaSiguiente
            @Estacion			int,
		    @Modulo				varchar(5),
		    @ID					int,
		    @Mov				varchar(20),
		    @Estatus 			varchar(15),
		    @Situacion			varchar(50),
		    @SituacionNueva		varchar(50)	= NULL OUTPUT,
		    @SituacionID		int			= NULL OUTPUT,
		    @SituacionUsuario	varchar(10)	= NULL,
		    @EnSilencio			bit			= 1,
		    @Retroceder			bit			= 0
--//WITH ENCRYPTION
AS BEGIN
  DECLARE @Condicional			bit,
		  @CondicionUsuario		varchar(max),
		  @SituacionVerdadero	varchar(50),
		  @SituacionFalso		varchar(50),		  
		  @ValidaCondicion		bit,
		  @ValidaCondUsuario	bit,
		  @Operador				varchar(10),
		  @SituacionFecha		datetime,
		  @PermiteRetroceder	bit,
		  @Rama					varchar(50),
		  @EsPadre				bit,
		  
		  @Cajero				varchar(10),
		  @Causa				varchar(50),
		  @Clase				varchar(50),
		  @Concepto				varchar(50),
		  @Condicion			varchar(50),
		  @Contacto				varchar(10),
		  @CtaDinero			varchar(10),
		  @Ejercicio			int,
		  @Empresa				varchar(5),
		  @EnviarA				int,
		  @FechaCancelacion		datetime,
		  @FechaEmision			datetime,
		  @FechaRegistro		datetime,
		  @FormaEnvio			varchar(50),
		  @Importe				money,
		  @Impuestos			money,
		  @Moneda				varchar(10),
		  @MovID				varchar(20),
		  @Observaciones		varchar(100),
		  @Origen				varchar(20),
		  @OrigenID				varchar(20),
		  @OrigenTipo			varchar(10),
		  @Periodo				int,
		  @Proyecto				varchar(50),
		  @RamaID				int,
		  @Referencia			varchar(50),
		  @Retenciones			money,
		  @SubClase				varchar(50),
		  @Sucursal				int,
		  @TipoCambio			float,
		  @Total				money,
		  @UEN					int,
		  @Usuario				varchar(10),
		  @Vencimiento			datetime,
		  @ZonaImpuesto			varchar(30)

  CREATE TABLE #Situaciones(
    Situacion	varchar(50)	NULL,
    Rama		bit			NULL
    )

  SELECT @SituacionFecha = GETDATE()
  
  DELETE MovSituacionBinariaSiguiente WHERE Estacion = @Estacion

  IF ISNULL(@Situacion, '') IN('.', '')
    SELECT @Situacion = RTRIM(@Mov)+' '+RTRIM(Nombre) FROM Estatus WHERE Estatus = @Estatus

  SELECT @Condicional = ISNULL(Condicional, 0), @CondicionUsuario = CondicionUsuario, @SituacionVerdadero = SituacionVerdadero,
		 @SituacionID = ID, @Operador = Operador, @PermiteRetroceder = ISNULL(PermiteRetroceder, 0), @Rama = Rama, @EsPadre = ISNULL(EsPadre, 0)
    FROM MovSituacion 
   WHERE Modulo    = @Modulo
     AND Mov	   = @Mov 
     AND Estatus   = @Estatus
     AND Situacion = @Situacion

  SELECT @SituacionFalso = Situacion
    FROM MovSituacion 
   WHERE Modulo	= @Modulo
     AND Mov		= @Mov 
     AND Estatus	= @Estatus
     AND Rama		= @Situacion
     AND Situacion <> @SituacionVerdadero

  IF ISNULL(@PermiteRetroceder, 0) = 1 AND @EsPadre = 0
    INSERT INTO #Situaciones(Situacion, Rama) VALUES(@Rama, 1)

  INSERT INTO #Situaciones(Situacion) VALUES(@SituacionFalso)
    
  IF @Condicional = 0
  BEGIN
    SELECT @SituacionNueva = @SituacionVerdadero
    
    INSERT INTO #Situaciones(Situacion) VALUES(@SituacionNueva)
    
    IF @EnSilencio = 1
      INSERT INTO MovSituacionBinariaSiguiente(Estacion, Modulo, ID, Mov, Estatus, Situacion, SituacionFecha, SituacionUsuario) VALUES(@Estacion, @Modulo, @ID, @Mov, @Estatus, @SituacionNueva, @SituacionFecha, @SituacionUsuario)    
  END
  ELSE
  BEGIN
    EXEC spMovInfo @ID, @Modulo, @Cajero = @Cajero OUTPUT, @Causa = @Causa OUTPUT, @Clase = @Clase OUTPUT, @Concepto = @Concepto OUTPUT, @Condicion = @Condicion OUTPUT, @Contacto = @Contacto OUTPUT, 
				   @CtaDinero = @CtaDinero OUTPUT, @Ejercicio = @Ejercicio OUTPUT, @Empresa = @Empresa OUTPUT, @EnviarA = @EnviarA OUTPUT, @FechaCancelacion = @FechaCancelacion OUTPUT, 
				   @FechaEmision = @FechaEmision OUTPUT, @FechaRegistro = @FechaRegistro OUTPUT, @FormaEnvio = @FormaEnvio OUTPUT, @Importe = @Importe OUTPUT, @Impuestos = @Impuestos OUTPUT, 
				   @Moneda = @Moneda OUTPUT, @MovID = @MovID OUTPUT, @Observaciones = @Observaciones OUTPUT, @Origen = @Origen OUTPUT, @OrigenID = @OrigenID OUTPUT, @OrigenTipo = @OrigenTipo OUTPUT, 
				   @Periodo = @Periodo OUTPUT, @Proyecto = @Proyecto OUTPUT, @RamaID = @RamaID OUTPUT, @Referencia = @Referencia OUTPUT, @Retenciones = @Retenciones OUTPUT, @SubClase = @SubClase OUTPUT, 
				   @Sucursal = @Sucursal OUTPUT, @TipoCambio = @TipoCambio OUTPUT, @Total = @Total OUTPUT, @UEN = @UEN OUTPUT, @Usuario = @Usuario OUTPUT, @Vencimiento = @Vencimiento OUTPUT, 
				   @ZonaImpuesto = @ZonaImpuesto OUTPUT
  
    EXEC spMovSituacionBinariaValidarCondicion @Modulo, @ID, @Mov, @Estatus, @Situacion, @SituacionID, @Operador, @Cajero, @Causa, @Clase, @Concepto, @Condicion, @Contacto, 
											   @CtaDinero, @Ejercicio, @Empresa, @EnviarA, @FechaCancelacion, @FechaEmision, @FechaRegistro, @FormaEnvio, @Importe, 
											   @Impuestos, @Moneda, @MovID, @Observaciones, @Origen, @OrigenID, @OrigenTipo, @Periodo, @Proyecto, @RamaID, @Referencia, 
											   @Retenciones, @SubClase, @Sucursal, @TipoCambio, @Total, @UEN, @Usuario, @Vencimiento, @ZonaImpuesto, 
											   @ValidaCondicion = @ValidaCondicion OUTPUT

    EXEC spMovSituacionBinariaValidarCondUsuario @Modulo, @ID, @Mov, @Estatus, @Situacion, @SituacionID, @CondicionUsuario, @Cajero, @Causa, @Clase, @Concepto, @Condicion, @Contacto, 
											     @CtaDinero, @Ejercicio, @Empresa, @EnviarA, @FechaCancelacion, @FechaEmision, @FechaRegistro, @FormaEnvio, @Importe, 
											     @Impuestos, @Moneda, @MovID, @Observaciones, @Origen, @OrigenID, @OrigenTipo, @Periodo, @Proyecto, @RamaID, @Referencia, 
											     @Retenciones, @SubClase, @Sucursal, @TipoCambio, @Total, @UEN, @Usuario, @Vencimiento, @ZonaImpuesto, @ValidaCondUsuario OUTPUT

    IF @ValidaCondicion = 1 AND @ValidaCondUsuario = 1
    BEGIN
      SELECT @SituacionNueva = @SituacionVerdadero
      
      INSERT INTO #Situaciones(Situacion) VALUES(@SituacionNueva)
      
      IF @EnSilencio = 1
        INSERT INTO MovSituacionBinariaSiguiente(Estacion, Modulo, ID, Mov, Estatus, Situacion, SituacionFecha, SituacionUsuario) VALUES(@Estacion, @Modulo, @ID, @Mov, @Estatus, @SituacionNueva, @SituacionFecha, @SituacionUsuario)
    END
    ELSE
    BEGIN
      SELECT @SituacionNueva = @SituacionFalso

      IF @EnSilencio = 1
        INSERT INTO MovSituacionBinariaSiguiente(Estacion, Modulo, ID, Mov, Estatus, Situacion, SituacionFecha, SituacionUsuario) VALUES(@Estacion, @Modulo, @ID, @Mov, @Estatus, @SituacionFalso, @SituacionFecha, @SituacionUsuario)
    END
  END
  
  IF @EnSilencio = 0
    IF @Retroceder = 1
      SELECT Situacion FROM #Situaciones WHERE Situacion IS NOT NULL AND Rama = 1
    ELSE
      SELECT Situacion FROM #Situaciones WHERE Situacion IS NOT NULL
END
GO

/************** spMovSituacionNueva *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovSituacionNueva') and type = 'P') drop procedure dbo.spMovSituacionNueva
GO
CREATE PROCEDURE spMovSituacionNueva
		    @Modulo				char(5),
		    @Mov				varchar(20),
		    @EstatusNuevo 		char(15),
		    @EstatusAnterior 	char(15),
		    @SituacionNueva 	varchar(50)	OUTPUT,
		    @ID					int			= NULL,
		    @Tipo				varchar(50)	= NULL
--//WITH ENCRYPTION
AS BEGIN
  -- 11464
  DECLARE @Flujo				varchar(20),
		  @MovSituacionBinaria	bit,
		  @Empresa				varchar(5),
		  @SQL					nvarchar(max),
		  @SituacionID			int

  SELECT @SQL = 'SELECT @Empresa = Empresa FROM '+dbo.fnMovTabla(@Modulo)+' WHERE ID = @ID'
  
  EXEC sp_executesql @SQL, N'@Empresa varchar(5) OUTPUT, @ID int', @Empresa OUTPUT, @ID
  
  SELECT @Flujo = Flujo FROM MovSituacionL WHERE Mov = @Mov AND Modulo = @Modulo AND Estatus = @EstatusNuevo
  
  SELECT @MovSituacionBinaria = ISNULL(MovSituacionBinaria, 0) FROM EmpresaGral WHERE Empresa = @Empresa

  SELECT @SituacionNueva = NULL, @Tipo = NULLIF(RTRIM(@Tipo), '')
  
  IF (SELECT SituacionFinalAlRegresar FROM Version) = 1 AND dbo.fnMovEstatusValor(@EstatusNuevo) < dbo.fnMovEstatusValor(@EstatusAnterior)
  BEGIN
    IF @Tipo IS NULL
      SELECT @SituacionNueva = Situacion FROM MovSituacion WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @EstatusNuevo AND UPPER(Flujo) = 'FINAL'
    ELSE
      SELECT @SituacionNueva = Situacion FROM MovSituacion WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @EstatusNuevo AND UPPER(Flujo) = 'FINAL' AND Tipo = @Tipo
  END ELSE
  BEGIN
    -- 11464
    IF @MovSituacionBinaria = 0  OR (@MovSituacionBinaria = 1 AND @Flujo = 'Normal')
    BEGIN
      IF @Tipo IS NULL
        SELECT @SituacionNueva = Situacion FROM MovSituacion WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @EstatusNuevo AND UPPER(Flujo) IN ('INICIAL TODAS', 'INICIAL ESPECIAL')
      ELSE
        SELECT @SituacionNueva = Situacion FROM MovSituacion WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @EstatusNuevo AND UPPER(Flujo) IN ('INICIAL TODAS', 'INICIAL ESPECIAL') AND @Tipo = @Tipo
    END
    ELSE
    BEGIN
      SELECT @SituacionNueva = Situacion FROM MovSituacion WHERE Modulo = @Modulo AND Mov = @Mov AND Estatus = @EstatusNuevo AND ISNULL(EsPadre, 0) = 1 AND Situacion <> '.'

      EXEC spMovSituacionBinariaSiguiente @@SPID, @Modulo, @ID, @Mov, @EstatusNuevo, @SituacionNueva, @SituacionNueva OUTPUT, @SituacionID OUTPUT
    END
  END
  
  IF @ID IS NOT NULL
    EXEC spMovSituacionNuevaAfectar @Modulo, @ID, @SituacionNueva

  RETURN 
END
GO

/**************** spMovTipo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovTipo') and type = 'P') drop procedure dbo.spMovTipo
GO             
CREATE PROCEDURE spMovTipo
      		   @Modulo		char(5),
		   @Mov			char(20), 
		   @FechaAfectacion	datetime,
                   @Empresa		char(5),
		   @Estatus		char(15),
		   @Concepto		varchar(50)     OUTPUT,
		   @MovTipo		char(20)	OUTPUT,
		   @Periodo		int		OUTPUT,
		   @Ejercicio		int		OUTPUT,
		   @Ok			int		OUTPUT,
		   @GenerarGasto	bit		= 0	OUTPUT,
		   @SubClave		varchar(20)	= NULL  OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @Requerido 		bit,
    @UtilizarEste	bit,
    @ConceptoMov	char(20),
    @ConceptoOmision	varchar(50)


  SELECT @Concepto  = NULLIF(RTRIM(@Concepto), '')
  SELECT @MovTipo   = UPPER(Clave), @GenerarGasto = ISNULL(GenerarGasto, 0), @SubClave = SubClave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov
  EXEC spPeriodoEjercicio @Empresa, @Modulo, @FechaAfectacion, @Periodo OUTPUT, @Ejercicio OUTPUT, @Ok OUTPUT

  IF @Estatus IN ('SINAFECTAR', 'CONFIRMAR', 'BORRADOR') 
  BEGIN
    SELECT @ConceptoMov = NULL
    SELECT @ConceptoMov = Mov, @ConceptoOmision = NULLIF(RTRIM(Concepto), ''), @Requerido = Requerido, @UtilizarEste = UtilizarEste
      FROM EmpresaConcepto
     WHERE Empresa = @Empresa AND Modulo = @Modulo AND Mov = @Mov
    IF @ConceptoMov IS NOT NULL 
    BEGIN
      IF NULLIF(RTRIM(@Concepto), '') IS NULL AND @UtilizarEste = 1 SELECT @Concepto = @ConceptoOmision 
      IF @Requerido = 1 AND @Concepto IS NULL SELECT @Ok = 20480 
    END
  END 
  RETURN
END
GO

/**************** spMovTipoConsecutivo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovTipoConsecutivo') and type = 'P') drop procedure dbo.spMovTipoConsecutivo
GO             
CREATE PROCEDURE spMovTipoConsecutivo
			@Empresa	char(5), 
			@Modulo		char(5), 
			@Mov		char(20), 
			@MovID		varchar(20), 
			@FechaEmision	datetime, 
			@Ok 		int		OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Serie		varchar(50),
    @Consecutivo	int,
    @VigenciaD		datetime,
    @VigenciaA		datetime,
    @Estatus		varchar(15)

  EXEC spMovIDEnSerieConsecutivo @MovID, @Serie OUTPUT, @Consecutivo OUTPUT
  SELECT @VigenciaD = VigenciaD, @VigenciaA = VigenciaA, @Estatus = Estatus
    FROM MovTipoConsecutivo
   WHERE Empresa = @Empresa AND Modulo = @Modulo AND Mov = @Mov AND ISNULL(Serie, '') = ISNULL(@Serie, '') AND @Consecutivo BETWEEN ConsecutivoD AND ConsecutivoA

  IF @@ROWCOUNT = 0 SELECT @Ok = 31030 ELSE
  IF @Estatus <> 'ALTA' SELECT @Ok = 31010 ELSE
  IF @VigenciaD IS NOT NULL AND @FechaEmision < @VigenciaD SELECT @Ok = 31020 ELSE
  IF @VigenciaA IS NOT NULL AND @FechaEmision > @VigenciaA SELECT @Ok = 31020 
  RETURN
END
GO

-- select * from movusuario
-- select dbo.fnMovUsuarioDevolver('ACT', 20)
/**************** fnMovUsuarioDevolver ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnMovUsuarioDevolver') DROP FUNCTION fnMovUsuarioDevolver
GO
CREATE FUNCTION fnMovUsuarioDevolver (@Modulo char(5), @ID int)
RETURNS varchar(10)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Orden	int,
    @Usuario	varchar(10)

  SELECT @Orden = ISNULL(MAX(Orden), 0) FROM MovUsuario WHERE Modulo = @Modulo AND ID = @ID AND Eliminado = 0
  SELECT @Usuario = Usuario FROM MovUsuario WHERE Modulo = @Modulo AND ID = @ID AND Orden = @Orden AND Eliminado = 0

  RETURN (@Usuario)
END
GO


-- exec spMovUsuario 'ACT', 22, 'DEVOLVER', 'DEMO', 'hola'
/**************** spMovUsuario ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMovUsuario') and type = 'P') drop procedure dbo.spMovUsuario
GO
CREATE PROCEDURE spMovUsuario
		    @Modulo		char(5),
    		    @ID         	int,
		    @Accion		varchar(20),
		    @Usuario		char(10),
		    @Observaciones	varchar(100),
		    @Prioridad		varchar(10)
--//WITH ENCRYPTION
AS BEGIN 
  DECLARE
    @Empresa		char(5),
    @Sucursal		int,
    @Propietario	char(10),
    @NuevoUsuario	char(10),
    @Orden		int,
    @Ok			int,
    @OkRef	     	varchar(255),
    @OkDesc     	varchar(255)

  SELECT @Observaciones = NULLIF(NULLIF(RTRIM(@Observaciones), ''), '0'),  
         @Prioridad	= NULLIF(NULLIF(RTRIM(@Prioridad), ''), '0')
  SELECT @Ok = NULL, @OkDesc = NULL, @Accion = UPPER(@Accion), @Orden = 0, @NuevoUsuario = NULL
  SELECT @Empresa = Empresa, @Sucursal = Sucursal, @Propietario = Usuario FROM dbo.fnMovReg(@Modulo, @ID)

  IF @Accion NOT IN ('TRANSFERIR', 'DEVOLVER')
    SELECT @Ok = 60030

  IF @Ok IS NULL
  BEGIN
    IF @Accion IN ('TRANSFERIR', 'DEVOLVER')
    BEGIN
      SELECT @Orden = ISNULL(MAX(Orden), 0) FROM MovUsuario WHERE Modulo = @Modulo AND ID = @ID 
      IF @Accion = 'TRANSFERIR' SELECT @NuevoUsuario = UPPER(@Usuario) ELSE
      IF @Accion = 'DEVOLVER' SELECT @NuevoUsuario = dbo.fnMovUsuarioDevolver(@Modulo, @ID)

      IF @NuevoUsuario IS NULL SELECT @Ok = 71010 ELSE
      IF NOT EXISTS(SELECT * FROM Usuario WHERE Usuario = @NuevoUsuario) SELECT @Ok = 71020 ELSE
      IF @Propietario = @NuevoUsuario SELECT @Ok = 71030
    END
  END

  IF @Ok IS NULL
  BEGIN
    BEGIN TRANSACTION
    IF @Accion IN ('TRANSFERIR', 'DEVOLVER')
    BEGIN
      IF @Accion = 'TRANSFERIR'
      BEGIN
        SELECT @Orden = @Orden + 1
        IF EXISTS(SELECT * FROM MovUsuario WHERE Modulo = @Modulo AND ID = @ID AND Usuario = @Propietario AND Eliminado = 0)
          UPDATE MovUsuario SET Orden = @Orden WHERE Modulo = @Modulo AND ID = @ID AND Usuario = @Propietario AND Eliminado = 0
        ELSE
          INSERT MovUsuario (Sucursal, Modulo, ID, Orden, Usuario, Observaciones, Prioridad) VALUES (@Sucursal, @Modulo, @ID, @Orden, @Propietario, @Observaciones, @Prioridad)
        UPDATE MovUsuario SET Eliminado = 1 WHERE Modulo = @Modulo AND ID = @ID AND Usuario = @NuevoUsuario AND Eliminado = 0
      END ELSE
      IF @Accion = 'DEVOLVER'
        UPDATE MovUsuario SET Eliminado = 1 WHERE Modulo = @Modulo AND ID = @ID AND Usuario = @NuevoUsuario AND Eliminado = 0 AND Orden = @Orden

      EXEC spMovPutInfo @ID, @Modulo, @Usuario = @NuevoUsuario, @Observaciones = @Observaciones, @Prioridad = @Prioridad
    END 
    COMMIT TRANSACTION
  END

  IF @Ok IS NOT NULL
    SELECT @OkDesc = Descripcion + ' '+ ISNULL(@OkRef, '') FROM MensajeLista WHERE Mensaje = @Ok

  SELECT "Mensaje" = @OkDesc
END
GO

/**************** spPeriodoEjercicio ****************/
if exists (select * from sysobjects where id = object_id('dbo.spPeriodoEjercicio') and type = 'P') drop procedure dbo.spPeriodoEjercicio
GO             
CREATE PROCEDURE spPeriodoEjercicio
		   @Empresa	char(5),
		   @Modulo	char(5),
		   @Fecha	datetime,
		   @Periodo	int		OUTPUT,
		   @Ejercicio	int		OUTPUT,
		   @Ok		int		OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @CfgPeriodosEspeciales char(2)

  IF @Modulo = 'CEFE' SET @Modulo = 'CXC'
  IF @Modulo = 'PEFE' SET @Modulo = 'CXP'

  SELECT @CfgPeriodosEspeciales = UPPER(PeriodosEspeciales) FROM EmpresaCfgModulo WHERE Empresa = @Empresa AND Modulo = @Modulo
  IF @CfgPeriodosEspeciales = 'SI'
  BEGIN
    EXEC spExtraerFecha @Fecha OUTPUT
    SELECT @Periodo = NULL, @Ejercicio = NULL
    SELECT @Periodo = Periodo, @Ejercicio = Ejercicio 
      FROM EjercicioEspecial 
     WHERE Empresa = @Empresa AND Modulo = @Modulo AND @Fecha BETWEEN FechaD AND FechaA
    IF @Periodo IS NULL OR @Ejercicio IS NULL SELECT @Ok = 70060 -- Falta Configurar Fechas
  END ELSE SELECT @Periodo = DATEPART(month, @Fecha), @Ejercicio = DATEPART(year, @Fecha)   
END
GO

/**************** spPosicionMovimiento **************/
if exists (select * from sysobjects where id = object_id('dbo.spPosicionMovimiento') and type = 'P') drop procedure dbo.spPosicionMovimiento
GO
CREATE PROCEDURE spPosicionMovimiento
			@Modulo         varchar(5),
			@ID             int
--//WITH ENCRYPTION
AS BEGIN 
  DECLARE 
    @Conteo	int,
    @SQL	nvarchar(1000),
    @Resultado  varchar(5)

  SELECT @Resultado = @Modulo
  IF (SELECT Hist FROM Modulo WHERE Modulo = @Modulo) = 1
  BEGIN
    SELECT @Conteo = 0
    SELECT @SQL = N'SELECT @Conteo = COUNT(*) FROM h'+dbo.fnMovTabla(@Modulo)+' WHERE ID = @ID'
    EXEC sp_ExecuteSQL @SQL, N'@Conteo int OUTPUT, @ID int', @Conteo OUTPUT, @ID

    IF @Conteo > 0 
      SELECT @Resultado = 'h' + @Modulo
  END

  SELECT @Resultado

END
GO

/************** spPresupuesto ***************/
if exists (select * from sysobjects where id = object_id('dbo.spPresupuesto') and type = 'P') drop procedure dbo.spPresupuesto
GO
CREATE PROCEDURE spPresupuesto
		   @Sucursal		int,
	           @Empresa		char(5),
		   @Moneda		char(10),
		   @Rama		char(5),
                   @Tipo		varchar(50),
	           @Cuenta		char(20),
		   @SubCuenta		varchar(50),
		   @SubCuenta2		varchar(50),
		   @SubCuenta3		varchar(50),
		   @UEN			int,
		   @Presupuesto		money,
		   @Reservado		money, 
		   @Comprometido	money, 
		   @Devengado		money, 
		   @Ejercido		money,
		   @Ejercicio		int,
		   @Periodo		int,
		   @Accion		char(20),
		
		   @Ok			int		OUTPUT,
		   @OkRef		varchar(255)	OUTPUT

--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @PPTO	bit,
    @Dif	money
  -- SET nocount ON

  IF (SELECT ISNULL(PresupuestoNivelUEN, 0) FROM Cta WHERE Cuenta = @Cuenta) = 0 SELECT @UEN = NULL

  IF @Accion IN ('CANCELAR', 'DESAFECTAR') SELECT @Presupuesto = -@Presupuesto, @Reservado = -@Reservado, @Comprometido = -@Comprometido, @Devengado = -@Devengado, @Ejercido = -@Ejercido

  UPDATE Presupuesto
     SET Presupuesto       = ISNULL(Presupuesto, 0.0) + ISNULL(@Presupuesto, 0.0),
	 Reservado         = ISNULL(Reservado, 0.0) + ISNULL(@Reservado, 0.0),
	 Comprometido      = ISNULL(Comprometido, 0.0) + ISNULL(@Comprometido, 0.0),
	 Devengado         = ISNULL(Devengado, 0.0) + ISNULL(@Devengado, 0.0),
	 Ejercido          = ISNULL(Ejercido, 0.0) + ISNULL(@Ejercido, 0.0)
   WHERE Empresa   = @Empresa 
     AND Rama      = @Rama 
     AND Moneda    = @Moneda 
     AND Cuenta    = @Cuenta 
     AND Ejercicio = @Ejercicio
     AND Periodo   = @Periodo
     AND ISNULL(Tipo, '')      = ISNULL(@Tipo, '')
     AND ISNULL(SubCuenta, '') = ISNULL(@SubCuenta, '')
     AND ISNULL(SubCuenta2, '') = ISNULL(@SubCuenta2, '')
     AND ISNULL(SubCuenta3, '') = ISNULL(@SubCuenta3, '')
     AND ISNULL(UEN, 0)        = ISNULL(@UEN, 0)

  IF @@ROWCOUNT = 0
    INSERT Presupuesto (Sucursal,  Empresa,  Rama,  Moneda,  Tipo,  Cuenta,  SubCuenta,  SubCuenta2,  SubCuenta3,   UEN,  Ejercicio,  Periodo,  Presupuesto,  Reservado,  Comprometido,  Devengado,  Ejercido)
                VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Tipo, @Cuenta, @SubCuenta, @SubCuenta2, @SubCuenta3, @UEN, @Ejercicio, @Periodo, @Presupuesto, @Reservado, @Comprometido, @Devengado, @Ejercido)

  SELECT @PPTO = PPTO FROM EmpresaGral WHERE Empresa = @Empresa
  IF @PPTO = 1
  BEGIN
    SELECT @Presupuesto = ISNULL(SUM(Presupuesto), 0.0),
           @Reservado   = ISNULL(SUM(Reservado), 0.0),
           @Comprometido= ISNULL(SUM(Comprometido), 0.0),
           @Devengado   = ISNULL(SUM(Devengado), 0.0),
           @Ejercido    = ISNULL(SUM(Ejercido), 0.0) 
      FROM Presupuesto
     WHERE Empresa   = @Empresa 
       AND Rama      = @Rama 
       AND Moneda    = @Moneda 
       AND Cuenta    = @Cuenta 
       AND Ejercicio = @Ejercicio
       AND Periodo   = @Periodo
       AND ISNULL(Tipo, '')      = ISNULL(@Tipo, '')
       AND ISNULL(SubCuenta, '') = ISNULL(@SubCuenta, '')
       AND ISNULL(SubCuenta2, '') = ISNULL(@SubCuenta2, '')
       AND ISNULL(SubCuenta3, '') = ISNULL(@SubCuenta3, '')
       AND ISNULL(UEN, 0)        = ISNULL(@UEN, 0)

    IF @Presupuesto < 0.0 SELECT @Ok = 50130, @Dif = ABS(@Presupuesto)  ELSE
    IF @Reservado   < 0.0 SELECT @Ok = 50140, @Dif = ABS(@Reservado)    ELSE
    IF @Comprometido< 0.0 SELECT @Ok = 50142, @Dif = ABS(@Comprometido) ELSE
    IF @Devengado   < 0.0 SELECT @Ok = 50144, @Dif = ABS(@Devengado)    ELSE
    IF @Ejercido    < 0.0 SELECT @Ok = 50140, @Dif = ABS(@Ejercido)     ELSE
    IF (@Presupuesto - @Reservado - @Comprometido - @Devengado - @Ejercido) < 0.0 SELECT @Ok = 50160, @Dif = ABS(@Presupuesto - @Reservado - @Ejercido)

    IF @Ok IS NOT NULL SELECT @OkRef = 'Periodo '+CONVERT(varchar, @Periodo)+', Cuenta '+@Cuenta+', UEN '+CONVERT(varchar, @UEN)+', Diferencia '+CONVERT(varchar, @Dif)
  END

  RETURN
END
GO

/*************** spProyectoAsignarPlantilla *******************/
if exists (select * from sysobjects where id = object_id('dbo.spProyectoAsignarPlantilla') and type = 'P') 
  drop procedure dbo.spProyectoAsignarPlantilla
GO             
CREATE PROCEDURE spProyectoAsignarPlantilla
				@ID			int,
    				@ProyPlan	varchar(100)

--//WITH ENCRYPTION
AS BEGIN
/*  DECLARE
    @Prioridad	varchar(10),
    @Orden		int

  SELECT @Prioridad = Prioridad FROM Proyecto WHERE ID = @ID
  DELETE Fase 
   WHERE ID = @ID AND Clave IN (SELECT Clave FROM ProyPlanTarea WHERE Plantilla = @ProyPlan)
  SELECT @Orden = ISNULL(MAX(Orden), 0) FROM Fase WHERE ID = @ID

  INSERT Fase (
         ID,  Clave, Asunto, Orden,        Tiempo, TiempoUnidad, TieneDetalle, Rama, Estado,         Prioridad)
  SELECT @ID, Clave, Asunto, @Orden+Orden, Tiempo, TiempoUnidad, TieneDetalle, Rama, 'No comenzada', @Prioridad 
    FROM ProyPlanTarea
   WHERE Plantilla = @ProyPlan
*/
  RETURN
END
GO

-- spPuedeEditarMovMatrizSucursal 6,6, 82000020, 'CONT', 'DEMO', 'SS', 'Diario', 'CONCLUIDO'
-- spPuedeEditarMovMatrizSucursal 0, 0,	19213,	'INV', 'SUSHI','LGARCIA','Transito','PENDIENTE'
-- spPuedeEditarMovMatrizSucursal 2, 0, 70, 'VTAS', 'DEMO', 'U2', 'Pedido', 'PENDIENTE'
-- select sucursal, usuario from usuario

/**************** spPuedeEditarMovMatrizSucursal ****************/
if exists (select * from sysobjects where id = object_id('dbo.spPuedeEditarMovMatrizSucursal') and type = 'P') drop procedure dbo.spPuedeEditarMovMatrizSucursal
GO
CREATE PROCEDURE spPuedeEditarMovMatrizSucursal
			@Sucursal		int,
			@SucursalOrigen 	int,  -- Nota En el caso de spAplicaOk no pasa la sucursal Origen
                        @ID			int,
			@Modulo			char(5),
                        @Empresa		char(5),
			@Usuario		char(10),
			@Mov			char(20),
			@Estatus		char(15),
		        @EnSilencio		bit = 0,
			@PuedeEditar		bit = 0 OUTPUT,
                        @Aplicando		bit = 0
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @SincroID		timestamp,
    @SincroIDPaquete	timestamp,
    @SincroC		int,
    @SucursalPrincipal 	int,
    @SucursalUsuario	int,
    @Seguimiento	char(20),
    @ChecarSincronizado	bit	

  SELECT @PuedeEditar = 1, @Seguimiento = NULL, @ChecarSincronizado = 0

  IF (SELECT Sincro FROM Version) = 1
  BEGIN
    IF (NULLIF(RTRIM(@Mov), '') IS NOT NULL) 
    BEGIN
      SELECT @PuedeEditar = 0
      SELECT @SucursalPrincipal = Sucursal FROM Version
      SELECT @SucursalUsuario = Sucursal FROM UsuarioSucursal WHERE Usuario = @Usuario
      IF @Estatus = 'SINCRO'
      BEGIN
        IF @SucursalOrigen = @SucursalUsuario 
          SELECT @ChecarSincronizado = 1
      END ELSE
      BEGIN
        IF @Modulo = 'CONT'
        BEGIN 
          IF @SucursalPrincipal = 0
            SELECT @PuedeEditar = 1
          ELSE
            SELECT @ChecarSincronizado = 1
        END ELSE BEGIN
          EXEC spSucursalMovSeguimiento @Sucursal, @Modulo, @Mov, @Seguimiento OUTPUT
          IF @Seguimiento IS NOT NULL
          BEGIN
            IF (@Seguimiento = 'MATRIZ' AND @SucursalPrincipal = 0)
            BEGIN
              EXEC spSincroMovRegistro @Modulo, @ID
              SELECT @PuedeEditar = 1
            END ELSE SELECT @ChecarSincronizado = 1
              -- Si no se ha sincronizado y no esta sincronizado
          END ELSE 
            IF @Sucursal = @SucursalUsuario 
            BEGIN
              EXEC spSincroMovRegistro @Modulo, @ID
              SELECT @PuedeEditar = 1 
            END
        END
      END
    END

    IF @Modulo <> 'CONT' AND @PuedeEditar = 0 AND @Seguimiento IS NULL AND (SELECT AfectarOtrasSucursalesEnLinea FROM Usuario WHERE Usuario = @Usuario) = 1
      EXEC spSucursalEnLinea @Sucursal, @PuedeEditar OUTPUT

    IF @PuedeEditar = 0 AND @ChecarSincronizado = 1
    BEGIN
      IF @Aplicando = 0 AND (SELECT Sincronizando FROM Version) = 0
      BEGIN
        EXEC spMovSincro @ID, @Modulo, @SincroID OUTPUT, @SincroC OUTPUT
        IF @SincroC = 1
        BEGIN
          EXEC sp_executesql N'SELECT @SincroIDPaquete = ISNULL(MAX(SincroID), 0) FROM SincroPaquete WHERE Sucursal = @SucursalPrincipal',
                             N'@SincroIDPaquete timestamp OUTPUT, @SucursalPrincipal int', 
			     @SincroIDPaquete = @SincroIDPaquete OUTPUT, @SucursalPrincipal = @SucursalPrincipal
          IF @SincroID > (@SincroIDPaquete) SELECT @PuedeEditar = 1
        END
      END
    END
  END ELSE IF (SELECT SincroIS FROM Version) = 1
  BEGIN
    IF (NULLIF(RTRIM(@Mov), '') IS NOT NULL) 
    BEGIN
      SELECT @PuedeEditar = 0
      SELECT @SucursalPrincipal = Sucursal FROM Version
      SELECT @SucursalUsuario = Sucursal FROM UsuarioSucursal WHERE Usuario = @Usuario
      IF @Estatus = 'SINCRO'
      BEGIN
        IF @SucursalOrigen = @SucursalUsuario 
          SELECT @ChecarSincronizado = 1
      END ELSE
      BEGIN
        IF @Modulo = 'CONT'
        BEGIN 
          IF @SucursalPrincipal = 0
            SELECT @PuedeEditar = 1
          ELSE
            SELECT @ChecarSincronizado = 1
        END ELSE BEGIN
        
          EXEC spSucursalMovSeguimiento @Sucursal, @Modulo, @Mov, @Seguimiento OUTPUT
          IF @Seguimiento IS NOT NULL
          BEGIN
            IF (@Seguimiento = 'MATRIZ' AND @SucursalPrincipal = 0)
            BEGIN
              EXEC spSincroMovRegistro @Modulo, @ID
              SELECT @PuedeEditar = 1
            END ELSE SELECT @ChecarSincronizado = 1
              -- Si no se ha sincronizado y no esta sincronizado
          END ELSE 
            IF @Sucursal = @SucursalUsuario 
            BEGIN
              EXEC spSincroMovRegistro @Modulo, @ID
              SELECT @PuedeEditar = 1 
            END
        END
      END
    END

    IF @Modulo <> 'CONT' AND @PuedeEditar = 0 AND @Seguimiento IS NULL AND (SELECT AfectarOtrasSucursalesEnLinea FROM Usuario WHERE Usuario = @Usuario) = 1
      EXEC spSucursalEnLinea @Sucursal, @PuedeEditar OUTPUT

    IF @PuedeEditar = 0 AND @ChecarSincronizado = 1
    BEGIN
      IF @Aplicando = 0 AND dbo.fnEstaSincronizando() = 0
      BEGIN
        EXEC spMovSincro @ID, @Modulo, @SincroID OUTPUT, @SincroC OUTPUT
        EXEC sp_executesql N'SELECT @SincroIDPaquete = ISNULL(MAX(SincroID), 0) FROM SincroISControl WHERE SucursalOrigen = @SucursalPrincipal',
                           N'@SincroIDPaquete timestamp OUTPUT, @SucursalPrincipal int', 
		     @SincroIDPaquete = @SincroIDPaquete OUTPUT, @SucursalPrincipal = @SucursalPrincipal
        IF @SincroID > (@SincroIDPaquete) SELECT @PuedeEditar = 1          

      END
    END
  END
  
  IF @EnSilencio = 0 SELECT "PuedeEditar" = @PuedeEditar
  RETURN
END
GO

/************** spRegistrarArtAlm *************/
if exists (select * from sysobjects where id = object_id('dbo.spRegistrarArtAlm') and type = 'P') drop procedure dbo.spRegistrarArtAlm
GO
CREATE PROCEDURE spRegistrarArtAlm
			@Empresa	char(5),
			@Articulo	char(20),
			@SubCuenta	varchar(50),
			@Almacen	char(10),
			@Fecha		datetime = NULL
--//WITH ENCRYPTION
AS BEGIN
  SELECT @SubCuenta = ISNULL(@SubCuenta, ''),
         @Almacen   = NULLIF(UPPER(RTRIM(@Almacen)), '')

  IF @Almacen IS NULL RETURN

  UPDATE ArtAlm SET UltimoMovimiento = @Fecha, TieneMovimientos = 1 WHERE UltimoMovimiento <> @Fecha AND Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Almacen = @Almacen
  IF NOT EXISTS(SELECT * FROM ArtAlm WHERE Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Almacen = @Almacen)
    INSERT ArtAlm (Empresa, Articulo, SubCuenta, Almacen, UltimoMovimiento, TieneMovimientos) VALUES (@Empresa, @Articulo, @SubCuenta, @Almacen, @Fecha, 1)

  RETURN
END
GO

/**************** spRegistrarMovimiento ****************/
if exists (select * from sysobjects where id = object_id('dbo.spRegistrarMovimiento') and type = 'P') drop procedure dbo.spRegistrarMovimiento
GO             
CREATE PROCEDURE spRegistrarMovimiento
			@Sucursal		int,
			@Empresa		char(5), 
			@Modulo			char(5), 
			@Mov			char(20), 
			@MovID			varchar(20), 
			@ID			int,
			@Ejercicio		int, 
			@Periodo		int, 
			@FechaRegistro		datetime, 
			@FechaEmision		datetime,
                        @Concepto		varchar(50), 
			@Proyecto		varchar(50), 
			@MovMoneda		char(10), 
			@MovTipoCambio		float,
                        @Usuario		char(10), 
			@Autorizacion		char(10), 
			@Referencia		varchar(50), 
			@DocFuente		int, 
			@Observaciones		varchar(255),

                        @Generar		bit,
			@GenerarMov 		char(20),
			@GenerarMovID 		varchar(20),
			@GenerarID		int,

			@Ok			int		OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  IF @Ok IS NOT NULL RETURN
  EXEC spExtraerFecha @FechaEmision OUTPUT

  --BUG25014
  IF @Modulo NOT IN ('EMB', 'ST', 'CAM', 'ASIS', 'TMA', 'RSS', 'CMP', 'FRM', 'CAPT', 'GES', 'PROY'/*, 'ACT'*/, 'SAUX', 'CORTE', 'CONTP')
  BEGIN
    IF NULLIF(RTRIM(@MovMoneda), '') IS NULL SELECT @Ok = 30040 ELSE
    IF NULLIF(@MovTipoCambio, 0) IS NULL SELECT @Ok = 30140
  END

  IF (SELECT ConsecutivoControl FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov) = 1
    EXEC spMovTipoConsecutivo @Empresa, @Modulo, @Mov, @MovID, @FechaEmision, @Ok OUTPUT

  IF @MovID IS NOT NULL
    EXEC spMovInsertar @Sucursal, @Empresa, @Modulo, @Mov, @MovID, @ID, @Ejercicio, @Periodo, @FechaRegistro, @FechaEmision,
                       @Concepto, @Proyecto, @MovMoneda, @MovTipoCambio,
                       @Usuario, @Autorizacion, @Referencia, @DocFuente, @Observaciones, @Ok OUTPUT
  IF @Generar = 1 AND @GenerarMovID IS NOT NULL
    EXEC spMovInsertar @Sucursal, @Empresa, @Modulo, @GenerarMov, @GenerarMovID, @GenerarID, @Ejercicio, @Periodo, @FechaRegistro, @FechaRegistro,
                       @Concepto, @Proyecto, @MovMoneda, @MovTipoCambio,
                       @Usuario, @Autorizacion, @Referencia, @DocFuente, @Observaciones, @Ok OUTPUT

  EXEC spTareasPorOmision @Modulo, @ID, @Empresa, @Mov, @Usuario
  RETURN
END
GO

/**************** spRound ****************/
if exists (select * from sysobjects where id = object_id('dbo.spRound') and type = 'P') drop procedure dbo.spRound
GO             
CREATE PROCEDURE spRound
			@Digitos money
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Lugares int

  IF @Digitos = 0      SELECT @Lugares = 0 ELSE
  IF @Digitos <= 0.001 SELECT @Lugares = 3 ELSE
  IF @Digitos <= 0.01  SELECT @Lugares = 2 ELSE
  IF @Digitos <= 0.1   SELECT @Lugares = 1 ELSE
  IF @Digitos <= 1.0   SELECT @Lugares = 0 ELSE
  IF @Digitos <= 10.0  SELECT @Lugares = -1 ELSE
  IF @Digitos <= 100.0 SELECT @Lugares = -2 ELSE
  SELECT @Lugares = -3
  RETURN @Lugares
END
GO

  --REQ12615 WMS
/************** spSaldoU (Unidades) ***************/
if exists (select * from sysobjects where id = object_id('dbo.spSaldoU') and type = 'P') drop procedure dbo.spSaldoU
GO
CREATE PROCEDURE spSaldoU
		   @Sucursal    int,
		   @Accion		char(20),
	       @Empresa		char(5),
		   @Usuario		char(10),
		   @Rama		char(5),
		   @Moneda		char(10),
	       @Cuenta		char(20),
	       @SubCuenta   varchar(50),
	       @Grupo		char(10),
	       @Modulo		char(5),
		   @ID			int,
	       @Mov			char(20),
	       @MovID		varchar(20),
		   @Cargo		money,
		   @Abono		money,
	       @CargoU		float,
	       @AbonoU		float,
	       @Fecha		datetime,
           @EjercicioAfectacion int,
           @PeriodoAfectacion   int,
		   @AcumulaSinDetalles	bit,
           @AcumulaEnLinea	    bit,
           @GeneraAuxiliar	    bit,
           @GeneraSaldo	        bit,
           @Conciliar		    bit,
		   @Aplica		        char(20),
		   @AplicaID		    varchar(20),

		   @EsTransferencia bit,
		   @EsResultados	bit,
		   @EsTipoSerie		bit,

		   @InvNegativoU   	float 		OUTPUT,
		   @ConsignacionU	float   	OUTPUT,
		   @Ok			    int		OUTPUT,
		   @OkRef		    varchar(255)	OUTPUT,
		   @Renglon		    float		= NULL,
		   @RenglonSub		int		= NULL,
		   @RenglonID		int		= NULL,
	       @SubGrupo		varchar(20)	= NULL
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @FechaSinHora       datetime,
    @SubCuentaAcum	varchar(50),
    @ImporteConciliarU	float,
    @TempU	   	float,
    @CargoAuxU		float,
    @AbonoAuxU		float,
    @SaldoAnteriorU 	float,

    @ImporteConciliar	money,
    @Temp	   	money,
    @CargoAux		money,
    @AbonoAux		money,
    @SaldoAnterior 	money,

    @EsCancelacion 	bit,
    @CantidadU		float,

    @INV		float,
    @RESV		float,
    @VMOS		float,
    @GAR		float,
    @CSG		float,
    @AF			float,
    @PZA		float,
    @TMACargoU		float,
    @TMAAbonoU		float,
    @IDGenerar		int, --REQ12534 Factory
    --REQ12615 WMS
    @WMS			bit,
    @MovTipo		varchar(20),
    @IDAplica		varchar(20),
    @Aplica2		varchar(20),
    @AplicaID2		varchar(20),
    @IDAplica2		varchar(20),

	--TASK25114
	--EWQ. Tuning2
    @Articulo		varchar(20),
    @AlmPosTipo		varchar(20),  
    @EsCEDIS		bit,

	--TASK25114
	--BUG24540
    @OrigenMovtipo	varchar(20),

	@WMSAuxiliar	bit, -- TASK1964
	@OrigenMovTipoc varchar(20)
 
  SELECT @WMSAuxiliar = WMSAuxiliar FROM Version -- TASK1964

  -- En el caso de reservados y venta de mostrador no es necesario el control a nivel tarima
  SELECT @SubGrupo = ISNULL(RTRIM(@SubGrupo), '')

  IF @Rama IN('INV','WMS') AND  @SubGrupo <> ''--Task 8036
    SELECT @SubGrupo = ISNULL(dbo.fnAlmacenTarima(@Grupo, @SubGrupo), '')  
  ELSE SELECT @SubGrupo = ''


  --REQ12615 WMS
  SELECT @WMS = WMS FROM Alm WHERE Almacen = @Grupo
  SELECT @MovTipo = Clave FROM MovTipo WHERE Modulo = 'INV' AND Mov = @Mov

  IF @WMS = 1 AND @MovTipo = 'INV.TMA' AND ISNULL(@SubGrupo,'') = ''
  BEGIN     
    SELECT @IDAplica = ID FROM Inv WHERE Mov = @Aplica AND MovID = @AplicaID AND Empresa = @Empresa
    SELECT @Aplica2 = Origen, @AplicaID2 = OrigenID FROM Inv WHERE ID = @IDAplica
    SELECT @IDAplica2 = ID FROM Inv WHERE Mov = @Aplica2 AND MovID = @AplicaID2 AND Empresa = @Empresa
    --SELECT @SubGrupo = ISNULL(Tarima,@SubGrupo) FROM InvD WHERE ID = @IDAplica2 AND NULLIF(Tarima,'') IS NOT NULL  -- CAMBIO USB (DESENTARIMAR)
  END

  --SELECT @SubGrupo = dbo.fnDesentarimadoSubGrupo(@Aplica, @AplicaID, @Empresa, @Mov, @Grupo, @SubGrupo)
  --REQ12615 WMS
 
  SELECT @Cargo  = ISNULL(@Cargo, 0.0), 
         @Abono  = ISNULL(@Abono, 0.0),
         @CargoU = ISNULL(@CargoU, 0.0), 
         @Abonou = ISNULL(@AbonoU, 0.0),
         @SaldoAnterior  = 0.0, 
         @SaldoAnteriorU = 0.0, 
         @InvNegativoU   = 0.0,  
         @ConsignacionU  = 0.0

  IF @Accion IN ('CANCELAR', 'DESAFECTAR')
  BEGIN
    SELECT @EsCancelacion = 1, @Temp = @Cargo, @TempU = @CargoU 
    SELECT @Cargo  = -@Abono,  @Abono = - @Temp, 
           @CargoU = -@AbonoU, @AbonoU = -@TempU
  END ELSE SELECT @EsCancelacion = 0

  --TASK25114
  --BUG24540
  IF @Modulo = 'INV'
    SELECT @OrigenMovTipo = Clave
      FROM MovTipo
      JOIN Inv ON MovTipo.Modulo = 'INV' AND MovTipo.Mov = Inv.Origen
     WHERE Inv.ID = @ID

  --TASK25114
  --EWQ.Tuning2
  IF @WMS = 1 AND @Rama IN('INV','WMS') /*AND @Modulo = 'INV' */AND @Accion = 'AFECTAR' --Task 8036 
  BEGIN
    IF ISNULL(RTRIM(@SubGrupo), '') <> ''
    BEGIN    
      SELECT @AlmPosTipo = Tipo
        FROM AlmPos
        JOIN Tarima ON AlmPos.Posicion = Tarima.Posicion
       WHERE Tarima.Tarima = @SubGrupo
         AND AlmPos.Almacen = @Grupo

  --    IF @AlmPosTipo IN('Domicilio', 'Ubicacion')
  --    BEGIN
  --      SELECT @Articulo = Articulo FROM ArtDisponibleTarima WHERE Almacen = @Grupo AND Tarima = @SubGrupo AND Empresa = @Empresa
		----SELECT @Articulo=Articulo FROM Tarima WHERE Almacen = @Grupo AND Tarima = @SubGrupo --TASK2429PGC

  --      IF @Articulo IS NOT NULL AND @Articulo <> @Cuenta AND ISNULL(@OrigenMovTipo, '') <> 'INV.IF'
  --        SELECT @Ok = 13015, @OkRef = 'Tarima: ' + @SubGrupo + ', Artículo: ' + @Articulo
  --    END
    END
  END

  -- Actualizar Saldos
  IF @GeneraSaldo = 1 AND @Ok IS NULL
  BEGIN
    IF @AcumulaSinDetalles = 1 SELECT @SubCuentaAcum = '' ELSE SELECT @SubCuentaAcum = @SubCuenta
    IF @Conciliar = 1 
      SELECT @ImporteConciliar  = @Cargo  - @Abono, 
             @ImporteConciliarU = @CargoU - @AbonoU 
    ELSE 
      SELECT @ImporteConciliar  = 0.0, 
             @ImporteConciliarU = 0.0

    IF @EsResultados = 0
      SELECT @SaldoAnterior  = ISNULL(SUM(Saldo), 0.0), @SaldoAnteriorU = ISNULL(SUM(SaldoU), 0.0)
        FROM SaldoUGral WITH (ROWLOCK)
       WHERE /*Sucursal = @Sucursal AND */Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND SubGrupo = @SubGrupo AND Cuenta = @Cuenta AND SubCuenta = @SubCuentaAcum
    ELSE
      SELECT @SaldoAnterior  = ISNULL(SUM(Saldo), 0.0), @SaldoAnteriorU = ISNULL(SUM(SaldoU), 0.0)
        FROM SaldoRU WITH (ROWLOCK)
       WHERE /*Sucursal = @Sucursal AND */Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND Cuenta = @Cuenta AND SubCuenta = @SubCuentaAcum

    IF @WMS = 1
    BEGIN
		IF @EsResultados = 0
		  SELECT @SaldoAnterior  = @SaldoAnterior - ISNULL(SUM(Saldo), 0.0), @SaldoAnteriorU = @SaldoAnteriorU - ISNULL(SUM(SaldoU), 0.0)
			FROM SaldoU WITH (ROWLOCK)
		   WHERE /*Sucursal = @Sucursal AND */Empresa = @Empresa AND Rama = 'RESV' AND Moneda = @Moneda AND Grupo = @Grupo AND SubGrupo = @SubGrupo AND Cuenta = @Cuenta AND SubCuenta = @SubCuentaAcum
		ELSE
		  SELECT @SaldoAnterior  = @SaldoAnterior - ISNULL(SUM(Saldo), 0.0), @SaldoAnteriorU = @SaldoAnteriorU - ISNULL(SUM(SaldoU), 0.0)
			FROM SaldoRU WITH (ROWLOCK)
		   WHERE /*Sucursal = @Sucursal AND */Empresa = @Empresa AND Rama = 'RESV' AND Moneda = @Moneda AND Grupo = @Grupo AND Cuenta = @Cuenta AND SubCuenta = @SubCuentaAcum
	END

    IF @@ERROR <> 0 SELECT @Ok = 1

    IF @EsTipoSerie = 1 AND @Rama IN('INV','WMS') AND @SubCuentaAcum <> '' AND (@SaldoAnteriorU + @CargoU - @AbonoU > 1.0 ) AND @Ok IS NULL--Task 8036
    BEGIN
      SELECT @Ok = 20080, @OkRef = 'Articulo: '+RTRIM(@Cuenta)+ ' ('+@SubCuentaAcum+')'
      RETURN
    END
	
    IF @Rama IN('INV','WMS') AND (@CargoU < 0.0 OR @AbonoU > 0.0) AND (@SaldoAnteriorU + @CargoU - @AbonoU < 0.0 )--Task 8036
      SELECT @InvNegativoU = (@SaldoAnteriorU + @CargoU - @AbonoU) * -1

	SELECT @OrigenMovTipoc = Clave
      FROM MovTipo
      JOIN Inv ON MovTipo.Modulo = 'INV' 
	   AND MovTipo.Mov = Inv.Mov
     WHERE Inv.ID = @ID
      
    IF @InvNegativoU <> 0.0 AND @Rama IN('INV','WMS') AND @OrigenMovTipoc <> 'INV.A'--Task 8036
    BEGIN
      -- ArtConsignacion
      SELECT @ConsignacionU = ISNULL(SUM(SaldoU), 0.0) 
        FROM SaldoU WITH (ROWLOCK)
       WHERE Rama = 'CSG' AND Sucursal = @Sucursal AND Empresa = @Empresa AND SubGrupo = @SubGrupo AND Cuenta = @Cuenta

      IF @@ERROR <> 0 SELECT @Ok = 1

      IF @ConsignacionU <> 0.0 AND @InvNegativoU < @ConsignacionU
        SELECT @ConsignacionU = @InvNegativoU

      IF @EsTransferencia = 1 AND @ConsignacionU <> 0.0
        IF @CargoU < 0.0 SELECT @CargoU = @CargoU + @ConsignacionU ELSE SELECT @AbonoU = @AbonoU - @ConsignacionU

      IF @EsTransferencia = 0 AND @ConsignacionU <> 0.0 AND @Accion NOT IN ('CANCELAR', 'DESAFECTAR') AND @Modulo <> 'COMS'
        EXEC spComprarConsignacion @Sucursal, @Empresa, @Usuario, @Cuenta, @SubCuenta, @Grupo, @SubGrupo, @ConsignacionU, @Modulo, @Mov, @MovID,
                                   @Fecha, @EjercicioAfectacion, @PeriodoAfectacion,
                                   @Ok OUTPUT, @OkRef OUTPUT
    END

    IF @EsResultados = 0
    BEGIN
      IF @WMSAuxiliar = 1 -- TASK1964
      BEGIN
        IF @SubGrupo <> ''
    	BEGIN
          UPDATE SaldoUWMS  WITH (ROWLOCK)   
             SET Saldo         = ISNULL(Saldo, 0.0), SaldoU        = ISNULL(SaldoU, 0.0) + @CargoU - @AbonoU,  
                 PorConciliar  = PorConciliar  + @ImporteConciliar,      PorConciliarU = PorConciliarU + @ImporteConciliarU  
           WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND SubGrupo = @SubGrupo AND Cuenta = @Cuenta AND SubCuenta = @SubCuentaAcum
  
          IF @@ROWCOUNT = 0  
            INSERT SaldoUWMS WITH (ROWLOCK)(Sucursal,  Empresa,  Rama,  Moneda,  Grupo,  SubGrupo,  Cuenta,  SubCuenta,      Saldo,              SaldoU,             PorConciliar,      PorConciliarU,      UltimoCambio)
                                    VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Grupo, @SubGrupo, @Cuenta, @SubCuentaAcum, 0, (@CargoU - @AbonoU), @ImporteConciliar, @ImporteConciliarU, @Fecha)
        END ELSE BEGIN -- TASK1964
          UPDATE SaldoU WITH (ROWLOCK)   
             SET Saldo         = ISNULL(Saldo, 0.0)  + @Cargo  - @Abono, SaldoU        = ISNULL(SaldoU, 0.0) + @CargoU - @AbonoU,  
                 PorConciliar  = PorConciliar  + @ImporteConciliar,      PorConciliarU = PorConciliarU + @ImporteConciliarU  
           WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND SubGrupo = @SubGrupo AND Cuenta = @Cuenta AND SubCuenta = @SubCuentaAcum
  
          IF @@ROWCOUNT = 0  
            INSERT SaldoU WITH (ROWLOCK)(Sucursal,  Empresa,  Rama,  Moneda,  Grupo,  SubGrupo,  Cuenta,  SubCuenta,      Saldo,              SaldoU,             PorConciliar,      PorConciliarU,      UltimoCambio)
                                     VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Grupo, @SubGrupo, @Cuenta, @SubCuentaAcum, (@Cargo - @Abono), (@CargoU - @AbonoU), @ImporteConciliar, @ImporteConciliarU, @Fecha)      
        END
      END ELSE BEGIN -- TASK1964
		EXEC dbo.sp_executesql N'UPDATE SaldoU WITH (ROWLOCK) 
           SET Saldo         = ISNULL(Saldo, 0.0)  + @Cargo  - @Abono, SaldoU        = ISNULL(SaldoU, 0.0) + @CargoU - @AbonoU,
               PorConciliar  = PorConciliar  + @ImporteConciliar,      PorConciliarU = PorConciliarU + @ImporteConciliarU
         WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND SubGrupo = @SubGrupo AND Cuenta = @Cuenta AND SubCuenta = @SubCuentaAcum
        IF @@ROWCOUNT = 0
          INSERT SaldoU (Sucursal,  Empresa,  Rama,  Moneda,  Grupo,  SubGrupo,  Cuenta,  SubCuenta,      Saldo,              SaldoU,             PorConciliar,      PorConciliarU,      UltimoCambio)
                 VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Grupo, @SubGrupo, @Cuenta, @SubCuentaAcum, (@Cargo - @Abono), (@CargoU - @AbonoU), @ImporteConciliar, @ImporteConciliarU, @Fecha)',
		N'@Sucursal int, @Empresa varchar(5), @Rama varchar(50), @Moneda varchar(50), @Grupo varchar(50), @SubGrupo varchar(50), @Cuenta varchar(50), @SubCuentaAcum varchar(50),
		  @Cargo money, @Abono money, @CargoU float, @AbonoU float, @ImporteConciliar money, @ImporteConciliarU money, @Fecha datetime',
		@Sucursal, @Empresa, @Rama, @Moneda, @Grupo, @SubGrupo, @Cuenta, @SubCuentaAcum, @Cargo, @Abono, @CargoU, @AbonoU, @ImporteConciliar, @ImporteConciliarU, @Fecha
      END -- TASK1964

      IF @@ERROR <> 0 SELECT @Ok = 1
    END ELSE BEGIN
      UPDATE SaldoRU WITH (ROWLOCK) 
         SET Saldo         = ISNULL(Saldo, 0.0)  + @Cargo  - @Abono, SaldoU        = ISNULL(SaldoU, 0.0) + @CargoU - @AbonoU,
             PorConciliar  = PorConciliar  + @ImporteConciliar,      PorConciliarU = PorConciliarU + @ImporteConciliarU
       WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND Cuenta = @Cuenta AND SubCuenta = @SubCuentaAcum

      IF @@ROWCOUNT = 0
        INSERT SaldoRU (Sucursal,  Empresa,  Rama,  Moneda,  Grupo,  Cuenta,  SubCuenta,      Saldo,              SaldoU,             PorConciliar,      PorConciliarU,      UltimoCambio)
                VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Grupo, @Cuenta, @SubCuentaAcum, (@Cargo - @Abono), (@CargoU - @AbonoU), @ImporteConciliar, @ImporteConciliarU, @Fecha)
      IF @@ERROR <> 0 SELECT @Ok = 1
    END  -- TASK1964
  END

  -- Generar Auxiliares
  IF @GeneraAuxiliar = 1 AND @Ok IS NULL
  BEGIN
    IF @Accion = 'DESAFECTAR'
    BEGIN
      IF (SELECT Sucursal FROM Version) <> 0
        SELECT @Ok = 60290

      IF @EsResultados = 0
	  BEGIN
        IF @WMSAuxiliar = 1 -- TASK1964
        BEGIN
          IF @SubGrupo <> '' -- TASK1964
          BEGIN
            DELETE AuxiliarUWMS
             WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND SubGrupo = @SubGrupo AND Cuenta = @Cuenta
               AND SubCuenta = @SubCuenta AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @EjercicioAfectacion AND Periodo = @PeriodoAfectacion
          END ELSE BEGIN -- TASK1964
            DELETE AuxiliarU
             WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND SubGrupo = @SubGrupo AND Cuenta = @Cuenta
               AND SubCuenta = @SubCuenta AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @EjercicioAfectacion AND Periodo = @PeriodoAfectacion
          END
        END ELSE -- TASK1964
		  EXEC dbo.sp_executesql N'
          DELETE AuxiliarU 
           WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND SubGrupo = @SubGrupo AND Cuenta = @Cuenta
             AND SubCuenta = @SubCuenta AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @EjercicioAfectacion AND Periodo = @PeriodoAfectacion', 
           N'@Sucursal int, @Empresa varchar(5), @Rama varchar(5), @Moneda varchar(20), @Grupo varchar(10), @SubGrupo varchar(20), @Cuenta varchar(20), @SubCuenta varchar(50),
		     @Mov varchar(20), @MovID varchar(20), @EjercicioAfectacion int, @PeriodoAfectacion int,',
		     @Sucursal, @Empresa, @Rama, @Moneda, @Grupo, @SubGrupo, @Cuenta, @SubCuenta, @Mov, @MovID, @EjercicioAfectacion, @PeriodoAfectacion
      END ELSE
        DELETE AuxiliarRU 
         WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND Cuenta = @Cuenta
           AND SubCuenta = @SubCuenta AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @EjercicioAfectacion AND Periodo = @PeriodoAfectacion

      IF @@ROWCOUNT = 0 SELECT @Ok = 60100, @OkRef = 'Movimiento: '+RTRIM(@Mov) + ' ' +LTRIM(Convert(Char, @MovID))
    END ELSE
    BEGIN
      SELECT @FechaSinHora = @Fecha,
             @CargoAux  = NULLIF(@Cargo, 0.0),  @AbonoAux  = NULLIF(@Abono, 0.0),    
             @CargoAuxU = NULLIF(@CargoU, 0.0), @AbonoAuxU = NULLIF(@AbonoU, 0.0)
      EXEC spExtraerFecha @FechaSinHora OUTPUT

      IF @EsResultados = 0
      BEGIN
        IF @WMSAuxiliar = 1 -- TASK1964
        BEGIN
          IF @SubGrupo <> '' -- TASK1964
          BEGIN
            INSERT AuxiliarUWMS (Sucursal, Empresa, Rama, Moneda, Cuenta, SubCuenta, Ejercicio, Periodo, Fecha,
                              Grupo, SubGrupo, Modulo, ModuloID, Mov, MovID, Cargo, Abono, CargoU, AbonoU, Aplica, AplicaID, Acumulado, Conciliado, EsCancelacion,
                              Renglon, RenglonSub)
                      VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Cuenta, @SubCuenta, @EjercicioAfectacion, @PeriodoAfectacion, @FechaSinHora,
                              @Grupo, @SubGrupo, @Modulo, @ID, @Mov, @MovID, @CargoAux, @AbonoAux, @CargoAuxU, @AbonoAuxU, @Aplica, @AplicaID, @AcumulaEnLinea, 0, @EsCancelacion,
                              @Renglon, @RenglonSub)
          END ELSE BEGIN  -- TASK1964
            INSERT AuxiliarU (Sucursal, Empresa, Rama, Moneda, Cuenta, SubCuenta, Ejercicio, Periodo, Fecha,
                              Grupo, SubGrupo, Modulo, ModuloID, Mov, MovID, Cargo, Abono, CargoU, AbonoU, Aplica, AplicaID, Acumulado, Conciliado, EsCancelacion,
                              Renglon, RenglonSub)
                      VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Cuenta, @SubCuenta, @EjercicioAfectacion, @PeriodoAfectacion, @FechaSinHora,
                              @Grupo, @SubGrupo, @Modulo, @ID, @Mov, @MovID, @CargoAux, @AbonoAux, @CargoAuxU, @AbonoAuxU, @Aplica, @AplicaID, @AcumulaEnLinea, 0, @EsCancelacion,
                              @Renglon, @RenglonSub)
          END
        END ELSE BEGIN -- TASK1964
		  EXEC dbo.sp_executesql N'
            INSERT AuxiliarU (Sucursal, Empresa, Rama, Moneda, Cuenta, SubCuenta, Ejercicio, Periodo, Fecha,
       	                      Grupo, SubGrupo, Modulo, ModuloID, Mov, MovID, Cargo, Abono, CargoU, AbonoU, Aplica, AplicaID, Acumulado, Conciliado, EsCancelacion,
                              Renglon, RenglonSub)
                      VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Cuenta, @SubCuenta, @EjercicioAfectacion, @PeriodoAfectacion, @FechaSinHora,
	  	                      @Grupo, @SubGrupo, @Modulo, @ID, @Mov, @MovID, @CargoAux, @AbonoAux, @CargoAuxU, @AbonoAuxU, @Aplica, @AplicaID, @AcumulaEnLinea, 0, @EsCancelacion,
                              @Renglon, @RenglonSub)',
            N'@Sucursal int, @Empresa varchar(5), @Rama varchar(5), @Moneda varchar(20), @Cuenta varchar(20), @SubCuenta varchar(50), @EjercicioAfectacion int, @PeriodoAfectacion int,
			  @FechaSinHora datetime, @Grupo varchar(10), @SubGrupo varchar(20), @Modulo varchar(5), @ID int, @Mov varchar(20), @MovID varchar(20), @CargoAux money, @AbonoAux money,
			  @CargoAuxU float, @AbonoAuxU float, @Aplica varchar(20), @AplicaID varchar(20), @AcumulaEnLinea bit, @EsCancelacion bit, @Renglon float, @RenglonSub int',
		    @Sucursal, @Empresa, @Rama, @Moneda, @Cuenta, @SubCuenta, @EjercicioAfectacion, @PeriodoAfectacion, @FechaSinHora, @Grupo, @SubGrupo, @Modulo, @ID, @Mov, @MovID, 
			@CargoAux, @AbonoAux, @CargoAuxU, @AbonoAuxU, @Aplica, @AplicaID, @AcumulaEnLinea, @EsCancelacion, @Renglon, @RenglonSub
        END -- TASK1964
      END
--REQ12534 Factory
        SET @IDGenerar = SCOPE_IDENTITY()

        INSERT AuxiliarRU (Sucursal, Empresa, Rama, Moneda, Cuenta, SubCuenta, Ejercicio, Periodo, Fecha,
      	                   Grupo, Modulo, ModuloID, Mov, MovID, Cargo, Abono, CargoU, AbonoU, Aplica, AplicaID, Acumulado, Conciliado, EsCancelacion,
                           Renglon, RenglonSub)
                   VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Cuenta, @SubCuenta, @EjercicioAfectacion, @PeriodoAfectacion, @FechaSinHora,
                           @Grupo, @Modulo, @ID, @Mov, @MovID, @CargoAux, @AbonoAux, @CargoAuxU, @AbonoAuxU, @Aplica, @AplicaID, @AcumulaEnLinea, 0, @EsCancelacion,
                           @Renglon, @RenglonSub)
      
	--REQ12534 Factory   // bug 54026
		IF @Mov = 'Redondeo'
		BEGIN
			UPDATE INV SET OrigenTipo = 'I:MES', MovMES = 1 WHERE ID = @ID
		END
		ELSE
		BEGIN       
         EXEC spInforSaldoU @Sucursal, @Accion, @Empresa, @Usuario, @Rama, @Moneda, @Cuenta, @SubCuenta, @Grupo, 
                  @Modulo, @ID, @Mov, @MovID, @Cargo, @Abono, @CargoU, @AbonoU, @Fecha, 
                  @EjercicioAfectacion, @PeriodoAfectacion, @AcumulaSinDetalles, @AcumulaEnLinea, @GeneraAuxiliar,
                  @GeneraSaldo, @Conciliar, @Aplica, @AplicaID, @EsTransferencia, @EsResultados, @EsTipoSerie,
                  @InvNegativoU, @ConsignacionU,@IDGenerar, @Ok OUTPUT, @OkRef OUTPUT, @Renglon = @Renglon, @RenglonSub = @RenglonSub,
				  @RenglonID = @RenglonID, @SubGrupo = @SubGrupo
	    END

		IF @@ERROR <> 0 SELECT @Ok = 1
    END
  END

  -- Actualizar Acumulados
  IF @AcumulaEnLinea = 1 AND @Ok IS NULL
  BEGIN
    IF @AcumulaSinDetalles = 1 SELECT @SubCuentaAcum = '' ELSE SELECT @SubCuentaAcum = @SubCuenta

    IF @EsResultados = 0
    BEGIN
      IF @WMSAuxiliar = 1 -- TASK1964
      BEGIN
        IF @SubGrupo <> '' -- TASK1964
        BEGIN
          UPDATE AcumUWMS WITH (ROWLOCK) 
             SET Cargos  = ISNULL(Cargos, 0.0)  + @Cargo,  Abonos  = ISNULL(Abonos, 0.0)  + @Abono,
                 CargosU = ISNULL(CargosU, 0.0) + @CargoU, AbonosU = ISNULL(AbonosU, 0.0) + @AbonoU,
                 UltimoCambio = @Fecha
           WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND SubGrupo = @SubGrupo AND Cuenta = @Cuenta 
             AND SubCuenta = @SubCuentaAcum AND Periodo = @PeriodoAfectacion AND Ejercicio = @EjercicioAfectacion

          IF @@ROWCOUNT = 0
            INSERT AcumUWMS (Sucursal,  Empresa,  Rama,  Moneda,  Grupo,  SubGrupo,  Cuenta,  SubCuenta,      Ejercicio,            Periodo,            Cargos, Abonos, CargosU, AbonosU, UltimoCambio)
                  VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Grupo, @SubGrupo, @Cuenta, @SubCuentaAcum, @EjercicioAfectacion, @PeriodoAfectacion, @Cargo, @Abono, @CargoU, @AbonoU, @Fecha)
        END ELSE BEGIN -- TASK1964
          UPDATE AcumU WITH (ROWLOCK) 
             SET Cargos  = ISNULL(Cargos, 0.0)  + @Cargo,  Abonos  = ISNULL(Abonos, 0.0)  + @Abono,
                 CargosU = ISNULL(CargosU, 0.0) + @CargoU, AbonosU = ISNULL(AbonosU, 0.0) + @AbonoU,
                 UltimoCambio = @Fecha
           WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND SubGrupo = @SubGrupo AND Cuenta = @Cuenta 
             AND SubCuenta = @SubCuentaAcum AND Periodo = @PeriodoAfectacion AND Ejercicio = @EjercicioAfectacion

          IF @@ROWCOUNT = 0
            INSERT AcumU (Sucursal,  Empresa,  Rama,  Moneda,  Grupo,  SubGrupo,  Cuenta,  SubCuenta,      Ejercicio,            Periodo,            Cargos, Abonos, CargosU, AbonosU, UltimoCambio)
                  VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Grupo, @SubGrupo, @Cuenta, @SubCuentaAcum, @EjercicioAfectacion, @PeriodoAfectacion, @Cargo, @Abono, @CargoU, @AbonoU, @Fecha)
        END
      END ELSE BEGIN -- TASK1964
		EXEC dbo.sp_executesql N'
          UPDATE AcumU WITH (ROWLOCK) 
             SET Cargos  = ISNULL(Cargos, 0.0)  + @Cargo,  Abonos  = ISNULL(Abonos, 0.0)  + @Abono,
                 CargosU = ISNULL(CargosU, 0.0) + @CargoU, AbonosU = ISNULL(AbonosU, 0.0) + @AbonoU,
                 UltimoCambio = @Fecha
           WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND SubGrupo = @SubGrupo AND Cuenta = @Cuenta 
             AND SubCuenta = @SubCuentaAcum AND Periodo = @PeriodoAfectacion AND Ejercicio = @EjercicioAfectacion

          IF @@ROWCOUNT = 0
            INSERT AcumU (Sucursal,  Empresa,  Rama,  Moneda,  Grupo,  SubGrupo,  Cuenta,  SubCuenta,      Ejercicio,            Periodo,            Cargos, Abonos, CargosU, AbonosU, UltimoCambio)
                  VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Grupo, @SubGrupo, @Cuenta, @SubCuentaAcum, @EjercicioAfectacion, @PeriodoAfectacion, @Cargo, @Abono, @CargoU, @AbonoU, @Fecha)', 
          N'@Sucursal int, @Empresa varchar(5), @Rama varchar(5), @Moneda varchar(20), @Grupo varchar(10), @SubGrupo varchar(20), @Cuenta varchar(20), @SubCuentaAcum varchar(50), 
		    @EjercicioAfectacion int, @PeriodoAfectacion int, @Cargo money, @Abono money, @CargoU float, @AbonoU float, @Fecha datetime',
		  @Sucursal, @Empresa, @Rama, @Moneda, @Grupo, @SubGrupo, @Cuenta, @SubCuentaAcum, @EjercicioAfectacion, @PeriodoAfectacion, @Cargo, @Abono, @CargoU, @AbonoU, @Fecha
      END -- TASK1964
      IF @@ERROR <> 0 SELECT @Ok = 1
    END ELSE 
    BEGIN
      UPDATE AcumRU WITH (ROWLOCK) 
         SET Cargos  = ISNULL(Cargos, 0.0)  + @Cargo,  Abonos  = ISNULL(Abonos, 0.0)  + @Abono,
             CargosU = ISNULL(CargosU, 0.0) + @CargoU, AbonosU = ISNULL(AbonosU, 0.0) + @AbonoU,
             UltimoCambio = @Fecha
       WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND Cuenta = @Cuenta 
         AND SubCuenta = @SubCuentaAcum AND Periodo = @PeriodoAfectacion AND Ejercicio = @EjercicioAfectacion

      IF @@ROWCOUNT = 0
        INSERT AcumRU (Sucursal,  Empresa,  Rama,  Moneda,  Grupo,  Cuenta,  SubCuenta,      Ejercicio,            Periodo,            Cargos, Abonos, CargosU, AbonosU, UltimoCambio)
               VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Grupo, @Cuenta, @SubCuentaAcum, @EjercicioAfectacion, @PeriodoAfectacion, @Cargo, @Abono, @CargoU, @AbonoU, @Fecha)
      IF @@ERROR <> 0 SELECT @Ok = 1
    END
  END

  -- Afectar ArtR (Es muy importate que el calculo de cantidadU se haga en este momento porque cargou y abonou pueden variar por las compras a consignacion)
/*  SELECT @CantidadU = @CargoU - @AbonoU
  IF @Rama IN ('INV', 'RESV', 'VMOS', 'CSG', 'GAR', 'AF', 'PZA') AND NULLIF(RTRIM(@Grupo), '') IS NOT NULL AND @CantidadU <> 0.0  AND @Ok IS NULL
  BEGIN
    SELECT @INV = 0.0, @RESV = 0.0, @VMOS = 0.0, @GAR = 0.0, @CSG = 0.0, @AF = 0.0, @PZA = 0.0
    IF @Rama = 'INV'  SELECT @INV  = @CantidadU ELSE
    IF @Rama = 'RESV' SELECT @RESV = @CantidadU ELSE
    IF @Rama = 'VMOS' SELECT @VMOS = @CantidadU ELSE
    IF @Rama = 'CSG'  SELECT @CSG  = @CantidadU ELSE
    IF @Rama = 'GAR'  SELECT @GAR  = @CantidadU ELSE
    IF @Rama = 'AF'   SELECT @AF   = @CantidadU ELSE
    IF @Rama = 'PZA'  SELECT @PZA  = @CantidadU
    UPDATE ArtR
       SET INV  = ISNULL(INV,  0.0) + @INV,
           RESV = ISNULL(RESV, 0.0) + @RESV,
           VMOS = ISNULL(VMOS, 0.0) + @VMOS,
           CSG  = ISNULL(CSG,  0.0) + @CSG,
           GAR  = ISNULL(GAR,  0.0) + @GAR,
           AF   = ISNULL(AF,   0.0) + @AF,
           PZA  = ISNULL(PZA,  0.0) + @PZA,
	   TieneMovimientos = 1 
     WHERE Empresa = @Empresa
       AND Articulo = @Cuenta
       AND SubCuenta = ISNULL(@SubCuenta, '')
       AND Almacen = @Grupo
    IF @@ROWCOUNT = 0
      INSERT ArtR (Empresa,  Articulo,  SubCuenta,              Almacen,  INV,  RESV,  VMOS,  GAR,  CSG,  AF,  PZA, TieneMovimientos)
           VALUES (@Empresa, @Cuenta,   ISNULL(@SubCuenta, ''), @Grupo,  @INV, @RESV, @VMOS, @GAR, @CSG, @AF, @PZA, 1)
  END
*/

  -- Afectar Inventario Tarimas
  /*
  IF @Rama = 'INV' AND @SubGrupo <> '' 
  BEGIN
    IF (SELECT WMSInventarioTarimas FROM EmpresaCfg WHERE Empresa = @Empresa) = 1
    BEGIN
      SELECT @TMACargoU = 0.0, @TMAAbonoU = 0.0
      IF @CargoU > 0.0 SELECT @TMACargoU = 1.0 ELSE IF @CargoU < 0.0 SELECT @TMACargoU = -1.0 
      IF @AbonoU > 0.0 SELECT @TMAAbonoU = 1.0 ELSE IF @AbonoU < 0.0 SELECT @TMAAbonoU = -1.0    
      EXEC spSaldoU @Sucursal, @Accion, @Empresa, @Usuario, 'TMA', @Moneda, @SubGrupo, '', @Grupo,
                    @Modulo, @ID, @Mov, @MovID, NULL, NULL, @TMACargoU, @TMAAbonoU, @Fecha,
	  	    @EjercicioAfectacion, @PeriodoAfectacion, 0, 1, 1,
	  	    1, @Conciliar, @Aplica, @AplicaID, 0, 0, 0, 
		    NULL, NULL, @Ok OUTPUT, @OkRef OUTPUT, @Renglon, @RenglonSub, @RenglonID, NULL
    END
  END*/
  
  --Integración MES
  IF (SELECT IntelMESInterfase FROM EmpresaCfg WHERE Empresa = @Empresa) = 1
	EXEC xpMESSaldoU @Sucursal, @Accion, @Empresa, @Usuario, @Rama, @Moneda, @Cuenta, @SubCuenta, @Grupo, 
                  @Modulo, @ID, @Mov, @MovID, @Cargo, @Abono, @CargoU, @AbonoU, @Fecha, 
	  	  @EjercicioAfectacion, @PeriodoAfectacion, @AcumulaSinDetalles, @AcumulaEnLinea, @GeneraAuxiliar,
		  @GeneraSaldo, @Conciliar, @Aplica, @AplicaID, @EsTransferencia, @EsResultados, @EsTipoSerie,
		  @InvNegativoU, @ConsignacionU, @Ok OUTPUT, @OkRef OUTPUT, @Renglon = @Renglon, @RenglonSub = @RenglonSub, @RenglonID = @RenglonID, @SubGrupo = @SubGrupo
  
  
  --xp's
  IF @Ok IS NULL
    EXEC xpSaldoU @Sucursal, @Accion, @Empresa, @Usuario, @Rama, @Moneda, @Cuenta, @SubCuenta, @Grupo, 
                  @Modulo, @ID, @Mov, @MovID, @Cargo, @Abono, @CargoU, @AbonoU, @Fecha, 
	  	  @EjercicioAfectacion, @PeriodoAfectacion, @AcumulaSinDetalles, @AcumulaEnLinea, @GeneraAuxiliar,
		  @GeneraSaldo, @Conciliar, @Aplica, @AplicaID, @EsTransferencia, @EsResultados, @EsTipoSerie,
		  @InvNegativoU, @ConsignacionU, @Ok OUTPUT, @OkRef OUTPUT, @Renglon = @Renglon, @RenglonSub = @RenglonSub, @RenglonID = @RenglonID, @SubGrupo = @SubGrupo
  
  
  
  
  RETURN 
END
GO

/**************** spSaldoInicialU ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSaldoInicialU') and type = 'P') drop procedure dbo.spSaldoInicialU
GO             
CREATE PROCEDURE spSaldoInicialU
			@Empresa	char(5),
			@Rama		char(5), 
                        @MonedaBase	char(10),
			@GrupoBase	char(10), 
			@CuentaBase	char(20), 
			@SubCuentaBase	varchar(50),
			@EsResultados	bit,
			@FechaInicial	datetime, 
			@CargoInicial 	money	OUTPUT,
			@AbonoInicial 	money	OUTPUT,
			@CargoInicialU 	float	OUTPUT,
			@AbonoInicialU 	float	OUTPUT,
			@Ok		int	OUTPUT,
			@SubGrupoBase	varchar(20)	= '' 
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
    @Ejercicio	int,
    @Periodo	int

  IF @Rama = 'INV' 
    SELECT @SubGrupoBase = ISNULL(dbo.fnAlmacenTarima(@GrupoBase, @SubGrupoBase), '')
  ELSE SELECT @SubGrupoBase = ''

  SELECT @CargoInicial = 0.0, @AbonoInicial = 0.0 
  EXEC spPeriodoEjercicio @Empresa, @Rama, @FechaInicial, @Periodo OUTPUT, @Ejercicio OUTPUT, @Ok OUTPUT

  IF @EsResultados = 0
  BEGIN
    SELECT @CargoInicial = ISNULL(Sum(Cargos), 0.0), @CargoInicialU = ISNULL(Sum(CargosU), 0.0),
           @AbonoInicial = ISNULL(Sum(Abonos), 0.0), @AbonoInicialU = ISNULL(Sum(AbonosU), 0.0) 
      FROM
    ( 
    SELECT Cargos, CargosU, Abonos, AbonosU
	  FROM AcumU 
     WHERE Empresa   = @Empresa
       AND Rama      = @Rama
       AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
       AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
       AND SubGrupo  = CASE @SubGrupoBase  WHEN NULL THEN SubGrupo  ELSE @SubGrupoBase  END
       AND Cuenta    = @CuentaBase --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
       AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
       AND Ejercicio = @Ejercicio 
       AND Periodo < @Periodo
	 UNION ALL
	SELECT Cargos, CargosU, Abonos, AbonosU
      FROM AcumUWMS
     WHERE Empresa   = @Empresa
       AND Rama      = @Rama
       AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
       --AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
       AND Cuenta    = @CuentaBase --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
       AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
       AND Ejercicio = @Ejercicio 
       AND Periodo < @Periodo    	    
    ) A

    IF @@ERROR <> 0 SELECT @Ok = 1

    IF DATEPART(dd, @FechaInicial) > 1 
    BEGIN
      SELECT @CargoInicial = ISNULL(@CargoInicial, 0.0) + ISNULL(Sum(Cargo), 0.0), @CargoInicialU = ISNULL(@CargoInicialU, 0.0) + ISNULL(Sum(CargoU), 0.0),
             @AbonoInicial = ISNULL(@AbonoInicial, 0.0) + ISNULL(Sum(Abono), 0.0), @AbonoInicialU = ISNULL(@AbonoInicialU, 0.0) + ISNULL(Sum(AbonoU), 0.0)
        FROM
	  (
	  SELECT Cargo, CargoU, Abono, AbonoU
        FROM AuxiliarU 
       WHERE Empresa   = @Empresa
         AND Rama      = @Rama
         AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
         AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
         AND SubGrupo  = CASE @SubGrupoBase  WHEN NULL THEN SubGrupo  ELSE @SubGrupoBase  END
         AND Cuenta    = @CuentaBase --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
         AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
         AND Ejercicio = @Ejercicio 
         AND Periodo   = @Periodo
         AND Fecha < @FechaInicial
   UNION ALL 
   	  SELECT Cargo, CargoU, Abono, AbonoU
		FROM AuxiliarUWMS 
       WHERE Empresa   = @Empresa
         AND Rama      = @Rama
         AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
         AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
         --AND SubGrupo  = CASE @SubGrupoBase  WHEN NULL THEN SubGrupo  ELSE @SubGrupoBase  END
         AND Cuenta    = @CuentaBase --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
         AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
         AND Ejercicio = @Ejercicio 
         AND Periodo   = @Periodo
         AND Fecha < @FechaInicial
	 ) A

      IF @@ERROR <> 0 SELECT @Ok = 1
    END
  END ELSE
  BEGIN
    SELECT @CargoInicial = ISNULL(Sum(Cargos), 0.0), @CargoInicialU = ISNULL(Sum(CargosU), 0.0),
           @AbonoInicial = ISNULL(Sum(Abonos), 0.0), @AbonoInicialU = ISNULL(Sum(AbonosU), 0.0) 
      FROM AcumRU
     WHERE Empresa   = @Empresa
       AND Rama      = @Rama
       AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
       AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
       AND Cuenta    = @CuentaBase --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
       AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
       AND Ejercicio = @Ejercicio 
       AND Periodo < @Periodo
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF DATEPART(dd, @FechaInicial) > 1 
    BEGIN
      SELECT @CargoInicial = ISNULL(@CargoInicial, 0.0) + ISNULL(Sum(Cargo), 0.0), @CargoInicialU = ISNULL(@CargoInicialU, 0.0) + ISNULL(Sum(CargoU), 0.0),
             @AbonoInicial = ISNULL(@AbonoInicial, 0.0) + ISNULL(Sum(Abono), 0.0), @AbonoInicialU = ISNULL(@AbonoInicialU, 0.0) + ISNULL(Sum(AbonoU), 0.0)
        FROM AuxiliarRU
       WHERE Empresa   = @Empresa
         AND Rama      = @Rama
         AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
         AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
         AND Cuenta    = @CuentaBase --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
         AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
         AND Ejercicio = @Ejercicio 
         AND Periodo   = @Periodo
         AND Fecha < @FechaInicial
      IF @@ERROR <> 0 SELECT @Ok = 1
    END
  END
  SELECT @CargoInicial = ISNULL(@CargoInicial, 0.0), @CargoInicialU = ISNULL(@CargoInicialU, 0.0),
         @AbonoInicial = ISNULL(@AbonoInicial, 0.0), @AbonoInicialU = ISNULL(@AbonoInicialU, 0.0)
  RETURN
END
GO

/************** spSaldoM (Monetarios) ***************/
if exists (select * from sysobjects where id = object_id('dbo.spSaldoM') and type = 'P') drop procedure dbo.spSaldoM
GO
CREATE PROCEDURE spSaldoM
		   @Sucursal		int,
		   @Accion		char(20),
	           @Empresa		char(5),
		   @Rama		char(5),
		   @Moneda		char(10),
		   @TipoCambio		float,
	           @Cuenta		char(20),
	           @SubCuenta		varchar(50),
	           @Grupo		char(10),
	           @Modulo		char(5),
		   @ID			int,
	           @Mov			char(20),
	           @MovID		varchar(20),
	           @Cargo		money,
	           @Abono		money,
	           @Fecha		datetime,
                   @EjercicioAfectacion int,
                   @PeriodoAfectacion   int,
		   @AcumulaSinDetalles	bit,
                   @AcumulaEnLinea	bit,
                   @GeneraAuxiliar	bit,
                   @GeneraSaldo	        bit,
                   @Conciliar		bit,
		   @Aplica		char(20),
		   @AplicaID		varchar(20),

		   @EsResultados	bit,

		   @Ok			int		OUTPUT,
		   @OkRef		varchar(255)	OUTPUT,
		   @Renglon		float	= NULL,
		   @RenglonSub		int	= NULL,
		   @RenglonID		int	= NULL,
		   @SubCuenta2		varchar(50) = '',
		   @SubCuenta3		varchar(50) = '',
		   @Proyecto		varchar(50) = '',
		   @UEN			int = 0
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @FechaSinHora	datetime,
    @SubCuentaAcum	varchar(50),
    @SubCuenta2Acum	varchar(50),
    @SubCuenta3Acum	varchar(50),
    @ImporteConciliar	money,
    @Temp   	   	money,
    @CargoAux		money,
    @AbonoAux		money,
    @EsCancelacion 	bit

  SELECT @Cargo = ISNULL(@Cargo, 0.0), 
         @Abono = ISNULL(@Abono, 0.0)

  IF @Accion IN ('CANCELAR', 'DESAFECTAR')
  BEGIN
    SELECT @EsCancelacion = 1, @Temp = @Cargo
    SELECT @Cargo = -@Abono, @Abono = -@Temp
  END ELSE SELECT @EsCancelacion = 0

  -- Actualizar Saldos
  IF @GeneraSaldo = 1 AND @Ok IS NULL
  BEGIN
    IF @AcumulaSinDetalles = 1 SELECT @SubCuentaAcum = '', @SubCuenta2Acum = '', @SubCuenta3Acum = '' ELSE SELECT @SubCuentaAcum = @SubCuenta, @SubCuenta2Acum = @SubCuenta2, @SubCuenta3Acum = @SubCuenta3
    IF @Conciliar = 1 
      SELECT @ImporteConciliar = @Cargo - @Abono 
    ELSE SELECT @ImporteConciliar = 0.0

    IF @EsResultados = 0 
    BEGIN
      UPDATE Saldo WITH (ROWLOCK) 
         SET Saldo        = ISNULL(Saldo, 0.0) + @Cargo - @Abono,
             PorConciliar = ISNULL(PorConciliar, 0.0) + @ImporteConciliar
       WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND Cuenta = @Cuenta AND SubCuenta = @SubCuentaAcum
         AND SubCuenta2 = @SubCuenta2Acum AND SubCuenta3 = @SubCuenta3Acum AND Proyecto = @Proyecto AND UEN = @UEN

      IF @@ROWCOUNT = 0
        INSERT Saldo (Sucursal,  Empresa,  Rama,  Moneda,  Grupo,  Cuenta,  SubCuenta,      SubCuenta2,      SubCuenta3,      Proyecto,  UEN,  Saldo,            PorConciliar,      UltimoCambio)
              VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Grupo, @Cuenta, @SubCuentaAcum, @SubCuenta2Acum, @SubCuenta3Acum, @Proyecto, @UEN, (@Cargo-@Abono), @ImporteConciliar, @Fecha)
      IF @@ERROR <> 0 SELECT @Ok = 1
    END 
    ELSE BEGIN
      UPDATE SaldoR WITH (ROWLOCK) 
         SET Saldo        = ISNULL(Saldo, 0.0) + @Cargo - @Abono,
             PorConciliar = ISNULL(PorConciliar, 0.0) + @ImporteConciliar
       WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND Cuenta = @Cuenta AND SubCuenta = @SubCuentaAcum

      IF @@ROWCOUNT = 0
        INSERT SaldoR (Sucursal,  Empresa, Rama, Moneda, Grupo, Cuenta, SubCuenta, Saldo, PorConciliar, UltimoCambio)
               VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Grupo, @Cuenta, @SubCuentaAcum, (@Cargo-@Abono), @ImporteConciliar, @Fecha)
      IF @@ERROR <> 0 SELECT @Ok = 1
    END
  END

  -- Generar Auxiliares 
  IF @GeneraAuxiliar = 1 AND @Ok IS NULL 
  BEGIN
    IF @Accion = 'DESAFECTAR'
    BEGIN
      IF (SELECT Sucursal FROM Version) <> 0
        SELECT @Ok = 60290

      IF @EsResultados = 0 
        DELETE Auxiliar WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND Cuenta = @Cuenta 
                              AND SubCuenta = @SubCuenta AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @EjercicioAfectacion AND Periodo = @PeriodoAfectacion
      ELSE
        DELETE AuxiliarR WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND Cuenta = @Cuenta 
                               AND SubCuenta = @SubCuenta AND Mov = @Mov AND MovID = @MovID AND Ejercicio = @EjercicioAfectacion AND Periodo = @PeriodoAfectacion

      IF @@ROWCOUNT = 0 SELECT @Ok = 60100, @OkRef = 'Movimiento: '+RTRIM(@Mov) + ' ' +LTRIM(Convert(Char, @MovID))
    END ELSE
    BEGIN
      SELECT @FechaSinHora = @Fecha,
             @CargoAux = NULLIF(@Cargo, 0.0),
             @AbonoAux = NULLIF(@Abono, 0.0)
      EXEC spExtraerFecha @FechaSinHora OUTPUT

      IF @EsResultados = 0 
        INSERT Auxiliar (Sucursal, Empresa, Rama, Moneda, TipoCambio, Cuenta, SubCuenta, Ejercicio, Periodo, Fecha, 
                         Grupo, Modulo, ModuloID, Mov, MovID, Cargo, Abono, Aplica, AplicaID, Acumulado, Conciliado, EsCancelacion,
                         Renglon, RenglonSub)
                 VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @TipoCambio, @Cuenta, @SubCuenta, @EjercicioAfectacion, @PeriodoAfectacion, @FechaSinHora,
                         @Grupo, @Modulo, @ID, @Mov, @MovID, @CargoAux, @AbonoAux, @Aplica, @AplicaID, @AcumulaEnLinea, 0, @EsCancelacion,
                         @Renglon, @RenglonSub)
      ELSE
        INSERT AuxiliarR (Sucursal, Empresa, Rama, Moneda, TipoCambio, Cuenta, SubCuenta, Ejercicio, Periodo, Fecha, 
                          Grupo, Modulo, ModuloID, Mov, MovID, Cargo, Abono, Aplica, AplicaID, Acumulado, Conciliado, EsCancelacion,
                          Renglon, RenglonSub)
                  VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @TipoCambio, @Cuenta, @SubCuenta, @EjercicioAfectacion, @PeriodoAfectacion, @FechaSinHora,
                          @Grupo, @Modulo, @ID, @Mov, @MovID, @CargoAux, @AbonoAux, @Aplica, @AplicaID, @AcumulaEnLinea, 0, @EsCancelacion,
                          @Renglon, @RenglonSub)
      IF @@ERROR <> 0 SELECT @Ok = 1
    END
  END


  -- Actualizar Acumulados
  IF @AcumulaEnLinea = 1 AND @Ok IS NULL
  BEGIN
    IF @AcumulaSinDetalles = 1 SELECT @SubCuentaAcum = '' ELSE SELECT @SubCuentaAcum = @SubCuenta

    IF @EsResultados = 0 
    BEGIN
      UPDATE Acum WITH (ROWLOCK) 
         SET Cargos = ISNULL(Cargos, 0.0) + @Cargo,
             Abonos = ISNULL(Abonos, 0.0) + @Abono,
             UltimoCambio = @Fecha
       WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND Cuenta = @Cuenta 
         AND SubCuenta = @SubCuentaAcum AND Periodo = @PeriodoAfectacion AND Ejercicio = @EjercicioAfectacion
         AND SubCuenta2 = @SubCuenta2Acum AND SubCuenta3 = @SubCuenta3Acum AND Proyecto = @Proyecto AND UEN = @UEN

      IF @@ROWCOUNT = 0
        INSERT Acum (Sucursal,  Empresa,  Rama,  Moneda,  Cuenta,  SubCuenta,      SubCuenta2,      SubCuenta3,      Proyecto,  UEN,  Grupo,  Ejercicio,            Periodo,            Cargos,  Abonos, UltimoCambio)
             VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Cuenta, @SubCuentaAcum, @SubCuenta2Acum, @SubCuenta3Acum, @Proyecto, @UEN, @Grupo, @EjercicioAfectacion, @PeriodoAfectacion, @Cargo,  @Abono, @Fecha)
      IF @@ERROR <> 0 SELECT @Ok = 1
    END ELSE
    BEGIN 
      UPDATE AcumR WITH (ROWLOCK) 
         SET Cargos = ISNULL(Cargos, 0.0) + @Cargo,
             Abonos = ISNULL(Abonos, 0.0) + @Abono,
             UltimoCambio = @Fecha
       WHERE Sucursal = @Sucursal AND Empresa = @Empresa AND Rama = @Rama AND Moneda = @Moneda AND Grupo = @Grupo AND Cuenta = @Cuenta 
         AND SubCuenta = @SubCuentaAcum AND Periodo = @PeriodoAfectacion AND Ejercicio = @EjercicioAfectacion

      IF @@ROWCOUNT = 0
        INSERT AcumR (Sucursal,  Empresa,  Rama,  Moneda,  Cuenta,  SubCuenta,      Grupo,  Ejercicio,            Periodo,            Cargos,  Abonos, UltimoCambio)
              VALUES (@Sucursal, @Empresa, @Rama, @Moneda, @Cuenta, @SubCuentaAcum, @Grupo, @EjercicioAfectacion, @PeriodoAfectacion, @Cargo,  @Abono, @Fecha)
      IF @@ERROR <> 0 SELECT @Ok = 1
    END
  END

  -- xp's
  IF @Ok IS NULL
    EXEC xpSaldoM @Sucursal, @Accion, @Empresa, @Rama, @Moneda, @TipoCambio, @Cuenta, @SubCuenta, @Grupo,
		  @Modulo, @ID, @Mov, @MovID, @Cargo, @Abono, @Fecha, @EjercicioAfectacion, @PeriodoAfectacion,
		  @AcumulaSinDetalles, @AcumulaEnLinea, @GeneraAuxiliar, @GeneraSaldo, @Conciliar, @Aplica, @AplicaID, @EsResultados,
		  @Ok OUTPUT, @OkRef OUTPUT, @Renglon = @Renglon, @RenglonSub = @RenglonSub, @RenglonID = @RenglonID
  RETURN
END
GO

-- spSaldoInicialM 'DEMO', 'CXC', 'Pesos', NULL, 'MEX', NULL, 0, '12/12/1', NULL, NULL, NULL

/**************** spSaldoInicialM ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSaldoInicialM') and type = 'P') drop procedure dbo.spSaldoInicialM
GO             
CREATE PROCEDURE spSaldoInicialM
			@Empresa	char(5),
			@Rama		char(5), 
                        @MonedaBase	char(10),
			@GrupoBase	char(10), 
			@CuentaBase	char(20),
			@SubCuentaBase	varchar(50),
			@EsResultados	bit,
			@FechaInicial	datetime, 
			@CargoInicial 	money	OUTPUT,
			@AbonoInicial 	money	OUTPUT,
			@Ok		int	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
    @Ejercicio	int,
    @Periodo	int

  SELECT @CargoInicial = 0.0, @AbonoInicial = 0.0
  EXEC spPeriodoEjercicio @Empresa, @Rama, @FechaInicial, @Periodo OUTPUT, @Ejercicio OUTPUT, @Ok OUTPUT
  IF @EsResultados = 0
  BEGIN
    SELECT @CargoInicial = ISNULL(Sum(Cargos), 0.0), @AbonoInicial = ISNULL(Sum(Abonos), 0.0) 
      FROM Acum 
     WHERE Empresa   = @Empresa
       AND Rama      = @Rama
       AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
       AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
       AND Cuenta    = @CuentaBase --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
       AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
       AND ((Ejercicio = @Ejercicio AND Periodo < @Periodo) OR Ejercicio < @Ejercicio)
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF DATEPART(dd, @FechaInicial) > 1 
    BEGIN
      SELECT @CargoInicial = ISNULL(@CargoInicial, 0.0) + ISNULL(Sum(Cargo), 0.0),
             @AbonoInicial = ISNULL(@AbonoInicial, 0.0) + ISNULL(Sum(Abono), 0.0) 
        FROM Auxiliar 
       WHERE Empresa   = @Empresa
         AND Rama      = @Rama
         AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
         AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
         AND Cuenta    = @CuentaBase --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
         AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
         AND Ejercicio = @Ejercicio 
         AND Periodo   = @Periodo
         AND Fecha < @FechaInicial
      IF @@ERROR <> 0 SELECT @Ok = 1
    END
  END ELSE
  BEGIN
    SELECT @CargoInicial = ISNULL(Sum(Cargos), 0.0), @AbonoInicial = ISNULL(Sum(Abonos), 0.0) 
      FROM AcumR
     WHERE Empresa   = @Empresa
       AND Rama      = @Rama
       AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
       AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
       AND Cuenta    = @CuentaBase --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
       AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
       AND Ejercicio = @Ejercicio 
       AND Periodo < @Periodo
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF DATEPART(dd, @FechaInicial) > 1 
    BEGIN
      SELECT @CargoInicial = ISNULL(@CargoInicial, 0.0) + ISNULL(Sum(Cargo), 0.0),
             @AbonoInicial = ISNULL(@AbonoInicial, 0.0) + ISNULL(Sum(Abono), 0.0) 
        FROM AuxiliarR
       WHERE Empresa   = @Empresa
         AND Rama      = @Rama
         AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
         AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
         AND Cuenta    = @CuentaBase  --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
         AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
         AND Ejercicio = @Ejercicio 
         AND Periodo   = @Periodo
         AND Fecha < @FechaInicial
      IF @@ERROR <> 0 SELECT @Ok = 1
    END
  END
  SELECT @CargoInicial = ISNULL(@CargoInicial, 0.0), @AbonoInicial = ISNULL(@AbonoInicial, 0.0)
  RETURN
END
GO
/**************** spSaldoInicial ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSaldoInicial') and type = 'P') drop procedure dbo.spSaldoInicial
GO             
CREATE PROCEDURE spSaldoInicial
			@Empresa	char(5),
			@Rama		char(5), 
                        @MonedaBase	char(10),
			@GrupoBase	char(10), 
			@CuentaBase	char(20),
			@SubCuentaBase	varchar(50),
			@FechaInicial	datetime, 
    			@EsMonetario	bit,
    			@EsUnidades	bit,
			@EsResultados	bit,
			@CargoInicial 	money	OUTPUT,
			@AbonoInicial 	money	OUTPUT,
			@CargoInicialU 	float	OUTPUT,
			@AbonoInicialU 	float	OUTPUT,
			@Ok		int	OUTPUT,
			@SubGrupoBase	varchar(20)	= NULL
--//WITH ENCRYPTION
-- Checar si la Rama es mensual, semanal, etc..
-- Actualmente funciona unicamente en Ramas Mensuales !!!
AS BEGIN
  -- SET nocount ON
  DECLARE
    @Ejercicio		  	int,
    @Periodo		  	int,
    @RamaAdicional  	  	char(5),
    @CargoInicialAdicional 	money,
    @AbonoInicialAdicional 	money

  EXEC spExtraerFecha @FechaInicial OUTPUT
  SELECT @CargoInicial  = 0.0, @AbonoInicial  = 0.0,
         @CargoInicialU = 0.0, @AbonoInicialU = 0.0

  IF @Rama='CONT'
  BEGIN
    EXEC spPeriodoEjercicio @Empresa, @Rama, @FechaInicial, @Periodo OUTPUT, @Ejercicio OUTPUT, @Ok OUTPUT
    EXEC spSaldoInicialCont @Empresa, @CuentaBase, @Ejercicio, @Periodo, @FechaInicial, @CargoInicial OUTPUT, @AbonoInicial OUTPUT, @Ok OUTPUT, @Moneda = @MonedaBase
  END ELSE
    IF @EsMonetario = 1 AND @EsUnidades = 0
    BEGIN
      EXEC spSaldoInicialM @Empresa, @Rama, @MonedaBase, @GrupoBase, @CuentaBase, @SubCuentaBase, @EsResultados, @FechaInicial,
                           @CargoInicial OUTPUT, @AbonoInicial OUTPUT, @Ok OUTPUT
      IF @Rama IN ('CXC', 'CXP') AND @Ok IS NULL
      BEGIN
        SELECT @CargoInicialAdicional = 0.0, @AbonoInicialAdicional = 0.0
        IF @Rama = 'CXC' SELECT @RamaAdicional = 'CEFE' ELSE SELECT @RamaAdicional = 'PEFE'
        EXEC spSaldoInicialM @Empresa, @RamaAdicional, @MonedaBase, @GrupoBase, @CuentaBase, @SubCuentaBase, @EsResultados, @FechaInicial,
                             @CargoInicialAdicional OUTPUT, @AbonoInicialAdicional OUTPUT, @Ok OUTPUT
        SELECT @CargoInicial = @CargoInicial + @CargoInicialAdicional, 
               @AbonoInicial = @AbonoInicial + @AbonoInicialAdicional
        IF @Rama = 'CXC' SELECT @RamaAdicional = 'CRND' ELSE SELECT @RamaAdicional = 'PRND'
        EXEC spSaldoInicialM @Empresa, @RamaAdicional, @MonedaBase, @GrupoBase, @CuentaBase, @SubCuentaBase, @EsResultados, @FechaInicial,
                             @CargoInicialAdicional OUTPUT, @AbonoInicialAdicional OUTPUT, @Ok OUTPUT
        SELECT @CargoInicial = @CargoInicial + @CargoInicialAdicional, 
               @AbonoInicial = @AbonoInicial + @AbonoInicialAdicional
        IF @Rama = 'CXC'
        BEGIN
          SELECT @CargoInicialAdicional = 0.0, @AbonoInicialAdicional = 0.0
          EXEC spSaldoInicialM @Empresa, 'CVALE', @MonedaBase, @GrupoBase, @CuentaBase, @SubCuentaBase, @EsResultados, @FechaInicial,
                               @CargoInicialAdicional OUTPUT, @AbonoInicialAdicional OUTPUT, @Ok OUTPUT
          SELECT @CargoInicial = @CargoInicial + @CargoInicialAdicional, 
                 @AbonoInicial = @AbonoInicial + @AbonoInicialAdicional
          EXEC spSaldoInicialM @Empresa, 'CNO', @MonedaBase, @GrupoBase, @CuentaBase, @SubCuentaBase, @EsResultados, @FechaInicial,
                               @CargoInicialAdicional OUTPUT, @AbonoInicialAdicional OUTPUT, @Ok OUTPUT
          SELECT @CargoInicial = @CargoInicial + @CargoInicialAdicional, 
                 @AbonoInicial = @AbonoInicial + @AbonoInicialAdicional
        END
      END
    END ELSE 
      EXEC spSaldoInicialU @Empresa, @Rama, @MonedaBase, @GrupoBase, @CuentaBase, @SubCuentaBase, @EsResultados, @FechaInicial,
                           @CargoInicial OUTPUT, @AbonoInicial OUTPUT, @CargoInicialU OUTPUT, @AbonoInicialU OUTPUT, @Ok OUTPUT, @SubGrupoBase = @SubGrupoBase
  RETURN
END
GO

/**************** spSaldoFinalCont ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSaldoFinalCont') and type = 'P') drop procedure dbo.spSaldoFinalCont
GO             
CREATE PROCEDURE spSaldoFinalCont
                                   @Empresa		char(5),
                                   @CuentaBase		char(20),
                                   @Ejercicio		int,
                                   @Periodo		int,
                                   @CargoInicial	money	OUTPUT,
                                   @AbonoInicial	money	OUTPUT,
                                   @Ok			int	OUTPUT,
                                   @Moneda		char(10) = NULL,
                                   @Controladora	char(5)  = NULL

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  IF UPPER(@Empresa) 	   IN ('0', 'NULL', '(TODOS)','') SELECT @Empresa = NULL
  IF UPPER(@Controladora)  IN ('0', 'NULL', '(TODOS)','') SELECT @Controladora = NULL
  EXEC spContEmpresaGrupo @Empresa OUTPUT, @Controladora OUTPUT

  SELECT @CargoInicial = 0.0, @AbonoInicial = 0.0
  SELECT @CargoInicial = ISNULL(Sum(Cargos), 0.0), @AbonoInicial = ISNULL(Sum(Abonos), 0.0) 
    FROM Acum a
    JOIN Empresa e ON e.Empresa = a.Empresa AND e.Empresa = ISNULL(@Empresa, e.Empresa) AND e.Controladora = ISNULL(@Controladora, e.Controladora)
   WHERE Moneda  = ISNULL(@Moneda, Moneda)
     AND Rama    = 'CONT'
     AND Cuenta  = @CuentaBase 
     AND Ejercicio = @Ejercicio 
     AND Periodo <= @Periodo 
  IF @@ERROR <> 0 SELECT @Ok = 1
  RETURN
END
GO

/************** spSaldo ***************/
if exists (select * from sysobjects where id = object_id('dbo.spSaldo') and type = 'P') drop procedure dbo.spSaldo
GO
CREATE PROCEDURE spSaldo
                   @Sucursal		int,
		   @Accion		char(20),
	           @Empresa		char(5),
		   @Usuario		char(10),
	           @Rama		char(5),
		   @Moneda		char(10),
		   @TipoCambio		float,
	           @Cuenta		char(20),
	           @SubCuenta		varchar(50),
	           @Grupo		char(10),
	           @GrupoDestino	char(10),
	           @Modulo		char(5),
                   @ID			int,
	           @Mov			char(20),
	           @MovID		varchar(20),
                   @EsCargo             bit,
	           @Importe		money,
	           @ImporteU		float,
		   @Factor		float,
	           @Fecha		datetime,
	           @EjercicioRegistro	int,
	           @PeriodoRegistro	int,
		   @Aplica		char(20),
		   @AplicaID		varchar(20),
		   @SinAuxiliares	bit,
		   @AcumulaSinDetalles	bit,
                   @EsTipoSerie		bit,

 		   @Ok                	int          OUTPUT,
    		   @OkRef             	varchar(255) OUTPUT,
		   @Renglon		float		= NULL,
		   @RenglonSub		int		= NULL,
		   @RenglonID		int		= NULL,
	           @SubGrupo		varchar(50)	= NULL,
	           @SubCuenta2		varchar(50)	= NULL,
	           @SubCuenta3		varchar(50)	= NULL,
	           @Proyecto		varchar(50)	= NULL,
	           @UEN			int		= NULL
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @Cargo               money,
    @Abono               money,
    @CargoU              float,
    @AbonoU              float,
    @AcumulaEnLinea	 bit,
    @GeneraAuxiliar	 bit,
    @GeneraSaldo	 bit,
    @AcumulaxEjercicio	 bit,
    @AcumulaxPeriodo	 bit,
    @Conciliar		 bit,
    @EjercicioAfectacion int,
    @PeriodoAfectacion	 int,
    @EsTransferencia	 bit,
    @EsMonetario	 bit,
    @EsUnidades		 bit,
    @EsResultados	 bit,
    @InvNegativoU	 float,
    @ConsignacionU	 float,
    @f1	 		 float,
    @f2	 		 float,

	--TASK25106
	--BUG24764
    @WMS		bit,
    @MovTipo	varchar(20)

  --TASK25106
  --BUG24764
  SELECT @WMS = ISNULL(WMS, 0) FROM Alm WHERE Almacen = @Grupo  
  SELECT @MovTipo = Clave FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov
  
  IF ISNULL(@Importe, 0.0) = 0.0 AND ISNULL(@ImporteU, 0.0) = 0.0 RETURN

  SELECT @ImporteU = @ImporteU * ISNULL(@Factor, 1.0)
  SELECT @InvNegativoU  = 0.0, 
         @ConsignacionU = 0.0,
         @Cargo         = 0.0, @CargoU = 0.0,
         @Abono         = 0.0, @AbonoU = 0.0,
         @Moneda        = ISNULL(RTRIM(@Moneda), ''),
         @Grupo         = ISNULL(RTRIM(@Grupo), ''),
         @SubGrupo      = ISNULL(RTRIM(@SubGrupo), ''),
         @SubCuenta     = ISNULL(RTRIM(@SubCuenta), ''),
         @SubCuenta2    = ISNULL(RTRIM(@SubCuenta2), ''),
         @SubCuenta3    = ISNULL(RTRIM(@SubCuenta3), ''),
         @Proyecto      = ISNULL(RTRIM(@Proyecto), ''),
         @UEN		= ISNULL(@UEN, 0)
  
  --  Determinar si se Acumula automaticamente, se Genera Saldo, se Genera Auxiliar y si Acumula por Ejercicio y Periodo    
  SELECT @AcumulaEnLinea    = AcumulaEnLinea,  
         @GeneraAuxiliar    = GeneraAuxiliar,
         @GeneraSaldo       = GeneraSaldo,
         @AcumulaxEjercicio = AcumuladoxEjercicio,
         @AcumulaxPeriodo   = AcumuladoxPeriodo,
         @Conciliar  	    = Conciliar,
         @EsMonetario	    = EsMonetario,
         @EsUnidades        = EsUnidades,
	 @EsResultados	    = EsResultados
   FROM  Rama
   WHERE Rama = @Rama
  IF @@ERROR <> 0 SELECT @Ok = 1

  IF @SinAuxiliares     = 1 SELECT @GeneraAuxiliar = 0
  IF @AcumulaxEjercicio = 1 SELECT @EjercicioAfectacion = @EjercicioRegistro ELSE SELECT @EjercicioAfectacion = NULL
  IF @AcumulaxPeriodo   = 1 SELECT @PeriodoAfectacion   = @PeriodoRegistro   ELSE SELECT @PeriodoAfectacion = NULL
  
  IF @EsMonetario = 1 AND @EsUnidades = 0 
  BEGIN
    IF @EsCargo = 1 SELECT @Cargo = @Importe ELSE SELECT @Abono = @Importe
    EXEC spSaldoM @Sucursal, @Accion, @Empresa, @Rama, @Moneda, @TipoCambio, @Cuenta, @SubCuenta, @Grupo, @Modulo, @ID, @Mov, @MovID, @Cargo, @Abono,
                  @Fecha, @EjercicioAfectacion, @PeriodoAfectacion,
                  @AcumulaSinDetalles, @AcumulaEnLinea, @GeneraAuxiliar, @GeneraSaldo, @Conciliar, @Aplica, @AplicaID, 
                  @EsResultados, @Ok OUTPUT, @OkRef OUTPUT, @Renglon = @Renglon, @RenglonSub = @RenglonSub, @RenglonID = @RenglonID,
                  @SubCuenta2 = @SubCuenta2, @SubCuenta3 = @SubCuenta3, @Proyecto = @Proyecto, @UEN = @UEN
  END ELSE 
  BEGIN
    IF @GrupoDestino IS NOT NULL SELECT @EsTransferencia = 1 ELSE SELECT @EsTransferencia = 0
    IF @EsTransferencia = 1 SELECT @AbonoU = @ImporteU ELSE 
    IF @EsCargo = 1 SELECT @Cargo = @Importe, @CargoU = @ImporteU ELSE SELECT @Abono = @Importe, @AbonoU = @ImporteU
    EXEC spSaldoU @Sucursal, @Accion, @Empresa, @Usuario, @Rama, @Moneda, @Cuenta, @SubCuenta, @Grupo, @Modulo, @ID, @Mov, @MovID, 
                  @Cargo, @Abono, @CargoU, @AbonoU, 
                  @Fecha, @EjercicioAfectacion, @PeriodoAfectacion,
                  @AcumulaSinDetalles, @AcumulaEnLinea, @GeneraAuxiliar, @GeneraSaldo, @Conciliar, @Aplica, @AplicaID, 
                  @EsTransferencia, @EsResultados, @EsTipoSerie,
                  @InvNegativoU OUTPUT, @ConsignacionU OUTPUT, @Ok OUTPUT, @OkRef OUTPUT, @Renglon = @Renglon, @RenglonSub = @RenglonSub, @RenglonID = @RenglonID, @SubGrupo = @SubGrupo
    SELECT @ImporteU = @ImporteU - @ConsignacionU

    IF @EsTransferencia = 1 AND @Ok IS NULL
    BEGIN
	  IF @Rama <> 'WMS'
      EXEC spSaldoU @Sucursal, @Accion, @Empresa, @Usuario, @Rama, @Moneda, @Cuenta, @SubCuenta, @GrupoDestino, @Modulo, @ID, @Mov, @MovID, 
                    0.0, 0.0, @ImporteU, 0.0,
                    @Fecha, @EjercicioAfectacion, @PeriodoAfectacion,
                    @AcumulaSinDetalles, @AcumulaEnLinea, @GeneraAuxiliar, @GeneraSaldo, @Conciliar, @Aplica, @AplicaID, 
                    @EsTransferencia, @EsResultados, @EsTipoSerie,
                    @f1, @f2, @Ok OUTPUT, @OkRef OUTPUT, @Renglon = @Renglon, @RenglonSub = @RenglonSub, @RenglonID = @RenglonID, @SubGrupo = @SubGrupo
      IF @ConsignacionU <> 0.0 AND @Ok IS NULL
      BEGIN
        EXEC spTransferirConsignacion @Empresa, @Cuenta, @SubCuenta, @Grupo, @GrupoDestino, @ConsignacionU, @Ok OUTPUT
        IF @Ok IS NULL
        BEGIN
          EXEC spSaldoU @Sucursal, @Accion, @Empresa, @Usuario, 'CSG', @Moneda, @Cuenta, @SubCuenta, @Grupo, @Modulo, @ID, @Mov, @MovID, 
                        0.0, 0.0, 0.0, @ConsignacionU, 
                        @Fecha, @EjercicioAfectacion, @PeriodoAfectacion,
                        @AcumulaSinDetalles, @AcumulaEnLinea, @GeneraAuxiliar, @GeneraSaldo, @Conciliar, @Aplica, @AplicaID, 
         	        @EsTransferencia, 0, 0,
                        @f1, @f2, @Ok OUTPUT, @OkRef OUTPUT, @Renglon = @Renglon, @RenglonSub = @RenglonSub, @RenglonID = @RenglonID, @SubGrupo = @SubGrupo

          EXEC spSaldoU @Sucursal, @Accion, @Empresa, @Usuario, 'CSG', @Moneda, @Cuenta, @SubCuenta, @GrupoDestino, @Modulo, @ID, @Mov, @MovID, 
                        0.0, 0.0, @ConsignacionU, 0.0,
                        @Fecha, @EjercicioAfectacion, @PeriodoAfectacion,
                        @AcumulaSinDetalles, @AcumulaEnLinea, @GeneraAuxiliar, @GeneraSaldo, @Conciliar, @Aplica, @AplicaID, 
         	        @EsTransferencia, 0, 0,
                        @f1, @f2, @Ok OUTPUT, @OkRef OUTPUT, @Renglon = @Renglon, @RenglonSub = @RenglonSub, @RenglonID = @RenglonID, @SubGrupo = @SubGrupo
        END
      END
    END 
    IF @Rama = 'INV' AND ROUND(@InvNegativoU - @ConsignacionU, 4) > 0.0 SELECT @Ok = 20025
	IF @Rama = 'WMS' AND ROUND(@InvNegativoU - @ConsignacionU, 4) > 0.0 SELECT @Ok = 20025
  END

  --TASK25106
  --BUG24764
    IF @Rama = 'INV' AND @Accion = 'AFECTAR' AND @Modulo = 'INV' AND @WMS = 1 AND @MovTipo = 'INV.TMA' AND @Ok = 20025
      SELECT @Ok = NULL

  IF @Ok IS NOT NULL AND @OkRef IS NULL
  BEGIN
    SELECT @OkRef = @Cuenta
    IF @SubCuenta IS NOT NULL AND @SubCuenta <> '' SELECT @OkRef = @OkRef+ ' ('+@SubCuenta+')'
  END
  RETURN 
END
GO

/**************** spSaldoInicialCont ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSaldoInicialCont') and type = 'P') drop procedure dbo.spSaldoInicialCont
GO             
CREATE PROCEDURE spSaldoInicialCont
                                   @Empresa		char(5),
                                   @CuentaBase		char(20),
                                   @Ejercicio		int,
                                   @Periodo		int,
                                   @FechaInicial	datetime, 
                                   @CargoInicial	money	OUTPUT,
                                   @AbonoInicial	money	OUTPUT,
                                   @Ok			int	OUTPUT,
                                   @Moneda		char(10) = NULL,
                                   @Controladora	char(5)  = NULL

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  SELECT @CargoInicial = 0.0, @AbonoInicial = 0.0
  IF UPPER(@Empresa) 	   IN ('0', 'NULL', '(TODOS)','') SELECT @Empresa = NULL
  IF UPPER(@Controladora)  IN ('0', 'NULL', '(TODOS)','') SELECT @Controladora = NULL
  EXEC spContEmpresaGrupo @Empresa OUTPUT, @Controladora OUTPUT
 
  SELECT @CargoInicial = ISNULL(Sum(a.Cargos), 0.0), @AbonoInicial = ISNULL(Sum(a.Abonos), 0.0) 
    FROM Acum a
    JOIN Empresa e ON e.Empresa = a.Empresa AND e.Empresa = ISNULL(@Empresa, e.Empresa) AND ISNULL(e.Controladora,'') = ISNULL(ISNULL(@Controladora, e.Controladora),'')
   WHERE Moneda  = ISNULL(@Moneda, Moneda)
     AND Rama    = 'CONT'
     AND Cuenta  = @CuentaBase 
     AND Ejercicio = @Ejercicio 
     AND Periodo < @Periodo 
  IF @@ERROR <> 0 SELECT @Ok = 1
 
  IF @FechaInicial IS NOT NULL AND DATEPART(dd, @FechaInicial) > 1 
  BEGIN
    SELECT @CargoInicial = ISNULL(@CargoInicial, 0.0) + ISNULL(Sum(Debe), 0.0),
           @AbonoInicial = ISNULL(@AbonoInicial, 0.0) + ISNULL(Sum(Haber), 0.0) 
      FROM ContD
      JOIN Cont ON ContD.ID = Cont.ID
      JOIN Empresa e ON e.Empresa = ContD.Empresa AND e.Empresa = ISNULL(@Empresa, e.Empresa) AND ISNULL(e.Controladora,'') = ISNULL(ISNULL(@Controladora, e.Controladora),'')
     WHERE Cont.Estatus = 'CONCLUIDO'
       AND ContD.Cuenta  = @CuentaBase 
       AND ContD.Ejercicio = @Ejercicio 
       AND ContD.Periodo   = @Periodo
       AND ContD.FechaContable < @FechaInicial
       AND Cont.Moneda = ISNULL(@Moneda, Cont.Moneda)
    IF @@ERROR <> 0 SELECT @Ok = 1
  END
 
  SELECT @CargoInicial = ISNULL(@CargoInicial, 0.0), @AbonoInicial = ISNULL(@AbonoInicial, 0.0)
  RETURN
END
GO

-- spVerSaldoInicialU 'DEMO', 'INV', 'Pesos', 'BIC', 'STOCK', '12/12/1', 'C3'
/**************** spVerSaldoInicialU ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVerSaldoInicialU') and type = 'P') drop procedure dbo.spVerSaldoInicialU
GO             
CREATE PROCEDURE spVerSaldoInicialU
			@Empresa	char(5),
			@Rama		char(5),
			@Moneda		char(10),
			@Cuenta		char(20),
                        @Grupo		char(10),
			@FechaInicial	datetime,
			@SubCuenta	varchar(50) = NULL,
			@SubGrupo	varchar(20) = NULL
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
    @Ejercicio	  	int,
    @Periodo	  	int,
    @EsMonetario	bit,
    @EsUnidades		bit,
    @EsResultados	bit,
    @CargoInicial 	money,
    @AbonoInicial 	money,
    @CargoInicialU 	float,
    @AbonoInicialU 	float,
    @Ok		  	int

  SELECT @SubCuenta = NULLIF(RTRIM(@SubCuenta), ''), @Grupo = NULLIF(RTRIM(@Grupo), ''), @SubGrupo = NULLIF(RTRIM(@SubGrupo), '')
  SELECT @SubCuenta = NULLIF(@SubCuenta, '0'),       @Grupo = NULLIF(@Grupo, '0'),       @SubGrupo = NULLIF(@SubGrupo, '0')

  SELECT @EsMonetario  = EsMonetario,
         @EsUnidades   = EsUnidades,
	 @EsResultados = EsResultados
    FROM Rama
   WHERE Rama = @Rama
  EXEC spPeriodoEjercicio @Empresa, @Rama, @FechaInicial, @Periodo OUTPUT, @Ejercicio OUTPUT, @Ok OUTPUT
  EXEC spSaldoInicial @Empresa, @Rama, @Moneda, @Grupo, @Cuenta, @SubCuenta, @FechaInicial, @EsMonetario, @EsUnidades, @EsResultados, 
       		      @CargoInicial OUTPUT, @AbonoInicial OUTPUT, @CargoInicialU OUTPUT, @AbonoInicialU OUTPUT,
     	     	      @Ok OUTPUT, @SubGrupoBase = @SubGrupo
 SELECT "SaldoInicial" = CONVERT(float, ISNULL(@CargoInicialU, 0.0) - ISNULL(@AbonoInicialU, 0.0))
END
GO

-- spVerSaldoInicialM 'DEMO', 'Cont', 'Pesos', '121-01-001', '5/1/3'
/**************** spVerSaldoInicialM ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVerSaldoInicialM') and type = 'P') drop procedure dbo.spVerSaldoInicialM
GO             
CREATE PROCEDURE spVerSaldoInicialM
			@Empresa	char(5),
			@Rama		char(5),
			@Moneda		char(10),
			@Cuenta		char(20),
			@FechaInicial	datetime,
			@SubCuenta	varchar(50) = NULL
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
    @Ejercicio	  	int,
    @Periodo	  	int,
    @EsMonetario	bit,
    @EsUnidades		bit,
    @EsResultados	bit,
    @CargoInicial 	money,
    @AbonoInicial 	money,
    @CargoInicialU 	float,
    @AbonoInicialU 	float,
    @Ok		  	int

  SELECT @SubCuenta = NULLIF(RTRIM(@SubCuenta), '')
  SELECT @SubCuenta = NULLIF(@SubCuenta, '0')

  SELECT @EsMonetario  = EsMonetario,
         @EsUnidades   = EsUnidades,
	 @EsResultados = EsResultados
    FROM Rama
   WHERE Rama = @Rama
  EXEC spPeriodoEjercicio @Empresa, @Rama, @FechaInicial, @Periodo OUTPUT, @Ejercicio OUTPUT, @Ok OUTPUT
  EXEC spSaldoInicial @Empresa, @Rama, @Moneda, NULL, @Cuenta, @SubCuenta, @FechaInicial, @EsMonetario, @EsUnidades, @EsResultados, 
       		      @CargoInicial OUTPUT, @AbonoInicial OUTPUT, @CargoInicialU OUTPUT, @AbonoInicialU OUTPUT,
     	     	      @Ok OUTPUT 
 SELECT "SaldoInicial" = CONVERT(money, ISNULL(@CargoInicial, 0.0) - ISNULL(@AbonoInicial, 0.0))
END
GO

/************** spSerieLoteFlujo *************/
if exists (select * from sysobjects where id = object_id('dbo.spSerieLoteFlujo') and type = 'P') drop procedure dbo.spSerieLoteFlujo
GO
CREATE PROCEDURE spSerieLoteFlujo
		   @Sucursal			int,
		   @SucursalAlmacen		int,
                   @SucursalAlmacenDestino	int,	
		   @Accion			char(20),
                   @Empresa     		char(5),
                   @Modulo			char(5),
		   @ID				int,
                   @Articulo            	char(20),
		   @SubCuenta			varchar(50),
                   @SerieLote           	varchar(50),
		   @Almacen			char(10),
		   @RenglonID			int,
		   @Tarima			varchar(20) = NULL
--//WITH ENCRYPTION
AS BEGIN

  SELECT @Tarima = Tarima
    FROM INVd 
   WHERE Id = @ID
     AND seccion = 1

  SELECT @SubCuenta = ISNULL(@SubCuenta, ''), @Tarima = ISNULL(@Tarima, '')
  IF @Accion = 'CANCELAR'
    DELETE SerieLoteD WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID = @ID AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND SerieLote = @SerieLote 
  ELSE 
  BEGIN
    IF @Almacen IS NOT NULL 
      IF NOT EXISTS(SELECT * FROM SerieLote WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND SerieLote = @SerieLote AND Tarima = @Tarima) AND @Tarima IS NULL
        INSERT SerieLote (Sucursal,         Empresa,  Articulo,  SubCuenta,  SerieLote,  Almacen,  Tarima) 
                  VALUES (@SucursalAlmacen, @Empresa, @Articulo, @SubCuenta, @SerieLote, @Almacen, @Tarima)
    IF NOT EXISTS(SELECT * FROM SerieLoteD WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID = @ID AND Articulo = @Articulo AND SerieLote = @SerieLote)
      INSERT SerieLoteD (Sucursal,         Empresa,  Modulo,  ID,  RenglonID,  Articulo,  SubCuenta,  SerieLote)
                 VALUES (@SucursalAlmacen, @Empresa, @Modulo, @ID, @RenglonID, @Articulo, @SubCuenta, @SerieLote)
  END
  RETURN
END
GO

/**************** spSeriesLotesFusionarTemp ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSeriesLotesFusionarTemp') and type = 'P') drop procedure dbo.spSeriesLotesFusionarTemp
GO              
CREATE PROCEDURE spSeriesLotesFusionarTemp
                   @Ok 				int		OUTPUT, 
                   @OkRef 			varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Empresa		char(5), 
    @Modulo		char(5), 
    @ID			int, 
    @RenglonID		int, 
    @Articulo		varchar(20), 
    @SubCuentaNull	varchar(50), 
    @SerieLote		varchar(50), 
    @Cantidad		float, 
    @CantidadAlterna	float, 
    @Propiedades	varchar(20), 
    @Sucursal		int, 
    @ArtCostoInv	float

  DECLARE crSerieLoteMovTemp CURSOR FOR 
   SELECT Empresa, Modulo, ID, RenglonID, Articulo, NULLIF(RTRIM(SubCuenta), ''), SerieLote, Cantidad, CantidadAlterna, Propiedades, Sucursal, ArtCostoInv
     FROM #SerieLoteMov
  OPEN crSerieLoteMovTemp
  FETCH NEXT FROM crSerieLoteMovTemp INTO @Empresa, @Modulo, @ID, @RenglonID, @Articulo, @SubCuentaNull, @SerieLote, @Cantidad, @CantidadAlterna, @Propiedades, @Sucursal, @ArtCostoInv
  WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
  BEGIN
    IF @@FETCH_STATUS <> -2 AND (@Cantidad <> 0.0 OR @CantidadAlterna <> 0.0)
    BEGIN
      UPDATE SerieLoteMov
         SET Cantidad = ISNULL(Cantidad, 0.0) + @Cantidad,
             CantidadAlterna = ISNULL(CantidadAlterna, 0.0) + @CantidadAlterna
       WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID = @ID AND RenglonID = @RenglonID AND Articulo = @Articulo AND NULLIF(RTRIM(SubCuenta), '') = @SubCuentaNull
      IF @@ROWCOUNT = 0
        INSERT SerieLoteMov (Empresa,  Modulo,  ID,  RenglonID,  Articulo,  SubCuenta,                  SerieLote,  Cantidad,  CantidadAlterna,  Propiedades,  Sucursal,  ArtCostoInv) 
                     VALUES (@Empresa, @Modulo, @ID, @RenglonID, @Articulo, ISNULL(@SubCuentaNull, ''), @SerieLote, @Cantidad, @CantidadAlterna, @Propiedades, @Sucursal, @ArtCostoInv)
    END
    FETCH NEXT FROM crSerieLoteMovTemp INTO @Empresa, @Modulo, @ID, @RenglonID, @Articulo, @SubCuentaNull, @SerieLote, @Cantidad, @CantidadAlterna, @Propiedades, @Sucursal, @ArtCostoInv
  END
  CLOSE crSerieLoteMovTemp
  DEALLOCATE crSerieLoteMovTemp

  RETURN
END
GO

/**************** spSeriesLotesMayoreoLimpiar ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSeriesLotesMayoreoLimpiar') and type = 'P') drop procedure dbo.spSeriesLotesMayoreoLimpiar
GO              
CREATE PROCEDURE spSeriesLotesMayoreoLimpiar
	           @Empresa			char(5),
                   @Modulo                      char(5),
                   @ID  			int, 
	           @RenglonID			int, 
                   @Articulo                    char(20),
		   @SubCuenta			varchar(50)
--//WITH ENCRYPTION
AS BEGIN
  BEGIN TRANSACTION

    DELETE SerieLoteMov 
     WHERE Empresa   = @Empresa
       AND Modulo    = @Modulo
       AND ID        = @ID
       AND RenglonID = @RenglonID
       AND Articulo  = @Articulo
       AND SubCuenta = ISNULL(RTRIM(@SubCuenta), '')

  IF @@ERROR = 0
    COMMIT TRANSACTION
  ELSE
    ROLLBACK TRANSACTION
END
GO

/**************** spSeriesLotesMayoreoDisminuir ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSeriesLotesMayoreoDisminuir') and type = 'P') drop procedure dbo.spSeriesLotesMayoreoDisminuir
GO              
CREATE PROCEDURE spSeriesLotesMayoreoDisminuir
                   @Sucursal			int,
		   @SucursalAlmacen		int,
                   @SucursalAlmacenDestino	int,	
	           @Empresa			char(5),
                   @Accion			char(20),
                   @Almacen			char(10),
		   @AlmacenDestino		char(10),
                   @Articulo                    char(20),
		   @SubCuentaNull		varchar(50),
		   @SubCuenta			varchar(50),
		   @ArtTipo			char(20),
		   @SerieLote			varchar(50),
                   @Propiedades			char(20),
                   @Cliente			varchar(10),
                   @Localizacion		varchar(10),
		   @Cantidad			float,
		   
		   @EsSalida			bit,
		   @EsTransferencia		bit,
		   @AlmacenTipo			char(20),
		   @FechaEmision		datetime,

                   @Ok 				int		OUTPUT,
		   @AlmacenTarima		varchar(20)	= '',
		   @AlmacenDestinoTarima	varchar(20)	= '',
		   @MovTipo					varchar(20)
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @CantidadAlterna	   	float,
    @Existencia  	   	float,
    @ExistenciaActivoFijo  	float,
    @CostoPromedio	   	float,
    @UltimaEntrada		datetime,
    @UltimaSalida		datetime

  EXEC spExtraerFecha @FechaEmision OUTPUT
  SELECT @Existencia = 0
  SELECT @Existencia = ISNULL(Existencia, 0)
    FROM SerieLote
   WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND Tarima = @AlmacenTarima AND SubCuenta = @SubCuenta AND Almacen = @Almacen AND SerieLote = @SerieLote 
  --Verificar SerieLote en transferecia y Transpaso
  IF @MovTipo = 'INV.T'
    SET @AlmacenDestinoTarima = ''

  IF @Existencia <= @Cantidad AND @MovTipo IN ('VTAS.N','VTAS.FM') AND (SELECT NotasBorrador FROM EmpresaCFG WHERE Empresa = @Empresa) = 1
  BEGIN
    SELECT @Ok = NULL
      
          SELECT @CostoPromedio = AVG(CostoPromedio) 
        FROM SerieLote 
       WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND SerieLote = @SerieLote AND Almacen = @Almacen AND Tarima = @AlmacenTarima

        
    UPDATE SerieLote
       SET Existencia        = NULLIF(ROUND(Existencia - @Cantidad, 8), 0.0),
           @CantidadAlterna  = (@Cantidad * ExistenciaAlterna / Existencia),
           ExistenciaAlterna = NULLIF(ExistenciaAlterna - (@Cantidad * ExistenciaAlterna / Existencia), 0.0),
           UltimaSalida      = CASE WHEN @EsSalida = 1 THEN @FechaEmision ELSE UltimaSalida END
     WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Almacen = @Almacen AND Tarima = @AlmacenTarima AND SerieLote = @SerieLote
    IF @@ROWCOUNT = 0
    IF NOT EXISTS (SELECT SerieLote FROM SerieLote WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Almacen = @Almacen AND Tarima = @AlmacenTarima AND SerieLote = @SerieLote)       
        INSERT SerieLote (Sucursal,                Empresa,  Articulo,  SubCuenta,  Almacen,         Tarima,                SerieLote,  Propiedades,  Cliente, Localizacion,  Existencia,  ExistenciaAlterna, CostoPromedio,  UltimaEntrada, UltimaSalida)
                  VALUES (@SucursalAlmacen, @Empresa, @Articulo, @SubCuenta, @Almacen, @AlmacenTarima, @SerieLote, @Propiedades, @Cliente, @Localizacion, -@Cantidad,  -@CantidadAlterna,  @CostoPromedio, @UltimaEntrada, @UltimaSalida)
    
  END ELSE
  BEGIN
    IF @AlmacenTipo = 'ACTIVOS FIJOS'
	BEGIN
      UPDATE SerieLote
         SET ExistenciaActivoFijo = NULLIF(ISNULL(ExistenciaActivoFijo, 0.0) - @Cantidad, 0.0),
             UltimaSalida = CASE WHEN @EsSalida = 1 THEN @FechaEmision ELSE UltimaSalida END
       WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Almacen = @Almacen AND Tarima = @AlmacenTarima AND SerieLote = @SerieLote AND ISNULL(ExistenciaActivoFijo, 0) > 0
	END
    IF @AlmacenTipo <> 'ACTIVOS FIJOS'
	BEGIN
	  IF EXISTS(SELECT * FROM SerieLote WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Almacen = @Almacen AND Tarima = @AlmacenTarima AND SerieLote = @SerieLote AND Existencia > 0)
	  BEGIN
		  UPDATE SerieLote
			 SET Existencia        = NULLIF(ROUND(Existencia - @Cantidad, 8), 0.0),
				 @CantidadAlterna  = (@Cantidad * ExistenciaAlterna / Existencia),
				 ExistenciaAlterna = NULLIF(ExistenciaAlterna - (@Cantidad * ExistenciaAlterna / Existencia), 0.0),
				 UltimaSalida      = CASE WHEN @EsSalida = 1 THEN @FechaEmision ELSE UltimaSalida END
		   WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Almacen = @Almacen AND Tarima = @AlmacenTarima AND SerieLote = @SerieLote AND Existencia > 0
		   IF @@ROWCOUNT = 0 SELECT @Ok = 20090
	  END
    END
  
    SELECT @Existencia = 0, @ExistenciaActivoFijo = 0
    SELECT @ExistenciaActivoFijo = ISNULL(ExistenciaActivoFijo, 0), 
           @Existencia = ISNULL(Existencia, 0),
           @UltimaEntrada = UltimaEntrada,
           @UltimaSalida	= UltimaSalida
      FROM SerieLote
     WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND Tarima = @AlmacenTarima AND SubCuenta = @SubCuenta AND Almacen = @Almacen AND SerieLote = @SerieLote 
    IF @Existencia < 0 OR @ExistenciaActivoFijo < 0 SELECT @Ok = 20510
  
  --JGD
    IF @Existencia < 0 AND (SELECT NotasBorrador FROM EmpresaCFG WHERE Empresa = @Empresa) = 1
      SELECT @Ok = NULL
  
    IF @ArtTipo = 'PARTIDA' AND @Existencia > 0 AND @Cantidad > 0 AND @Accion <> 'CANCELAR' AND @Ok IS NULL SELECT @Ok = 20580
  
    IF @EsTransferencia = 1 AND @Ok IS NULL
    BEGIN
      IF @AlmacenTipo = 'ACTIVOS FIJOS'
        UPDATE SerieLote
           SET ExistenciaActivoFijo = ISNULL(ExistenciaActivoFijo, 0.0) + @Cantidad
         WHERE Sucursal = @SucursalAlmacenDestino AND Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND SerieLote = @SerieLote AND Almacen = @AlmacenDestino AND Tarima = @AlmacenDestinoTarima 
      ELSE
        UPDATE SerieLote
           SET Existencia = ISNULL(Existencia, 0.0) + @Cantidad,
               ExistenciaAlterna = NULLIF(ISNULL(ExistenciaAlterna, 0.0) + @CantidadAlterna, 0.0)
         WHERE Sucursal = @SucursalAlmacenDestino AND Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND SerieLote = @SerieLote AND Almacen = @AlmacenDestino AND Tarima = @AlmacenDestinoTarima 
  
      IF @@ROWCOUNT = 0
      BEGIN
        SELECT @CostoPromedio = AVG(CostoPromedio) 
          FROM SerieLote 
         WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND SerieLote = @SerieLote AND Almacen = @Almacen AND Tarima = @AlmacenTarima 
  
        IF @AlmacenTipo = 'ACTIVOS FIJOS'
          INSERT SerieLote (Sucursal,                Empresa,  Articulo,  SubCuenta,  Almacen,         Tarima,                SerieLote,  Propiedades,  Cliente,  Localizacion,  ExistenciaActivoFijo, CostoPromedio,  UltimaEntrada, UltimaSalida)
                    VALUES (@SucursalAlmacenDestino, @Empresa, @Articulo, @SubCuenta, @AlmacenDestino, @AlmacenDestinoTarima, @SerieLote, @Propiedades, @Cliente, @Localizacion, @Cantidad,            @CostoPromedio, @UltimaEntrada, @UltimaSalida)
        ELSE
          INSERT SerieLote (Sucursal,                Empresa,  Articulo,  SubCuenta,  Almacen,         Tarima,                SerieLote,  Propiedades,  Cliente, Localizacion,  Existencia,  ExistenciaAlterna, CostoPromedio,  UltimaEntrada, UltimaSalida)
                    VALUES (@SucursalAlmacenDestino, @Empresa, @Articulo, @SubCuenta, @AlmacenDestino, @AlmacenDestinoTarima, @SerieLote, @Propiedades, @Cliente, @Localizacion, @Cantidad,  @CantidadAlterna,  @CostoPromedio, @UltimaEntrada, @UltimaSalida)
      END
  
      SELECT @Existencia = 0, @ExistenciaActivoFijo = 0
      SELECT @ExistenciaActivoFijo = ISNULL(ExistenciaActivoFijo, 0), @Existencia = ISNULL(Existencia, 0)
        FROM SerieLote
       WHERE Sucursal = @SucursalAlmacenDestino AND Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Almacen = @AlmacenDestino AND Tarima = @AlmacenDestinoTarima AND SerieLote = @SerieLote 
      IF @Existencia < 0 OR @ExistenciaActivoFijo < 0 SELECT @Ok = 20510
    END
  END
  
  RETURN
END
GO

/**************** fnSerieLoteConsignacionSaldoInicial ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnSerieLoteConsignacionSaldoInicial') DROP FUNCTION fnSerieLoteConsignacionSaldoInicial
GO
CREATE FUNCTION fnSerieLoteConsignacionSaldoInicial 
	(
	@Estacion				int,
	@GenerarModulo			varchar(5),
	@GenerarID				int,
	@Empresa				varchar(5), 
	@OModulo				varchar(5),
	@OModuloID				int,
	@Articulo				varchar(20),
	@SubCuenta				varchar(50),
	@SerieLote				varchar(50),
	@FechaCorte				datetime
	)
RETURNS float
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Resultado	float

  
  SELECT 
    @Resultado =ISNULL(SUM(ISNULL(slca.CargoU,0.0)-ISNULL(slca.AbonoU,0.0)),0.0)
    FROM SerieLoteConsignacionAuxTemp slca LEFT OUTER JOIN SerieLoteConsignacion slc
      ON slc.SerieLote = slca.SerieLote AND ISNULL(slc.SubCuenta,'') = ISNULL(slca.SubCuenta,'') AND slc.Articulo = slca.Articulo AND slc.OModuloID = slca.MModuloID AND slc.OModulo = slca.MModulo AND slc.Empresa = slca.Empresa 
   WHERE (NULLIF(slca.CorteID,0) IS NOT NULL OR slc.SerieLote IS NOT NULL)
     AND slca.Fecha <= @FechaCorte
     AND slca.SerieLote = @SerieLote
     AND ISNULL(slca.SubCuenta,'') = ISNULL(@SubCuenta,'')
     AND slca.Articulo = @Articulo
     AND slca.OModuloID = @OModuloID
     AND slca.OModulo = @OModulo
     AND slca.Empresa = @Empresa
     AND slca.Estacion = @Estacion
     AND slca.Modulo = @GenerarModulo
     AND slca.ModuloID = @GenerarID

  RETURN (@Resultado)
END
GO

/**************** fnSerieLoteConsignacionMovimientos ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnSerieLoteConsignacionMovimientos') DROP FUNCTION fnSerieLoteConsignacionMovimientos
GO
CREATE FUNCTION fnSerieLoteConsignacionMovimientos 
	(
	@Estacion				int,
	@GenerarModulo			varchar(5),
	@GenerarID				int,	
	@Empresa				varchar(5), 
	@OModulo				varchar(5),
	@OModuloID				int,
	@Articulo				varchar(20),
	@SubCuenta				varchar(50),
	@SerieLote				varchar(50),
	@FechaCorte				datetime
	)
RETURNS float
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Resultado	float

  SELECT 
    @Resultado =ISNULL(SUM(ISNULL(AbonoU,0.0)-ISNULL(CargoU,0.0)),0.0)
    FROM SerieLoteConsignacionAuxTemp slca
   WHERE NULLIF(CorteID,0) IS NULL
     AND slca.Fecha <= @FechaCorte
     AND slca.SerieLote = @SerieLote
     AND ISNULL(slca.SubCuenta,'') = ISNULL(@SubCuenta,'')
     AND slca.Articulo = @Articulo
     AND slca.OModuloID = @OModuloID
     AND slca.OModulo = @OModulo
     AND slca.Empresa = @Empresa
     AND slca.Estacion = @Estacion
     AND slca.Modulo = @GenerarModulo
     AND slca.ModuloID = @GenerarID
     AND (slca.OModuloID <> slca.MModuloID OR slca.OModulo <> slca.MModulo)
     
  RETURN (@Resultado)
END
GO

/**************** fnSerieLoteConsignacionParticipacion ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnSerieLoteConsignacionParticipacion') DROP FUNCTION fnSerieLoteConsignacionParticipacion
GO
CREATE FUNCTION fnSerieLoteConsignacionParticipacion 
	(
	@Empresa				varchar(5), 
	@OModuloID				int,
	@Articulo				varchar(20),
	@SubCuenta				varchar(50),
	@SerieLote				varchar(50)
	)
RETURNS float
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Resultado				float,
    @ImporteTotal			float,
    @DetalleImporteTotal	float

  SELECT 
    @ImporteTotal = SUM(ImporteTotal)
    FROM CompraTCalc
   WHERE ID = @OModuloID
   
  SELECT
    @DetalleImporteTotal = SUM((ISNULL(slm.Cantidad,0.0)/ISNULL(cd.Cantidad,0.0))*ctc.ImporteTotal)
    FROM SerieLoteMov slm JOIN CompraD cd
      ON cd.RenglonID = slm.RenglonID AND cd.ID = slm.ID AND 'COMS' = slm.Modulo JOIN CompraTCalc ctc
      ON ctc.RenglonSub = cd.RenglonSub AND ctc.Renglon = cd.Renglon AND ctc.ID = cd.ID
   WHERE RTRIM(slm.SerieLote) = RTRIM(@SerieLote)
     AND ISNULL(slm.SubCuenta,'') = ISNULL(@SubCuenta,'')
     AND RTRIM(slm.Articulo) = RTRIM(@Articulo)
     AND RTRIM(slm.ID) = RTRIM(@OModuloID)
     AND RTRIM(slm.Modulo) = 'COMS'
     AND RTRIM(slm.Empresa) = RTRIM(@Empresa)
   
  SET @Resultado = ISNULL(@DetalleImporteTotal,0.0) / ISNULL(@ImporteTotal,0.0)

  RETURN (@Resultado)
END
GO


/************** spMovOrigen *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovOrigen') and type = 'P') drop procedure dbo.spMovOrigen
GO
CREATE PROCEDURE spMovOrigen
        @DModulo				varchar(5),
        @DModuloID				int,
		@Nivel					int,
		@OModulo				varchar(5) OUTPUT,
		@OModuloID				int OUTPUT
		

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @OModuloResultado			varchar(5),
    @OModuloIDResultado			int

  SELECT @Nivel = @Nivel + 1      
  IF NOT EXISTS(SELECT OModulo FROM MovFlujo WHERE DModulo = @DModulo AND DID = @DModuloID) OR @Nivel > 20
  BEGIN
    SELECT @OModulo = @DModulo, @OModuloID = @DModuloID            
  END ELSE
  BEGIN  
    SELECT @OModuloResultado = OModulo, @OModuloIDResultado = OID FROM MovFlujo WHERE DModulo = @DModulo AND DID = @DModuloID
    EXEC spMovOrigen @OModuloResultado, @OModuloIDResultado, @Nivel, @OModuloResultado OUTPUT, @OModuloIDResultado OUTPUT             
    SELECT @OModulo = @OModuloResultado, @OModuloID = @OModuloIDResultado              
  END  
END
GO

/**************** fnSerieLoteConsignacionCorteVerificado ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnSerieLoteConsignacionCorteVerificado') DROP FUNCTION fnSerieLoteConsignacionCorteVerificado
GO
CREATE FUNCTION fnSerieLoteConsignacionCorteVerificado 
	(
    @Estacion				int,
	@Modulo					varchar(20),
	@ModuloID				int
	)
RETURNS bit
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Resultado	bit

  
  SET @Resultado = 1
  IF EXISTS(SELECT slca.Empresa 
              FROM SerieLoteConsignacionAuxTemp slcat JOIN SerieLoteConsignacionAux slca
                ON slca.RID = slcat.RIDOriginal AND slca.SerieLote = slcat.SerieLote AND ISNULL(slca.SubCuenta,'') = ISNULL(slcat.SubCuenta,'') AND slca.Articulo = slcat.Articulo AND slca.OModuloID = slcat.OModuloID AND slca.OModulo = slcat.OModulo AND slca.OModulo = slcat.OModulo
             WHERE (ISNULL(slca.CorteID,0) <> ISNULL(slcat.CorteID,0) OR ISNULL(slca.CorteIDAnterior,0) <> ISNULL(slcat.CorteIDAnterior,0))
               AND slcat.ModuloID = @ModuloID
               AND slcat.Modulo = @Modulo
               AND slcat.Estacion = @Estacion)
               SET @Resultado = 0
                  
     
  RETURN (@Resultado)
END
GO

--SELECT dbo.fnSerieLoteConsignacionCorteVerificado(52, 'CXP', 68) 

/**************** fnSerieLoteConsignacionUltimoCorteTemp ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnSerieLoteConsignacionUltimoCorteTemp') DROP FUNCTION fnSerieLoteConsignacionUltimoCorteTemp
GO
CREATE FUNCTION fnSerieLoteConsignacionUltimoCorteTemp 
	(
    @Estacion				int,
	@Modulo					varchar(20),
	@ModuloID				int
	)
RETURNS int
--//WITH ENCRYPTION
AS BEGIN                  
  DECLARE
    @Resultado				int
       
  SELECT TOP 1
    @Resultado = NULLIF(CorteID,0)
    FROM SerieLoteConsignacionAuxTemp
   WHERE ModuloID = @ModuloID
     AND Modulo = @Modulo
     AND Estacion = @Estacion
     AND CorteID NOT IN (SELECT CorteIDAnterior FROM SerieLoteConsignacionAuxTemp WHERE ModuloID = @ModuloID AND Modulo = @Modulo AND Estacion = @Estacion AND CorteID IS NOT NULL)
     AND CorteID IS NOT NULL   
         
  RETURN (@Resultado)
END
GO

--SELECT dbo.fnSerieLoteConsignacionUltimoCorteTemp(52, 'CXP', 68) 

/**************** fnSerieLoteConsignacionUltimoCorte ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnSerieLoteConsignacionUltimoCorte') DROP FUNCTION fnSerieLoteConsignacionUltimoCorte
GO
CREATE FUNCTION fnSerieLoteConsignacionUltimoCorte 
	(
	@OModulo				varchar(20),
	@OModuloID				int
	)
RETURNS int
--//WITH ENCRYPTION
AS BEGIN                  
  DECLARE
    @Resultado				int
       
  SELECT TOP 1
    @Resultado = NULLIF(CorteID,0)
    FROM SerieLoteConsignacionAux
   WHERE OModuloID = @OModuloID
     AND OModulo = @OModulo
     AND CorteID NOT IN (SELECT CorteIDAnterior FROM SerieLoteConsignacionAux WHERE OModuloID = @OModuloID AND OModulo = @OModulo AND CorteID IS NOT NULL)
     AND CorteID IS NOT NULL   
         
  RETURN (@Resultado)
END
GO

/******************************* spSerieLoteConsignacion *************************************************/
if exists (select * from sysobjects where id = object_id('dbo.spSerieLoteConsignacion') and type = 'P') drop procedure dbo.spSerieLoteConsignacion --MEJORASLC
GO             
CREATE PROCEDURE spSerieLoteConsignacion
		@Empresa		varchar(5),
		@Articulo		varchar(20),
		@SubCuenta		varchar(50),
		@SerieLote		varchar(50),
		@Modulo			varchar(20),
		@ModuloID		varchar(20),
		@Accion			varchar(20),

		@Cantidad		float,			
		
		@EsEntrada		bit = 0,
		@EsSalida		bit = 0,
		@Ok		int = NULL OUTPUT,
		@OkRef		varchar(255) = NULL OUTPUT


--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @MovTipo				varchar(20),
    @SubMovTipo				varchar(20),
    @CantidadSobrante		float,
    @CantidadDisponible		float,
    @CantidadAbonar			float,
    @OModulo				varchar(5),
    @OModuloID				int,    
    @OModuloDisponible		varchar(5),
    @OModuloIDDisponible	int,
    @CargoU					float,
    @AbonoU					float
    

  IF @Modulo = 'COMS' SELECT @MovTipo = mt.Clave, @SubMovTipo = mt.SubClave FROM MovTipo mt JOIN Compra m ON m.Mov = mt.Mov WHERE mt.Modulo = @Modulo AND m.ID = @ModuloID ELSE
  IF @Modulo = 'VTAS' SELECT @MovTipo = mt.Clave, @SubMovTipo = mt.SubClave FROM MovTipo mt JOIN Venta m  ON m.Mov = mt.Mov WHERE mt.Modulo = @Modulo AND m.ID = @ModuloID ELSE
  IF @Modulo = 'PROD' SELECT @MovTipo = mt.Clave, @SubMovTipo = mt.SubClave FROM MovTipo mt JOIN Prod m   ON m.Mov = mt.Mov WHERE mt.Modulo = @Modulo AND m.ID = @ModuloID ELSE 
  IF @Modulo = 'INV'  SELECT @MovTipo = mt.Clave, @SubMovTipo = mt.SubClave FROM MovTipo mt JOIN Inv m    ON m.Mov = mt.Mov WHERE mt.Modulo = @Modulo AND m.ID = @ModuloID  

  IF @Accion IN ('AFECTAR')
  BEGIN
    IF @Modulo = 'COMS' AND @MovTipo = 'COMS.F' AND @SubMovTipo = 'COMS.SLC' AND @EsEntrada = 1
    BEGIN
      IF NOT EXISTS(SELECT * FROM SerieLoteConsignacion WHERE SerieLote = @SerieLote AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND OModuloID = @ModuloID AND OModulo = @Modulo AND Empresa = @Empresa)
      BEGIN
      
        INSERT SerieLoteConsignacion (Empresa,  OModulo, OModuloID, Articulo,  SubCuenta,             SerieLote,  Estatus)
                              VALUES (@Empresa, @Modulo, @ModuloID, @Articulo, ISNULL(@SubCuenta,''), @SerieLote, 'ALTA')
        IF @@ERROR <> 0 SELECT @Ok = 1                            

      END

      IF @Ok IS NULL      
      BEGIN
        INSERT SerieLoteConsignacionAux (Empresa,  OModulo, OModuloID, Articulo,  SubCuenta,             SerieLote,  Modulo,  ModuloID,  Fecha,                         CargoU,    AbonoU) 
                                 VALUES (@Empresa, @Modulo, @ModuloID, @Articulo, ISNULL(@SubCuenta,''), @SerieLote, @Modulo, @ModuloID, dbo.fnFechaSinHora(GETDATE()), @Cantidad, 0.0)
        IF @@ERROR <> 0 SELECT @Ok = 1                                                            
      END   
          
    END ELSE
    IF @EsEntrada = 1 AND (@MovTipo NOT IN ('COMS.F') AND @SubMovTipo NOT IN ('COMS.SLC')) 
    BEGIN
      SET @CantidadSobrante = @Cantidad
      WHILE @CantidadSobrante > 0.0 AND NULLIF(@Ok,0) IS NULL
      BEGIN
        SELECT @OModuloDisponible = NULL, @OModuloIDDisponible = NULL
        SELECT TOP 1
          @OModuloDisponible   = OModulo,
          @OModuloIDDisponible = OModuloID
          FROM SerieLoteConsignacion
         WHERE SerieLote = @SerieLote
           AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')         
           AND Articulo = @Articulo
           AND Empresa = @Empresa
           AND Estatus = 'ALTA' 

        IF @OModuloDisponible IS NOT NULL AND @OModuloIDDisponible IS NOT NULL    
        BEGIN
          SELECT 
            @CantidadDisponible = SUM(ISNULL(CargoU,0.0)-ISNULL(AbonoU,0.0))
            FROM SerieLoteConsignacionAux WITH(ROWLOCK)
           WHERE SerieLote = @SerieLote
             AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')           
             AND Articulo = @Articulo
             AND OModulo = @OModuloDisponible
             AND OModuloID = @OModuloIDDisponible
             AND Empresa = @Empresa

          SELECT 
            @CantidadDisponible = ISNULL(CargoU,0.0) - @CantidadDisponible
            FROM SerieLoteConsignacionAux WITH(ROWLOCK)
           WHERE SerieLote = @SerieLote
             AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')           
             AND Articulo = @Articulo
             AND OModulo = @OModuloDisponible
             AND OModuloID = @OModuloIDDisponible
             AND Modulo = @OModuloDisponible
             AND ModuloID = @OModuloIDDisponible             
             AND Empresa = @Empresa

          IF @CantidadDisponible > @CantidadSobrante  SET @CantidadAbonar = @CantidadSobrante ELSE
          IF @CantidadDisponible <= @CantidadSobrante SET @CantidadAbonar = @CantidadDisponible         
          
          INSERT SerieLoteConsignacionAux (Empresa,  OModulo,            OModuloID,            Articulo,  SubCuenta,             SerieLote,  Modulo,  ModuloID,  Fecha,                         CargoU,          AbonoU) 
                                   VALUES (@Empresa, @OModuloDisponible, @OModuloIDDisponible, @Articulo, ISNULL(@SubCuenta,''), @SerieLote, @Modulo, @ModuloID, dbo.fnFechaSinHora(GETDATE()), @CantidadAbonar, 0.0)         
          IF @@ERROR <> 0 SELECT @Ok = 1                                                     

          IF NULLIF(@Ok,0) IS NULL
          BEGIN
            UPDATE SerieLoteConsignacion
               SET Estatus = 'ALTA'
              FROM SerieLoteConsignacion
             WHERE SerieLote = @SerieLote
               AND Articulo = @Articulo
               AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')
               AND OModuloID = @OModuloIDDisponible
               AND OModulo = @OModuloDisponible
               AND Empresa = @Empresa
               AND Estatus = 'BAJA'         
            IF @@ERROR <> 0 SELECT @Ok = 1                                                     
          END
          
          IF @CantidadDisponible > @CantidadSobrante  SET @CantidadSobrante = 0.0 ELSE
          IF @CantidadDisponible <= @CantidadSobrante SET @CantidadSobrante = @CantidadSobrante - @CantidadDisponible         

          IF @CantidadDisponible > @CantidadSobrante  SET @CantidadDisponible = @CantidadDisponible - @CantidadAbonar ELSE
          IF @CantidadDisponible <= @CantidadSobrante SET @CantidadDisponible = 0.0

        END ELSE
          SET @CantidadSobrante = 0.0                
      END    
    END ELSE
    IF @EsSalida = 1
    BEGIN           
      SET @CantidadSobrante = @Cantidad
      WHILE @CantidadSobrante > 0.0 AND NULLIF(@Ok,0) IS NULL
      BEGIN
        SELECT @OModuloDisponible = NULL, @OModuloIDDisponible = NULL
        SELECT TOP 1
          @OModuloDisponible   = OModulo,
          @OModuloIDDisponible = OModuloID
          FROM SerieLoteConsignacion
         WHERE SerieLote = @SerieLote
           AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')         
           AND Articulo = @Articulo
           AND Empresa = @Empresa
           AND Estatus = 'ALTA' 

        IF @OModuloDisponible IS NOT NULL AND @OModuloIDDisponible IS NOT NULL    
        BEGIN
          SELECT 
            @CantidadDisponible = SUM(ISNULL(CargoU,0.0)-ISNULL(AbonoU,0.0))
            FROM SerieLoteConsignacionAux WITH(ROWLOCK)
           WHERE SerieLote = @SerieLote
             AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')           
             AND Articulo = @Articulo
             AND OModulo = @OModuloDisponible
             AND OModuloID = @OModuloIDDisponible
             AND Empresa = @Empresa

          IF @CantidadDisponible > @CantidadSobrante  SET @CantidadAbonar = @CantidadSobrante ELSE
          IF @CantidadDisponible <= @CantidadSobrante SET @CantidadAbonar = @CantidadDisponible         
          
          INSERT SerieLoteConsignacionAux (Empresa,  OModulo,            OModuloID,            Articulo,  SubCuenta,             SerieLote,  Modulo,  ModuloID,  Fecha,                         CargoU, AbonoU) 
                                   VALUES (@Empresa, @OModuloDisponible, @OModuloIDDisponible, @Articulo, ISNULL(@SubCuenta,''), @SerieLote, @Modulo, @ModuloID, dbo.fnFechaSinHora(GETDATE()), 0.0,    @CantidadAbonar)         
          IF @@ERROR <> 0 SELECT @Ok = 1                                                     
          
          IF @CantidadDisponible > @CantidadSobrante  SET @CantidadSobrante = 0.0 ELSE
          IF @CantidadDisponible <= @CantidadSobrante SET @CantidadSobrante = @CantidadSobrante - @CantidadDisponible         

          IF @CantidadDisponible > @CantidadSobrante  SET @CantidadDisponible = @CantidadDisponible - @CantidadAbonar ELSE
          IF @CantidadDisponible <= @CantidadSobrante SET @CantidadDisponible = 0.0

          IF @CantidadDisponible = 0.0         
          BEGIN
            UPDATE SerieLoteConsignacion
               SET Estatus = 'BAJA'
              FROM SerieLoteConsignacion
             WHERE SerieLote = @SerieLote
               AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')             
               AND Articulo = @Articulo
               AND OModuloID = @OModuloIDDisponible
               AND OModulo = @OModuloDisponible
               AND Empresa = @Empresa
               AND Estatus = 'ALTA'         
            IF @@ERROR <> 0 SELECT @Ok = 1                                         
            
          END
        END ELSE
          SET @CantidadSobrante = 0.0        
      END
    END
  
  END ELSE
  IF @Accion IN ('CANCELAR')
  BEGIN
    DECLARE crSerieLoteConsignacionAux INSENSITIVE CURSOR FOR
     SELECT OModulo, OModuloID, CargoU, AbonoU 
       FROM SerieLoteConsignacionAux
      WHERE Modulo = @Modulo
        AND ModuloID = @ModuloID 
        AND Empresa = @Empresa
        AND Articulo = @Articulo
        AND SubCuenta = @SubCuenta
        AND SerieLote = @SerieLote

    OPEN crSerieLoteConsignacionAux
    FETCH NEXT FROM crSerieLoteConsignacionAux INTO @OModulo, @OModuloID, @CargoU, @AbonoU 
    WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
    BEGIN

      INSERT SerieLoteConsignacionAux (Empresa,  OModulo,  OModuloID,  Articulo,  SubCuenta,             SerieLote,  Modulo,  ModuloID,  Fecha,                         CargoU,  AbonoU) 
                               VALUES (@Empresa, @OModulo, @OModuloID, @Articulo, ISNULL(@SubCuenta,''), @SerieLote, @Modulo, @ModuloID, dbo.fnFechaSinHora(GETDATE()), @AbonoU, @CargoU)         
      IF @@ERROR <> 0 SELECT @Ok = 1                                                     
          
      FETCH NEXT FROM crSerieLoteConsignacionAux INTO @OModulo, @OModuloID, @CargoU, @AbonoU 
    END
    CLOSE crSerieLoteConsignacionAux
    DEALLOCATE crSerieLoteConsignacionAux

  END   
  
END
GO

/**************** spMoverSeriesLotesWMS ****************/
if exists (select * from sysobjects where id = object_id('dbo.spMoverSeriesLotesWMS') and type = 'P') drop procedure dbo.spMoverSeriesLotesWMS
GO              
CREATE PROCEDURE spMoverSeriesLotesWMS
           @Accion			        char(20),
		   @Tarima			        varchar(20),
           @TarimaSurtido           varchar(20),
           @Cantidad                float,
           @Ok 				        int		OUTPUT, 
           @OkRef 			        varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @SerieLote			varchar(50),
    @Propiedades		char(20),
    @CantidadSerie   	float,
    @CantidadRestante   float

    SET @CantidadRestante = @Cantidad

    IF @Accion = 'AFECTAR'
    BEGIN
        DECLARE crSerieLoteMov CURSOR FOR 
	        SELECT NULLIF(RTRIM(SerieLote), ''), ISNULL(Existencia, 0.0), NULLIF(RTRIM(Propiedades), '')
	        FROM TarimaSerieLote
	       WHERE Tarima = @Tarima
            OPEN crSerieLoteMov
            FETCH NEXT FROM crSerieLoteMov INTO @SerieLote, @CantidadSerie, @Propiedades
            IF @@ERROR <> 0 SELECT @Ok = 1
            WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
            BEGIN
            IF @@FETCH_STATUS <> -2 AND (@Cantidad <> 0.0)
            BEGIN

                IF @CantidadRestante > 0
                BEGIN

                  IF @CantidadSerie > @CantidadRestante
                    SET @CantidadSerie = @CantidadRestante

                  UPDATE TarimaSerieLote SET Existencia = ISNULL(Existencia,0) - ISNULL(@CantidadSerie,0) WHERE Tarima = @Tarima
                  IF EXISTS (SELECT * FROM TarimaSerieLote WHERE SerieLote = @SerieLote AND ISNULL(Tarima,'') = ISNULL(@Tarima,''))
                  BEGIN
                    UPDATE TarimaSerieLote SET Existencia = ISNULL(Existencia,0) + ISNULL(@CantidadSerie,0) WHERE Tarima = @TarimaSurtido
	              END
                  IF NOT EXISTS (SELECT * FROM TarimaSerieLote WHERE SerieLote = @SerieLote AND ISNULL(Tarima,'') = ISNULL(@TarimaSurtido,''))
                  BEGIN
                    INSERT TarimaSerieLote (Tarima, SerieLote, Propiedades, Existencia)
                                VALUES (@TarimaSurtido, @SerieLote, @Propiedades, @CantidadSerie)
	              END
                END
                SET @CantidadRestante = ISNULL(@CantidadRestante,0) - @CantidadSerie
            END
            FETCH NEXT FROM crSerieLoteMov INTO @SerieLote, @Cantidad, @Propiedades
            IF @@ERROR <> 0 SELECT @Ok = 1
            END
            CLOSE crSerieLoteMov
            DEALLOCATE crSerieLoteMov
    END

  RETURN
END
GO
/**************** spSeriesLotesWMS ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSeriesLotesWMS') and type = 'P') drop procedure dbo.spSeriesLotesWMS
GO              
CREATE PROCEDURE spSeriesLotesWMS
	       @Empresa			        char(5),
           @Modulo                  char(5),
           @Accion			        char(20),
		   @EsEntrada			    bit, 
		   @EsSalida			    bit, 
           @ID  			        int, 
	       @RenglonID			    int, 
           @Articulo                char(20),
		   @SubCuenta			    varchar(50),
		   @MovTipo			        char(20),
		   @AplicaMovTipo		    char(20),
		   @FechaEmision		    datetime,
		   @Temp			        bit = 0,
		   @Tarima			        varchar(20),
           @CantidadMovimiento      float,
           @Ok 				        int		OUTPUT, 
           @OkRef 			        varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @SubCuentaNull		varchar(50),
    @SerieLote			varchar(50),
    @Propiedades		char(20),
    @Cantidad			float,
    @MovSubTipo				char(20),
    @OrigenTipo                 varchar(10)


  SELECT @MovSubTipo = NULLIF(RTRIM(mt.SubClave), '')
    FROM MovTipo mt
   WHERE mt.Modulo = @Modulo AND mt.Clave = @MovTipo

   

    IF @Accion = 'AFECTAR'
    BEGIN
        DECLARE crSerieLoteMov CURSOR FOR 
	        SELECT NULLIF(RTRIM(SerieLote), ''), ISNULL(Cantidad, 0.0), NULLIF(RTRIM(Propiedades), '')
	        FROM SerieLoteMov
	        WHERE Empresa   = @Empresa
	        AND Modulo    = @Modulo
	        AND ID        = @ID
	        AND RenglonID = @RenglonID
	        AND Articulo  = @Articulo
	        AND SubCuenta = ISNULL(@SubCuenta, SubCuenta)
            OPEN crSerieLoteMov
            FETCH NEXT FROM crSerieLoteMov INTO @SerieLote, @Cantidad, @Propiedades
            IF @@ERROR <> 0 SELECT @Ok = 1
            WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
            BEGIN
            IF @@FETCH_STATUS <> -2 AND (@Cantidad <> 0.0)
            BEGIN
                IF EXISTS (SELECT * FROM TarimaSerieLote WHERE SerieLote = @SerieLote AND Tarima = @Tarima)
                BEGIN
                    UPDATE TarimaSerieLote 
                       SET Existencia = ISNULL(Existencia,0) + @Cantidad
                     WHERE SerieLote = @SerieLote AND ISNULL(Tarima,'') = ISNULL(@Tarima,'')
	            END

                IF NOT EXISTS (SELECT * FROM TarimaSerieLote WHERE SerieLote = @SerieLote AND ISNULL(Tarima,'') = ISNULL(@Tarima,''))
                BEGIN
                    INSERT TarimaSerieLote (Tarima, SerieLote, Propiedades, Existencia)
                                VALUES (@Tarima, @SerieLote, @Propiedades, @Cantidad)
	            END
            END
            FETCH NEXT FROM crSerieLoteMov INTO @SerieLote, @Cantidad, @Propiedades
            IF @@ERROR <> 0 SELECT @Ok = 1
            END
            CLOSE crSerieLoteMov
            DEALLOCATE crSerieLoteMov
    END

    IF @Accion = 'CANCELAR'
    BEGIN
        DECLARE crSerieLoteMov CURSOR FOR 
	        SELECT NULLIF(RTRIM(SerieLote), ''), ISNULL(Cantidad, 0.0), NULLIF(RTRIM(Propiedades), '')
	        FROM SerieLoteMov
	        WHERE Empresa   = @Empresa
	        AND Modulo    = @Modulo
	        AND ID        = @ID
	        AND RenglonID = @RenglonID
	        AND Articulo  = @Articulo
	        AND NULLIF(RTRIM(SubCuenta), '') = @SubCuentaNull
            OPEN crSerieLoteMov
            FETCH NEXT FROM crSerieLoteMov INTO @SerieLote, @Cantidad, @Propiedades
            IF @@ERROR <> 0 SELECT @Ok = 1
            WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
            BEGIN
            IF @@FETCH_STATUS <> -2 AND (@Cantidad <> 0.0)
            BEGIN
                  
                IF EXISTS (SELECT * FROM TarimaSerieLote WHERE SerieLote = @SerieLote AND ISNULL(Tarima,'') = ISNULL(@Tarima,''))
                BEGIN
                    UPDATE TarimaSerieLote 
                       SET Existencia = ISNULL(Existencia,0) - @Cantidad
                     WHERE SerieLote = @SerieLote AND ISNULL(Tarima,'') = ISNULL(@Tarima,'')
	            END

            END
            FETCH NEXT FROM crSerieLoteMov INTO @SerieLote, @Cantidad, @Propiedades
            IF @@ERROR <> 0 SELECT @Ok = 1
            END
            CLOSE crSerieLoteMov
            DEALLOCATE crSerieLoteMov
    END

  RETURN
END
GO

/**************** spSeriesLotesMayoreo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSeriesLotesMayoreo') and type = 'P') drop procedure dbo.spSeriesLotesMayoreo
GO              
CREATE PROCEDURE spSeriesLotesMayoreo
		   @Sucursal			int,
		   @SucursalAlmacen		int,
                   @SucursalAlmacenDestino	int,	
	           @Empresa			char(5),
                   @Modulo                      char(5),
                   @Accion			char(20),
		   @AfectarCostos		bit,
		   @EsEntrada			bit, 
		   @EsSalida			bit, 
		   @EsTransferencia		bit,

                   @ID  			int, 
	           @RenglonID			int, 
                   @Almacen			char(10),
		   @AlmacenDestino		char(10),
                   @Articulo                    char(20),
		   @SubCuenta			varchar(50),
		   @ArtTipo			char(20),
		   @ArtSerieLoteInfo		bit,
		   @ArtLotesFijos		bit,	
		   @ArtCosto			float,
		   @ArtCostoInv			float,
                   @CantidadMovimiento 		float,
		   @Factor			float,
		   @MovTipo			char(20),
		   @AplicaMovTipo		char(20),
		   @AlmacenTipo			char(20),
		   @FechaEmision		datetime,

		   @CfgCosteoSeries		bit,                   
		   @CfgCosteoLotes		bit,
		   @ArtCostoIdentificado	bit, 	
		   @CfgValidarLotesCostoDif	bit,
		   @CfgVINAccesorioArt		bit, 
		   @CfgVINCostoSumaAccesorios	bit,

                   @Ok 				int		OUTPUT, 
                   @OkRef 			varchar(255)	OUTPUT,
		   @Temp			bit = 0,
		   @Tarima			varchar(20) = NULL
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @SubCuentaNull		varchar(50),
    @SerieLote			varchar(50),
    @SerieLotePropiedades	varchar(50),
    @Propiedades		char(20),
    @Cliente			varchar(10),
    @Localizacion		varchar(10),
    @Cantidad			float,
    @CantidadAlterna		float,
    @CantidadTomada		float,
    @ArtCostoF			float,
    @ArtCostoInvF		float,
    @SumaCantidad		float,
    @SumaCantidadAlterna	float,
    @Requiere	        	float,
    @ExistenciaNueva 		float,
    @ExistenciaAnterior		float,
    @CosteoLotes		bit,
    @CostoPromedio		float,
    @UltimaEntrada		datetime,
    @UltimaSalida		datetime,
    @AlmacenTarima		varchar(20),
    @AlmacenDestinoTarima	varchar(20),
    @MovSubTipo				char(20),
    @PedimentoExtraccion	char(50),
--REQ 13386  
    @LDIArticulo                bit,
    @LDI                        bit,
    @OrigenTipo                 varchar(10),
    @WMS						bit,  --BUG3819
    @TarimaOrigen               varchar(20),
	@ArticuloTarjetasDef		varchar(20)



  DECLARE @SerieloteMovVal TABLE
                               ( 
                                 RenglonID        int         NULL, 
                                 SerieLote        varchar(50) NULL, 
                                 TarimaOrigen     varchar(20) NULL, 
                                 Cantidad         float       NULL, 
                                 SucursalAlmacen  int         NULL
                               )

  SELECT @WMS = ISNULL(WMS,0) FROM Alm WHERE Almacen = @Almacen  --BUG3819
  SELECT @ArticuloTarjetasDef = CxcArticuloTarjetasDef FROM EmpresaCfg WHERE Empresa = @Empresa
  SELECT @OrigenTipo = OrigenTipo FROM Venta WHERE ID = @ID
  SELECT @LDI = ISNULL(InterfazLDI,0) FROM EmpresaGral WHERE Empresa = @Empresa
  SELECT @LDIArticulo = ISNULL(LDI,0) FROM Art WHERE Articulo = @Articulo      

  SELECT @SubCuenta              = ISNULL(RTRIM(@SubCuenta), ''), 
         @SubCuentaNull          = NULLIF(RTRIM(@SubCuenta), ''),
         @Tarima		 = ISNULL(RTRIM(@Tarima), ''), 
         @UltimaEntrada          = NULL,
         @UltimaSalida           = NULL,
         @CosteoLotes	         = 0
         
  SELECT @MovSubTipo = NULLIF(RTRIM(mt.SubClave), '')
    FROM MovTipo mt
   WHERE mt.Modulo = @Modulo AND mt.Clave = @MovTipo

  SELECT @AlmacenTarima		 = dbo.fnAlmacenTarima(@Almacen, @Tarima),
         @AlmacenDestinoTarima	 = dbo.fnAlmacenTarima(@AlmacenDestino, @Tarima)

  IF ((@ArtTipo IN ('LOTE', 'PARTIDA') AND (@CfgCosteoLotes  = 1 OR @ArtCostoIdentificado = 1)) OR 
      (@ArtTipo IN ('SERIE', 'VIN')    AND (@CfgCosteoSeries = 1 OR @ArtCostoIdentificado = 1))) SELECT @CosteoLotes = 1
  IF (@AplicaMovTipo = 'COMS.CC' AND @MovTipo IN ('COMS.F', 'COMS.FL', 'COMS.EG', 'COMS.EI')) OR (@AplicaMovTipo = 'VTAS.R' AND @MovTipo IN ('VTAS.F', 'VTAS.FAR', 'VTAS.FC', 'VTAS.FG', 'VTAS.FX')) RETURN

  --IF @MovTipo IN ('VTAS.N', 'VTAS.NO', 'VTAS.NR', 'VTAS.FM', 'COMS.CC') AND @CosteoLotes = 1 AND @ArtSerieLoteInfo = 0 SELECT @Ok = 20720
  -- Para corregir este problema hay que enviar la Serie/Lote a movimiento Final ??

  IF @EsEntrada = 1 SELECT @UltimaEntrada = @FechaEmision ELSE
  IF @EsSalida  = 1 SELECT @UltimaSalida  = @FechaEmision

  IF @EsEntrada = 1 AND @Modulo = 'INV' AND @MovTipo = 'INV.EI' AND @MovSubTipo = 'INV.EXT' AND @Accion = 'AFECTAR'
  BEGIN
  	SELECT @PedimentoExtraccion = NULLIF(RTRIM(i.PedimentoExtraccion), '')
  	  FROM Inv i
  	WHERE i.ID = @ID

    IF @PedimentoExtraccion IS NOT NULL AND (SELECT COUNT(*)
          FROM SerieLoteMov
         WHERE Empresa   = @Empresa
           AND Modulo    = @Modulo
           AND ID        = @ID
           AND RenglonID = @RenglonID
           AND Articulo  = @Articulo
           AND NULLIF(RTRIM(SubCuenta), '') = @SubCuentaNull) > 1
    SELECT @Ok = 73070, @OkRef = 'Producto ' + RTRIM(@Articulo)

  	IF @PedimentoExtraccion IS NOT NULL AND @Ok IS NULL
    BEGIN
  	  UPDATE SerieLoteMov SET SerieLote = @PedimentoExtraccion
       WHERE Empresa   = @Empresa
         AND Modulo    = @Modulo
         AND ID        = @ID
         AND RenglonID = @RenglonID
         AND Articulo  = @Articulo
         AND NULLIF(RTRIM(SubCuenta), '') = @SubCuentaNull
    END
  END

  SELECT @ArtCostoF = @ArtCosto / @Factor--, @ArtCostoInvF = @ArtCostoInv / @Factor
  SELECT @SumaCantidad = 0.0, @SumaCantidadAlterna = 0.0
  IF @Temp = 1
  BEGIN
    CREATE INDEX Llave ON #SerieLoteMov (ID, RenglonID, Articulo, SubCuenta, SerieLote, Modulo, Empresa)     
    DECLARE crSerieLoteMov CURSOR FOR 
     SELECT NULLIF(RTRIM(SerieLote), ''), ISNULL(Cantidad, 0.0)/**@Factor*/, ISNULL(CantidadAlterna, 0.0)/**@Factor*/, NULLIF(RTRIM(Propiedades), ''), NULLIF(RTRIM(Cliente), ''), NULLIF(RTRIM(Localizacion), ''), ISNULL(NULLIF(ArtCostoInv, 0), @ArtCostoInv) / @Factor 
       FROM #SerieLoteMov
      WHERE Empresa   = @Empresa
        AND Modulo    = @Modulo
        AND ID        = @ID
        AND RenglonID = @RenglonID
        AND Articulo  = @Articulo
        AND NULLIF(RTRIM(SubCuenta), '') = @SubCuentaNull
  END ELSE
		IF ISNULL(@AlmacenTarima,'') = ''
			DECLARE crSerieLoteMov CURSOR FOR 
			 SELECT NULLIF(RTRIM(SerieLote), ''), ISNULL(Cantidad, 0.0)/**@Factor*/, ISNULL(CantidadAlterna, 0.0)/**@Factor*/, NULLIF(RTRIM(Propiedades), ''), NULLIF(RTRIM(Cliente), ''), NULLIF(RTRIM(Localizacion), ''), ISNULL(NULLIF(ArtCostoInv, 0), @ArtCostoInv) / @Factor 
			   FROM SerieLoteMov
			  WHERE Empresa   = @Empresa
				AND Modulo    = @Modulo
				AND ID        = @ID
				AND RenglonID = @RenglonID
				AND Articulo  = @Articulo
				AND NULLIF(RTRIM(SubCuenta), '') = @SubCuentaNull
		ELSE 
			DECLARE crSerieLoteMov CURSOR FOR 
			 SELECT NULLIF(RTRIM(SerieLote), ''), ISNULL(Cantidad, 0.0)/**@Factor*/, ISNULL(CantidadAlterna, 0.0)/**@Factor*/, NULLIF(RTRIM(Propiedades), ''), NULLIF(RTRIM(Cliente), ''), NULLIF(RTRIM(Localizacion), ''), ISNULL(NULLIF(ArtCostoInv, 0), @ArtCostoInv) / @Factor 
			   FROM SerieLoteMov
			  WHERE Empresa   = @Empresa
				AND Modulo    = @Modulo
				AND ID        = @ID
				AND RenglonID = @RenglonID
				AND Articulo  = @Articulo
				AND NULLIF(RTRIM(SubCuenta), '') = @SubCuentaNull

  OPEN crSerieLoteMov
  FETCH NEXT FROM crSerieLoteMov INTO @SerieLote, @Cantidad, @CantidadAlterna, @Propiedades, @Cliente, @Localizacion, @ArtCostoInvF
  IF @@ERROR <> 0 SELECT @Ok = 1
  WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL
  BEGIN
    IF @@FETCH_STATUS <> -2 AND (@Cantidad <> 0.0 OR @CantidadAlterna <> 0.0)
    BEGIN
      SELECT @SumaCantidad = @SumaCantidad + @Cantidad, @SumaCantidadAlterna = @SumaCantidadAlterna + @CantidadAlterna
      SELECT @ExistenciaNueva = 0.0, @ExistenciaAnterior = 0.0, @CostoPromedio = 0.0

      SELECT @ExistenciaAnterior = CASE @AlmacenTipo WHEN 'ACTIVOS FIJOS' THEN ISNULL(ExistenciaActivoFijo, 0.0) ELSE ISNULL(Existencia, 0.0) END,
             @SerieLotePropiedades = NULLIF(RTRIM(Propiedades), '')
        FROM SerieLote
       WHERE Sucursal  = @SucursalAlmacen
         AND Empresa   = @Empresa 
         AND Articulo  = @Articulo 
         AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')
         AND SerieLote = @SerieLote 
         AND Almacen   = @Almacen
		 AND ISNULL(Tarima,'')    = ISNULL(@AlmacenTarima,'')

      IF (@EsSalida = 1 OR @EsTransferencia = 1 OR @Modulo = 'VTAS') AND @Propiedades <> @SerieLotePropiedades AND @Propiedades IS NULL 
      BEGIN
        SELECT @Propiedades = @SerieLotePropiedades
        IF @Temp = 1
          UPDATE #SerieLoteMov SET Propiedades = @Propiedades WHERE CURRENT OF crSerieLoteMov
        ELSE
          UPDATE SerieLoteMov SET Propiedades = @Propiedades WHERE CURRENT OF crSerieLoteMov
      END

      IF @CosteoLotes = 1
      BEGIN
        SELECT @CostoPromedio = ISNULL(SUM(ISNULL(Existencia, 0.0) * ISNULL(CostoPromedio, 0.0))/NULLIF(SUM(Existencia), 0.0), 0.0)
          FROM SerieLote
         WHERE Empresa 	 = @Empresa 
           AND Articulo  = @Articulo 
           AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta ,'')
           AND SerieLote = @SerieLote
           AND Almacen   = @Almacen
           AND ISNULL(Tarima,'') = ISNULL(@AlmacenTarima,'')
           AND Sucursal  = @SucursalAlmacen

        IF (@EsSalida = 1 OR @EsTransferencia = 1) AND @ArtLotesFijos = 1 AND @Accion <> 'CANCELAR'
          SELECT @ArtCostoInvF = @CostoPromedio
      END

      IF (@EsEntrada = 1 OR @ArtSerieLoteInfo = 1) AND @Ok IS NULL
      BEGIN
        IF @ArtSerieLoteInfo = 1 SELECT @Cantidad = 0.0
        IF (@AlmacenTipo = 'ACTIVOS FIJOS' AND  @Accion <> 'CANCELAR')
          UPDATE SerieLote
             SET @ExistenciaNueva = ExistenciaActivoFijo = ISNULL(ExistenciaActivoFijo, 0.0) + @Cantidad,
                 UltimaEntrada = CASE WHEN @EsEntrada = 1 AND @Accion <> 'CANCELAR' THEN @FechaEmision ELSE UltimaEntrada END,
                 UltimaSalida  = CASE WHEN @EsSalida  = 1 AND @Accion <> 'CANCELAR' THEN @FechaEmision ELSE UltimaSalida  END
           WHERE Sucursal  = @SucursalAlmacen
             AND Empresa   = @Empresa 
             AND Articulo  = @Articulo 
             AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')
             AND SerieLote = @SerieLote 
             AND Almacen   = @Almacen
             AND ISNULL(Tarima,'') = ISNULL(@AlmacenTarima,'')
        ELSE
		IF @Accion = 'CANCELAR'        
		BEGIN
            DECLARE crSerieLote CURSOR FOR  
            SELECT slm.RenglonID, slm.SerieLote, slm.Tarima, slm.Cantidad, a.Sucursal
              FROM SerieloteMov slm
              JOIN Alm a ON slm.Sucursal = a.Sucursal
             WHERE Id = @ID
                AND Modulo = @Modulo
                AND slm.Tarima <> ''
                AND slm.Articulo = @Articulo
                AND ISNULL(slm.SubCuenta,'') = ISNULL(@SubCuenta,'')
				AND a.Almacen = @Almacen 
                AND slm.Empresa = @Empresa 
                AND slm.Sucursal = @Sucursal 
            OPEN crSerieLote  
            FETCH NEXT FROM crSerieLote INTO @RenglonID, @SerieLote, @TarimaOrigen, @Cantidad, @SucursalAlmacen  
            WHILE @@FETCH_STATUS = 0 AND @Ok IS NULL
            BEGIN 

               IF EXISTS (SELECT * FROM SerieLote WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo  = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND SerieLote = @SerieLote AND Almacen = @Almacen AND ISNULL(Tarima,'') = ISNULL(@TarimaOrigen,'') )
                  UPDATE SerieLote
				     SET Existencia = 0,
					     UltimaEntrada  = UltimaEntrada,
					     UltimaSalida   = UltimaSalida
				   WHERE Sucursal             = @SucursalAlmacen 
                     AND Empresa              = @Empresa 
                     AND Articulo             = @Articulo 
                     AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') 
                     AND SerieLote            = @SerieLote 
                     AND Almacen              = @Almacen 
                     AND ISNULL(Tarima,'')    = ISNULL(@TarimaOrigen,'') 
                
               IF NOT EXISTS (SELECT * FROM @SerieloteMovVal WHERE RenglonID = @RenglonID AND SerieLote = @SerieLote AND TarimaOrigen = @TarimaOrigen AND @Cantidad = @Cantidad AND SucursalAlmacen = @SucursalAlmacen)
                 UPDATE SerieLote
                   SET @ExistenciaNueva = Existencia = ISNULL(Existencia, 0.0) + @Cantidad,
                       ExistenciaAlterna = ISNULL(ExistenciaAlterna, 0.0) + @CantidadAlterna,
                       UltimaEntrada     = CASE WHEN @EsEntrada = 1 AND @Accion <> 'CANCELAR' THEN @FechaEmision ELSE UltimaEntrada END,
                       UltimaSalida      = CASE WHEN @EsSalida  = 1 AND @Accion <> 'CANCELAR' THEN @FechaEmision ELSE UltimaSalida  END
                 WHERE Sucursal  = @SucursalAlmacen
                   AND Empresa   = @Empresa 
                   AND Articulo  = @Articulo 
                   AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')
                   AND SerieLote = @SerieLote 
                   AND Almacen   = @Almacen
                   AND ISNULL(Tarima,'') = ISNULL(@AlmacenTarima,'') 

                   INSERT @SerieloteMovVal (RenglonID, SerieLote, TarimaOrigen, Cantidad, SucursalAlmacen)
                                     SELECT @RenglonID, @SerieLote, @TarimaOrigen, @Cantidad, @SucursalAlmacen 
  
              FETCH NEXT FROM crSerieLote INTO @RenglonID, @SerieLote, @TarimaOrigen, @Cantidad, @SucursalAlmacen
            END  
            CLOSE crSerieLote  
            DEALLOCATE crSerieLote 
        END    

        IF EXISTS (SELECT * FROM SerieLote WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND SerieLote = @SerieLote AND Almacen = @Almacen AND ISNULL(Tarima,'') = ISNULL(@AlmacenTarima,''))             
        BEGIN
          IF @AlmacenTipo = 'ACTIVOS FIJOS'          
            UPDATE SerieLote 
               SET ExistenciaActivoFijo = ISNULL(ExistenciaActivoFijo,0) + @Cantidad, 
                   UltimaEntrada = @UltimaEntrada,
                   UltimaSalida = @UltimaSalida
             WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND SerieLote = @SerieLote AND Almacen = @Almacen AND ISNULL(Tarima,'') = ISNULL(@AlmacenTarima,'')
          ELSE
            UPDATE SerieLote 
               SET Existencia = ISNULL(Existencia,0) + @Cantidad, 
                   UltimaEntrada = @UltimaEntrada,
                   UltimaSalida = @UltimaSalida
             WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND SerieLote = @SerieLote AND Almacen = @Almacen AND ISNULL(Tarima,'') = ISNULL(@AlmacenTarima,'')
	    END

        IF NOT EXISTS (SELECT * FROM SerieLote WHERE Sucursal = @SucursalAlmacen AND Empresa = @Empresa AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'') AND SerieLote = @SerieLote AND Almacen = @Almacen AND ISNULL(Tarima,'') = ISNULL(@AlmacenTarima,''))             
        BEGIN
          IF @AlmacenTipo = 'ACTIVOS FIJOS'          
            INSERT SerieLote (Sucursal,         Empresa,  Articulo,  SubCuenta,  SerieLote,  Almacen,  Tarima,         Propiedades,  Cliente,  Localizacion,  ExistenciaActivoFijo, UltimaEntrada,  UltimaSalida)
                      VALUES (@SucursalAlmacen, @Empresa, @Articulo, @SubCuenta, @SerieLote, @Almacen, @AlmacenTarima, @Propiedades, @Cliente, @Localizacion, @Cantidad,            @UltimaEntrada, @UltimaSalida)
          ELSE
            INSERT SerieLote (Sucursal,          Empresa,  Articulo,  SubCuenta,  SerieLote,  Almacen, Tarima,         Propiedades,  Cliente,  Localizacion,  Existencia, ExistenciaAlterna, UltimaEntrada,  UltimaSalida)
                      VALUES (@SucursalAlmacen, @Empresa, @Articulo, @SubCuenta, @SerieLote, @Almacen, @AlmacenTarima, @Propiedades, @Cliente, @Localizacion, @Cantidad,  @CantidadAlterna,  @UltimaEntrada, @UltimaSalida)
        
	    END

		IF NOT EXISTS(SELECT Sucursal,          Empresa,  Articulo,  SubCuenta,  SerieLote,  Almacen, Tarima,         Propiedades,  Cliente,  Localizacion,  Existencia, ExistenciaAlterna, UltimaEntrada,  UltimaSalida
						FROM SerieLote 
					   WHERE SerieLote = @SerieLote AND Articulo = @Articulo AND SubCuenta = @SubCuenta 
						 AND Almacen = @Almacen AND Tarima = @AlmacenTarima AND Sucursal = @SucursalAlmacen AND Empresa = @Empresa)
			BEGIN
				INSERT SerieLote (Sucursal,          Empresa,  Articulo,  SubCuenta,  SerieLote,  Almacen, Tarima,         Propiedades,  Cliente,  Localizacion,  Existencia, ExistenciaAlterna, UltimaEntrada,  UltimaSalida)
				VALUES (@SucursalAlmacen, @Empresa, @Articulo, @SubCuenta, @SerieLote, @Almacen, @AlmacenTarima, @Propiedades, @Cliente, @Localizacion, @Cantidad,  @CantidadAlterna,  @UltimaEntrada, @UltimaSalida)			
			END

        IF @ArtTipo IN ('SERIE', 'VIN') AND @ArtSerieLoteInfo = 0
        BEGIN
          IF @AlmacenTipo = 'ACTIVOS FIJOS'
          BEGIN
            IF (SELECT ISNULL(SUM(ExistenciaActivoFijo), 0) FROM SerieLote WHERE Empresa = @Empresa AND Articulo  = @Articulo AND SerieLote = @SerieLote) <> 1.0 
			   IF @Accion <> 'CANCELAR'  SELECT @Ok = 20080
          END ELSE
          BEGIN
--JGD
            IF (SELECT ISNULL(SUM(Existencia), 0) FROM SerieLote WHERE Empresa = @Empresa AND Articulo = @Articulo AND SerieLote = @SerieLote) <> 1.0 AND (((SELECT NotasBorrador FROM EmpresaCFG WHERE Empresa = @Empresa) = 0) OR @MovTipo NOT IN ('VTAS.N','VTAS.NR','VTAS.NO'))
              SELECT @Ok = 20080
          END
        END

      END ELSE
      IF (@EsSalida = 1 OR @EsTransferencia = 1) AND @ArtSerieLoteInfo = 0 AND @Ok IS NULL
        --BUG3819
       IF @WMS=1
       BEGIN
         --IF @AlmacenTarima<>'' --BUG2983
          EXEC spSeriesLotesMayoreoDisminuir @Sucursal, @SucursalAlmacen, @SucursalAlmacenDestino, @Empresa, @Accion, @Almacen, @AlmacenDestino, @Articulo, @SubCuentaNull, @SubCuenta, @ArtTipo, @SerieLote, @Propiedades, @Cliente, @Localizacion, @Cantidad, @EsSalida, @EsTransferencia, @AlmacenTipo, @FechaEmision, @Ok OUTPUT, @AlmacenTarima = @AlmacenTarima, @AlmacenDestinoTarima = @AlmacenDestinoTarima, @MovTipo = @MovTipo         
       END
       ELSE
        EXEC spSeriesLotesMayoreoDisminuir @Sucursal, @SucursalAlmacen, @SucursalAlmacenDestino, @Empresa, @Accion, @Almacen, @AlmacenDestino, @Articulo, @SubCuentaNull, @SubCuenta, @ArtTipo, @SerieLote, @Propiedades, @Cliente, @Localizacion, @Cantidad, @EsSalida, @EsTransferencia, @AlmacenTipo, @FechaEmision, @Ok OUTPUT, @AlmacenTarima = @AlmacenTarima, @AlmacenDestinoTarima = @AlmacenDestinoTarima, @MovTipo = @MovTipo         
          
--JGD
      IF @Ok = 20090 AND (SELECT NotasBorrador FROM EmpresaCFG WHERE Empresa = @Empresa) = 1 AND @ArtTipo IN ('SERIE','LOTE')
        SELECT @Ok = NULL

      IF @Ok IS NULL 
        EXEC spSerieLoteFlujo @Sucursal, @SucursalAlmacen, @SucursalAlmacenDestino, @Accion, @Empresa, @Modulo, @ID, @Articulo, @SubCuenta, @SerieLote, @Almacen, @RenglonID, @Tarima = @AlmacenTarima
--JGD
/*
      IF (SELECT NotasBorrador FROM EmpresaCFG WHERE Empresa = @Empresa) = 1 AND @ArtTipo IN ('SERIE','LOTE') AND @EsSalida = 1
        UPDATE SerieLote 
           SET Existencia = -1*@Cantidad
         WHERE Articulo = @Articulo AND SerieLote = @SerieLote AND Empresa = @Empresa 
           AND ISNULL(RTRIM(SubCuenta), '') = ISNULL(RTRIM(@SubCuenta), '')
           AND Almacen = @Almacen
           AND ISNULL(RTRIM(Tarima),'') = ISNULL(RTRIM(@AlmacenTarima),'')
           AND ISNULL(Existencia, 0) = 0
*/

      -- Calcular Costeo por Lotes
      IF @CosteoLotes = 1 AND (@AfectarCostos = 1 OR @MovTipo = 'COMS.CC') AND @ArtSerieLoteInfo = 0 AND @Ok IS NULL
      BEGIN
        IF @MovTipo IN ('COMS.B', 'COMS.CA', 'COMS.GX')
          EXEC spBonificarCostoPromedio @ExistenciaAnterior, @Accion, @MovTipo, @Cantidad, @ArtCostoInvF, @CostoPromedio OUTPUT
        ELSE
        BEGIN
          IF @CfgValidarLotesCostoDif = 1 AND ROUND(@ArtCostoInvF, 2) <> ROUND(@CostoPromedio, 2)
            IF (@EsEntrada = 1 AND ROUND(@ExistenciaAnterior - @Cantidad, 4) > 0.0) OR (@EsSalida  = 1 AND ROUND(@ExistenciaAnterior + @Cantidad, 4) > 0.0)
              SELECT @Ok = 20710

          IF @Ok IS NULL
            EXEC spCalcCostoPromedio @ExistenciaAnterior, @EsEntrada, @Cantidad, @ArtCostoInvF, @CostoPromedio OUTPUT
        END

        IF (@EsEntrada = 1 AND @Accion <> 'CANCELAR') OR (@EsSalida = 1 AND @Accion = 'CANCELAR') OR @MovTipo IN ('COMS.B', 'COMS.CA', 'COMS.GX')
          UPDATE SerieLote
             SET CostoPromedio = @CostoPromedio
           WHERE Empresa   = @Empresa 
             AND Articulo  = @Articulo 
             AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,'')
             AND SerieLote = @SerieLote
             AND Almacen   = @Almacen
             AND ISNULL(Tarima,'') = ISNULL(@AlmacenTarima,'')
             AND Sucursal  = @SucursalAlmacen
      END

      IF @ArtTipo = 'VIN' 
        IF @EsEntrada = 1
        BEGIN
          UPDATE VIN 
             SET Costo = @ArtCostoF, CostoConGastos = @ArtCostoInvF
           WHERE VIN = @SerieLote

          IF @CfgVINAccesorioArt = 1 AND @CfgVINCostoSumaAccesorios = 1
            IF ABS(@CostoPromedio - (SELECT ROUND(SUM(PrecioDistribuidor), 0) FROM VINAccesorio WHERE VIN = @SerieLote AND Estatus = 'ALTA')) > 1.0
              SELECT @Ok = 20335, @OkRef = @SerieLote
        END ELSE
        IF @MovTipo IN ('VTAS.F', 'VTAS.FAR', 'VTAS.FC')
          UPDATE VIN 
             SET FechaFactura = @FechaEmision
           WHERE VIN = @SerieLote AND FechaFactura IS NULL

      IF @Ok IS NOT NULL 
        SELECT @OkRef = 'Articulo: '+RTRIM(@Articulo) + ' ' + @SubCuentaNull + ' ('+RTRIM(@SerieLote)+')'

      IF @CosteoLotes = 1 AND @ArtLotesFijos = 1 
      BEGIN
        IF @Temp = 1
          UPDATE #SerieLoteMov SET ArtCostoInv = @ArtCostoInvF * @Factor WHERE CURRENT OF crSerieLoteMov
        ELSE
          UPDATE SerieLoteMov SET ArtCostoInv = @ArtCostoInvF * @Factor WHERE CURRENT OF crSerieLoteMov
      END
	-- ETO Tarjetas 9-Feb-2007
--REQ 13386  
      IF @LDI = 1 OR @OrigenTipo = 'POS'
      BEGIN
        IF @OrigenTipo ='POS' and @Articulo = @ArticuloTarjetasDef 
          EXEC spValeSerieTarjeta @Empresa, @ID, @RenglonID, @MovTipo, @Accion, @Almacen, @AlmacenTipo, @Articulo, @ArtTipo, @SerieLote, @EsEntrada, @EsSalida, @FechaEmision, @Ok OUTPUT, @OkRef OUTPUT
        
        IF NULLIF(@OrigenTipo,'') IS NULL AND @Modulo = 'VTAS' AND Exists(SELECT * FROM ValeSerie WHERE Serie = @SerieLote AND Articulo = @Articulo)AND (@LDIArticulo = 0 OR (@LDIArticulo = 1 AND @MovTipo NOT IN('VTAS.N')))
          EXEC spValeSerieTarjeta @Empresa, @ID, @RenglonID, @MovTipo, @Accion, @Almacen, @AlmacenTipo, @Articulo, @ArtTipo, @SerieLote, @EsEntrada, @EsSalida, @FechaEmision, @Ok OUTPUT, @OkRef OUTPUT
      END
      ELSE   
        IF @Modulo = 'VTAS' AND Exists(SELECT * FROM ValeSerie WHERE Serie = @SerieLote AND Articulo = @Articulo)
          EXEC spValeSerieTarjeta @Empresa, @ID, @RenglonID, @MovTipo, @Accion, @Almacen, @AlmacenTipo, @Articulo, @ArtTipo, @SerieLote, @EsEntrada, @EsSalida, @FechaEmision, @Ok OUTPUT, @OkRef OUTPUT
            

      IF @Ok IS NULL --MEJORASLC
        EXEC spSerieLoteConsignacion @Empresa, @Articulo, @SubCuenta, @SerieLote, @Modulo, @ID, @Accion, @Cantidad, @EsEntrada, @EsSalida, @Ok OUTPUT, @OkRef OUTPUT  
    END 
   
    FETCH NEXT FROM crSerieLoteMov INTO @SerieLote, @Cantidad, @CantidadAlterna, @Propiedades, @Cliente, @Localizacion, @ArtCostoInvF
    IF @@ERROR <> 0 SELECT @Ok = 1
  END
  CLOSE crSerieLoteMov
  DEALLOCATE crSerieLoteMov
  
  -- Promediar Factor Alterno
/*  IF @ArtTipo = 'PARTIDA' AND @SumaCantidad > 0.0 AND @SumaCantidadAlterna > 0 AND @EsEntrada = 1 AND @Ok IS NULL
  BEGIN
    SELECT @Existencia = 0.0
    SELECT @Existencia = ISNULL(SUM(SaldoU), 0.0) FROM SaldoU WHERE Empresa=@Empresa AND Rama='INV' AND Cuenta=@Articulo
    SELECT @Existencia = @Existencia - @SumaCantidad
  END*/

  RETURN
END
GO

/**************** spSeriesLotesSurtidoAuto ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSeriesLotesSurtidoAuto') and type = 'P') drop procedure dbo.spSeriesLotesSurtidoAuto
GO              
CREATE PROCEDURE spSeriesLotesSurtidoAuto
		   @Sucursal			int,
	       @Empresa			char(5),
           @Modulo                      char(5),
		   @EsSalida			bit, 
		   @EsTransferencia		bit,
           @ID  			int, 
	           @RenglonID			int, 
                   @Almacen			char(10),
                   @Articulo                    char(20),
		   @SubCuenta			varchar(50),
                   @CantidadMovimiento 		float,
		   @Factor			float,
		   @AlmacenTipo			char(20),

		   @CfgSeriesLotesAutoOrden	char(20),	

                   @Ok 				int		OUTPUT, 
                   @OkRef 			varchar(255)	OUTPUT,
		   @Temp			bit = 0,
		   @Tarima			varchar(20)	= NULL
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @SubCuentaNull		varchar(50),
    @SerieLote			varchar(50),
    @CantidadTomada		float,
    @Requiere	        float,
    @Existencia 		float,
    @Mov				varchar(20),
    @MovTipo			varchar(20),
	@CantidadSL         float,
	@CantidadMov        float

  IF @Modulo = 'VTAS' SELECT @Mov = Mov FROM Venta WHERE ID = @ID
    SELECT @MovTipo = dbo.fnMovTipo(@Modulo, @Mov)

  IF @Modulo = 'INV' SELECT @Mov = Mov FROM Inv WHERE ID = @ID
    SELECT @MovTipo = dbo.fnMovTipo(@Modulo, @Mov)




  SELECT @SubCuenta       = ISNULL(RTRIM(@SubCuenta), ''), 
         @SubCuentaNull   = NULLIF(RTRIM(@SubCuenta), ''),
         @Tarima	  = ISNULL(dbo.fnAlmacenTarima(@Almacen, @Tarima), ''),
         @Existencia      = 0.0

  IF @EsSalida = 1 OR @EsTransferencia = 1 AND @CfgSeriesLotesAutoOrden <> 'NO'
    IF @Temp = 1 OR NOT EXISTS (SELECT * FROM SerieLoteMov WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID = @ID AND RenglonID = @RenglonID AND Articulo  = @Articulo AND SubCuenta = @SubCuenta)
    BEGIN
      IF @AlmacenTipo = 'ACTIVOS FIJOS'
      BEGIN
        IF @CfgSeriesLotesAutoOrden = 'FECHA 1' 
          DECLARE crSerieLoteMovAuto CURSOR FOR SELECT s.SerieLote, ISNULL(s.ExistenciaActivoFijo, 0.0) FROM SerieLote s LEFT OUTER JOIN SerieLoteProp p ON p.Propiedades = s.Propiedades WHERE s.Empresa = @Empresa AND s.Articulo = @Articulo AND s.SubCuenta = @SubCuenta AND s.Almacen = @Almacen AND s.Tarima = @Tarima AND s.ExistenciaActivoFijo > 0 ORDER BY p.Fecha1, s.SerieLote
        ELSE IF @CfgSeriesLotesAutoOrden = 'DESCENDENTE' 
          DECLARE crSerieLoteMovAuto CURSOR FOR SELECT SerieLote, ISNULL(ExistenciaActivoFijo, 0.0) FROM SerieLote WHERE Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Almacen = @Almacen AND Tarima = @Tarima AND ExistenciaActivoFijo > 0 ORDER BY SerieLote DESC 
        ELSE
          DECLARE crSerieLoteMovAuto CURSOR FOR SELECT SerieLote, ISNULL(ExistenciaActivoFijo, 0.0) FROM SerieLote WHERE Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Almacen = @Almacen AND Tarima = @Tarima AND ExistenciaActivoFijo > 0 ORDER BY SerieLote
      END ELSE
      BEGIN
        IF @CfgSeriesLotesAutoOrden = 'FECHA 1' 
          DECLARE crSerieLoteMovAuto CURSOR FOR SELECT s.SerieLote, ISNULL(s.Existencia, 0.0) FROM SerieLote s LEFT OUTER JOIN SerieLoteProp p ON p.Propiedades = s.Propiedades WHERE s.Empresa = @Empresa AND s.Articulo = @Articulo AND s.SubCuenta = @SubCuenta AND s.Almacen = @Almacen AND s.Tarima = @Tarima AND s.Existencia > 0 ORDER BY p.Fecha1, s.SerieLote
        ELSE IF @CfgSeriesLotesAutoOrden = 'DESCENDENTE' 
          DECLARE crSerieLoteMovAuto CURSOR FOR SELECT SerieLote, ISNULL(Existencia, 0.0) FROM SerieLote WHERE Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Almacen = @Almacen AND Tarima = @Tarima AND Existencia > 0 ORDER BY SerieLote DESC 
        ELSE
          DECLARE crSerieLoteMovAuto CURSOR FOR SELECT SerieLote, ISNULL(Existencia, 0.0) FROM SerieLote WHERE Empresa = @Empresa AND Articulo = @Articulo AND SubCuenta = @SubCuenta AND Almacen = @Almacen AND Tarima = @Tarima AND Existencia > 0 ORDER BY SerieLote
      END

      SELECT @Requiere = @CantidadMovimiento * @Factor
      OPEN crSerieLoteMovAuto
      FETCH NEXT FROM crSerieLoteMovAuto INTO @SerieLote, @Existencia
      IF @@ERROR <> 0 SELECT @Ok = 1
      WHILE @@FETCH_STATUS <> -1 AND @Requiere > 0 AND @Ok IS NULL
      BEGIN
        IF @@FETCH_STATUS <> -2 AND @Existencia > 0
        BEGIN
          IF @Existencia > @Requiere SELECT @CantidadTomada = @Requiere ELSE SELECT @CantidadTomada = @Existencia
          IF @Temp = 1
            INSERT #SerieLoteMov (Sucursal, Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad)
                          VALUES (@Sucursal, @Empresa, @Modulo, @ID, @RenglonID, @Articulo, @SubCuenta, @SerieLote, @CantidadTomada/* /@Factor*/)
          ELSE
            INSERT SerieLoteMov (Sucursal, Empresa, Modulo, ID, RenglonID, Articulo, SubCuenta, SerieLote, Cantidad)
                         VALUES (@Sucursal, @Empresa, @Modulo, @ID, @RenglonID, @Articulo, @SubCuenta, @SerieLote, @CantidadTomada/* /@Factor*/)
          SELECT @Requiere = @Requiere - @CantidadTomada
        END
        FETCH NEXT FROM crSerieLoteMovAuto INTO @SerieLote, @Existencia
        IF @@ERROR <> 0 SELECT @Ok = 1
      END
      CLOSE crSerieLoteMovAuto
      DEALLOCATE crSerieLoteMovAuto
    END

   IF @MovTipo IN ('VTAS.N','VTAS.FM') AND (SELECT NotasBorrador FROM EmpresaCFG WHERE Empresa = @Empresa) = 1
      AND NOT EXISTS (SELECT * FROM SerieLoteMov WHERE Empresa = @Empresa AND Modulo = @Modulo AND ID = @ID AND RenglonID = @RenglonID AND Articulo  = @Articulo AND SubCuenta = @SubCuenta)
        SELECT @Ok = 20320

   IF @Modulo = 'INV' AND @MovTipo IN ('INV.SI','INV.T')
   BEGIN
		SELECT @CantidadSL = SUM(Cantidad)
		  FROM SerieLoteMov 
		 WHERE Modulo = @Modulo 
		   AND ID = @ID
		   AND RenglonID = @RenglonID
		   AND Articulo = @Articulo

		SELECT @CantidadMov = SUM(ISNULL(Cantidad,0)*ISNULL(Factor,1))
          FROM InvD 
          WHERE ID = @ID
            AND RenglonID = @RenglonID
            AND Articulo = @Articulo


		IF @CantidadSL <> @CantidadMov 
			SELECT @Ok = 20330, @OkRef = @Articulo + '. ' + ISNULL(@SubCuenta,'')

		IF @MovTipo IN ('INV.T')
		BEGIN
			IF EXISTS(SELECT * FROM Art WHERE Articulo = @Articulo AND Tipo IN ('Serie','Lote'))
			IF NOT EXISTS(SELECT * FROM SerieLoteMov WHERE Empresa = @Empresa AND @Modulo = @Modulo AND ID = @ID AND RenglonID = @RenglonID AND Articulo = @Articulo AND ISNULL(SubCuenta,'') = ISNULL(@SubCuenta,''))
			BEGIN
				SELECT @Ok = 20320, @OkRef = 'No Existen Números de Serie/Lote para el Artículo: '+@Articulo
			END
		END

   END

  RETURN
END  
GO

/**************** spSincroMovRegistro ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSincroMovRegistro') and type = 'P') drop procedure dbo.spSincroMovRegistro
GO
CREATE PROCEDURE spSincroMovRegistro
			@Modulo		char(5),
                        @ID		int
--//WITH ENCRYPTION
AS BEGIN
/*  DECLARE
    @SucursalPrincipal int,
    @OrigenTipo			varchar(10)

  EXEC spMovInfo @ID, @Modulo, @OrigenTipo = @OrigenTipo OUTPUT
  IF @OrigenTipo <> 'E/COLLAB'
  BEGIN
    SELECT @SucursalPrincipal = Sucursal FROM Version
    IF NOT EXISTS(SELECT * FROM SincroMovRegistro WHERE Sucursal = @SucursalPrincipal AND Modulo = @Modulo AND ID = @ID)
      INSERT SincroMovRegistro (Sucursal, Modulo, ID) VALUES (@SucursalPrincipal, @Modulo, @ID)
  END*/
  RETURN
END
GO

/* spSucursalEnLinea */ 
if exists (select * from sysobjects where id = object_id('dbo.spSucursalEnLinea') and type = 'P') drop procedure dbo.spSucursalEnLinea
GO
CREATE PROCEDURE spSucursalEnLinea
			@Sucursal	int,
			@EnLinea	bit OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE 
    @SucursalPrincipal int

  SELECT @EnLinea = 0
  SELECT @SucursalPrincipal = Sucursal FROM Version
  IF @Sucursal = @SucursalPrincipal OR @Sucursal IN (SELECT Sucursal FROM Sucursal WHERE EnLinea = 1 AND SucursalPrincipal = @SucursalPrincipal)
   SELECT @EnLinea = 1
END
GO

/* spSucursalMovSeguimiento */ 
if exists (select * from sysobjects where id = object_id('dbo.spSucursalMovSeguimiento') and type = 'P') drop procedure dbo.spSucursalMovSeguimiento
GO
CREATE PROCEDURE spSucursalMovSeguimiento
			@Sucursal	int,
			@Modulo		char(5),
			@Mov		char(20),
			@Seguimiento	char(20)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  SELECT @Seguimiento = NULL
  SELECT @Seguimiento = NULLIF(RTRIM(UPPER(Seguimiento)), '')
    FROM SucursalMovSeguimiento
   WHERE Sucursal = @Sucursal AND Modulo = @Modulo AND Mov = @Mov
  RETURN
END
GO

/************** spTablaAnual *************/
if exists (select * from sysobjects where id = object_id('dbo.spTablaAnual') and type = 'P') drop procedure dbo.spTablaAnual
GO
CREATE PROCEDURE spTablaAnual
                   @Tabla	varchar(50),
                   @Ejercicio	int,
		   @Periodo 	int,
		   @Error	bit,

		   @Importe 	float		OUTPUT,
                   @Ok		int		OUTPUT,
		   @OkRef	varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  SELECT @Importe = NULL
  SELECT @Importe = NULLIF(Importe, 0.0) 
    FROM TablaAnualD 
   WHERE TablaAnual = @Tabla 
     AND Ejercicio = @Ejercicio 
     AND Periodo = @Periodo

   IF @Importe IS NULL AND @Error = 1
     SELECT @Ok = 20500, @OkRef = 'Tabla: '+RTRIM(@Tabla)+', Ejercicio: '+LTRIM(Convert(char, @Ejercicio)) +', Periodo: '+LTRIM(Convert(char, @Periodo))
  RETURN
END
GO

if exists (select * from sysobjects where id = object_id('dbo.spTablaImpuesto') and type = 'P') drop procedure dbo.spTablaImpuesto
go
CREATE PROCEDURE spTablaImpuesto
  			@Tabla		varchar(50),
  			@Tabla2		varchar(50),
  			@PeriodoTipo	char(20),
  			@Importe	money,
  			@Impuesto	money	OUTPUT,
			@PorcentajeFijo	float	= NULL
--//WITH ENCRYPTION
AS BEGIN
DECLARE
  @QLimiteInferior	money,
  @LimiteInferior	money,
  @LimiteInferior2	money,
  @Cuota		money,
  @Cuota2		money,
  @Porcentaje		float,
  @Porcentaje2		float,
  @Excedente		money

  IF @PorcentajeFijo IS NOT NULL
    SELECT @Impuesto = @Importe * (@PorcentajeFijo/100.0)
  ELSE BEGIN
    SELECT @LimiteInferior = ISNULL(LimiteInferior, 0),
           @Cuota          = ISNULL(Cuota, 0),
           @Porcentaje     = ISNULL(Porcentaje, 0)
      FROM TablaImpuestoD
     WHERE TablaImpuesto = @Tabla AND PeriodoTipo = @PeriodoTipo
       AND @Importe BETWEEN LimiteInferior AND LimiteSuperior
    SELECT @Excedente = (@Importe - @LimiteInferior) * (@Porcentaje/100.0)
    SELECT @Impuesto = (@Cuota + @Excedente) 

--    EXEC xpTablaImpuesto @Tabla, @PeriodoTipo, @Importe, @Impuesto OUTPUT

    IF @Tabla2 IS NOT NULL
    BEGIN
      SELECT @LimiteInferior2 = ISNULL(LimiteInferior, 0),
             @Cuota2 	      = ISNULL(Cuota, 0),
             @Porcentaje2     = ISNULL(Porcentaje, 0)
        FROM TablaImpuestoD
       WHERE TablaImpuesto = @Tabla2 AND PeriodoTipo = @PeriodoTipo
         AND @Importe BETWEEN LimiteInferior AND LimiteSuperior

      IF (SELECT NomLimiteInferior2 FROM Version) = 1 SELECT @QLimiteInferior = @LimiteInferior2 ELSE SELECT @QLimiteInferior = @LimiteInferior
      SELECT @Impuesto = @Cuota + (((@Importe - @QLimiteInferior) * (@Porcentaje2/100.0))*(@Porcentaje/100.0))
    END
  END

  EXEC xpTablaImpuesto @Tabla, '(Sin Periodo)', @Importe, @Impuesto OUTPUT
  RETURN
END
go

/*
declare
  @importe   money,
  @impuestos money
exec spTablaImpuestoInversa 'ISAN', NULL, '(Sin Periodo)', 1000000, @Importe OUTPUT, @Impuestos OUTPUT
select @Importe, @Impuestos
*/

/**************** spTablaImpuestoInversa ****************/
if exists (select * from sysobjects where id = object_id('dbo.spTablaImpuestoInversa') and type = 'P') drop procedure dbo.spTablaImpuestoInversa
GO             
CREATE PROCEDURE spTablaImpuestoInversa
			@Tabla        	varchar(50),
			@Tabla2       	varchar(50),
			@PeriodoTipo  	char(20),
			@Total        	float,
			@Importe      	float      OUTPUT,
			@Impuesto     	float      OUTPUT,
			@TablaLujo    	varchar(50)        = NULL,
			@ImporteLujo    float              = NULL,
			@PorcentajeFijo float              = NULL

--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @ImpuestoLujo    	float,
    @Promedio        	float,
    @Dif       		float,
    @a                  int,
    @Veces              int

  SELECT @a = 0, @Veces = 200
  SELECT @Promedio = NULLIF(AVG(Porcentaje), 0)
    FROM TablaImpuestoD 
   WHERE TablaImpuesto = @Tabla AND PeriodoTipo = @PeriodoTipo

  SELECT @Importe = @Total/(1+(@Promedio/100.0))
  IF  @PorcentajeFijo IS NULL 
    EXEC spTablaImpuesto @Tabla, @Tabla2, @PeriodoTipo, @Importe, @Impuesto OUTPUT, @PorcentajeFijo
  ELSE 
    SELECT @Impuesto = @Importe * @PorcentajeFijo /100.0
  
  IF @TablaLujo IS NOT NULL AND @Importe > = @ImporteLujo
  BEGIN
    EXEC spTablaImpuesto @TablaLujo, NULL, @PeriodoTipo, @Importe, @ImpuestoLujo OUTPUT
    SELECT @Impuesto = @Impuesto - @ImpuestoLujo
  END

  WHILE (ROUND(@Importe + @Impuesto, 11) <> ROUND(@Total, 11)) AND (@a < @Veces)
  BEGIN
    SELECT @Dif = @Total - (@Importe + @Impuesto)
    SELECT @Importe = @Importe + @Dif / 2.0   
-- SELECT 'Total'=@Total,@total *1.15 , 'Importe'=@Importe, 'impuesto' = @Impuesto, 'Suma' = (@Importe + @Impuesto) * 1.15 ,  @Dif
    IF  @PorcentajeFijo IS NULL 
      EXEC spTablaImpuesto @Tabla, @Tabla2, @PeriodoTipo, @Importe, @Impuesto OUTPUT, @PorcentajeFijo
    ELSE 
      SELECT @Impuesto = @Importe * @PorcentajeFijo /100.0

    IF @TablaLujo IS NOT NULL AND @Importe>=@ImporteLujo
    BEGIN
      EXEC spTablaImpuesto @TablaLujo, NULL, @PeriodoTipo, @Importe, @ImpuestoLujo OUTPUT, @PorcentajeFijo
      SELECT @Impuesto = @Impuesto - @ImpuestoLujo
    END
    SELECT @a = @a + 1
  END
  RETURN
END
GO

/**************** spTablaNum ****************/
if exists (select * from sysobjects where id = object_id('dbo.spTablaNum') and type = 'P') drop procedure dbo.spTablaNum
GO             
CREATE PROCEDURE spTablaNum
			@Tabla	varchar(50),
			@Numero	money,
			@Valor	money	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Max money

  SELECT @Max = 0.0, @Valor = 0.0
  IF EXISTS(SELECT * FROM TablaNum WHERE TablaNum = @Tabla)
  BEGIN
    SELECT @Max = MIN(Numero) FROM TablaNumD WHERE TablaNum = @Tabla AND Numero >= @Numero
    SELECT @Valor = ISNULL(Valor, 0.0) FROM TablaNumD WHERE TablaNum = @Tabla AND Numero = @Max
  END
  SELECT @Valor = NULLIF(@Valor, 0.0)
  RETURN
END
GO

-- spVerTablaNum 'Factor', -1
/**************** spVerTablaNum ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVerTablaNum') and type = 'P') drop procedure dbo.spVerTablaNum
GO             
CREATE PROCEDURE spVerTablaNum
			@Tabla	varchar(50),
			@Numero	money
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Valor	money

  EXEC spTablaNum @Tabla, @Numero, @Valor OUTPUT
  SELECT "Valor" = @Valor
  RETURN
END
GO


/**************** spTablaRango ****************/
if exists (select * from sysobjects where id = object_id('dbo.spTablaRango') and type = 'P') drop procedure dbo.spTablaRango
GO             
CREATE PROCEDURE spTablaRango
			@Tabla	varchar(50),
			@Numero	money,
			@Valor	money	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Max money

  SELECT @Max = 0.0, @Valor = 0.0
  IF EXISTS(SELECT * FROM TablaRango WHERE TablaRango = @Tabla)
     SELECT @Valor = ISNULL(Valor, 0.0) FROM TablaRangoD WHERE TablaRango = @Tabla AND @Numero>NumeroD AND @Numero<=NumeroA
  RETURN
END
GO

-- spVerTablaRango 'Infonavit 20%', 3.5
--      select * FROM TablaRangoD WHERE TablaRango = 'Infonavit 20%' AND 3.5 >NumeroD AND 3.5 <= NumeroA

/**************** spVerTablaRango ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVerTablaRango') and type = 'P') drop procedure dbo.spVerTablaRango
GO             
CREATE PROCEDURE spVerTablaRango
			@Tabla	varchar(50),
			@Numero	money
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Valor	money

  EXEC spTablaRango @Tabla, @Numero, @Valor OUTPUT
  SELECT "Valor" = @Valor
  RETURN
END
GO


/**************** spTablaRangoSt ****************/
if exists (select * from sysobjects where id = object_id('dbo.spTablaRangoSt') and type = 'P') drop procedure dbo.spTablaRangoSt
GO             
CREATE PROCEDURE spTablaRangoSt
			@Tabla	varchar(50),
			@Numero	float,
			@Nombre	varchar(50) OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Max varchar(50)

  SELECT @Max = 0.0, @Nombre = ''
  IF EXISTS(SELECT * FROM TablaRangoSt WHERE TablaRangoSt = @Tabla)
     SELECT @Nombre = Nombre FROM TablaRangoStD WHERE TablaRangoSt = @Tabla AND @Numero>NumeroD AND @Numero<=NumeroA
  RETURN
END
GO

-- spVerTablaRangoSt 'Infonavit 20%', 3.5
--      select * FROM TablaRangoStD WHERE TablaRangoSt = 'Infonavit 20%' AND 3.5 >NumeroD AND 3.5 <= NumeroA

/**************** spVerTablaRangoSt ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVerTablaRangoSt') and type = 'P') drop procedure dbo.spVerTablaRangoSt
GO             
CREATE PROCEDURE spVerTablaRangoSt
			@Tabla	varchar(50),
			@Numero	float
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Nombre	varchar(50)

  EXEC spTablaRangoSt @Tabla, @Numero, @Nombre OUTPUT
  SELECT "Nombre" = @Nombre
  RETURN
END
GO

/************** spTransferirConsignacion ***************/
if exists (select * from sysobjects where id = object_id('dbo.spTransferirConsignacion') and type = 'P') drop procedure dbo.spTransferirConsignacion
GO
CREATE PROCEDURE spTransferirConsignacion
		    	@Empresa		char(5), 
	           	@Articulo		char(20),
	           	@SubCuenta		varchar(50),
	           	@Almacen		char(10),
	           	@AlmacenDestino		char(10),
			@Cantidad		float,

   		   	@Ok                	int          OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE
    @ID			int,
    @Renglon		float,
    @RenglonSub 	int,
    @Requiere   	float,
    @Obtenido		float,
--    @PendienteDif	float,
    @Pendiente		float

  SELECT @Requiere = @Cantidad, @SubCuenta = NULLIF(RTRIM(@SubCuenta), '')
  DECLARE crTransferirConsig CURSOR
    FOR SELECT CompraD.ID, CompraD.Renglon, CompraD.RenglonSub, ISNULL(CompraD.CantidadPendiente, 0.0)
          FROM CompraD, Compra, MovTipo
         WHERE Compra.Estatus = 'PENDIENTE'
           AND MovTipo.Mov = Compra.Mov
           AND MovTipo.Clave = 'COMS.CC'
	   AND CompraD.ID = Compra.ID
           AND CompraD.Almacen = @Almacen
	   AND CompraD.Articulo = @Articulo
	   AND CompraD.SubCuenta = @SubCuenta
	   AND CompraD.CantidadPendiente > 0.0
         ORDER BY CompraD.ID, CompraD.Renglon, CompraD.RenglonSub

  OPEN crTransferirConsig
  FETCH NEXT FROM crTransferirConsig INTO @ID, @Renglon, @RenglonSub, @Pendiente
  IF @@ERROR <> 0 SELECT @Ok = 1
  WHILE @@FETCH_STATUS <> -1 AND @Ok IS NULL AND @Requiere > 0
  BEGIN
    IF @@FETCH_STATUS <> -2 
    BEGIN
      IF @Requiere < @Pendiente
      BEGIN
        -- Si Alcanza 
        SELECT @Obtenido = @Requiere	

        --BUG17456
        UPDATE CompraD SET Cantidad = Cantidad - @Obtenido, CantidadPendiente = CantidadPendiente - @Obtenido, CantidadInventario = (Cantidad - @Obtenido)*Factor WHERE CURRENT OF crTransferirConsig
        IF @@ERROR <> 0 SELECT @Ok = 1

        SELECT * INTO #CompraDetalle FROM cCompraD WHERE ID = @ID AND Renglon = @Renglon AND RenglonSub = @RenglonSub 
        IF @@ERROR <> 0 SELECT @Ok = 1

        SELECT @RenglonSub = MAX(RenglonSub)+1 FROM CompraD WHERE ID = @ID AND Renglon = @Renglon
        IF @@ERROR <> 0 SELECT @Ok = 1

        --BUG17456
        UPDATE #CompraDetalle SET Cantidad = @Obtenido, CantidadPendiente = @Obtenido, Almacen = @AlmacenDestino, RenglonSub = @RenglonSub, CantidadInventario = @Obtenido * Factor, AplicaRenglon = @Renglon
        IF @@ERROR <> 0 SELECT @Ok = 1

        -- Actualizar Descuento Importe
	UPDATE #CompraDetalle SET DescuentoImporte = (Cantidad*Costo)*(DescuentoLinea/100.0)
        IF @@ERROR <> 0 SELECT @Ok = 1

        INSERT INTO cCompraD SELECT * FROM #CompraDetalle
        IF @@ERROR <> 0 SELECT @Ok = 1
      END ELSE
      BEGIN
        -- No Alcanza (toma toda la linea)
        SELECT @Obtenido = @Pendiente	

        UPDATE CompraD SET Almacen = @AlmacenDestino WHERE CURRENT OF crTransferirConsig
        IF @@ERROR <> 0 SELECT @Ok = 1
      END
      SELECT @Requiere = @Requiere - @Obtenido
    END
    IF @Requiere > 0
      FETCH NEXT FROM crTransferirConsig INTO @ID, @Renglon, @RenglonSub, @Pendiente
    IF @@ERROR <> 0 SELECT @Ok = 1
  END
  CLOSE crTransferirConsig
  DEALLOCATE crTransferirConsig
  IF @Requiere > 0 AND @Ok IS NULL 
    SELECT @Ok = 30130
END
GO

/*
declare
  @factor	float
exec spUnidadFactor 'DEMO', 'A1', NULL, 'Kg', @factor output
select @factor
*/
/**************** spUnidadFactor ****************/
if exists (select * from sysobjects where id = object_id('dbo.spUnidadFactor') and type = 'P') drop procedure dbo.spUnidadFactor
GO             
CREATE PROCEDURE spUnidadFactor
			@Empresa	char(5),
			@Articulo	char(20), 
			@SubCuenta	varchar(50), 
			@Unidad		varchar(50), 
			@Factor 	float		= NULL OUTPUT, 
			@Decimales	int		= NULL OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @CfgMultiUnidades	        bit,
    @CfgMultiUnidadesNivel      char(20)

  SELECT @CfgMultiUnidades         = MultiUnidades,
	 @CfgMultiUnidadesNivel    = ISNULL(UPPER(NivelFactorMultiUnidad), 'UNIDAD')
    FROM EmpresaCfg2 
   WHERE Empresa = @Empresa

  IF @CfgMultiUnidades = 1
  BEGIN
    IF @CfgMultiUnidadesNivel = 'ARTICULO'
      EXEC xpArtUnidadFactor @Articulo, @SubCuenta, @Unidad, @Factor OUTPUT, @Decimales OUTPUT, NULL
    ELSE
      EXEC xpUnidadFactor @Articulo, @SubCuenta, @Unidad, @Factor OUTPUT, @Decimales OUTPUT
  END
  RETURN
END
GO

/**************** spValidarAgrupador ****************/
if exists (select * from sysobjects where id = object_id('dbo.spValidarAgrupador') and type = 'P') drop procedure dbo.spValidarAgrupador
GO
CREATE PROCEDURE spValidarAgrupador
			@Empresa	char(5),
			@Modulo		char(5),
			@Agrupador	varchar(50)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Resultado		varchar(50),
    @AgrupadorArt	varchar(20),
    @AgrupadorPersonal 	varchar(20)

  SELECT @Resultado = NULL
  SELECT @AgrupadorArt      = BPlanAgrupadorArt,
         @AgrupadorPersonal = BPlanAgrupadorPersonal
    FROM EmpresaGral
   WHERE Empresa = @Empresa

  IF @Modulo IN ('VTAS', 'COMS')
  BEGIN
    IF @AgrupadorArt = 'Categoria'  SELECT @Resultado = Categoria  FROM ArtCat     WHERE Categoria  = @Agrupador ELSE
    IF @AgrupadorArt = 'Grupo'      SELECT @Resultado = Grupo      FROM ArtGrupo   WHERE Grupo      = @Agrupador ELSE
    IF @AgrupadorArt = 'Familia'    SELECT @Resultado = Familia    FROM ArtFam     WHERE Familia    = @Agrupador ELSE
    IF @AgrupadorArt = 'Linea'      SELECT @Resultado = Linea      FROM ArtLinea   WHERE Linea      = @Agrupador ELSE
    IF @AgrupadorArt = 'Fabricante' SELECT @Resultado = Fabricante FROM Fabricante WHERE Fabricante = @Agrupador
  END ELSE
  IF @Modulo = 'NOM'
  BEGIN
    IF @AgrupadorArt = 'Categoria'    SELECT @Resultado = Categoria    FROM PersonalCat   WHERE Categoria    = @Agrupador ELSE
    IF @AgrupadorArt = 'Grupo'        SELECT @Resultado = Grupo        FROM PersonalGrupo WHERE Grupo        = @Agrupador ELSE
    IF @AgrupadorArt = 'Departamento' SELECT @Resultado = Departamento FROM Departamento  WHERE Departamento = @Agrupador ELSE
    IF @AgrupadorArt = 'Puesto'       SELECT @Resultado = Puesto       FROM Puesto        WHERE Puesto       = @Agrupador
  END ELSE
  SELECT @Resultado = Clase FROM Clase WHERE Modulo = @Modulo AND Clase = @Agrupador

  SELECT 'Validacion' = @Resultado
  RETURN
END
GO 

/**************** spValidarContactoTipo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spValidarContactoTipo') and type = 'P') drop procedure dbo.spValidarContactoTipo
GO
CREATE PROCEDURE spValidarContactoTipo
			@ContactoTipo	varchar(20),
			@Contacto	char(10)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Estatus varchar(15)

  SELECT @Estatus = NULL
  IF @ContactoTipo = 'Cliente'   SELECT @Estatus = Estatus FROM Cte      WHERE Cliente   = @Contacto ELSE
  IF @ContactoTipo = 'Proveedor' SELECT @Estatus = Estatus FROM Prov     WHERE Proveedor = @Contacto ELSE
  IF @ContactoTipo = 'Personal'  SELECT @Estatus = Estatus FROM Personal WHERE Personal  = @Contacto ELSE
  IF @ContactoTipo = 'Agente'    SELECT @Estatus = Estatus FROM Agente   WHERE Agente    = @Contacto ELSE
  IF @ContactoTipo = 'Almacen'   SELECT @Estatus = Estatus FROM Alm      WHERE Almacen   = @Contacto 
  SELECT 'Estatus' = @Estatus
  RETURN
END
GO 


-- 'CORTE'
/**************** spValidarCuentaTipo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spValidarCuentaTipo') and type = 'P') drop procedure dbo.spValidarCuentaTipo
GO
CREATE PROCEDURE spValidarCuentaTipo
			@CuentaTipo		varchar(20),
			@Cuenta			char(10)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Estatus varchar(15)

  SELECT @Estatus = NULL
  IF @CuentaTipo = 'Cliente'   SELECT @Estatus = Estatus FROM Cte      WHERE Cliente   = @Cuenta ELSE
  IF @CuentaTipo = 'Proveedor' SELECT @Estatus = Estatus FROM Prov     WHERE Proveedor = @Cuenta ELSE
  IF @CuentaTipo = 'Personal'  SELECT @Estatus = Estatus FROM Personal WHERE Personal  = @Cuenta ELSE
  IF @CuentaTipo = 'Agente'    SELECT @Estatus = Estatus FROM Agente   WHERE Agente    = @Cuenta ELSE
  IF @CuentaTipo = 'Almacen'   SELECT @Estatus = Estatus FROM Alm      WHERE Almacen   = @Cuenta ELSE
  IF @CuentaTipo = 'Articulo'  SELECT @Estatus = Estatus FROM Art      WHERE Articulo  = @Cuenta
  
  SELECT 'Estatus' = @Estatus
  RETURN
END
GO 

/************** spValidarMovImporteMaximo *************/
if exists (select * from sysobjects where id = object_id('dbo.spValidarMovImporteMaximo') and sysstat & 0xf = 4) drop procedure dbo.spValidarMovImporteMaximo
GO
CREATE PROCEDURE spValidarMovImporteMaximo
			@Usuario	char(10),
		   	@Modulo		char(5),
			@Mov		char(20),
			@ID		int,
			@Ok		int		OUTPUT,
			@OkRef		varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  IF @Modulo NOT IN ('VTAS', 'COMS', 'CXC', 'CXP', 'DIN', 'GAS') RETURN
  DECLARE
    @Importe			money,
    @NoDeducible		money,
    @ImporteMaximo		money,
    @NoDeducibleMaximo		money,
    @DescuentoMN		money,
    @Descuento			float,
    @DescuentoMaximo		money,
    @DescuentoGlobalMaximo	float,
    @DescuentoLineaMaximo	float

  SELECT @ImporteMaximo = NULL, @NoDeducibleMaximo = NULL
  SELECT @ImporteMaximo = NULLIF(ImporteMaximo, 0.0),
         @NoDeducibleMaximo = NULLIF(NoDeducibleMaximo, 0.0),
         @DescuentoMaximo = NULLIF(DescuentoMaximo, 0.0),
         @DescuentoGlobalMaximo = NULLIF(DescuentoGlobalMaximo, 0.0),
         @DescuentoLineaMaximo = NULLIF(DescuentoLineaMaximo, 0.0)
    FROM UsuarioMovImporteMaximo 
   WHERE Usuario = @Usuario AND Modulo = @Modulo AND Mov = @Mov

  IF @ImporteMaximo IS NOT NULL
  BEGIN
    IF @Modulo = 'VTAS' SELECT @Importe = SUM(ImporteTotal*TipoCambio) FROM VentaTCalc         WHERE ID = @ID ELSE
    IF @Modulo = 'COMS' SELECT @Importe = SUM(ImporteTotal*TipoCambio) FROM CompraTCalc        WHERE ID = @ID ELSE
    IF @Modulo = 'CXC'  SELECT @Importe = (ISNULL(Importe, 0)+ISNULL(Impuestos, 0))*TipoCambio FROM Cxc    WHERE ID = @ID ELSE
    IF @Modulo = 'CXP'  SELECT @Importe = (ISNULL(Importe, 0)+ISNULL(Impuestos, 0))*TipoCambio FROM Cxp    WHERE ID = @ID ELSE
    IF @Modulo = 'DIN'  SELECT @Importe = (ISNULL(Importe, 0)+ISNULL(Impuestos, 0))*TipoCambio FROM Dinero WHERE ID = @ID ELSE
    IF @Modulo = 'GAS'
    BEGIN
      SELECT @Importe = SUM(TotalLinea*TipoCambio),
             @NoDeducible = SUM(TotalLinea*TipoCambio*(100-ISNULL(PorcentajeDeducible, 0.0))/100.0)    
        FROM GastoT WHERE ID = @ID
      IF @NoDeducible IS NOT NULL AND @NoDeducible > @NoDeducibleMaximo SELECT @Ok = 20016, @OkRef = CONVERT(varchar, @NoDeducibleMaximo)
    END
    IF ISNULL(@Importe, 0.0) > @ImporteMaximo SELECT @Ok = 20014, @OkRef = CONVERT(varchar, @ImporteMaximo)
  END
  IF @Modulo IN ('VTAS', 'COMS') 
  BEGIN
    IF @DescuentoMaximo IS NOT NULL AND @Ok IS NULL 
    BEGIN
      SELECT @DescuentoMN = 0.0
      IF @Modulo = 'VTAS' SELECT @DescuentoMN = SUM(DescuentosTotales) FROM VentaTCalc  WHERE ID = @ID ELSE
      IF @Modulo = 'COMS' SELECT @DescuentoMN = SUM(DescuentosTotales) FROM CompraTCalc WHERE ID = @ID 
      IF ISNULL(@DescuentoMN, 0.0) > @DescuentoMaximo SELECT @Ok = 20019, @OkRef = CONVERT(varchar, @DescuentoMaximo)
    END
    IF @DescuentoGlobalMaximo IS NOT NULL AND @Ok IS NULL 
    BEGIN
      SELECT @Descuento = 0.0
      IF @Modulo = 'VTAS' SELECT @Descuento = DescuentoGlobal FROM Venta  WHERE ID = @ID ELSE
      IF @Modulo = 'COMS' SELECT @Descuento = DescuentoGlobal FROM Compra WHERE ID = @ID 
      IF ISNULL(@Descuento, 0.0) > @DescuentoGlobalMaximo SELECT @Ok = 20017, @OkRef = CONVERT(varchar, @DescuentoGlobalMaximo)
    END
    IF @DescuentoLineaMaximo IS NOT NULL AND @Ok IS NULL
    BEGIN
      SELECT @Descuento = 0.0
      IF @Modulo = 'VTAS' SELECT @Descuento = MAX(DescuentoLinea) FROM VentaD  WHERE ID = @ID ELSE
      IF @Modulo = 'COMS' SELECT @Descuento = MAX(DescuentoLinea) FROM CompraD WHERE ID = @ID 
      IF ISNULL(@Descuento, 0.0) > @DescuentoLineaMaximo SELECT @Ok = 20018, @OkRef = CONVERT(varchar, @DescuentoLineaMaximo)
    END
  END
  RETURN
END
GO

/**************** spVentaCobroTotal ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVentaCobroTotal') and type = 'P') drop procedure dbo.spVentaCobroTotal
GO             
CREATE PROCEDURE spVentaCobroTotal
		   @FormaCobro1		varchar(50),
		   @FormaCobro2 	varchar(50),
		   @FormaCobro3 	varchar(50),   
		   @FormaCobro4 	varchar(50),
		   @FormaCobro5 	varchar(50),
		   @Importe1		money,
		   @Importe2		money,
		   @Importe3		money,
		   @Importe4		money,
		   @Importe5		money,
		   @Total		money	OUTPUT,
		   @VerResultado	bit	 = 0,
		   @Moneda		char(10) = NULL,
		   @TipoCambio		float    = 1.0
--//WITH ENCRYPTION
AS BEGIN
  EXEC spFormaPagoTC @FormaCobro1, @Importe1 OUTPUT, @Moneda, @TipoCambio
  EXEC spFormaPagoTC @FormaCobro2, @Importe2 OUTPUT, @Moneda, @TipoCambio
  EXEC spFormaPagoTC @FormaCobro3, @Importe3 OUTPUT, @Moneda, @TipoCambio
  EXEC spFormaPagoTC @FormaCobro4, @Importe4 OUTPUT, @Moneda, @TipoCambio
  EXEC spFormaPagoTC @FormaCobro5, @Importe5 OUTPUT, @Moneda, @TipoCambio

  SELECT @Total = (@Importe1 + @Importe2 + @Importe3 + @Importe4 + @Importe5) / @TipoCambio
  IF @VerResultado = 1 SELECT "Total" = @Total
  RETURN
END
GO

-- spVerBPlanAgrupador 'DEMO', 'VTAS'
/**************** spVerBPlanAgrupador ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVerBPlanAgrupador') and type = 'P') drop procedure dbo.spVerBPlanAgrupador
GO
CREATE PROCEDURE spVerBPlanAgrupador
			@Empresa	char(5),
			@Modulo		char(5)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @AgrupadorArt	varchar(20),
    @AgrupadorPersonal 	varchar(20)

  SELECT @AgrupadorArt      = BPlanAgrupadorArt,
         @AgrupadorPersonal = BPlanAgrupadorPersonal
    FROM EmpresaGral
   WHERE Empresa = @Empresa

  IF @Modulo IN ('VTAS', 'COMS')
  BEGIN
    IF @AgrupadorArt = 'Categoria'  SELECT 'Agrupador' = CONVERT(varchar(50), Categoria)  FROM ArtCat   ELSE
    IF @AgrupadorArt = 'Grupo'      SELECT 'Agrupador' = CONVERT(varchar(50), Grupo)      FROM ArtGrupo ELSE
    IF @AgrupadorArt = 'Familia'    SELECT 'Agrupador' = CONVERT(varchar(50), Familia)    FROM ArtFam   ELSE
    IF @AgrupadorArt = 'Linea'      SELECT 'Agrupador' = CONVERT(varchar(50), Linea)      FROM ArtLinea ELSE
    IF @AgrupadorArt = 'Fabricante' SELECT 'Agrupador' = CONVERT(varchar(50), Fabricante) FROM Fabricante
  END ELSE
  IF @Modulo = 'NOM'
  BEGIN
    IF @AgrupadorArt = 'Categoria'    SELECT 'Agrupador' = CONVERT(varchar(50), Categoria)    FROM PersonalCat   ELSE
    IF @AgrupadorArt = 'Grupo'        SELECT 'Agrupador' = CONVERT(varchar(50), Grupo)        FROM PersonalGrupo ELSE
    IF @AgrupadorArt = 'Departamento' SELECT 'Agrupador' = CONVERT(varchar(50), Departamento) FROM Departamento  ELSE
    IF @AgrupadorArt = 'Puesto'       SELECT 'Agrupador' = CONVERT(varchar(50), Puesto)       FROM Puesto
  END ELSE
  SELECT 'Agrupador' = CONVERT(varchar(40), Clase) FROM Clase WHERE Modulo = @Modulo

  RETURN
END
GO 

-- spVerCuentaTipo ''
-- 'CORTE'
/**************** spVerCuentaTipo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVerCuentaTipo') and type = 'P') drop procedure dbo.spVerCuentaTipo
GO
CREATE PROCEDURE spVerCuentaTipo
			@CuentaTipo		varchar(20)
--//WITH ENCRYPTION
AS BEGIN
  IF @CuentaTipo = 'Cliente'   SELECT 'Clave' = CONVERT(char(20), Cliente),   'Nombre' = convert(varchar(100), Nombre)		FROM Cte      ELSE
  IF @CuentaTipo = 'Proveedor' SELECT 'Clave' = CONVERT(char(20), Proveedor), 'Nombre' = convert(varchar(100), Nombre)		FROM Prov     ELSE
  IF @CuentaTipo = 'Personal'  SELECT 'Clave' = CONVERT(char(20), Personal),  'Nombre' = convert(varchar(100), RTRIM(Nombre+' '+ApellidoPaterno+' '+ApellidoMaterno))  FROM Personal ELSE
  IF @CuentaTipo = 'Agente'    SELECT 'Clave' = CONVERT(char(20), Agente),    'Nombre' = convert(varchar(100), Nombre)		FROM Agente   ELSE
  IF @CuentaTipo = 'Almacen'   SELECT 'Clave' = CONVERT(char(20), Almacen),   'Nombre' = convert(varchar(100), Nombre)		FROM Alm   ELSE
  IF @CuentaTipo = 'Articulo'  SELECT 'Clave' = CONVERT(char(20), Articulo),   'Nombre' = convert(varchar(100), Descripcion1) FROM Art
  ELSE SELECT CONVERT(char(20), NULL), CONVERT(varchar(100), NULL)
  RETURN
END
GO 

-- spVerContactoTipo ''
/**************** spVerContactoTipo ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVerContactoTipo') and type = 'P') drop procedure dbo.spVerContactoTipo
GO
CREATE PROCEDURE spVerContactoTipo
			@ContactoTipo	varchar(20)
--//WITH ENCRYPTION
AS BEGIN
  IF @ContactoTipo = 'Cliente'   SELECT 'Clave' = CONVERT(char(10), Cliente),   'Nombre' = convert(varchar(100), Nombre)   FROM Cte      ELSE
  IF @ContactoTipo = 'Proveedor' SELECT 'Clave' = CONVERT(char(10), Proveedor), 'Nombre' = convert(varchar(100), Nombre) FROM Prov     ELSE
  IF @ContactoTipo = 'Personal'  SELECT 'Clave' = CONVERT(char(10), Personal),  'Nombre' = convert(varchar(100), RTRIM(Nombre+' '+ApellidoPaterno+' '+ApellidoMaterno))  FROM Personal ELSE
  IF @ContactoTipo = 'Agente'    SELECT 'Clave' = CONVERT(char(10), Agente),    'Nombre' = convert(varchar(100), Nombre)    FROM Agente   ELSE
  IF @ContactoTipo = 'Almacen'   SELECT 'Clave' = CONVERT(char(10), Almacen),   'Nombre' = convert(varchar(100), Nombre)   FROM Alm      
  ELSE SELECT CONVERT(char(10), NULL), CONVERT(varchar(100), NULL)
  RETURN
END
GO 

/************** spMovTipoCFD *************/
if exists (select * from sysobjects where id = object_id('dbo.spMovTipoCFD') and type = 'P') drop procedure dbo.spMovTipoCFD
GO
CREATE PROCEDURE spMovTipoCFD
				@Empresa				varchar(5),
				@Modulo					varchar(5),
				@Mov					varchar(20),
				@CFD					bit		OUTPUT,
				@CFDFlex				bit = NULL OUTPUT --Cambio CFD Flexible
				
--//WITH ENCRYPTION
AS BEGIN
  SELECT @CFD = 0
  IF ((SELECT CFD FROM Empresa WHERE Empresa = @Empresa) = 1) OR ((SELECT CFDFlex FROM EmpresaGral WHERE Empresa = @Empresa) = 1 AND (SELECT eDoc FROM EmpresaGral WHERE Empresa = @Empresa) = 1)
  BEGIN --Cambio CFD Flexible
    SELECT @CFD = CASE WHEN (SELECT ISNULL(CFD, 0) FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov) = 1 OR (SELECT ISNULL(CFDFlex, 0) FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov) = 1 THEN 1 ELSE 0 END
    SELECT @CFDFlex = CASE WHEN (SELECT ISNULL(CFDFlex, 0) FROM MovTipo WHERE Modulo = @Modulo AND Mov = @Mov) = 1 THEN 1 ELSE 0 END --Cambio CFD Flexible        
  END --Cambio CFD Flexible

  EXEC xpMovTipoCFD @Empresa, @Modulo, @Mov, @CFD OUTPUT, @CFDFlex OUTPUT --Cambio CFD Flexible
  RETURN 
END
GO

/************** spVerMovTipoCFD *************/
if exists (select * from sysobjects where id = object_id('dbo.spVerMovTipoCFD') and type = 'P') drop procedure dbo.spVerMovTipoCFD
GO
CREATE PROCEDURE spVerMovTipoCFD
               @Empresa     varchar(5),
               @Modulo  varchar(5),
               @Mov           varchar(20),
               @ID          int = NULL
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @CFD                     bit,
    @Timbrado                bit, 
    @VersionCFD              varchar(10),
    @UUID                    varchar(50),
    @SelloSAT                varchar(max),
    @TFDCadenaOriginal       varchar(max),
    @Sello                   varchar(max),
    @CFDI                    bit,
	@Estatus                 varchar(20)


  EXEC spMovInfo @ID = @ID OUTPUT, @Modulo = @Modulo, @Estatus = @Estatus OUTPUT

  SELECT @CFD = 0
  EXEC spMovTipoCFD @Empresa, @Modulo, @Mov, @CFD OUTPUT

  SELECT @CFDI = CFDI FROM EmpresaGral WHERE Empresa = @Empresa

  IF @CFD = 1 AND @Estatus <> 'CANCELADO'
  BEGIN

    IF EXISTS (SELECT * FROM CFD WHERE Modulo = @Modulo AND ModuloID = @ID)
    BEGIN
      SELECT @VersionCFD               = Substring(CadenaOriginal, 3, 3),
             @Timbrado                   = Timbrado,
             @UUID                             = UUID,
             @SelloSAT                   = SelloSAT,
             @TFDCadenaOriginal    = TFDCadenaOriginal,
             @Sello = Sello
        FROM CFD WHERE Modulo = @Modulo AND ModuloID = @ID

      IF NULLIF(@VersionCFD,'') IS NULL OR ISNUMERIC(@VersionCFD)= 0 
      SELECT @VersionCFD = Version FROM EmpresaCFD WHERE Empresa = @Empresa     
        
      IF @VersionCFD  >= '3.2' OR @CFDI = 1
      BEGIN
        IF @UUID IS NOT NULL OR @SelloSAT IS NOT NULL --OR @TFDCadenaOriginal IS NOT NULL
          SELECT @CFD = 0
      END
      ELSE IF NULLIF(@Sello,'') IS NOT NULL SELECT @CFD = 0
    END

    IF @VersionCFD  >= '3.2' OR @CFDI = 1
    BEGIN
      IF EXISTS (SELECT * FROM MovTipo mt 
                          JOIN MovFlujo mf ON mf.OModulo = mt.Modulo AND mf.OMov = mt.Mov
                          JOIN CFD cfd ON cfd.Modulo = mt.Modulo AND ModuloID = mf.OID AND (NULLIF(cfd.SelloSAT,'') IS NOT NULL OR cfd.Timbrado = 1 OR cfd.UUID IS NOT NULL)
                         WHERE mt.ConsecutivoModulo = @Modulo AND mt.ConsecutivoMov = @Mov AND mt.Modulo != @Modulo AND mt.Mov != @Mov
                           AND mf.DID = @ID AND mf.DModulo = @Modulo)
        SELECT @CFD = 0
    END ELSE 
    BEGIN 
      IF EXISTS (SELECT * FROM MovTipo mt 
                          JOIN MovFlujo mf ON mf.OModulo = mt.Modulo AND mf.OMov = mt.Mov
                          JOIN CFD cfd ON cfd.Modulo = mt.Modulo AND ModuloID = mf.OID AND NULLIF(cfd.Sello,'') IS NOT NULL  
                         WHERE mt.ConsecutivoModulo = @Modulo AND mt.ConsecutivoMov = @Mov AND mt.Modulo != @Modulo AND mt.Mov != @Mov
                           AND mf.DID = @ID AND mf.DModulo = @Modulo)
        SELECT @CFD = 0
    END     
  END

  SELECT 'CFD' = @CFD

  RETURN 
END
GO

/**************** spVerPersonalCosto ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVerPersonalCosto') and type = 'P') drop procedure dbo.spVerPersonalCosto
GO             
CREATE PROCEDURE spVerPersonalCosto 
			@Personal        char(20),
                        @TipoCambio      float,
                        @FechaEmision    datetime = NULL
--//WITH ENCRYPTION
AS BEGIN
  DECLARE 
    @Dias     	int, 
    @DiasLibres int,
    @Anio     	int,
    @Mes      	int,
    @FechaIni 	datetime,
    @FechaFin 	datetime, 
    @Jornada  	varchar(20),
    @Costo1   	float,
    @Costo2   	float,
    @Costo3   	float

  IF @FechaEmision IS NULL SELECT @FechaEmision = GETDATE()

  SELECT @Anio    = YEAR(@FechaEmision), @Mes = MONTH(@FechaEmision)
  SELECT @Jornada = Jornada FROM Personal WHERE Personal = @Personal
  EXEC spDiasMes @Mes, @Anio, @Dias OUTPUT

  EXEC spIntToDateTime 1,     @Mes, @Anio, @FechaIni OUTPUT
  EXEC spIntToDateTime @Dias, @Mes, @Anio, @FechaFin OUTPUT
  EXEC spJornadaDiasLibres @Jornada, @FechaIni, @FechaFin, @DiasLibres OUTPUT
  
  SELECT @Costo1 = SUM(CASE WHEN d.Concepto = 'Credito al Salario' 
                             THEN -1  
                             ELSE 1 
                         END * d.Importe * m.TipoCambio / j.HorasPromedio) / (@Dias - @DiasLibres) / @TipoCambio
    FROM Nomina   n
    JOIN NominaD  d ON d.ID       = n.ID 
    JOIN Personal p ON p.Personal = d.Personal 
    JOIN Jornada  j ON j.Jornada  = p.Jornada
    JOIN Mon      m ON m.Moneda   = n.Moneda
   WHERE d.Concepto IN ('Total Percepciones', 
                        'Impuesto Estatal', 
                        'IMSS Patron', 
                        'Infonavit', 
                        'Retiro y Cesantia', 
                        'Credito al Salario') 
     AND n.Estatus  =   'CONCLUIDO'
     AND d.Personal =   @Personal
     AND n.FechaD       BETWEEN @FechaIni AND @FechaFin

  SELECT @FechaIni = DATEADD(m,-1,@FechaIni) 
  SELECT @Anio     = YEAR(@FechaIni), @Mes = MONTH(@FechaIni)
  EXEC spDiasMes @Mes, @Anio, @Dias OUTPUT
  EXEC spIntToDateTime @Dias, @Mes, @Anio, @FechaFin OUTPUT
  EXEC spJornadaDiasLibres @Jornada, @FechaIni, @FechaFin, @DiasLibres OUTPUT

  SELECT @Costo2 = SUM(CASE WHEN d.Concepto = 'Credito al Salario' 
                             THEN -1  
                             ELSE 1 
                         END * d.Importe * m.TipoCambio / j.HorasPromedio) / (@Dias - @DiasLibres) / @TipoCambio
    FROM Nomina   n
    JOIN NominaD  d ON d.ID       = n.ID 
    JOIN Personal p ON p.Personal = d.Personal 
    JOIN Jornada  j ON j.Jornada  = p.Jornada
    JOIN Mon      m ON m.Moneda   = n.Moneda
   WHERE d.Concepto IN ('Total Percepciones', 
                        'Impuesto Estatal', 
                        'IMSS Patron', 
                        'Infonavit', 
                        'Retiro y Cesantia', 
                        'Credito al Salario') 
     AND n.Estatus  =   'CONCLUIDO'
     AND d.Personal =   @Personal
     AND n.FechaD       BETWEEN @FechaIni AND @FechaFin

  SELECT @Costo3 = (SUM(p.SueldoDiario * m.TipoCambio / j.HorasPromedio) / @TipoCambio ) * 1.25
    FROM Personal p
    JOIN Jornada  j ON j.Jornada = p.Jornada
    JOIN Mon      m ON m.Moneda  = p.Moneda
   WHERE p.Personal = @Personal

  IF @Costo1 >= @Costo2 AND @Costo1 >= @Costo3 
    SELECT "Costo" = @Costo1
  ELSE
    IF @Costo2 >= @Costo3 AND @Costo2 >= @Costo1 
      SELECT "Costo" = @Costo2
    ELSE
      SELECT "Costo" = @Costo3

  RETURN
END
GO

/*
declare
  @TasaDiaria 	float, 
  @Ok 		int,
  @OkRef	varchar(255)

EXEC spVerTasaDiaria 'TIIE', '14/5/4', @TasaDiaria OUTPUT, @Ok OUTPUT, @OkRef OUTPUT
SELECT @TasaDiaria*100
*/
/**************** spVerTasaDiaria ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVerTasaDiaria') and type = 'P') drop procedure dbo.spVerTasaDiaria
GO             
CREATE PROCEDURE spVerTasaDiaria
			@Tasa		varchar(50), 
			@Fecha		datetime, 
			@TasaDiaria 	float 		OUTPUT, 
			@Ok 		int		OUTPUT,
			@OkRef		varchar(255)	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  SELECT @TasaDiaria = NULL
  SELECT @TasaDiaria = d.Porcentaje/NULLIF(t.Dias, 0) 
    FROM Tasa t, TasaD d
   WHERE t.Tasa = @Tasa 
     AND d.Tasa = t.Tasa AND d.Fecha = @Fecha

  IF @TasaDiaria IS NULL
    SELECT @Ok = 10360, @OkRef = @Tasa+' '+CONVERT(varchar, @Fecha, 103)
  RETURN
END
GO

/**************** fnTipoImpuestoRegla ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnTipoImpuestoRegla') DROP FUNCTION fnTipoImpuestoRegla
GO
CREATE FUNCTION fnTipoImpuestoRegla (@TipoImpuesto varchar(10), @Fecha datetime, @Modulo varchar(5), @ID int, @Mov varchar(20), @CriterioEmpresa varchar(30), @CriterioCliente varchar(30), @CriterioProveedor varchar(30), @RegimenEmpresa varchar(30), @ZonaEmpresa varchar(30), @RegimenSucursal varchar(30), @ZonaSucursal varchar(30), @RegimenCliente varchar(30), @ZonaCliente varchar(30), @RegimenClienteEnviarA varchar(30), @ZonaClienteEnviarA varchar(30), @RegimenProveedor varchar(30), @ZonaProveedor varchar(30))
RETURNS varchar(10)
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @Resultado			varchar(10),
    @ReglaID			int, 
    @ReglaModulo		varchar(5),
    @ReglaMov			varchar(20),
    @ReglaRegimenEmpresa	varchar(30), 
    @ReglaRegimenCliente	varchar(30), 
    @ReglaRegimenProveedor	varchar(30), 
    @ReglaZonaEmpresa		varchar(30), 
    @ReglaZonaCliente		varchar(30), 
    @ReglaZonaProveedor		varchar(30),     
    @TipoImpuestoNuevo		varchar(10),
    @Tipo					varchar(20)

  --MEJORA4769 (Se hicieron cambios masivos en este procedimiento)
  
  SELECT @Resultado = NULL
  SELECT @Tipo = '('+Tipo+')' FROM TipoImpuesto WHERE TipoImpuesto = @TipoImpuesto
  
  IF NULLIF(RTRIM(@TipoImpuesto), '') IS NULL
    RETURN (@Resultado)

  DECLARE crRegla CURSOR LOCAL FOR
   SELECT ID, NULLIF(RTRIM(Modulo),''), NULLIF(RTRIM(Mov),''), NULLIF(RTRIM(FiscalRegimenEmpresa),''), NULLIF(RTRIM(FiscalRegimenCliente),''), NULLIF(RTRIM(FiscalRegimenProveedor),''), TipoImpuestoNuevo, NULLIF(RTRIM(FiscalZonaEmpresa),''), NULLIF(RTRIM(FiscalZonaCliente),''), NULLIF(RTRIM(FiscalZonaProveedor),'')
     FROM FiscalRegimenRegla
    WHERE TipoImpuesto IN (@TipoImpuesto, @Tipo) AND Estatus = 'ALTA' AND VigenciaD <= @Fecha AND (VigenciaA IS NULL OR VigenciaA >= @Fecha)
      AND NULLIF(RTRIM(Modulo), '') IN (NULL, @Modulo) 
      AND NULLIF(RTRIM(Mov), '') IN (NULL, @Mov) 
      AND NULLIF(RTRIM(TipoImpuestoNuevo), '') IS NOT NULL
    ORDER BY LEN(ISNULL(Modulo,'') + ISNULL(Mov,'')) DESC
       
  OPEN crRegla
  FETCH NEXT FROM crRegla INTO @ReglaID, @ReglaModulo, @ReglaMov, @ReglaRegimenEmpresa, @ReglaRegimenCliente, @ReglaRegimenProveedor, @TipoImpuestoNuevo, @ReglaZonaEmpresa, @ReglaZonaCliente, @ReglaZonaProveedor
  WHILE @@FETCH_STATUS <> -1 AND @Resultado IS NULL
  BEGIN
    IF @@FETCH_STATUS <> -2 
    BEGIN
      --IF @ReglaModulo = @Modulo AND @ReglaMov = @Mov
      --  SELECT @Resultado = @TipoImpuestoNuevo

      IF (@RegimenEmpresa  = @ReglaRegimenEmpresa AND @ZonaEmpresa = @ReglaZonaEmpresa  AND @CriterioEmpresa IN ('Empresa', 'Empresa/Sucursal')) OR
         (@RegimenSucursal = @ReglaRegimenEmpresa AND @ZonaSucursal = @ReglaZonaEmpresa AND @CriterioEmpresa IN ('Sucursal', 'Empresa/Sucursal'))
      BEGIN
        IF ((@RegimenCliente        = @ReglaRegimenCliente AND @ZonaCliente        = @ReglaZonaCliente AND @CriterioCliente IN ('Cliente', 'Cliente/Sucursal Envio')) OR
           (@RegimenClienteEnviarA  = @ReglaRegimenCliente AND @ZonaClienteEnviarA = @ReglaZonaCliente AND @CriterioCliente IN ('Sucursal Envio', 'Cliente/Sucursal Envio'))) 
           AND NULLIF(@ReglaRegimenCliente,'') IS NOT NULL AND NULLIF(@ReglaZonaCliente,'') IS NOT NULL
           SELECT @Resultado = @TipoImpuestoNuevo
        ELSE
        IF RTRIM(@RegimenProveedor) = RTRIM(@ReglaRegimenProveedor) AND RTRIM(@ZonaProveedor) = RTRIM(@ReglaZonaProveedor) AND RTRIM(@CriterioProveedor) = 'Proveedor' 
           AND NULLIF(@ReglaRegimenProveedor,'') IS NOT NULL AND NULLIF(@ReglaZonaProveedor,'') IS NOT NULL
          SELECT @Resultado = @TipoImpuestoNuevo
      END

      IF NULLIF(@ReglaRegimenEmpresa,'') IS NULL AND NULLIF(@ReglaRegimenCliente,'') IS NULL AND NULLIF(@ReglaRegimenProveedor,'') IS NULL AND NULLIF(@ReglaZonaEmpresa,'') IS NULL AND NULLIF(@ReglaZonaCliente,'') IS NULL AND NULLIF(@ReglaZonaProveedor,'') IS NULL
         SELECT @Resultado = @TipoImpuestoNuevo
    END
    FETCH NEXT FROM crRegla INTO @ReglaID, @ReglaModulo, @ReglaMov, @ReglaRegimenEmpresa, @ReglaRegimenCliente, @ReglaRegimenProveedor, @TipoImpuestoNuevo, @ReglaZonaEmpresa, @ReglaZonaCliente, @ReglaZonaProveedor
  END -- While
  CLOSE crRegla
  DEALLOCATE crRegla
  
  RETURN (ISNULL(NULLIF(RTRIM(@Resultado), ''), @TipoImpuesto))
END
GO

/**************** spTipoImpuesto ****************/
if exists (select * from sysobjects where id = object_id('dbo.spTipoImpuesto') and sysstat & 0xf = 4) drop procedure dbo.spTipoImpuesto
GO             
CREATE PROCEDURE spTipoImpuesto
			@Modulo			varchar(5),
			@ID			int,
			
			@Mov			varchar(20),
			@Fecha			datetime,
			@Empresa		varchar(5),
			@Sucursal		int,
			@Contacto		varchar(10),
			@EnviarA		int		= NULL,
			@Articulo		varchar(20)	= NULL,
			@Concepto		varchar(50)	= NULL,
			@VerTipos		bit		= 0,
			@EnSilencio		bit		= 0,
			@Impuesto1		float		= NULL	OUTPUT,
			@Impuesto2		float		= NULL	OUTPUT,
			@Impuesto3		float		= NULL	OUTPUT,
			@Retencion1		float		= NULL	OUTPUT,
			@Retencion2		float		= NULL	OUTPUT,
			@Retencion3		float		= NULL	OUTPUT,
			@TipoImpuesto1		varchar(10)	= NULL	OUTPUT,
			@TipoImpuesto2		varchar(10)	= NULL	OUTPUT,
			@TipoImpuesto3		varchar(10)	= NULL	OUTPUT,
			@TipoRetencion1		varchar(10)	= NULL	OUTPUT,
			@TipoRetencion2		varchar(10)	= NULL	OUTPUT,
			@TipoRetencion3		varchar(10)	= NULL	OUTPUT,
			@TipoImpuesto4		varchar(10)	= NULL	OUTPUT,
			@Impuesto5			float		= NULL	OUTPUT,
			@TipoImpuesto5		varchar(10)	= NULL	OUTPUT,
			@ConceptoMov		bit	= 0 --MEJORA10041

--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @CfgTipoImpuesto		bit,
    @CriterioEmpresa		varchar(30),
    @CriterioCliente		varchar(30),
    @CriterioProveedor		varchar(30),
    @RegimenEmpresa			varchar(30),
    @ZonaEmpresa			varchar(30), 
    @RegimenSucursal		varchar(30),
    @ZonaSucursal			varchar(30), 
    @RegimenCliente			varchar(30), 
    @ZonaCliente			varchar(30),
    @RegimenEnviarA			varchar(30),
    @ZonaEnviarA			varchar(30),
    @RegimenProveedor		varchar(30),
    @ZonaProveedor			varchar(30),
    @MovTipo				varchar(20), --MEJORA10041
    @SubMovTipo				varchar(20)  --MEJORA10041

  --MEJORA4769 (Se hicieron cambios masivos en este procedimiento)
  SELECT @MovTipo = Clave, @SubMovTipo = SubClave FROM MovTipo WHERE Mov = @Mov AND Modulo = @Modulo --MEJORA10041
  
  SELECT @RegimenEmpresa = NULL, @RegimenSucursal = NULL, @RegimenCliente = NULL, @RegimenEnviarA = NULL, @RegimenProveedor = NULL,
         @TipoImpuesto1 = NULL, @TipoImpuesto2 = NULL, @TipoImpuesto3 = NULL, @TipoImpuesto5 = NULL, @TipoRetencion1 = NULL, @TipoRetencion2 = NULL, @TipoRetencion3 = NULL,
         @ZonaEmpresa = NULL, @ZonaSucursal = NULL, @ZonaCliente = NULL, @ZonaEnviarA = NULL, @ZonaProveedor = NULL
  SELECT @CfgTipoImpuesto   = ISNULL(TipoImpuesto, 0),
         @CriterioEmpresa   = FiscalRegimenCriterioEmpresa,
         @CriterioCliente   = FiscalRegimenCriterioCliente,
         @CriterioProveedor = FiscalRegimenCriterioProveedor
    FROM EmpresaGral
   WHERE Empresa = @Empresa
   
  IF @CfgTipoImpuesto = 1 AND @Modulo IN ('VTAS', 'COMS', 'GAS','CREDI','CXC','CXP') --MEJORA10041
  BEGIN
    SELECT @Impuesto1 = NULL, @Impuesto2 = NULL, @Impuesto3 = NULL, @Impuesto5 = NULL, @Retencion1 = NULL, @Retencion2 = NULL, @Retencion3 = NULL           
    SELECT @RegimenEmpresa = FiscalRegimen, @ZonaEmpresa = FiscalZona
      FROM Empresa
     WHERE Empresa = @Empresa
    SELECT @RegimenSucursal = FiscalRegimen, @ZonaSucursal = FiscalZona
      FROM Sucursal
     WHERE Sucursal = @Sucursal
   
    IF @Modulo = 'VTAS'
    BEGIN
      SELECT @RegimenCliente = FiscalRegimen, @ZonaCliente = FiscalZona
        FROM Cte
       WHERE Cliente = @Contacto
      SELECT @RegimenEnviarA = FiscalRegimen, @ZonaEnviarA = FiscalZona
        FROM CteEnviarA
       WHERE Cliente = @Contacto AND ID = @EnviarA
    END ELSE
    IF @Modulo IN ('COMS', 'GAS')
    BEGIN --MEJORA10041
      SELECT @RegimenProveedor = FiscalRegimen, @ZonaProveedor = FiscalZona
        FROM Prov
       WHERE Proveedor = @Contacto
    END ELSE --MEJORA10041   
    IF @Modulo IN ('CREDI') --MEJORA10041
    BEGIN
	  IF @MovTipo IN ('CREDI.FON','CREDI.DA','CFEDI.FOA')
	  BEGIN
        SELECT @RegimenProveedor = FiscalRegimen, @ZonaProveedor = FiscalZona
          FROM Prov
         WHERE Proveedor = @Contacto	  
	  END ELSE
	  BEGIN
	    IF @MovTipo IN ('CREDI.FEX','CREDI.FIN','CREDI.CES','CREDI.DIS','CREDI.BTB')
	    BEGIN
          SELECT @RegimenCliente = FiscalRegimen, @ZonaCliente = FiscalZona
            FROM Cte
           WHERE Cliente = @Contacto
          SELECT @RegimenEnviarA = FiscalRegimen, @ZonaEnviarA = FiscalZona
            FROM CteEnviarA
           WHERE Cliente = @Contacto AND ID = @EnviarA	    
	    END
	  END
    END ELSE 
    IF @Modulo IN ('CXC') --MEJORA10041
    BEGIN
      SELECT @RegimenCliente = FiscalRegimen, @ZonaCliente = FiscalZona
        FROM Cte
       WHERE Cliente = @Contacto
      SELECT @RegimenEnviarA = FiscalRegimen, @ZonaEnviarA = FiscalZona
        FROM CteEnviarA
       WHERE Cliente = @Contacto AND ID = @EnviarA	    
    END ELSE 
    IF @Modulo IN ('CXP') --MEJORA10041
    BEGIN
      SELECT @RegimenProveedor = FiscalRegimen, @ZonaProveedor = FiscalZona
        FROM Prov
       WHERE Proveedor = @Contacto	  
    END 
      
    IF @Modulo IN ('COMS', 'VTAS')
    BEGIN --MEJORA10041
      IF @ConceptoMov = 0 --MEJORA10041
      BEGIN --MEJORA10041
        SELECT @TipoImpuesto1 = TipoImpuesto1, @TipoImpuesto2 = TipoImpuesto2, @TipoImpuesto3 = TipoImpuesto3,  @TipoImpuesto4 = TipoImpuesto4,  @TipoImpuesto5 = TipoImpuesto5,
   	       @TipoRetencion1 = TipoRetencion1, @TipoRetencion2 = TipoRetencion2, @TipoRetencion3 = TipoRetencion3
          FROM Art
         WHERE Articulo = @Articulo
      END ELSE --MEJORA10041
      BEGIN --MEJORA10041
        IF @ConceptoMov = 1
        BEGIN
          SELECT @TipoImpuesto1 = TipoImpuesto1
            FROM Concepto
           WHERE Modulo = @Modulo AND Concepto = @Concepto                  
        END
      END
    END ELSE --MEJORA10041
    IF @Modulo = 'GAS'
    BEGIN --MEJORA10041
      SELECT @TipoImpuesto1 = TipoImpuesto1, @TipoImpuesto2 = TipoImpuesto2, @TipoImpuesto3 = TipoImpuesto3, @TipoImpuesto4 = TipoImpuesto4,  @TipoImpuesto5 = TipoImpuesto5,
  	     @TipoRetencion1 = TipoRetencion1, @TipoRetencion2 = TipoRetencion2, @TipoRetencion3 = TipoRetencion3
        FROM Concepto
       WHERE Modulo = @Modulo AND Concepto = @Concepto
    END ELSE --MEJORA10041
    IF @Modulo IN ('CREDI') --MEJORA10041
    BEGIN
      SELECT @TipoImpuesto1 = TipoImpuesto1
        FROM Concepto
       WHERE Modulo = @Modulo AND Concepto = @Concepto      
    END ELSE --MEJORA10041
    IF @Modulo IN ('CXC') --MEJORA10041
    BEGIN
      SELECT @TipoImpuesto1 = TipoImpuesto1
        FROM Concepto
       WHERE Modulo = @Modulo AND Concepto = @Concepto          
    END ELSE --MEJORA10041
    IF @Modulo IN ('CXP') --MEJORA10041
    BEGIN
      SELECT @TipoImpuesto1 = TipoImpuesto1
        FROM Concepto
       WHERE Modulo = @Modulo AND Concepto = @Concepto          
    END    
    
    IF NULLIF(RTRIM(@TipoImpuesto1), '') IS NOT NULL 
    BEGIN
      SELECT @TipoImpuesto1 = dbo.fnTipoImpuestoRegla(@TipoImpuesto1, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @ZonaEmpresa, @RegimenSucursal, @ZonaSucursal, @RegimenCliente, @ZonaCliente, @RegimenEnviarA, @ZonaEnviarA, @RegimenProveedor, @ZonaProveedor)
      SELECT @Impuesto1  = Tasa FROM TipoImpuesto WHERE TipoImpuesto = @TipoImpuesto1
    END
    IF NULLIF(RTRIM(@TipoImpuesto2), '') IS NOT NULL 
    BEGIN
      SELECT @TipoImpuesto2 = dbo.fnTipoImpuestoRegla(@TipoImpuesto2, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @ZonaEmpresa, @RegimenSucursal, @ZonaSucursal, @RegimenCliente, @ZonaCliente, @RegimenEnviarA, @ZonaEnviarA, @RegimenProveedor, @ZonaProveedor)
      SELECT @Impuesto2  = Tasa FROM TipoImpuesto WHERE TipoImpuesto = @TipoImpuesto2
    END
    IF NULLIF(RTRIM(@TipoImpuesto3), '') IS NOT NULL 
    BEGIN
      SELECT @TipoImpuesto3 = dbo.fnTipoImpuestoRegla(@TipoImpuesto3, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @ZonaEmpresa, @RegimenSucursal, @ZonaSucursal, @RegimenCliente, @ZonaCliente, @RegimenEnviarA, @ZonaEnviarA, @RegimenProveedor, @ZonaProveedor)
      SELECT @Impuesto3  = Tasa FROM TipoImpuesto WHERE TipoImpuesto = @TipoImpuesto3
    END
    IF NULLIF(RTRIM(@TipoImpuesto4), '') IS NOT NULL 
    BEGIN
      SELECT @TipoImpuesto4 = dbo.fnTipoImpuestoRegla(@TipoImpuesto4, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @ZonaEmpresa, @RegimenSucursal, @ZonaSucursal, @RegimenCliente, @ZonaCliente, @RegimenEnviarA, @ZonaEnviarA, @RegimenProveedor, @ZonaProveedor)
    END
    IF NULLIF(RTRIM(@TipoImpuesto5), '') IS NOT NULL 
    BEGIN
      SELECT @TipoImpuesto5 = dbo.fnTipoImpuestoRegla(@TipoImpuesto5, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @ZonaEmpresa, @RegimenSucursal, @ZonaSucursal, @RegimenCliente, @ZonaCliente, @RegimenEnviarA, @ZonaEnviarA, @RegimenProveedor, @ZonaProveedor)
      SELECT @Impuesto5  = Tasa FROM TipoImpuesto WHERE TipoImpuesto = @TipoImpuesto5
    END
    IF NULLIF(RTRIM(@TipoRetencion1), '') IS NOT NULL 
    BEGIN
      SELECT @TipoRetencion1 = dbo.fnTipoImpuestoRegla(@TipoRetencion1, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @ZonaEmpresa, @RegimenSucursal, @ZonaSucursal, @RegimenCliente, @ZonaCliente, @RegimenEnviarA, @ZonaEnviarA, @RegimenProveedor, @ZonaProveedor)
      SELECT @Retencion1  = Tasa FROM TipoImpuesto WHERE TipoImpuesto = @TipoRetencion1
    END
    IF NULLIF(RTRIM(@TipoRetencion2), '') IS NOT NULL 
    BEGIN
      SELECT @TipoRetencion2 = dbo.fnTipoImpuestoRegla(@TipoRetencion2, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @ZonaEmpresa, @RegimenSucursal, @ZonaSucursal, @RegimenCliente, @ZonaCliente, @RegimenEnviarA, @ZonaEnviarA, @RegimenProveedor, @ZonaProveedor)
      SELECT @Retencion2  = Tasa FROM TipoImpuesto WHERE TipoImpuesto = @TipoRetencion2
    END
    IF NULLIF(RTRIM(@TipoRetencion3), '') IS NOT NULL 
    BEGIN
      SELECT @TipoRetencion3 = dbo.fnTipoImpuestoRegla(@TipoRetencion3, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @ZonaEmpresa, @RegimenSucursal, @ZonaSucursal, @RegimenCliente, @ZonaCliente, @RegimenEnviarA, @ZonaEnviarA, @RegimenProveedor, @ZonaProveedor)
      SELECT @Retencion3  = Tasa FROM TipoImpuesto WHERE TipoImpuesto = @TipoRetencion3
    END
  END

  EXEC xpTipoImpuesto @Modulo, @ID, @Mov, @Fecha, @Empresa, @Sucursal, @Contacto, @EnviarA, @Articulo, @Concepto, @VerTipos, @EnSilencio, @Impuesto1 OUTPUT, @Impuesto2	OUTPUT, @Impuesto3	OUTPUT, @Retencion1	OUTPUT, @Retencion2	OUTPUT, @Retencion3	OUTPUT, @TipoImpuesto1	OUTPUT, @TipoImpuesto2	OUTPUT, @TipoImpuesto3	OUTPUT,  @TipoRetencion1	OUTPUT, @TipoRetencion2	OUTPUT, @TipoRetencion3	OUTPUT, @TipoImpuesto4 OUTPUT, @Impuesto5 OUTPUT, @TipoImpuesto5 OUTPUT
  
  IF @EnSilencio = 0 AND @VerTipos = 0
    SELECT Impuesto1 = @Impuesto1, 
	   Impuesto2 = @Impuesto2, 
	   Impuesto3 = @Impuesto3, 
	   Impuesto5 = @Impuesto5, 
	   Retencion1 = @Retencion1, 
	   Retencion2 = @Retencion2, 
	   Retencion3 = @Retencion3
	   
  IF @EnSilencio = 0 AND @VerTipos = 1
    SELECT Impuesto1 = @Impuesto1, 
	   Impuesto2 = @Impuesto2, 
	   Impuesto3 = @Impuesto3, 
	   Retencion1 = @Retencion1, 
	   Retencion2 = @Retencion2, 
	   Retencion3 = @Retencion3,
	   TipoImpuesto1 = @TipoImpuesto1, 
	   TipoImpuesto2 = @TipoImpuesto2, 
	   TipoImpuesto3 = @TipoImpuesto3, 
	   TipoRetencion1 = @TipoRetencion1, 
	   TipoRetencion2 = @TipoRetencion2, 
	   TipoRetencion3 = @TipoRetencion3,
	   TipoImpuesto4 = @TipoImpuesto4,
	   Impuesto5 = @Impuesto5, 
	   TipoImpuesto5 = @TipoImpuesto5
  RETURN
END
GO


/**************** spTipoImpuesto ****************/
/*
if exists (select * from sysobjects where id = object_id('dbo.spTipoImpuesto') and sysstat & 0xf = 4) drop procedure dbo.spTipoImpuesto             
CREATE PROCEDURE spTipoImpuesto
			@Modulo			varchar(5),
			@ID			int,
			
			@Mov			varchar(20),
			@Fecha			datetime,
			@Empresa		varchar(5),
			@Sucursal		int,
			@Contacto		varchar(10),
			@EnviarA		int		= NULL,
			@Articulo		varchar(20)	= NULL,
			@Concepto		varchar(50)	= NULL,
			@VerTipos		bit		= 0,
			@EnSilencio		bit		= 0,
			@Impuesto1		float		= NULL	OUTPUT,
			@Impuesto2		float		= NULL	OUTPUT,
			@Impuesto3		float		= NULL	OUTPUT,
			@Retencion1		float		= NULL	OUTPUT,
			@Retencion2		float		= NULL	OUTPUT,
			@Retencion3		float		= NULL	OUTPUT,
			@TipoImpuesto1		varchar(10)	= NULL	OUTPUT,
			@TipoImpuesto2		varchar(10)	= NULL	OUTPUT,
			@TipoImpuesto3		varchar(10)	= NULL	OUTPUT,
			@TipoRetencion1		varchar(10)	= NULL	OUTPUT,
			@TipoRetencion2		varchar(10)	= NULL	OUTPUT,
			@TipoRetencion3		varchar(10)	= NULL	OUTPUT,
			@TipoImpuesto4		varchar(10)	= NULL	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  DECLARE
    @CfgTipoImpuesto		bit,
    @CriterioEmpresa		varchar(30),
    @CriterioCliente		varchar(30),
    @CriterioProveedor		varchar(30),
    @RegimenEmpresa		varchar(30), 
    @RegimenSucursal		varchar(30), 
    @RegimenCliente		varchar(30), 
    @RegimenEnviarA		varchar(30),
    @RegimenProveedor		varchar(30) 

  SELECT @RegimenEmpresa = NULL, @RegimenSucursal = NULL, @RegimenCliente = NULL, @RegimenEnviarA = NULL, @RegimenProveedor = NULL,
         @TipoImpuesto1 = NULL, @TipoImpuesto2 = NULL, @TipoImpuesto3 = NULL, @TipoRetencion1 = NULL, @TipoRetencion2 = NULL, @TipoRetencion3 = NULL
  SELECT @CfgTipoImpuesto   = ISNULL(TipoImpuesto, 0),
         @CriterioEmpresa   = FiscalRegimenCriterioEmpresa,
         @CriterioCliente   = FiscalRegimenCriterioCliente,
         @CriterioProveedor = FiscalRegimenCriterioProveedor
    FROM EmpresaGral
   WHERE Empresa = @Empresa
   
  IF @CfgTipoImpuesto = 1 AND @Modulo IN ('VTAS', 'COMS', 'GAS')
  BEGIN
    SELECT @Impuesto1 = NULL, @Impuesto2 = NULL, @Impuesto3 = NULL, @Retencion1 = NULL, @Retencion2 = NULL, @Retencion3 = NULL           
    SELECT @RegimenEmpresa = FiscalRegimen
      FROM Empresa
     WHERE Empresa = @Empresa
    SELECT @RegimenSucursal = FiscalRegimen
      FROM Sucursal
     WHERE Sucursal = @Sucursal
   
    IF @Modulo = 'VTAS'
    BEGIN
      SELECT @RegimenCliente = FiscalRegimen
        FROM Cte
       WHERE Cliente = @Contacto
      SELECT @RegimenEnviarA = FiscalRegimen
        FROM CteEnviarA
       WHERE Cliente = @Contacto AND ID = @EnviarA
     END ELSE
    IF @Modulo IN ('COMS', 'GAS')
      SELECT @RegimenProveedor = FiscalRegimen
        FROM Prov
       WHERE Proveedor = @Contacto
      
    IF @Modulo IN ('COMS', 'VTAS')
      SELECT @TipoImpuesto1 = TipoImpuesto1, @TipoImpuesto2 = TipoImpuesto2, @TipoImpuesto3 = TipoImpuesto3,  @TipoImpuesto4 = TipoImpuesto4,
   	     @TipoRetencion1 = TipoRetencion1, @TipoRetencion2 = TipoRetencion2, @TipoRetencion3 = TipoRetencion3
        FROM Art
       WHERE Articulo = @Articulo
    ELSE
    IF @Modulo = 'GAS'
      SELECT @TipoImpuesto1 = TipoImpuesto1, @TipoImpuesto2 = TipoImpuesto2, @TipoImpuesto3 = TipoImpuesto3, @TipoImpuesto4 = TipoImpuesto4,
  	     @TipoRetencion1 = TipoRetencion1, @TipoRetencion2 = TipoRetencion2, @TipoRetencion3 = TipoRetencion3
        FROM Concepto
       WHERE Modulo = @Modulo AND Concepto = @Concepto

    IF NULLIF(RTRIM(@TipoImpuesto1), '') IS NOT NULL 
    BEGIN
      SELECT @TipoImpuesto1 = dbo.fnTipoImpuestoRegla(@TipoImpuesto1, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @RegimenSucursal, @RegimenCliente, @RegimenEnviarA, @RegimenProveedor)
      SELECT @Impuesto1  = Tasa FROM TipoImpuesto WHERE TipoImpuesto = @TipoImpuesto1
    END
    IF NULLIF(RTRIM(@TipoImpuesto2), '') IS NOT NULL 
    BEGIN
      SELECT @TipoImpuesto2 = dbo.fnTipoImpuestoRegla(@TipoImpuesto2, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @RegimenSucursal, @RegimenCliente, @RegimenEnviarA, @RegimenProveedor)
      SELECT @Impuesto2  = Tasa FROM TipoImpuesto WHERE TipoImpuesto = @TipoImpuesto2
    END
    IF NULLIF(RTRIM(@TipoImpuesto3), '') IS NOT NULL 
    BEGIN
      SELECT @TipoImpuesto3 = dbo.fnTipoImpuestoRegla(@TipoImpuesto3, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @RegimenSucursal, @RegimenCliente, @RegimenEnviarA, @RegimenProveedor)
      SELECT @Impuesto3  = Tasa FROM TipoImpuesto WHERE TipoImpuesto = @TipoImpuesto3
    END
    IF NULLIF(RTRIM(@TipoImpuesto4), '') IS NOT NULL 
    BEGIN
      SELECT @TipoImpuesto4 = dbo.fnTipoImpuestoRegla(@TipoImpuesto4, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @RegimenSucursal, @RegimenCliente, @RegimenEnviarA, @RegimenProveedor)
    END
    IF NULLIF(RTRIM(@TipoRetencion1), '') IS NOT NULL 
    BEGIN
      SELECT @TipoRetencion1 = dbo.fnTipoImpuestoRegla(@TipoRetencion1, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @RegimenSucursal, @RegimenCliente, @RegimenEnviarA, @RegimenProveedor)
      SELECT @Retencion1  = Tasa FROM TipoImpuesto WHERE TipoImpuesto = @TipoRetencion1
    END
    IF NULLIF(RTRIM(@TipoRetencion2), '') IS NOT NULL 
    BEGIN
      SELECT @TipoRetencion2 = dbo.fnTipoImpuestoRegla(@TipoRetencion2, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @RegimenSucursal, @RegimenCliente, @RegimenEnviarA, @RegimenProveedor)
      SELECT @Retencion2  = Tasa FROM TipoImpuesto WHERE TipoImpuesto = @TipoRetencion2
    END
    IF NULLIF(RTRIM(@TipoRetencion3), '') IS NOT NULL 
    BEGIN
      SELECT @TipoRetencion3 = dbo.fnTipoImpuestoRegla(@TipoRetencion3, @Fecha, @Modulo, @ID, @Mov, @CriterioEmpresa, @CriterioCliente, @CriterioProveedor, @RegimenEmpresa, @RegimenSucursal, @RegimenCliente, @RegimenEnviarA, @RegimenProveedor)
      SELECT @Retencion3  = Tasa FROM TipoImpuesto WHERE TipoImpuesto = @TipoRetencion3
    END
  END
  
  IF @EnSilencio = 0 AND @VerTipos = 0
    SELECT Impuesto1 = @Impuesto1, 
	   Impuesto2 = @Impuesto2, 
	   Impuesto3 = @Impuesto3, 
	   Retencion1 = @Retencion1, 
	   Retencion2 = @Retencion2, 
	   Retencion3 = @Retencion3
	   
  IF @EnSilencio = 0 AND @VerTipos = 1
    SELECT Impuesto1 = @Impuesto1, 
	   Impuesto2 = @Impuesto2, 
	   Impuesto3 = @Impuesto3, 
	   Retencion1 = @Retencion1, 
	   Retencion2 = @Retencion2, 
	   Retencion3 = @Retencion3,
	   TipoImpuesto1 = @TipoImpuesto1, 
	   TipoImpuesto2 = @TipoImpuesto2, 
	   TipoImpuesto3 = @TipoImpuesto3, 
	   TipoRetencion1 = @TipoRetencion1, 
	   TipoRetencion2 = @TipoRetencion2, 
	   TipoRetencion3 = @TipoRetencion3,
	   TipoImpuesto4 = @TipoImpuesto4
  RETURN
END
*/
GO



/**************** fnTipoImpuestoTasa ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnTipoImpuestoTasa') DROP FUNCTION fnTipoImpuestoTasa
GO
CREATE FUNCTION fnTipoImpuestoTasa (@TipoImpuesto varchar(10))
RETURNS float
--//WITH ENCRYPTION
AS BEGIN
  RETURN(SELECT Tasa FROM TipoImpuesto WHERE TipoImpuesto=@TipoImpuesto)
END
GO


/**************** spSaldoInicialContSucursal ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSaldoInicialContSucursal') and type = 'P') drop procedure dbo.spSaldoInicialContSucursal
GO             
CREATE PROCEDURE spSaldoInicialContSucursal
                                   @Empresa		char(5),
                                   @CuentaBase		char(20),
                                   @Ejercicio		int,
                                   @Periodo		int,
                                   @FechaInicial	datetime,
                                   @Sucursal            int, 
                                   @CargoInicial	money	OUTPUT,
                                   @AbonoInicial	money	OUTPUT,
                                   @Ok			int	OUTPUT,
                                   @Moneda		char(10) = NULL,
                                   @Controladora	char(5)  = NULL

--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  SELECT @CargoInicial = 0.0, @AbonoInicial = 0.0
  IF UPPER(@Empresa) 	   IN ('0', 'NULL', '(TODOS)','') SELECT @Empresa = NULL
  IF UPPER(@Controladora)  IN ('0', 'NULL', '(TODOS)','') SELECT @Controladora = NULL
  EXEC spContEmpresaGrupo @Empresa OUTPUT, @Controladora OUTPUT
 
  SELECT @CargoInicial = ISNULL(Sum(a.Cargos), 0.0), @AbonoInicial = ISNULL(Sum(a.Abonos), 0.0) 
    FROM Acum a
    JOIN Empresa e ON e.Empresa = a.Empresa AND e.Empresa = ISNULL(@Empresa, e.Empresa) AND ISNULL(e.Controladora,'') = ISNULL(ISNULL(@Controladora, e.Controladora),'')
   WHERE a.Moneda  = ISNULL(@Moneda, Moneda)
     AND a.Rama    = 'CONT'
     AND a.Cuenta  = @CuentaBase 
     AND a.Ejercicio = @Ejercicio 
     AND a.Periodo < @Periodo 
     AND a.Sucursal = ISNULL(@Sucursal,a.Sucursal) 
  IF @@ERROR <> 0 SELECT @Ok = 1
 
  IF @FechaInicial IS NOT NULL AND DATEPART(dd, @FechaInicial) > 1 
  BEGIN
    SELECT @CargoInicial = ISNULL(@CargoInicial, 0.0) + ISNULL(Sum(Debe), 0.0),
           @AbonoInicial = ISNULL(@AbonoInicial, 0.0) + ISNULL(Sum(Haber), 0.0) 
      FROM ContD
      JOIN Cont ON ContD.ID = Cont.ID
      JOIN Empresa e ON e.Empresa = ContD.Empresa AND e.Empresa = ISNULL(@Empresa, e.Empresa) AND ISNULL(e.Controladora,'') = ISNULL(ISNULL(@Controladora, e.Controladora),'')
     WHERE Cont.Estatus = 'CONCLUIDO'
       AND ContD.Cuenta  = @CuentaBase 
       AND ContD.Ejercicio = @Ejercicio 
       AND ContD.Periodo   = @Periodo
       AND ContD.FechaContable < @FechaInicial
       AND Cont.Moneda = ISNULL(@Moneda, Cont.Moneda)
       AND SucursalContable = ISNULL(@Sucursal,SucursalContable) 
    IF @@ERROR <> 0 SELECT @Ok = 1
  END
 
  SELECT @CargoInicial = ISNULL(@CargoInicial, 0.0), @AbonoInicial = ISNULL(@AbonoInicial, 0.0)
  RETURN
END
GO






/**************** spVerSaldoInicialMSucursal ****************/
if exists (select * from sysobjects where id = object_id('dbo.spVerSaldoInicialMSucursal') and type = 'P') drop procedure dbo.spVerSaldoInicialMSucursal
GO             
CREATE PROCEDURE spVerSaldoInicialMSucursal
			@Empresa	char(5),
			@Rama		char(5),
			@Moneda		char(10),
			@Cuenta		char(20),
			@FechaInicial	datetime,
			@Sucursal       int,
			@SubCuenta	varchar(50) = NULL
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
    @Ejercicio	  	int,
    @Periodo	  	int,
    @EsMonetario	bit,
    @EsUnidades		bit,
    @EsResultados	bit,
    @CargoInicial 	money,
    @AbonoInicial 	money,
    @CargoInicialU 	float,
    @AbonoInicialU 	float,
    @Ok		  	int

  SELECT @SubCuenta = NULLIF(RTRIM(@SubCuenta), '')
  SELECT @SubCuenta = NULLIF(@SubCuenta, '0')

  SELECT @EsMonetario  = EsMonetario,
         @EsUnidades   = EsUnidades,
	 @EsResultados = EsResultados
    FROM Rama
   WHERE Rama = @Rama
  EXEC spPeriodoEjercicio @Empresa, @Rama, @FechaInicial, @Periodo OUTPUT, @Ejercicio OUTPUT, @Ok OUTPUT
  EXEC spSaldoInicialSucursal @Empresa, @Rama, @Moneda, NULL, @Cuenta, @SubCuenta, @FechaInicial, @EsMonetario, @EsUnidades, @EsResultados,@Sucursal, 
       		      @CargoInicial OUTPUT, @AbonoInicial OUTPUT, @CargoInicialU OUTPUT, @AbonoInicialU OUTPUT,
     	     	      @Ok OUTPUT 
 SELECT "SaldoInicial" = CONVERT(money, ISNULL(@CargoInicial, 0.0) - ISNULL(@AbonoInicial, 0.0))
END
GO

/**************** spSaldoInicialSucursal ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSaldoInicialSucursal') and type = 'P') drop procedure dbo.spSaldoInicialSucursal
GO             
CREATE PROCEDURE spSaldoInicialSucursal
			@Empresa	char(5),
			@Rama		char(5), 
                        @MonedaBase	char(10),
			@GrupoBase	char(10), 
			@CuentaBase	char(20),
			@SubCuentaBase	varchar(50),
			@FechaInicial	datetime, 
    			@EsMonetario	bit,
    			@EsUnidades	bit,
			@EsResultados	bit,
			@Sucursal       int,
			@CargoInicial 	money	OUTPUT,
			@AbonoInicial 	money	OUTPUT,
			@CargoInicialU 	float	OUTPUT,
			@AbonoInicialU 	float	OUTPUT,
			@Ok		int	OUTPUT,
			@SubGrupoBase	varchar(20)	= NULL
--//WITH ENCRYPTION
-- Checar si la Rama es mensual, semanal, etc..
-- Actualmente funciona unicamente en Ramas Mensuales !!!
AS BEGIN
  -- SET nocount ON
  DECLARE
    @Ejercicio		  	int,
    @Periodo		  	int,
    @RamaAdicional  	  	char(5),
    @CargoInicialAdicional 	money,
    @AbonoInicialAdicional 	money

  EXEC spExtraerFecha @FechaInicial OUTPUT
  SELECT @CargoInicial  = 0.0, @AbonoInicial  = 0.0,
         @CargoInicialU = 0.0, @AbonoInicialU = 0.0

  IF @Rama='CONT'
  BEGIN
    EXEC spPeriodoEjercicio @Empresa, @Rama, @FechaInicial, @Periodo OUTPUT, @Ejercicio OUTPUT, @Ok OUTPUT
    EXEC spSaldoInicialContSucursal @Empresa, @CuentaBase, @Ejercicio, @Periodo, @FechaInicial,@Sucursal, @CargoInicial OUTPUT, @AbonoInicial OUTPUT, @Ok OUTPUT, @Moneda = @MonedaBase
  END ELSE
    IF @EsMonetario = 1 AND @EsUnidades = 0
    BEGIN
      EXEC spSaldoInicialMSucursal @Empresa, @Rama, @MonedaBase, @GrupoBase, @CuentaBase, @SubCuentaBase, @EsResultados, @FechaInicial,@Sucursal,
                           @CargoInicial OUTPUT, @AbonoInicial OUTPUT, @Ok OUTPUT
      IF @Rama IN ('CXC', 'CXP') AND @Ok IS NULL
      BEGIN
        SELECT @CargoInicialAdicional = 0.0, @AbonoInicialAdicional = 0.0
        IF @Rama = 'CXC' SELECT @RamaAdicional = 'CEFE' ELSE SELECT @RamaAdicional = 'PEFE'
        EXEC spSaldoInicialMSucursal @Empresa, @RamaAdicional, @MonedaBase, @GrupoBase, @CuentaBase, @SubCuentaBase, @EsResultados, @FechaInicial,@Sucursal,
                             @CargoInicialAdicional OUTPUT, @AbonoInicialAdicional OUTPUT, @Ok OUTPUT
        SELECT @CargoInicial = @CargoInicial + @CargoInicialAdicional, 
               @AbonoInicial = @AbonoInicial + @AbonoInicialAdicional
        IF @Rama = 'CXC' SELECT @RamaAdicional = 'CRND' ELSE SELECT @RamaAdicional = 'PRND'
        EXEC spSaldoInicialMSucursal @Empresa, @RamaAdicional, @MonedaBase, @GrupoBase, @CuentaBase, @SubCuentaBase, @EsResultados, @FechaInicial,@Sucursal,
                             @CargoInicialAdicional OUTPUT, @AbonoInicialAdicional OUTPUT, @Ok OUTPUT
        SELECT @CargoInicial = @CargoInicial + @CargoInicialAdicional, 
               @AbonoInicial = @AbonoInicial + @AbonoInicialAdicional
        IF @Rama = 'CXC'
        BEGIN
          SELECT @CargoInicialAdicional = 0.0, @AbonoInicialAdicional = 0.0
          EXEC spSaldoInicialMSucursal @Empresa, 'CVALE', @MonedaBase, @GrupoBase, @CuentaBase, @SubCuentaBase, @EsResultados, @FechaInicial,@Sucursal,
                               @CargoInicialAdicional OUTPUT, @AbonoInicialAdicional OUTPUT, @Ok OUTPUT
          SELECT @CargoInicial = @CargoInicial + @CargoInicialAdicional, 
                 @AbonoInicial = @AbonoInicial + @AbonoInicialAdicional
          EXEC spSaldoInicialMSucursal @Empresa, 'CNO', @MonedaBase, @GrupoBase, @CuentaBase, @SubCuentaBase, @EsResultados, @FechaInicial,@Sucursal,
                               @CargoInicialAdicional OUTPUT, @AbonoInicialAdicional OUTPUT, @Ok OUTPUT
          SELECT @CargoInicial = @CargoInicial + @CargoInicialAdicional, 
                 @AbonoInicial = @AbonoInicial + @AbonoInicialAdicional
        END
      END
    END ELSE 
      EXEC spSaldoInicialU @Empresa, @Rama, @MonedaBase, @GrupoBase, @CuentaBase, @SubCuentaBase, @EsResultados, @FechaInicial,
                           @CargoInicial OUTPUT, @AbonoInicial OUTPUT, @CargoInicialU OUTPUT, @AbonoInicialU OUTPUT, @Ok OUTPUT, @SubGrupoBase = @SubGrupoBase
  RETURN
END
GO








/**************** spSaldoInicialMSucursal ****************/
if exists (select * from sysobjects where id = object_id('dbo.spSaldoInicialMSucursal') and type = 'P') drop procedure dbo.spSaldoInicialMSucursal
GO             
CREATE PROCEDURE spSaldoInicialMSucursal
			@Empresa	char(5),
			@Rama		char(5), 
                        @MonedaBase	char(10),
			@GrupoBase	char(10), 
			@CuentaBase	char(20),
			@SubCuentaBase	varchar(50),
			@EsResultados	bit,
			@FechaInicial	datetime, 
			@Sucursal       int,
			@CargoInicial 	money	OUTPUT,
			@AbonoInicial 	money	OUTPUT,
			@Ok		int	OUTPUT
--//WITH ENCRYPTION
AS BEGIN
  -- SET nocount ON
  DECLARE 
    @Ejercicio	int,
    @Periodo	int

  SELECT @CargoInicial = 0.0, @AbonoInicial = 0.0
  EXEC spPeriodoEjercicio @Empresa, @Rama, @FechaInicial, @Periodo OUTPUT, @Ejercicio OUTPUT, @Ok OUTPUT
  IF @EsResultados = 0
  BEGIN
    SELECT @CargoInicial = ISNULL(Sum(Cargos), 0.0), @AbonoInicial = ISNULL(Sum(Abonos), 0.0) 
      FROM Acum 
     WHERE Empresa   = @Empresa
       AND Rama      = @Rama
       AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
       AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
       AND Cuenta    = @CuentaBase --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
       AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
       AND Ejercicio = @Ejercicio 
       AND Periodo < @Periodo
       AND Sucursal = ISNULL(@Sucursal,Sucursal)
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF DATEPART(dd, @FechaInicial) > 1 
    BEGIN
      SELECT @CargoInicial = ISNULL(@CargoInicial, 0.0) + ISNULL(Sum(Cargo), 0.0),
             @AbonoInicial = ISNULL(@AbonoInicial, 0.0) + ISNULL(Sum(Abono), 0.0) 
        FROM Auxiliar 
       WHERE Empresa   = @Empresa
         AND Rama      = @Rama
         AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
         AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
         AND Cuenta    = @CuentaBase --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
         AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
         AND Ejercicio = @Ejercicio 
         AND Periodo   = @Periodo
         AND Fecha < @FechaInicial
         AND Sucursal = ISNULL(@Sucursal,Sucursal)
      IF @@ERROR <> 0 SELECT @Ok = 1
    END
  END ELSE
  BEGIN
    SELECT @CargoInicial = ISNULL(Sum(Cargos), 0.0), @AbonoInicial = ISNULL(Sum(Abonos), 0.0) 
      FROM AcumR
     WHERE Empresa   = @Empresa
       AND Rama      = @Rama
       AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
       AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
       AND Cuenta    = @CuentaBase --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
       AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
       AND Ejercicio = @Ejercicio 
       AND Periodo < @Periodo
       AND Sucursal = ISNULL(@Sucursal,Sucursal)
    IF @@ERROR <> 0 SELECT @Ok = 1

    IF DATEPART(dd, @FechaInicial) > 1 
    BEGIN
      SELECT @CargoInicial = ISNULL(@CargoInicial, 0.0) + ISNULL(Sum(Cargo), 0.0),
             @AbonoInicial = ISNULL(@AbonoInicial, 0.0) + ISNULL(Sum(Abono), 0.0) 
        FROM AuxiliarR
       WHERE Empresa   = @Empresa
         AND Rama      = @Rama
         AND Moneda    = CASE @MonedaBase    WHEN NULL THEN Moneda    ELSE @MonedaBase    END
         AND Grupo     = CASE @GrupoBase     WHEN NULL THEN Grupo     ELSE @GrupoBase     END
         AND Cuenta    = @CuentaBase  --CASE @CuentaBase    WHEN NULL THEN Cuenta    ELSE @CuentaBase    END
         AND SubCuenta = CASE @SubCuentaBase WHEN NULL THEN SubCuenta ELSE @SubCuentaBase END
         AND Ejercicio = @Ejercicio 
         AND Periodo   = @Periodo
         AND Fecha < @FechaInicial
         AND Sucursal = ISNULL(@Sucursal,Sucursal) 
      IF @@ERROR <> 0 SELECT @Ok = 1
    END
  END
  SELECT @CargoInicial = ISNULL(@CargoInicial, 0.0), @AbonoInicial = ISNULL(@AbonoInicial, 0.0)
  RETURN
END
GO

-- 9319
/************** spEmpresaValidarFechaAplicacion ***************/
if exists(select * from sysobjects where name = 'spEmpresaValidarFechaAplicacion' and type = 'p') drop proc spEmpresaValidarFechaAplicacion
GO
CREATE PROCEDURE spEmpresaValidarFechaAplicacion  
			@Sucursal					int,  
			@Accion						char(20),  
			@Empresa					char(5),  
			@Modulo						char(5),  
			@ID							int,  
			@Mov						char(20),  
			@MovID						varchar(20),  
			@Fecha						datetime,  
			@EjercicioRegistro			int,  
			@PeriodoRegistro			int,  
			@Aplica						char(20),  
			@AplicaID					varchar(20),  
			@AplicaModulo				varchar(5),  
			@AplicaModuloID				int,  
			@FechaAplica				datetime,  
			@EjercicioAplica			int,  
			@PeriodoAplica				int,  
			@Ok							int         OUTPUT,  
			@OkRef						varchar(255)OUTPUT  
--//WITH ENCRYPTION
AS BEGIN
  IF @MovID IS NULL OR @AplicaModulo IS NULL OR @AplicaModuloID IS NULL OR @Aplica IS NULL OR @AplicaID IS NULL RETURN  
  
  IF EXISTS(SELECT * FROM EmpresaValidarFechaAplicacion WHERE Empresa = @Empresa AND Modulo = @Modulo AND Mov = @Mov AND AplicaModulo = @AplicaModulo AND AplicaMov = @Aplica)  
  BEGIN  
    IF @EjercicioAplica <> @EjercicioRegistro OR @PeriodoAplica <> @PeriodoRegistro  
      SELECT @Ok = 50056, @OkRef = RTRIM(@Aplica) + ' ' + RTRIM(@AplicaID)  
  END  
  RETURN  
END  
GO

/************** spValidarFechaAplicacion ***************/
if exists(select * from sysobjects where name = 'spValidarFechaAplicacion' and type = 'p') drop proc spValidarFechaAplicacion
GO
CREATE PROCEDURE spValidarFechaAplicacion  
			@Sucursal					int,  
			@Accion						char(20),  
			@Empresa					char(5),  
			@Modulo						char(5),  
			@ID							int,  
			@Mov						char(20),  
			@MovID						varchar(20),  
			@Fecha						datetime,  
			@EjercicioRegistro			int,  
			@PeriodoRegistro			int,  
			@Aplica						char(20),  
			@AplicaID					varchar(20),  
			@AplicaModulo				varchar(5),  
			@AplicaModuloID				int,  
			@FechaAplica				datetime,  
			@EjercicioAplica			int,  
			@PeriodoAplica				int,  
			@Ok							int         OUTPUT,  
			@OkRef						varchar(255)OUTPUT  
--//WITH ENCRYPTION  
AS BEGIN  
  DECLARE @CfgValidarFechaAplicacion varchar(10)
  
  SELECT @CfgValidarFechaAplicacion = CASE @Modulo
                                      WHEN 'VTAS' THEN VTASValidarFechaAplicacion
                                      WHEN 'COMS' THEN COMSValidarFechaAplicacion 
                                      WHEN 'INV'  THEN INVValidarFechaAplicacion
                                      WHEN 'CXC'  THEN CXCValidarFechaAplicacion
                                      WHEN 'CXP'  THEN CXPValidarFechaAplicacion
                                      WHEN 'DIN'  THEN DINValidarFechaAplicacion
                                      WHEN 'GAS'  THEN GASValidarFechaAplicacion
                                      WHEN 'PROD' THEN PRODValidarFechaAplicacion
                                    END
     FROM EmpresaCfg2
    WHERE Empresa = @Empresa

  IF @CfgValidarFechaAplicacion = 'No' OR @MovID IS NULL OR @AplicaModulo IS NULL OR @AplicaModuloID IS NULL OR @Aplica IS NULL OR @AplicaID IS NULL RETURN  
  
  IF @CfgValidarFechaAplicacion = 'Fecha'  
  BEGIN  
    IF @Fecha < @FechaAplica  
      SELECT @Ok = 50052, @OkRef = RTRIM(@Aplica) + ' ' + RTRIM(@AplicaID)  
  END  
  ELSE IF @CfgValidarFechaAplicacion = 'Periodo'  
  BEGIN  
    IF @EjercicioAplica <> @EjercicioRegistro OR @PeriodoAplica > @PeriodoRegistro  
      SELECT @Ok = 50054, @OkRef = RTRIM(@Aplica) + ' ' + RTRIM(@AplicaID)  
  END  
  RETURN
END  
GO

/**************** fnConceptoImpuestoTasa ****************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'fnConceptoImpuestoTasa') DROP FUNCTION fnConceptoImpuestoTasa
GO
CREATE FUNCTION fnConceptoImpuestoTasa (@Empresa varchar(5), @Modulo char(5), @Concepto varchar(50), @Tipo varchar(10))
RETURNS float
--//WITH ENCRYPTION
AS BEGIN
  DECLARE @CfgTipoImpuesto	bit

  DECLARE @Tasa				float,
		  @Impuestos 		float,
		  @Retencion1		float,
          @Retencion2		float,
          @Retencion3		float,
		  @TipoImpuesto		varchar(10),
		  @TipoImpuesto1	varchar(10),
		  @TipoImpuesto2	varchar(10),
		  @TipoImpuesto3	varchar(10),		
		  @TipoImpuesto4	varchar(10),
		  @TipoImpuesto5	varchar(10),
		  @TipoRetencion1	varchar(10),
		  @TipoRetencion2	varchar(10),
		  @TipoRetencion3	varchar(10)

  SELECT @CfgTipoImpuesto=0
  SELECT @Tasa=0
		  
  SELECT @CfgTipoImpuesto=ISNULL(TipoImpuesto,0) FROM EmpresaGral WHERE Empresa=@Empresa

  SELECT 
		 @Impuestos=Impuestos, 
		 @Retencion1=Retencion, 
		 @Retencion2=Retencion2, 
		 @Retencion3=Retencion3,
		 @TipoImpuesto1 = TipoImpuesto1, 
		 @TipoImpuesto2 = TipoImpuesto2, 
		 @TipoImpuesto3 = TipoImpuesto3, 
		 @TipoImpuesto4 = TipoImpuesto4, 
		 @TipoImpuesto5 = TipoImpuesto5,
  		 @TipoRetencion1 = TipoRetencion1, 
		 @TipoRetencion2 = TipoRetencion2, 
		 @TipoRetencion3 = TipoRetencion3
   FROM Concepto
  WHERE Modulo = @Modulo 
    AND Concepto = @Concepto      
  
  IF @CfgTipoImpuesto = 0
  BEGIN
    IF @Tipo = 'Impuesto1'
      SELECT @Tasa = @Impuestos
    ELSE IF @Tipo = 'Retencion1'
      SELECT @Tasa = @Retencion1  
    ELSE IF @Tipo = 'Retencion2'
      SELECT @Tasa = @Retencion2
    ELSE IF @Tipo = 'Retencion3'
      SELECT @Tasa = @Retencion3
  END
  ELSE IF @CfgTipoImpuesto = 1
  BEGIN
    IF @Tipo = 'Impuesto1'
      SELECT @Tasa = dbo.fnTipoImpuestoTasa(@TipoImpuesto1)
    IF @Tipo = 'Impuesto2'
      SELECT @Tasa = dbo.fnTipoImpuestoTasa(@TipoImpuesto2)  
    IF @Tipo = 'Impuesto3'
	  SELECT @Tasa = dbo.fnTipoImpuestoTasa(@TipoImpuesto3)  
    IF @Tipo = 'Impuesto4'
	  SELECT @Tasa = dbo.fnTipoImpuestoTasa(@TipoImpuesto4)  
    IF @Tipo = 'Impuesto5'
	  SELECT @Tasa = dbo.fnTipoImpuestoTasa(@TipoImpuesto5)  
    IF @Tipo = 'Retencion1'
	  SELECT @Tasa = dbo.fnTipoImpuestoTasa(@TipoRetencion1)  
    IF @Tipo = 'Retencion2'
	  SELECT @Tasa = dbo.fnTipoImpuestoTasa(@TipoRetencion2)  
    IF @Tipo = 'Retencion3'
	  SELECT @Tasa = dbo.fnTipoImpuestoTasa(@TipoRetencion3)  
  END

  RETURN @Tasa

END
GO




